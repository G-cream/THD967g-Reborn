//===========================================================================
// 
// 东方幻想乡DOTS v0.962p
// 
//   Warcraft III map script
//   Generated by the Warcraft III World Editor
//   Date: Wed May 04 22:47:25 2011
//   Map Author: 东方幻想乡DOTS制作组
// 
//===========================================================================

//***************************************************************************
//*
//*  Global Variables
//*
//***************************************************************************

globals
    // User-defined
    boolean                 udg_FlagFirst              = false
    player array            udg_PlayerA
    player array            udg_PlayerB
    force                   udg_OnlinePlayers          = null
    force                   udg_TeamA                  = null
    force                   udg_TeamB                  = null
    integer array           udg_ScoreSpirit
    integer array           udg_GameSetting_Spirit
    integer array           udg_GameSetting_Gold
    integer                 udg_GameTime               = 0
    multiboard              udg_GIB                    = null
    integer                 udg_OnlinePlayerSum        = 0
    string array            udg_PlayerColors
    integer array           udg_GIB_PlayerRow
    unit array              udg_PlayerHeroes
    string array            udg_HeroIcon
    boolean                 udg_DebugMode              = false
    boolean                 udg_ShiftPlayer            = false
    string array            udg_PN
    player                  udg_HostPlayer             = null
    integer array           udg_HeroType
    force                   udg_TeamOB                 = null
    hashtable               udg_Hashtable              = null
    real array              udg_ReviveTime
    integer array           udg_SUA_ID_A
    integer array           udg_SU_No_A
    integer array           udg_SUA_ID_B
    integer array           udg_SU_No_B
    integer                 udg_NeutralFirstCreateTime = 0
    integer                 udg_NeutralCreatePeriod    = 0
    integer array           udg_NeutralTypes
    string array            udg_NeutralGroups
    integer                 udg_NeutralCampsCount      = 0
    rect array              udg_NeutralCamps
    string array            udg_NeutralCampTypes
    integer                 udg_ItemsCount             = 0
    integer array           udg_Items
    integer                 udg_ItemFormulasCount      = 0
    string array            udg_ItemFormulas
    string array            udg_PerfectText
    force                   udg_AI_Players             = null
    location array          udg_RevivePoint
    location array          udg_SpawnRouteA
    location array          udg_SpawnRouteB
    location array          udg_SpawnLocA
    location array          udg_SpawnLocB
    timer array             udg_CSS_Timers
    integer array           udg_CSS_register
    destructable array      udg_CSS_Sprites
    boolean array           udg_CSS_Prepared
    destructable array      udg_CSS_Icons
    destructable array      udg_CSS_DisplayIcons
    trackable array         udg_CSS_Buttons
    trigger array           udg_CSS_Triggers
    fogmodifier array       udg_CSS_FM
    integer array           udg_HeroButton
    integer array           udg_CSS_Item
    rect array              udg_CSS_Areas
    real array              udg_CSS_TimeSetting
    unit array              udg_BaseA
    unit array              udg_BaseB
    integer array           udg_FlagDeath
    unit                    udg_Weather_Shrine         = null
    integer                 udg_Weather_Type           = 0
    rect                    udg_Weather_Region         = null
    integer array           udg_Weather_TriggerItem
    timer array             udg_Weather_Timer
    weathereffect array     udg_Weather_Effect
    group                   udg_Weather_SpellGroup     = null
    string array            udg_GameModeName
    dialog                  udg_ModeSelectDialog       = null
    button array            udg_ModeSelectButtons
    timer                   udg_MainTimer              = null
    integer                 udg_GameMode               = 0
    timerdialog             udg_MainTimerWindow        = null
    boolean array           udg_HeroBan
    integer array           udg_PlayerHeroList
    string array            udg_HeroBrief
    integer array           udg_AI_DataBase
    integer array           udg_SU_ID_A
    integer array           udg_SU_ID_B
    integer array           udg_FlagPerfect
    integer array           udg_FlagKill
    trigger array           udg_neutralCreepsTriggers
    trigger                 udg_neutralCreepsTrigger   = null
    integer                 udg_NeutralFirstCreateTime2 = 0
    trigger                 udg_neutralCreepsStarter   = null
    unit                    udg_ObjectsDoll            = null
    location                udg_SK_TempLocation        = null
    gamecache               udg_gc                     = null
    boolexpr array          udg_FLIFF
    integer array           udg_SK_Mokou02
    integer array           udg_SK_Reisen
    boolean                 udg_SK_Cirno03_CD          = false
    timer                   udg_SK_Flan03_Timer        = null
    unit array              udg_SK_Utsuho03_Units
    weathereffect           udg_SK_Yuka_Weather        = null
    integer                 udg_SK_Yuugi02I            = 0
    unit                    udg_SK_Yuugi02U2           = null
    unit                    udg_SK_Yuugi02U1           = null
    unit                    udg_SK_Spider04U           = null
    integer                 udg_SK_Spider04I           = 0
    integer array           udg_SK_Spider04_Hero
    unit                    udg_SK_Letty02_Lunit       = null
    location                udg_SK_Letty02_Jpoint      = null
    location                udg_SK_Letty02_Lpoint      = null
    real                    udg_SK_Letty02_in          = 0
    real                    udg_SK_Letty02_angle       = 0
    real                    udg_SK_Letty02_Distance    = 0
    location                udg_SK_Letty02_Tpoint      = null
    group                   udg_SK_Letty02_Group       = null
    group                   udg_SK_Letty02_Group2      = null
    integer                 udg_SK_Letty02_i           = 0
    integer                 udg_SK_Letty02_Level       = 0
    unit                    udg_SK_Letty02_Tunit       = null
    unit                    udg_SK_Letty02_Sunit       = null
    location                udg_SK_Letty02_Spoint      = null
    integer array           udg_GameSetting_Power
    integer array           udg_PlayerPower
    weathereffect           udg_WE_FallingLeaves       = null
    weathereffect           udg_WE_SunShine            = null
    boolean                 udg_TestMode               = false
    unit                    udg_SK_Caption04_Hero      = null
    unit                    udg_SK_Caption04_Ship      = null
    string array            udg_BGM
    timerdialog             udg_SelectTimerWindow      = null
    unit                    udg_SK_XiongGui            = null
    force                   udg_SK_Medi_Team           = null
    force                   udg_TeamSpawnA             = null
    force                   udg_TeamSpawnB             = null
    unit                    udg_SK_Cat01_Hero          = null
    unit                    udg_SK_Cat01_Wagon         = null
    integer                 udg_SK_Cat01_BodyNo        = 0
    group                   udg_SK_Cat01_BodyGrp       = null
    group                   udg_SK_Cat04_Group         = null
    trigger array           udg_HeroInit
    integer                 udg_AUD_LimitRunTimes      = 0
    integer                 udg_AUD_LimitEventCount    = 0
    boolean                 udg_AUD_hasInit            = false
    integer                 udg_AUD_runCount           = 0
    integer                 udg_AUD_eventCount         = 0
    group                   udg_AUD_heroGroup          = null
    trigger                 udg_AUD_anyUnitDamageTrigger = null
    trigger array           udg_AUD_trgArray
    unit array              udg_NPC_attackArrayUnit
    unit array              udg_NPC_attackArrayAim
    real array              udg_NPC_attackArrayTime
    integer array           udg_NPC_attackArrayNext
    integer                 udg_NPC_attackArrayTop     = 0
    integer                 udg_NPC_attackArrayEnd     = 0
    integer                 udg_NPC_cycleIndex         = 0
    timer                   udg_NPC_cycleTimer         = null
    real                    udg_NPC_AttackMaxTime      = 0
    real                    udg_NPC_Lowlife            = 0
    real                    udg_NPC_GetCycle           = 0
    force                   udg_TeamS                  = null
    hashtable               udg_ht                     = null
    integer array           udg_SK_Kaguya01_RGB
    group array             udg_AI_Groups
    hashtable               udg_sht                    = null
    string array            udg_PlayerName
    trigger array           udg_AI_Triggers
    unit                    udg_SK_Youmu_Unit          = null
    unit                    udg_SK_Mystia              = null
    unit                    udg_SK_Nazrin04            = null
    item array              udg_Rune
    unit                    udg_SK_Cat04_Hero          = null
    hashtable               udg_db                     = null
    boolean                 udg_SK_Reisen02_ON         = false
    boolean                 udg_SK_Kogasa04_Stun       = false
    boolean                 udg_SK_Pachi04_Attacking   = false
    unit                    udg_SK_Pachi04_Target      = null
    integer array           udg_SK_Meirin_RGB
    integer array           udg_HC_Database_01
    integer array           udg_HC_register
    unit array              udg_HC_register_unit
    boolean                 udg_HC_Lock                = false
    group                   udg_SK_Yukari_Gap          = null
    integer                 udg_SK_Yukari_Count        = 0
    rect                    udg_MapRegion              = null
    rect                    udg_MapRegionScreen        = null
    location array          udg_RecoverPoint
    location array          udg_BirthPoint
    integer                 udg_SK_Rumia04_Str         = 0
    group                   udg_SK_Wriggle03_Group     = null
    location                udg_BackStage              = null
    integer                 udg_SK_AliceDollsCounting  = 0
    group                   udg_SK_AliceDollsCountingGroup = null
    unit array              udg_SK_ShanghaiJSA
    integer array           udg_AI_Characters
    integer array           udg_AI_register
    unit array              udg_AI_register_unit
    string array            udg_SK_Shikieiki_Degree
    unit                    udg_u                      = null
    item array              udg_SK_Nitori_Bag
    location                udg_CommonPoint            = null
    string array            udg_ACSII
    real array              udg_TP_Response
    real array              udg_CE_Response
    real array              udg_CE_register
    integer array           udg_CE_state
    lightning array         udg_SK_Nazrin04_Lightning
    boolean                 udg_SK_Nazrin04_ON         = false
    unit                    udg_SK_Nazrin03_Target     = null
    unit                    udg_SK_Hina01_Unit         = null
    boolean                 udg_SK_Nazrin_Pick         = false
    integer                 udg_HostPlayerId           = 0
    location array          udg_AI_Waypoints
    integer array           udg_AI_States
    hashtable               udg_HeroDatabase           = null
    boolean                 udg_SK_Nitori_Load         = false
    boolean array           udg_Smileys
    integer array           udg_SmileysLast
    integer                 udg_SK_nue_nightmare_buff  = 0
    integer                 udg_SK_nue_nightmare_insc  = 0
    integer                 udg_SK_Keine_Wolf          = 0
    unit                    udg_SK_Keine               = null
    integer                 udg_SK_Keine_Str           = 0
    integer array           udg_SK_YYY
    integer                 udg_SK_uuz03_switch        = 0
    integer                 udg_SK_uuzre_switch        = 0
    boolean                 udg_SK_Koishi04_value      = false
    integer                 udg_SK_Keine04_count       = 0
    player                  udg_SK_nue_rscd_player     = null
    integer array           udg_SK_Kafziel
    unit                    udg_SK_Cirno_Cirno         = null
    integer                 udg_SK_Cirno_Baga          = 0
    integer                 udg_SK_Twei03_Iff          = 0
    boolean                 udg_SK_Twei03_Moving       = false
    unit                    udg_SK_Twei04_Twei         = null
    boolean                 udg_AUD_FirstRun           = false
    unit                    udg_SK_Yuka_Unit           = null
    unit array              udg_SK_Utsuho04_Sun
    integer                 udg_SK_Kaguya_Rewind       = 0
    integer                 udg_SK_Kaguya_RewindIncre  = 0
    integer array           udg_HeroPickA
    integer array           udg_HeroPickB
    unit array              udg_PlayerHeroesBan
    real array              udg_MRS_ResistStoreValue
    integer                 udg_MRS_ResistBuffCount    = 0
    real array              udg_MRS_ResistStoreValueDiminish
    integer                 udg_MRS_ResistBuffCountDiminish = 0
    real                    udg_MRS_ResistDecreaseValue = 0
    integer                 udg_SK_Lunasa02_Buff       = 0
    integer                 udg_SK_MeirinStar          = 0
    boolean                 udg_SK_Toramaru01_CoolDown = false
    boolean array           udg_SK_BLTalismanicCoolDown
    boolean array           udg_SK_BLTalismanicAvaliable
    integer                 udg_SK_Sakuya04_Mana01     = 0
    boolean                 udg_SK_Sakuya04_Switch     = false
    boolean                 udg_SK_SakuyaEX_ClockSwitch = false
    integer                 udg_SK_Sakuya04_Mana02     = 0
    integer                 udg_SK_Sakuya04_Mana03     = 0
    effect                  udg_SK_SakuyaEX_Effect     = null
    integer                 udg_SK_ToramaruDB_Count    = 0
    unit                    udg_SK_Toramaru            = null
    integer                 udg_SK_Sakuya04_Mana04     = 0
    integer                 udg_SK_KisumeEX_Count      = 0
    real                    udg_SK_Kisume03_Count      = 0
    effect                  udg_SK_Kisume03_Effect     = null
    unit                    udg_SK_Yuugi               = null
    boolean                 udg_SK_Yuugi_Roar_CD       = false
    unit                    udg_SK_Minoriko            = null
    unit                    udg_SK_Komachi             = null
    boolean                 udg_SK_Youmu02_Illusion_Count = false
    boolean                 udg_SK_Reisen02            = false
    unit                    udg_SK_Reisen01_Target     = null
    boolean                 udg_TestMode_Close         = false
    unit                    udg_SK_Merlin04_Target     = null
    integer                 udg_SK_MerlinEx_Count      = 0
    unit                    udg_SK_Kaguya_Summon01     = null
    unit                    udg_SK_Kaguya_Summon02     = null
    unit                    udg_SK_Kaguya_Summon03     = null
    unit                    udg_SK_Kaguya_Summon04     = null
    unit                    udg_SK_Kaguya_Target       = null
    boolean                 udg_SK_EyeBugModeOn        = false
    unit                    udg_SK_Nazirin             = null
    effect                  udg_SK_Toramaru01_Effect   = null
    hashtable               udg_SK_Shikieiki_Count     = null
    unit                    udg_SK_Shikieiki           = null
    integer array           udg_FlagAssist

    // Generated
    rect                    gg_rct_AI_Waypoint_00      = null
    rect                    gg_rct_AI_Waypoint_01      = null
    rect                    gg_rct_AI_Waypoint_02      = null
    rect                    gg_rct_AI_Waypoint_03      = null
    rect                    gg_rct_AI_Waypoint_04      = null
    rect                    gg_rct_AI_Waypoint_05      = null
    rect                    gg_rct_AI_Waypoint_B0      = null
    rect                    gg_rct_AI_Waypoint_B1      = null
    rect                    gg_rct_AI_Waypoint_B2      = null
    rect                    gg_rct_AI_Waypoint_B3      = null
    rect                    gg_rct_BackStage           = null
    rect                    gg_rct_BaseA               = null
    rect                    gg_rct_BaseB               = null
    rect                    gg_rct_BirthA              = null
    rect                    gg_rct_BirthB              = null
    rect                    gg_rct_BoatL               = null
    rect                    gg_rct_BoatR               = null
    rect                    gg_rct_CommonArea          = null
    rect                    gg_rct_Creeps00a           = null
    rect                    gg_rct_Creeps01a           = null
    rect                    gg_rct_Creeps02b           = null
    rect                    gg_rct_Creeps03b           = null
    rect                    gg_rct_Creeps04b           = null
    rect                    gg_rct_Creeps05b           = null
    rect                    gg_rct_Creeps06b           = null
    rect                    gg_rct_Creeps07b           = null
    rect                    gg_rct_EyePoint01          = null
    rect                    gg_rct_EyePoint02          = null
    rect                    gg_rct_EyePoint03          = null
    rect                    gg_rct_EyePoint04          = null
    rect                    gg_rct_EyePoint05          = null
    rect                    gg_rct_EyePoint06          = null
    rect                    gg_rct_EyePoint07          = null
    rect                    gg_rct_EyePoint08          = null
    rect                    gg_rct_EyePoint09          = null
    rect                    gg_rct_EyePoint10          = null
    rect                    gg_rct_EyePoint11          = null
    rect                    gg_rct_EyePoint12          = null
    rect                    gg_rct_FallingLeaves       = null
    rect                    gg_rct_HarborL             = null
    rect                    gg_rct_HarborR             = null
    rect                    gg_rct_Jump1bot            = null
    rect                    gg_rct_Jump1top            = null
    rect                    gg_rct_Jump2bot            = null
    rect                    gg_rct_Jump2top            = null
    rect                    gg_rct_Jump3bot            = null
    rect                    gg_rct_Jump3top            = null
    rect                    gg_rct_Jump4bot            = null
    rect                    gg_rct_Jump4top            = null
    rect                    gg_rct_Jump5bot            = null
    rect                    gg_rct_Jump5top            = null
    rect                    gg_rct_Jump6bot            = null
    rect                    gg_rct_Jump6top            = null
    rect                    gg_rct_PlayerCSS_A1        = null
    rect                    gg_rct_PlayerCSS_A2        = null
    rect                    gg_rct_PlayerCSS_A3        = null
    rect                    gg_rct_PlayerCSS_A4        = null
    rect                    gg_rct_PlayerCSS_A5        = null
    rect                    gg_rct_PlayerCSS_B1        = null
    rect                    gg_rct_PlayerCSS_B2        = null
    rect                    gg_rct_PlayerCSS_B3        = null
    rect                    gg_rct_PlayerCSS_B4        = null
    rect                    gg_rct_PlayerCSS_B5        = null
    rect                    gg_rct_PlayerCSS_C0        = null
    rect                    gg_rct_PreloadUnits        = null
    rect                    gg_rct_RecoverAreaA        = null
    rect                    gg_rct_RecoverAreaB        = null
    rect                    gg_rct_RedFog              = null
    rect                    gg_rct_ReviveA             = null
    rect                    gg_rct_ReviveB             = null
    rect                    gg_rct_Rune1               = null
    rect                    gg_rct_Rune2               = null
    rect                    gg_rct_SpawnA0             = null
    rect                    gg_rct_SpawnA1             = null
    rect                    gg_rct_SpawnA2             = null
    rect                    gg_rct_SpawnB0             = null
    rect                    gg_rct_SpawnB1             = null
    rect                    gg_rct_SpawnB2             = null
    rect                    gg_rct_SunShine            = null
    rect                    gg_rct_TargetA             = null
    rect                    gg_rct_TargetB             = null
    rect                    gg_rct_WayPoint_0_0        = null
    rect                    gg_rct_WayPoint_0_1        = null
    rect                    gg_rct_WayPoint_0_2        = null
    rect                    gg_rct_WayPoint_0_3        = null
    rect                    gg_rct_WayPoint_0_4        = null
    rect                    gg_rct_WayPoint_0_5        = null
    rect                    gg_rct_WayPoint_1_0        = null
    rect                    gg_rct_WayPoint_1_1        = null
    rect                    gg_rct_WayPoint_1_2        = null
    rect                    gg_rct_WayPoint_1_3        = null
    rect                    gg_rct_WayPoint_1_4        = null
    rect                    gg_rct_WayPoint_1_5        = null
    rect                    gg_rct_WayPoint_2_0        = null
    rect                    gg_rct_WayPoint_2_1        = null
    rect                    gg_rct_WayPoint_2_2        = null
    rect                    gg_rct_WayPoint_2_3        = null
    rect                    gg_rct_WayPoint_2_4        = null
    rect                    gg_rct_WayPoint_2_5        = null
    rect                    gg_rct_EyePoint01resort    = null
    rect                    gg_rct_EyePoint02resort    = null
    rect                    gg_rct_EyePoint03resort    = null
    rect                    gg_rct_EyePoint04resort    = null
    rect                    gg_rct_EyePoint05resort    = null
    rect                    gg_rct_EyePoint06resort    = null
    rect                    gg_rct_EyePoint07resort    = null
    rect                    gg_rct_EyePoint08resort    = null
    rect                    gg_rct_EyePoint09resort    = null
    rect                    gg_rct_EyePoint10resort    = null
    rect                    gg_rct_EyePoint11resort    = null
    rect                    gg_rct_EyePoint12resort    = null
    rect                    gg_rct_RunesTeleport01     = null
    rect                    gg_rct_RunesTeleport02     = null
    rect                    gg_rct_RunesTeleport03     = null
    rect                    gg_rct_RunesTeleport04     = null
    rect                    gg_rct_RunesTeleport05     = null
    rect                    gg_rct_RunesTeleport06     = null
    rect                    gg_rct_RunesTeleport07     = null
    sound                   gg_snd_Yuugi               = null
    sound                   gg_snd_Dlss                = null
    sound                   gg_snd_BattleShipDeath1    = null
    sound                   gg_snd_LightningShieldTarget = null
    sound                   gg_snd_Suika04             = null
    sound                   gg_snd_Weather             = null
    sound                   gg_snd_RollingThunder1     = null
    sound                   gg_snd_SargerasRoar        = null
    sound                   gg_snd_GetPower            = null
    sound                   gg_snd_PaladinDivineShieldDeath1 = null
    sound                   gg_snd_TinkerMorph1        = null
    sound                   gg_snd_SteamTankYes1       = null
    sound                   gg_snd_TrumpetChorusA_u    = null
    sound                   gg_snd_TrumpetChorusD      = null
    sound                   gg_snd_TrumpetChorus_01    = null
    sound                   gg_snd_TrumpetChorus_02    = null
    sound                   gg_snd_TrumpetChorus_03    = null
    trigger                 gg_trg_OpenSmileys         = null
    trigger                 gg_trg_QuickSmileys        = null
    trigger                 gg_trg_Systems             = null
    trigger                 gg_trg_Override_Systems    = null
    trigger                 gg_trg_Misc                = null
    trigger                 gg_trg_Any_Unit_Damaged    = null
    trigger                 gg_trg_Magic_Resist_Systems = null
    trigger                 gg_trg_AI_System           = null
    trigger                 gg_trg_HC_System           = null
    trigger                 gg_trg_Setting_Balance     = null
    trigger                 gg_trg_Setting_Character_A = null
    trigger                 gg_trg_Setting_Character_B = null
    trigger                 gg_trg_Setting_Item_System_Table_1 = null
    trigger                 gg_trg_Setting_Item_System_Table_2 = null
    trigger                 gg_trg_Setting_Neutrals    = null
    trigger                 gg_trg_Setting_Spawn       = null
    trigger                 gg_trg_Setting_Item_System_Table_3 = null
    trigger                 gg_trg_About_Map           = null
    trigger                 gg_trg_Announce            = null
    trigger                 gg_trg_Master_Initialization = null
    trigger                 gg_trg_Master_Trigger      = null
    trigger                 gg_trg_Initialization_Players = null
    trigger                 gg_trg_Initialization_UDG  = null
    trigger                 gg_trg_Initialization_Locations = null
    trigger                 gg_trg_Enter_Mode_Select   = null
    trigger                 gg_trg_Mode_Select_Step_1  = null
    trigger                 gg_trg_Mode_Select_Step_2  = null
    trigger                 gg_trg_Mode_Select_Time_Out = null
    trigger                 gg_trg_Initialization_CSS  = null
    trigger                 gg_trg_Enter_Character_Select_Screen = null
    trigger                 gg_trg_CSS                 = null
    trigger                 gg_trg_CSS_GUI             = null
    trigger                 gg_trg_CSS_Event           = null
    trigger                 gg_trg_CSS_Main            = null
    trigger                 gg_trg_CSS_Ban_Mode        = null
    trigger                 gg_trg_CSS_Ban_Mode_Step2  = null
    trigger                 gg_trg_CSS_Ban_Pick        = null
    trigger                 gg_trg_CSS_Action          = null
    trigger                 gg_trg_CSS_Setup           = null
    trigger                 gg_trg_CSS_AI              = null
    trigger                 gg_trg_CSS_Finish          = null
    trigger                 gg_trg_GIB                 = null
    trigger                 gg_trg_Setup_Game_Info_Board = null
    trigger                 gg_trg_Set_GIB_Clock       = null
    trigger                 gg_trg_Resource_System     = null
    trigger                 gg_trg_Spirit              = null
    trigger                 gg_trg_Power_Create        = null
    trigger                 gg_trg_Power_Get           = null
    trigger                 gg_trg_Power_Lost          = null
    trigger                 gg_trg_Initialization_Spawn = null
    trigger                 gg_trg_Route_A             = null
    trigger                 gg_trg_Route_B             = null
    trigger                 gg_trg_Route_Order         = null
    trigger                 gg_trg_Keep_Order_A        = null
    trigger                 gg_trg_Keep_Order_B        = null
    trigger                 gg_trg_Spawn_A             = null
    trigger                 gg_trg_Spawn_B             = null
    trigger                 gg_trg_Spawn_Levelup       = null
    trigger                 gg_trg_Spawn_Units_AI      = null
    trigger                 gg_trg_Refresh_Order       = null
    trigger                 gg_trg_Initialization_Base = null
    trigger                 gg_trg_Tower_Break_A       = null
    trigger                 gg_trg_Tower_Break_A_Patch = null
    trigger                 gg_trg_Tower_Break_B       = null
    trigger                 gg_trg_Tower_Break_B_Patch = null
    trigger                 gg_trg_Initialization_Weather = null
    trigger                 gg_trg_Weather_Change      = null
    trigger                 gg_trg_Weather_Fog_System  = null
    trigger                 gg_trg_Weather_Shrine_Reset = null
    trigger                 gg_trg_Weather_Trigger     = null
    trigger                 gg_trg_Weather_Effect_Create = null
    trigger                 gg_trg_Weather_Effect_Remove = null
    trigger                 gg_trg_Weather_Effect_Spell = null
    trigger                 gg_trg_Weather_Spell_02    = null
    trigger                 gg_trg_Weather_Spell_02_Off = null
    trigger                 gg_trg_Initialization_Defence = null
    trigger                 gg_trg_Defence_DefArea     = null
    trigger                 gg_trg_Defence_Eating      = null
    trigger                 gg_trg_Defence_BL          = null
    trigger                 gg_trg_Defence_Control_1   = null
    trigger                 gg_trg_Defence_SpdArea     = null
    trigger                 gg_trg_Defence_SCV         = null
    trigger                 gg_trg_Defence_God         = null
    trigger                 gg_trg_Defence_Control_2   = null
    trigger                 gg_trg_RuneBorn            = null
    trigger                 gg_trg_Rune                = null
    trigger                 gg_trg_Tree_Bridge         = null
    trigger                 gg_trg_Trees_Relife        = null
    trigger                 gg_trg_Bridge_Restore      = null
    trigger                 gg_trg_BoatRL              = null
    trigger                 gg_trg_BoatLR              = null
    trigger                 gg_trg_Jump1               = null
    trigger                 gg_trg_Jump2               = null
    trigger                 gg_trg_Jump3               = null
    trigger                 gg_trg_Jump4               = null
    trigger                 gg_trg_Jump5               = null
    trigger                 gg_trg_Jump6               = null
    trigger                 gg_trg_GoodMan             = null
    trigger                 gg_trg_Initialization_Market = null
    trigger                 gg_trg_Item_System         = null
    trigger                 gg_trg_Item_Exchange       = null
    trigger                 gg_trg_Initialization_CE   = null
    trigger                 gg_trg_CE_Input            = null
    trigger                 gg_trg_CE_Bonus            = null
    trigger                 gg_trg_Announce_Bonus      = null
    trigger                 gg_trg_Game_Start          = null
    trigger                 gg_trg_Time_Event          = null
    trigger                 gg_trg_Money               = null
    trigger                 gg_trg_Share               = null
    trigger                 gg_trg_Point_Creat         = null
    trigger                 gg_trg_Point_Delete        = null
    trigger                 gg_trg_Attack              = null
    trigger                 gg_trg_Deny                = null
    trigger                 gg_trg_Hero_Event          = null
    trigger                 gg_trg_Victory             = null
    trigger                 gg_trg_Player_Left         = null
    trigger                 gg_trg_FeetManFix          = null
    trigger                 gg_trg_Neutral_System      = null
    trigger                 gg_trg_ItemClear           = null
    trigger                 gg_trg_Init_Abilities      = null
    trigger                 gg_trg_Marisa01            = null
    trigger                 gg_trg_Marisa02            = null
    trigger                 gg_trg_Marisa03            = null
    trigger                 gg_trg_Marisa04            = null
    trigger                 gg_trg_Initial_Marisa      = null
    trigger                 gg_trg_SakuyaDS            = null
    trigger                 gg_trg_SakuyaClock         = null
    trigger                 gg_trg_Sakuya01            = null
    trigger                 gg_trg_Sakuya02            = null
    trigger                 gg_trg_Sakuya03            = null
    trigger                 gg_trg_Sakuya04            = null
    trigger                 gg_trg_Sakuya04_Reset      = null
    trigger                 gg_trg_Sakuya04_Enter      = null
    trigger                 gg_trg_Initial_Sakuya      = null
    trigger                 gg_trg_ReimuEx             = null
    trigger                 gg_trg_Reimu01             = null
    trigger                 gg_trg_Reimu02             = null
    trigger                 gg_trg_Reimu03             = null
    trigger                 gg_trg_Reimu04             = null
    trigger                 gg_trg_Initial_Reimu       = null
    trigger                 gg_trg_YukariEyebug        = null
    trigger                 gg_trg_Yukari02            = null
    trigger                 gg_trg_Yukari02_Gap_Dump   = null
    trigger                 gg_trg_Yukari02_Mega_Dump  = null
    trigger                 gg_trg_Yukari03            = null
    trigger                 gg_trg_Yukari04_New        = null
    trigger                 gg_trg_Yukari04_New_Effect = null
    trigger                 gg_trg_Yukari04_DS         = null
    trigger                 gg_trg_Initial_Yukari      = null
    trigger                 gg_trg_IkuTime             = null
    trigger                 gg_trg_Iku01               = null
    trigger                 gg_trg_Iku02               = null
    trigger                 gg_trg_Iku03_Active        = null
    trigger                 gg_trg_Iku03               = null
    trigger                 gg_trg_Iku04               = null
    trigger                 gg_trg_Initial_Iku         = null
    trigger                 gg_trg_Mokou01             = null
    trigger                 gg_trg_Mokou02             = null
    trigger                 gg_trg_Mokou03             = null
    trigger                 gg_trg_Mokou04             = null
    trigger                 gg_trg_Mokou04_End         = null
    trigger                 gg_trg_Mokou04_AOE         = null
    trigger                 gg_trg_Initial_Mokou       = null
    trigger                 gg_trg_Yuyuko_Rekill       = null
    trigger                 gg_trg_Yuyuko01            = null
    trigger                 gg_trg_Yuyuko02            = null
    trigger                 gg_trg_Yuyuko03            = null
    trigger                 gg_trg_Yuyuko03_Damage     = null
    trigger                 gg_trg_Yuyuko03_Switch     = null
    trigger                 gg_trg_Yuyuko04            = null
    trigger                 gg_trg_Yuyuko04_Learn      = null
    trigger                 gg_trg_Init_Yuyuko         = null
    trigger                 gg_trg_AyaDS               = null
    trigger                 gg_trg_Aya01               = null
    trigger                 gg_trg_Aya02               = null
    trigger                 gg_trg_Aya02_Use           = null
    trigger                 gg_trg_Aya03               = null
    trigger                 gg_trg_Aya04               = null
    trigger                 gg_trg_Initial_Aya         = null
    trigger                 gg_trg_Suika01             = null
    trigger                 gg_trg_Suika02             = null
    trigger                 gg_trg_Suika03             = null
    trigger                 gg_trg_Suika04             = null
    trigger                 gg_trg_Initial_Suika       = null
    trigger                 gg_trg_Youmu01             = null
    trigger                 gg_trg_Youmu02             = null
    trigger                 gg_trg_Youmu03             = null
    trigger                 gg_trg_Youmu04             = null
    trigger                 gg_trg_Initial_Youmu       = null
    trigger                 gg_trg_Reisen_Attack       = null
    trigger                 gg_trg_Reisen01            = null
    trigger                 gg_trg_Reisen01_Count      = null
    trigger                 gg_trg_Reisen02_New        = null
    trigger                 gg_trg_Reisen03            = null
    trigger                 gg_trg_Reisen04            = null
    trigger                 gg_trg_Init_Reisen         = null
    trigger                 gg_trg_CirnoBaga           = null
    trigger                 gg_trg_Cirno01             = null
    trigger                 gg_trg_Cirno02             = null
    trigger                 gg_trg_Cirno03             = null
    trigger                 gg_trg_Cirno04             = null
    trigger                 gg_trg_Initial_Cirno       = null
    trigger                 gg_trg_FlandreBroker       = null
    trigger                 gg_trg_Flandre01           = null
    trigger                 gg_trg_Flandre02           = null
    trigger                 gg_trg_Flandre02_Skill     = null
    trigger                 gg_trg_Flandre04           = null
    trigger                 gg_trg_Initial_Flandre     = null
    trigger                 gg_trg_SanaeEx             = null
    trigger                 gg_trg_Sanae01             = null
    trigger                 gg_trg_Sanae02             = null
    trigger                 gg_trg_Sanae03             = null
    trigger                 gg_trg_Sanae04             = null
    trigger                 gg_trg_Initial_Sanae       = null
    trigger                 gg_trg_TensiDS             = null
    trigger                 gg_trg_Tensi01             = null
    trigger                 gg_trg_Tensi02             = null
    trigger                 gg_trg_Tensi03             = null
    trigger                 gg_trg_Tensi04             = null
    trigger                 gg_trg_Init_Tensi          = null
    trigger                 gg_trg_UtsuhoEx            = null
    trigger                 gg_trg_Utsuho01            = null
    trigger                 gg_trg_Utsuho02            = null
    trigger                 gg_trg_Utsuho03            = null
    trigger                 gg_trg_Utsuho04            = null
    trigger                 gg_trg_Initial_Utsuho      = null
    trigger                 gg_trg_Rumia01             = null
    trigger                 gg_trg_Rumia02             = null
    trigger                 gg_trg_Rumia03             = null
    trigger                 gg_trg_Rumia04             = null
    trigger                 gg_trg_Rumia04_Lost        = null
    trigger                 gg_trg_Initial_Rumia       = null
    trigger                 gg_trg_YukaFlower          = null
    trigger                 gg_trg_YukaFlower_Levelup  = null
    trigger                 gg_trg_Yuka01              = null
    trigger                 gg_trg_Yuka02              = null
    trigger                 gg_trg_Yuka03              = null
    trigger                 gg_trg_Yuka04              = null
    trigger                 gg_trg_Initial_Yuka        = null
    trigger                 gg_trg_Medi02              = null
    trigger                 gg_trg_Medi03              = null
    trigger                 gg_trg_Medi04              = null
    trigger                 gg_trg_Initial_Medi        = null
    trigger                 gg_trg_EirinSage           = null
    trigger                 gg_trg_Eirin01             = null
    trigger                 gg_trg_Eirin02             = null
    trigger                 gg_trg_Eirin03             = null
    trigger                 gg_trg_Eirin04             = null
    trigger                 gg_trg_Initial_Eirin       = null
    trigger                 gg_trg_KaguyaEx            = null
    trigger                 gg_trg_Kaguya01            = null
    trigger                 gg_trg_Kaguya02            = null
    trigger                 gg_trg_Kaguya03            = null
    trigger                 gg_trg_Kaguya04            = null
    trigger                 gg_trg_Init_Kaguya         = null
    trigger                 gg_trg_Letty01             = null
    trigger                 gg_trg_Letty02New          = null
    trigger                 gg_trg_Letty02             = null
    trigger                 gg_trg_Letty02main         = null
    trigger                 gg_trg_Letty04             = null
    trigger                 gg_trg_Initial_Letty       = null
    trigger                 gg_trg_Nitori_Bag          = null
    trigger                 gg_trg_Nitori_Loaded       = null
    trigger                 gg_trg_Nitori01            = null
    trigger                 gg_trg_Nitori02            = null
    trigger                 gg_trg_Nitori03            = null
    trigger                 gg_trg_Nitori03_Active     = null
    trigger                 gg_trg_Nitori04            = null
    trigger                 gg_trg_Initial_Nitori      = null
    trigger                 gg_trg_YamameDS            = null
    trigger                 gg_trg_Yamame_Dis          = null
    trigger                 gg_trg_Yamame01            = null
    trigger                 gg_trg_Yamame02            = null
    trigger                 gg_trg_Yamame03            = null
    trigger                 gg_trg_Yamame04            = null
    trigger                 gg_trg_Initial_Spider      = null
    trigger                 gg_trg_Yuugi_Roar          = null
    trigger                 gg_trg_Yuugi01             = null
    trigger                 gg_trg_Yuugi02             = null
    trigger                 gg_trg_Yuugi03             = null
    trigger                 gg_trg_Yuugi04             = null
    trigger                 gg_trg_Initial_Yuugi       = null
    trigger                 gg_trg_Wriggle01           = null
    trigger                 gg_trg_Wriggle02           = null
    trigger                 gg_trg_Wriggle03           = null
    trigger                 gg_trg_Wriggle04           = null
    trigger                 gg_trg_Initial_Wriggle     = null
    trigger                 gg_trg_CaptainEyebug01     = null
    trigger                 gg_trg_CaptainEyebug02     = null
    trigger                 gg_trg_CaptainEyebug03     = null
    trigger                 gg_trg_CaptainEyebug04     = null
    trigger                 gg_trg_CaptainEyebug05     = null
    trigger                 gg_trg_CaptainEyebug06     = null
    trigger                 gg_trg_CaptainEyebug07     = null
    trigger                 gg_trg_CaptainEyebug08     = null
    trigger                 gg_trg_CaptainEyebug09     = null
    trigger                 gg_trg_CaptainEyebug10     = null
    trigger                 gg_trg_CaptainEyebug11     = null
    trigger                 gg_trg_CaptainEyebug12     = null
    trigger                 gg_trg_Captain01           = null
    trigger                 gg_trg_Captain02           = null
    trigger                 gg_trg_Captain03           = null
    trigger                 gg_trg_Captain04_Learn     = null
    trigger                 gg_trg_Captain04_Reg       = null
    trigger                 gg_trg_Captain04_LostShip  = null
    trigger                 gg_trg_Captain04_jiasu     = null
    trigger                 gg_trg_Captain04_jiansu    = null
    trigger                 gg_trg_Captain04_yongjiutingbo = null
    trigger                 gg_trg_Captain04_nihility  = null
    trigger                 gg_trg_Captain04_CallBack  = null
    trigger                 gg_trg_Initial_Captain     = null
    trigger                 gg_trg_Shikieiki01         = null
    trigger                 gg_trg_Shikieiki01_Active  = null
    trigger                 gg_trg_Shikieiki01_Display = null
    trigger                 gg_trg_Shikieiki01_Death   = null
    trigger                 gg_trg_Shikieiki02         = null
    trigger                 gg_trg_Shikieiki03         = null
    trigger                 gg_trg_Shikieiki04         = null
    trigger                 gg_trg_Initial_Shikieiki   = null
    trigger                 gg_trg_Cat01_Reg           = null
    trigger                 gg_trg_Cat01_BodyGet       = null
    trigger                 gg_trg_Cat01_BodyRemove    = null
    trigger                 gg_trg_Cat01_LimitBodyGet  = null
    trigger                 gg_trg_Cat02               = null
    trigger                 gg_trg_Cat03               = null
    trigger                 gg_trg_Cat04               = null
    trigger                 gg_trg_Initial_Cat         = null
    trigger                 gg_trg_KogasaDS            = null
    trigger                 gg_trg_Kogasa01            = null
    trigger                 gg_trg_Kogasa02            = null
    trigger                 gg_trg_Kogasa03            = null
    trigger                 gg_trg_Kogasa03_Learn      = null
    trigger                 gg_trg_Kogasa04_Check      = null
    trigger                 gg_trg_Kogasa04            = null
    trigger                 gg_trg_Kogasa04_Cancel     = null
    trigger                 gg_trg_Umbrella04_Start    = null
    trigger                 gg_trg_Initial_Umbrella    = null
    trigger                 gg_trg_Remilia01           = null
    trigger                 gg_trg_Remilia02           = null
    trigger                 gg_trg_Remilia03           = null
    trigger                 gg_trg_Remilia04           = null
    trigger                 gg_trg_Initial_Remilia     = null
    trigger                 gg_trg_Komachi01           = null
    trigger                 gg_trg_Komachi03           = null
    trigger                 gg_trg_Komachi04           = null
    trigger                 gg_trg_KomachiGhostExplosion = null
    trigger                 gg_trg_KomachiALLExplosion = null
    trigger                 gg_trg_Initial_Komachi     = null
    trigger                 gg_trg_Nazrin_Pet          = null
    trigger                 gg_trg_Nazrin01            = null
    trigger                 gg_trg_Nazrin02            = null
    trigger                 gg_trg_Nazrin03            = null
    trigger                 gg_trg_Nazrin04            = null
    trigger                 gg_trg_Nazrin04_Switch     = null
    trigger                 gg_trg_Init_Nazrin         = null
    trigger                 gg_trg_MystiaFly           = null
    trigger                 gg_trg_Mystia01            = null
    trigger                 gg_trg_Mystia02            = null
    trigger                 gg_trg_Mystia03            = null
    trigger                 gg_trg_Mystia04            = null
    trigger                 gg_trg_Init_Mystia         = null
    trigger                 gg_trg_Koishi01            = null
    trigger                 gg_trg_Koishi02            = null
    trigger                 gg_trg_Koishi04            = null
    trigger                 gg_trg_Koishi04_DS         = null
    trigger                 gg_trg_Init_Koishi         = null
    trigger                 gg_trg_Hina01              = null
    trigger                 gg_trg_Hina02              = null
    trigger                 gg_trg_Hina03              = null
    trigger                 gg_trg_Hina04              = null
    trigger                 gg_trg_Initial_Hina        = null
    trigger                 gg_trg_Ran01               = null
    trigger                 gg_trg_Ran01Up             = null
    trigger                 gg_trg_Ran02               = null
    trigger                 gg_trg_Ran03               = null
    trigger                 gg_trg_Ran04               = null
    trigger                 gg_trg_Chen                = null
    trigger                 gg_trg_Chen02              = null
    trigger                 gg_trg_Chen03              = null
    trigger                 gg_trg_Initial_Ran         = null
    trigger                 gg_trg_Kanako01            = null
    trigger                 gg_trg_Kanako02            = null
    trigger                 gg_trg_Kanako03            = null
    trigger                 gg_trg_Kanako04            = null
    trigger                 gg_trg_KanakoEX01          = null
    trigger                 gg_trg_KanakoEX02          = null
    trigger                 gg_trg_KanakoEX03          = null
    trigger                 gg_trg_Init_Kanako         = null
    trigger                 gg_trg_SuwakoEx            = null
    trigger                 gg_trg_Suwako01            = null
    trigger                 gg_trg_Suwako02            = null
    trigger                 gg_trg_Suwako03            = null
    trigger                 gg_trg_Suwako04            = null
    trigger                 gg_trg_Init_Suwako         = null
    trigger                 gg_trg_Pachouli_Attack     = null
    trigger                 gg_trg_Pachouli01          = null
    trigger                 gg_trg_Pachouli02          = null
    trigger                 gg_trg_Pachouli03          = null
    trigger                 gg_trg_Pachouli04          = null
    trigger                 gg_trg_Init_Pachouli       = null
    trigger                 gg_trg_MeirinStar          = null
    trigger                 gg_trg_Meirin              = null
    trigger                 gg_trg_Meirin01            = null
    trigger                 gg_trg_Meirin02            = null
    trigger                 gg_trg_Meirin03            = null
    trigger                 gg_trg_Meirin04            = null
    trigger                 gg_trg_Init_Meirin         = null
    trigger                 gg_trg_Alice_Dolls         = null
    trigger                 gg_trg_Alice_Dolls_KIA     = null
    trigger                 gg_trg_Alice_Dolls_Back    = null
    trigger                 gg_trg_Shanghai01          = null
    trigger                 gg_trg_Shanghai02          = null
    trigger                 gg_trg_Shanghai03          = null
    trigger                 gg_trg_Shanghai04          = null
    trigger                 gg_trg_Shanghai04_Issue    = null
    trigger                 gg_trg_Shanghai04_Alice    = null
    trigger                 gg_trg_Hourai01            = null
    trigger                 gg_trg_Hourai02            = null
    trigger                 gg_trg_Hourai04            = null
    trigger                 gg_trg_NewEngland01        = null
    trigger                 gg_trg_NewEngland03        = null
    trigger                 gg_trg_NewEngland04        = null
    trigger                 gg_trg_Alice               = null
    trigger                 gg_trg_Alice01             = null
    trigger                 gg_trg_Alice02             = null
    trigger                 gg_trg_Alice03             = null
    trigger                 gg_trg_Alice_Onboard       = null
    trigger                 gg_trg_Init_Alice          = null
    trigger                 gg_trg_Satori01            = null
    trigger                 gg_trg_Satori01_Collect    = null
    trigger                 gg_trg_Satori02            = null
    trigger                 gg_trg_Satori03            = null
    trigger                 gg_trg_Satori04            = null
    trigger                 gg_trg_Init_Satori         = null
    trigger                 gg_trg_shizuha01           = null
    trigger                 gg_trg_Shizuha02           = null
    trigger                 gg_trg_shizuha03           = null
    trigger                 gg_trg_Shizuha04           = null
    trigger                 gg_trg_Init_Shizuha        = null
    trigger                 gg_trg_Minoriko_Harvest    = null
    trigger                 gg_trg_Minoriko01          = null
    trigger                 gg_trg_Minoriko02          = null
    trigger                 gg_trg_Minoriko03          = null
    trigger                 gg_trg_Minoriko04          = null
    trigger                 gg_trg_Init_Minoriko       = null
    trigger                 gg_trg_Momizi01            = null
    trigger                 gg_trg_Momizi02            = null
    trigger                 gg_trg_Momizi03            = null
    trigger                 gg_trg_Init_Momizi         = null
    trigger                 gg_trg_NueAttack           = null
    trigger                 gg_trg_NueIllusionKill     = null
    trigger                 gg_trg_Nue01               = null
    trigger                 gg_trg_Nue02               = null
    trigger                 gg_trg_Nue03               = null
    trigger                 gg_trg_Nue04               = null
    trigger                 gg_trg_Initial_Nue         = null
    trigger                 gg_trg_Keine_Ability_Change = null
    trigger                 gg_trg_Keine01             = null
    trigger                 gg_trg_Keine02             = null
    trigger                 gg_trg_Keine03             = null
    trigger                 gg_trg_Keine04             = null
    trigger                 gg_trg_Initial_Keine       = null
    trigger                 gg_trg_Byakuren01          = null
    trigger                 gg_trg_Byakuren02          = null
    trigger                 gg_trg_Byakuren03          = null
    trigger                 gg_trg_Byakuren04          = null
    trigger                 gg_trg_Byakuren04Attack    = null
    trigger                 gg_trg_Initial_Byakuren    = null
    trigger                 gg_trg_Twei01              = null
    trigger                 gg_trg_Twei01_Death        = null
    trigger                 gg_trg_Twei02              = null
    trigger                 gg_trg_Twei03              = null
    trigger                 gg_trg_Twei03_Damage       = null
    trigger                 gg_trg_Twei04              = null
    trigger                 gg_trg_Init_Twei           = null
    trigger                 gg_trg_KoakumaLibrary      = null
    trigger                 gg_trg_Koakuma             = null
    trigger                 gg_trg_Koakuma04_Effect    = null
    trigger                 gg_trg_Init_Koakuma        = null
    trigger                 gg_trg_Sunny03             = null
    trigger                 gg_trg_Sunny04             = null
    trigger                 gg_trg_Init_Sunny          = null
    trigger                 gg_trg_Orange01            = null
    trigger                 gg_trg_Init_Orange         = null
    trigger                 gg_trg_Lunasa01            = null
    trigger                 gg_trg_Lunasa02            = null
    trigger                 gg_trg_Lunasa03            = null
    trigger                 gg_trg_Lunasa04            = null
    trigger                 gg_trg_Init_Lunasa         = null
    trigger                 gg_trg_MerlinAttack        = null
    trigger                 gg_trg_MerlinEx            = null
    trigger                 gg_trg_Merlin01            = null
    trigger                 gg_trg_Merlin02            = null
    trigger                 gg_trg_Merlin03            = null
    trigger                 gg_trg_Merlin04            = null
    trigger                 gg_trg_Merlin04_Damage     = null
    trigger                 gg_trg_Init_Merlin         = null
    trigger                 gg_trg_ToramaruDB          = null
    trigger                 gg_trg_Toramaru01          = null
    trigger                 gg_trg_Toramaru01_Attack   = null
    trigger                 gg_trg_Toramaru02          = null
    trigger                 gg_trg_Toramaru02_Learn    = null
    trigger                 gg_trg_Toramaru03          = null
    trigger                 gg_trg_Toramaru03_Kill     = null
    trigger                 gg_trg_Toramaru04          = null
    trigger                 gg_trg_Initial_Toramaru    = null
    trigger                 gg_trg_Initial_Parsee      = null
    trigger                 gg_trg_KisumeDS            = null
    trigger                 gg_trg_Kisume01            = null
    trigger                 gg_trg_Kisume02            = null
    trigger                 gg_trg_Kisume03            = null
    trigger                 gg_trg_Kisume03_Damage     = null
    trigger                 gg_trg_Kisume04            = null
    trigger                 gg_trg_Initialing_Kisume   = null
    trigger                 gg_trg_Hatate01            = null
    trigger                 gg_trg_Hatate01_Learn      = null
    trigger                 gg_trg_Hatate02            = null
    trigger                 gg_trg_Hatate02_Attack     = null
    trigger                 gg_trg_Hatate03            = null
    trigger                 gg_trg_Hatate04            = null
    trigger                 gg_trg_Hatate04_Learn      = null
    trigger                 gg_trg_Hatate04_Ex         = null
    trigger                 gg_trg_Initialing_Hatate   = null
    trigger                 gg_trg_Initialization_ItemAbilities = null
    trigger                 gg_trg_Mashroom            = null
    trigger                 gg_trg_TreeEyes            = null
    trigger                 gg_trg_Doll_Cast           = null
    trigger                 gg_trg_Doll_Issue          = null
    trigger                 gg_trg_Doll_Move           = null
    trigger                 gg_trg_Lunchbox            = null
    trigger                 gg_trg_Lunchbox_Collecting = null
    trigger                 gg_trg_ChuShou             = null
    trigger                 gg_trg_QiQiu               = null
    trigger                 gg_trg_Peach               = null
    trigger                 gg_trg_Magic_String        = null
    trigger                 gg_trg_Cirno_Ball          = null
    trigger                 gg_trg_XinHua              = null
    trigger                 gg_trg_BaGuaLu             = null
    trigger                 gg_trg_YukkuriUpgrade      = null
    trigger                 gg_trg_HuDieMengWan        = null
    trigger                 gg_trg_Hourai_Elixir       = null
    trigger                 gg_trg_Hourai_Elixir_Drop  = null
    trigger                 gg_trg_WoCaoNiMa           = null
    trigger                 gg_trg_WoCao2KuangCao      = null
    trigger                 gg_trg_KuangCao2WoCao      = null
    trigger                 gg_trg_KuangCaoManaCost    = null
    trigger                 gg_trg_LvBaHuaJiHuHang     = null
    trigger                 gg_trg_Mr_Yang             = null
    trigger                 gg_trg_Jinkela             = null
    trigger                 gg_trg_XiongGui            = null
    trigger                 gg_trg_Yukkuri_Morph       = null
    trigger                 gg_trg_DaoYao              = null
    trigger                 gg_trg_DaJiangYou          = null
    trigger                 gg_trg_TuPao               = null
    trigger                 gg_trg_Kafziel             = null
    trigger                 gg_trg_Verity              = null
    trigger                 gg_trg_YYY                 = null
    trigger                 gg_trg_CardWorseMan        = null
    trigger                 gg_trg_BLTalismanic        = null
    trigger                 gg_trg_BLTalismanicDrop    = null
    trigger                 gg_trg_CardGoodMan         = null
    trigger                 gg_trg_PadsClockThunderBolt = null
    trigger                 gg_trg_MagicHat            = null
    trigger                 gg_trg_WindGun             = null
    trigger                 gg_trg_Profess             = null
    trigger                 gg_trg_Camara              = null
    trigger                 gg_trg_Steam_Bun_And_Frog  = null
    trigger                 gg_trg_AI                  = null
    trigger                 gg_trg_Initialization_AI   = null
    trigger                 gg_trg_AI_Waypoints        = null
    trigger                 gg_trg_AI_Learn            = null
    trigger                 gg_trg_AI_Revive           = null
    trigger                 gg_trg_AI_EXP_Bonus        = null
    trigger                 gg_trg_AI_Ability          = null
    trigger                 gg_trg_AI_Action           = null
    trigger                 gg_trg_AI_Init             = null
    trigger                 gg_trg_Initialization_CMD  = null
    trigger                 gg_trg_Close_TEST_MODE     = null
    trigger                 gg_trg_Command_Move_Speed  = null
    trigger                 gg_trg_Command_Kill        = null
    trigger                 gg_trg_Command_PS          = null
    trigger                 gg_trg_PointOpen           = null
    trigger                 gg_trg_PowerOpen           = null
    trigger                 gg_trg_PointOff            = null
    trigger                 gg_trg_PowerOff            = null
    trigger                 gg_trg_TEST_MODE_OPEN      = null
    trigger                 gg_trg_TEST_MODE_OFF       = null
    trigger                 gg_trg_Debug_Fog           = null
    trigger                 gg_trg_Debug_CD            = null
    trigger                 gg_trg_Debug_Level         = null
    trigger                 gg_trg_Debug_Gold          = null
    trigger                 gg_trg_Debug_Spirit        = null
    trigger                 gg_trg_Debug_Death         = null
    trigger                 gg_trg_Debug_Level_Up_All  = null
    trigger                 gg_trg_Debug_TOD           = null
    trigger                 gg_trg_Debug_TODMORE       = null
    trigger                 gg_trg_Debug_Kill          = null
    trigger                 gg_trg_MapMain             = null
    trigger                 gg_trg_GetCurrentAbilityId = null
    trigger                 gg_trg_test                = null
    unit                    gg_unit_h00A_0057          = null
    unit                    gg_unit_h017_0107          = null
    unit                    gg_unit_h00Y_0089          = null
    unit                    gg_unit_h00A_0058          = null
    unit                    gg_unit_h00A_0056          = null
    unit                    gg_unit_h013_0053          = null
    unit                    gg_unit_h013_0052          = null
    unit                    gg_unit_h00Z_0092          = null
    unit                    gg_unit_h00U_0019          = null
    unit                    gg_unit_h00Y_0050          = null
    unit                    gg_unit_h00C_0008          = null
    unit                    gg_unit_h018_0075          = null
    unit                    gg_unit_h00C_0042          = null
    unit                    gg_unit_h018_0074          = null
    unit                    gg_unit_h016_0048          = null
    unit                    gg_unit_h018_0110          = null
    unit                    gg_unit_h016_0049          = null
    unit                    gg_unit_h00Z_0091          = null
    unit                    gg_unit_h013_0054          = null
    unit                    gg_unit_h018_0108          = null
    unit                    gg_unit_h018_0109          = null
    unit                    gg_unit_h016_0090          = null
    unit                    gg_unit_h019_0038          = null
    unit                    gg_unit_h016_0078          = null
    unit                    gg_unit_h010_0043          = null
    unit                    gg_unit_h016_0046          = null
    unit                    gg_unit_h016_0023          = null
    unit                    gg_unit_h018_0077          = null
    unit                    gg_unit_h00V_0012          = null
    unit                    gg_unit_n023_0006          = null
    unit                    gg_unit_h00D_0013          = null
    unit                    gg_unit_n000_0018          = null
    unit                    gg_unit_n03O_0079          = null
    item                    gg_item_I02O_0073          = null
    destructable            gg_dest_LTt5_0498          = null
    destructable            gg_dest_DTlv_1987          = null
    destructable            gg_dest_LT07_0951          = null
    destructable            gg_dest_LT06_0189          = null
endglobals

function InitGlobals takes nothing returns nothing
    local integer i = 0
    set udg_FlagFirst = false
    set udg_OnlinePlayers = CreateForce()
    set udg_TeamA = CreateForce()
    set udg_TeamB = CreateForce()
    set i = 0
    loop
        exitwhen (i > 1)
        set udg_ScoreSpirit[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 1)
        set udg_GameSetting_Spirit[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 1)
        set udg_GameSetting_Gold[i] = 0
        set i = i + 1
    endloop

    set udg_GameTime = 0
    set udg_OnlinePlayerSum = 0
    set i = 0
    loop
        exitwhen (i > 16)
        set udg_PlayerColors[i] = ""
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 16)
        set udg_GIB_PlayerRow[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 64)
        set udg_PlayerHeroes[i] = null
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 200)
        set udg_HeroIcon[i] = ""
        set i = i + 1
    endloop

    set udg_DebugMode = false
    set udg_ShiftPlayer = false
    set i = 0
    loop
        exitwhen (i > 16)
        set udg_PN[i] = ""
        set i = i + 1
    endloop

    set udg_TeamOB = CreateForce()
    set i = 0
    loop
        exitwhen (i > 1)
        set udg_ReviveTime[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 1)
        set udg_SU_No_A[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 1)
        set udg_SU_No_B[i] = 0
        set i = i + 1
    endloop

    set udg_NeutralFirstCreateTime = 0
    set udg_NeutralCreatePeriod = 0
    set i = 0
    loop
        exitwhen (i > 1)
        set udg_NeutralGroups[i] = ""
        set i = i + 1
    endloop

    set udg_NeutralCampsCount = 0
    set i = 0
    loop
        exitwhen (i > 1)
        set udg_NeutralCampTypes[i] = ""
        set i = i + 1
    endloop

    set udg_ItemsCount = 0
    set udg_ItemFormulasCount = 0
    set i = 0
    loop
        exitwhen (i > 1)
        set udg_ItemFormulas[i] = ""
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 10)
        set udg_PerfectText[i] = ""
        set i = i + 1
    endloop

    set udg_AI_Players = CreateForce()
    set i = 0
    loop
        exitwhen (i > 4)
        set udg_CSS_Timers[i] = CreateTimer()
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 60)
        set udg_CSS_register[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 16)
        set udg_CSS_Prepared[i] = false
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 4)
        set udg_CSS_TimeSetting[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 16)
        set udg_FlagDeath[i] = 0
        set i = i + 1
    endloop

    set udg_Weather_Type = 0
    set i = 0
    loop
        exitwhen (i > 4)
        set udg_Weather_Timer[i] = CreateTimer()
        set i = i + 1
    endloop

    set udg_Weather_SpellGroup = CreateGroup()
    set i = 0
    loop
        exitwhen (i > 1)
        set udg_GameModeName[i] = ""
        set i = i + 1
    endloop

    set udg_ModeSelectDialog = DialogCreate()
    set udg_MainTimer = CreateTimer()
    set udg_GameMode = 0
    set i = 0
    loop
        exitwhen (i > 200)
        set udg_HeroBan[i] = false
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 200)
        set udg_HeroBrief[i] = ""
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 1600)
        set udg_AI_DataBase[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 16)
        set udg_FlagPerfect[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 16)
        set udg_FlagKill[i] = 0
        set i = i + 1
    endloop

    set udg_NeutralFirstCreateTime2 = 0
    set i = 0
    loop
        exitwhen (i > 1)
        set udg_SK_Reisen[i] = 0
        set i = i + 1
    endloop

    set udg_SK_Cirno03_CD = false
    set udg_SK_Flan03_Timer = CreateTimer()
    set udg_SK_Yuugi02I = 0
    set udg_SK_Spider04I = 0
    set i = 0
    loop
        exitwhen (i > 1)
        set udg_SK_Spider04_Hero[i] = 0
        set i = i + 1
    endloop

    set udg_SK_Letty02_in = 0
    set udg_SK_Letty02_angle = 0
    set udg_SK_Letty02_Distance = 0
    set udg_SK_Letty02_Group = CreateGroup()
    set udg_SK_Letty02_Group2 = CreateGroup()
    set udg_SK_Letty02_i = 0
    set udg_SK_Letty02_Level = 0
    set i = 0
    loop
        exitwhen (i > 1)
        set udg_GameSetting_Power[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 64)
        set udg_PlayerPower[i] = 0
        set i = i + 1
    endloop

    set udg_TestMode = false
    set i = 0
    loop
        exitwhen (i > 1)
        set udg_BGM[i] = ""
        set i = i + 1
    endloop

    set udg_SK_Medi_Team = CreateForce()
    set udg_TeamSpawnA = CreateForce()
    set udg_TeamSpawnB = CreateForce()
    set udg_SK_Cat01_BodyNo = 0
    set udg_SK_Cat01_BodyGrp = CreateGroup()
    set udg_SK_Cat04_Group = CreateGroup()
    set udg_AUD_LimitRunTimes = 10
    set udg_AUD_LimitEventCount = 5000
    set udg_AUD_hasInit = false
    set udg_AUD_runCount = 0
    set udg_AUD_eventCount = 0
    set udg_AUD_heroGroup = CreateGroup()
    set i = 0
    loop
        exitwhen (i > 1)
        set udg_NPC_attackArrayTime[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 1)
        set udg_NPC_attackArrayNext[i] = 0
        set i = i + 1
    endloop

    set udg_NPC_attackArrayTop = 1
    set udg_NPC_attackArrayEnd = 0
    set udg_NPC_cycleIndex = 0
    set udg_NPC_cycleTimer = CreateTimer()
    set udg_NPC_AttackMaxTime = 3.00
    set udg_NPC_Lowlife = 0.20
    set udg_NPC_GetCycle = 0.33
    set udg_TeamS = CreateForce()
    set i = 0
    loop
        exitwhen (i > 21)
        set udg_SK_Kaguya01_RGB[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 4)
        set udg_AI_Groups[i] = CreateGroup()
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 16)
        set udg_PlayerName[i] = ""
        set i = i + 1
    endloop

    set udg_SK_Reisen02_ON = false
    set udg_SK_Kogasa04_Stun = false
    set udg_SK_Pachi04_Attacking = false
    set i = 0
    loop
        exitwhen (i > 36)
        set udg_SK_Meirin_RGB[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 2001)
        set udg_HC_Database_01[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 40)
        set udg_HC_register[i] = 0
        set i = i + 1
    endloop

    set udg_HC_Lock = false
    set udg_SK_Yukari_Gap = CreateGroup()
    set udg_SK_Yukari_Count = 0
    set udg_SK_Rumia04_Str = 0
    set udg_SK_Wriggle03_Group = CreateGroup()
    set udg_SK_AliceDollsCounting = 0
    set udg_SK_AliceDollsCountingGroup = bj_lastCreatedGroup
    set i = 0
    loop
        exitwhen (i > 8)
        set udg_AI_register[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 13)
        set udg_SK_Shikieiki_Degree[i] = ""
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 128)
        set udg_ACSII[i] = ""
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 16)
        set udg_TP_Response[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 16)
        set udg_CE_Response[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 32)
        set udg_CE_register[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 8)
        set udg_CE_state[i] = 0
        set i = i + 1
    endloop

    set udg_SK_Nazrin04_ON = false
    set udg_SK_Nazrin_Pick = false
    set udg_HostPlayerId = 0
    set i = 0
    loop
        exitwhen (i > 16)
        set udg_AI_States[i] = 0
        set i = i + 1
    endloop

    set udg_SK_Nitori_Load = false
    set i = 0
    loop
        exitwhen (i > 1)
        set udg_Smileys[i] = false
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 1)
        set udg_SmileysLast[i] = 0
        set i = i + 1
    endloop

    set udg_SK_nue_nightmare_buff = 0
    set udg_SK_nue_nightmare_insc = 0
    set udg_SK_Keine_Wolf = 0
    set udg_SK_Keine_Str = 0
    set i = 0
    loop
        exitwhen (i > 16)
        set udg_SK_YYY[i] = 0
        set i = i + 1
    endloop

    set udg_SK_uuz03_switch = 0
    set udg_SK_uuzre_switch = 0
    set udg_SK_Koishi04_value = false
    set udg_SK_Keine04_count = 0
    set i = 0
    loop
        exitwhen (i > 16)
        set udg_SK_Kafziel[i] = 0
        set i = i + 1
    endloop

    set udg_SK_Cirno_Baga = 0
    set udg_SK_Twei03_Iff = 0
    set udg_SK_Twei03_Moving = false
    set udg_AUD_FirstRun = false
    set udg_SK_Kaguya_Rewind = 0
    set udg_SK_Kaguya_RewindIncre = 0
    set i = 0
    loop
        exitwhen (i > 1)
        set udg_HeroPickA[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 1)
        set udg_HeroPickB[i] = 0
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 64)
        set udg_PlayerHeroesBan[i] = null
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 12)
        set udg_MRS_ResistStoreValue[i] = 0
        set i = i + 1
    endloop

    set udg_MRS_ResistBuffCount = 0
    set i = 0
    loop
        exitwhen (i > 12)
        set udg_MRS_ResistStoreValueDiminish[i] = 0
        set i = i + 1
    endloop

    set udg_MRS_ResistBuffCountDiminish = 0
    set udg_MRS_ResistDecreaseValue = 0
    set udg_SK_Lunasa02_Buff = 0
    set udg_SK_MeirinStar = 0
    set udg_SK_Toramaru01_CoolDown = false
    set i = 0
    loop
        exitwhen (i > 16)
        set udg_SK_BLTalismanicCoolDown[i] = false
        set i = i + 1
    endloop

    set i = 0
    loop
        exitwhen (i > 16)
        set udg_SK_BLTalismanicAvaliable[i] = false
        set i = i + 1
    endloop

    set udg_SK_Sakuya04_Mana01 = 0
    set udg_SK_Sakuya04_Switch = false
    set udg_SK_SakuyaEX_ClockSwitch = false
    set udg_SK_Sakuya04_Mana02 = 0
    set udg_SK_Sakuya04_Mana03 = 0
    set udg_SK_ToramaruDB_Count = 0
    set udg_SK_Sakuya04_Mana04 = 0
    set udg_SK_KisumeEX_Count = 0
    set udg_SK_Kisume03_Count = 0
    set udg_SK_Yuugi_Roar_CD = false
    set udg_SK_Youmu02_Illusion_Count = false
    set udg_SK_Reisen02 = false
    set udg_TestMode_Close = false
    set udg_SK_MerlinEx_Count = 0
    set udg_SK_EyeBugModeOn = false
    set i = 0
    loop
        exitwhen (i > 16)
        set udg_FlagAssist[i] = 0
        set i = i + 1
    endloop

endfunction

//***************************************************************************
//*
//*  Sounds
//*
//***************************************************************************

function InitSounds takes nothing returns nothing
    set gg_snd_Yuugi = CreateSound( "war3mapImported\\Yuugi.mp3", false, true, true, 5, 10, "DefaultEAXON" )
    call SetSoundDuration( gg_snd_Yuugi, 1992 )
    call SetSoundChannel( gg_snd_Yuugi, 0 )
    call SetSoundVolume( gg_snd_Yuugi, 127 )
    call SetSoundPitch( gg_snd_Yuugi, 1.0 )
    call SetSoundDistances( gg_snd_Yuugi, 8000.0, 10000.0 )
    call SetSoundDistanceCutoff( gg_snd_Yuugi, 100000.0 )
    call SetSoundConeAngles( gg_snd_Yuugi, 0.0, 0.0, 127 )
    call SetSoundConeOrientation( gg_snd_Yuugi, 0.0, 0.0, 0.0 )
    set gg_snd_Dlss = CreateSound( "war3mapImported\\Dlss.mp3", false, true, true, 1, 10, "SpellsEAX" )
    call SetSoundDuration( gg_snd_Dlss, 7904 )
    call SetSoundChannel( gg_snd_Dlss, 0 )
    call SetSoundVolume( gg_snd_Dlss, 127 )
    call SetSoundPitch( gg_snd_Dlss, 1.0 )
    call SetSoundDistances( gg_snd_Dlss, 600.0, 10000.0 )
    call SetSoundDistanceCutoff( gg_snd_Dlss, 3000.0 )
    call SetSoundConeAngles( gg_snd_Dlss, 0.0, 0.0, 127 )
    call SetSoundConeOrientation( gg_snd_Dlss, 0.0, 0.0, 0.0 )
    set gg_snd_BattleShipDeath1 = CreateSound( "Doodads\\Northrend\\Water\\Battleship\\BattleShipDeath1.wav", false, true, true, 10, 10, "SpellsEAX" )
    call SetSoundParamsFromLabel( gg_snd_BattleShipDeath1, "BattleShipDeath" )
    call SetSoundDuration( gg_snd_BattleShipDeath1, 3065 )
    call SetSoundChannel( gg_snd_BattleShipDeath1, 0 )
    call SetSoundPitch( gg_snd_BattleShipDeath1, 0.8 )
    set gg_snd_LightningShieldTarget = CreateSound( "Abilities\\Spells\\Orc\\LightningShield\\LightningShieldTarget.wav", false, true, true, 10, 10, "SpellsEAX" )
    call SetSoundParamsFromLabel( gg_snd_LightningShieldTarget, "LightningShield" )
    call SetSoundDuration( gg_snd_LightningShieldTarget, 3878 )
    call SetSoundDistances( gg_snd_LightningShieldTarget, 2000.0, 10000.0 )
    set gg_snd_Suika04 = CreateSound( "Abilities\\Spells\\Orc\\FeralSpirit\\FeralSpiritTarget1.wav", false, true, true, 10, 10, "SpellsEAX" )
    call SetSoundParamsFromLabel( gg_snd_Suika04, "FeralSpiritDone" )
    call SetSoundDuration( gg_snd_Suika04, 2436 )
    set gg_snd_Weather = CreateSound( "Sound\\Interface\\SecretFound.wav", false, false, false, 10, 10, "DefaultEAXON" )
    call SetSoundParamsFromLabel( gg_snd_Weather, "SecretFound" )
    call SetSoundDuration( gg_snd_Weather, 2525 )
    call SetSoundVolume( gg_snd_Weather, 127 )
    set gg_snd_RollingThunder1 = CreateSound( "Sound\\Ambient\\DoodadEffects\\RollingThunder1.wav", false, false, false, 10, 10, "DefaultEAXON" )
    call SetSoundParamsFromLabel( gg_snd_RollingThunder1, "RollingThunderSound" )
    call SetSoundDuration( gg_snd_RollingThunder1, 3831 )
    set gg_snd_SargerasRoar = CreateSound( "Sound\\Ambient\\DoodadEffects\\SargerasRoar.wav", false, false, true, 10, 10, "DefaultEAXON" )
    call SetSoundParamsFromLabel( gg_snd_SargerasRoar, "SargerasRoar" )
    call SetSoundDuration( gg_snd_SargerasRoar, 4481 )
    set gg_snd_GetPower = CreateSound( "Abilities\\Spells\\Items\\WandOfNeutralization\\WandOfNeutralization.wav", false, true, true, 10, 10, "SpellsEAX" )
    call SetSoundParamsFromLabel( gg_snd_GetPower, "NeutralizationWandHit" )
    call SetSoundDuration( gg_snd_GetPower, 961 )
    set gg_snd_PaladinDivineShieldDeath1 = CreateSound( "Abilities\\Spells\\Human\\DivineShield\\PaladinDivineShieldDeath1.wav", false, true, true, 10, 10, "SpellsEAX" )
    call SetSoundParamsFromLabel( gg_snd_PaladinDivineShieldDeath1, "DivineShieldDeath" )
    call SetSoundDuration( gg_snd_PaladinDivineShieldDeath1, 1043 )
    set gg_snd_TinkerMorph1 = CreateSound( "Units\\Creeps\\HeroTinker\\TinkerMorph1.wav", false, false, true, 10, 10, "DefaultEAXON" )
    call SetSoundParamsFromLabel( gg_snd_TinkerMorph1, "HeroTinkerMorph" )
    call SetSoundDuration( gg_snd_TinkerMorph1, 1866 )
    call SetSoundChannel( gg_snd_TinkerMorph1, 10 )
    set gg_snd_SteamTankYes1 = CreateSound( "Units\\Human\\SteamTank\\SteamTankYes1.wav", false, false, true, 10, 10, "DefaultEAXON" )
    call SetSoundParamsFromLabel( gg_snd_SteamTankYes1, "SteamTankYes" )
    call SetSoundDuration( gg_snd_SteamTankYes1, 2868 )
    call SetSoundChannel( gg_snd_SteamTankYes1, 10 )
    set gg_snd_TrumpetChorusA_u = CreateSound( "war3mapImported\\TrumpetChorusA#.mp3", false, true, true, 1, 10, "SpellsEAX" )
    call SetSoundDuration( gg_snd_TrumpetChorusA_u, 313 )
    call SetSoundChannel( gg_snd_TrumpetChorusA_u, 0 )
    call SetSoundVolume( gg_snd_TrumpetChorusA_u, 127 )
    call SetSoundPitch( gg_snd_TrumpetChorusA_u, 1.0 )
    call SetSoundDistances( gg_snd_TrumpetChorusA_u, 600.0, 10000.0 )
    call SetSoundDistanceCutoff( gg_snd_TrumpetChorusA_u, 3000.0 )
    call SetSoundConeAngles( gg_snd_TrumpetChorusA_u, 0.0, 0.0, 127 )
    call SetSoundConeOrientation( gg_snd_TrumpetChorusA_u, 0.0, 0.0, 0.0 )
    set gg_snd_TrumpetChorusD = CreateSound( "war3mapImported\\TrumpetChorusD.mp3", false, true, true, 1, 10, "SpellsEAX" )
    call SetSoundDuration( gg_snd_TrumpetChorusD, 682 )
    call SetSoundChannel( gg_snd_TrumpetChorusD, 0 )
    call SetSoundVolume( gg_snd_TrumpetChorusD, 127 )
    call SetSoundPitch( gg_snd_TrumpetChorusD, 1.0 )
    call SetSoundDistances( gg_snd_TrumpetChorusD, 600.0, 10000.0 )
    call SetSoundDistanceCutoff( gg_snd_TrumpetChorusD, 3000.0 )
    call SetSoundConeAngles( gg_snd_TrumpetChorusD, 0.0, 0.0, 127 )
    call SetSoundConeOrientation( gg_snd_TrumpetChorusD, 0.0, 0.0, 0.0 )
    set gg_snd_TrumpetChorus_01 = CreateSound( "war3mapImported\\TrumpetChorus-01.mp3", false, true, true, 1, 10, "SpellsEAX" )
    call SetSoundDuration( gg_snd_TrumpetChorus_01, 787 )
    call SetSoundChannel( gg_snd_TrumpetChorus_01, 0 )
    call SetSoundVolume( gg_snd_TrumpetChorus_01, 127 )
    call SetSoundPitch( gg_snd_TrumpetChorus_01, 1.0 )
    call SetSoundDistances( gg_snd_TrumpetChorus_01, 600.0, 10000.0 )
    call SetSoundDistanceCutoff( gg_snd_TrumpetChorus_01, 3000.0 )
    call SetSoundConeAngles( gg_snd_TrumpetChorus_01, 0.0, 0.0, 127 )
    call SetSoundConeOrientation( gg_snd_TrumpetChorus_01, 0.0, 0.0, 0.0 )
    set gg_snd_TrumpetChorus_02 = CreateSound( "war3mapImported\\TrumpetChorus-02.mp3", false, true, true, 1, 10, "SpellsEAX" )
    call SetSoundDuration( gg_snd_TrumpetChorus_02, 787 )
    call SetSoundChannel( gg_snd_TrumpetChorus_02, 0 )
    call SetSoundVolume( gg_snd_TrumpetChorus_02, 127 )
    call SetSoundPitch( gg_snd_TrumpetChorus_02, 1.0 )
    call SetSoundDistances( gg_snd_TrumpetChorus_02, 600.0, 10000.0 )
    call SetSoundDistanceCutoff( gg_snd_TrumpetChorus_02, 3000.0 )
    call SetSoundConeAngles( gg_snd_TrumpetChorus_02, 0.0, 0.0, 127 )
    call SetSoundConeOrientation( gg_snd_TrumpetChorus_02, 0.0, 0.0, 0.0 )
    set gg_snd_TrumpetChorus_03 = CreateSound( "war3mapImported\\TrumpetChorus-03.mp3", false, true, true, 1, 10, "SpellsEAX" )
    call SetSoundDuration( gg_snd_TrumpetChorus_03, 8101 )
    call SetSoundChannel( gg_snd_TrumpetChorus_03, 0 )
    call SetSoundVolume( gg_snd_TrumpetChorus_03, 127 )
    call SetSoundPitch( gg_snd_TrumpetChorus_03, 1.0 )
    call SetSoundDistances( gg_snd_TrumpetChorus_03, 600.0, 10000.0 )
    call SetSoundDistanceCutoff( gg_snd_TrumpetChorus_03, 3000.0 )
    call SetSoundConeAngles( gg_snd_TrumpetChorus_03, 0.0, 0.0, 127 )
    call SetSoundConeOrientation( gg_snd_TrumpetChorus_03, 0.0, 0.0, 0.0 )
endfunction

//***************************************************************************
//*
//*  Destructable Objects
//*
//***************************************************************************

function CreateAllDestructables takes nothing returns nothing
    local destructable d
    local trigger t
    local real life
    set gg_dest_DTlv_1987 = CreateDestructable( 'DTlv', 2720.0, -14688.0, 225.000, 1.000, 0 )
    set gg_dest_LT06_0189 = CreateDestructableZ( 'LT06', 6400.0, -4640.0, 54.5, 90.000, 1.050, 0 )
    set gg_dest_LT07_0951 = CreateDestructableZ( 'LT07', 704.0, -12352.0, -147.2, 90.000, 1.000, 0 )
    set gg_dest_LTt5_0498 = CreateDestructableZ( 'LTt5', 3072.0, -14400.0, 48.4, 90.000, 1.300, 0 )
endfunction

//***************************************************************************
//*
//*  Items
//*
//***************************************************************************

function CreateAllItems takes nothing returns nothing
    local integer itemID

    set gg_item_I02O_0073 = CreateItem( 'I02O', 11229.5, -15718.1 )
endfunction

//***************************************************************************
//*
//*  Unit Creation
//*
//***************************************************************************

//===========================================================================
function CreateBuildingsForPlayer4 takes nothing returns nothing
    local player p = Player(4)
    local unit u
    local integer unitID
    local trigger t
    local real life

    set gg_unit_n023_0006 = CreateUnit( p, 'n023', 640.0, -16384.0, 270.000 )
    set gg_unit_h00D_0013 = CreateUnit( p, 'h00D', 2176.0, -16704.0, 45.000 )
    set gg_unit_h010_0043 = CreateUnit( p, 'h010', 2528.0, -16288.0, 270.000 )
    call SetUnitColor( gg_unit_h010_0043, ConvertPlayerColor(0) )
    set gg_unit_h00Y_0050 = CreateUnit( p, 'h00Y', -352.0, -11040.0, 270.000 )
    call SetUnitColor( gg_unit_h00Y_0050, ConvertPlayerColor(0) )
    set gg_unit_h013_0052 = CreateUnit( p, 'h013', 2400.0, -15904.0, 270.000 )
    set gg_unit_h013_0053 = CreateUnit( p, 'h013', 3040.0, -16352.0, 270.000 )
    set gg_unit_h013_0054 = CreateUnit( p, 'h013', 7712.0, -15776.0, 270.000 )
    set gg_unit_h018_0074 = CreateUnit( p, 'h018', 3808.0, -16608.0, 270.000 )
    call SetUnitColor( gg_unit_h018_0074, ConvertPlayerColor(0) )
    set gg_unit_h018_0075 = CreateUnit( p, 'h018', 1760.0, -15072.0, 270.000 )
    call SetUnitColor( gg_unit_h018_0075, ConvertPlayerColor(0) )
    set gg_unit_h018_0077 = CreateUnit( p, 'h018', 7520.0, -15328.0, 270.000 )
    call SetUnitColor( gg_unit_h018_0077, ConvertPlayerColor(0) )
    set u = CreateUnit( p, 'n00C', 704.0, -16384.0, 270.000 )
    set gg_unit_h00Y_0089 = CreateUnit( p, 'h00Y', 7520.0, -11296.0, 270.000 )
    call SetUnitColor( gg_unit_h00Y_0089, ConvertPlayerColor(0) )
    set gg_unit_h017_0107 = CreateUnit( p, 'h017', 8288.0, -14240.0, 270.000 )
    call SetUnitColor( gg_unit_h017_0107, ConvertPlayerColor(0) )
    set gg_unit_h018_0108 = CreateUnit( p, 'h018', 8096.0, -15584.0, 270.000 )
    call SetUnitColor( gg_unit_h018_0108, ConvertPlayerColor(0) )
    set gg_unit_h018_0109 = CreateUnit( p, 'h018', 3808.0, -15840.0, 270.000 )
    call SetUnitColor( gg_unit_h018_0109, ConvertPlayerColor(0) )
    set gg_unit_h018_0110 = CreateUnit( p, 'h018', 2272.0, -14816.0, 270.000 )
    call SetUnitColor( gg_unit_h018_0110, ConvertPlayerColor(0) )
endfunction

//===========================================================================
function CreateBuildingsForPlayer10 takes nothing returns nothing
    local player p = Player(10)
    local unit u
    local integer unitID
    local trigger t
    local real life

    set gg_unit_h00C_0008 = CreateUnit( p, 'h00C', 11744.0, -10720.0, 270.000 )
    set gg_unit_h00U_0019 = CreateUnit( p, 'h00U', 11712.0, -5184.0, 225.000 )
    set gg_unit_h016_0023 = CreateUnit( p, 'h016', 10976.0, -7328.0, 270.000 )
    set gg_unit_h019_0038 = CreateUnit( p, 'h019', 3168.0, -6496.0, 270.000 )
    set gg_unit_h00C_0042 = CreateUnit( p, 'h00C', 3936.0, -8992.0, 270.000 )
    set gg_unit_h016_0046 = CreateUnit( p, 'h016', 9824.0, -5920.0, 270.000 )
    set gg_unit_h016_0048 = CreateUnit( p, 'h016', 3680.0, -4960.0, 270.000 )
    set gg_unit_h016_0049 = CreateUnit( p, 'h016', 9824.0, -5344.0, 270.000 )
    set gg_unit_h00A_0056 = CreateUnit( p, 'h00A', 11104.0, -6240.0, 270.000 )
    set gg_unit_h00A_0057 = CreateUnit( p, 'h00A', 10720.0, -5600.0, 270.000 )
    set gg_unit_h00A_0058 = CreateUnit( p, 'h00A', 4192.0, -4768.0, 270.000 )
    set u = CreateUnit( p, 'n00C', 12928.0, -4736.0, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set gg_unit_h016_0078 = CreateUnit( p, 'h016', 4256.0, -5408.0, 270.000 )
    set gg_unit_n03O_0079 = CreateUnit( p, 'n03O', 12992.0, -4672.0, 270.000 )
    set gg_unit_h016_0090 = CreateUnit( p, 'h016', 11424.0, -7328.0, 270.000 )
    set gg_unit_h00Z_0091 = CreateUnit( p, 'h00Z', 11424.0, -5920.0, 270.000 )
    set gg_unit_h00Z_0092 = CreateUnit( p, 'h00Z', 11040.0, -5408.0, 270.000 )
endfunction

//===========================================================================
function CreateNeutralPassiveBuildings takes nothing returns nothing
    local player p = Player(PLAYER_NEUTRAL_PASSIVE)
    local unit u
    local integer unitID
    local trigger t
    local real life

    set u = CreateUnit( p, 'n01E', 7232.0, -8768.0, 270.000 )
    set u = CreateUnit( p, 'h01G', 12480.0, -12288.0, 270.000 )
    set u = CreateUnit( p, 'n03Q', 960.0, -16960.0, 270.000 )
    set u = CreateUnit( p, 'n03Q', 12992.0, -5312.0, 270.000 )
    set gg_unit_n000_0018 = CreateUnit( p, 'n000', 4192.0, -11424.0, 270.000 )
    call SetUnitColor( gg_unit_n000_0018, ConvertPlayerColor(0) )
    set u = CreateUnit( p, 'n017', 7680.0, -8896.0, 270.000 )
    set u = CreateUnit( p, 'n01D', -448.0, -8000.0, 270.000 )
    set u = CreateUnit( p, 'n016', 768.0, -16960.0, 270.000 )
    set u = CreateUnit( p, 'n012', 576.0, -15936.0, 270.000 )
    set u = CreateUnit( p, 'n015', 512.0, -16960.0, 270.000 )
    set u = CreateUnit( p, 'n01B', 448.0, -16000.0, 270.000 )
    set u = CreateUnit( p, 'n01C', 384.0, -16896.0, 270.000 )
    set u = CreateUnit( p, 'n011', 896.0, -15808.0, 270.000 )
    set u = CreateUnit( p, 'n014', 640.0, -15872.0, 270.000 )
    set u = CreateUnit( p, 'n013', 768.0, -15872.0, 270.000 )
    call SetUnitColor( u, ConvertPlayerColor(2) )
    set u = CreateUnit( p, 'n01F', 960.0, -16128.0, 270.000 )
    set u = CreateUnit( p, 'n01C', 13248.0, -4864.0, 270.000 )
    set u = CreateUnit( p, 'n012', 12288.0, -4736.0, 270.000 )
    set u = CreateUnit( p, 'n015', 13248.0, -5056.0, 270.000 )
    set u = CreateUnit( p, 'n01B', 12736.0, -4416.0, 270.000 )
    set u = CreateUnit( p, 'n016', 13120.0, -5184.0, 270.000 )
    set u = CreateUnit( p, 'n011', 12544.0, -4352.0, 270.000 )
    set u = CreateUnit( p, 'n014', 12416.0, -4480.0, 270.000 )
    set u = CreateUnit( p, 'n013', 12352.0, -4608.0, 270.000 )
    call SetUnitColor( u, ConvertPlayerColor(2) )
    set u = CreateUnit( p, 'n01F', 12800.0, -5376.0, 270.000 )
endfunction

//===========================================================================
function CreateNeutralPassive takes nothing returns nothing
    local player p = Player(PLAYER_NEUTRAL_PASSIVE)
    local unit u
    local integer unitID
    local trigger t
    local real life

    set gg_unit_h00V_0012 = CreateUnit( p, 'h00V', 6627.5, -7395.2, 140.000 )
    set u = CreateUnit( p, 'h00F', -4140.1, -6354.6, 270.000 )
    set u = CreateUnit( p, 'e005', -3830.3, -6495.7, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'n005', -3682.9, -6495.7, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'e00D', -3992.1, -6364.3, 270.000 )
    set u = CreateUnit( p, 'u001', -4393.2, -6503.6, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'u002', -3704.1, -6283.8, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'o00K', -3873.5, -6286.0, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'u000', -4590.7, -6501.6, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'n006', -4181.1, -6513.4, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'n007', -4016.3, -6495.7, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'o002', -4212.4, -6320.6, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'o003', -4402.6, -6307.6, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'h00H', -4134.0, -6221.8, 270.000 )
    set u = CreateUnit( p, 'e00B', -3986.3, -6230.1, 270.000 )
    set u = CreateUnit( p, 'e00C', -4127.5, -6067.6, 270.000 )
    set u = CreateUnit( p, 'e00E', -4127.5, -5921.5, 270.000 )
    set u = CreateUnit( p, 'h00E', -3994.3, -6100.2, 270.000 )
    set u = CreateUnit( p, 'h00G', -3981.1, -5945.6, 270.000 )
    set u = CreateUnit( p, 'e003', -3860.5, -5898.5, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'h007', -4600.9, -6074.0, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'h003', -4439.0, -6091.2, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'h006', -4219.9, -6067.1, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'h005', -4070.1, -6071.9, 270.000 )
    set u = CreateUnit( p, 'h004', -3866.0, -6110.2, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'h008', -3675.3, -6081.6, 270.000 )
    set u = CreateUnit( p, 'e001', -4592.1, -5859.6, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'e007', -4427.0, -5881.3, 270.000 )
    set u = CreateUnit( p, 'e004', -3683.0, -5888.5, 270.000 )
    set u = CreateUnit( p, 'e002', -4071.4, -5861.8, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'e006', -4240.3, -5861.8, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'o004', -4049.5, -6314.2, 270.000 )
    call SetUnitState( u, UNIT_STATE_MANA, 0 )
    set u = CreateUnit( p, 'o001', -4616.6, -6267.0, 270.000 )
endfunction

//===========================================================================
function CreatePlayerBuildings takes nothing returns nothing
    call CreateBuildingsForPlayer4(  )
    call CreateBuildingsForPlayer10(  )
endfunction

//===========================================================================
function CreatePlayerUnits takes nothing returns nothing
endfunction

//===========================================================================
function CreateAllUnits takes nothing returns nothing
    call CreateNeutralPassiveBuildings(  )
    call CreatePlayerBuildings(  )
    call CreateNeutralPassive(  )
    call CreatePlayerUnits(  )
endfunction

//***************************************************************************
//*
//*  Regions
//*
//***************************************************************************

function CreateRegions takes nothing returns nothing
    local weathereffect we

    set gg_rct_AI_Waypoint_00 = Rect( 4384.0, -16000.0, 4896.0, -15488.0 )
    set gg_rct_AI_Waypoint_01 = Rect( 7232.0, -15168.0, 7744.0, -14656.0 )
    set gg_rct_AI_Waypoint_02 = Rect( 8768.0, -13664.0, 9184.0, -13248.0 )
    set gg_rct_AI_Waypoint_03 = Rect( 3168.0, -7712.0, 3584.0, -7328.0 )
    set gg_rct_AI_Waypoint_04 = Rect( 3232.0, -6432.0, 3648.0, -6016.0 )
    set gg_rct_AI_Waypoint_05 = Rect( 4640.0, -5088.0, 5152.0, -4576.0 )
    set gg_rct_AI_Waypoint_B0 = Rect( -640.0, -10368.0, -128.0, -9856.0 )
    set gg_rct_AI_Waypoint_B1 = Rect( 576.0, -8384.0, 1088.0, -7872.0 )
    set gg_rct_AI_Waypoint_B2 = Rect( 10176.0, -13376.0, 10688.0, -12864.0 )
    set gg_rct_AI_Waypoint_B3 = Rect( 11328.0, -11456.0, 11840.0, -10944.0 )
    set gg_rct_BackStage = Rect( -5600.0, -6400.0, -5088.0, -5888.0 )
    set gg_rct_BaseA = Rect( 1504.0, -17376.0, 2976.0, -15840.0 )
    set gg_rct_BaseB = Rect( 10656.0, -6336.0, 12320.0, -4576.0 )
    set gg_rct_BirthA = Rect( 704.0, -16512.0, 960.0, -16256.0 )
    set gg_rct_BirthB = Rect( 12640.0, -4960.0, 12896.0, -4704.0 )
    set gg_rct_BoatL = Rect( 6368.0, -6624.0, 6656.0, -6368.0 )
    set gg_rct_BoatR = Rect( 6496.0, -7520.0, 6784.0, -7232.0 )
    set gg_rct_CommonArea = Rect( 5344.0, -10400.0, 5856.0, -9888.0 )
    set gg_rct_Creeps00a = Rect( 5216.0, -15072.0, 6048.0, -14112.0 )
    set gg_rct_Creeps01a = Rect( 7264.0, -7328.0, 8160.0, -6304.0 )
    set gg_rct_Creeps02b = Rect( 6176.0, -12576.0, 6752.0, -11968.0 )
    set gg_rct_Creeps03b = Rect( 4224.0, -7680.0, 4928.0, -6944.0 )
    set gg_rct_Creeps04b = Rect( 2432.0, -13440.0, 3104.0, -12736.0 )
    set gg_rct_Creeps05b = Rect( 8160.0, -10048.0, 8800.0, -9408.0 )
    set gg_rct_Creeps06b = Rect( 2656.0, -11136.0, 3264.0, -10496.0 )
    set gg_rct_Creeps07b = Rect( 9408.0, -9248.0, 10080.0, -8480.0 )
    set gg_rct_EyePoint01 = Rect( 9952.0, -12704.0, 10144.0, -12512.0 )
    set gg_rct_EyePoint02 = Rect( 9568.0, -10144.0, 9760.0, -9952.0 )
    set gg_rct_EyePoint03 = Rect( 9312.0, -6464.0, 9760.0, -6208.0 )
    set gg_rct_EyePoint04 = Rect( 5216.0, -8256.0, 5440.0, -8032.0 )
    set gg_rct_EyePoint05 = Rect( 3936.0, -7104.0, 4096.0, -6880.0 )
    set gg_rct_EyePoint06 = Rect( 832.0, -10432.0, 1056.0, -10208.0 )
    set gg_rct_EyePoint07 = Rect( 1760.0, -8096.0, 1920.0, -7936.0 )
    set gg_rct_EyePoint08 = Rect( 1664.0, -8192.0, 1824.0, -8032.0 )
    set gg_rct_EyePoint09 = Rect( 8480.0, -9088.0, 8704.0, -8832.0 )
    set gg_rct_EyePoint10 = Rect( 3488.0, -11648.0, 3712.0, -11392.0 )
    set gg_rct_EyePoint11 = Rect( 7360.0, -6112.0, 7584.0, -5856.0 )
    set gg_rct_EyePoint12 = Rect( 4320.0, -13984.0, 4512.0, -13792.0 )
    set gg_rct_FallingLeaves = Rect( 6912.0, -10208.0, 14144.0, -2080.0 )
    set gg_rct_HarborL = Rect( 6176.0, -6560.0, 6464.0, -6272.0 )
    set gg_rct_HarborR = Rect( 6688.0, -7712.0, 6944.0, -7424.0 )
    set gg_rct_Jump1bot = Rect( 9248.0, -8384.0, 9376.0, -8256.0 )
    set gg_rct_Jump1top = Rect( 9888.0, -7616.0, 10016.0, -7488.0 )
    set gg_rct_Jump2bot = Rect( 10720.0, -12672.0, 10848.0, -12544.0 )
    set gg_rct_Jump2top = Rect( 10368.0, -12288.0, 10496.0, -12160.0 )
    set gg_rct_Jump3bot = Rect( 9344.0, -13216.0, 9472.0, -13088.0 )
    set gg_rct_Jump3top = Rect( 9440.0, -12512.0, 9568.0, -12384.0 )
    set gg_rct_Jump4bot = Rect( 832.0, -9600.0, 960.0, -9472.0 )
    set gg_rct_Jump4top = Rect( 1216.0, -8992.0, 1344.0, -8864.0 )
    set gg_rct_Jump5bot = Rect( 480.0, -8832.0, 608.0, -8704.0 )
    set gg_rct_Jump5top = Rect( -128.0, -8256.0, 0.0, -8128.0 )
    set gg_rct_Jump6bot = Rect( 2112.0, -7584.0, 2240.0, -7456.0 )
    set gg_rct_Jump6top = Rect( 2144.0, -8192.0, 2272.0, -8064.0 )
    set gg_rct_PlayerCSS_A1 = Rect( -8864.0, -18080.0, -6016.0, -15936.0 )
    set gg_rct_PlayerCSS_A2 = Rect( -8864.0, -15936.0, -6016.0, -13760.0 )
    set gg_rct_PlayerCSS_A3 = Rect( -8864.0, -13760.0, -6016.0, -11584.0 )
    set gg_rct_PlayerCSS_A4 = Rect( -8864.0, -11584.0, -6016.0, -9408.0 )
    set gg_rct_PlayerCSS_A5 = Rect( -8864.0, -9408.0, -6016.0, -7232.0 )
    set gg_rct_PlayerCSS_B1 = Rect( -5792.0, -18080.0, -2944.0, -15936.0 )
    set gg_rct_PlayerCSS_B2 = Rect( -5792.0, -15936.0, -2944.0, -13760.0 )
    set gg_rct_PlayerCSS_B3 = Rect( -5792.0, -13760.0, -2944.0, -11584.0 )
    set gg_rct_PlayerCSS_B4 = Rect( -5792.0, -11584.0, -2944.0, -9408.0 )
    set gg_rct_PlayerCSS_B5 = Rect( -5792.0, -9408.0, -2944.0, -7232.0 )
    set gg_rct_PlayerCSS_C0 = Rect( -8864.0, -7232.0, -6016.0, -5056.0 )
    set gg_rct_PreloadUnits = Rect( -5792.0, -7232.0, -2944.0, -5056.0 )
    set gg_rct_RecoverAreaA = Rect( 704.0, -16512.0, 960.0, -16256.0 )
    set gg_rct_RecoverAreaB = Rect( 12640.0, -4960.0, 12896.0, -4704.0 )
    set gg_rct_RedFog = Rect( 11360.0, -11744.0, 13056.0, -9984.0 )
    set we = AddWeatherEffect( gg_rct_RedFog, 'FDrh' )
    call EnableWeatherEffect( we, true )
    set gg_rct_ReviveA = Rect( 704.0, -16512.0, 960.0, -16256.0 )
    set gg_rct_ReviveB = Rect( 12640.0, -4960.0, 12896.0, -4704.0 )
    set gg_rct_Rune1 = Rect( 6080.0, -8992.0, 6528.0, -8480.0 )
    set gg_rct_Rune2 = Rect( 4512.0, -11776.0, 4960.0, -11328.0 )
    set gg_rct_SpawnA0 = Rect( 7648.0, -15584.0, 7968.0, -15264.0 )
    set gg_rct_SpawnA1 = Rect( 3136.0, -16352.0, 3456.0, -16032.0 )
    set gg_rct_SpawnA2 = Rect( 2400.0, -15872.0, 2688.0, -15552.0 )
    set gg_rct_SpawnB0 = Rect( 3840.0, -5184.0, 4096.0, -4928.0 )
    set gg_rct_SpawnB1 = Rect( 10880.0, -6624.0, 11136.0, -6368.0 )
    set gg_rct_SpawnB2 = Rect( 10368.0, -5856.0, 10624.0, -5568.0 )
    set gg_rct_SunShine = Rect( -1984.0, -17664.0, 5152.0, -12608.0 )
    set gg_rct_TargetA = Rect( 11520.0, -5376.0, 11904.0, -4960.0 )
    set gg_rct_TargetB = Rect( 2048.0, -16768.0, 2368.0, -16480.0 )
    set gg_rct_WayPoint_0_0 = Rect( 7808.0, -15104.0, 8064.0, -14848.0 )
    set gg_rct_WayPoint_0_1 = Rect( 7808.0, -12384.0, 8064.0, -12064.0 )
    set gg_rct_WayPoint_0_2 = Rect( 6880.0, -11040.0, 7168.0, -10752.0 )
    set gg_rct_WayPoint_0_3 = Rect( 4032.0, -9664.0, 4320.0, -9376.0 )
    set gg_rct_WayPoint_0_4 = Rect( 3360.0, -7840.0, 3648.0, -7584.0 )
    set gg_rct_WayPoint_0_5 = Rect( 3456.0, -5760.0, 3744.0, -5472.0 )
    set gg_rct_WayPoint_1_0 = Rect( 7072.0, -16160.0, 7328.0, -15872.0 )
    set gg_rct_WayPoint_1_1 = Rect( 9120.0, -13312.0, 9472.0, -12960.0 )
    set gg_rct_WayPoint_1_2 = Rect( 10368.0, -13504.0, 10688.0, -13184.0 )
    set gg_rct_WayPoint_1_3 = Rect( 11552.0, -11456.0, 11872.0, -11104.0 )
    set gg_rct_WayPoint_1_4 = Rect( 11392.0, -9888.0, 11680.0, -9600.0 )
    set gg_rct_WayPoint_1_5 = Rect( 11392.0, -8032.0, 11648.0, -7776.0 )
    set gg_rct_WayPoint_2_0 = Rect( 1504.0, -14112.0, 1824.0, -13792.0 )
    set gg_rct_WayPoint_2_1 = Rect( 224.0, -11808.0, 544.0, -11456.0 )
    set gg_rct_WayPoint_2_2 = Rect( -736.0, -10080.0, -448.0, -9792.0 )
    set gg_rct_WayPoint_2_3 = Rect( 736.0, -7648.0, 1056.0, -7264.0 )
    set gg_rct_WayPoint_2_4 = Rect( 1728.0, -7776.0, 2048.0, -7456.0 )
    set gg_rct_WayPoint_2_5 = Rect( 4672.0, -4800.0, 4960.0, -4544.0 )
    set gg_rct_EyePoint01resort = Rect( 9792.0, -12480.0, 9984.0, -12288.0 )
    set gg_rct_EyePoint02resort = Rect( 9632.0, -10592.0, 9824.0, -10400.0 )
    set gg_rct_EyePoint03resort = Rect( 9568.0, -6208.0, 10016.0, -5952.0 )
    set gg_rct_EyePoint04resort = Rect( 5184.0, -8640.0, 5408.0, -8416.0 )
    set gg_rct_EyePoint05resort = Rect( 3680.0, -7232.0, 3840.0, -7008.0 )
    set gg_rct_EyePoint06resort = Rect( 1024.0, -10752.0, 1248.0, -10528.0 )
    set gg_rct_EyePoint07resort = Rect( 1888.0, -8320.0, 2048.0, -8160.0 )
    set gg_rct_EyePoint08resort = Rect( 1760.0, -8416.0, 1920.0, -8256.0 )
    set gg_rct_EyePoint09resort = Rect( 8800.0, -9280.0, 9024.0, -9024.0 )
    set gg_rct_EyePoint10resort = Rect( 3104.0, -11552.0, 3328.0, -11296.0 )
    set gg_rct_EyePoint11resort = Rect( 7712.0, -6592.0, 7936.0, -6336.0 )
    set gg_rct_EyePoint12resort = Rect( 4608.0, -13664.0, 4800.0, -13472.0 )
    set gg_rct_RunesTeleport01 = Rect( 12064.0, -12608.0, 12320.0, -12352.0 )
    set gg_rct_RunesTeleport02 = Rect( -288.0, -8000.0, -32.0, -7744.0 )
    set gg_rct_RunesTeleport03 = Rect( 5472.0, -10272.0, 5728.0, -10016.0 )
    set gg_rct_RunesTeleport04 = Rect( 3488.0, -13536.0, 3744.0, -13280.0 )
    set gg_rct_RunesTeleport05 = Rect( 9088.0, -8256.0, 9344.0, -8000.0 )
    set gg_rct_RunesTeleport06 = Rect( 7072.0, -13152.0, 7328.0, -12896.0 )
    set gg_rct_RunesTeleport07 = Rect( 5760.0, -6688.0, 6016.0, -6432.0 )
endfunction

//***************************************************************************
//*
//*  Custom Script Code
//*
//***************************************************************************
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function IsUnitDead takes unit u returns boolean
    return (GetUnitState(u,UNIT_STATE_LIFE)<=0) or IsUnitType(u,UNIT_TYPE_DEAD)
endfunction

function IsUnitAlive takes unit whichUnit returns boolean
    return not IsUnitDead(whichUnit)
endfunction

//===========================================================================
//句柄转换 Handle System
//===========================================================================
//
function FlushStoredIntegerSimple takes string missionkey, string key returns nothing
    call RemoveSavedHandle(udg_Hashtable, StringHash(missionkey), StringHash(key))
endfunction

function StoreHandle takes string missionkey, string key, agent h returns nothing
    call SaveAgentHandle(udg_Hashtable, StringHash(missionkey), StringHash(key), h)
endfunction

function GetStoredUnit takes string missionkey, string key returns unit
    return LoadUnitHandle(udg_Hashtable, StringHash(missionkey), StringHash(key))
endfunction

function FlushStoredMissionSimple takes string missionkey returns nothing
    call FlushChildHashtable(udg_Hashtable, StringHash (missionkey))
endfunction

function GetStoredRealSimple takes string missionkey, string key returns real
    return LoadReal(udg_Hashtable, StringHash(missionkey), StringHash(key))
endfunction

function StoreRealSimple takes string missionkey, string key, real r returns nothing
    call SaveReal(udg_Hashtable, StringHash(missionkey), StringHash(key), r)
endfunction

function GetStoredIntegerSimple takes string missionkey, string key returns integer
    return LoadInteger(udg_Hashtable, StringHash(missionkey), StringHash(key))
endfunction

function GetStoredBooleanSimple takes string missionkey, string key returns boolean
    return LoadBoolean(udg_Hashtable, StringHash(missionkey), StringHash(key))
endfunction

function StoreIntegerSimple takes string missionkey, string key, integer i returns nothing
    call SaveInteger(udg_Hashtable, StringHash(missionkey), StringHash(key), i)
endfunction

function StoreBooleanSimple takes string missionkey, string key, boolean b returns nothing
    call SaveBoolean(udg_Hashtable, StringHash(missionkey), StringHash(key), b)
endfunction
//================================================================================
function H2I takes agent h returns integer
    call SaveAgentHandle(udg_Hashtable,GetHandleId(h),0,h)
    return GetHandleId(h)
endfunction

function H2S takes handle h returns string
    return I2S(GetHandleId(h))
endfunction

function I2U takes integer i returns unit
    return LoadUnitHandle(udg_Hashtable,i,0)
endfunction

function I2L takes integer i returns location
    return LoadLocationHandle(udg_Hashtable,i,0)
endfunction

function I2G takes integer i returns group
    return LoadGroupHandle(udg_Hashtable,i,0)
endfunction

function I2T takes integer i returns timer
    return LoadTimerHandle(udg_Hashtable,i,0)
endfunction

function I2E takes integer i returns effect
    return LoadEffectHandle(udg_Hashtable,i,0)           
endfunction

function I2B takes integer i returns boolexpr
    return LoadBooleanExprHandle(udg_Hashtable,i,0)   
endfunction

function I2BE takes integer i returns boolexpr
    return LoadBooleanExprHandle(udg_Hashtable,i,0)   
endfunction

function I2LT takes integer i returns lightning
    return LoadLightningHandle(udg_Hashtable,i,0)   
endfunction

function I2TD takes integer i returns timerdialog
    return LoadTimerDialogHandle(udg_Hashtable,i,0)   
endfunction

function I2TR takes integer i returns trigger
    return LoadTriggerHandle(udg_Hashtable,i,0)   
endfunction

function I2TA takes integer i returns triggeraction
    return LoadTriggerActionHandle(udg_Hashtable,i,0)   
endfunction

function I2W takes integer i returns rect
    return LoadRectHandle(udg_Hashtable,i,0)   
endfunction

function I2RT takes integer i returns rect
    return LoadRectHandle(udg_Hashtable,i,0)   
endfunction

function I2D takes integer i returns destructable
    return LoadDestructableHandle(udg_Hashtable,i,0)   
endfunction

function I2WE takes integer i returns nothing
    return
endfunction

function I2SND takes integer i returns sound    
    return LoadSoundHandle(udg_Hashtable,i,0)  
endfunction

function I2MB takes integer i returns multiboard
    return LoadMultiboardHandle(udg_Hashtable,i,0)   
endfunction

function I2MBI takes integer i returns multiboarditem
    return LoadMultiboardItemHandle(udg_Hashtable,i,0)   
endfunction

function I2FM takes integer i returns fogmodifier
    return LoadFogModifierHandle(udg_Hashtable,i,0) 
endfunction

function I2P takes integer i returns player
    return LoadPlayerHandle(udg_Hashtable,i,0) 
endfunction

function I2IT takes integer i returns item
    return LoadItemHandle(udg_Hashtable,i,0) 
endfunction
//
//===========================================================================

function Coin takes integer a,integer b returns integer
    if GetRandomInt(0,1)==0 then
        return a
    endif
    return b
endfunction

function Integer takes boolean b returns integer
    if b then
        return 1
    else
        return 0
    endif
endfunction

function Boolean takes integer b returns boolean
    return b!=0
endfunction

function Bit takes integer b returns integer
    return R2I(Pow(2,b))
endfunction

function GetBitBoolean takes integer a,integer b returns boolean
    set a = a/Bit(b)
    if a==a/2*2 then
        return false
    else
        return true
    endif
endfunction

function EnableHeight takes unit u returns nothing
    call UnitAddAbility(u,'Arav')
    call UnitRemoveAbility(u,'Arav')
endfunction

function DistanceBetweenUnits takes unit A,unit B returns real
    local real dx = GetUnitX(B) - GetUnitX(A)
    local real dy = GetUnitY(B) - GetUnitY(A)
    return SquareRoot(dx*dx + dy*dy)
endfunction

function AngleBetweenUnits takes unit A,unit B returns real
    return bj_RADTODEG*Atan2(GetUnitY(B) - GetUnitY(A), GetUnitX(B) - GetUnitX(A))
endfunction

function GetRandomLocInRange takes location o,real r returns location
    local real px
    local real py
    if r < 4.0 then
        set r = 4.0
    endif
    loop
        set px = GetRandomReal(-r,r)
        set py = GetRandomReal(-r,r)
        exitwhen Pow(px,2) + Pow(py,2) <= Pow(r,2)
    endloop
    return Location(GetLocationX(o)+px,GetLocationY(o)+py)
endfunction

//这个貌似没用到
//function TriggerRegisterEnterRect takes trigger trig, rect r, boolexpr filter returns event
//    local region rectRegion = CreateRegion()
//    call RegionAddRect(rectRegion, r)
//    return TriggerRegisterEnterRegion(trig, rectRegion, filter)
//endfunction

//初级敌我识别器 First Level IFF
//===========================================================================
//调用GetPlayerFilter(player) 用于识别敌我
//===========================================================================
function GetPlayerFilter takes player q returns boolexpr
    return udg_FLIFF[GetPlayerId(q)]
endfunction

function FLIFF01 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(0)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF02 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(1)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF03 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(2)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF04 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(3)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF05 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(4)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF06 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(5)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF07 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(6)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF08 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(7)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF09 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(8)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF10 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(9)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF11 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(10)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF12 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(11)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF13 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(12)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF14 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(13)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function FLIFF15 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),Player(14)) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function CostItem takes item w,integer n returns nothing
    local integer m = GetItemCharges(w)
    if n<=0 then
        return
    endif
    if m<=n then
        call RemoveItem(w)
    else
        call SetItemCharges(w,m-n)
    endif
endfunction

function GPSU takes nothing returns integer
    return 'o000'
endfunction

function YawError takes real current, real reference returns real
    local real e = reference - current
    if e<-180.0 then
        return e + 360.0
    endif
    if e>=180.0 then
        return e - 360.0
    endif
    return e
endfunction

function GetPositionZ takes real x,real y returns real
    local location p = Location(x,y)
    local real z = GetLocationZ(p)
    call RemoveLocation(p)
    set p = null
    return z
endfunction

function SetUnitXY takes unit u, real x,real y returns nothing
    if GetRectMinX(bj_mapInitialPlayableArea)<=x and x<=GetRectMaxX(bj_mapInitialPlayableArea) then
        call SetUnitX(u,x)
    endif
    if GetRectMinY(bj_mapInitialPlayableArea)<=y and y<=GetRectMaxY(bj_mapInitialPlayableArea) then
        call SetUnitY(u,y)
    endif
endfunction

function SetUnitXYFly takes unit u,real x,real y returns boolean
    if IsTerrainPathable(x,y,PATHING_TYPE_FLYABILITY) then
        return false
    endif
    call SetUnitX(u,x)
    call SetUnitY(u,y)
    return true
endfunction

function SetUnitXYGround takes unit u,real x,real y returns boolean
    if IsTerrainPathable(x,y,PATHING_TYPE_WALKABILITY) then
        return false
    endif
    call SetUnitX(u,x)
    call SetUnitY(u,y)
    return true
endfunction

function SetUnitXYRepel takes unit u,real x,real y returns boolean
    if IsTerrainPathable(x,y,PATHING_TYPE_WALKABILITY) then
        return false
    endif
    call SetUnitPosition(u,x,y)
    return true
endfunction

//时间平移操作
//===========================================================================

function TSU_RemoveUnit_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    call RemoveUnit(LoadUnitHandle(udg_ht,task,0))
    call FlushChildHashtable(udg_ht,task)
    call DestroyTimer(t)
    set t = null
endfunction
function TSU_RemoveUnit takes real delay,unit u returns timer
    local timer t
    if u==null then
        set t = null
        return null
    endif
    set t = CreateTimer()
    call SaveUnitHandle(udg_ht,GetHandleId(t),0,u)
    call TimerStart(t,delay,false,function TSU_RemoveUnit_Main)
    set bj_lastStartedTimer = t
    set t = null
    return bj_lastStartedTimer
endfunction

function TSU_DestroyEffect_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    call DestroyEffect(LoadEffectHandle(udg_ht,task,0))
    call FlushChildHashtable(udg_ht,task)
    call DestroyTimer(t)
    set t = null
endfunction
function TSU_DestroyEffect takes real delay,effect e returns timer
    local timer t
    if e==null then
        set t = null
        return null
    endif
    set t = CreateTimer()
    call SaveEffectHandle(udg_ht,GetHandleId(t),0,e)
    call TimerStart(t,delay,false,function TSU_DestroyEffect_Main)
    set bj_lastStartedTimer = t
    set t = null
    return bj_lastStartedTimer
endfunction

function TSU_DestroyLightning_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local lightning e = LoadLightningHandle(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    if i==10 then
        call SaveInteger(udg_ht,task,1,9)
        call TimerStart(t,0.04,true,function TSU_DestroyLightning_Main)
    elseif i>0 then
        call SetLightningColor(e,1.0,1.0,1.0,i/10.0)
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call DestroyLightning(e)
        call FlushChildHashtable(udg_ht,task)
        call DestroyTimer(t)
    endif
    set t = null
    set e = null
endfunction
function TSU_DestroyLightning takes real delay,lightning e returns timer
    local timer t
    if e==null then
        set t = null
        return null
    endif
    set t = CreateTimer()
    call SaveLightningHandle(udg_ht,GetHandleId(t),0,e)
    call SaveInteger(udg_ht,GetHandleId(t),1,10)
    call TimerStart(t,delay,false,function TSU_DestroyLightning_Main)
    set bj_lastStartedTimer = t
    set t = null
    return bj_lastStartedTimer
endfunction

function TSU_RemoveDestructable_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    call RemoveDestructable(LoadDestructableHandle(udg_ht,GetHandleId(t),0))
    call FlushChildHashtable(udg_ht,task)
    call DestroyTimer(t)
    set t = null
endfunction
function TSU_RemoveDestructable takes real delay,destructable d returns timer
    local timer t
    if d==null then
        set t = null
        return null
    endif
    set t = CreateTimer()
    call SaveDestructableHandle(udg_ht,GetHandleId(t),0,d)
    call TimerStart(t,delay,false,function TSU_RemoveDestructable_Main)
    set bj_lastStartedTimer = t
    set t = null
    return bj_lastStartedTimer
endfunction

function TSU_AddSpecialEffect_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit target = LoadUnitHandle(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i>0 and GetUnitState(target,UNIT_STATE_LIFE)>0 then
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call DestroyEffect(LoadEffectHandle(udg_ht,task,1))
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set target = null
endfunction
function TSU_AddSpecialEffectTarget takes string modelName, unit target, string attachPointName, real time returns timer
    local timer t
    local effect e
    if target==null then
        set t = null
        set e = null
        return null
    endif
    set t = CreateTimer()
    set e = AddSpecialEffectTarget(modelName,target,attachPointName)
    call SaveUnitHandle(udg_ht,GetHandleId(t),0,target)
    call SaveEffectHandle(udg_ht,GetHandleId(t),1,e)
    call SaveInteger(udg_ht,GetHandleId(t),1,R2I(time/0.1))
    call TimerStart(t,0.1,true,function TSU_AddSpecialEffect_Main)
    set bj_lastStartedTimer = t
    set t = null
    set e = null
    return bj_lastStartedTimer
endfunction

function TSU_SetUnitInvulnerable_End takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_ht,task,0)
    call SetUnitInvulnerable(u,false)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set u = null
endfunction
function TSU_SetUnitInvulnerable takes unit u,real period returns timer
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    call SetUnitInvulnerable(u,true)
    call SaveUnitHandle(udg_ht,task,0,u)
    call TimerStart(t,period,false,function TSU_SetUnitInvulnerable_End)
    set bj_lastStartedTimer = t
    set t = null
    return bj_lastStartedTimer
endfunction

function TSU_SetUnitTimeScale_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_ht,task,0)
    call SetUnitTimeScale(u,LoadReal(udg_ht,task,0))
    call FlushChildHashtable(udg_ht,task)
    call DestroyTimer(t)
    set t = null
    set u = null
endfunction
function TSU_SetUnitTimeScale takes real delay,unit u,real rate returns timer
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    call SaveUnitHandle(udg_ht,task,0,u)
    call SaveReal(udg_ht,task,0,rate)
    call TimerStart(t,delay,false,function TSU_SetUnitTimeScale_Main)
    set bj_lastStartedTimer = t
    set t = null
    return bj_lastStartedTimer
endfunction

function TSU_SetUnitMoveSpeed_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_ht,task,0)
    local real s = LoadReal(udg_ht,task,0)
    call SetUnitMoveSpeed(u,s)
    call FlushChildHashtable(udg_ht,task)
    call DestroyTimer(t)
    set t = null
    set u = null
endfunction
function TSU_SetUnitMoveSpeed takes real delay,unit u,real speed returns timer
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    call SaveUnitHandle(udg_ht,task,0,u)
    call SaveReal(udg_ht,task,0,speed)
    call TimerStart(t,delay,false,function TSU_SetUnitMoveSpeed_Main)
    set bj_lastStartedTimer = t
    set t = null
    return bj_lastStartedTimer
endfunction

function TSU_UnitRemoveAbility_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_ht,task,0)
    local integer aID = LoadInteger(udg_ht,task,0)
    call UnitRemoveAbility(u,aID)
    call FlushChildHashtable(udg_ht,task)
    call DestroyTimer(t)
    set t = null
    set u = null
endfunction
function TSU_UnitRemoveAbility takes real delay,unit u,integer aID returns timer
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    call SaveUnitHandle(udg_ht,task,0,u)
    call SaveInteger(udg_ht,task,0,aID)
    call TimerStart(t,delay,false,function TSU_UnitRemoveAbility_Main)
    set bj_lastStartedTimer = t
    set t = null
    return bj_lastStartedTimer
endfunction

function TSU_UnitAddItem_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_ht,task,0)
    local item w = LoadItemHandle(udg_ht,task,1)
    local integer i = LoadInteger(udg_ht,task,1)
    if IsUnitAlive(u) or i<=0 then
        call SetItemVisible(w,true)
        call SetItemPosition(w,GetUnitX(u),GetUnitY(u))
        call UnitAddItem(u,w)
        call FlushChildHashtable(udg_ht,task)
        call DestroyTimer(t)
    else
        call SaveInteger(udg_ht,task,1,i - 1)
    endif
    set t = null
    set u = null
    set w = null
endfunction
function TSU_UnitAddItem takes unit u,item w returns timer
    local timer t
    if u==null or w==null then
        set t = null
        return null
    endif
    if IsUnitAlive(u) then
        call UnitAddItem(u,w)
        set t = null
        return null
    endif
    set t = CreateTimer()
    call SetItemVisible(w,false)
    call SaveUnitHandle(udg_ht,GetHandleId(t),0,u)
    call SaveItemHandle(udg_ht,GetHandleId(t),1,w)
    call SaveInteger(udg_ht,GetHandleId(t),1,800)
    call TimerStart(t,0.25,true,function TSU_UnitAddItem_Main)
    set bj_lastStartedTimer = t
    set t = null
    return bj_lastStartedTimer
endfunction

function UnitDamageArea takes unit h,real x,real y,real r,boolexpr f,real amount, boolean attack, boolean ranged, attacktype attackType, damagetype damageType, weapontype weaponType returns integer
    local integer n = 0
    local unit v
    local group g = CreateGroup()
    call GroupEnumUnitsInRange(g,x,y,r+128.0,f)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitInRangeXY(v,x,y,r) then
            call UnitDamageTarget(h,v,amount,attack,ranged,attackType,damageType,weaponType)
        endif
        set n = n + 1
    endloop
    call DestroyGroup(g)
    set v = null
    set g = null
    return n
endfunction

//***************************************************************************
//*
//*  Triggers
//*
//***************************************************************************

//===========================================================================
// Trigger: OpenSmileys
//
// 输入-s+数字发布表情(如:-s1)
// 1.笑  2.汗  3.难  4.弱  5.点
// 6.哭  7.乱  8.怒  9.⑨ 10.BUG
//===========================================================================
function Trig_OpenSmileys_Conditions takes nothing returns boolean
    if ( not ( udg_Smileys[ (GetPlayerId(GetTriggerPlayer()))] == false ) ) then
        return false
    endif
    return true
endfunction

function Trig_OpenSmileys_Actions takes nothing returns nothing
    local integer i = GetPlayerId(GetTriggerPlayer())
    local integer j = S2I(SubString(GetEventPlayerChatString(),2,4))
    local effect e
    set udg_SmileysLast[ (GetPlayerId(GetTriggerPlayer()))] =  (j)
    //====
    if j==1 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_smile.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 2 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_sweat.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 3 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_sohard.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 4 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_poor.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 5 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_dot.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 6 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_cry.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 7 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_crazy.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 8 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_anger.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 9 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_9.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 10 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_bug.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    else
    set udg_Smileys[ (i)] = true
    call DisplayTimedTextToPlayer( GetTriggerPlayer(), 0, 0, 6.00, "TRIGSTR_9616" )
    call TriggerSleepAction( 4.00 )
    set udg_Smileys[ (i)] = false
    endif
    //====
    set e = null
endfunction

//===========================================================================
function InitTrig_OpenSmileys takes nothing returns nothing
    set gg_trg_OpenSmileys = CreateTrigger(  )
    call TriggerRegisterPlayerChatEvent( gg_trg_OpenSmileys, Player(0), "-s", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_OpenSmileys, Player(1), "-s", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_OpenSmileys, Player(2), "-s", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_OpenSmileys, Player(3), "-s", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_OpenSmileys, Player(6), "-s", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_OpenSmileys, Player(7), "-s", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_OpenSmileys, Player(8), "-s", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_OpenSmileys, Player(9), "-s", false )
    call TriggerAddCondition( gg_trg_OpenSmileys, Condition( function Trig_OpenSmileys_Conditions ) )
    call TriggerAddAction( gg_trg_OpenSmileys, function Trig_OpenSmileys_Actions )
endfunction

//===========================================================================
// Trigger: QuickSmileys
//
// 快速发布最后发布的表情
//===========================================================================
function Trig_QuickSmileys_Conditions takes nothing returns boolean
    if ( not ( udg_Smileys[ (GetPlayerId(GetTriggerPlayer()))] == false ) ) then
        return false
    endif
    return true
endfunction

function Trig_QuickSmileys_Actions takes nothing returns nothing
    local integer i = GetPlayerId(GetTriggerPlayer())
    local integer j = udg_SmileysLast[GetPlayerId(GetTriggerPlayer())]
    local effect e
    //====
    if j==1 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_smile.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 2 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_sweat.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 3 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_sohard.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 4 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_poor.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 5 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_dot.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 6 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_cry.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 7 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_crazy.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 8 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_anger.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 9 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_9.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    elseif j == 10 then
    set udg_Smileys[ (i)] = true
    set e = AddSpecialEffectTarget("smileys_bug.mdx",udg_PlayerHeroes[i],"overhead")
    call TriggerSleepAction( 4.00 )
    call DestroyEffect(e)
    set udg_Smileys[ (i)] = false
    //====
    else
    set udg_Smileys[ (i)] = true
    call DisplayTimedTextToPlayer( GetTriggerPlayer(), 0, 0.00, 6.00, "TRIGSTR_9615" )
    call TriggerSleepAction( 4.00 )
    set udg_Smileys[ (i)] = false
    endif
    //====
    set e = null
endfunction

//===========================================================================
function InitTrig_QuickSmileys takes nothing returns nothing
    set gg_trg_QuickSmileys = CreateTrigger(  )
    call TriggerRegisterPlayerEventEndCinematic( gg_trg_QuickSmileys, Player(0) )
    call TriggerRegisterPlayerEventEndCinematic( gg_trg_QuickSmileys, Player(1) )
    call TriggerRegisterPlayerEventEndCinematic( gg_trg_QuickSmileys, Player(2) )
    call TriggerRegisterPlayerEventEndCinematic( gg_trg_QuickSmileys, Player(3) )
    call TriggerRegisterPlayerEventEndCinematic( gg_trg_QuickSmileys, Player(6) )
    call TriggerRegisterPlayerEventEndCinematic( gg_trg_QuickSmileys, Player(7) )
    call TriggerRegisterPlayerEventEndCinematic( gg_trg_QuickSmileys, Player(8) )
    call TriggerRegisterPlayerEventEndCinematic( gg_trg_QuickSmileys, Player(9) )
    call TriggerAddCondition( gg_trg_QuickSmileys, Condition( function Trig_QuickSmileys_Conditions ) )
    call TriggerAddAction( gg_trg_QuickSmileys, function Trig_QuickSmileys_Actions )
endfunction

//===========================================================================
// Trigger: Systems
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0

//数据库
function DB_SetHeroTypeData takes integer ID,integer field,integer value returns nothing
    call SaveInteger(udg_HeroDatabase,ID,field,value)
endfunction
function DB_GetHeroTypeData takes integer ID,integer field returns integer
    return LoadInteger(udg_HeroDatabase,ID,field)
endfunction

function DB_HERO_MULTIPLE_ATTACK takes nothing returns integer
    return 'XMAA'
endfunction

function DB_HERO_PRIMARY_TYPE takes nothing returns integer
    return 'PRIM'
endfunction
function DB_ENUM_STR takes nothing returns integer
    return 1
endfunction
function DB_ENUM_AGI takes nothing returns integer
    return 2
endfunction
function DB_ENUM_INT takes nothing returns integer
    return 3
endfunction

//老
function HERO_TYPE_STR takes nothing returns integer
    return 1
endfunction
function HERO_TYPE_AGI takes nothing returns integer
    return 2
endfunction
function HERO_TYPE_INT takes nothing returns integer
    return 3
endfunction
function GetHeroMainProperty takes unit h returns integer
    return LoadInteger(udg_HeroDatabase,GetUnitTypeId(h),DB_HERO_PRIMARY_TYPE())
endfunction

function DB_HERO_ATTACK_RANGE takes nothing returns integer
    return 'ARNG'
endfunction
function DB_ENUM_MELEE takes nothing returns integer
    return 100
endfunction
function DB_ENUM_MID takes nothing returns integer
    return 450
endfunction
function DB_ENUM_LONG takes nothing returns integer
    return 600
endfunction
function DB_ENUM_SUPER takes nothing returns integer
    return 700
endfunction

function DB_HERO_ITEMS_TYPE_ID takes nothing returns integer
    return 'ITI0'
endfunction
function DB_HERO_ITEMS_TRIGGER_VALUE takes nothing returns integer
    return 'ITV0'
endfunction

function DB_GetHeroSystemItemType takes integer ID,integer which returns integer
    return LoadInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TYPE_ID() + which)
endfunction
function DB_GetHeroSystemItemTime takes integer ID,integer which returns integer
    return LoadInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TRIGGER_VALUE() + which)
endfunction

function DBxSetHeroItemsA takes integer ID,integer i1,integer v1,integer i2,integer v2,integer i3,integer v3 returns nothing
    call SaveInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TYPE_ID() + 0,i1)
    call SaveInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TYPE_ID() + 1,i2)
    call SaveInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TYPE_ID() + 2,i3)
    call SaveInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TRIGGER_VALUE() + 0,v1)
    call SaveInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TRIGGER_VALUE() + 1,v2)
    call SaveInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TRIGGER_VALUE() + 2,v3)
endfunction

function DBxSetHeroItemsB takes integer ID,integer i4,integer v4,integer i5,integer v5,integer i6,integer v6 returns nothing
    call SaveInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TYPE_ID() + 3,i4)
    call SaveInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TYPE_ID() + 4,i5)
    call SaveInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TYPE_ID() + 5,i6)
    call SaveInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TRIGGER_VALUE() + 3,v4)
    call SaveInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TRIGGER_VALUE() + 4,v5)
    call SaveInteger(udg_HeroDatabase,ID,DB_HERO_ITEMS_TRIGGER_VALUE() + 5,v6)
endfunction


//是否可以进入BAN人模式
function IsBanModeAvailable takes nothing returns boolean
    if GetPlayerSlotState(udg_PlayerA[1])!=PLAYER_SLOT_STATE_PLAYING then
        return false
    endif
    if GetPlayerSlotState(udg_PlayerB[1])!=PLAYER_SLOT_STATE_PLAYING then
        return false
    endif
    if GetPlayerController(udg_PlayerA[1])!=MAP_CONTROL_USER then
        return false
    endif
    if GetPlayerController(udg_PlayerB[1])!=MAP_CONTROL_USER then
        return false
    endif
    return true
endfunction

//全场强力广播消息
function BroadcastMessage takes string message returns nothing
    local integer i = 0
    loop
        call DisplayTimedTextToPlayer(Player(i),0,0,6.0,message)
        set i = i + 1
        exitwhen i>=12
    endloop
    //call DisplayTimedTextToPlayer(GetLocalPlayer(),0,0,6.0,message)
endfunction

//获取玩家名称
function PlayerName takes player who returns string
    return udg_PN[GetPlayerId(who)]
endfunction

//获取英雄编号
function GetHeroIndex takes integer ID returns integer
    local integer i = 0
    loop
        exitwhen udg_HeroType[i] == ID
        set i = i + 1
        exitwhen i >= 200
    endloop
    return i
endfunction

//平分所得金钱
function ShareGold takes force team,integer amount returns nothing
    local player who
    local integer sum = 0
    local integer i = 0
    loop
        set who = Player(i)
        if GetPlayerSlotState(who)==PLAYER_SLOT_STATE_PLAYING and IsPlayerInForce(who,team) then
            set sum = sum + 1
        endif
        set i = i + 1
        exitwhen i>15
    endloop
    set amount = amount/sum
    set i = 0
    loop
        set who = Player(i)
        if GetPlayerSlotState(who)==PLAYER_SLOT_STATE_PLAYING and IsPlayerInForce(who,team) then
            call AdjustPlayerStateBJ(amount,who,PLAYER_STATE_RESOURCE_GOLD)
        endif
        set i = i + 1
        exitwhen i>15
    endloop
endfunction

//玩家获取玩家ID 
function GetSortedPlayerId takes player who returns integer
    if IsPlayerInForce(who,udg_TeamA) then
        return GetPlayerId(who)
    elseif IsPlayerInForce(who,udg_TeamB) then
        return GetPlayerId(who)-2
    elseif who==udg_PlayerA[0] then
        return 8
    elseif who==udg_PlayerB[0] then
        return 9
    endif
    return 15
endfunction

//玩家ID获取玩家 
function GetSortedPlayer takes integer id returns player
    if id==8 then
        return udg_PlayerA[0]
    elseif id==9 then
        return udg_PlayerB[0]
    elseif 0<=id and id<=3 then
        return Player(id)
    elseif 4<=id and id<=7 then
        return Player(id+2)
    endif
    return Player(15)
endfunction

//获得玩家当前使用的角色
function GetPlayerCharacter takes player who returns unit
    local integer i = GetPlayerId(who)
    if who == null then
    return null
    endif
    return udg_PlayerHeroes[i]
endfunction

function IsPlayerUser takes player who returns boolean
    if GetPlayerController(who)==MAP_CONTROL_COMPUTER then
        return false
    endif
    return GetPlayerSlotState(who)==PLAYER_SLOT_STATE_PLAYING
endfunction

function HostPlayerTest takes nothing returns nothing
    local gamecache gc = InitGameCache("test.w3v")
    local integer c = GetPlayerId(GetLocalPlayer())
    
    call StoreInteger(gc,"test","host",c + 1)
    
    call TriggerSyncStart()
    call SyncStoredInteger(gc,"test","host")
    call TriggerSyncReady()
    
    set c = GetStoredInteger(gc,"test","host")
    
    set udg_HostPlayerId = c
    
    call FlushGameCache(gc)
    set gc = null
endfunction

function DecideHostPlayer takes nothing returns player
    local integer i = 0
    
    //if udg_HostPlayerId>0 then
    //    set udg_HostPlayer = Player(udg_HostPlayerId - 1)
    //    return udg_HostPlayer
    //endif
    
    loop
        exitwhen i > 11
        if IsPlayerUser(Player(i)) then
            exitwhen IsPlayerInForce(Player(i),udg_TeamA)
            exitwhen IsPlayerInForce(Player(i),udg_TeamB)
        endif
        set i = i + 1
    endloop
    if i>11 then
        set udg_HostPlayer = null
    else
        set udg_HostPlayer = Player(i)
    endif
    
    return udg_HostPlayer
endfunction

//Debug文字
function DebugMsg takes string msg returns nothing
    if udg_DebugMode then
        call DisplayTimedTextToForce(bj_FORCE_ALL_PLAYERS,5.0,msg)
    endif
endfunction

function IsPlayerOpponent takes player A,player B returns boolean
    if IsPlayerObserver(A) or IsPlayerObserver(B) then
        return false
    endif
    return (GetPlayerId(A)<=5)!=(GetPlayerId(B)<=5)
endfunction

function GetPlayerBase takes player who returns rect
    if IsPlayerInForce(who,udg_TeamA) then
        return gg_rct_BaseA
    elseif IsPlayerInForce(who,udg_TeamB) then
        return gg_rct_BaseB
    endif
    return gg_rct_CommonArea
endfunction

function GetPlayerShelter takes player who returns location
    if IsPlayerInForce(who,udg_TeamA) then
        return udg_RecoverPoint[0]
    elseif IsPlayerInForce(who,udg_TeamB) then
        return udg_RecoverPoint[1]
    endif
    return udg_CommonPoint
endfunction

function GetPlayerRevivePoint takes player who returns location
    if IsPlayerInForce(who,udg_TeamA) then
        return udg_RevivePoint[0]
    elseif IsPlayerInForce(who,udg_TeamB) then
        return udg_RevivePoint[1]
    endif
    return udg_CommonPoint
endfunction

function GetPlayerForceId takes player w returns integer
    if IsPlayerInForce(w,udg_TeamA) then
        return 0
    endif
    if IsPlayerInForce(w,udg_TeamB) then
        return 1
    endif
    if w==udg_PlayerA[0] or w==udg_PlayerA[5] then
        return 0
    endif
    if w==udg_PlayerB[0] or w==udg_PlayerB[5] then
        return 1
    endif
    return 0
endfunction

function CreateGroupOfAllHeroes takes nothing returns group
    local group g = CreateGroup()
    local unit h
    local integer i = 0
    loop
        exitwhen i>=12
        set h = udg_PlayerHeroes[i]
        if h!= null then
            call GroupAddUnit(g,h)
        endif
        set i = i + 1
    endloop
    set bj_lastCreatedGroup = g
    set g = null
    set h = null
    return bj_lastCreatedGroup
endfunction

//==============================================================================

function InitTrig_Systems takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Override Systems
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function IsUnitSpawn takes unit u returns boolean
    return GetUnitAbilityLevel(u,'A008')>0 and GetUnitTypeId(u)!='h015' and GetUnitTypeId(u)!='h01O'
endfunction

function IsUnitWard takes unit u returns boolean
    return GetUnitAbilityLevel(u,'A0IL')>0
endfunction

function IsUnitGiant takes unit u returns boolean
    return IsUnitType(u,UNIT_TYPE_GIANT)
endfunction

function IsMobileUnit takes unit u returns boolean
    local integer id
    if IsUnitWard(u) then
        return false
    endif
    if IsUnitGiant(u) then
        return false
    endif
    set id = GetUnitTypeId(u)
    if id=='U00M' then
        return false
    endif
    if id=='n01M' then
        return false
    endif
    return true
endfunction

//自定义状态
//==============================================================================

function SetCustomState takes unit u,integer index,integer x returns nothing
    local integer d = GetUnitUserData(u)
    local integer n = R2I(Pow(10,index-1))
    local integer m = 10*n
    call SetUnitUserData(u,(d/m*m)+(x*n)+(d-d/n*n))
endfunction

function GetCustomState takes unit u,integer index returns integer
    local integer d = GetUnitUserData(u)
    local integer n = R2I(Pow(10,index-1))
    local integer m = 10*n
    return d/n-d/m*10
endfunction

function IsUnitFree takes unit u returns boolean
    local integer d = GetUnitUserData(u)
    return (d-d/10000*10000)==0
endfunction

//常量

//失控中（间隙等） 
function CS_LOST takes nothing returns integer
    return 1
endfunction

//卷入中（漩涡等）
function CS_DRAW takes nothing returns integer
    return 2
endfunction

//被拉中（19百合钩子等）
function CS_DRAG takes nothing returns integer
    return 3
endfunction

//被击退中（红有三魔炮等）
function CS_REPEL takes nothing returns integer
    return 4
endfunction

//冲刺中（文文黑白等）
function CS_DASHING takes nothing returns integer
    return 5
endfunction

//绝对静止（9）
function CS_FROZEN takes nothing returns integer
    return 6
endfunction

function CS_YUUGI takes nothing returns integer
    return 7
endfunction

//主接口函数

function SetUnitFlag takes unit u,integer which,boolean flag returns nothing
    if flag then
        call SetCustomState(u,which,4)
    else
        call SetCustomState(u,which,0)
    endif
endfunction

function GetUnitFlag takes unit u,integer which returns boolean
    return GetCustomState(u,which)!=0
endfunction

function ClearUnitFlag takes unit u returns nothing
    call SetUnitUserData(u,0)
endfunction

//抗负面
function IsUnitAntiDebuff takes unit u returns boolean
    if GetUnitAbilityLevel(u,'A0AN')>0 then
        return true
    endif
    return IsUnitType(u,UNIT_TYPE_RESISTANT)
endfunction

//魔法免疫
function IsUnitAntiMagic takes unit u returns boolean
    if GetUnitAbilityLevel(u,'ACmi')>0 then
        return true
    endif
    if GetUnitAbilityLevel(u,'ACm2')>0 then
        return true
    endif
    if GetUnitAbilityLevel(u,'ACm3')>0 then
        return true
    endif
    return IsUnitType(u,UNIT_TYPE_MAGIC_IMMUNE)
endfunction

//被沉默
function IsUnitSlient takes unit u returns boolean
    if GetUnitAbilityLevel(u,'B019')>0 then
        return true
    endif
    if GetUnitAbilityLevel(u,'B035')>0 then
        return true
    endif
    if GetUnitAbilityLevel(u,'B00Q')>0 then
        return true
    endif
    if GetUnitAbilityLevel(u,'B032')>0 then
        return true
    endif
    if GetUnitAbilityLevel(u,'BNsi')>0 then
        return true
    endif
    return false
endfunction

//被变形
function IsUnitMorphed takes unit u returns boolean
    if GetUnitAbilityLevel(u,'B00N')>0 then
        return true
    endif
    if GetUnitAbilityLevel(u,'B03S')>0 then
        return true
    endif
    return IsUnitType(u,UNIT_TYPE_POLYMORPHED)
endfunction

//被限制
function IsUnitLimited takes unit u returns boolean
    if GetUnitAbilityLevel(u,'B00N')>0 then
        return true
    endif
    if GetUnitAbilityLevel(u,'B03S')>0 then
        return true
    endif
    if GetUnitFlag(u,CS_LOST()) then
        return true
    endif
    if GetUnitFlag(u,CS_DRAW()) then
        return true
    endif
    if GetUnitFlag(u,CS_REPEL()) then
        return true
    endif
    if GetUnitFlag(u,CS_FROZEN()) then
        return true
    endif
    if GetUnitCurrentOrder(u)==851973 then//眩晕 催眠 空中鎖?
        return true
    endif
    if IsUnitType(u,UNIT_TYPE_SNARED) then
        return true
    endif
    return false
endfunction

//==============================================================================

function InitTrig_Override_Systems takes nothing returns nothing    
endfunction
//===========================================================================
// Trigger: Misc
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function InitTrig_Misc takes nothing returns nothing
endfunction

//BLTalismanic Resetion
function Item_BLTalismanicRunningCD_Resolve takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit target = LoadUnitHandle(udg_Hashtable,task,0)
    local integer k = GetConvertedPlayerId(GetOwningPlayer(target))
    set udg_SK_BLTalismanicCoolDown[k] = false
    if UnitHasItemOfTypeBJ(target, 'I00E') then
        set udg_SK_BLTalismanicAvaliable[k] = true
        call UnitAddAbility(target,'A0QL')
    endif
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set target = null
endfunction

function Item_BLTalismanicRunningCD takes unit target returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer k = GetConvertedPlayerId(GetOwningPlayer(target))
    set udg_SK_BLTalismanicAvaliable[k] = false
    set udg_SK_BLTalismanicCoolDown[k] = true
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\SpellShieldAmulet\\SpellShieldCaster.mdl",GetUnitX(target),GetUnitY(target)))
    call UnitRemoveAbility(target,'A0QL')
    call SaveUnitHandle(udg_ht,task,0,target)
    call SaveTimerHandle(udg_ht,task,99,t)
    call TimerStart(t,30.0,false,function Item_BLTalismanicRunningCD_Resolve)
    set t = null
endfunction

//Ability CoolDown Resetion
function Item_HeroAbilityCoolDownReset_Resolve takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer abilityid = LoadInteger(udg_ht,task,1)
    local integer abilitylevel = GetUnitAbilityLevel(caster,abilityid)
    call UnitRemoveAbility(caster,abilityid)
    call UnitAddAbility(caster,abilityid)
    call SetUnitAbilityLevel(caster,abilityid,abilitylevel)
    call UnitMakeAbilityPermanent(caster,true,abilityid)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set caster = null
endfunction

function Item_HeroAbilityCoolDownReset takes unit caster ,integer abilityid ,real loadtime returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,1,abilityid)
    call SaveTimerHandle(udg_ht,task,99,t)
    call TimerStart(t,loadtime * 0.75,false,function Item_HeroAbilityCoolDownReset_Resolve)
    set t = null
endfunction

//附加攻击力
function UnitAddAttackDamage takes unit u,integer d returns nothing
    call SetUnitAbilityLevel(u, 'A0H9', d/1000 + 1)
    set d = d - d/1000*1000
    call SetUnitAbilityLevel(u, 'A0H8', d/100 + 1)
    set d = d - d/100*100
    call SetUnitAbilityLevel(u, 'A0H7', d/10 + 1)
    set d = d - d/10*10
    call SetUnitAbilityLevel(u, 'A0H6', d + 1)
endfunction

//BUG
function PreMorphReset takes unit h returns nothing
    call UnitRemoveAbility(h,'B019')
    call UnitRemoveAbility(h,'B035')
    call UnitRemoveAbility(h,'Bspe')
    call UnitRemoveAbility(h,'B00G')
    call UnitRemoveAbility(h,'B02T')
    call UnitRemoveAbility(h,'B049')
    call SetUnitMoveSpeed(h,GetUnitDefaultMoveSpeed(h))
endfunction

//秒杀
function InstantKill takes unit caster,unit target returns nothing
    local real damage = GetUnitState(target,UNIT_STATE_LIFE)*1.5
    local real hp
    if IsUnitGiant(target) then
        set damage = 2000.0
    //UUZ undeath
    elseif GetUnitAbilityLevel(target,'A0MQ')!=0 then
        set damage = 0.0
    else
        set damage = GetUnitState(target,UNIT_STATE_LIFE)*1.5 + 550.0
    endif
    set hp = GetUnitState(target,UNIT_STATE_LIFE)
    call UnitDamageTarget(caster,target,damage,false,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    if hp - damage < GetUnitState(target,UNIT_STATE_LIFE) then
        call UnitDamageTarget(caster,target,damage,false,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_DEMOLITION,WEAPON_TYPE_WHOKNOWS)
    endif
endfunction

//技能文字
function CastSpell takes unit caster,string name returns texttag
    local real ox = GetUnitX(caster) - 8.0*StringLength(name)
    local real oy = GetUnitY(caster)
    local texttag e = CreateTextTag()
    call SetTextTagTextBJ(e,name,16.0)
    call SetTextTagPos(e,ox,oy,80.0)
    call SetTextTagColor(e,255,240,40,240)
    call SetTextTagVelocityBJ(e,64,90)
    call SetTextTagPermanent(e,false)
    call SetTextTagLifespan(e,2.00)
    set bj_lastCreatedTextTag = e
    set e = null
    return bj_lastCreatedTextTag
endfunction

//增加任意最大生命值
function addlife takes unit u,integer life returns nothing
    local integer a
    local integer b = 2
    loop
        exitwhen life == 0
        set a = life - life / 10 * 10
        loop
            exitwhen a == 0
            set a = a - 1
            call UnitAddAbility(u,'A07D')
            call SetUnitAbilityLevel(u,'A07D',b)
            call UnitRemoveAbility(u,'A07D')
        endloop
        set life = life / 10
        set b = b + 1
    endloop
endfunction

function AddUnitMaxLife takes unit u,integer amount returns nothing
    call addlife(u,amount)
endfunction

//跳跃函数
function JumpTimerLoop takes nothing returns nothing
    local timer t=GetExpiredTimer()
    local integer task=GetHandleId(t)
    local unit hero=LoadUnitHandle(udg_Hashtable, task, StringHash("Hero"))
    local real angle=LoadReal(udg_Hashtable, task, StringHash("Angle"))
    local integer steeps=LoadInteger(udg_Hashtable, task, StringHash("steeps"))
    local integer steepsMax=LoadInteger(udg_Hashtable, task, StringHash("steepsMax"))
    local real heightMax=LoadReal(udg_Hashtable, task, StringHash("heightMax"))
    local real dist=LoadReal(udg_Hashtable, task, StringHash("dist"))
    local real dheig=LoadReal(udg_Hashtable, task, StringHash("dheig"))
    local real OriginHeight=LoadReal(udg_Hashtable, task, StringHash("OriginHeight"))
    local real x=LoadReal(udg_Hashtable, task, StringHash("X"))
    local real y=LoadReal(udg_Hashtable, task, StringHash("Y"))
    local real x1=0
    local real y1=0
    local real height=0
    if steeps < steepsMax then
        set x1=x + steeps * dist * Cos(angle * 3.14159 / 180.0)
        set y1=y + steeps * dist * Sin(angle * 3.14159 / 180.0)
        call SetUnitX(hero, x1)
        call SetUnitY(hero, y1)
        call SetUnitFacing(hero,angle)
        set steeps=steeps + 1
        call SaveInteger(udg_Hashtable, task, StringHash("steeps"), steeps)
        set height=( - ( 2 * I2R(steeps) * dheig - 1 ) * ( 2 * I2R(steeps) * dheig - 1 ) + 1 ) * heightMax + OriginHeight
        call SetUnitFlyHeight(hero, height, 0)
        call SetUnitFacingTimed(hero, angle,0)
    else
        call SetUnitFlyHeight(hero, GetUnitDefaultFlyHeight(hero), 0)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable, task)
    endif
    set t=null
    set hero=null
endfunction

function JumpTimer takes unit hero,real angle,real distance,real lasttime,real timeout,real heightMax returns nothing
    local timer t=CreateTimer()
    local integer task = GetHandleId(t)
    local real x=GetUnitX(hero)
    local real y=GetUnitY(hero)
    local integer steepsMax=R2I(lasttime / timeout)
    local integer steeps=0
    local real dist=distance / steepsMax
    local real dheig=1.0 / steepsMax
    local real OriginHeight=GetUnitFlyHeight(hero)
    call UnitAddAbility(hero, 'Amrf')
    call UnitRemoveAbility(hero, 'Amrf')  
    call SaveTimerHandle( udg_Hashtable, task, StringHash("Timer"), t )
    call SaveUnitHandle( udg_Hashtable, task, StringHash("Hero"), hero )
    call SaveReal( udg_Hashtable, task, StringHash("OriginHeight"), OriginHeight )
    call SaveReal( udg_Hashtable, task, StringHash("Angle"), angle )
    call SaveReal( udg_Hashtable, task, StringHash("dist"), dist )
    call SaveReal( udg_Hashtable, task, StringHash("heightMax"), heightMax )
    call SaveReal( udg_Hashtable, task, StringHash("dheig"), dheig )
    call SaveReal( udg_Hashtable, task, StringHash("X"), x )
    call SaveReal( udg_Hashtable, task, StringHash("Y"), y )
    call SaveInteger( udg_Hashtable, task, StringHash("steeps"), steeps )
    call SaveInteger( udg_Hashtable, task, StringHash("steepsMax"), steepsMax )
    call TimerStart( t, timeout, true, function JumpTimerLoop )
    set t=null
endfunction

//渐隐函数
//=======================================
function UnitFade_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_Hashtable,task,1)
    local integer i = LoadInteger(udg_Hashtable,task,2)
    local boolean killornot = LoadBoolean(udg_Hashtable,task,4)
    local boolean fadeorappear = LoadBoolean(udg_Hashtable,task,5)
    local integer j
    //========
    if i>0 then
        if fadeorappear then
            set j = i
        else
            set j = 11 - i
        endif
        call SetUnitVertexColor(u,5+j*25,5+j*25,5+j*25,5+j*25)        
        set i = i - 1
        call SaveInteger(udg_Hashtable,task,2,i)
    else
        if killornot then
            call KillUnit(u)
            call RemoveUnit(u)
        endif
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,task)
    endif
    //========
    set t = null
    set u = null
endfunction

function UnitFade takes unit u, boolean killornot, boolean fadeorappear, real speedperiod returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    call SaveUnitHandle(udg_Hashtable,task,1,u)
    call SaveInteger(udg_Hashtable,task,2,10)
    call SaveTimerHandle(udg_Hashtable,task,3,t)
    call SaveBoolean(udg_Hashtable,task,4,killornot)
    call SaveBoolean(udg_Hashtable,task,5,fadeorappear)
    call TimerStart(t,speedperiod,true,function UnitFade_Main)
    set t = null
endfunction

//=======================================

function GetInventoryIndexOfItemType takes unit u,integer ID returns integer
    local integer i
    local item w
    
    set i = 0
    loop
        set w = UnitItemInSlot(u,i)
        if (w != null) and (GetItemTypeId(w)==ID) then
            set w = null
            return i + 1
        endif
        
        set i = i + 1
        exitwhen i >= bj_MAX_INVENTORY
    endloop
    
    set w = null
    return 0
endfunction

//玩家文字上色 
function PlayerColorText takes string s,player q returns string
    return udg_PlayerColors[GetPlayerId(q)] + s + "|r"
endfunction

function UnitGainMana takes unit whichUnit, real gain returns nothing
    local real manaMax = GetUnitState(whichUnit, UNIT_STATE_MAX_MANA)
    local real mana = GetUnitState(whichUnit, UNIT_STATE_MANA)
    if mana + gain > manaMax then
        call SetUnitState(whichUnit, UNIT_STATE_MANA, manaMax)
    else
        call SetUnitState(whichUnit, UNIT_STATE_MANA, mana + gain)
    endif
endfunction

function UnitGainLife takes unit whichUnit, real gain returns nothing
    local real lifeMax = GetUnitState(whichUnit, UNIT_STATE_MAX_LIFE)
    local real life = GetUnitState(whichUnit, UNIT_STATE_LIFE)
    if life + gain > lifeMax then
        call SetUnitState(whichUnit, UNIT_STATE_LIFE, lifeMax)
    else
        call SetUnitState(whichUnit, UNIT_STATE_LIFE, life + gain)
    endif
endfunction

//判断是否是白天
function IsDayTime takes nothing returns boolean
    return GetTimeOfDay() >= 6 and GetTimeOfDay() < 18
endfunction



function InitACSII takes nothing returns nothing
    local string chars = " !.#$%&'()*+,-./0123456789:;<=>.@ABCDEFGHIJKLMNOPQRSTUVWXYZ[.]^_`abcdefghijklmnopqrstuvwxyz{|}~"//32-126
    local integer i = 0
    loop
        exitwhen i>=128
        if (i>=32)and(i<=126) then
            set udg_ACSII[i] = SubString(chars,i-32,i-31)
        else
            set udg_ACSII[i] = "NAC"
        endif
        set i = i + 1
    endloop
endfunction

function StringToID takes string str returns integer
    local integer i
    local integer c
    local integer d = 0
    local string b
    
    set i = 0
    loop
        set b = SubString(str,i,i+1)
        set c = '0'
        loop
            exitwhen udg_ACSII[c]==b
            set c = c + 1
            exitwhen c>'z'
        endloop
        set d = d*256 + c
        set i = i + 1
        exitwhen i==4
    endloop
    
    set b = null
    
    return d
endfunction



//限时播放动画
function PlayUnitAnimeTimedEnd takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer tid = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_Hashtable, tid, 1)

    call SetUnitAnimation(u, "stand")
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_Hashtable, tid)
    set t = null
    set u = null
endfunction

function PlayUnitAnimeTimedStart takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer tid = GetHandleId(t)
    local timer t2 = CreateTimer()
    local integer t2id = GetHandleId(t2)
    local unit u = LoadUnitHandle(udg_Hashtable, tid, 1)
    local string animename = LoadStr(udg_Hashtable, tid, 2)
    local real lasttime = LoadReal(udg_Hashtable, tid, 3)

    call SetUnitAnimation(u, animename)
    call TimerStart(t2, lasttime, false, function PlayUnitAnimeTimedEnd)
    call SaveUnitHandle(udg_Hashtable, t2id, 1, u)
    call SaveTimerHandle( udg_Hashtable, t2id, 99, t )
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_Hashtable, tid)
    set t = null
    set t2 = null
    set u = null
endfunction

function PlayUnitAnimeTimed takes unit u, string animename, real lasttime returns nothing
    local timer t = CreateTimer()
    call TimerStart(t, 0.01, false, function PlayUnitAnimeTimedStart)
    call SaveUnitHandle(udg_Hashtable, GetHandleId(t), 1, u)
    call SaveStr(udg_Hashtable, GetHandleId(t), 2, animename)
    call SaveReal(udg_Hashtable, GetHandleId(t), 3, lasttime)
    call SaveTimerHandle(udg_Hashtable, GetHandleId(t), 99, t )
    set t = null
endfunction

//播放动画 不会重置动作
function PlayUnitAnimeNoLoopStart takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer tid = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_Hashtable, tid, 1)
    local string animename = LoadStr(udg_Hashtable, tid, 2)

    call SetUnitAnimation(u, animename)
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_Hashtable, tid)
    set t = null
    set u = null
endfunction

function PlayUnitAnimeNoLoop takes unit u, string animename returns nothing
    local timer t = CreateTimer()
    call TimerStart(t, 0.01, false, function PlayUnitAnimeNoLoopStart)
    call SaveUnitHandle(udg_Hashtable, GetHandleId(t), 1, u)
    call SaveStr(udg_Hashtable, GetHandleId(t), 2, animename)
    call SaveTimerHandle(udg_Hashtable, GetHandleId(t), 99, t )
    set t = null
endfunction

//限时播放动画 按序号(按动作名不好使的话试试这个)
function PlayUnitAnimeTimedByIndexEnd takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer tid = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_Hashtable, tid, 1)

    call SetUnitAnimation(u, "stand")
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_Hashtable, tid)
    set t = null
    set u = null
endfunction

function PlayUnitAnimeTimedByIndexStart takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer tid = GetHandleId(t)
    local timer t2 = CreateTimer()
    local integer t2id = GetHandleId(t2)
    local unit u = LoadUnitHandle(udg_Hashtable, tid, 1)
    local integer animeindex = LoadInteger(udg_Hashtable, tid, 2)
    local real lasttime = LoadReal(udg_Hashtable, tid, 3)

    call SetUnitAnimationByIndex(u, animeindex)
    call TimerStart(t2, lasttime, false, function PlayUnitAnimeTimedByIndexEnd)
    call SaveUnitHandle(udg_Hashtable, t2id, 1, u)
    call SaveTimerHandle(udg_Hashtable, t2id, 99, t )
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_Hashtable, tid)
    set t = null
    set t2 = null
    set u = null
endfunction

function PlayUnitAnimeTimedByIndex takes unit u, integer animeindex, real lasttime returns nothing
    local timer t = CreateTimer()
    call TimerStart(t, 0.01, false, function PlayUnitAnimeTimedByIndexStart)
    call SaveUnitHandle(udg_Hashtable, GetHandleId(t), 1, u)
    call SaveInteger(udg_Hashtable, GetHandleId(t), 2, animeindex)
    call SaveReal(udg_Hashtable, GetHandleId(t), 3, lasttime)
    call SaveTimerHandle(udg_Hashtable, GetHandleId(t), 99, t )
    set t = null
endfunction

//---------------------------------------------------------------------------------------------------
//Nue
//Nue Reset CD
function NueResetCD takes unit killer,unit dyer returns nothing
    local integer level = GetUnitAbilityLevel(killer,'A0M3')
    local integer ab01lv = GetUnitAbilityLevel(killer,'A0M1')
    local integer ab02lv = GetUnitAbilityLevel(killer,'A0M2')
    local integer ab04lv = GetUnitAbilityLevel(killer,'A0M4')
    if level >= 1 then
        call AddHeroXP(killer,10+level*5,true)
        if IsUnitType(dyer, UNIT_TYPE_HERO) == true and IsUnitIllusionBJ(dyer) == false then
            if level !=4 then
                call UnitRemoveAbility(killer,'A0LZ')
                call UnitAddAbility(killer,'A0LZ' )
            endif
            if ab01lv >= 1 and level != 4 then
                call UnitRemoveAbility(killer,'A0M1')
                call UnitAddAbility(killer,'A0M1' )
                call SetUnitAbilityLevel(killer,'A0M1',ab01lv)
            endif
            if level >= 2 and level != 4 and ab02lv >= 1 then
                call UnitRemoveAbility(killer,'A0M2')
                call UnitAddAbility(killer,'A0M2' )
                call SetUnitAbilityLevel(killer,'A0M2',ab02lv)
            endif
            if level == 3 and ab04lv >= 1 then
                call UnitRemoveAbility(killer,'A0M4')
                call UnitAddAbility(killer,'A0M4' )
                call SetUnitAbilityLevel(killer,'A0M4',ab04lv)
            endif
            if level == 4 then
                call UnitResetCooldown(killer)
            endif
        endif
    endif
endfunction

//Nue Damage Counting
function NueDamageCounting takes unit caster returns real
    local real nmdamage 
    local real nmbased = 11.25
    local integer nmlevel = GetUnitAbilityLevel(caster, 'A0M1')
    if nmlevel >= 1 then
        set nmdamage = nmbased * I2R(nmlevel) * (1.00 + I2R(udg_SK_nue_nightmare_buff))
    else
        set nmdamage = 0.00
    endif
    return nmdamage
endfunction

//---------------------------------------------------------------------------------------------------
//替换单位物品(单位,物品栏格数,物品1,物品2)
//将item1替换为item2 没有找到物品返回false
function ChangeUnitItem takes unit whichunit, integer slotnum, item item1, item item2 returns boolean
    local integer i = 0
    local integer targetindex = 0
    local boolean flag = false
    local real x = GetUnitX(whichunit)
    local real y = GetUnitY(whichunit)

    loop
        exitwhen(i>slotnum-1)
        if UnitItemInSlot(whichunit, i) == item1 then
            set targetindex = i
            set flag = true
        endif
        set i = i + 1
    endloop
    if not flag then
        return false
    endif
    set i = 0
    call RemoveItem(item1)
    loop
        exitwhen(i>targetindex-1)
        if UnitItemInSlot(whichunit, i) == null then
            call UnitAddItem(whichunit, CreateItem('ches', x, y))  //添加奶酪物品占位
        endif
        set i = i + 1
    endloop
    call UnitAddItem(whichunit, item2)
    set i = 0
    loop
        exitwhen(i>targetindex-1)
        if GetItemTypeId(UnitItemInSlot(whichunit, i)) == 'ches' then
            call RemoveItem(UnitItemInSlot(whichunit, i))  //删除占位物品
        endif
        set i = i + 1
    endloop
    return true
endfunction

//------------------------------------------------------------------------
//检测单位是否持有某物品
function IsUnitOwnedItem takes unit whichunit, item whichitem returns boolean
    local integer i = 0

    if whichitem == null then
        return false
    endif
    loop
        exitwhen(i>5)
        if UnitItemInSlot(whichunit, i) == whichitem then
            return true
        endif
        set i = i + 1
    endloop
    return false
endfunction

//---------------------------------------------------------------------------
function UnitDamageTargetHJ_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local real damage = LoadReal(udg_ht,task,2)
    local real damagerecord
    local real hp
    local integer dtype = LoadInteger(udg_ht,task,3)
    local unit u
    if dtype >= 5 or dtype <= -1 then
        call DebugMsg("dtype should be 0-Magic 1-Physic 2-NonarmorMagic 3-NonarmorPhysic 4-BothPenatrated")
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        set t = null
        set caster = null
        set target = null
        set u = null
        return
    endif
    set u = CreateUnit(GetOwningPlayer(caster),'n00F',GetUnitX(caster),GetUnitY(caster),0)
    if dtype == 0 then
        call UnitDamageTarget(u,target,damage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    endif
    if dtype == 1 then
        call UnitDamageTarget(u,target,damage,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
    endif
    if dtype == 2 then
        call UnitDamageTarget(u,target,damage,false,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    endif
    if dtype == 3 then
        call UnitDamageTarget(u,target,damage,false,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_DEMOLITION,WEAPON_TYPE_WHOKNOWS)
    endif
    if dtype == 4 then
        set hp = GetUnitState(target,UNIT_STATE_LIFE)
        call UnitDamageTarget(u,target,damage,false,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
        //if hp - damage < GetUnitState(target,UNIT_STATE_LIFE) then
        //    call SetUnitState(target,UNIT_STATE_LIFE,hp)
        //    call UnitDamageTarget(u,target,damage,false,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_DEMOLITION,WEAPON_TYPE_WHOKNOWS)
        //endif
    endif
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set caster = null
    set target = null
    set u = null
endfunction

function UnitDamageTargetHJ takes unit caster, unit target, real damage, integer dtype returns nothing
    local timer t = CreateTimer() 
    local integer task = GetHandleId(t) 
    if GetUnitAbilityLevel(target,'A0MQ')!=0 then
        set t = null
        set caster = null
        set target = null
        return
    endif
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveReal(udg_ht,task,2,damage)
    call SaveInteger(udg_ht,task,3,dtype)
    call SaveTimerHandle(udg_ht,task,99,t)
    call TimerStart(t,0.01,false,function UnitDamageTargetHJ_Clear)
    set t = null
endfunction

function UnitDamageTargetHina_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local real damage = LoadReal(udg_ht,task,2)
    local integer dtype = LoadInteger(udg_ht,task,3)
    local unit u
    if dtype >= 3 or dtype <= -1 then
        call DebugMsg("dtype should be 0-Magic 1-Physic 2-God")
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        set t = null
        set caster = null
        set target = null
        set u = null
        return
    endif
    set u = CreateUnit(GetOwningPlayer(caster),'n02V',GetUnitX(caster),GetUnitY(caster),0)
    if dtype == 0 then
        call UnitDamageTarget(u,target,damage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    endif
    if dtype == 1 then
        call UnitDamageTarget(u,target,damage,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
    endif
    if dtype == 2 then
        call UnitDamageTarget(u,target,damage,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    endif
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set caster = null
    set target = null
    set u = null
endfunction

function UnitDamageTargetHina takes unit caster, unit target, real damage, integer dtype, real dtime returns nothing
    local timer t = CreateTimer() 
    local integer task = GetHandleId(t) 
    if GetUnitAbilityLevel(target,'A0MQ')!=0 then
        set t = null
        set caster = null
        set target = null
        return
    endif
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveReal(udg_ht,task,2,damage)
    call SaveInteger(udg_ht,task,3,dtype)
    call SaveTimerHandle(udg_ht,task,99,t)
    call TimerStart(t,dtime,false,function UnitDamageTargetHina_Clear)
    set t = null
endfunction

function UnitDamageTargetHinaII_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local real damage = LoadReal(udg_ht,task,2)
    local integer dtype = LoadInteger(udg_ht,task,3)
    local unit u
    if dtype >= 3 or dtype <= -1 then
        call DebugMsg("dtype should be 0-Magic 1-Physic 2-God")
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        set t = null
        set caster = null
        set target = null
        set u = null
        return
    endif
    set u = CreateUnit(GetOwningPlayer(caster),'n02U',GetUnitX(caster),GetUnitY(caster),0)
    if dtype == 0 then
        call UnitDamageTarget(u,target,damage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    endif
    if dtype == 1 then
        call UnitDamageTarget(u,target,damage,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
    endif
    if dtype == 2 then
        call UnitDamageTarget(u,target,damage,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    endif
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set caster = null
    set target = null
    set u = null
endfunction

function UnitDamageTargetHinaII takes unit caster, unit target, real damage, integer dtype returns nothing
    local timer t = CreateTimer() 
    local integer task = GetHandleId(t) 
    if GetUnitAbilityLevel(target,'A0MQ')!=0 then
        set t = null
        set caster = null
        set target = null
        return
    endif
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveReal(udg_ht,task,2,damage)
    call SaveInteger(udg_ht,task,3,dtype)
    call SaveTimerHandle(udg_ht,task,99,t)
    call TimerStart(t,0.01,false,function UnitDamageTargetHinaII_Clear)
    set t = null
endfunction
//---------------------------------------------------------------------------//===========================================================================
// Trigger: Any Unit Damaged
//
// //=====================================================================================//
// //  说明：任意单位接受伤害系统，调用 RegisterAnyUnitDamage(trigger) 为指定触发注册即可 //
// //=====================================================================================//
// udg_AUD_LimitRunTimes = 100
// udg_AUD_LimitEventCount = 50000 
// 这2个一个是递归上限，一个是事件上限 
// 递归上限就是，伤害事件里面再用触发伤害，而且没有经过条件区分的，就会造成触发器自己触发自己，无限次循环跳出游戏 
// 所以加个上限，每次触发达到上限就停了
// 其实10就可以了，100的话，完全到上限会大卡一下，500是极限，超过500游戏就会跳出
//===========================================================================
//TESH.scrollpos=55
//TESH.alwaysfold=0
function UnitAddDamage takes unit u returns nothing
    set udg_AUD_eventCount = udg_AUD_eventCount + 1
    call TriggerRegisterUnitEvent(udg_AUD_anyUnitDamageTrigger,u,EVENT_UNIT_DAMAGED)
endfunction

function EnumHero takes nothing returns nothing
    call UnitAddDamage(GetEnumUnit())
endfunction

function EnumUnit takes nothing returns boolean
    local unit u = GetFilterUnit()
    if(IsUnitInGroup(u,udg_AUD_heroGroup) == false)then
        call UnitAddDamage(u)
        if(IsUnitType(u,UNIT_TYPE_HERO) and IsUnitIllusion(u) == false)then
            call GroupAddUnit(udg_AUD_heroGroup,u)
        endif
    endif
    set u = null
    return false
endfunction

function AnyUnitDamageAction takes nothing returns boolean
    local integer i
    if(udg_AUD_runCount > udg_AUD_LimitRunTimes)then
        return false
    endif
    set udg_AUD_runCount = udg_AUD_runCount + 1
    set i = 0
    loop
        exitwhen udg_AUD_trgArray[i] == null
        if(IsTriggerEnabled(udg_AUD_trgArray[i]))then
            if(TriggerEvaluate(udg_AUD_trgArray[i]))then
                call TriggerExecute(udg_AUD_trgArray[i])
            endif
        endif
        set i = i + 1
    endloop
    set udg_AUD_runCount = 0
    return false
endfunction

function ReBuild takes nothing returns nothing
    local group g = CreateGroup()
    call DestroyTrigger(udg_AUD_anyUnitDamageTrigger)
    set udg_AUD_eventCount = 0
    set udg_AUD_anyUnitDamageTrigger = CreateTrigger()
    call TriggerAddCondition(udg_AUD_anyUnitDamageTrigger,Condition(function AnyUnitDamageAction))
    call ForGroup(udg_AUD_heroGroup,function EnumHero)
    call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Filter(function EnumUnit))
    call DestroyGroup(g)
    set g = null
endfunction

function UnitInGame takes nothing returns boolean
    if(GetUnitAbilityLevel(GetEnteringUnit(),'Aloc') == 0)then
        if(GetRandomInt(udg_AUD_eventCount,udg_AUD_LimitEventCount) < udg_AUD_LimitEventCount)then
            call UnitAddDamage(GetEnteringUnit())
        else
            call ReBuild()
        endif
    endif
    return false
endfunction

function RegisterAnyUnitDamage takes trigger t returns nothing
    local integer i
    local group g
    
    if(udg_AUD_hasInit == false)then
        set udg_AUD_hasInit = true
        set udg_AUD_eventCount = 0
        set udg_AUD_LimitRunTimes = 10
        set udg_AUD_LimitEventCount = 4000
        set udg_AUD_anyUnitDamageTrigger = CreateTrigger()
        call TriggerAddCondition(udg_AUD_anyUnitDamageTrigger,Condition(function UnitInGame))
        call TriggerRegisterEnterRectSimple(udg_AUD_anyUnitDamageTrigger,bj_mapInitialPlayableArea)
        set udg_AUD_anyUnitDamageTrigger = CreateTrigger()
        call TriggerAddCondition(udg_AUD_anyUnitDamageTrigger,Condition(function AnyUnitDamageAction))
        set udg_AUD_heroGroup = CreateGroup()
        set g = CreateGroup()
        call GroupEnumUnitsInRect(g,bj_mapInitialPlayableArea,Filter(function EnumUnit))
        call DestroyGroup(g)
        set g = null
        call TimerStart(CreateTimer(),1200,true,function ReBuild)
    endif
    set i = 0
    loop
        exitwhen udg_AUD_trgArray[i] == null or udg_AUD_trgArray[i] == t
        if(i > JASS_MAX_ARRAY_SIZE)then
            return
        endif
        set i = i + 1
    endloop
    set udg_AUD_trgArray[i] = t
endfunction

//===========================================================================
function InitTrig_Any_Unit_Damaged takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: AI System
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function InitTrig_AI_System takes nothing returns nothing
endfunction

function AI_GetPlayerForceId takes player w returns integer
    return GetPlayerForceId(w)
endfunction

function AI_GetAllFoes takes unit h,real range returns group
    local player w = GetOwningPlayer(h)
    local group g = CreateGroup()
    local unit v
    local integer i = 0
    loop
        exitwhen i>=12
        set v = udg_PlayerHeroes[i]
        if v!= null and IsUnitAlive(v) then
            if IsUnitEnemy(v,w) and IsUnitInRange(h,v,range) then
                call GroupAddUnit(g,v)
            endif
        endif
        set i = i + 1
    endloop
    set bj_lastCreatedGroup = g
    set g = null
    set v = null
    set w = null
    return bj_lastCreatedGroup
endfunction

function AI_GetAllFriends takes unit h,real range returns group
    local player w = GetOwningPlayer(h)
    local group g = CreateGroup()
    local unit v
    local integer i = 0
    loop
        exitwhen i>=12
        set v = udg_PlayerHeroes[i]
        if v!= null and IsUnitAlive(v) then
            if IsUnitAlly(v,w) and IsUnitInRange(h,v,range) then
                call GroupAddUnit(g,v)
            endif
        endif
        set i = i + 1
    endloop
    set bj_lastCreatedGroup = g
    set g = null
    set v = null
    set w = null
    return bj_lastCreatedGroup
endfunction

function AI_ClearInventorySlot takes unit h returns nothing
    local item w
    local integer i
    if h==null or IsUnitDead(h) then
        set w = null
        return
    endif
    set i = 0
    loop
        set w = UnitItemInSlot(h,i)
        if (w != null) and (GetItemType(w)==ITEM_TYPE_PURCHASABLE) then
            call UnitRemoveItem(h,w)
            set w = null
            exitwhen true
        endif
        set i = i + 1
        exitwhen i >= bj_MAX_INVENTORY
    endloop
    set w = null
endfunction

function AI_UnitAddItem_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit h = LoadUnitHandle(udg_ht,task,0)
    local item w = LoadItemHandle(udg_ht,task,1)
    local integer i = LoadInteger(udg_ht,task,1)
    if IsUnitAlive(h) or i<=0 then
        if LoadBoolean(udg_ht,task,0) then
            call AI_ClearInventorySlot(h)
        endif
        call SetItemVisible(w,true)
        call SetItemPosition(w,GetUnitX(h),GetUnitY(h))
        call UnitAddItem(h,w)
        call FlushChildHashtable(udg_ht,task)
        call DestroyTimer(t)
    else
        call SaveInteger(udg_ht,task,1,i - 1)
    endif
    set t = null
    set h = null
    set w = null
endfunction
function AI_UnitAddItem takes unit h,item w,boolean clear returns timer
    local timer t
    if h==null or w==null then
        set t = null
        return null
    endif
    if IsUnitAlive(h) then
        if clear then
            call AI_ClearInventorySlot(h)
        endif
        call UnitAddItem(h,w)
        return null
    endif
    set t = CreateTimer()
    call SetItemVisible(w,false)
    call SaveUnitHandle(udg_ht,GetHandleId(t),0,h)
    call SaveItemHandle(udg_ht,GetHandleId(t),1,w)
    call SaveBoolean(udg_ht,GetHandleId(t),0,clear)
    call SaveInteger(udg_ht,GetHandleId(t),1,800)
    call SaveTimerHandle(udg_ht,GetHandleId(t),99,t)
    call TimerStart(t,0.25,true,function TSU_UnitAddItem_Main)
    set bj_lastStartedTimer = t
    set t = null
    return bj_lastStartedTimer
endfunction

function AI_CountUnitsInGroup_Count takes nothing returns nothing
    set udg_AI_register[7] = udg_AI_register[7] + 1
endfunction
function AI_CountUnitsInGroup takes group g returns integer
    set udg_AI_register[7] = 0
    call ForGroup(g,function AI_CountUnitsInGroup_Count)
    return udg_AI_register[7]
endfunction

function AI_DataBaseWrite takes integer index,integer key,integer value returns nothing
    set udg_AI_DataBase[index*16+key] = value
endfunction
function AI_DataBaseRead takes integer index,integer key returns integer
    return udg_AI_DataBase[index*16+key]
endfunction

function AI_HeroSkill takes integer index,integer s1,integer s2,integer s3,integer s4,integer s5 returns nothing
    call AI_DataBaseWrite(index,1,s1)
    call AI_DataBaseWrite(index,2,s2)
    call AI_DataBaseWrite(index,3,s3)
    call AI_DataBaseWrite(index,4,s4)
    call AI_DataBaseWrite(index,5,s5)
endfunction

function AI_LearnSkill takes unit h returns nothing
    local integer index = GetHeroIndex(GetUnitTypeId(h))
    local integer i = GetHeroSkillPoints(h)
    if index == 0 then
        return
    endif
    loop
        exitwhen i==0
        call SelectHeroSkill(h,AI_DataBaseRead(index,1))
        call SelectHeroSkill(h,AI_DataBaseRead(index,2))
        call SelectHeroSkill(h,AI_DataBaseRead(index,3))
        call SelectHeroSkill(h,AI_DataBaseRead(index,4))
        call SelectHeroSkill(h,AI_DataBaseRead(index,5))
        set i = i - 1
    endloop
endfunction

function CountAIPlayerSum takes nothing returns integer
    set udg_AI_DataBase[0] = CountPlayersInForceBJ(udg_AI_Players)
    return udg_AI_DataBase[0]
endfunction
//===========================================================================
// Trigger: HC System
//
// 合成系统核心
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0

//Horadric Cube System

//==============================================================================

function HC_GetResourceA takes unit h returns integer
    return GetPlayerState(GetOwningPlayer(h),PLAYER_STATE_RESOURCE_GOLD)
endfunction

function HC_GetResourceB takes unit h returns integer
    return GetPlayerState(GetOwningPlayer(h),PLAYER_STATE_RESOURCE_LUMBER)
endfunction

function HC_SetResourceA takes unit h,integer value returns nothing
    call SetPlayerState(GetOwningPlayer(h),PLAYER_STATE_RESOURCE_GOLD,value)
endfunction

function HC_SetResourceB takes unit h,integer value returns nothing
    call SetPlayerState(GetOwningPlayer(h),PLAYER_STATE_RESOURCE_LUMBER,value)
endfunction

//==============================================================================

function HC_DataBaseRead takes integer DB,integer SN,integer offset returns integer
    return udg_HC_Database_01[SN*20 + offset]
endfunction

function HC_DataBaseWrite takes integer DB,integer SN,integer offset,integer value returns nothing
    set udg_HC_Database_01[SN*20 + offset] = value
endfunction

function HC_GetCapSN takes nothing returns integer
    return udg_HC_Database_01[2000]
endfunction

function HC_SetCapSN takes integer m returns nothing
    set udg_HC_Database_01[2000] = m
endfunction

function HC_IsValidSN takes integer SN returns boolean
    return (SN >= 0) and (SN < HC_GetCapSN())
endfunction

function HC_GetCurrentGlobalSN takes nothing returns integer
    return udg_HC_Database_01[2000] + 1000
endfunction

function HC_ConvertGlobalSN takes integer GlobalSN returns integer
    return GlobalSN - 1000
endfunction

function HC_FlushRegisters takes nothing returns nothing
    local integer i
    set i = 0
    loop
        set udg_HC_register[i] = 0
        set i = i + 1
        exitwhen i>=32
    endloop
endfunction

//==============================================================================

function HC_Formula_Begin takes integer GlobalSN,integer ID,integer Product returns nothing
    local integer SN = HC_ConvertGlobalSN(GlobalSN)
    set udg_HC_register[12] = SN  //00.System Serial Number
    set udg_HC_register[13] = ID  //01.Formula ID
    set udg_HC_register[14] = 1   //02.Auto Activate
    set udg_HC_register[15] = 1   //03.Check All Player Units (NYI)
    set udg_HC_register[16] = Product
    set udg_HC_register[17] = 1   //05.Allow Recursive Activate
    set udg_HC_register[18] = 0   //06.Resource Cost A
    set udg_HC_register[19] = 0   //07.Resource Cost B
    set udg_HC_register[20] = 0   //08.Material Item 01
    set udg_HC_register[21] = 0   //09.Material Item 01 Quantity
    set udg_HC_register[22] = 0   //10.Material Item 02
    set udg_HC_register[23] = 0   //11.Material Item 02 Quantity
    set udg_HC_register[24] = 0   //...
    set udg_HC_register[25] = 0   //...
    set udg_HC_register[26] = 0   //...
    set udg_HC_register[27] = 0   //...
    set udg_HC_register[28] = 0   //...
    set udg_HC_register[29] = 0   //...
    set udg_HC_register[30] = 0   //18.Material Item 06
    set udg_HC_register[31] = 0   //19.Material Item 06 Quantity
endfunction

function HC_Formula_Config takes boolean CheckAllUnits,boolean AutoActivate,boolean AllowRecursive returns nothing
    set udg_HC_register[14] = Integer(AutoActivate)
    set udg_HC_register[15] = Integer(CheckAllUnits)
    set udg_HC_register[17] = Integer(AllowRecursive)
endfunction

function HC_Formula_SetResourceAB takes integer value1,integer value2 returns nothing
    set udg_HC_register[18] = value1
    set udg_HC_register[19] = value2
endfunction

function HC_Formula_SetMaterialA takes integer t1,integer n1,integer t2,integer n2,integer t3,integer n3 returns nothing
    set udg_HC_register[20] = t1
    set udg_HC_register[21] = n1
    set udg_HC_register[22] = t2
    set udg_HC_register[23] = n2
    set udg_HC_register[24] = t3
    set udg_HC_register[25] = n3
endfunction

function HC_Formula_SetMaterialB takes integer t4,integer n4,integer t5,integer n5,integer t6,integer n6 returns nothing
    set udg_HC_register[26] = t4
    set udg_HC_register[27] = n4
    set udg_HC_register[28] = t5
    set udg_HC_register[29] = n5
    set udg_HC_register[30] = t6
    set udg_HC_register[31] = n6
endfunction

function HC_Formula_End takes nothing returns nothing
    local integer SN = udg_HC_register[12]
    local integer ID = udg_HC_register[13]
    local integer i
    local integer j
    local integer c
    local integer n
    if SN<0 or SN>=100 then
        call HC_FlushRegisters()
        return
    endif
    set i = 0
    loop
        call HC_DataBaseWrite(0,SN,i,udg_HC_register[12+i])
        set i = i + 1
        exitwhen i>=8
    endloop
    set i = 0
    set j = 0
    loop
        set c = udg_HC_register[20 + 2*i    ]
        set n = udg_HC_register[20 + 2*i + 1]
        if c!=0 then
            call HC_DataBaseWrite(0,SN,8 + 2*j    ,c)
            call HC_DataBaseWrite(0,SN,8 + 2*j + 1,n)
            set j = j + 1
        endif
        set i = i + 1
        exitwhen i>=6
    endloop
    set SN = IMaxBJ(HC_GetCapSN(),SN+1)
    call HC_SetCapSN(SN)
    return
endfunction

function HC_SearchFormulaID takes integer TargetID returns integer
    local integer DB = 0
    local integer SN
    local integer ID
    local integer m = HC_GetCapSN()
    set SN = 0
    loop
        exitwhen SN >= m
        set ID = HC_DataBaseRead(DB,SN,1)
        if ID==TargetID then
            return SN
        endif
        set SN = SN + 1
    endloop
    return -1
endfunction

//==============================================================================

function HC_CheckPossibilty takes integer SN,integer ItemTypeID returns boolean
    local integer c
    local integer i = 8
    loop
        set c = HC_DataBaseRead(0,SN,i)
        exitwhen c==0
        if c==ItemTypeID then
            return true
        endif
        set i = i + 2
        exitwhen i>=20
    endloop
    return false
endfunction

function HC_PopFormula takes integer SN returns boolean
    local integer i
    
    set i = 0
    loop
        set udg_HC_register[i] = 0
        set i = i + 1
        exitwhen i>=12
    endloop
    
    set i = 0
    loop
        set udg_HC_register[12+i] = HC_DataBaseRead(0,SN,i)
        set i = i + 1
        exitwhen i>=20
    endloop
    
    return true
endfunction

function HC_PopFormulaByGlobalSN takes integer GlobalSN returns boolean
    local integer SN = HC_ConvertGlobalSN(GlobalSN)
    return HC_PopFormula(SN)
endfunction

function HC_GetItemQuantity takes item w returns integer
    local integer n
    if w==null then
        return 0
    endif
    set n = GetItemCharges(w)
    if n==0 then
        return 1
    endif
    return n
endfunction

function HC_LocateMaterial takes unit h,integer c returns integer
    local integer i
    local item w
    set i = 0
    loop
        set w = UnitItemInSlot(h,i)
        if (w!=null) and (GetItemTypeId(w) == c) then
            if udg_HC_register[i*2]==0 then
                set w = null
                return i
            endif
        endif
        set i = i + 1
        exitwhen i >= bj_MAX_INVENTORY
    endloop
    set w = null
    return -1
endfunction

function HC_CheckMaterials takes unit h returns boolean
    local integer slot
    local integer c
    local integer n
    local integer m
    local integer i
    local integer CostA = udg_HC_register[18]
    local integer CostB = udg_HC_register[19]
    local boolean CheckAllUnits = Boolean(udg_HC_register[15])
    
    if HC_GetResourceA(h)<CostA then
        return false
    endif
    if HC_GetResourceB(h)<CostB then
        return false
    endif
    
    set i = 0
    loop
        set c = udg_HC_register[20 + 2*i]
        set n = udg_HC_register[20 + 2*i + 1]
        exitwhen c==0
        set slot = HC_LocateMaterial(h,c)
        if slot < 0 then
            return false
        endif
        set udg_HC_register[slot*2] = c
        set udg_HC_register[slot*2+1] = 0
        if n>0 then
            set m = HC_GetItemQuantity(UnitItemInSlot(h,slot))
            if m<n then
                return false
            endif
            set udg_HC_register[slot*2+1] = n
        elseif n<0 then
            set udg_HC_register[slot*2+1] = HC_GetItemQuantity(UnitItemInSlot(h,slot))
        endif
        set i = i + 1
        exitwhen i >= 6
    endloop
    
    return true
endfunction

function HC_ActivateFormula takes unit h returns boolean
    local integer c
    local integer n
    local integer i
    local integer slot
    local item w
    local integer d = udg_HC_register[16]
    local integer CostA = udg_HC_register[18]
    local integer CostB = udg_HC_register[19]
    local boolean AutoActivate = Boolean(udg_HC_register[14])
    local boolean AllowRecursive = Boolean(udg_HC_register[17])
    
    if CostA>0 then
        call HC_SetResourceA(h,HC_GetResourceA(h) - CostA)
    endif
    if CostB>0 then
        call HC_SetResourceB(h,HC_GetResourceB(h) - CostB)
    endif
    
    set i = 0
    loop
        set c = udg_HC_register[i*2]
        if c!=0 then
            set n = udg_HC_register[i*2 + 1]
            set w = UnitItemInSlot(h,i)
            if w!=null and n>0 then
                call CostItem(w,n)
            endif
        endif
        set i = i + 1
        exitwhen i >= 6
    endloop
    
    if AllowRecursive then
        set udg_HC_Lock = false
    endif
    
    set w = CreateItem(d,GetUnitX(h),GetUnitY(h))
    call UnitAddItem(h,w)
    
    if not AllowRecursive then
        set udg_HC_Lock = false
    endif
    
    set w = null
    return true
endfunction

//==============================================================================

function HCxGUIxFormulaBegin takes integer GlobalSN,integer ID,integer Product returns nothing
    call HC_Formula_Begin(GlobalSN,ID,Product)
endfunction

function HCxGUIxFormulaSetResourceAB takes integer A,integer B returns nothing
    call HC_Formula_SetResourceAB(A,B)
endfunction

function HCxGUIxFormulaSetMaterialA takes integer t1,integer n1,integer t2,integer n2,integer t3,integer n3 returns nothing
    call HC_Formula_SetMaterialA(t1,n1,t2,n2,t3,n3)
endfunction

function HCxGUIxFormulaSetMaterialB takes integer t4,integer n4,integer t5,integer n5,integer t6,integer n6 returns nothing
    call HC_Formula_SetMaterialB(t4,n4,t5,n5,t6,n6)
endfunction

function HCxGUIxFormulaEnd takes nothing returns nothing
    call HC_Formula_End()
endfunction

//==============================================================================

function InitTrig_HC_System takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Setting Balance
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏设定--资源及复活时间
//===========================================================================
function Trig_Setting_Balance_Actions takes nothing returns nothing
    // 复活时间 ＝ ReviveTime[0] + 等级×ReviveTime[1]
    set udg_ReviveTime[0] = 1.00
    set udg_ReviveTime[1] = 4.00
    // GameSetting_Gold[0]是初始钱，GameSetting_Gold[1]是工资
    set udg_GameSetting_Gold[0] = 800
    set udg_GameSetting_Gold[1] = 1
    // GameSetting_Spirit[0]是初始信仰，GameSetting_Spirit[1]是推塔的信仰
    // GameSetting_Spirit[2]是杀死英雄信仰，GameSetting_Spirit[3]是信仰工资
    set udg_GameSetting_Spirit[0] = 0
    set udg_GameSetting_Spirit[1] = 10
    set udg_GameSetting_Spirit[2] = 5
    set udg_GameSetting_Spirit[3] = 1
    // GameSetting_Power
    set udg_GameSetting_Power[0] = 0
endfunction

//===========================================================================
function InitTrig_Setting_Balance takes nothing returns nothing
    set gg_trg_Setting_Balance = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Setting_Balance, function Trig_Setting_Balance_Actions )
endfunction

//===========================================================================
// Trigger: Setting Character A
//
// 游戏设定--博丽神社英雄设定
// AI学习技能设定通魔技能建议排最后
// 多重攻击的技能，要填魔法书的编号，技能本体（分裂、弹幕等）的编号必须是 = ( 其魔法书编号 - 1 )
//===========================================================================
function Trig_Setting_Character_A_Actions takes nothing returns nothing
    local integer i = 0
    local hashtable db = udg_HeroDatabase
    // ========================
    // 博丽神社
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H001'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_reimu.blp"
    set udg_HeroButton[ (i)] = 'B01I'
    set udg_HeroBrief[ (i)] = "TRIGSTR_4926"
    call AI_HeroSkill(i,'A049','A048','A04B','A03Y','A04A')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0JV')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Reimu
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H000'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_marisa.blp"
    set udg_HeroButton[ (i)] = 'B01V'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9448"
    call AI_HeroSkill(i,'A042','A041','A03Z','A03Y','A040')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0JT')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Marisa
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H00L'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_suika.blp"
    set udg_HeroButton[ (i)] = 'B00Y'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9450"
    call AI_HeroSkill(i,'A05W','A05V','A02I','A03Y','A05R')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    // 变身单位数据库补充定义
    call DB_SetHeroTypeData('H00Q',DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData('H00Q',DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Suika
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E00F'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_yukari.blp"
    set udg_HeroButton[ (i)] = 'B01M'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9451"
    call AI_HeroSkill(i,'A04J','A04L','A04N','A03Y','A04M')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0JX')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Yukari
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E00G'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Ran.blp"
    set udg_HeroButton[ (i)] = 'B01N'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9452"
    call AI_HeroSkill(i,'A0EG','A0EF','A0EH','A03Y','A0EE')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0JZ')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Ran
    // =========================
    set i=i+1
    set udg_HeroType[ (i)] = 'O00J'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Remilia.blp"
    set udg_HeroButton[ (i)] = 'B01O'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9453"
    call AI_HeroSkill(i,'A0CI','A0CD','A0CH','A0CG','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K5')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Remilia
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E000'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_sakuya.blp"
    set udg_HeroButton[ (i)] = 'B00F'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9454"
    call AI_HeroSkill(i,'A09C','A04H','A099','A03Y','A09A')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K9')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Sakuya
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'U007'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Flandre.blp"
    set udg_HeroButton[ (i)] = 'B00U'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9455"
    call AI_HeroSkill(i,'A06J','A06L','A06K','A03Y','A06M')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Flandre
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'U00N'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNpatchouli.blp"
    set udg_HeroButton[ (i)] = 'B014'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9456"
    call AI_HeroSkill(i,'A0FV','A0FZ','A0FY','A03Y','A0FX')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0KF')
    set udg_HeroInit[ (i)] = gg_trg_Init_Pachouli
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E013'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNmeirin.blp"
    set udg_HeroButton[ (i)] = 'B011'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9457"
    call AI_HeroSkill(i,0,0,0,0,'A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Init_Meirin
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E01E'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Koakuma.blp"
    set udg_HeroButton[ (i)] = 'B02K'
    set udg_HeroBrief[ (i)] = "TRIGSTR_6633"
    call AI_HeroSkill(i,'A0MT','A0NH','A0NI','A0NJ','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0NN')
    set udg_HeroInit[ (i)] = gg_trg_Init_Koakuma
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'U006'
    set udg_HeroButton[ (i)] = 'B00Z'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9458"
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_yuyuko.blp"
    call AI_HeroSkill(i,'A05D','A05B','A05E','A03Y','A05C')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K7')
    set udg_HeroInit[ (i)] = gg_trg_Init_Yuyuko
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'O00B'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_youmu.blp"
    set udg_HeroButton[ (i)] = 'B016'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9459"
    call AI_HeroSkill(i,'A05Y','A064','A065','A03Y','A05X')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Youmu
    set i=i+1
    set udg_HeroType[ (i)] = 'E01W'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNMerlin.blp"
    set udg_HeroButton[ (i)] = 'B02R'
    set udg_HeroBrief[ (i)] = "TRIGSTR_4252"
    call AI_HeroSkill(i,'A0O3','A0RS','A0RX','A03Y','A0RZ')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0S6')
    set udg_HeroInit[ (i)] = gg_trg_Init_Merlin
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'O009'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNutsuho.blp"
    set udg_HeroButton[ (i)] = 'B01L'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9460"
    call AI_HeroSkill(i,'A074','A079','A03Y','A076','A07B')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0KJ')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Utsuho
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E00W'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Rin.blp"
    set udg_HeroButton[ (i)] = 'B01J'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9461"
    call AI_HeroSkill(i,'A0BO','A0BH','A0BM','A03Y','A0BP')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Cat
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'O008'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Spider.blp"
    set udg_HeroButton[ (i)] = 'B01W'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9462"
    call AI_HeroSkill(i,'A08F','A08I','A08J','A08E','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Spider
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E01V'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Kisume.blp"
    set udg_HeroButton[ (i)] = 'B02P'
    set udg_HeroBrief[ (i)] = "TRIGSTR_4384"
    call AI_HeroSkill(i,'A0R8','A0R9','A0RA','A0RB','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initialing_Kisume
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'N00J'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_mokou.blp"
    set udg_HeroButton[ (i)] = 'B017'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9463"
    call AI_HeroSkill(i,'A059','A04W','A052','A03Y','A04U')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Mokou
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E01A'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Keine.blp"
    set udg_HeroButton[ (i)] = 'B02G'
    set udg_HeroBrief[ (i)] = "TRIGSTR_5169"
    call AI_HeroSkill(i,'A0M8','A0M9','A0MA','A0MB','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    // 变身单位数据库补充定义
    call DB_SetHeroTypeData('E01B',DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData('E01B',DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Keine
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'N00K'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_medi.blp"
    set udg_HeroButton[ (i)] = 'B01G'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9464"
    call AI_HeroSkill(i,'A07W','A07Y','A07V','A03Y',0)
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0KH')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Medi
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H01A'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNalice.blp"
    set udg_HeroButton[ (i)] = 'B00M'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9465"
    call AI_HeroSkill(i,'A0GY','A0GV','A0GW','A0GX','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0KR')
    set udg_HeroInit[ (i)] = gg_trg_Init_Alice
    // ========================
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H00K'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Yuugi.blp"
    set udg_HeroButton[ (i)] = 'B012'
    set udg_HeroBrief[ (i)] = "TRIGSTR_5106"
    call AI_HeroSkill(i,'A08D','A08B','A08A','A08C','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Yuugi
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'U00J'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_komachi.blp"
    set udg_HeroButton[ (i)] = 'B019'
    set udg_HeroBrief[ (i)] = "TRIGSTR_5170"
    call AI_HeroSkill(i,'A0CJ','A0CL','A0CM','A03Y','A0CK')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0RU')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Komachi
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E00V'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNshikieiki.blp"
    set udg_HeroButton[ (i)] = 'B013'
    set udg_HeroBrief[ (i)] = "TRIGSTR_4985"
    call AI_HeroSkill(i,'A0B7','A0B9','A03Y','A0BF',0)//'A0BA'
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0KZ')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Shikieiki
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E015'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNsatori.blp"
    set udg_HeroButton[ (i)] = 'B022'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9466"
    call AI_HeroSkill(i,'A0IZ','A0IW','A0IY','A0IX','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0L1')
    set udg_HeroInit[ (i)] = gg_trg_Init_Satori
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E010'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNkoishi.blp"
    set udg_HeroButton[ (i)] = 'B01C'
    set udg_HeroBrief[ (i)] = "TRIGSTR_9467"
    call AI_HeroSkill(i,'A0DR','A0DQ','A0MI','A0DY','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0KD')
    // 变身单位数据库补充定义
    call DB_SetHeroTypeData('E011',DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData('E011',DB_HERO_MULTIPLE_ATTACK(),'A0KD')
    set udg_HeroInit[ (i)] = gg_trg_Init_Koishi
    // ========================
    set udg_HeroType[0] = i
    set db = null
endfunction

//===========================================================================
function InitTrig_Setting_Character_A takes nothing returns nothing
    set gg_trg_Setting_Character_A = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Setting_Character_A, function Trig_Setting_Character_A_Actions )
endfunction

//===========================================================================
// Trigger: Setting Character B
//
// 游戏设定--守失神社英雄设定
//===========================================================================
function Trig_Setting_Character_B_Actions takes nothing returns nothing
    local integer i = 100
    local hashtable db = udg_HeroDatabase
    // ========================
    // 守矢神社
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H009'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_sanae.blp"
    set udg_HeroButton[ (i)] = 'B01E'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2038"
    call AI_HeroSkill(i,'A06U','A06V','A06W','A03Y','A06Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K3')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Sanae
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'U00L'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNkanako.blp"
    set udg_HeroButton[ (i)] = 'B01K'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2044"
    call AI_HeroSkill(i,'A0F6','A0F1','A0F4','A03Y',0)
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0LB')
    // 变身单位数据库补充定义
    call DB_SetHeroTypeData('U00M',DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData('U00M',DB_HERO_MULTIPLE_ATTACK(),'A0LB')
    set udg_HeroInit[ (i)] = gg_trg_Init_Kanako
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H012'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNsuwako.blp"
    set udg_HeroButton[ (i)] = 'B01U'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2074"
    call AI_HeroSkill(i,'A0FI','A0FJ','A0FK','A03Y',0)
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Init_Suwako
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H002'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_tensi.blp"
    set udg_HeroButton[ (i)] = 'B015'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2105"
    call AI_HeroSkill(i,'A0AJ','A070','A071','A073','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Init_Tensi
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'U003'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_iku.blp"
    set udg_HeroButton[ (i)] = 'B00H'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2234"
    call AI_HeroSkill(i,'A04S','A05M','A04O','A03Y','A0A4')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0KL')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Iku
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E008'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_aya.blp"
    set udg_HeroButton[ (i)] = 'B01D'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2237"
    call AI_HeroSkill(i,'A05P','A05L','A05S','A03Y','A05K')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Aya
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'O00V'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNHatate.blp"
    set udg_HeroButton[ (i)] = 'B02Q'
    set udg_HeroBrief[ (i)] = "TRIGSTR_1982"
    call AI_HeroSkill(i,'A08N','A0D9','A09B','A0E6','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A08M')
    set udg_HeroInit[ (i)] = gg_trg_Initialing_Hatate
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'O00A'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_momizi.blp"
    set udg_HeroButton[ (i)] = 'B00V'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2263"
    call AI_HeroSkill(i,'A09W','A09U','A09V','A09T','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Init_Momizi
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H00M'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Nitori.blp"
    set udg_HeroButton[ (i)] = 'B01H'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2355"
    call AI_HeroSkill(i,'A094','A095','A03Y','A0GF','A0LK')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    // 变身单位数据库补充定义
    call DB_SetHeroTypeData('H00S',DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData('H00S',DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Nitori
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H00X'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNHina.blp"
    set udg_HeroButton[ (i)] = 'B01S'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2392"
    call AI_HeroSkill(i,'A0E9','A0E4','A0DZ','A03Y','A0E8')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0KX')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Hina
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'N00L'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_yuka.blp"
    set udg_HeroButton[ (i)] = 'B01B'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2410"
    call AI_HeroSkill(i,'A06I','A068','A07Q','A0DA','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Yuka
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E009'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Cirno.blp"
    set udg_HeroButton[ (i)] = 'B00J'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2428"
    call AI_HeroSkill(i,'A06E','A06G','A06H','A03Y','A0MV')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Cirno
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E00I'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Rumia.blp"
    set udg_HeroButton[ (i)] = 'B01T'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2431"
    call AI_HeroSkill(i,'A07C','A07E','A07G','A03Y','A07J')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    // 变身单位数据库补充定义
    call DB_SetHeroTypeData('E00J',DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData('E00J',DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Rumia
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E00A'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Wriggle.blp"
    set udg_HeroButton[ (i)] = 'B010'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2569"
    call AI_HeroSkill(i,'A09R','A09K','A03Y','A09N','A09M')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0KT')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Wriggle
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E00Z'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Mystia.blp"
    set udg_HeroButton[ (i)] = 'B00W'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2570"
    call AI_HeroSkill(i,'A0DE','A0DI','A0DH','A0DN','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    // 变身单位数据库补充定义
    call DB_SetHeroTypeData('E01T',DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData('E01T',DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Init_Mystia
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H00N'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_letty.blp"
    set udg_HeroButton[ (i)] = 'B01P'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2644"
    call AI_HeroSkill(i,'A08W','A092','A08Q','A08P','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0KV')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Letty
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'O006'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNeirin.blp"
    set udg_HeroButton[ (i)] = 'B00Q'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2648"
    call AI_HeroSkill(i,'A088','A083','A082','A03Y','A086')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0KN')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Eirin
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H00W'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNkaguya.blp"
    set udg_HeroButton[ (i)] = 'B01Q'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2807"
    call AI_HeroSkill(i,'A0D0','A0SP','A0D2','A0SQ','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0KP')
    set udg_HeroInit[ (i)] = gg_trg_Init_Kaguya
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'O007'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_reisen.blp"
    set udg_HeroButton[ (i)] = 'B00X'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2845"
    call AI_HeroSkill(i,'A069','A0GT','A066','A06D','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0JR')
    set udg_HeroInit[ (i)] = gg_trg_Init_Reisen
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'O00N'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Twei.blp"
    set udg_HeroButton[ (i)] = 'B02I'
    set udg_HeroBrief[ (i)] = "TRIGSTR_3032"
    call AI_HeroSkill(i,'A0N2','A0N3','A0N5','A0N4','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0N6')
    set udg_HeroInit[ (i)] = gg_trg_Init_Twei
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H01H'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Shizuha.blp"
    set udg_HeroButton[ (i)] = 'B023'
    set udg_HeroBrief[ (i)] = "TRIGSTR_3241"
    call AI_HeroSkill(i,'A0J6','A0J7','A0JC','A0J8','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0L3')
    set udg_HeroInit[ (i)] = gg_trg_Init_Shizuha
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H01I'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNminoriko.blp"
    set udg_HeroButton[ (i)] = 'B024'
    set udg_HeroBrief[ (i)] = "TRIGSTR_3264"
    call AI_HeroSkill(i,'A0JJ','A0JI','A0JF','A0JK','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0L5')
    set udg_HeroInit[ (i)] = gg_trg_Init_Minoriko
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'U00K'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTNnazrin.blp"
    set udg_HeroButton[ (i)] = 'B01R'
    set udg_HeroBrief[ (i)] = "TRIGSTR_3271"
    call AI_HeroSkill(i,'A0D7','A0D8','A03Y','A0ED','A0D4')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    // 变身单位数据库补充定义
    call DB_SetHeroTypeData('U00R',DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData('U00R',DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Init_Nazrin
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E00X'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Umbrella.blp"
    set udg_HeroButton[ (i)] = 'B018'
    set udg_HeroBrief[ (i)] = "TRIGSTR_3290"
    call AI_HeroSkill(i,'A0C7','A0LS','A0C3','A0C8','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Umbrella
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'E00Q'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Captain.blp"
    set udg_HeroButton[ (i)] = 'B01F'
    set udg_HeroBrief[ (i)] = "TRIGSTR_3291"
    call AI_HeroSkill(i,'A0AA','A0A6','A03Y','A0AB','A0AC')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Captain
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H01N'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Toramaru.blp"
    set udg_HeroButton[ (i)] = 'B02N'
    set udg_HeroBrief[ (i)] = "TRIGSTR_2153"
    call AI_HeroSkill(i,'A0P2','A0P1','A0P3','A0P4','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_STR())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Toramaru
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H01K'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_byakuren.blp"
    set udg_HeroButton[ (i)] = 'B02H'
    set udg_HeroBrief[ (i)] = "TRIGSTR_3292"
    call AI_HeroSkill(i,'A0NZ','A0O0','A0O1','A0O2','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_INT())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Byakuren
    // ========================
    set i=i+1
    set udg_HeroType[ (i)] = 'H01J'
    set udg_HeroIcon[ (i)] = "ReplaceableTextures\\CommandButtons\\BTN_Houjuu Nue.blp"
    set udg_HeroButton[ (i)] = 'B02F'
    set udg_HeroBrief[ (i)] = "TRIGSTR_3389"
    call AI_HeroSkill(i,'A0M1','A0M2','A0M3','A0M4','A03Y')
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_PRIMARY_TYPE(),DB_ENUM_AGI())
    call DB_SetHeroTypeData(udg_HeroType[i],DB_HERO_MULTIPLE_ATTACK(),'A0K1')
    set udg_HeroInit[ (i)] = gg_trg_Initial_Nue
    // ========================
    set udg_HeroType[100] = i - 100
    set db = null
endfunction

//===========================================================================
function InitTrig_Setting_Character_B takes nothing returns nothing
    set gg_trg_Setting_Character_B = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Setting_Character_B, function Trig_Setting_Character_B_Actions )
endfunction

//===========================================================================
// Trigger: Setting Item System Table 1
//
// 注意：
// 1、不可并行运行。要分成两个触发，先一后二来执行。
// 2、“--开始:”里面的第二个数目前无用，随便设。
//===========================================================================
function Trig_Setting_Item_System_Table_1_Actions takes nothing returns nothing
    local integer i = HC_GetCurrentGlobalSN()
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I02Z' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I01I', 1, 'I01G', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I033' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02Z', -1, 0, 0, 0, 0 )
    call HCxGUIxFormulaSetMaterialB( 'I01E', 1, 'I01E', 1, 'I01E', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I03G' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I033', -1, 0, 0, 0, 0 )
    call HCxGUIxFormulaSetMaterialB( 'I01E', 1, 'I01E', 1, 'I01E', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I00H' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I01S', 1, 'I012', 1, 'I03U', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I00D' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I03G', -1, 'I00H', 1, 'I03O', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I036' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I017', 1, 'I017', 1, 'I03X', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I00C' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I011', 1, 'I014', 1, 'I014', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I00B' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I049', 1, 'I049', 1, 'I021', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I02V' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I012', 1, 'I01N', 1, 'I01T', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I04C' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I03W', 1, 'I01P', 1, 'I01P', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I00G' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I03Y', 1, 'I01P', 1, 'I01Q', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I030' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I01D', 1, 'I01G', 1, 'I015', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I00M' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02A', 1, 'I01C', 1, 'I01R', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I04L' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I04M', 1, 'I01N', 1, 'I01N', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I01E', 1, 'I01E', 1, 'I01O', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I04L' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I04M', 1, 'I04L', -1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I00S' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I020', 1, 'I010', 1, 'I01P', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I00T' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I023', 1, 'I01L', 1, 'I01P', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 1, 'I00R' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I01Z', 1, 'I01R', 1, 'I01P', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I04Y' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I03J', 1, 'I04X', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I04X' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I03J', 1, 'I04W', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I04W' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I03J', 1, 'I04V', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I04V' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I03J', 1, 'I04U', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I04U' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I03J', 1, 'I00Z', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call TriggerExecute( gg_trg_Setting_Item_System_Table_2 )
endfunction

//===========================================================================
function InitTrig_Setting_Item_System_Table_1 takes nothing returns nothing
    set gg_trg_Setting_Item_System_Table_1 = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Setting_Item_System_Table_1, function Trig_Setting_Item_System_Table_1_Actions )
endfunction

//===========================================================================
// Trigger: Setting Item System Table 2
//===========================================================================
function Trig_Setting_Item_System_Table_2_Actions takes nothing returns nothing
    local integer i = HC_GetCurrentGlobalSN()
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I007' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I01D', 1, 'I01N', 1, 'I01M', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I034' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I03V', 1, 'I007', 1, 'I01D', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I00Q' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02F', 1, 'I01V', 1, 'I019', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I008' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I03Q', 1, 'I01A', 1, 'I00Q', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I00L' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I029', 1, 'I036', 1, 'I01B', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I011', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I037' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I036', 1, 'I01U', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I00K' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I00J', 1, 'I00J', 1, 'I00J', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I04Q' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I04C', 1, 'I00Q', 1, 'I04R', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I04B' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I01O', 1, 'I018', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I02W' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I04B', 1, 'I00X', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I02Y' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I01X', 1, 'I01J', 1, 'I01L', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I01K', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I00P' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I00Y', 1, 'I049', -1, 'I02D', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I01S', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I04O' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I04P', 1, 'I01B', 1, 'I014', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I047' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02E', 1, 'I046', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I046' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02E', 1, 'I045', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I045' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02E', 1, 'I044', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I044' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02E', 1, 'I043', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I043' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02E', 1, 'I00Z', 1, 'I01V', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 2, 'I04F' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I04E', 1, 'I01K', 1, 'I01F', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call TriggerExecute( gg_trg_Setting_Item_System_Table_3 )
endfunction

//===========================================================================
function InitTrig_Setting_Item_System_Table_2 takes nothing returns nothing
    set gg_trg_Setting_Item_System_Table_2 = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Setting_Item_System_Table_2, function Trig_Setting_Item_System_Table_2_Actions )
endfunction

//===========================================================================
// Trigger: Setting Neutrals
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏设定--野怪设定
//===========================================================================
function Trig_Setting_Neutrals_Actions takes nothing returns nothing
    // 野怪刷新时间
    set udg_NeutralFirstCreateTime = 30
    set udg_NeutralCreatePeriod = 120
    // 野怪类型
    set udg_NeutralTypes[1] = 'e001'
    set udg_NeutralTypes[2] = 'e007'
    set udg_NeutralTypes[3] = 'e006'
    set udg_NeutralTypes[4] = 'e002'
    set udg_NeutralTypes[5] = 'e003'
    set udg_NeutralTypes[6] = 'e004'
    set udg_NeutralTypes[7] = 'h007'
    set udg_NeutralTypes[8] = 'h003'
    set udg_NeutralTypes[9] = 'h005'
    set udg_NeutralTypes[10] = 'h006'
    set udg_NeutralTypes[11] = 'h004'
    set udg_NeutralTypes[12] = 'h008'
    set udg_NeutralTypes[13] = 'o001'
    set udg_NeutralTypes[14] = 'o003'
    set udg_NeutralTypes[15] = 'o002'
    set udg_NeutralTypes[16] = 'e005'
    set udg_NeutralTypes[17] = 'o004'
    set udg_NeutralTypes[18] = 'o00K'
    set udg_NeutralTypes[19] = 'u002'
    set udg_NeutralTypes[20] = 'u000'
    set udg_NeutralTypes[21] = 'u001'
    set udg_NeutralTypes[22] = 'n006'
    set udg_NeutralTypes[23] = 'n007'
    set udg_NeutralTypes[24] = 'n005'
    // 野怪组别
    set udg_NeutralGroups[1] = "8,11,20"
    set udg_NeutralGroups[2] = "24,1,21"
    set udg_NeutralGroups[3] = "18,13"
    set udg_NeutralGroups[4] = "4,5,5,6"
    set udg_NeutralGroups[5] = "22"
    set udg_NeutralGroups[6] = "23"
    set udg_NeutralGroups[7] = "9,10,10"
    set udg_NeutralGroups[8] = "7,12"
    set udg_NeutralGroups[9] = "16,19"
    set udg_NeutralGroups[10] = "3,2,2"
    set udg_NeutralGroups[11] = "14,17"
    // 野怪刷新点
    set udg_NeutralCampsCount = 8
    set udg_NeutralCamps[1] = gg_rct_Creeps00a
    set udg_NeutralCamps[2] = gg_rct_Creeps01a
    set udg_NeutralCamps[3] = gg_rct_Creeps02b
    set udg_NeutralCamps[4] = gg_rct_Creeps03b
    set udg_NeutralCamps[5] = gg_rct_Creeps04b
    set udg_NeutralCamps[6] = gg_rct_Creeps05b
    set udg_NeutralCamps[7] = gg_rct_Creeps06b
    set udg_NeutralCamps[8] = gg_rct_Creeps07b
    // 每个刷新点刷新哪几个组别
    set udg_NeutralCampTypes[1] = "1,2,3,4,5"
    set udg_NeutralCampTypes[2] = "1,2,3,4,5"
    set udg_NeutralCampTypes[3] = "6,7,8,9,10,11"
    set udg_NeutralCampTypes[4] = "6,7,8,9,10,11"
    set udg_NeutralCampTypes[5] = "6,7,8,9,10,11"
    set udg_NeutralCampTypes[6] = "6,7,8,9,10,11"
    set udg_NeutralCampTypes[7] = "6,7,8,9,10,11"
    set udg_NeutralCampTypes[8] = "6,7,8,9,10,11"
endfunction

//===========================================================================
function InitTrig_Setting_Neutrals takes nothing returns nothing
    set gg_trg_Setting_Neutrals = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Setting_Neutrals, function Trig_Setting_Neutrals_Actions )
endfunction

//===========================================================================
// Trigger: Setting Spawn
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏设定--刷兵设定
//===========================================================================
function Trig_Setting_Spawn_Actions takes nothing returns nothing
    // 博丽神社
    // ========================
    set udg_SU_ID_A[0] = 'h00E'
    set udg_SU_No_A[0] = 4
    set udg_SU_ID_A[1] = 'e00B'
    set udg_SU_No_A[1] = 1
    set udg_SU_ID_A[2] = 'e016'
    set udg_SU_No_A[2] = 0
    // --------
    set udg_SUA_ID_A[0] = 'h00G'
    set udg_SUA_ID_A[1] = 'e00D'
    set udg_SUA_ID_A[2] = 'u005'
    //  
    //  
    //  
    // 守矢神社
    // ========================
    set udg_SU_ID_B[0] = 'h00F'
    set udg_SU_No_B[0] = 4
    set udg_SU_ID_B[1] = 'e00C'
    set udg_SU_No_B[1] = 1
    set udg_SU_ID_B[2] = 'e016'
    set udg_SU_No_B[2] = 0
    // --------
    set udg_SUA_ID_B[0] = 'h00H'
    set udg_SUA_ID_B[1] = 'e00E'
    set udg_SUA_ID_B[2] = 'u005'
    //  
    //  
    //  
endfunction

//===========================================================================
function InitTrig_Setting_Spawn takes nothing returns nothing
    set gg_trg_Setting_Spawn = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Setting_Spawn, function Trig_Setting_Spawn_Actions )
endfunction

//===========================================================================
// Trigger: Setting Item System Table 3
//
// |cffff3300其它材料：|r
// |cffffcc00属性：|r
// |cff00ff33特殊效果：|r
// |cff00ccff使用效果：|r
//===========================================================================
function Trig_Setting_Item_System_Table_3_Actions takes nothing returns nothing
    local integer i = HC_GetCurrentGlobalSN()
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I039' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02H', 1, 'I01W', 1, 'I017', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I03A' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02I', 1, 'I01W', 1, 'I017', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I03B' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02J', 1, 'I01W', 1, 'I017', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I031' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I039', 1, 'I02I', 1, 'I02J', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I03S', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I031' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02H', 1, 'I03A', 1, 'I02J', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I03S', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I031' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02H', 1, 'I02I', 1, 'I03B', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I03S', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I00I' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02K', 1, 'I01H', 1, 'I01F', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I00N' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I03T', 1, 'I01W', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I009' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I017', 1, 'I03N', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I00A' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I01W', 1, 'I02M', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I00E' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I02G', 1, 'I014', 1, 'I00H', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I00J' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I01G', 1, 'I011', 1, 'I00Y', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I02X' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I005', 1, 'I01S', 1, 'I01S', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I014', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I04A' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I002', 1, 'I01M', 1, 'I01M', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I03I' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I003', 1, 'I001', 1, 'I001', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I061' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I062', 1, 'I01V', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I00U' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I03R', 1, 'I061', 1, 'I01B', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I00V' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I004', 1, 'I00Z', 1, 'I00Y', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I01S', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I00W' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I006', 1, 'I01O', 1, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I032' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I024', 1, 'I01R', 1, 'I013', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I01O', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I00O' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I027', 1, 'I01K', 1, 'I013', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I01M', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I035' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I01O', 1, 'I00Z', 1, 'I01J', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I014', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I041' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I042', 1, 'I048', 1, 'I04C', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I04D' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I001', 1, 'I019', 1, 'I01I', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I01I', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I04N' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I01F', 1, 'I01C', 1, 'I01M', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I04T' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I050', 1, 'I02O', 1, 'I01B', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I051' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I052', 1, 'I010', 1, 'I00Y', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I00Z', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I05T' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I017', 1, 'I01A', 1, 'I01J', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I05W' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I03G', -1, 0, 0, 0, 0 )
    call HCxGUIxFormulaSetMaterialB( 'I015', 1, 'I01V', 1, 'I05V', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I04G' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I04H', 1, 'I01H', 1, 'I01N', 1 )
    call HCxGUIxFormulaSetMaterialB( 'I01N', 1, 0, 0, 0, 0 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call HCxGUIxFormulaBegin(  (i), 3, 'I060' )
    call HCxGUIxFormulaSetResourceAB( 0, 0 )
    call HCxGUIxFormulaSetMaterialA( 'I05Z', 1, 'I048', 1, 'I048', 1 )
    call HCxGUIxFormulaEnd(  )
    set i = i + 1
    // ========
    call TriggerSleepAction( 0.50 )
    call DebugMsg("物品合成公式总数：" + I2S(i-1000))
endfunction

//===========================================================================
function InitTrig_Setting_Item_System_Table_3 takes nothing returns nothing
    set gg_trg_Setting_Item_System_Table_3 = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Setting_Item_System_Table_3, function Trig_Setting_Item_System_Table_3_Actions )
endfunction

//===========================================================================
// Trigger: About Map
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏设定--任务帮助信息
//===========================================================================
function Trig_About_Map_Actions takes nothing returns nothing
    // =========
    call CreateQuestBJ( bj_QUESTTYPE_OPT_DISCOVERED, "TRIGSTR_4001", "TRIGSTR_4008", "ReplaceableTextures\\CommandButtons\\BTNEngineeringUpgrade.blp" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_4142" )
    // =========
    call CreateQuestBJ( bj_QUESTTYPE_OPT_DISCOVERED, "TRIGSTR_4143", "TRIGSTR_4144", "ReplaceableTextures\\CommandButtons\\BTNMagicVault.blp" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_4145" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_4146" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_4221" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_4229" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_4231" )
    // =========
    call CreateQuestBJ( bj_QUESTTYPE_OPT_DISCOVERED, "TRIGSTR_4276", "TRIGSTR_4283", "ReplaceableTextures\\CommandButtons\\BTNHumanCaptureFlag.blp" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_4289" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_4443" )
    // =========
    call CreateQuestBJ( bj_QUESTTYPE_REQ_DISCOVERED, "TRIGSTR_5911", "TRIGSTR_5914", "ReplaceableTextures\\CommandButtons\\BTNSnazzyScroll.blp" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_5915" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_6342" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_6343" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_6344" )
    // =========
    call CreateQuestBJ( bj_QUESTTYPE_REQ_DISCOVERED, "TRIGSTR_6345", "TRIGSTR_6346", "ReplaceableTextures\\CommandButtons\\BTN_marisa.blp" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_6347" )
    // =========
    // =========
    call CreateQuestBJ( bj_QUESTTYPE_REQ_DISCOVERED, "TRIGSTR_6376", "TRIGSTR_6377", "ReplaceableTextures\\CommandButtons\\BTNSorceressMaster.blp" )
    call CreateQuestItemBJ( GetLastCreatedQuestBJ(), "TRIGSTR_6378" )
endfunction

//===========================================================================
function InitTrig_About_Map takes nothing returns nothing
    set gg_trg_About_Map = CreateTrigger(  )
    call TriggerAddAction( gg_trg_About_Map, function Trig_About_Map_Actions )
endfunction

//===========================================================================
// Trigger: Announce
//===========================================================================
function Trig_Announce_Actions takes nothing returns nothing
    call FlashQuestDialogButton(  )
    call ClearTextMessages(  )
    call DisplayTimedTextToForce( GetPlayersAll(), 10.00, "TRIGSTR_6379" )
    call PolledWait( 8.00 )
    call DisplayTimedTextToForce( GetPlayersAll(), 10.00, "TRIGSTR_6380" )
    call PolledWait( 8.00 )
    call DisplayTimedTextToForce( GetPlayersAll(), 10.00, "TRIGSTR_6381" )
    if udg_TestMode then
    call PolledWait( 8.00 )
    call DisplayTimedTextToPlayer( GetLocalPlayer(), 0, 0, 30.00, "TRIGSTR_6383" )
    call DisplayTimedTextToPlayer( GetLocalPlayer(), 0, 0, 30.00, "TRIGSTR_6384" )
    endif
endfunction

//===========================================================================
function InitTrig_Announce takes nothing returns nothing
    set gg_trg_Announce = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Announce, function Trig_Announce_Actions )
endfunction

//===========================================================================
// Trigger: Master Initialization
//===========================================================================
function Trig_Master_Initialization_Func016A takes nothing returns nothing
    call SetCameraBoundsToRectForPlayerBJ( GetEnumPlayer(), udg_MapRegion )
endfunction

function Trig_Master_Initialization_Actions takes nothing returns nothing
    set udg_MapRegion = Rect(- 2112.0, - 18432.0, 14432.0, - 2048.0)
    set udg_MapRegionScreen = Rect(- 9000.0, - 18432.0, - 2304.0, - 2048.0)
    // ========================
    call SetMapFlag( MAP_OBSERVERS_ON_DEATH, true )
    call SetMapFlag( MAP_LOCK_ALLIANCE_CHANGES, true )
    call SetGameSpeed( MAP_SPEED_FASTEST )
    call LockGameSpeedBJ(  )
    call FogEnable( true )
    call FogMaskEnable( true )
    call MeleeStartingVisibility(  )
    call SetSkyModel( "Environment\\Sky\\LordaeronFallSky\\LordaeronFallSky.mdl" )
    // ========================
    set udg_DebugMode = false
    set udg_TestMode = false
    // ========================
    call ForForce( GetPlayersAll(), function Trig_Master_Initialization_Func016A )
    set udg_ShiftPlayer = true
    call ForceAddPlayer( udg_TeamOB, Player(5) )
    call ForceAddPlayer( udg_TeamOB, Player(11) )
    call SetPlayerName( Player(5), ( GetPlayerName(Player(5)) + "(围观者)" ) )
    call SetPlayerName( Player(11), ( GetPlayerName(Player(11)) + "(吐槽者)" ) )
    // ========================
    call TriggerExecute( gg_trg_Initialization_Players )
    call TriggerExecute( gg_trg_Initialization_Locations )
    call TriggerExecute( gg_trg_Initialization_Market )
    call TriggerExecute( gg_trg_Initialization_CE )
    // ========================
    call TriggerExecute( gg_trg_Setting_Balance )
    call TriggerExecute( gg_trg_Setting_Character_A )
    call TriggerExecute( gg_trg_Setting_Character_B )
    call TriggerExecute( gg_trg_Setting_Item_System_Table_1 )
    call TriggerExecute( gg_trg_Setting_Neutrals )
    call TriggerExecute( gg_trg_Setting_Spawn )
    call TriggerExecute( gg_trg_About_Map )
    // ========================
    call TriggerExecute( gg_trg_Initialization_CMD )
    call TriggerExecute( gg_trg_Initialization_CSS )
    call TriggerExecute( gg_trg_Initialization_Spawn )
    call TriggerExecute( gg_trg_Initialization_Base )
    call TriggerExecute( gg_trg_Initialization_Weather )
    call TriggerExecute( gg_trg_Initialization_Defence )
    call TriggerExecute( gg_trg_Initialization_AI )
    // ========================
    call TriggerRegisterTimerEventSingle( gg_trg_Master_Trigger, 0.01 )
endfunction

//===========================================================================
function InitTrig_Master_Initialization takes nothing returns nothing
    set gg_trg_Master_Initialization = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Master_Initialization, function Trig_Master_Initialization_Actions )
endfunction

//===========================================================================
// Trigger: Master Trigger
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 初始化--主触发启动
// 删除预载单位--游戏进程开始--进入模式选择
//===========================================================================
function Trig_Master_Trigger_Func007A takes nothing returns nothing
    call ExplodeUnitBJ( GetEnumUnit() )
    call RemoveUnit( GetEnumUnit() )
endfunction

function Trig_Master_Trigger_Actions takes nothing returns nothing
    //call HostPlayerTest()
    call DebugMsg("主初始化完成")
    call DebugMsg("OB数量：" + I2S(CountPlayersInForceBJ(udg_TeamOB)))
    call SetTimeOfDayScalePercentBJ( 0.00 )
    call TriggerExecute( gg_trg_Enter_Mode_Select )
    set bj_wantDestroyGroup = true
    call ForGroupBJ( GetUnitsInRectAll(gg_rct_PreloadUnits), function Trig_Master_Trigger_Func007A )
endfunction

//===========================================================================
function InitTrig_Master_Trigger takes nothing returns nothing
    set gg_trg_Master_Trigger = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Master_Trigger, function Trig_Master_Trigger_Actions )
endfunction

//===========================================================================
// Trigger: Initialization Players
//
// PlayerA[0]: 博丽神社相关玩家
// PlayerB[0]: 守失神社相关玩家
//===========================================================================
function Trig_Initialization_Players_Func098Func001C takes nothing returns boolean
    if ( not ( GetPlayerSlotState(GetEnumPlayer()) == PLAYER_SLOT_STATE_PLAYING ) ) then
        return false
    endif
    return true
endfunction

function Trig_Initialization_Players_Func098A takes nothing returns nothing
    if ( Trig_Initialization_Players_Func098Func001C() ) then
        call ForceAddPlayer( udg_OnlinePlayers, GetEnumPlayer() )
    else
        call DoNothing(  )
    endif
    call SetPlayerMaxHeroesAllowed( 1, GetEnumPlayer() )
    call SetPlayerAlliance( GetEnumPlayer(), Player(5), ALLIANCE_SHARED_CONTROL, true )
    call SetPlayerAlliance( GetEnumPlayer(), Player(11), ALLIANCE_SHARED_CONTROL, true )
    call ClearTextMessages(  )
endfunction

function Trig_Initialization_Players_Func099Func001C takes nothing returns boolean
    if ( not ( GetPlayerSlotState(GetEnumPlayer()) == PLAYER_SLOT_STATE_PLAYING ) ) then
        return false
    endif
    return true
endfunction

function Trig_Initialization_Players_Func099A takes nothing returns nothing
    if ( Trig_Initialization_Players_Func099Func001C() ) then
        call ForceAddPlayer( udg_OnlinePlayers, GetEnumPlayer() )
    else
        call DoNothing(  )
    endif
    call SetPlayerMaxHeroesAllowed( 1, GetEnumPlayer() )
    call SetPlayerAlliance( GetEnumPlayer(), Player(5), ALLIANCE_SHARED_CONTROL, true )
    call SetPlayerAlliance( GetEnumPlayer(), Player(11), ALLIANCE_SHARED_CONTROL, true )
    call ClearTextMessages(  )
endfunction

function Trig_Initialization_Players_Func100Func001C takes nothing returns boolean
    if ( not ( GetPlayerController(GetEnumPlayer()) == MAP_CONTROL_COMPUTER ) ) then
        return false
    endif
    return true
endfunction

function Trig_Initialization_Players_Func100A takes nothing returns nothing
    if ( Trig_Initialization_Players_Func100Func001C() ) then
        call ForceAddPlayer( udg_AI_Players, GetEnumPlayer() )
    else
        call DoNothing(  )
    endif
endfunction

function Trig_Initialization_Players_Actions takes nothing returns nothing
    local integer i = 0
    // ========================
    set udg_PlayerA[0] = Player(4)
    set udg_PlayerB[0] = Player(10)
    set udg_PlayerA[5] = Player(bj_PLAYER_NEUTRAL_VICTIM)
    set udg_PlayerB[5] = Player(bj_PLAYER_NEUTRAL_EXTRA)
    call ForceAddPlayer( udg_TeamA, udg_PlayerA[0] )
    call ForceAddPlayer( udg_TeamB, udg_PlayerB[0] )
    call ForceAddPlayer( udg_TeamS, udg_PlayerA[0] )
    call ForceAddPlayer( udg_TeamS, udg_PlayerB[0] )
    call SetPlayerName( udg_PlayerA[0], ( "博丽神社" + ( "(" + ( GetPlayerName(udg_PlayerA[0]) + ")" ) ) ) )
    call SetPlayerName( udg_PlayerB[0], ( "守矢神社" + ( "(" + ( GetPlayerName(udg_PlayerB[0]) + ")" ) ) ) )
    call SetPlayerAlliance( udg_PlayerA[0], udg_PlayerA[0], ALLIANCE_SHARED_CONTROL, false )
    call SetPlayerAlliance( udg_PlayerA[0], udg_PlayerA[0], ALLIANCE_SHARED_ADVANCED_CONTROL, false )
    call SetPlayerAlliance( udg_PlayerB[0], udg_PlayerB[0], ALLIANCE_SHARED_CONTROL, false )
    call SetPlayerAlliance( udg_PlayerB[0], udg_PlayerB[0], ALLIANCE_SHARED_ADVANCED_CONTROL, false )
    set udg_PN[GetPlayerId(udg_PlayerA[0])] = "|cFFFFFF00博丽|r"
    set udg_PN[GetPlayerId(udg_PlayerB[0])] = "|cFF006633守矢|r"
    // ========================
    set i = 0
    // 博丽神社
    set i = i + 1
    set udg_PlayerA[ (i)] = Player(0)
    set i = i + 1
    set udg_PlayerA[ (i)] = Player(1)
    set i = i + 1
    set udg_PlayerA[ (i)] = Player(2)
    set i = i + 1
    set udg_PlayerA[ (i)] = Player(3)
    // ========================
    loop
    call ForceAddPlayer( udg_TeamA, udg_PlayerA[ (i)] )
        exitwhen i==0
        set i = i - 1
    endloop
    // ========================
    set i = 0
    // 守矢神社
    set i = i + 1
    set udg_PlayerB[ (i)] = Player(6)
    set i = i + 1
    set udg_PlayerB[ (i)] = Player(7)
    set i = i + 1
    set udg_PlayerB[ (i)] = Player(8)
    set i = i + 1
    set udg_PlayerB[ (i)] = Player(9)
    // ========================
    loop
    call ForceAddPlayer( udg_TeamB, udg_PlayerB[ (i)] )
        exitwhen i==0
        set i = i - 1
    endloop
    // ========================
    call SetForceAllianceStateBJ( udg_TeamA, udg_TeamA, bj_ALLIANCE_ALLIED_VISION )
    call SetForceAllianceStateBJ( udg_TeamA, udg_TeamB, bj_ALLIANCE_UNALLIED )
    call SetForceAllianceStateBJ( udg_TeamA, bj_FORCE_PLAYER[PLAYER_NEUTRAL_AGGRESSIVE], bj_ALLIANCE_UNALLIED )
    // --------
    call SetForceAllianceStateBJ( udg_TeamB, udg_TeamB, bj_ALLIANCE_ALLIED_VISION )
    call SetForceAllianceStateBJ( udg_TeamB, udg_TeamA, bj_ALLIANCE_UNALLIED )
    call SetForceAllianceStateBJ( udg_TeamB, bj_FORCE_PLAYER[PLAYER_NEUTRAL_AGGRESSIVE], bj_ALLIANCE_UNALLIED )
    // --------
    // --------
    call SetForceAllianceStateBJ( bj_FORCE_PLAYER[PLAYER_NEUTRAL_AGGRESSIVE], udg_TeamA, bj_ALLIANCE_UNALLIED )
    call SetForceAllianceStateBJ( bj_FORCE_PLAYER[PLAYER_NEUTRAL_AGGRESSIVE], udg_TeamB, bj_ALLIANCE_UNALLIED )
    call ClearTextMessages(  )
    call SetMapFlag( MAP_LOCK_ALLIANCE_CHANGES, true )
    // --------
    call ForceRemovePlayer( udg_TeamA, udg_PlayerA[0] )
    call ForceRemovePlayer( udg_TeamB, udg_PlayerB[0] )
    call ForceAddPlayer( udg_TeamSpawnA, udg_PlayerA[0] )
    call ForceAddPlayer( udg_TeamSpawnB, udg_PlayerB[0] )
    // ========================
    call ForForce( udg_TeamA, function Trig_Initialization_Players_Func098A )
    call ForForce( udg_TeamB, function Trig_Initialization_Players_Func099A )
    call ForForce( udg_OnlinePlayers, function Trig_Initialization_Players_Func100A )
    set udg_OnlinePlayerSum = CountPlayersInForceBJ(udg_OnlinePlayers)
    // ========================
    call DebugMsg("游戏人数："+I2S(udg_OnlinePlayerSum))
endfunction

//===========================================================================
function InitTrig_Initialization_Players takes nothing returns nothing
    set gg_trg_Initialization_Players = CreateTrigger(  )
    call DisableTrigger( gg_trg_Initialization_Players )
    call TriggerAddAction( gg_trg_Initialization_Players, function Trig_Initialization_Players_Actions )
endfunction

//===========================================================================
// Trigger: Initialization UDG
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 初始化--UDG全局变量初始化
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Initialization_UDG_Actions takes nothing returns nothing
    local integer i = 0
    //========
    
    //初始化游戏缓存
    set udg_gc = InitGameCache("touhouproject.w3v")
    
    //初始化哈希表
    set udg_HeroDatabase = InitHashtable()
    set udg_Hashtable = InitHashtable()
    set udg_db = udg_HeroDatabase
    set udg_ht = udg_Hashtable
    //换个名字而已
    
    set udg_sht = InitHashtable()//静态记录用哈希表。不要Flush！
    
    //========
    
    //设置连杀称号 
    set udg_PerfectText[3] = "|c0000ff40春光满面|r"
    set udg_PerfectText[4] = "|c00400080春意盎然|r"
    set udg_PerfectText[5] = "|c00ff0080春心荡漾|r"
    set udg_PerfectText[6] = "|c00ff8000春不可挡|r"
    set udg_PerfectText[7] = "|c00808000春到残暴|r"
    set udg_PerfectText[8] = "|c00ff80ff春之妖怪|r"
    set udg_PerfectText[9] = "|c00ff0000近似春哥|r"
    set udg_PerfectText[10]= "|c00ff8000超越春哥|r"
    
    //========
    
    //玩家颜色代码
    set udg_PlayerColors[ 0] = "|cFFFF0000"
    set udg_PlayerColors[ 1] = "|cFF0033FF"
    set udg_PlayerColors[ 2] = "|cFF33FFCC"
    set udg_PlayerColors[ 3] = "|cFF7036A0"
    set udg_PlayerColors[ 4] = "|cFFFFFF00"
    set udg_PlayerColors[ 5] = "|cFFFF9900"
    set udg_PlayerColors[ 6] = "|cFF33CC00"
    set udg_PlayerColors[ 7] = "|cFFCC6699"
    set udg_PlayerColors[ 8] = "|cFF999999"
    set udg_PlayerColors[ 9] = "|cFF66CCFF"
    set udg_PlayerColors[10] = "|cFF006633"
    set udg_PlayerColors[11] = "|cFF663300"
    
    //========
    
    //设置玩家名字 
    set i = 0
    loop
        set udg_PN[i] = udg_PlayerColors[i] + GetPlayerName(Player(i)) + "|r"
        set i = i + 1
        exitwhen i > 11
    endloop
    
    //========
    
    //初级敌我识别器
    set udg_FLIFF[ 0] = Filter(function FLIFF01)
    set udg_FLIFF[ 1] = Filter(function FLIFF02)
    set udg_FLIFF[ 2] = Filter(function FLIFF03)
    set udg_FLIFF[ 3] = Filter(function FLIFF04)
    set udg_FLIFF[ 4] = Filter(function FLIFF05)
    set udg_FLIFF[ 5] = Filter(function FLIFF06)
    set udg_FLIFF[ 6] = Filter(function FLIFF07)
    set udg_FLIFF[ 7] = Filter(function FLIFF08)
    set udg_FLIFF[ 8] = Filter(function FLIFF09)
    set udg_FLIFF[ 9] = Filter(function FLIFF10)
    set udg_FLIFF[10] = Filter(function FLIFF11)
    set udg_FLIFF[11] = Filter(function FLIFF12)
    set udg_FLIFF[12] = Filter(function FLIFF13)
    set udg_FLIFF[13] = Filter(function FLIFF14)
    set udg_FLIFF[14] = Filter(function FLIFF15)
    
    //字符表
    call InitACSII()
    
    //========
    
    set i = 0
    loop
        set udg_PlayerHeroes[i] = null
        set i = i + 1
        exitwhen i >= 64
    endloop
    
endfunction

//===========================================================================
function InitTrig_Initialization_UDG takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initialization Locations
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 初始化--设置重生位置
//===========================================================================
function Trig_Initialization_Locations_Actions takes nothing returns nothing
    set udg_RevivePoint[0] = GetRectCenter(gg_rct_ReviveA)
    set udg_RevivePoint[1] = GetRectCenter(gg_rct_ReviveB)
    set udg_RecoverPoint[0] = GetRectCenter(gg_rct_RecoverAreaA)
    set udg_RecoverPoint[1] = GetRectCenter(gg_rct_RecoverAreaB)
    set udg_BirthPoint[0] = GetRectCenter(gg_rct_BirthA)
    set udg_BirthPoint[1] = GetRectCenter(gg_rct_BirthB)
    set udg_BackStage = GetRectCenter(gg_rct_BackStage)
    set udg_CommonPoint = GetRectCenter(gg_rct_CommonArea)
endfunction

//===========================================================================
function InitTrig_Initialization_Locations takes nothing returns nothing
    set gg_trg_Initialization_Locations = CreateTrigger(  )
    call DisableTrigger( gg_trg_Initialization_Locations )
    call TriggerAddAction( gg_trg_Initialization_Locations, function Trig_Initialization_Locations_Actions )
endfunction

//===========================================================================
// Trigger: Enter Mode Select
//===========================================================================
function Trig_Enter_Mode_Select_Func030C takes nothing returns boolean
    if ( not ( GetPlayerController(udg_HostPlayer) == MAP_CONTROL_USER ) ) then
        return false
    endif
    return true
endfunction

function Trig_Enter_Mode_Select_Actions takes nothing returns nothing
    local string msg
    call StopMusic( false )
    // ========
    set udg_GameMode = 0
    set udg_GameModeName[0] = "[1]普通选择模式"
    set udg_GameModeName[1] = "[2]隐藏选择模式"
    set udg_GameModeName[2] = "[3]一击选择模式"
    set udg_GameModeName[3] = "[4]随机选择模式"
    set udg_GameModeName[4] = "[5]比赛选择模式"
    // ========
    set udg_GameModeName[10] = "[1]分阵模式"
    set udg_GameModeName[20] = "[2]全阵模式"
    // ========
    call DecideHostPlayer()
    // ========
    call DialogSetMessage( udg_ModeSelectDialog, "TRIGSTR_1888" )
    set udg_ModeSelectButtons[0] = DialogAddButton(udg_ModeSelectDialog, udg_GameModeName[0], '1')
    set udg_ModeSelectButtons[1] = DialogAddButton(udg_ModeSelectDialog, udg_GameModeName[1], '2')
    set udg_ModeSelectButtons[2] = DialogAddButton(udg_ModeSelectDialog, udg_GameModeName[2], '3')
    set udg_ModeSelectButtons[3] = DialogAddButton(udg_ModeSelectDialog, udg_GameModeName[3], '4')
    if IsBanModeAvailable() then
    set udg_ModeSelectButtons[4] = DialogAddButton(udg_ModeSelectDialog, udg_GameModeName[4], '5')
    endif
    // ========
    call DialogDisplay( udg_HostPlayer, udg_ModeSelectDialog, true )
    call TriggerRegisterDialogEventBJ( gg_trg_Mode_Select_Step_1, udg_ModeSelectDialog )
    // ========
    call DestroyTrigger( GetTriggeringTrigger() )
    call TriggerRegisterTimerExpireEventBJ( gg_trg_Mode_Select_Time_Out, udg_MainTimer )
    if ( Trig_Enter_Mode_Select_Func030C() ) then
        call BroadcastMessage( PlayerColorText(GetPlayerName(udg_HostPlayer),udg_HostPlayer) + "选择中……" )
        call StartTimerBJ( udg_MainTimer, false, 25.00 )
    else
        call StartTimerBJ( udg_MainTimer, false, 3.00 )
    endif
endfunction

//===========================================================================
function InitTrig_Enter_Mode_Select takes nothing returns nothing
    set gg_trg_Enter_Mode_Select = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Enter_Mode_Select, function Trig_Enter_Mode_Select_Actions )
endfunction

//===========================================================================
// Trigger: Mode Select Step 1
//===========================================================================
function Trig_Mode_Select_Step_1_Actions takes nothing returns nothing
    local integer i
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_8774" )
    set i = 0
    loop
        exitwhen i>=10
        if GetClickedButton()==udg_ModeSelectButtons[i] then
    call DisplayTextToForce( GetPlayersAll(), udg_GameModeName[i] )
            set udg_GameMode = i
            exitwhen true
        endif
        set i = i + 1
    endloop
    call DestroyTrigger( GetTriggeringTrigger() )
    // ========
    call DialogDestroy(udg_ModeSelectDialog)
    set udg_ModeSelectDialog = DialogCreate()
    call DialogSetMessage( udg_ModeSelectDialog, "TRIGSTR_8775" )
    set udg_ModeSelectButtons[10] = DialogAddButton(udg_ModeSelectDialog, udg_GameModeName[10], '1')
    set udg_ModeSelectButtons[20] = DialogAddButton(udg_ModeSelectDialog, udg_GameModeName[20], '2')
    call DialogDisplay( udg_HostPlayer, udg_ModeSelectDialog, true )
    call TriggerRegisterDialogEventBJ( gg_trg_Mode_Select_Step_2, udg_ModeSelectDialog )
endfunction

//===========================================================================
function InitTrig_Mode_Select_Step_1 takes nothing returns nothing
    set gg_trg_Mode_Select_Step_1 = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Mode_Select_Step_1, function Trig_Mode_Select_Step_1_Actions )
endfunction

//===========================================================================
// Trigger: Mode Select Step 2
//===========================================================================
function Trig_Mode_Select_Step_2_Actions takes nothing returns nothing
    local integer i
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_8776" )
    set i = 10
    loop
        exitwhen i>=100
        if GetClickedButton()==udg_ModeSelectButtons[i] then
    call DisplayTextToForce( GetPlayersAll(), udg_GameModeName[i] )
            set udg_GameMode = i + udg_GameMode
            exitwhen true
        endif
        set i = i + 10
    endloop
    call DestroyTrigger( GetTriggeringTrigger() )
    // ========
    call DialogDestroy( udg_ModeSelectDialog )
    call DestroyTrigger( gg_trg_Mode_Select_Time_Out )
    call TriggerExecute( gg_trg_Enter_Character_Select_Screen )
endfunction

//===========================================================================
function InitTrig_Mode_Select_Step_2 takes nothing returns nothing
    set gg_trg_Mode_Select_Step_2 = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Mode_Select_Step_2, function Trig_Mode_Select_Step_2_Actions )
endfunction

//===========================================================================
// Trigger: Mode Select Time Out
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 模式选择--时间超时自动选择
//===========================================================================
function Trig_Mode_Select_Time_Out_Actions takes nothing returns nothing
    set udg_GameMode = 20
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_6388" )
    call DisplayTextToForce( GetPlayersAll(), udg_GameModeName[0] )
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_8773" )
    call DisplayTextToForce( GetPlayersAll(), udg_GameModeName[20] )
    call DestroyTrigger( gg_trg_Mode_Select_Step_1 )
    call DestroyTrigger( gg_trg_Mode_Select_Step_2 )
    call DestroyTrigger( GetTriggeringTrigger() )
    call DialogDisplay( udg_HostPlayer, udg_ModeSelectDialog, false )
    call DialogDestroy( udg_ModeSelectDialog )
    // ========
    call TriggerExecute( gg_trg_Enter_Character_Select_Screen )
endfunction

//===========================================================================
function InitTrig_Mode_Select_Time_Out takes nothing returns nothing
    set gg_trg_Mode_Select_Time_Out = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Mode_Select_Time_Out, function Trig_Mode_Select_Time_Out_Actions )
endfunction

//===========================================================================
// Trigger: Initialization CSS
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 选人系统--选人系统初始化设置
//===========================================================================
function Trig_Initialization_CSS_Actions takes nothing returns nothing
    // ========
    call DestroyTimer( udg_CSS_Timers[0] )
    call DestroyTimer( udg_CSS_Timers[1] )
    call DestroyTimer( udg_CSS_Timers[2] )
    call DestroyTimer( udg_CSS_Timers[3] )
    // 选人区Z高度
    set udg_CSS_register[59] = 788
    set udg_CSS_register[5] = 0
    set udg_CSS_register[7] = 0
    set udg_CSS_register[40] = 0
    set udg_CSS_Sprites[159] = null
    set udg_CSS_Prepared[11] = false
    set udg_CSS_Icons[1599] = null
    set udg_CSS_DisplayIcons[143] = null
    set udg_CSS_Buttons[1599] = udg_CSS_Buttons[0]
    set udg_CSS_Triggers[15] = udg_CSS_Triggers[0]
    set udg_CSS_FM[17] = udg_CSS_FM[0]
    // ========
    set udg_HeroButton[0] = 'B00D'
    set udg_CSS_Item[0] = 'B00G'
    set udg_CSS_Item[1] = 'B00B'
    set udg_CSS_Item[2] = 'B001'
    set udg_CSS_Item[3] = 'B009'
    set udg_CSS_Item[4] = 'B007'
    set udg_CSS_Item[5] = 'B00A'
    set udg_CSS_Item[6] = 'B00E'
    set udg_CSS_Item[7] = 'B00C'
    set udg_CSS_Item[8] = 'B01Y'
    // ========
    set udg_CSS_Item[10] = 'B02E'
    set udg_CSS_Item[11] = 'B025'
    set udg_CSS_Item[12] = 'B027'
    set udg_CSS_Item[13] = 'B02A'
    set udg_CSS_Item[14] = 'B02C'
    set udg_CSS_Item[15] = 'B029'
    set udg_CSS_Item[16] = 'B02D'
    set udg_CSS_Item[17] = 'B028'
    set udg_CSS_Item[18] = 'B026'
    set udg_CSS_Item[19] = 'B02B'
    // ========
    set udg_CSS_Areas[0] = gg_rct_PlayerCSS_A1
    set udg_CSS_Areas[1] = gg_rct_PlayerCSS_A2
    set udg_CSS_Areas[2] = gg_rct_PlayerCSS_A3
    set udg_CSS_Areas[3] = gg_rct_PlayerCSS_A4
    set udg_CSS_Areas[4] = gg_rct_PlayerCSS_B1
    set udg_CSS_Areas[5] = gg_rct_PlayerCSS_B2
    set udg_CSS_Areas[6] = gg_rct_PlayerCSS_B3
    set udg_CSS_Areas[7] = gg_rct_PlayerCSS_B4
    set udg_CSS_Areas[8] = gg_rct_PlayerCSS_A5
    set udg_CSS_Areas[9] = gg_rct_PlayerCSS_B5
    set udg_CSS_Areas[10] = gg_rct_PlayerCSS_C0
    set udg_CSS_Areas[11] = gg_rct_CommonArea
    // ========
    set udg_CSS_TimeSetting[0] = 90.00
    set udg_CSS_TimeSetting[1] = 7.00
    set udg_CSS_TimeSetting[2] = 30.00
    // ========
    set udg_HeroPickA[0] = 0
    set udg_HeroPickB[0] = 0
endfunction

//===========================================================================
function InitTrig_Initialization_CSS takes nothing returns nothing
    set gg_trg_Initialization_CSS = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initialization_CSS, function Trig_Initialization_CSS_Actions )
endfunction

//===========================================================================
// Trigger: Enter Character Select Screen
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 选人系统--选人开始入口
//===========================================================================
function Trig_Enter_Character_Select_Screen_Func003A takes nothing returns nothing
    call SetCameraBoundsToRectForPlayerBJ( GetEnumPlayer(), udg_MapRegionScreen )
endfunction

function Trig_Enter_Character_Select_Screen_Actions takes nothing returns nothing
    call SetSkyModel( null )
    call PlayThematicMusic( "Sound\\Music\\mp3Music\\DarkVictory.mp3" )
    call ForForce( GetPlayersAll(), function Trig_Enter_Character_Select_Screen_Func003A )
    call TriggerExecute( gg_trg_CSS_Setup )
endfunction

//===========================================================================
function InitTrig_Enter_Character_Select_Screen takes nothing returns nothing
    set gg_trg_Enter_Character_Select_Screen = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Enter_Character_Select_Screen, function Trig_Enter_Character_Select_Screen_Actions )
endfunction

//===========================================================================
// Trigger: CSS
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 选人系统--选择系统算法与核心函数
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0

function InitTrig_CSS takes nothing returns nothing
endfunction

//获得角色系统内ID
function CSS_GetCharacterID takes integer d returns integer
    local integer i = 1
    if d<=0 then
        return 0
    endif
    loop
        exitwhen i>=200
        if udg_HeroType[i]==d then
            return i
        endif
        set i = i + 1
    endloop
    return 0
endfunction

//获得角色实体
function GetCharacterHandle takes integer ID returns unit
    local integer i = 0
    loop
        exitwhen i>=12
        if GetUnitTypeId(udg_PlayerHeroes[i])==ID then
            return udg_PlayerHeroes[i]
        endif
        set i = i + 1
    endloop
    return null
endfunction

//选择方式类型

function IsLimitedSideMode takes nothing returns boolean
    return (udg_GameMode/10)==2
endfunction

function IsHiddenMode takes nothing returns boolean
    return (udg_GameMode - udg_GameMode/10*10)==1
endfunction

function IsOneShotMode takes nothing returns boolean
    return (udg_GameMode - udg_GameMode/10*10)==2
endfunction

function IsAllRandom takes nothing returns boolean
    return (udg_GameMode - udg_GameMode/10*10)==3
endfunction

function IsBanMode takes nothing returns boolean
    return (udg_GameMode - udg_GameMode/10*10)==4
endfunction

//手动选择
function CSS_RequestCharacter takes player who,integer index returns boolean
    local integer i
    local integer node = udg_CSS_register[7]
    
    if index<=0 or index==100 or index>=200 then
        return false
    endif
    
    //检查是否可用
    if udg_HeroBan[index] then
        return false
    endif
    
    //检查是否已被选 
    set i = 11
    loop
        exitwhen udg_PlayerHeroList[i] == index
        set i = i - 1
        exitwhen i < 0
    endloop
    if not (i<0) then
        return false
    endif
    
    //全阵模式直接通过 
    if IsLimitedSideMode() then
        set udg_PlayerHeroList[GetPlayerId(who)] = index
        return true
    endif
    
    //检查该英雄属于哪个阵营
    if IsBanMode() and node<=6 then
        //分阵BAN模式只能BAN对方英雄
        if (index>100) != IsPlayerInForce(who,udg_TeamB) then
            set udg_PlayerHeroList[GetPlayerId(who)] = index
            return true
        endif
    else
        //分阵普通模式只能选已方英雄
        if (index>100) == IsPlayerInForce(who,udg_TeamB) then
            set udg_PlayerHeroList[GetPlayerId(who)] = index
            return true
        endif
    endif
    
    return false
endfunction

//随机选择
function CSS_RequestRandom takes player who returns integer
    local integer m
    local integer n
    local integer w
    local integer i
    local integer index
    
    //决定随机阵营 
    if IsLimitedSideMode() then
        set w = GetRandomInt(1,udg_HeroType[0] + udg_HeroType[100])
        set i = Integer(w > udg_HeroType[0])
    else
        set i = Integer(IsPlayerInForce(who,udg_TeamB))
    endif
    
    //随机抽取英雄 
    set n = i*100 + 1
    set m = i*100 + udg_HeroType[i*100]
    set i = 0
    loop
        set index = GetRandomInt(n,m)
        set w = 0
        loop
            exitwhen udg_HeroBan[index]
            exitwhen udg_PlayerHeroList[w] == index
            set w = w + 1
            exitwhen w>12
        endloop
        exitwhen w>11
        set i = i + 1
        exitwhen i>=50
    endloop
    
    //是否抽到可用英雄 
    if w>11 then
        if IsBanMode() then
        else
        set udg_PlayerHeroList[GetPlayerId(who)] = index
        endif
    return index
    endif
    
    return 0
endfunction
//===========================================================================
// Trigger: CSS GUI
//===========================================================================
//TESH.scrollpos=219
//TESH.alwaysfold=0

function InitTrig_CSS_GUI takes nothing returns nothing
endfunction

function CSS_GetSlotIconX takes integer w returns real
    if w <= 3 then
        return -128.0
    else
        return  128.0
    endif
endfunction

function CSS_GetSlotIconY takes integer w returns real
    if w <= 3 then
        return 128.0 - 128.0*(w)
    else
        return 128.0 - 128.0*(w-4)
    endif
endfunction

function CSS_AddClickFeedback takes integer screen,integer index,integer d returns nothing
    local integer c = screen
    local integer offset = c*32
    local destructable w = udg_CSS_Icons[c*200 + index]
    local real x = GetDestructableX(w)
    local real y = GetDestructableY(w)
    local real z = udg_CSS_register[59]
    if udg_CSS_Sprites[offset] != null then
        set w = udg_CSS_Sprites[offset]
        call RemoveDestructable(w)
    endif
    set w = CreateDestructableZ(d,x,y,z-20.0,180.0,1.5,0)
    set udg_CSS_Sprites[offset] = w
    set w = null
endfunction
function CSS_RemoveClickFeedback takes integer screen returns nothing
    local integer offset = screen*32
    if udg_CSS_Sprites[offset] != null then
        call RemoveDestructable(udg_CSS_Sprites[offset])
        set udg_CSS_Sprites[offset] = null
    endif
endfunction


function CSS_RemoveCharacterIconFilterForEachScreen takes nothing returns nothing
    local integer c = GetSortedPlayerId(GetEnumPlayer())
    local integer index = udg_CSS_register[51]
    local integer offset = c*32 + 16 + udg_CSS_register[52]
    call RemoveDestructable(udg_CSS_Sprites[offset])
endfunction
function CSS_AddCharacterIconFilterForEachScreen takes nothing returns nothing
    local integer c = GetSortedPlayerId(GetEnumPlayer())
    local integer index = udg_CSS_register[51]
    local integer offset = c*32 + 16 + udg_CSS_register[52]
    local destructable w = udg_CSS_Icons[c*200 + index]
    local integer d = udg_CSS_register[53]
    local real px = GetDestructableX(w)
    local real py = GetDestructableY(w)
    local real z = udg_CSS_register[59]
    set w = CreateDestructableZ(d,px,py,z-15.0,180.0,1.0,0)
    set udg_CSS_Sprites[offset] = w
    set w = null
endfunction
function CSS_AddCharacterIconFilterPickedForEachScreen takes nothing returns nothing
    local integer c = GetSortedPlayerId(GetEnumPlayer())
    local integer index = udg_CSS_register[51]
    local integer offset = c*32 + 16 + udg_CSS_register[52]
    local destructable w = udg_CSS_Icons[c*200 + index]
    local integer d = udg_CSS_register[53]
    local real px = GetDestructableX(w)
    local real py = GetDestructableY(w)
    local real z = udg_CSS_register[59]
    set w = CreateDestructableZ(d,px,py,z-15.0,180.0,1.0,0)
    //set udg_CSS_Sprites[offset] = w
    set w = null
endfunction
function CSS_AddCharacterIconFilter takes integer index,boolean f,integer d returns boolean
    local integer s = udg_CSS_register[40]
    local integer i
    
    if s >= 10 and f then
        return false
    endif
    
    set i = 1
    loop
        exitwhen udg_CSS_register[40+i] == index
        set i = i + 1
        exitwhen i>10
    endloop
    
    if i>10 and f then
        
        set i = 1
        loop
            exitwhen udg_CSS_register[40+i] == 0
            set i = i + 1
            exitwhen i>10
        endloop
        
        set udg_CSS_register[40 + i] = index
        set udg_CSS_register[40] = udg_CSS_register[40] + 1
        
        set udg_CSS_register[51] = index
        set udg_CSS_register[52] = i
        set udg_CSS_register[53] = d
        if d==udg_CSS_Item[2] then
        call ForForce(udg_OnlinePlayers,function CSS_AddCharacterIconFilterPickedForEachScreen)
        else
        call ForForce(udg_OnlinePlayers,function CSS_AddCharacterIconFilterForEachScreen)
        endif
        return true
    endif
        
    if i<=10 and f == false then
        
        set udg_CSS_register[40 + i] = 0
        set udg_CSS_register[40] = udg_CSS_register[40] - 1
        
        set udg_CSS_register[51] = index
        set udg_CSS_register[52] = i
        
        call ForForce(udg_OnlinePlayers,function CSS_RemoveCharacterIconFilterForEachScreen)
        
        return true    
    endif
    
    return false
endfunction

function CSS_AddCharacterIconFilterSelected takes integer index returns boolean
    return CSS_AddCharacterIconFilter(index,true,udg_CSS_Item[7])
endfunction
function CSS_AddCharacterIconFilterBanned takes integer index returns boolean
    return CSS_AddCharacterIconFilter(index,true,udg_CSS_Item[8])
endfunction
function CSS_AddCharacterIconFilterPicked takes integer index returns boolean
    return CSS_AddCharacterIconFilter(index,true,udg_CSS_Item[2])
endfunction
function CSS_RemoveCharacterIconFilter takes integer index returns boolean
    return CSS_AddCharacterIconFilter(index,false,0)
endfunction


function CSS_SetPlayerPreparedGlowOnScreen takes integer c,integer slot returns nothing
    local integer offset = c*32 + 4 + slot
    local real ox = GetRectCenterX(udg_CSS_Areas[c])
    local real oy = GetRectCenterY(udg_CSS_Areas[c])
    local real px
    local real py
    local real z = udg_CSS_register[59]
    local destructable d
    if udg_CSS_Sprites[offset] == null and udg_CSS_Prepared[slot] then
        set px = ox + CSS_GetSlotIconX(slot)
        set py = oy + CSS_GetSlotIconY(slot)
        set d = CreateDestructableZ(udg_CSS_Item[4],px,py,z,180.0,1.3,0)
        set udg_CSS_Sprites[offset] = d
    elseif udg_CSS_Sprites[offset] != null and not udg_CSS_Prepared[slot] then
        set d = udg_CSS_Sprites[offset]
        call RemoveDestructable(d)
        set udg_CSS_Sprites[offset] = null
    endif
    set d = null
endfunction
function CSS_SetPlayerPreparedGlowForEachScreen takes nothing returns nothing
    local integer c = GetSortedPlayerId(GetEnumPlayer())
    local integer slot = udg_CSS_register[3]
    call CSS_SetPlayerPreparedGlowOnScreen(c,slot)
endfunction
function CSS_SetPlayerPreparedGlow takes player who returns nothing
    local integer slot = GetSortedPlayerId(who)
    call CSS_RemoveClickFeedback(slot)
    set udg_CSS_register[3] = slot
    call ForForce(udg_OnlinePlayers,function CSS_SetPlayerPreparedGlowForEachScreen)
    call ForForce(udg_TeamS,function CSS_SetPlayerPreparedGlowForEachScreen)
    if Boolean(udg_CSS_register[5]) then
        call CSS_SetPlayerPreparedGlowOnScreen(10,slot)
    endif
endfunction


function CSS_ClearCharacterDisplayOnScreen takes integer c,integer slot returns nothing
    local integer offset = c*8 + slot
    call RemoveDestructable(udg_CSS_DisplayIcons[offset])
endfunction
function CSS_ClearCharacterDisplayForEachScreen takes nothing returns nothing
    local integer c = GetSortedPlayerId(GetEnumPlayer())
    local integer slot = udg_CSS_register[1]
    call CSS_ClearCharacterDisplayOnScreen(c,slot)
endfunction
function CSS_ClearCharacterDisplay takes player who returns nothing
    local integer slot = GetSortedPlayerId(who)
    set udg_CSS_register[1] = slot
    call ForForce(udg_OnlinePlayers,function CSS_ClearCharacterDisplayForEachScreen)
    call ForForce(udg_TeamS,function CSS_ClearCharacterDisplayForEachScreen)
    if Boolean(udg_CSS_register[5]) then
        call CSS_ClearCharacterDisplayOnScreen(10,slot)
    endif
endfunction


function CSS_SetCharacterDisplayOnScreen takes integer c,player who,integer slot,integer index returns nothing
    local integer offset = c*8 + slot
    local real ox = GetRectCenterX(udg_CSS_Areas[c])
    local real oy = GetRectCenterY(udg_CSS_Areas[c])
    local real px
    local real py
    local real z = udg_CSS_register[59]
    local destructable display
    local integer d
    
    set display = udg_CSS_DisplayIcons[offset]
    call RemoveDestructable(display)
    set px = ox + CSS_GetSlotIconX(slot)
    set py = oy + CSS_GetSlotIconY(slot)
    
    if c!=10 and IsHiddenMode() and IsPlayerOpponent(who,GetSortedPlayer(slot)) then
        set d = udg_CSS_Item[GetRandomInt(10,19)]
    else
        set d = udg_HeroButton[index]
    endif
    set udg_CSS_DisplayIcons[offset] = CreateDestructableZ(d,px,py,z-8.0,180.0,1.0,0)
    
    set display = null
endfunction
function CSS_SetCharacterDisplayForEachScreen takes nothing returns nothing
    local integer c = GetSortedPlayerId(GetEnumPlayer())
    local integer slot = udg_CSS_register[1]
    local integer index = udg_CSS_register[2]
    call CSS_SetCharacterDisplayOnScreen(c,GetEnumPlayer(),slot,index)
endfunction
function CSS_SetCharacterDisplay takes player who,integer index returns nothing
    local integer slot = GetSortedPlayerId(who)
    set udg_CSS_register[1] = slot
    set udg_CSS_register[2] = index
    call ForForce(udg_OnlinePlayers,function CSS_SetCharacterDisplayForEachScreen)
    call ForForce(udg_TeamS,function CSS_SetCharacterDisplayForEachScreen)
    if Boolean(udg_CSS_register[5]) then
        call CSS_SetCharacterDisplayOnScreen(10,who,slot,index)
    endif
endfunction


function CSS_AddCharacterIcon takes integer c,integer index,real x,real y returns trackable
    local integer offset = c*200 + index
    local real z = udg_CSS_register[59]
    if index < 100 then
        set udg_CSS_Buttons[offset] = CreateTrackable("HitBoxRed.mdl",x,y,270.0)
    else
        set udg_CSS_Buttons[offset] = CreateTrackable("HitBoxGreen.mdl",x,y,270.0)
    endif
    set udg_CSS_Icons[offset] = CreateDestructableZ(udg_HeroButton[index],x,y,z-16.0,180.0,1.0,0)
    return udg_CSS_Buttons[offset]
endfunction

function CSS_AddRandomIcon takes integer c,real x,real y returns trackable
    local integer offset = c*200
    local real z = udg_CSS_register[59]
    set udg_CSS_Buttons[offset] = CreateTrackable("HitBoxYellow.mdl",x,y,270.0)
    set udg_CSS_Icons[offset] = CreateDestructableZ(udg_HeroButton[0],x,y,z-16.0,180.0,1.0,0)
    return udg_CSS_Buttons[offset]
endfunction

function CSS_AddOkIcon takes integer c,real x,real y returns trackable
    local integer offset = c*200 + 100
    local real z = udg_CSS_register[59]
    set udg_CSS_Buttons[offset] = CreateTrackable("HitBoxHidden.mdl",x,y,270.0)
    set udg_CSS_Icons[offset] = CreateDestructableZ(udg_CSS_Item[2],x,y,z,180.0,1.00,0)
    call CreateDestructableZ(udg_CSS_Item[3],x,y,z-24.0,180.0,1.25,0)
    return udg_CSS_Buttons[offset]
endfunction
//===========================================================================
// Trigger: CSS Event
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 抽象动作
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0

function InitTrig_CSS_Event takes nothing returns nothing
endfunction

function CSS_SetPlayerPrepared takes player who,boolean flag returns nothing
    set udg_CSS_Prepared[GetSortedPlayerId(who)] = flag
    call CSS_SetPlayerPreparedGlow(who)
endfunction

function CSS_SelectCharacter takes player who,integer index,boolean text returns boolean
    local integer w = GetPlayerId(who)
    local integer origin = udg_PlayerHeroList[w]
    local boolean result
    if udg_HeroBan[index] then
        return false
    endif
    if who == GetLocalPlayer() then
        call ClearTextMessages()
    endif
    if index > 0 then
        call DisplayTextToPlayer(who,0,0,udg_HeroBrief[index])
        set result = CSS_RequestCharacter(who,index)
    else
        if index==0 then
            set udg_PlayerHeroList[w] = 0
            set result = true
            call DisplayTextToPlayer(who,0,0,"随机")
        else
            set index = CSS_RequestRandom(who)
            if index>0 then
                set result = true
                if text then
                    call DisplayTextToPlayer(who,0,0,udg_HeroBrief[index])
                endif
            else
                set result = false
            endif
        endif
    endif
    if result then
        call CSS_SetCharacterDisplay(who,index)
        call CSS_SetPlayerPrepared(who,false)
        call CSS_RemoveCharacterIconFilter(origin)
        if udg_PlayerHeroList[w] > 0 then
            if IsHiddenMode()==false then
                call CSS_AddCharacterIconFilterSelected(udg_PlayerHeroList[w])
            endif
        endif
    endif
    return result
endfunction

function CSS_SelectCharacterForBan takes player who,integer index returns boolean
    return CSS_SelectCharacter(who,index,false)
endfunction

function CSS_LockUI takes integer screen returns nothing
    set udg_CSS_register[8+screen] = 1
endfunction
//===========================================================================
// Trigger: CSS Main
//===========================================================================
//TESH.scrollpos=99
//TESH.alwaysfold=0

//检测已准备人数
function CSS_GetPreparedPlayerSum takes nothing returns integer
    local integer i = 0
    local integer sum = 0
    loop
        if udg_CSS_Prepared[i] then
            set sum = sum + 1
        endif
        set i = i + 1
        exitwhen i>11
    endloop
    return sum
endfunction

//清除选人物件
function CSS_RemoveIcons takes nothing returns nothing
    call RemoveDestructable(GetEnumDestructable())
endfunction
function CSS_Clear takes nothing returns nothing
    local integer c = 0
    loop
        exitwhen c>7
        call DestroyTrigger(udg_CSS_Triggers[c])
        call DestroyFogModifier(udg_CSS_FM[c])
        set udg_CSS_FM[c] = CreateFogModifierRect(GetEnumPlayer(),FOG_OF_WAR_MASKED,udg_CSS_Areas[c],true,true)
        call FogModifierStart(udg_CSS_FM[c])
        call EnumDestructablesInRectAll(udg_CSS_Areas[c],function CSS_RemoveIcons)
        set c = c + 1
    endloop
    call EnumDestructablesInRectAll(udg_CSS_Areas[10],function CSS_RemoveIcons)
endfunction

function KeepOnResetCamera takes nothing returns nothing
local timer t = GetExpiredTimer()
call ResetToGameCamera(0)
call PauseTimer(t)
call DestroyTimer(t)
set t = null
endfunction

function CSS_ExitCameraSetting takes player who returns nothing
    call SetCameraField(CAMERA_FIELD_TARGET_DISTANCE, 3800.00, 0 )
    call SetCameraField(CAMERA_FIELD_FARZ           , 5000.00, 0 )
    call SetCameraField(CAMERA_FIELD_FIELD_OF_VIEW  , 70.00, 0 )
    call ResetToGameCamera(3)
    
    if IsPlayerInForce(who,udg_TeamA) or who==udg_PlayerA[0] then
        call PanCameraToTimed(GetLocationX(udg_BirthPoint[0]),GetLocationY(udg_BirthPoint[0]),0.0)
    elseif IsPlayerInForce(who,udg_TeamB) or who==udg_PlayerB[0] then
        call PanCameraToTimed(GetLocationX(udg_BirthPoint[1]),GetLocationY(udg_BirthPoint[1]),0.0)
    else
        call PanCameraToTimed(GetRectCenterX(udg_CSS_Areas[11]),GetRectCenterY(udg_CSS_Areas[11]),0.0)
    endif
endfunction

//选择完毕动作
function CSS_Finish takes nothing returns nothing
    local integer i
    
    call PauseTimer(udg_CSS_Timers[0])
    call PauseTimer(udg_CSS_Timers[1])
    call PauseTimer(udg_CSS_Timers[2])
    call PauseTimer(udg_CSS_Timers[3])
    
    call DestroyTimer(udg_CSS_Timers[0])
    call DestroyTimer(udg_CSS_Timers[1])
    call DestroyTimer(udg_CSS_Timers[2])
    call DestroyTimer(udg_CSS_Timers[3])
    call DestroyTimerDialog(udg_MainTimerWindow)
    call DestroyTimerDialog(udg_SelectTimerWindow)
    
    //call ResetToGameCamera(1.0)
    //call EnableUserControl(true)
    //call ShowInterface(true,0.1)
    //call CSS_ExitCameraSetting(GetLocalPlayer())
    
    call CSS_Clear()
    
    if IsBanMode() then
    call TriggerExecute(gg_trg_CSS_Ban_Mode_Step2)
    else
    call TriggerExecute(gg_trg_CSS_Finish)
    endif
endfunction

function CSS_Preload takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local player who = GetSortedPlayer(udg_CSS_register[4])
    local integer i = GetPlayerId(who)
    local integer d = udg_HeroType[udg_PlayerHeroList[i]]
    if IsBanMode() then
        if i <= 3 then
        set who = udg_PlayerA[0]
        else
        set who = udg_PlayerB[0]
        endif
    endif
    
    if IsUnitType(udg_PlayerHeroes[i],UNIT_TYPE_HERO)==false then
        call TSU_RemoveUnit(udg_CSS_TimeSetting[1],udg_PlayerHeroes[i])
        set udg_PlayerHeroes[i] = CreateUnitAtLoc(who,d,udg_BackStage,0)
        call PauseUnit(udg_PlayerHeroes[i],true)
        //ban模式选人时再注册
        if IsBanMode() then
        call SaveInteger(udg_ht,GetHandleId(udg_PlayerHeroes[i]),0,udg_PlayerHeroList[i])
        else
        call TriggerExecute(udg_HeroInit[udg_PlayerHeroList[i]])
        endif
    endif
    set udg_CSS_register[4] = udg_CSS_register[4] + 1
    if udg_CSS_register[4]>7 then
        call TSU_RemoveUnit(udg_CSS_TimeSetting[1],udg_PlayerHeroes[4])
        call TSU_RemoveUnit(udg_CSS_TimeSetting[1],udg_PlayerHeroes[10])
        call TSU_RemoveUnit(udg_CSS_TimeSetting[1],udg_PlayerHeroes[15])
        call PauseTimer(t)
        call DestroyTimer(t)
    endif
    set t = null
    set who = null
endfunction

function CSS_FillRandomCharacters_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local player who = GetSortedPlayer(udg_CSS_register[4])
    if IsPlayerInForce(who,udg_OnlinePlayers) then
        if udg_PlayerHeroList[GetPlayerId(who)]==0 then
            call CSS_SelectCharacter(who,-1,true)
        endif
        call CSS_SetPlayerPrepared(who,true)
    endif
    set udg_CSS_register[4] = udg_CSS_register[4] + 1
    if udg_CSS_register[4]>7 then
        set udg_CSS_register[4] = 0
        call TimerStart(t,0.25,true,function CSS_Preload)
    endif
    set t = null
    set who = null
endfunction

function CSS_FillRandomCharacters takes nothing returns nothing
    local timer t = CreateTimer()
    set udg_CSS_register[4] = 0
    call TimerStart(t,0.20,true,function CSS_FillRandomCharacters_Main)
    set t = null
endfunction

//选择时间超时随即选择
function CSS_TimeOut takes nothing returns nothing
    local integer i = 0
    loop
        exitwhen i>7
        call DisableTrigger(udg_CSS_Triggers[i])//禁止玩家点击
        set i = i+1
    endloop
    set udg_CSS_register[1] = 1
    call CSS_FillRandomCharacters()
endfunction

//选择及时间
function CSS_Main takes nothing returns nothing
    local integer sum = CSS_GetPreparedPlayerSum()
    local timer t = udg_CSS_Timers[1]
    local timerdialog w = udg_MainTimerWindow
    //========
    if sum == udg_OnlinePlayerSum then
        if udg_CSS_register[4]==0 then
            call CSS_FillRandomCharacters()
        endif
        if not IsTimerDialogDisplayed(w) then
            call TimerDialogDisplay(w,true)
            call ResumeTimer(t)
            call PauseTimer(udg_CSS_Timers[2])
        endif
    else
        if IsTimerDialogDisplayed(w) then
            call TimerDialogDisplay(w,false)
            call TimerStart(t,udg_CSS_TimeSetting[1],false,function CSS_Finish)
            call PauseTimer(t)
            call ResumeTimer(udg_CSS_Timers[2])
        endif
    endif
    //========
    call SetCameraField(CAMERA_FIELD_ROTATION       , 90.00, 0 )
    call SetCameraField(CAMERA_FIELD_ANGLE_OF_ATTACK, 270.00, 0 )
    call SetCameraField(CAMERA_FIELD_ROLL           , 0.00, 0 )
    call SetCameraField(CAMERA_FIELD_TARGET_DISTANCE, 1800.00, 0 )
    call SetCameraField(CAMERA_FIELD_FARZ           , 15000.00, 0 )
    call SetCameraField(CAMERA_FIELD_FIELD_OF_VIEW  , 70.00, 0 )
    //========
    set t = null
    set w = null
endfunction

//===========================================================================
function InitTrig_CSS_Main takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: CSS Ban Mode
//
// udg_HeroPickA[0]计数
// udg_HeroPickA[1]~udg_HeroPickA[4]储存英雄编号
//===========================================================================
//TESH.scrollpos=181
//TESH.alwaysfold=0
function InitTrig_CSS_Ban_Mode takes nothing returns nothing
endfunction

function CSS_Click_Actions_Ban_PlayerOrder takes integer node returns integer
//Ban
    if     node == 1  then
        return 0
    elseif node == 2  then
        return 4
    elseif node == 3  then
        return 4
    elseif node == 4  then
        return 0
    elseif node == 5  then
        return 0
    elseif node == 6  then
        return 4
//Pick
    elseif node == 7  then
        return 0
    elseif node == 8  then
        return 4
    elseif node == 9  then
        return 4
    elseif node == 10 then
        return 0
    elseif node == 11 then
        return 0
    elseif node == 12 then
        return 4
    elseif node == 13 then
        return 0
    elseif node == 14 then
        return 4
    endif
    return 0
endfunction

//Ban设置函数
function CSS_SetCharacterBan takes integer index,boolean ban returns nothing
    if ban then
        set udg_HeroBan[index] = true
        call CSS_RemoveCharacterIconFilter(index)
        call CSS_AddCharacterIconFilterBanned(index)
    else
        set udg_HeroBan[index] = false
        call CSS_RemoveCharacterIconFilter(index)
    endif
endfunction

//Pick设置函数
function CSS_SetCharacterPick takes integer index,integer node returns nothing
    local integer f = CSS_Click_Actions_Ban_PlayerOrder(node)
        if f == 0 then
        set udg_HeroBan[index] = true
        set udg_HeroPickA[0] = udg_HeroPickA[0] + 1
        set udg_HeroPickA[udg_HeroPickA[0]] = index
        set udg_PlayerHeroList[4-udg_HeroPickA[0]] = index
        call CSS_SetCharacterDisplay(udg_PlayerA[5-udg_HeroPickA[0]],index)
        call CSS_RemoveCharacterIconFilter(index)
        call CSS_AddCharacterIconFilterPicked(index)
        else
        set udg_HeroBan[index] = true
        set udg_HeroPickB[0] = udg_HeroPickB[0] + 1
        set udg_HeroPickB[udg_HeroPickB[0]] = index
        set udg_PlayerHeroList[10-udg_HeroPickB[0]] = index
        call CSS_SetCharacterDisplay(udg_PlayerB[5-udg_HeroPickB[0]],index)
        call CSS_RemoveCharacterIconFilter(index)
        call CSS_AddCharacterIconFilterPicked(index)
        endif
endfunction

function CSS_BanTimeOut takes nothing returns nothing
    local integer node = udg_CSS_register[7]
    local integer n = CSS_Click_Actions_Ban_PlayerOrder(node)
    local string msg
    local player who = GetSortedPlayer(n)
    local timer t
    local integer i
    local integer index
    
        set index = udg_PlayerHeroList[GetPlayerId(who)]
        call CSS_ClearCharacterDisplay(who)
        set udg_PlayerHeroList[GetPlayerId(who)] = 0
      
        if node<=6 then
        //call CSS_SetCharacterBan(index,true)
            call CSS_RemoveCharacterIconFilter(index)
        else
            if index==0 then
            call CSS_SetCharacterPick(CSS_RequestRandom(who),node)
            else
            call CSS_SetCharacterPick(index,node)
            endif
        endif
        
        set node = node + 1
        set udg_CSS_register[7] = node
        
        if node<=6 then
            set n = CSS_Click_Actions_Ban_PlayerOrder(node)
            set msg = "现在请" + PlayerName(GetSortedPlayer(n))
            set msg = msg + "选择一个禁止使用的角色----"
            call BroadcastMessage(msg)
            set msg = null
            call PauseTimer(udg_CSS_Timers[2])
            call TimerStart(udg_CSS_Timers[2],udg_CSS_TimeSetting[2],false,function CSS_BanTimeOut)
        elseif node>6 and node<=14 then
            set n = CSS_Click_Actions_Ban_PlayerOrder(node)
            set msg = "现在请" + PlayerName(GetSortedPlayer(n))
            set msg = msg + "选择一个本队使用的角色----"
            call BroadcastMessage(msg)
            set msg = null
            call PauseTimer(udg_CSS_Timers[2])
            call TimerStart(udg_CSS_Timers[2],udg_CSS_TimeSetting[2],false,function CSS_BanTimeOut)
        else
            set msg = "现在请各位玩家开始选择自己的角色"
            call BroadcastMessage(msg)
            set msg = null
            call PauseTimer(udg_CSS_Timers[2])
            //call TimerDialogDisplay(udg_SelectTimerWindow,false)
            //call TimerDialogDisplay(udg_MainTimerWindow,true)
            call TimerStart(udg_CSS_Timers[2],udg_CSS_TimeSetting[1],false,function CSS_Finish)
            set udg_CSS_register[4] = 1
            set t = CreateTimer()
            call TimerStart(t,0.25,true,function CSS_Preload)
            
            set i = 0
            loop
                exitwhen i>11
                if udg_PlayerHeroes[i] != null then
                    call TSU_RemoveUnit(udg_CSS_TimeSetting[1],udg_PlayerHeroes[i])
                endif
                set i=i+1
            endloop
        endif
        set t = null
        set who = null
endfunction

function CSS_Click_Actions_Ban takes player who,integer c,integer index returns boolean
    local integer node = udg_CSS_register[7]
    local integer i
    local integer n
    local string msg
    local timer t
    
    if IsBanMode()==false then
        return false
    endif
    if node>14 then
        return false
    endif

    if c != CSS_Click_Actions_Ban_PlayerOrder(node) then
        return true
    endif
    
    if index == 100 then
        set index = udg_PlayerHeroList[GetPlayerId(who)]
        
        call CSS_ClearCharacterDisplay(who)
        set udg_PlayerHeroList[GetPlayerId(who)] = 0
        
        if node<=6 then
        call CSS_SetCharacterBan(index,true)
        else
        call CSS_SetCharacterPick(index,node)
        endif
    
        set node = node + 1
        set udg_CSS_register[7] = node
        
        if node<=6 then
            set n = CSS_Click_Actions_Ban_PlayerOrder(node)
            set msg = "现在请" + PlayerName(GetSortedPlayer(n))
            set msg = msg + "选择一个禁止使用的角色----"
            call BroadcastMessage(msg)
            set msg = null
            call PauseTimer(udg_CSS_Timers[2])
            call TimerStart(udg_CSS_Timers[2],udg_CSS_TimeSetting[2],false,function CSS_BanTimeOut)
        elseif node>6 and node<=14 then
            set n = CSS_Click_Actions_Ban_PlayerOrder(node)
            set msg = "现在请" + PlayerName(GetSortedPlayer(n))
            set msg = msg + "选择一个本队使用的角色----"
            call BroadcastMessage(msg)
            set msg = null
            call PauseTimer(udg_CSS_Timers[2])
            call TimerStart(udg_CSS_Timers[2],udg_CSS_TimeSetting[2],false,function CSS_BanTimeOut)
        else
            set msg = "现在请各位玩家开始选择自己的角色"
            call BroadcastMessage(msg)
            set msg = null
            call PauseTimer(udg_CSS_Timers[2])
            //call TimerDialogDisplay(udg_SelectTimerWindow,false)
            //call TimerDialogDisplay(udg_MainTimerWindow,true)
            call TimerStart(udg_CSS_Timers[2],udg_CSS_TimeSetting[1],false,function CSS_Finish)
            set udg_CSS_register[4] = 0
            set t = CreateTimer()
            call TimerStart(t,0.25,true,function CSS_Preload)
            
            set i = 0
            loop
                exitwhen i>11
                if udg_PlayerHeroes[i] != null then
                    call TSU_RemoveUnit(udg_CSS_TimeSetting[1],udg_PlayerHeroes[i])
                endif
                set i=i+1
            endloop
        endif
        set t = null
        return true
    endif
    
    if CSS_SelectCharacterForBan(who,index) then
        call CSS_AddClickFeedback(c,index,udg_CSS_Item[5])
    endif
    
    return true
endfunction
//===========================================================================
// Trigger: CSS Ban Mode Step2
//===========================================================================
//TESH.scrollpos=12
//TESH.alwaysfold=0
function Trig_CSS_Ban_Mode_Step2_Actions_SetRegion takes nothing returns nothing
    call SetCameraBoundsToRectForPlayerBJ( GetEnumPlayer(), udg_MapRegion )
endfunction

function Trig_CSS_Ban_Mode_Step2_Actions takes nothing returns nothing
local integer i = 0   
local timer t = CreateTimer() 
    call ClearTextMessagesBJ( GetPlayersAll() )
    call ForForce( GetPlayersAll(), function Trig_CSS_Ban_Mode_Step2_Actions_SetRegion )
    
    loop
    exitwhen i>3
    //===bl
        call SetUnitPosition(udg_PlayerHeroes[i],GetLocationX(udg_BirthPoint[0])-100+i*100,GetLocationY(udg_BirthPoint[0]))
        call UnitAddAbility( udg_PlayerHeroes[i], 'Asud' )
        call UnitAddAbility( udg_PlayerHeroes[i], 'Aall' )
        call AddUnitToStock( udg_PlayerHeroes[i], 'n00D', 1, 1)
        call UnitMakeAbilityPermanent( udg_PlayerHeroes[i], true, 'Asud' )
        call UnitMakeAbilityPermanent( udg_PlayerHeroes[i], true, 'Aall' )
        call ModifyHeroSkillPoints( udg_PlayerHeroes[i], bj_MODIFYMETHOD_SET, 0 )
        call PauseUnit(udg_PlayerHeroes[i],false)
        set udg_PlayerHeroesBan[i]= udg_PlayerHeroes[i]
        set udg_PlayerHeroes[i] = null
    //===ss
        call SetUnitPosition(udg_PlayerHeroes[i+6],GetLocationX(udg_BirthPoint[1])-200+i*100,GetLocationY(udg_BirthPoint[1]))
        call UnitAddAbility( udg_PlayerHeroes[i+6], 'Asud' )
        call UnitAddAbility( udg_PlayerHeroes[i+6], 'Aall' )
        call AddUnitToStock( udg_PlayerHeroes[i+6], 'n00D', 1, 1)
        call UnitMakeAbilityPermanent( udg_PlayerHeroes[i+6], true, 'Asud' )
        call UnitMakeAbilityPermanent( udg_PlayerHeroes[i+6], true, 'Aall' )
        call ModifyHeroSkillPoints( udg_PlayerHeroes[i+6], bj_MODIFYMETHOD_SET, 0 )
        call PauseUnit(udg_PlayerHeroes[i+6],false)
        set udg_PlayerHeroesBan[i+6]= udg_PlayerHeroes[i+6]
        set udg_PlayerHeroes[i+6] = null
    //===
    set i=i+1
    endloop
    
    call TimerStart(t,3.50,false,function KeepOnResetCamera)    
    call CSS_ExitCameraSetting(GetLocalPlayer())
    call TriggerExecute( gg_trg_Game_Start )

set t = null
endfunction

//===========================================================================
function InitTrig_CSS_Ban_Mode_Step2 takes nothing returns nothing
    set gg_trg_CSS_Ban_Mode_Step2 = CreateTrigger(  )
    call TriggerAddAction( gg_trg_CSS_Ban_Mode_Step2, function Trig_CSS_Ban_Mode_Step2_Actions )
endfunction

//===========================================================================
// Trigger: CSS Ban Pick
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_CSS_Ban_Pick_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetSoldUnit()) == 'n00D'
endfunction

function Trig_CSS_Ban_Pick_Actions takes nothing returns nothing
local player PLY = GetOwningPlayer(GetSoldUnit())
local unit caster = GetTriggerUnit()
local integer i = GetPlayerId(PLY)
local integer n
if PLY == udg_PlayerA[0] or PLY == udg_PlayerB[0] then
    set PLY = null
    return
endif
if udg_PlayerHeroes[i]==null then
    call RescueUnitBJ( caster, PLY, true )
    set udg_PlayerHeroes[i]=caster
    call SetUnitUserData(caster,0)
    set udg_PlayerName[i] = udg_PlayerColors[i] + GetPlayerName(Player(i)) + "|r"
    call SetPlayerName( PLY , GetPlayerName(PLY) + "（" + GetHeroProperName(udg_PlayerHeroes[i]) + "）" )
    set udg_PN[i] = udg_PlayerColors[i] + GetPlayerName(Player(i)) + "|r"
    call TriggerRegisterUnitEvent( gg_trg_CE_Input, udg_PlayerHeroes[ (i)], EVENT_UNIT_DAMAGED )
    call UnitRemoveAbility( udg_PlayerHeroes[i], 'Asud' )
    call UnitRemoveAbility( udg_PlayerHeroes[i], 'Aall' )
    call ModifyHeroSkillPoints( udg_PlayerHeroes[i], bj_MODIFYMETHOD_SET, 1 )
    //注册技能
    set n = LoadInteger(udg_ht,GetHandleId(caster),0)
    call FlushChildHashtable(udg_ht,GetHandleId(caster))
    call TriggerExecute(udg_HeroInit[n])
    //call SetUnitPropWindow(udg_PlayerHeroes[i],GetUnitDefaultPropWindow(udg_PlayerHeroes[i]))
    call TriggerExecute( gg_trg_Setup_Game_Info_Board )
endif
set PLY = null
set caster = null
endfunction

//===========================================================================
function InitTrig_CSS_Ban_Pick takes nothing returns nothing
    set gg_trg_CSS_Ban_Pick = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_CSS_Ban_Pick, EVENT_PLAYER_UNIT_SELL )
    call TriggerAddCondition( gg_trg_CSS_Ban_Pick, Condition( function Trig_CSS_Ban_Pick_Conditions ) )
    call TriggerAddAction( gg_trg_CSS_Ban_Pick, function Trig_CSS_Ban_Pick_Actions )
endfunction

//===========================================================================
// Trigger: CSS Action
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0

function InitTrig_CSS_Action takes nothing returns nothing
endfunction

function CSS_Click_Actions takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local trackable icon = GetTriggeringTrackable()
    local integer c
    local integer offset = 0
    local player who
    local integer index
    //========
    
    //查找是那个屏幕的点击 
    set c = 0
    loop
        exitwhen udg_CSS_Triggers[c]==trg
        set c = c + 1
        exitwhen c > 7
    endloop
    if c > 7 then
        set trg = null
        set icon = null
        return
    endif
    
    set who = GetSortedPlayer(c)
    set offset = c*200
    
    //是否是禁止点击
    if udg_CSS_register[6]==1 or udg_CSS_register[8+c]==1 then
        set trg = null
        set icon = null
        return
    endif
    
    //查找按的是那个键 
    set index = 0
    loop
        exitwhen udg_CSS_Buttons[offset+index]==icon
        set index = index + 1
        exitwhen index > 199
    endloop
    if index >= 199 then
        set trg = null
        set icon = null
        return
    endif
    
    //特殊处理流程
    if IsBanMode() and index == 0 then
        set trg = null
        set icon = null
        return
    elseif IsBanMode() and index == 100 and udg_PlayerHeroList[GetPlayerId(who)] == 0 then
        set trg = null
        set icon = null
        return
    elseif CSS_Click_Actions_Ban(who,c,index) then
        set trg = null
        set icon = null
        return
    endif
    
    //如果是准备完毕键 
    if index == 100 then
        if udg_PlayerHeroList[GetPlayerId(who)]>=0 then
            if udg_PlayerHeroList[GetPlayerId(who)]==0 then
                call CSS_SetCharacterDisplay(who,0)
            endif
            call CSS_SetPlayerPrepared(who,not udg_CSS_Prepared[c])
            call DisableTrigger( udg_CSS_Triggers[c] )//禁止准备完毕玩家点击
        endif
        set trg = null
        set icon = null
        return
    endif
    
    //如果是选英雄键
    if CSS_SelectCharacter(who,index,true) then
        call CSS_AddClickFeedback(c,index,udg_CSS_Item[5])
        if IsOneShotMode() then
            call CSS_SetPlayerPrepared(who,true)
            call DisableTrigger( udg_CSS_Triggers[c] )//禁止准备完毕玩家点击
        endif
    endif
    
    //========
    set trg = null
    set icon = null
endfunction
//===========================================================================
// Trigger: CSS Setup
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 选人系统--系统出入,建立与运行
// udg_CSS_register[0] 是否启动
// udg_CSS_register[1] ~ udg_CSS_register[4] 传递参数用
// udg_CSS_register[5] 是否已经生成OB观看的屏幕
// udg_CSS_register[6] 禁止全部点击的Flag
// udg_CSS_register[7] 特殊模式的节点记录
//===========================================================================
//TESH.scrollpos=12
//TESH.alwaysfold=0

//玩家选择界面
function CSS_SetupForOnlinePlayer takes nothing returns nothing
    local player who = GetEnumPlayer()
    local integer c = GetSortedPlayerId(who)
    local rect q = udg_CSS_Areas[c]
    local real ox = GetRectCenterX(q)
    local real oy = GetRectCenterY(q)
    local real px
    local real py
    local real z = udg_CSS_register[59]
    local integer i
    local integer index
    local trackable icon
    local trigger trg
    local unit u
    
    set u = CreateUnit(who,'n003',ox+16.0,oy,270.0)
    call SelectUnitForPlayerSingle(u,who)
    set udg_PlayerHeroes[GetPlayerId(who)] = u
    
    //镜头
    call SetCameraTargetControllerNoZForPlayer(who,u,0,0,false)
    call DestroyFogModifier(udg_CSS_FM[c])
    set udg_CSS_FM[c] = CreateFogModifierRect(who,FOG_OF_WAR_VISIBLE,q,true,true)
    call FogModifierStart(udg_CSS_FM[c])
    
    //创建背景
    set px = ox + 32.0
    set py = oy - 128.0
    call CreateDeadDestructableZ(udg_CSS_Item[0],px,py,-3500,40.0,2.5,0) 
    
    //创建玩家英雄位
    set i = 0
    loop
        set px = ox + CSS_GetSlotIconX(i)
        set py = oy + CSS_GetSlotIconY(i)
        call CreateDestructableZ(udg_CSS_Item[1],px,py,z-24.0,180.0,1.25,0)
        set i = i + 1
        exitwhen i>7
    endloop
    
    //创建图标按钮与点击响应触发 
    set trg = CreateTrigger()
    call TriggerAddAction(trg,function CSS_Click_Actions)
    set udg_CSS_Triggers[c] = trg
    
    //TeamA
    set i = 1
    loop
        exitwhen i > udg_HeroType[0]
        set index = i + 0
        set px = ox - 320.0 - 128.0*((i-1)-(i-1)/5*5)
        set py = oy + 384.0 - 128.0*((i-1)/5)
        set icon = CSS_AddCharacterIcon(c,index,px,py)
        call TriggerRegisterTrackableHitEvent(trg,icon)
        set i = i + 1
    endloop
    
    //TeamB
    set i = 1
    loop
        exitwhen i > udg_HeroType[100] 
        set index = i + 100
        set px = ox + 320.0 + 128.0*((i-1)-(i-1)/5*5)
        set py = oy + 384.0 - 128.0*((i-1)/5)
        set icon = CSS_AddCharacterIcon(c,index,px,py)
        call TriggerRegisterTrackableHitEvent(trg,icon)
        set i = i + 1
    endloop
    
    //随机键 
    set px = ox
    set py = oy + 384.0
    set icon = CSS_AddRandomIcon(c,px,py)
    call TriggerRegisterTrackableHitEvent(trg,icon)
    
    //准备键
    set px = ox + 512.0
    set py = oy - 384.0
    set icon = CSS_AddOkIcon(c,px,py)
    call TriggerRegisterTrackableHitEvent(trg,icon)
    
    set who = null
    set trg = null
    set icon = null
    set u = null
    set q = null
endfunction

//教练监督观看界面
function CSS_SetupForSupervisor takes nothing returns nothing
    local player who = GetEnumPlayer()
    local integer c = GetSortedPlayerId(who)
    local rect q = udg_CSS_Areas[c]
    local real ox = GetRectCenterX(q)
    local real oy = GetRectCenterY(q)
    local real px
    local real py
    local real z = udg_CSS_register[59]
    local integer i
    local integer index
    local trackable icon
    //local trigger trg
    local unit u
    
    set u = CreateUnit(who,'n003',ox+16.0,oy,270.0)
    call SelectUnitForPlayerSingle(u,who)
    set udg_PlayerHeroes[GetPlayerId(who)] = u
    
    //镜头
    call SetCameraTargetControllerNoZForPlayer(who,u,0,0,false)
    call DestroyFogModifier(udg_CSS_FM[c])
    set udg_CSS_FM[c] = CreateFogModifierRect(who,FOG_OF_WAR_VISIBLE,q,true,true)
    call FogModifierStart(udg_CSS_FM[c])
    
    //创建背景
    set px = ox + 32.0
    set py = oy - 128.0
    call CreateDeadDestructableZ(udg_CSS_Item[0],px,py,-3500,40.0,2.5,0) 
    
    //创建玩家英雄位
    set i = 0
    loop
        set px = ox + CSS_GetSlotIconX(i)
        set py = oy + CSS_GetSlotIconY(i)
        call CreateDestructableZ(udg_CSS_Item[1],px,py,z-24.0,180.0,1.25,0)
        set i = i + 1
        exitwhen i>7
    endloop
    
    //创建图标按钮与点击响应触发 
    //set trg = CreateTrigger()
    //call TriggerAddAction(trg,function CSS_Click_Actions)
    //set udg_CSS_Triggers[c] = trg
    
    //TeamA
    set i = 1
    loop
        exitwhen i > udg_HeroType[0]
        set index = i + 0
        set px = ox - 320.0 - 128.0*((i-1)-(i-1)/5*5)
        set py = oy + 384.0 - 128.0*((i-1)/5)
        set icon = CSS_AddCharacterIcon(c,index,px,py)
        //call TriggerRegisterTrackableHitEvent(trg,icon)
        set i = i + 1
    endloop
    
    //TeamB
    set i = 1
    loop
        exitwhen i > udg_HeroType[100] 
        set index = i + 100
        set px = ox + 320.0 + 128.0*((i-1)-(i-1)/5*5)
        set py = oy + 384.0 - 128.0*((i-1)/5)
        set icon = CSS_AddCharacterIcon(c,index,px,py)
        //call TriggerRegisterTrackableHitEvent(trg,icon)
        set i = i + 1
    endloop
    
    //随机键 
    set px = ox
    set py = oy + 384.0
    set icon = CSS_AddRandomIcon(c,px,py)
    //call TriggerRegisterTrackableHitEvent(trg,icon)
    
    //准备键
    //set px = ox + 512.0
    //set py = oy - 384.0
    //set icon = CSS_AddOkIcon(c,px,py)
    //call TriggerRegisterTrackableHitEvent(trg,icon)
    
    set who = null
    //set trg = null
    set icon = null
    set u = null
    set q = null
endfunction

//观察者界面
function CSS_SetupForOB takes nothing returns nothing
    local player who = GetEnumPlayer()
    local unit u
    local rect w = udg_CSS_Areas[10]
    local real ox = GetRectCenterX(w)
    local real oy = GetRectCenterY(w)
    local real px
    local real py
    local real z = udg_CSS_register[59]
    local integer i
    local integer index
    local trackable icon
    
    if Boolean(udg_CSS_register[5]) then
        set u = udg_PlayerHeroes[15]
        //call SelectUnitForPlayerSingle(u,who)
        //镜头
        call SetCameraTargetControllerNoZForPlayer(who,u,0,0,false)
        set udg_CSS_FM[14] = CreateFogModifierRect(who,FOG_OF_WAR_VISIBLE,w,true,true)
        call FogModifierStart(udg_CSS_FM[14])
        if who == GetLocalPlayer() then
            call PanCameraToTimed(ox,oy,0.0)
        endif
        set u = null
        set w = null
        set icon = null
        return
    endif
    
    call DebugMsg("生成OB界面")
    
    set u = CreateUnit(Player(15),'n003',ox+16.0,oy,270.0)
    call SelectUnitForPlayerSingle(u,who)
    set udg_PlayerHeroes[15] = u
    
    //镜头
    call SetCameraTargetControllerNoZForPlayer(who,u,0,0,false)
    set udg_CSS_FM[15] = CreateFogModifierRect(who,FOG_OF_WAR_VISIBLE,w,true,true)
    call FogModifierStart(udg_CSS_FM[15])
    
    //创建背景
    set px = ox + 32.0
    set py = oy - 128.0
    call CreateDeadDestructableZ(udg_CSS_Item[0],px,py,-3500,40.0,2.5,0)
    
    //创建玩家英雄位
    set i = 0
    loop
        set px = ox + CSS_GetSlotIconX(i)
        set py = oy + CSS_GetSlotIconY(i)
        call CreateDestructableZ(udg_CSS_Item[1],px,py,z-24.0,180.0,1.25,0)
        set i = i + 1
        exitwhen i>7
    endloop
    
    //TeamA
    set i = 1
    loop
        exitwhen i > udg_HeroType[0]
        set index = i + 0
        set px = ox - 320.0 - 128.0*((i-1)-(i-1)/5*5)
        set py = oy + 384.0 - 128.0*((i-1)/5)
        set icon = CSS_AddCharacterIcon(15,index,px,py)
        set i = i + 1
    endloop
    
    //TeamB
    set i = 1
    loop
        exitwhen i > udg_HeroType[100] 
        set index = i + 100
        set px = ox + 320.0 + 128.0*((i-1)-(i-1)/5*5)
        set py = oy + 384.0 - 128.0*((i-1)/5)
        set icon = CSS_AddCharacterIcon(15,index,px,py)
        set i = i + 1
    endloop
    
    set udg_CSS_register[5] = 1
    
    if who == GetLocalPlayer() then
        call PanCameraToTimed(ox,oy,0.0)
    endif
    
    set who = null
    set icon = null
    set w = null
    set u = null
endfunction

//选人开始动作
function Trig_CSS_Enter_Actions takes nothing returns nothing
    local timer t
    local timerdialog w
    local string msg
    
    //========
    
    if udg_CSS_register[0]==1 then
        set t = null
        set w = null
        return
    endif
    set udg_CSS_register[0] = 1
    
    //========
    
    set udg_CSS_register[5] = 0
    call SetTerrainFogEx( 0, 30000.0, 30000.0, 0.5, 1.000, 1.000, 1.000 ) //设置地图迷雾
    call ForForce(udg_OnlinePlayers,function CSS_SetupForOnlinePlayer) //生成玩家选择界面
    call ForForce(udg_TeamS,function CSS_SetupForSupervisor) //生成教练界面
    call ForForce(udg_TeamOB,function CSS_SetupForOB) //生成观察者界面
    
    call DebugMsg("界面生成完毕")
    
    //========
    
    //主处理任务
    set udg_CSS_Timers[0] = CreateTimer()
    call TimerStart(udg_CSS_Timers[0],0.01,true,function CSS_Main)
    
    //udg_CSS_TimeSetting[1]游戏开始倒计时
    set udg_CSS_Timers[1] = CreateTimer()
    set t = udg_CSS_Timers[1]
    call TimerStart(t,udg_CSS_TimeSetting[1],false,function CSS_Finish)
    call PauseTimer(t)
    set w = CreateTimerDialog(t)
    set udg_MainTimerWindow = w
    call TimerDialogSetTitle(w,"游戏开始倒计时")
    call TimerDialogDisplay(w,false)
    
    //udg_CSS_TimeSetting[0]人物选择时间
    set udg_CSS_Timers[2] = CreateTimer()
    set t = udg_CSS_Timers[2]
    
    if IsBanMode() then
        call TimerStart(t,udg_CSS_TimeSetting[2],false,function CSS_BanTimeOut)
    else
        call TimerStart(t,udg_CSS_TimeSetting[0],false,function CSS_TimeOut)
    endif
    
    set w = CreateTimerDialog(t)
    set udg_SelectTimerWindow = w
    call TimerDialogSetTitle(w,"人物选择时间")
    call TimerDialogDisplay(w,true)
    set udg_CSS_register[4] = 0
    
    //AI选人
    set udg_CSS_Timers[3] = CreateTimer()
    
    //========
    
    if IsBanMode() then
        set udg_CSS_register[6] = 0
        set udg_CSS_register[7] = 1
        set msg = "请" + PlayerName(GetSortedPlayer(CSS_Click_Actions_Ban_PlayerOrder(0)))
        set msg = msg + "选择一个需要禁止使用的角色----"
        call BroadcastMessage(msg)
        set msg = null
    else
        if IsAllRandom() then
            set udg_CSS_register[6] = 1
            call CSS_FillRandomCharacters()
        else
            set udg_CSS_register[6] = 0
            call TriggerExecute(gg_trg_CSS_AI)
        endif
    endif
    
    //========
    
    set t = null
    set w = null
endfunction

function InitTrig_CSS_Setup takes nothing returns nothing
    set gg_trg_CSS_Setup = CreateTrigger()
    call TriggerAddAction( gg_trg_CSS_Setup, function Trig_CSS_Enter_Actions )
endfunction
//===========================================================================
// Trigger: CSS AI
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 选人系统--电脑玩家选人
// 通过调用抽象动作完成。
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0

function CSS_AIPlayerSelection_Loop takes nothing returns nothing
    local player who = GetEnumPlayer()
    local integer d = udg_AI_Characters[GetPlayerId(who)]
    if udg_OnlinePlayerSum - CSS_GetPreparedPlayerSum() <= udg_AI_DataBase[0] then
        if udg_PlayerHeroList[GetPlayerId(who)] == 0 then
            if d>0 then
                call CSS_SelectCharacter(who,d,false)
            else
                call CSS_SelectCharacter(who,-1,false)
            endif
        endif
        if udg_CSS_Prepared[GetSortedPlayerId(who)] == false then
            call CSS_SetPlayerPrepared(who,true)
        endif
    else
        if GetRandomReal(0,100)>50.0 then
            if d>0 then
                call CSS_SelectCharacter(who,d,false)
            else
                call CSS_SelectCharacter(who,-1,false)
            endif
        endif
    endif
    set who = null
endfunction

function CSS_AIPlayerSelection_Main takes nothing returns nothing
    call ForForce(udg_AI_Players,function CSS_AIPlayerSelection_Loop)
endfunction

function Trig_CSS_AI_Actions takes nothing returns nothing
    local integer sum = CountAIPlayerSum()
    local integer i
    
    if udg_CSS_register[0]==0 then
        return
    endif    
    
    set i = 0
    loop
        set udg_AI_Characters[i] = CSS_GetCharacterID(udg_AI_Characters[i])
        set i = i + 1
        exitwhen i>=12
    endloop
    
    call TriggerSleepAction(2.0)
    if sum > 0 then
        call TimerStart(udg_CSS_Timers[3],0.5,true,function CSS_AIPlayerSelection_Main)
    endif
endfunction

//===========================================================================
function InitTrig_CSS_AI takes nothing returns nothing
    set gg_trg_CSS_AI = CreateTrigger()
    call TriggerAddAction( gg_trg_CSS_AI, function Trig_CSS_AI_Actions )
endfunction
//===========================================================================
// Trigger: CSS Finish
//
// 选人完毕
//===========================================================================
function Trig_CSS_Finish_Func003A takes nothing returns nothing
    call SetCameraBoundsToRectForPlayerBJ( GetEnumPlayer(), udg_MapRegion )
endfunction

function Trig_CSS_Finish_Func004A takes nothing returns nothing
    local player who = GetEnumPlayer()
    local integer i = GetPlayerId(who)
    local unit h = udg_PlayerHeroes[i]
    local integer index = udg_PlayerHeroList[i]
    if IsPlayerInForce(who,udg_TeamA) then
        call SetUnitPositionLoc(h,udg_BirthPoint[0])
    else
        call SetUnitPositionLoc(h,udg_BirthPoint[1])
    endif
    call PauseUnit(h,false)
    call SetUnitUserData(h,0)
    set udg_PlayerName[i] = udg_PlayerColors[i] + GetPlayerName(Player(i)) + "|r"
    call SetPlayerName( who , GetPlayerName(who) + "（" + GetHeroProperName(udg_PlayerHeroes[i]) + "）" )
    set udg_PN[i] = udg_PlayerColors[i] + GetPlayerName(Player(i)) + "|r"
    call TriggerRegisterUnitEvent( gg_trg_CE_Input, udg_PlayerHeroes[ (i)], EVENT_UNIT_DAMAGED )
    set who = null
    set h = null
endfunction

function Trig_CSS_Finish_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    call ClearTextMessagesBJ( GetPlayersAll() )
    call ForForce( GetPlayersAll(), function Trig_CSS_Finish_Func003A )
    call ForForce( udg_OnlinePlayers, function Trig_CSS_Finish_Func004A )
    call CSS_ExitCameraSetting(GetLocalPlayer())
    call TimerStart(t,3.50,false,function KeepOnResetCamera)
    call TriggerExecute( gg_trg_Game_Start )
    set t = null
endfunction

//===========================================================================
function InitTrig_CSS_Finish takes nothing returns nothing
    set gg_trg_CSS_Finish = CreateTrigger(  )
    call TriggerAddAction( gg_trg_CSS_Finish, function Trig_CSS_Finish_Actions )
endfunction

//===========================================================================
// Trigger: GIB
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 信息面板--杂项函数
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
/////////////////////////////////////////////////////////////////////////////
//    THDOTA-0.800 for Warcraft 1.24b                                      //
//    Rewritten by HJISTC (System based on THDOTA-0.670 written by Chen)   //
//    If you have any Problem or Suggestion                                //
//    Please visit "http://www.thdota.org/bbs/"                            //
/////////////////////////////////////////////////////////////////////////////

function InitTrig_GIB takes nothing returns nothing
endfunction

//各信息在多面板的位置 
function GIB_COLUMN_NAME takes nothing returns integer
    return 0
endfunction
function GIB_COLUMN_CHARACTER takes nothing returns integer
    return 1
endfunction
function GIB_COLUMN_FLAG_KILL takes nothing returns integer
    return 2
endfunction
function GIB_COLUMN_FLAG_DEATH takes nothing returns integer
    return 3
endfunction
function GIB_COLUMN_FLAG_ASSIST takes nothing returns integer
    return 4
endfunction
function GIB_COLUMN_REVIVE takes nothing returns integer
    return 5
endfunction
function GIB_COLUMN_TOWER takes nothing returns integer
    return 5
endfunction

//多面板赋值
function GIB_SetPlayerField takes player who,integer column,string text returns nothing
    local integer row = udg_GIB_PlayerRow[8+GetPlayerId(who)]
    local multiboarditem field = MultiboardGetItem(udg_GIB,row,column)
    call MultiboardSetItemValue(field,text)
    set field = null
endfunction//===========================================================================
// Trigger: Setup Game Info Board
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 信息面板--计分表主体
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
/////////////////////////////////////////////////////////////////////////////
//    THDOTA-0.800 for Warcraft 1.24b                                      //
//    Rewritten by HJISTC (System based on THDOTA-0.670 written by Chen)   //
//    If you have any Problem or Suggestion                                //
//    Please visit "http://www.thdota.org/bbs/"                            //
/////////////////////////////////////////////////////////////////////////////
function Trig_Setup_Game_Info_Board_Actions takes nothing returns nothing
    local multiboard board
    local multiboarditem field
    local integer row = 0
    local integer column = 0
    local real array w
    local integer i
    local player who
    local unit h
    local string line = "|cffffcc00───────────────────────────────────────────────────────|r"
    local string PCNameA = "|cffffff33====|r " + PlayerName(udg_PlayerA[0]) + " |cffffff33====|r" //电脑玩家A 
    local string PCNameB = "|cffffff33====|r " + PlayerName(udg_PlayerB[0]) + " |cffffff33====|r" //电脑玩家B 
    //========
    
    set w[0] = 0.07//多面板表格间隔距离 
    set w[1] = 0.09//多面板表格间隔距离 
    set w[2] = 0.03//多面板表格间隔距离 
    set w[3] = 0.03//多面板表格间隔距离 
    set w[4] = 0.03//多面板表格间隔距离
    set w[5] = 0.04//多面板表格间隔距离   
    
    call MultiboardSuppressDisplay(true)
    
    if udg_GIB == null then
        set board = CreateMultiboard()
    else
        set board = udg_GIB
    endif
    
    call MultiboardSetTitleText(board,"|cffffcc00游戏信息|r")//此处信息被信仰显示系统覆盖 
    call MultiboardDisplay(board,true)
    set udg_GIB = board
    
    call MultiboardSetRowCount(board,6 + udg_OnlinePlayerSum)//多面板行数 
    call MultiboardSetColumnCount(board,6)//多面板列数 
    //========
    
    //项目 
    set row = 0
    set column = 0
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,"|cffffcc00玩家|r")
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,"|cffffcc00角色|r")
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,"|cffffcc00战绩|r")
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,"|cffffcc00败绩|r")
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,"|cffffcc00协力|r")
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,"|cffffcc00复活|r")
    //========
    
    //分割线 
    set row = row + 1
    set column = 0
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,0.4)
    call MultiboardSetItemValue(field,line)//-------------------------------- 
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,0.0)
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,0.0)
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,0.0)
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,0.0)
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,0.0)
    //========
    
    //博丽神社 
    set row = row + 1
    set column = 0
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,PCNameA)
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,w[column])
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,"|cffffcc000|r")
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,w[column])
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,udg_PlayerColors[4] + "剩余塔数：|r")
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,"11")
    set udg_GIB_PlayerRow[8+GetPlayerId(udg_PlayerA[0])] = row
    //========
    
    //博丽神社英雄 
    set i = 0
    loop
        set who = GetSortedPlayer(i)
        if GetPlayerSlotState(who) != PLAYER_SLOT_STATE_EMPTY then
    //{
    set h = udg_PlayerHeroes[GetPlayerId(who)]
    set row = row + 1
    set column = 0
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,udg_PlayerName[GetPlayerId(who)])
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,true)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,GetHeroProperName(h))
    call MultiboardSetItemIcon(field,udg_HeroIcon[GetHeroIndex(GetUnitTypeId(h))])
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,I2S(0))
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,I2S(0))
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,I2S(0))
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,"    -")
    set udg_GIB_PlayerRow[8+GetPlayerId(who)] = row
    //}
        endif
        set i = i + 1
        exitwhen i>3
    endloop
    //========
    
    //守矢神社 
    set row = row + 1
    set column = 0
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,PCNameB)
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,w[column])
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,"|cffffcc000|r")
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,w[column])
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,udg_PlayerColors[10] + "剩余塔数：|r")
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,"12")
    set udg_GIB_PlayerRow[8+GetPlayerId(udg_PlayerB[0])] = row
    //========
    
    //守矢神社英雄 
    set i = 4
    loop
        set who = GetSortedPlayer(i)
        if GetPlayerSlotState(who) != PLAYER_SLOT_STATE_EMPTY then
    //{
    set h = udg_PlayerHeroes[GetPlayerId(who)]
    set row = row + 1
    set column = 0
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,udg_PlayerName[GetPlayerId(who)])
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,true)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,GetHeroProperName(h))
    call MultiboardSetItemIcon(field,udg_HeroIcon[GetHeroIndex(GetUnitTypeId(h))])
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,I2S(0))
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,I2S(0))
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,I2S(0))
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,"    -   ")
    set udg_GIB_PlayerRow[8+GetPlayerId(who)] = row
    //}
        endif
        set i = i + 1
        exitwhen i>7
    endloop
    //========
    
    //分割线 
    set row = row + 1
    set column = 0
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,0.4)
    call MultiboardSetItemValue(field,line)//--------------------------------
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,0.0)
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,0.0)
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,0.0)
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,0.0)
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,0.0)
    //========
    
    //信仰显示(在GIB Clock中每秒刷新显示)
    set row = row + 1
    set column = 0
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,"|cffffffff信仰：|r")
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column])
    call MultiboardSetItemValue(field,udg_PlayerColors[4] + "博丽神社:       " + "|r" + I2S(udg_ScoreSpirit[4]))
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,true,false)
    call MultiboardSetItemWidth(field,w[column-1])
    call MultiboardSetItemValue(field,udg_PlayerColors[10] + "守失神社:       " + "|r" + I2S(udg_ScoreSpirit[10]))
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,0.0)
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,0.0)
    set column = column + 1
    set field = MultiboardGetItem(board,row,column)
    call MultiboardSetItemStyle(field,false,false)
    call MultiboardSetItemWidth(field,0.0)
    set udg_GIB_PlayerRow[0] = row
   
    //========
    call MultiboardSuppressDisplay(false)//是否显示多面板 
    call MultiboardMinimize(board,true)//初始最小化多面板 
    set board = null
    set field = null
    set h = null
endfunction

//===========================================================================
function InitTrig_Setup_Game_Info_Board takes nothing returns nothing
    set gg_trg_Setup_Game_Info_Board = CreateTrigger()
    call TriggerAddAction( gg_trg_Setup_Game_Info_Board, function Trig_Setup_Game_Info_Board_Actions )
endfunction//===========================================================================
// Trigger: Set GIB Clock
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 信息面板--标题时间显示，刷新信仰显示
//===========================================================================
//TESH.scrollpos=32
//TESH.alwaysfold=0
/////////////////////////////////////////////////////////////////////////////
//    THDOTA-0.800 for Warcraft 1.24b                                      //
//    Rewritten by HJISTC (System based on THDOTA-0.670 written by Chen)   //
//    If you have any Problem or Suggestion                                //
//    Please visit "http://www.thdota.org/bbs/"                            //
/////////////////////////////////////////////////////////////////////////////

function Trig_Set_GIB_Clock_Actions takes nothing returns nothing
    local string str
    local integer h = udg_GameTime/3600
    local integer m = udg_GameTime/60
    local integer s = udg_GameTime
    local string a = ""
    //========
    set m = m - (m/60)*60
    set s = s - (s/60)*60
    if h>0 then
        set a = a + I2S(h)
        set a = a + ":"
        if m>=10 then
            set a = a + I2S(m)
        else
            set a = a + "0" + I2S(m)
        endif
        set a = a + ":"
        if s>=10 then
            set a = a + I2S(s)
        else
            set a = a + "0" + I2S(s)
        endif
    else
        set a = a + I2S(m)
        set a = a + ":"
        if s>=10 then
            set a = a + I2S(s)
        else
            set a = a + "0" + I2S(s)
        endif
    endif
    //========刷新时间
    set str = "|cffffcc00信息面板|r / "
    set str = str + "|cffffcc00游戏时间：|r  "
    set str = str + a
    call MultiboardSetTitleText(udg_GIB,str)
    
    //========刷新信仰
    set str = udg_PlayerColors[5] + "博丽神社:       " + "|r" + I2S(udg_ScoreSpirit[4])
    call MultiboardSetItemValue(MultiboardGetItem(udg_GIB,udg_GIB_PlayerRow[0],1),str)
    
    set str = udg_PlayerColors[10] + "守失神社:       " + "|r" + I2S(udg_ScoreSpirit[10])
    call MultiboardSetItemValue(MultiboardGetItem(udg_GIB,udg_GIB_PlayerRow[0],2),str)
endfunction

//===========================================================================
function InitTrig_Set_GIB_Clock takes nothing returns nothing
    set gg_trg_Set_GIB_Clock = CreateTrigger()
    call TriggerAddAction( gg_trg_Set_GIB_Clock, function Trig_Set_GIB_Clock_Actions )
endfunction
//===========================================================================
// Trigger: Resource System
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function THD_SyncSpirit_A takes nothing returns nothing
    call SetPlayerStateBJ( GetEnumPlayer(), PLAYER_STATE_RESOURCE_LUMBER, udg_ScoreSpirit[4] )
endfunction

function THD_SyncSpirit_B takes nothing returns nothing
    call SetPlayerStateBJ( GetEnumPlayer(), PLAYER_STATE_RESOURCE_LUMBER, udg_ScoreSpirit[10] )
endfunction

//同步信仰点的显示
function THD_SyncSpirit takes nothing returns nothing
    call ForForce(udg_TeamA,function THD_SyncSpirit_A )
    call SetPlayerStateBJ(udg_PlayerA[0], PLAYER_STATE_RESOURCE_LUMBER, udg_ScoreSpirit[4] )
    call ForForce(udg_TeamB,function THD_SyncSpirit_B )
    call SetPlayerStateBJ(udg_PlayerB[0], PLAYER_STATE_RESOURCE_LUMBER, udg_ScoreSpirit[10] )
endfunction

//信仰
function THD_AddSpirit takes player who,integer amount returns nothing
    if IsPlayerAlly(who,udg_PlayerA[0]) then
        set udg_ScoreSpirit[4] = udg_ScoreSpirit[4] + amount
    elseif IsPlayerAlly(who,udg_PlayerB[0]) then
        set udg_ScoreSpirit[10] = udg_ScoreSpirit[10] + amount
    endif
    call THD_SyncSpirit()
endfunction

function THD_GetSpirit takes player who returns integer
    if IsPlayerAlly(who,udg_PlayerA[0]) then
        return udg_ScoreSpirit[4]
    endif
    if IsPlayerAlly(who,udg_PlayerB[0]) then
        return udg_ScoreSpirit[10]
    endif
    return 0
endfunction

//点
function THD_AddCredit takes player who,integer amount returns nothing
    if amount>0 then
        call SetPlayerState(who,PLAYER_STATE_GOLD_GATHERED,GetPlayerState(who,PLAYER_STATE_GOLD_GATHERED) + amount)
    endif
    call SetPlayerState(who,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(who,PLAYER_STATE_RESOURCE_GOLD) + amount)
endfunction

function THD_GetCredit takes player who returns integer
    return GetPlayerState(who,PLAYER_STATE_RESOURCE_GOLD)
endfunction

//===========================================================================
function InitTrig_Resource_System takes nothing returns nothing
    //set gg_trg_Resource_System = CreateTrigger()
    //call TriggerAddAction( gg_trg_Resource_System, function Trig_Resource_System_Actions )
endfunction
//===========================================================================
// Trigger: Spirit
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
//===========================================================================
function Trig_Spirit_Conditions takes nothing returns boolean
    if ( not ( IsUnitEnemy(GetKillingUnitBJ(), GetTriggerPlayer()) == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Spirit_Func001Func002C takes nothing returns boolean
    if ( not ( IsUnitType(GetDyingUnit(), UNIT_TYPE_STRUCTURE) == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Spirit_Func001C takes nothing returns boolean
    if ( not ( IsUnitType(GetDyingUnit(), UNIT_TYPE_HERO) == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Spirit_Actions takes nothing returns nothing
    if ( Trig_Spirit_Func001C() ) then
        call THD_AddSpirit(GetOwningPlayer(GetKillingUnit()),udg_GameSetting_Spirit[2])
    else
        if ( Trig_Spirit_Func001Func002C() ) then
            call THD_AddSpirit(GetOwningPlayer(GetKillingUnit()),udg_GameSetting_Spirit[1])
        else
            call DoNothing(  )
        endif
    endif
endfunction

//===========================================================================
function InitTrig_Spirit takes nothing returns nothing
    set gg_trg_Spirit = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Spirit, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_Spirit, Condition( function Trig_Spirit_Conditions ) )
    call TriggerAddAction( gg_trg_Spirit, function Trig_Spirit_Actions )
endfunction

//===========================================================================
// Trigger: Power Create
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Power_Create_Conditions takes nothing returns boolean
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_TAUREN) then
        return false
    endif
    if IsUnitSpawn(GetTriggerUnit())==false then
        return false
    endif
    return GetRandomReal(0,100)<=5.0
endfunction

function Trig_Power_Create_Actions takes nothing returns nothing
    local unit u = GetTriggerUnit()
    call CreateItem('I03H',GetUnitX(u),GetUnitY(u))
    set u = null
endfunction

//===========================================================================
function InitTrig_Power_Create takes nothing returns nothing
    set gg_trg_Power_Create = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Power_Create, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_Power_Create, Condition( function Trig_Power_Create_Conditions ) )
    call TriggerAddAction( gg_trg_Power_Create, function Trig_Power_Create_Actions )
endfunction
//===========================================================================
// Trigger: Power Get
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 删除掉落的Power
// (1.24的物品拾取后使用其实没有消失)
// 其实ItemClear触发里每60秒也会删除一次
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0

function Trig_Power_Main_Conditions takes nothing returns boolean
    return GetItemTypeId(GetManipulatedItem())=='I03H' and IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)
endfunction

function Trig_Power_Main_Actions takes nothing returns nothing
    local unit h = GetTriggerUnit()
    local player who = GetOwningPlayer(h)
    local integer i = GetPlayerId(who) + 1
    local integer c = GetHeroMainProperty(h)
    local integer d = udg_PlayerPower[i]
    
    call RemoveItem(GetManipulatedItem())
    
    if d<30 then
        set udg_PlayerPower[i] = d + 1
        if c == HERO_TYPE_STR() then
            call SetHeroStr(h,GetHeroStr(h,false)+1,true)
        elseif c == HERO_TYPE_AGI() then
            call SetHeroAgi(h,GetHeroAgi(h,false)+1,true)
        elseif c == HERO_TYPE_INT() then
            call SetHeroInt(h,GetHeroInt(h,false)+1,true)
        endif
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIlm\\AIlmTarget.mdl",h,"origin"))
    else
        //call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\HealingSalve\\HealingSalveTarget.mdl",h,"origin"))
        //call THD_AddSpirit(who,1)
    endif
    
    set h = null
    set who = null
endfunction

//===========================================================================
function InitTrig_Power_Get takes nothing returns nothing
    set gg_trg_Power_Get = CreateTrigger()
    //在GameStart中添加事件
    call TriggerAddCondition( gg_trg_Power_Get, Condition( function Trig_Power_Main_Conditions ) )
    call TriggerAddAction( gg_trg_Power_Get, function Trig_Power_Main_Actions )
endfunction
//===========================================================================
// Trigger: Power Lost
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 删除Power增加的属性在HeroEvent触发的Hero Recovery函数里
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Power_Lost_Conditions takes nothing returns boolean
    if IsUnitIllusion(GetTriggerUnit()) then
        return false
    endif
    return IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)
endfunction

function Trig_Power_Lost_Actions takes nothing returns nothing
    local unit h = GetTriggerUnit()
    local player who = GetOwningPlayer(h)
    local real x = GetUnitX(h)
    local real y = GetUnitY(h)
    local integer i = GetPlayerId(who) + 1
    local integer d = udg_PlayerPower[i]
    local integer c = GetHeroMainProperty(h)
    
    set udg_PlayerPower[i] = 0
    
    if c == HERO_TYPE_STR() then
        call SetHeroStr(h,GetHeroStr(h,false)-d,true)
    elseif c == HERO_TYPE_AGI() then
        call SetHeroAgi(h,GetHeroAgi(h,false)-d,true)
    elseif c == HERO_TYPE_INT() then
        call SetHeroInt(h,GetHeroInt(h,false)-d,true)
    endif
    
    set d = d/3
    loop
        exitwhen d<=0
        call CreateItem('I03H',x,y)
        set d = d - 1
    endloop
    
    set h = null
    set who = null
endfunction

//===========================================================================
function InitTrig_Power_Lost takes nothing returns nothing
    set gg_trg_Power_Lost = CreateTrigger()
    //在GameStart中添加事件
    call TriggerAddCondition( gg_trg_Power_Lost, Condition( function Trig_Power_Lost_Conditions ) )
    call TriggerAddAction( gg_trg_Power_Lost, function Trig_Power_Lost_Actions )
endfunction
//===========================================================================
// Trigger: Initialization Spawn
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 刷兵系统--刷兵位置初始化设置
// SpawnLocA[0]=博丽神社主基地上方兵营   /  SpawnLocB[0]=守失神社分基地兵营
// SpawnLocA[1]=博丽神社主基地下方兵营   /  SpawnLocB[1]=守失神社主基地上方兵营
// SpawnLocA[2]=博丽神社分基地兵营       /  SpawnLocB[2]=守失神社主基地下方兵营
// SpawnLocA[3]=目标守失神社             /  SpawnLocB[3]=目标博丽神社
//===========================================================================
function Trig_Initialization_Spawn_Actions takes nothing returns nothing
    call TriggerExecute( gg_trg_Route_A )
    call TriggerExecute( gg_trg_Route_B )
    // ========
    set udg_SpawnLocA[0] = GetRectCenter(gg_rct_SpawnA0)
    set udg_SpawnLocA[1] = GetRectCenter(gg_rct_SpawnA1)
    set udg_SpawnLocA[2] = GetRectCenter(gg_rct_SpawnA2)
    set udg_SpawnLocA[3] = GetRectCenter(gg_rct_BaseA)
    // ========
    set udg_SpawnLocB[0] = GetRectCenter(gg_rct_SpawnB0)
    set udg_SpawnLocB[1] = GetRectCenter(gg_rct_SpawnB1)
    set udg_SpawnLocB[2] = GetRectCenter(gg_rct_SpawnB2)
    set udg_SpawnLocB[3] = GetRectCenter(gg_rct_BaseB)
endfunction

//===========================================================================
function InitTrig_Initialization_Spawn takes nothing returns nothing
    set gg_trg_Initialization_Spawn = CreateTrigger(  )
    call DisableTrigger( gg_trg_Initialization_Spawn )
    call TriggerAddAction( gg_trg_Initialization_Spawn, function Trig_Initialization_Spawn_Actions )
endfunction

//===========================================================================
// Trigger: Route A
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 刷兵系统--博丽神社部队路径点设置
// 每路最多支持16个路径点
//===========================================================================
function Trig_Route_A_Actions takes nothing returns nothing
    local integer i = 0
    local integer j = 0
    //  
    // ========
    set j = 0
    // ========
    //  
    set i = 0
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_BaseA)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_0_0)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_0_1)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_0_2)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_0_3)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_0_4)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_0_5)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_BaseB)
    //  
    // ========
    set j = 1
    // ========
    //  
    set i = 0
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_BaseA)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_1_0)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_1_1)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_1_2)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_1_3)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_1_4)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_1_5)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_BaseB)
    //  
    // ========
    set j = 2
    // ========
    //  
    set i = 0
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_BaseA)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_2_0)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_2_1)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_2_2)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_2_3)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_2_4)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_2_5)
    set i = i + 1
    set udg_SpawnRouteA[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_BaseB)
    // ========
endfunction

//===========================================================================
function InitTrig_Route_A takes nothing returns nothing
    set gg_trg_Route_A = CreateTrigger(  )
    call DisableTrigger( gg_trg_Route_A )
    call TriggerAddAction( gg_trg_Route_A, function Trig_Route_A_Actions )
endfunction

//===========================================================================
// Trigger: Route B
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 刷兵系统--守失神社部队路径点设置
// 每路最多支持16个路径点
//===========================================================================
function Trig_Route_B_Actions takes nothing returns nothing
    local integer i = 0
    local integer j = 0
    //  
    // ========
    set j = 0
    // ========
    //  
    set i = 0
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_BaseB)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_0_5)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_0_4)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_0_3)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_0_2)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_0_1)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_0_0)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_BaseA)
    //  
    // ========
    set j = 1
    // ========
    //  
    set i = 0
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_BaseB)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_1_5)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_1_4)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_1_3)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_1_2)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_1_1)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_1_0)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_BaseA)
    //  
    // ========
    set j = 2
    // ========
    //  
    set i = 0
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_BaseB)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_2_5)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_2_4)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_2_3)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_2_2)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_2_1)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_WayPoint_2_0)
    set i = i + 1
    set udg_SpawnRouteB[( (  (j) * 16 ) +  (i) )] = GetRectCenter(gg_rct_BaseA)
    // ========
endfunction

//===========================================================================
function InitTrig_Route_B takes nothing returns nothing
    set gg_trg_Route_B = CreateTrigger(  )
    call DisableTrigger( gg_trg_Route_B )
    call TriggerAddAction( gg_trg_Route_B, function Trig_Route_B_Actions )
endfunction

//===========================================================================
// Trigger: Route Order
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 刷兵系统--部队按路径行动
//===========================================================================
//TESH.scrollpos=107
//TESH.alwaysfold=0

//设置单位路径记录(用技能等级判断走过的路径数目)
function SetUnitWaypointRecord takes unit u,integer value returns nothing
    call SetUnitAbilityLevel(u,'A008',1 + value - value/10*10)
    call SetUnitAbilityLevel(u,'A009',1 + value/10)
endfunction

//添加路径记录(一个无用的技能)
function AddUnitWaypointRecord takes unit u,integer value returns nothing
    call UnitAddAbility(u,'A008')
    call UnitAddAbility(u,'A009')
    call SetUnitWaypointRecord(u,value)
endfunction

//获取单位剩余路径记录(无用技能的等级)
function GetUnitWaypointRecord takes unit u returns integer
    return GetUnitAbilityLevel(u,'A008') - 1 + 10*(GetUnitAbilityLevel(u,'A009') - 1)
endfunction

//博丽神社部队发布动作
function SpawnIssueOrderA takes unit u returns nothing
    local integer i = GetUnitWaypointRecord(u)
    local integer waypoint = i - i/16*16
    local location p
    if udg_SpawnRouteA[i + 1] != null and waypoint <= 15 then
        set p = udg_SpawnRouteA[i + 1]
    else
        set p = udg_SpawnRouteA[i]
    endif

    call IssuePointOrderLoc(u,"attack",p)
    set p = null
endfunction


//守失神社部队发布动作
function SpawnIssueOrderB takes unit u returns nothing
    local integer i = GetUnitWaypointRecord(u)
    local integer waypoint = i - i/16*16
    local location p
    if udg_SpawnRouteB[i + 1] != null and waypoint <= 15 then
        set p = udg_SpawnRouteB[i + 1]
    else
        set p = udg_SpawnRouteB[i]
    endif

    call IssuePointOrderLoc(u,"attack",p)
    set p = null
endfunction

//博丽神社部队动作
function Trig_WayPointA_Actions takes nothing returns nothing
    local unit u = GetEnteringUnit()
    local location p = GetUnitLoc(u)
    local integer i
    local integer route = GetUnitWaypointRecord(u)/16
    
    set i = 0
    loop
        if udg_SpawnRouteA[i] != null then
            exitwhen DistanceBetweenPoints(udg_SpawnRouteA[i],p)<400
        endif
        set i = i + 1
        exitwhen i > 47
    endloop
    call RemoveLocation(p)
    
    if route==i/16 and i<48 then
        call SetUnitWaypointRecord(u,i)
        call SpawnIssueOrderA(u)
    endif
    
    set p = null
    set u = null
endfunction

//守失神社部队动作
function Trig_WayPointB_Actions takes nothing returns nothing
    local unit u = GetEnteringUnit()
    local location p = GetUnitLoc(u)
    local integer i
    local integer route = GetUnitWaypointRecord(u)/16
    
    set i = 0
    loop
        if udg_SpawnRouteB[i] != null then
            exitwhen DistanceBetweenPoints(udg_SpawnRouteB[i],p)<400
        endif
        set i = i + 1
        exitwhen i > 47
    endloop
    call RemoveLocation(p)
    
    if route==i/16 and i<48 then
        call SetUnitWaypointRecord(u,i)
        call SpawnIssueOrderB(u)
    endif
    
    set p = null
    set u = null
endfunction

//判断是否是博丽神社部队
function Trig_Route_Order_A_Filter takes nothing returns boolean
    return IsUnitOwnedByPlayer(GetFilterUnit(),udg_PlayerA[0])
endfunction


//判断是否是守失神社部队
function Trig_Route_Order_B_Filter takes nothing returns boolean
    return IsUnitOwnedByPlayer(GetFilterUnit(),udg_PlayerB[0])
endfunction


function Trig_Route_Order_Actions takes nothing returns nothing
    local trigger trg
    local integer i
    local integer j
    local location p
    local unit u
    local boolexpr f
    
    //========
    
    set trg = CreateTrigger()
    set f = Filter(function Trig_Route_Order_A_Filter)
    set j = 0
    loop
        set i = 0
        loop
            set p = udg_SpawnRouteA[j*16+i]
            exitwhen p == null
            set u = CreateUnitAtLoc(Player(15),'n004',p,270.0) //路径记录点
            call TriggerRegisterUnitInRange(trg,u,270.0,f)
            set i = i + 1
            exitwhen i>15
        endloop
        set j = j + 1
        exitwhen j>2
    endloop
    call TriggerAddAction(trg,function Trig_WayPointA_Actions)
    
    //========
    
    set trg = CreateTrigger()
    set f = Filter(function Trig_Route_Order_B_Filter)
    set j = 0
    loop
        set i = 0
        loop
            set p = udg_SpawnRouteB[j*16+i]
            exitwhen p == null
            set u = CreateUnitAtLoc(Player(15),'n004',p,270.0) //路径记录点
            call TriggerRegisterUnitInRange(trg,u,270.0,f)
            set i = i + 1
            exitwhen i>15
        endloop
        set j = j + 1
        exitwhen j>2
    endloop
    call TriggerAddAction(trg,function Trig_WayPointB_Actions)
    
    //========
    
    set trg = null
    set u = null
    set p = null
    set f = null
endfunction

//===========================================================================
function InitTrig_Route_Order takes nothing returns nothing
    set gg_trg_Route_Order = CreateTrigger()
    call TriggerAddAction( gg_trg_Route_Order, function Trig_Route_Order_Actions )
endfunction//===========================================================================
// Trigger: Keep Order A
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 刷兵系统--部队按路径行动--防止返回
//===========================================================================
function Trig_Keep_Order_A_Conditions takes nothing returns boolean
    if ( not ( GetIssuedOrderIdBJ() == String2OrderIdBJ("move") ) ) then
        return false
    endif
    return true
endfunction

function Trig_Keep_Order_A_Actions takes nothing returns nothing
    call SpawnIssueOrderA(GetTriggerUnit())
endfunction

//===========================================================================
function InitTrig_Keep_Order_A takes nothing returns nothing
    set gg_trg_Keep_Order_A = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Keep_Order_A, Condition( function Trig_Keep_Order_A_Conditions ) )
    call TriggerAddAction( gg_trg_Keep_Order_A, function Trig_Keep_Order_A_Actions )
endfunction

//===========================================================================
// Trigger: Keep Order B
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 刷兵系统--部队按路径行动--防止返回
//===========================================================================
function Trig_Keep_Order_B_Conditions takes nothing returns boolean
    if ( not ( GetIssuedOrderIdBJ() == String2OrderIdBJ("move") ) ) then
        return false
    endif
    return true
endfunction

function Trig_Keep_Order_B_Actions takes nothing returns nothing
    call SpawnIssueOrderB(GetTriggerUnit())
endfunction

//===========================================================================
function InitTrig_Keep_Order_B takes nothing returns nothing
    set gg_trg_Keep_Order_B = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Keep_Order_B, Condition( function Trig_Keep_Order_B_Conditions ) )
    call TriggerAddAction( gg_trg_Keep_Order_B, function Trig_Keep_Order_B_Actions )
endfunction

//===========================================================================
// Trigger: Spawn A
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 刷兵系统--博丽神社刷兵并移动开始
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
/////////////////////////////////////////////////////////////////////////////
//    THDOTA-0.800 for Warcraft 1.24b                                      //
//    Rewritten by HJISTC (System based on THDOTA-0.670 written by Chen)   //
//    If you have any Problem or Suggestion                                //
//    Please visit "http://www.thdota.org/bbs/"                            //
/////////////////////////////////////////////////////////////////////////////

function Trig_Spawn_A_Actions takes nothing returns nothing
    local integer route
    local integer t
    local integer n
    local unit u
    local player who = udg_PlayerA[0]
    local real facing = 45.0
    local integer array order
    local integer i
    
    set order[0] = 2
    set order[1] = 0
    set order[2] = 1
    
    //========
    
    set i = 0
    loop
        
        set route = order[i]
         
        set t = 0
        set n = udg_SU_No_A[t]
        loop
            exitwhen n==0
            set u = CreateUnitAtLoc(who,udg_SU_ID_A[t],udg_SpawnLocA[3],facing)
            call AddUnitWaypointRecord(u,route*16)
            call SetUnitColor( u, PLAYER_COLOR_RED )
            call SetUnitPositionLoc(u,udg_SpawnLocA[route])
            call SpawnIssueOrderA(u)
            set n = n - 1
        endloop
        
        call TriggerSleepAction(1.0)
        
        set t = 1
        set n = udg_SU_No_A[t]
        loop
            exitwhen n==0
            set u = CreateUnitAtLoc(who,udg_SU_ID_A[t],udg_SpawnLocA[3],facing)
            call AddUnitWaypointRecord(u,route*16)
            call SetUnitColor( u, PLAYER_COLOR_RED )
            call SetUnitPositionLoc(u,udg_SpawnLocA[route])
            call SpawnIssueOrderA(u)
            set n = n - 1
        endloop
        
        set t = 2
        set n = udg_SU_No_A[t]
        loop
            exitwhen n==0
            set u = CreateUnitAtLoc(who,udg_SU_ID_A[t],udg_SpawnLocA[3],facing)
            call AddUnitWaypointRecord(u,route*16)
            call SetUnitColor( u, PLAYER_COLOR_RED )
            call SetUnitPositionLoc(u,udg_SpawnLocA[route])
            call SpawnIssueOrderA(u)
            set n = n - 1
        endloop
        
        call TriggerSleepAction(1.0)
        
        set i = i + 1
        exitwhen i > 2
    endloop
    
    //========

    set who = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Spawn_A takes nothing returns nothing
    set gg_trg_Spawn_A = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Spawn_A, function Trig_Spawn_A_Actions )
endfunction//===========================================================================
// Trigger: Spawn B
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 刷兵系统--守失神社刷兵并移动开始
//===========================================================================
//TESH.scrollpos=10
//TESH.alwaysfold=0
/////////////////////////////////////////////////////////////////////////////
//    THDOTA-0.800 for Warcraft 1.24b                                      //
//    Rewritten by HJISTC (System based on THDOTA-0.670 written by Chen)   //
//    If you have any Problem or Suggestion                                //
//    Please visit "http://www.thdota.org/bbs/"                            //
/////////////////////////////////////////////////////////////////////////////

function Trig_Spawn_B_Actions takes nothing returns nothing
    local integer route
    local integer t
    local integer n
    local unit u
    local player who = udg_PlayerB[0]
    local real facing = 225.0
    local integer array order
    local integer i
    
    set order[0] = 1
    set order[1] = 0
    set order[2] = 2
    
    //========
    
    set i = 0
    loop
        
        set route = order[i]
         
        set t = 0
        set n = udg_SU_No_B[t]
        loop
            exitwhen n==0
            set u = CreateUnitAtLoc(who,udg_SU_ID_B[t],udg_SpawnLocB[3],facing)
            call AddUnitWaypointRecord(u,route*16)
            call SetUnitPositionLoc(u,udg_SpawnLocB[route])
            call SpawnIssueOrderB(u)
            set n = n - 1
        endloop

        call TriggerSleepAction(1.0)
        
        set t = 1
        set n = udg_SU_No_B[t]
        loop
            exitwhen n==0
            set u = CreateUnitAtLoc(who,udg_SU_ID_B[t],udg_SpawnLocB[3],facing)
            call AddUnitWaypointRecord(u,route*16)
            call SetUnitPositionLoc(u,udg_SpawnLocB[route])
            call SpawnIssueOrderB(u)
            set n = n - 1
        endloop

        set t = 2
        set n = udg_SU_No_B[t]
        loop
            exitwhen n==0
            set u = CreateUnitAtLoc(who,udg_SU_ID_B[t],udg_SpawnLocB[3],facing)
            call AddUnitWaypointRecord(u,route*16)
            call SetUnitPositionLoc(u,udg_SpawnLocB[route])
            call SpawnIssueOrderB(u)
            set n = n - 1
        endloop

        call TriggerSleepAction(1.0)
        
        set i = i + 1
        exitwhen i > 2
    endloop
    
    //========
    
    set who = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Spawn_B takes nothing returns nothing
    set gg_trg_Spawn_B = CreateTrigger()
    call TriggerAddAction( gg_trg_Spawn_B, function Trig_Spawn_B_Actions )
endfunction//===========================================================================
// Trigger: Spawn Levelup
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0

function Trig_Spawn_Levelup_Actions takes nothing returns nothing
    call SetPlayerTechResearched( udg_PlayerA[0], 'R003', GetPlayerTechCount(udg_PlayerA[0],'R003',true) + 1 )
    call SetPlayerTechResearched( udg_PlayerA[0], 'R002', GetPlayerTechCount(udg_PlayerA[0],'R002',true) + 1 )
    call SetPlayerTechResearched( udg_PlayerB[0], 'R003', GetPlayerTechCount(udg_PlayerB[0],'R003',true) + 1 )
    call SetPlayerTechResearched( udg_PlayerB[0], 'R002', GetPlayerTechCount(udg_PlayerB[0],'R002',true) + 1 )
    call SetPlayerTechResearched( Player(PLAYER_NEUTRAL_AGGRESSIVE), 'Rhme', GetPlayerTechCount(Player(PLAYER_NEUTRAL_AGGRESSIVE),'Rhme',true) + 1)
    call SetPlayerTechResearched( Player(PLAYER_NEUTRAL_AGGRESSIVE), 'Rhar', GetPlayerTechCount(Player(PLAYER_NEUTRAL_AGGRESSIVE),'Rhar',true) + 1)
    call SetPlayerTechResearched( Player(PLAYER_NEUTRAL_AGGRESSIVE), 'Rhde', GetPlayerTechCount(Player(PLAYER_NEUTRAL_AGGRESSIVE),'Rhde',true) + 1)
    if GetPlayerTechCount(udg_PlayerA[0],'R003',true) > 20 then
        call SetPlayerTechResearched( udg_PlayerA[0], 'R003', GetPlayerTechCount(udg_PlayerA[0],'R003',true) + 1 )
        call SetPlayerTechResearched( udg_PlayerA[0], 'R002', GetPlayerTechCount(udg_PlayerA[0],'R002',true) + 1 )
    endif
    if GetPlayerTechCount(udg_PlayerB[0],'R003',true) > 20 then
        call SetPlayerTechResearched( udg_PlayerB[0], 'R003', GetPlayerTechCount(udg_PlayerB[0],'R003',true) + 1 )
        call SetPlayerTechResearched( udg_PlayerB[0], 'R002', GetPlayerTechCount(udg_PlayerB[0],'R002',true) + 1 )
    endif
    if GetPlayerTechCount(udg_PlayerA[0],'R003',true) > 40 then
        call SetPlayerTechResearched( udg_PlayerA[0], 'R003', GetPlayerTechCount(udg_PlayerA[0],'R003',true) + 1 )
        call SetPlayerTechResearched( udg_PlayerA[0], 'R002', GetPlayerTechCount(udg_PlayerA[0],'R002',true) + 1 )
    endif
    if GetPlayerTechCount(udg_PlayerB[0],'R003',true) > 40 then
        call SetPlayerTechResearched( udg_PlayerB[0], 'R003', GetPlayerTechCount(udg_PlayerB[0],'R003',true) + 1 )
        call SetPlayerTechResearched( udg_PlayerB[0], 'R002', GetPlayerTechCount(udg_PlayerB[0],'R002',true) + 1 )
    endif
    if GetPlayerTechCount(udg_PlayerA[0],'R003',true) > 60 then
        call SetPlayerTechResearched( udg_PlayerA[0], 'R003', GetPlayerTechCount(udg_PlayerA[0],'R003',true) + 1 )
        call SetPlayerTechResearched( udg_PlayerA[0], 'R002', GetPlayerTechCount(udg_PlayerA[0],'R002',true) + 1 )
    endif
    if GetPlayerTechCount(udg_PlayerB[0],'R003',true) > 60 then
        call SetPlayerTechResearched( udg_PlayerB[0], 'R003', GetPlayerTechCount(udg_PlayerB[0],'R003',true) + 1 )
        call SetPlayerTechResearched( udg_PlayerB[0], 'R002', GetPlayerTechCount(udg_PlayerB[0],'R002',true) + 1 )
    endif
endfunction

//===========================================================================
function InitTrig_Spawn_Levelup takes nothing returns nothing
    set gg_trg_Spawn_Levelup = CreateTrigger()
    call TriggerAddAction( gg_trg_Spawn_Levelup, function Trig_Spawn_Levelup_Actions )
endfunction//===========================================================================
// Trigger: Spawn Units AI
//
// //=====================================================================================//
// //    1.需要自己完成DefaultAttack函数的内容，让小兵按照之前的路线继续前进              //
// //    2.只有攻击目标处于小兵主动攻击范围内才会攻击，所以最好把近战小兵改成500，远程700 //
// //    3.Lowlife函数设置低血量优先被攻击的百分比                                        //
// //    4.AttackMaxTime函数设置追击时间，即发生更换目标后N秒回复之前的攻击路线           //
// //    5.如果有没有顾及到的地方，可以手动调用UnitAttackAim(小兵，攻击目标)              //
// //=====================================================================================//
// udg_NPC_AttackMaxTime = 3
// udg_NPC_Lowlife = 0.2
// udg_NPC_GetCycle = 0.33
// globals
//     unit array attackArrayUnit
//     unit array attackArrayAim
//     real array attackArrayTime
//     integer array attackArrayNext
//     integer attackArrayTop = 1
//     integer attackArrayEnd = 0
//     integer cycleIndex
//     timer cycleTimer
// endglobals
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function THD_ResetSpawnUnitOrder takes unit u returns nothing
    if GetOwningPlayer(u) == udg_PlayerA[0] then 
        call SpawnIssueOrderA(u)
    elseif GetOwningPlayer(u) == udg_PlayerB[0] then
        call SpawnIssueOrderB(u)
    endif
endfunction

function GetNow takes nothing returns real
    return udg_NPC_cycleIndex * udg_NPC_GetCycle + TimerGetElapsed(udg_NPC_cycleTimer)
endfunction

function UnitAttackAim takes unit u,unit aim returns nothing
    local integer i = 0
    if(IsUnitInRange(aim,u,GetUnitDefaultAcquireRange(u)))then
        loop
            exitwhen udg_NPC_attackArrayNext[i] == 0
            if(udg_NPC_attackArrayUnit[udg_NPC_attackArrayNext[i]] == u)then
                if(udg_NPC_attackArrayAim[udg_NPC_attackArrayNext[i]] == aim)then
                    if(udg_NPC_attackArrayNext[i] != udg_NPC_attackArrayEnd)then
                        set udg_NPC_attackArrayNext[udg_NPC_attackArrayEnd] = udg_NPC_attackArrayNext[i]
                        set udg_NPC_attackArrayEnd = udg_NPC_attackArrayNext[i]
                        set udg_NPC_attackArrayNext[i] = udg_NPC_attackArrayNext[udg_NPC_attackArrayEnd]
                        set udg_NPC_attackArrayNext[udg_NPC_attackArrayEnd] = 0
                    endif
                    set udg_NPC_attackArrayTime[udg_NPC_attackArrayEnd] = GetNow()
                endif
                return
            endif
            set i = udg_NPC_attackArrayNext[i]
        endloop
        set udg_NPC_attackArrayNext[udg_NPC_attackArrayEnd] = udg_NPC_attackArrayTop
        set udg_NPC_attackArrayEnd = udg_NPC_attackArrayTop
        if(udg_NPC_attackArrayNext[udg_NPC_attackArrayTop] == 0)then
            set udg_NPC_attackArrayTop = udg_NPC_attackArrayTop + 1
        else
            set udg_NPC_attackArrayTop = udg_NPC_attackArrayNext[udg_NPC_attackArrayTop]
        endif
        set udg_NPC_attackArrayUnit[udg_NPC_attackArrayEnd] = u
        set udg_NPC_attackArrayAim[udg_NPC_attackArrayEnd] = aim
        set udg_NPC_attackArrayNext[udg_NPC_attackArrayEnd] = 0
        set udg_NPC_attackArrayTime[udg_NPC_attackArrayEnd] = GetNow()
        call IssueTargetOrderById(u,851983,aim)
    endif
endfunction

function Cycle takes nothing returns nothing//循环计时器
    local real lowtime
    local integer i
    set udg_NPC_cycleIndex = udg_NPC_cycleIndex + 1
    set lowtime = GetNow() - udg_NPC_AttackMaxTime 
    loop
        set i = udg_NPC_attackArrayNext[0]
        exitwhen i == 0
        if(IsUnitType(udg_NPC_attackArrayUnit[i],UNIT_TYPE_DEAD) or IsUnitType(udg_NPC_attackArrayAim[i],UNIT_TYPE_DEAD) or udg_NPC_attackArrayTime[i] < lowtime)then
            set udg_NPC_attackArrayNext[0] = udg_NPC_attackArrayNext[i]
            set udg_NPC_attackArrayNext[i] = udg_NPC_attackArrayTop
            set udg_NPC_attackArrayTop = i
            if(IsUnitType(udg_NPC_attackArrayUnit[i],UNIT_TYPE_DEAD) == false)then
                call THD_ResetSpawnUnitOrder(udg_NPC_attackArrayUnit[i])
            endif
            set udg_NPC_attackArrayUnit[i] = null
            set udg_NPC_attackArrayAim[i] = null
        else
            exitwhen true
        endif
    endloop
    if(i == 0)then
        set udg_NPC_attackArrayEnd = 0
    endif
endfunction

function LowlifeNear takes nothing returns boolean
    local unit u = LoadUnitHandle(udg_Hashtable,GetHandleId(GetTriggeringTrigger()),StringHash("unit"))
    local real life = GetUnitState(u,UNIT_STATE_LIFE)
    if(life > 0.0 and life < GetUnitState(u,UNIT_STATE_MAX_LIFE) * udg_NPC_Lowlife and IsUnitEnemy(u,GetOwningPlayer(GetTriggerUnit())))then
        call UnitAttackAim(GetTriggerUnit(),u)
    endif
    set u = null
    return false
endfunction

function HeroInGame takes nothing returns boolean
    local unit u = GetEnteringUnit()
    local trigger t
    if(IsUnitType(u,UNIT_TYPE_HERO) and IsUnitIllusion(u) == false)then
        set t = CreateTrigger()
        call SaveUnitHandle(udg_Hashtable,GetHandleId(t),StringHash("unit"),u)
        call TriggerAddCondition(t,Condition(function LowlifeNear))
        call TriggerRegisterUnitInRange(t,u,700,null)
        call TriggerRegisterUnitInRange(t,u,400,null)
    endif
    set u = null
    set t = null
    return false
endfunction

function LowlifeAttack takes nothing returns boolean
    local group g
    local player p
    local unit u2
    local unit u = GetTriggerUnit()
    local real life = GetUnitState(u,UNIT_STATE_LIFE) - GetEventDamage()
    if(life > 0.0 and life < GetUnitState(u,UNIT_STATE_MAX_LIFE) * udg_NPC_Lowlife)then
        if(IsUnitAlly(u,Player(0)))then
            set p = Player(6)
        else
            set p = Player(0)
        endif
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),800,null)
        loop
            set u2 = FirstOfGroup(g)
            exitwhen u2 == null
            if(GetOwningPlayer(u2) == p)then
                call UnitAttackAim(u2,u)
            endif
            call GroupRemoveUnit(g,u2)
        endloop
        call DestroyGroup(g)
    endif
    set u = null
    set p = null
    set g = null
    set u2 = null
    return false
endfunction

function AegisHero takes nothing returns boolean
    local unit attacker
    local unit attacked
    local group g
    local player who
    if(GetTriggerEventId() == EVENT_PLAYER_UNIT_ATTACKED)then
        set attacker = GetAttacker()
        set attacked = GetTriggerUnit()
    elseif(GetIssuedOrderId() == 851983 or GetIssuedOrderId() == 851971)then
        set attacker = GetTriggerUnit()
        set attacked = GetOrderTargetUnit()
    else
        set attacker = null
        set attacked = null
        set g = null
        set who = null
        return false
    endif
    if(IsUnitType(attacked,UNIT_TYPE_HERO) and IsUnitEnemy(attacker,GetOwningPlayer(attacked)))then
        if IsUnitAlly(attacker,udg_PlayerA[0]) then
            set who = udg_PlayerB[0]
        else
            set who = udg_PlayerA[0]
        endif
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,GetUnitX(attacker),GetUnitY(attacker),800.0,null)
        loop
            set attacked = FirstOfGroup(g)
            exitwhen attacked == null
            call GroupRemoveUnit(g,attacked)
            if(GetOwningPlayer(attacked)==who)then
                call UnitAttackAim(attacked,attacker)
            endif
        endloop
        call DestroyGroup(g)
    endif
    set attacker = null
    set attacked = null
    set g = null
    set who = null
    return false
endfunction

function Trig_Spawn_Units_AI_Init takes nothing returns nothing
    local trigger trg
    
    set udg_NPC_AttackMaxTime = 3
    set udg_NPC_Lowlife = -1.0
    set udg_NPC_GetCycle = 0.33
    
    set udg_NPC_cycleIndex = 0
    set udg_NPC_cycleTimer = CreateTimer()
    call TimerStart(udg_NPC_cycleTimer,udg_NPC_GetCycle,true,function Cycle)
    
    //set trg = CreateTrigger()
    //call TriggerAddCondition(trg,Condition(function LowlifeAttack))
    //call RegisterAnyUnitDamage(trg)
    
    set trg = CreateTrigger()
    call TriggerAddCondition(trg,Condition(function HeroInGame))
    call TriggerRegisterEnterRectSimple(trg,bj_mapInitialPlayableArea)
    
    set gg_trg_Spawn_Units_AI = CreateTrigger()
    call TriggerAddCondition(gg_trg_Spawn_Units_AI,Condition(function AegisHero))
    call TriggerRegisterAnyUnitEventBJ(gg_trg_Spawn_Units_AI,EVENT_PLAYER_UNIT_ATTACKED)
    call TriggerRegisterAnyUnitEventBJ(gg_trg_Spawn_Units_AI,EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER)
    
    set trg = null
endfunction

//===========================================================================
function InitTrig_Spawn_Units_AI takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Refresh Order
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Refresh_Order_Filter takes nothing returns boolean
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_DEAD) then
        return false
    endif
    if IsUnitHidden(GetFilterUnit()) then
        return false
    endif
    return IsUnitSpawn(GetFilterUnit())
endfunction

function Trig_Refresh_Order_Actions takes nothing returns nothing
    local group g
    local boolexpr f = Filter(function Trig_Refresh_Order_Filter)
    local unit u
    
    set g = CreateGroup()
    call GroupEnumUnitsOfPlayer(g,udg_PlayerA[0],f)
    loop
        set u = FirstOfGroup(g)
        exitwhen u == null
        call GroupRemoveUnit(g,u)
        if GetUnitCurrentOrder(u)==0 then
            call SpawnIssueOrderA(u)
        endif
    endloop
    call DestroyGroup(g)
    
    call TriggerSleepAction(5.0)
    
    set g = CreateGroup()
    call GroupEnumUnitsOfPlayer(g,udg_PlayerB[0],f)
    loop
        set u = FirstOfGroup(g)
        exitwhen u == null
        call GroupRemoveUnit(g,u)
        if GetUnitCurrentOrder(u)==0 then
            call SpawnIssueOrderB(u)
        endif
    endloop
    call DestroyGroup(g)
    
    call DestroyBoolExpr(f)
    set g = null
    set f = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Refresh_Order takes nothing returns nothing
    set udg_NPC_cycleIndex = 0
    set gg_trg_Refresh_Order = CreateTrigger()
    call TriggerAddAction( gg_trg_Refresh_Order, function Trig_Refresh_Order_Actions )
endfunction
//===========================================================================
// Trigger: Initialization Base
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 建筑系统--相关建筑初始化设置
//===========================================================================
function Trig_Initialization_Base_Actions takes nothing returns nothing
    // 博丽神社
    // ========================
    set udg_BaseA[0] = gg_unit_h00D_0013
    // 内塔
    set udg_BaseA[1] = gg_unit_h010_0043
    set udg_BaseA[2] = null
    // 兵营
    set udg_BaseA[3] = gg_unit_h013_0052
    set udg_BaseA[4] = gg_unit_h013_0053
    set udg_BaseA[5] = gg_unit_h013_0054
    // 外塔
    set udg_BaseA[6] = gg_unit_h00Y_0050
    set udg_BaseA[8] = gg_unit_h00Y_0089
    set udg_BaseA[9] = gg_unit_h017_0107
    // 兵营塔 ----  对应兵营 3,4,5
    set udg_BaseA[10] = gg_unit_h018_0075
    set udg_BaseA[11] = gg_unit_h018_0110
    set udg_BaseA[12] = gg_unit_h018_0074
    set udg_BaseA[13] = gg_unit_h018_0109
    set udg_BaseA[14] = gg_unit_h018_0108
    set udg_BaseA[15] = gg_unit_h018_0077
    //  
    //  
    //  
    // 守矢神社
    // ========================
    set udg_BaseB[0] = gg_unit_h00U_0019
    // 内塔
    set udg_BaseB[1] = gg_unit_h00Z_0091
    set udg_BaseB[2] = gg_unit_h00Z_0092
    // 兵营
    set udg_BaseB[3] = gg_unit_h00A_0056
    set udg_BaseB[4] = gg_unit_h00A_0057
    set udg_BaseB[5] = gg_unit_h00A_0058
    // 外塔
    set udg_BaseB[6] = gg_unit_h00C_0008
    set udg_BaseB[8] = gg_unit_h00C_0042
    set udg_BaseB[9] = gg_unit_h019_0038
    // 兵营塔 ---- 对应兵营 3,4,5
    set udg_BaseB[10] = gg_unit_h016_0090
    set udg_BaseB[11] = gg_unit_h016_0023
    set udg_BaseB[12] = gg_unit_h016_0049
    set udg_BaseB[13] = gg_unit_h016_0046
    set udg_BaseB[14] = gg_unit_h016_0048
    set udg_BaseB[15] = gg_unit_h016_0078
    //  
    //  
    //  
    call SetUnitInvulnerable( udg_BaseA[0], true )
    call SetUnitInvulnerable( udg_BaseA[3], true )
    call SetUnitInvulnerable( udg_BaseA[4], true )
    call SetUnitInvulnerable( udg_BaseA[5], true )
    call SetUnitInvulnerable( udg_BaseB[0], true )
    call SetUnitInvulnerable( udg_BaseB[3], true )
    call SetUnitInvulnerable( udg_BaseB[4], true )
    call SetUnitInvulnerable( udg_BaseB[5], true )
    call TriggerRegisterPlayerUnitEventSimple( gg_trg_Tower_Break_A, udg_PlayerA[0], EVENT_PLAYER_UNIT_DEATH )
    call TriggerRegisterPlayerUnitEventSimple( gg_trg_Tower_Break_B, udg_PlayerB[0], EVENT_PLAYER_UNIT_DEATH )
endfunction

//===========================================================================
function InitTrig_Initialization_Base takes nothing returns nothing
    set gg_trg_Initialization_Base = CreateTrigger(  )
    call DisableTrigger( gg_trg_Initialization_Base )
    call TriggerAddAction( gg_trg_Initialization_Base, function Trig_Initialization_Base_Actions )
endfunction

//===========================================================================
// Trigger: Tower Break A
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 建筑系统--博丽神社建筑关联
//===========================================================================
//TESH.scrollpos=18
//TESH.alwaysfold=0

function Trig_Tower_Break_A_Conditions takes nothing returns boolean
    return IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)//判断死亡单位类别建筑
endfunction

function Trig_Tower_Break_A_Actions takes nothing returns nothing
    local integer i = 1
    
    loop
        exitwhen udg_BaseA[i] == GetTriggerUnit()
        set i = i + 1
        exitwhen i>15
    endloop
    set udg_BaseA[i] = null
    
    //兵营塔爆，解兵营，如果是基地兵营的塔 会解除2个兵营
    if udg_BaseA[10]==null and udg_BaseA[11]==null then
        call SetUnitInvulnerable(udg_BaseA[3],false)
        call SetUnitInvulnerable(udg_BaseA[4],false)//另一个兵营
    endif
    if udg_BaseA[12]==null and udg_BaseA[13]==null then
        call SetUnitInvulnerable(udg_BaseA[4],false)
        call SetUnitInvulnerable(udg_BaseA[3],false)//另一个兵营
    endif
    if udg_BaseA[14]==null and udg_BaseA[15]==null then
        call SetUnitInvulnerable(udg_BaseA[5],false)
    endif
    
    //基地塔全爆，解神社无敌 
    if udg_BaseA[1] == null then
        call SetUnitInvulnerable(udg_BaseA[0],false)
    endif
    
    //兵营全爆，对手小兵科技顶级
    if udg_BaseA[3]==null and udg_BaseA[4]==null and udg_BaseA[5]==null and GetUnitTypeId(GetTriggerUnit())=='h013' then
        set udg_SU_ID_B[0]=udg_SUA_ID_B[0]//变为大兵
        set udg_SU_ID_B[1]=udg_SUA_ID_B[1]//变为大兵
        set udg_SU_ID_B[2]=udg_SUA_ID_B[2]//变为大兵
        set udg_SU_No_B[2]=udg_SU_No_B[2]+1//刷投石车数量
        //call SetPlayerTechResearched(udg_PlayerB[0],'R002',GetPlayerTechCount(udg_PlayerB[0],'R002',true)+10)
        //call SetPlayerTechResearched(udg_PlayerB[0],'R003',GetPlayerTechCount(udg_PlayerB[0],'R003',true)+10)
    endif
    
    //刷新计分表塔数显示信息
    if (i==1) or (6<=i and i<=15) then
        //全队奖励
        if i == 1 then
        call ShareGold(udg_TeamB,1000)
        call DisplayTextToForce(udg_TeamB,"|cffffcc00击败玄爷，全队平分1000点奖励！|r")       
        else
        call ShareGold(udg_TeamB,500)
        call DisplayTextToForce(udg_TeamB,"|cffffcc00攻破防线，全队平分500点奖励！|r")               
        endif
        
        set i = GetPlayerId(udg_PlayerA[0])
        set udg_FlagDeath[i] = udg_FlagDeath[i] + 1
        call GIB_SetPlayerField(udg_PlayerA[0],GIB_COLUMN_TOWER(),I2S(11 - udg_FlagDeath[i]))//计分表
    endif
    
endfunction

//===========================================================================
function InitTrig_Tower_Break_A takes nothing returns nothing
    set gg_trg_Tower_Break_A = CreateTrigger()
    call TriggerAddCondition( gg_trg_Tower_Break_A, Condition( function Trig_Tower_Break_A_Conditions ) )
    call TriggerAddAction( gg_trg_Tower_Break_A, function Trig_Tower_Break_A_Actions )
endfunction

//===========================================================================
// Trigger: Tower Break A Patch
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 建筑系统--博丽神社外兵营摧毁事件
// 增加小兵科技3级 增加投石车
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Tower_Break_A_Patch_Actions takes nothing returns nothing
    set udg_SU_No_B[2]=udg_SU_No_B[2]+1//刷投石车数量
    call SetPlayerTechResearchedSwap( 'R003', ( GetPlayerTechCountSimple('R003', udg_PlayerB[0]) + 3 ), udg_PlayerB[0] )
    call SetPlayerTechResearchedSwap( 'R002', ( GetPlayerTechCountSimple('R002', udg_PlayerB[0]) + 3 ), udg_PlayerB[0] )
endfunction

//===========================================================================
function InitTrig_Tower_Break_A_Patch takes nothing returns nothing
    set gg_trg_Tower_Break_A_Patch = CreateTrigger(  )
    call TriggerRegisterUnitEvent( gg_trg_Tower_Break_A_Patch, gg_unit_h013_0054, EVENT_UNIT_DEATH )
    call TriggerAddAction( gg_trg_Tower_Break_A_Patch, function Trig_Tower_Break_A_Patch_Actions )
endfunction

//===========================================================================
// Trigger: Tower Break B
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 建筑系统--守失神社建筑关联
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Tower_Break_B_Conditions takes nothing returns boolean
    return IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE)//判断死亡单位类别建筑
endfunction

function Trig_Tower_Break_B_Actions takes nothing returns nothing
    local integer i = 1
    
    loop
        exitwhen udg_BaseB[i] == GetTriggerUnit()
        set i = i + 1
        exitwhen i>15
    endloop
    set udg_BaseB[i] = null
    
    //兵营塔爆，解兵营，如果是基地兵营的塔 会解除2个兵营
    if udg_BaseB[10]==null and udg_BaseB[11]==null then
        call SetUnitInvulnerable(udg_BaseB[3],false)
        call SetUnitInvulnerable(udg_BaseB[4],false)//另一个兵营
    endif
    if udg_BaseB[12]==null and udg_BaseB[13]==null then
        call SetUnitInvulnerable(udg_BaseB[4],false)
        call SetUnitInvulnerable(udg_BaseB[3],false)//另一个兵营
    endif
    if udg_BaseB[14]==null and udg_BaseB[15]==null then
        call SetUnitInvulnerable(udg_BaseB[5],false)
    endif
    
    //基地塔全爆，解神社无敌 
    if udg_BaseB[1] == null and udg_BaseB[2] == null then
        call SetUnitInvulnerable(udg_BaseB[0],false)
    endif
    
    //兵营全爆，对手小兵科技顶级
    if udg_BaseB[3]==null and udg_BaseB[4]==null and udg_BaseB[5]==null and GetUnitTypeId(GetTriggerUnit())=='h00A'  then
        set udg_SU_ID_A[0]=udg_SUA_ID_A[0]//变为大兵
        set udg_SU_ID_A[1]=udg_SUA_ID_A[1]//变为大兵
        set udg_SU_ID_A[2]=udg_SUA_ID_A[2]//变为大兵
        set udg_SU_No_A[2]=udg_SU_No_A[2]+1//刷投石车数量+1
        //call SetPlayerTechResearched(udg_PlayerA[0],'R002',GetPlayerTechCount(udg_PlayerA[0],'R002',true)+10)
        //call SetPlayerTechResearched(udg_PlayerA[0],'R003',GetPlayerTechCount(udg_PlayerA[0],'R003',true)+10)
    endif
    
    //刷新计分表塔数显示信息
    if (i==1 or i==2) or (6<=i and i<=15) then
        //全队奖励
        call ShareGold(udg_TeamA,500)
        call DisplayTextToForce(udg_TeamA,"|cffffcc00攻破防线，全队平分500点奖励！|r")
    
        set i = GetPlayerId(udg_PlayerB[0])
        set udg_FlagDeath[i] = udg_FlagDeath[i] + 1
        call GIB_SetPlayerField(udg_PlayerB[0],GIB_COLUMN_TOWER(),I2S(12 - udg_FlagDeath[i]))//计分表
    endif
    
endfunction

//===========================================================================
function InitTrig_Tower_Break_B takes nothing returns nothing
    set gg_trg_Tower_Break_B = CreateTrigger()
    call TriggerAddCondition( gg_trg_Tower_Break_B, Condition( function Trig_Tower_Break_B_Conditions ) )
    call TriggerAddAction( gg_trg_Tower_Break_B, function Trig_Tower_Break_B_Actions )
endfunction

//===========================================================================
// Trigger: Tower Break B Patch
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 建筑系统--守失神社外兵营摧毁事件
// 增加小兵科技3级 增加投石车
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Tower_Break_B_Patch_Actions takes nothing returns nothing
    set udg_SU_No_A[2]=udg_SU_No_A[2]+1//刷投石车数量+1
    call SetPlayerTechResearchedSwap( 'R003', ( GetPlayerTechCountSimple('R003', udg_PlayerA[0]) + 3 ), udg_PlayerA[0] )
    call SetPlayerTechResearchedSwap( 'R002', ( GetPlayerTechCountSimple('R002', udg_PlayerA[0]) + 3 ), udg_PlayerA[0] )
endfunction

//===========================================================================
function InitTrig_Tower_Break_B_Patch takes nothing returns nothing
    set gg_trg_Tower_Break_B_Patch = CreateTrigger(  )
    call TriggerRegisterUnitEvent( gg_trg_Tower_Break_B_Patch, gg_unit_h00A_0058, EVENT_UNIT_DEATH )
    call TriggerAddAction( gg_trg_Tower_Break_B_Patch, function Trig_Tower_Break_B_Patch_Actions )
endfunction

//===========================================================================
// Trigger: Initialization Weather
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 天气系统--天气系统初始化设置
// 0.霧雨--全场回魔6/S,持续120秒.          1.红霧--全场吸血光环,15%,持续80秒.
// 2.川霧--全场所有英雄隐身40秒.           3.梅雨--全场减15血光环,持续60秒.
// 4.花曇--全场无法普通攻击持续8秒.        5.台風--全场攻击提高35%，持续20秒. 
// 6.小雪--全场减速15%，持续2分.
//===========================================================================
function Trig_Initialization_Weather_Actions takes nothing returns nothing
    // ========
    set udg_Weather_Type = -1
    set udg_Weather_Shrine = gg_unit_n000_0018
    set udg_Weather_Region = Rect(-2025.00, -18142.00, 15237.00, -2144.00)
    set udg_Weather_TriggerItem[0] = 'n02G'
    set udg_Weather_TriggerItem[1] = 'n02C'
    set udg_Weather_TriggerItem[2] = 'n02H'
    set udg_Weather_TriggerItem[3] = 'n02D'
    set udg_Weather_TriggerItem[4] = 'n02B'
    set udg_Weather_TriggerItem[5] = 'n02F'
    set udg_Weather_TriggerItem[6] = 'n02E'
    // ========
    call TriggerExecute( gg_trg_Weather_Shrine_Reset )
    call TriggerRegisterUnitEvent( gg_trg_Weather_Trigger, udg_Weather_Shrine, EVENT_UNIT_SELL )
endfunction

//===========================================================================
function InitTrig_Initialization_Weather takes nothing returns nothing
    set gg_trg_Initialization_Weather = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initialization_Weather, function Trig_Initialization_Weather_Actions )
endfunction

//===========================================================================
// Trigger: Weather Change
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 天气系统--天气迷雾转变函数
// function WeatherFogStart takes boolean startorend, real zstart2, real zend2, real density2, real red2, real green2, real blue2 returns nothing
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
//天气迷雾函数 日常迷雾<==>天气迷雾
//===========================================================================
function WeatherFogStartLoop takes nothing returns nothing
local timer t = GetExpiredTimer()
local integer task = GetHandleId(t)
local integer i = LoadInteger(udg_Hashtable,task,1)
local real zstart1 = LoadReal(udg_Hashtable,task,2)
local real zend1 = LoadReal(udg_Hashtable,task,3)
local real density1 = LoadReal(udg_Hashtable,task,4)
local real red1 = LoadReal(udg_Hashtable,task,5)
local real green1 = LoadReal(udg_Hashtable,task,6)
local real blue1 = LoadReal(udg_Hashtable,task,7)
local real zstart2
local real zend2
local real density2
local real red2
local real green2
local real blue2
local real zstartperiod = LoadReal(udg_Hashtable,task,14)
local real zendperiod = LoadReal(udg_Hashtable,task,15)
local real densityperiod = LoadReal(udg_Hashtable,task,16)
local real redperiod = LoadReal(udg_Hashtable,task,17)
local real greenperiod = LoadReal(udg_Hashtable,task,18)
local real blueperiod = LoadReal(udg_Hashtable,task,19)
local boolean startorend = LoadBoolean(udg_Hashtable,task,20)
local integer j
if i < 50 then
    if startorend == true then
    set j = i
    else
    set j = 50-i
    endif
    set i = i+1
    call SaveInteger(udg_Hashtable,task,1,i)
    call SetTerrainFogEx( 0, zstart1+j*zstartperiod, zend1+j*zendperiod, density1+j*densityperiod, red1+j*redperiod, green1+j*greenperiod, blue1+j*blueperiod )
else
    if startorend == true then
    set zstart2 = LoadReal(udg_Hashtable,task,8)
    set zend2 = LoadReal(udg_Hashtable,task,9)
    set density2 = LoadReal(udg_Hashtable,task,10)
    set red2 = LoadReal(udg_Hashtable,task,11)
    set green2 = LoadReal(udg_Hashtable,task,12)
    set blue2 = LoadReal(udg_Hashtable,task,13)
    call SetTerrainFogEx( 0, zstart2, zend2, density2, red2, green2, blue2 )
    else
    call SetTerrainFogEx( 0, zstart1, zend1, density1, red1, green1, blue1 )
    call EnableTrigger( gg_trg_Weather_Fog_System )                         //重新激活日常迷雾系统
    endif
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_Hashtable,task)
endif
set t = null
endfunction

function WeatherFogStart takes boolean startorend, real zstart2, real zend2, real density2, real red2, real green2, real blue2 returns nothing
local timer t = CreateTimer()
local integer task = GetHandleId(t)
local integer i = 0
local real daytime = GetFloatGameState(GAME_STATE_TIME_OF_DAY)
local real zstart1
local real zend1
local real density1
local real red1
local real green1
local real blue1
local real zstartperiod
local real zendperiod
local real densityperiod
local real redperiod
local real greenperiod
local real blueperiod
if daytime <= 12 then
    set zstart1 = 1000
    set zend1 = daytime*1250+3000
    set density1 = 100
    set red1 = daytime*0.08
    set green1 = daytime*0.08
    set blue1 = 0.48-daytime*0.04
else
    set daytime = daytime - 12
    set zstart1 = 1000
    set zend1 = 18000-daytime*1250
    set density1 = 100
    set red1 = 0.96-daytime*0.08
    set green1 = 0.96-daytime*0.08
    set blue1 = daytime*0.04
endif
set zstartperiod = (zstart2 - zstart1)/50
set zendperiod = (zend2 - zend1)/50
set densityperiod = (density2 - density1)/50
set redperiod = (red2 - red1)/50
set greenperiod = (green2 - green1)/50
set blueperiod = (blue2 - blue1)/50
call SaveTimerHandle(udg_Hashtable,task,0,t)
call SaveInteger(udg_Hashtable,task,1,i)
call SaveReal(udg_Hashtable,task,2,zstart1)
call SaveReal(udg_Hashtable,task,3,zend1)
call SaveReal(udg_Hashtable,task,4,density1)
call SaveReal(udg_Hashtable,task,5,red1)
call SaveReal(udg_Hashtable,task,6,green1)
call SaveReal(udg_Hashtable,task,7,blue1)
call SaveReal(udg_Hashtable,task,8,zstart2)
call SaveReal(udg_Hashtable,task,9,zend2)
call SaveReal(udg_Hashtable,task,10,density2)
call SaveReal(udg_Hashtable,task,11,red2)
call SaveReal(udg_Hashtable,task,12,green2)
call SaveReal(udg_Hashtable,task,13,blue2)
call SaveReal(udg_Hashtable,task,14,zstartperiod)
call SaveReal(udg_Hashtable,task,15,zendperiod)
call SaveReal(udg_Hashtable,task,16,densityperiod)
call SaveReal(udg_Hashtable,task,17,redperiod)
call SaveReal(udg_Hashtable,task,18,greenperiod)
call SaveReal(udg_Hashtable,task,19,blueperiod)
call SaveBoolean(udg_Hashtable,task,20,startorend)
call TimerStart(t,0.04,true,function WeatherFogStartLoop)
set t = null
endfunction

//===========================================================================
function InitTrig_Weather_Change takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Weather Fog System
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 天气系统--动态迷雾效果
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

//日常时间迷雾
function Trig_Weather_Fog_Day takes real progress returns nothing
    local real R0 = 255
    local real G0 = 255
    local real B0 = 255
    local real Z0 = 1500
    local real E0 = 3000
    local real f = Pow(Sin(progress*bj_PI),3.0)
    local real e = 1.0 - f
    local real R1 = 255
    local real G1 = 196
    local real B1 = 0
    local real Z1 = 1500
    local real E1 = 3000
    set R1 = R0*e + R1*f
    set G1 = G0*e + G1*f
    set B1 = B0*e + B1*f
    set Z1 = Z0*e + Z1*f
    set E1 = E0*e + E1*f
    call SetTerrainFogEx(0,Z1,E1,0.50,R1/255.5,G1/255.5,B1/255.5)
endfunction

function Trig_Weather_Fog_Night takes real progress returns nothing
    local real R0 = 255
    local real G0 = 255
    local real B0 = 255
    local real Z0 = 1500.0
    local real E0 = 3000.0
    local real f = Pow(Sin(progress*bj_PI),3.0)
    local real e = 1.0 - f
    local real R1 = 40
    local real G1 = 0
    local real B1 = 100
    local real Z1 = 1500.0
    local real E1 = 3000.0
    set R1 = R0*e + R1*f
    set G1 = G0*e + G1*f
    set B1 = B0*e + B1*f
    set Z1 = Z0*e + Z1*f
    set E1 = E0*e + E1*f
    call SetTerrainFogEx(0,Z1,E1,0.50,R1/255.5,G1/255.5,B1/255.5)
endfunction

function Trig_Weather_Fog_System_Actions takes nothing returns nothing
    local real daytime = GetFloatGameState(GAME_STATE_TIME_OF_DAY)
    local real progress
    if (daytime>6.0) and (daytime<=18.0) then
        set progress = (daytime - 6.0)/12.0
        call Trig_Weather_Fog_Day(progress)
    else
        if (daytime<=6.0) then
            set daytime = daytime + 24.0
        endif
        set progress = (daytime - 18.0)/12.0
        call Trig_Weather_Fog_Night(progress)
    endif
endfunction

function InitTrig_Weather_Fog_System takes nothing returns nothing
    set gg_trg_Weather_Fog_System = CreateTrigger()
    call DisableTrigger( gg_trg_Weather_Fog_System )
    call TriggerRegisterTimerEventPeriodic( gg_trg_Weather_Fog_System, 1.00 )
    call TriggerAddAction( gg_trg_Weather_Fog_System, function Trig_Weather_Fog_System_Actions )
endfunction
//===========================================================================
// Trigger: Weather Shrine Reset
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 天气系统--天气控制坛重置
//===========================================================================
function Trig_Weather_Shrine_Reset_Func003C takes nothing returns boolean
    if ( not ( udg_Weather_Type == -1 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Shrine_Reset_Actions takes nothing returns nothing
    local integer i = 0
    if ( Trig_Weather_Shrine_Reset_Func003C() ) then
        set i = 0
        loop
        exitwhen udg_Weather_TriggerItem[i]==0 or i>9
        call RemoveUnitFromStockBJ( udg_Weather_TriggerItem[ (i)], udg_Weather_Shrine )
        call AddUnitToStockBJ( udg_Weather_TriggerItem[ (i)], udg_Weather_Shrine, 1, 1 )
        set i = i + 1
        endloop
    else
        set i = 0
        loop
            exitwhen udg_Weather_TriggerItem[i]==0 or i>9
        call RemoveUnitFromStockBJ( udg_Weather_TriggerItem[ (i)], udg_Weather_Shrine )
        call AddUnitToStockBJ( udg_Weather_TriggerItem[ (i)], udg_Weather_Shrine, 0, 1 )
        set i = i + 1
        endloop
    endif
endfunction

//===========================================================================
function InitTrig_Weather_Shrine_Reset takes nothing returns nothing
    set gg_trg_Weather_Shrine_Reset = CreateTrigger(  )
    call TriggerRegisterTimerExpireEventBJ( gg_trg_Weather_Shrine_Reset, udg_Weather_Timer[1] )
    call TriggerAddAction( gg_trg_Weather_Shrine_Reset, function Trig_Weather_Shrine_Reset_Actions )
endfunction

//===========================================================================
// Trigger: Weather Trigger
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 天气系统--召唤天气触发
// 利用信仰购买天气效果
//===========================================================================
function Trig_Weather_Trigger_Conditions takes nothing returns boolean
    if ( not ( udg_Weather_Type < 0 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Trigger_Actions takes nothing returns nothing
    local unit u = GetSoldUnit()
    local player who = GetOwningPlayer(u)
    local integer ID = GetUnitTypeId(u)
    local integer j = 0
    local integer i = 0
    local integer cost = 5    //召唤天气所需要的信仰
    if ID == 'n02F' then //台风
        set cost = 5
    elseif ID == 'n02E' then //小雪
        set cost = 5
    elseif ID == 'n02C' then //紅霧
        set cost = 8
    elseif ID == 'n02G' then //霧雨
        set cost = 8
    elseif ID == 'n02D' then //梅雨
        set cost = 8
    elseif ID == 'n02H' then //川霧
        set cost = 15
    elseif ID == 'n02B' then //花曇
        set cost = 15
    endif
    call KillUnit(       (u) )
    call RemoveUnit(       (u) )
    set u = null
    // ========
    call DisableTrigger( GetTriggeringTrigger() )
    loop
        exitwhen udg_Weather_TriggerItem[i]==ID or i>9
        set i = i + 1
    endloop
    if i>9 then
        set u = null
        set who = null
        return
    endif
    // ========
    if THD_GetSpirit(who) < cost then
        call DisplayTextToPlayer(who,0,0,"信仰不足！需要" + I2S(cost) + "信仰才能获得改变天气的力量")
    call StartTimerBJ( udg_Weather_Timer[1], false, 0.01 )
    call EnableTrigger( GetTriggeringTrigger() )
    else
        call THD_AddSpirit(who,-cost)
        set udg_Weather_Type = i
    call TriggerExecute( gg_trg_Weather_Effect_Create )
    call TriggerExecute( gg_trg_Weather_Effect_Spell )
    call StartTimerBJ( udg_Weather_Timer[1], false, 0.01 )
    call EnableTrigger( GetTriggeringTrigger() )
    endif
    // ========
    set u = null
    set who = null
endfunction

//===========================================================================
function InitTrig_Weather_Trigger takes nothing returns nothing
    set gg_trg_Weather_Trigger = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Weather_Trigger, Condition( function Trig_Weather_Trigger_Conditions ) )
    call TriggerAddAction( gg_trg_Weather_Trigger, function Trig_Weather_Trigger_Actions )
endfunction

//===========================================================================
// Trigger: Weather Effect Create
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 天气系统--持续时间和大气效果
// 0.霧雨--全场回魔6/S,持续80秒.          1.红霧--全场吸血光环,15%,持续80秒.
// 2.川霧--全场所有英雄隐身40秒.           3.梅雨--全场减8血光环,持续60秒.
// 4.花曇--全场物理免疫持续25秒.            5.台風--全场攻击提高35%，持续60秒. 
// 6.小雪--全场减速15%，持续60秒.
//===========================================================================
function Trig_Weather_Effect_Create_Func007C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 0 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Create_Func009C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 1 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Create_Func011C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 2 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Create_Func013C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 3 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Create_Func015C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 4 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Create_Func017C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 5 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Create_Func019C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 6 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Create_Actions takes nothing returns nothing
    // ================================================================
    call RemoveWeatherEffect( udg_WE_FallingLeaves )
    call RemoveWeatherEffect( udg_WE_SunShine )
    call DisableTrigger( gg_trg_Weather_Fog_System )
    call PlaySoundBJ( gg_snd_Weather )
    // ================================================================
    if ( Trig_Weather_Effect_Create_Func007C() ) then
        call WeatherFogStart(true,1000,3000,50,1,1,1)
        // ========
        call AddWeatherEffectSaveLast( udg_Weather_Region, 'RLlr' )
        call EnableWeatherEffect( GetLastCreatedWeatherEffect(), true )
        set udg_Weather_Effect[0] = GetLastCreatedWeatherEffect()
        // ========
        call AddWeatherEffectSaveLast( udg_Weather_Region, 'FDwh' )
        call EnableWeatherEffect( GetLastCreatedWeatherEffect(), true )
        set udg_Weather_Effect[1] = GetLastCreatedWeatherEffect()
        // ========
        call StartTimerBJ( udg_Weather_Timer[0], false, 80.00 )
        return
    else
        call DoNothing(  )
    endif
    // ================================================================
    if ( Trig_Weather_Effect_Create_Func009C() ) then
        call WeatherFogStart(true,1000,3000,100,1,0.6,0.6)
        // ========
        call AddWeatherEffectSaveLast( udg_Weather_Region, 'FDrh' )
        call EnableWeatherEffect( GetLastCreatedWeatherEffect(), true )
        set udg_Weather_Effect[0] = GetLastCreatedWeatherEffect()
        // ========
        call StartTimerBJ( udg_Weather_Timer[0], false, 80.00 )
        return
    else
        call DoNothing(  )
    endif
    // ================================================================
    if ( Trig_Weather_Effect_Create_Func011C() ) then
        call WeatherFogStart(true,250,3000,100,1,1,1)
        // ========
        call AddWeatherEffectSaveLast( udg_Weather_Region, 'FDwh' )
        call EnableWeatherEffect( GetLastCreatedWeatherEffect(), true )
        set udg_Weather_Effect[0] = GetLastCreatedWeatherEffect()
        // ========
        call StartTimerBJ( udg_Weather_Timer[0], false, 40.00 )
        return
    else
        call DoNothing(  )
    endif
    // ================================================================
    if ( Trig_Weather_Effect_Create_Func013C() ) then
        call WeatherFogStart(true,600,3000,100,0.6,0.9,0.6)
        // ========
        call AddWeatherEffectSaveLast( udg_Weather_Region, 'RAlr' )
        call EnableWeatherEffect( GetLastCreatedWeatherEffect(), true )
        set udg_Weather_Effect[0] = GetLastCreatedWeatherEffect()
        // ========
        call StartTimerBJ( udg_Weather_Timer[0], false, 60.00 )
        return
    else
        call DoNothing(  )
    endif
    // ================================================================
    if ( Trig_Weather_Effect_Create_Func015C() ) then
        call WeatherFogStart(true,1000,3000,100,1,0.6,0.9)
        // ========
        call AddWeatherEffectSaveLast( udg_Weather_Region, 'MEds' )
        call EnableWeatherEffect( GetLastCreatedWeatherEffect(), true )
        set udg_Weather_Effect[0] = GetLastCreatedWeatherEffect()
        // ========
        call StartTimerBJ( udg_Weather_Timer[0], false, 25.00 )
        return
    else
        call DoNothing(  )
    endif
    // ================================================================
    if ( Trig_Weather_Effect_Create_Func017C() ) then
        call WeatherFogStart(true,2000,4000,100,0.75,0.75,0.7)
        // ========
        call AddWeatherEffectSaveLast( udg_Weather_Region, 'WNcw' )
        call EnableWeatherEffect( GetLastCreatedWeatherEffect(), true )
        set udg_Weather_Effect[0] = GetLastCreatedWeatherEffect()
        // ========
        call StartTimerBJ( udg_Weather_Timer[0], false, 60.00 )
        return
    else
        call DoNothing(  )
    endif
    // ================================================================
    if ( Trig_Weather_Effect_Create_Func019C() ) then
        call WeatherFogStart(true,1000,3000,70,1,1,1)
        // ========
        call AddWeatherEffectSaveLast( udg_Weather_Region, 'SNls' )
        call EnableWeatherEffect( GetLastCreatedWeatherEffect(), true )
        set udg_Weather_Effect[0] = GetLastCreatedWeatherEffect()
        // ========
        call StartTimerBJ( udg_Weather_Timer[0], false, 60.00 )
        return
    else
        call DoNothing(  )
    endif
endfunction

//===========================================================================
function InitTrig_Weather_Effect_Create takes nothing returns nothing
    set gg_trg_Weather_Effect_Create = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Weather_Effect_Create, function Trig_Weather_Effect_Create_Actions )
endfunction

//===========================================================================
// Trigger: Weather Effect Remove
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 天气系统--移除天气效果
//===========================================================================
function Trig_Weather_Effect_Remove_Func002C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 0 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Remove_Func004C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 1 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Remove_Func006C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 2 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Remove_Func008C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 3 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Remove_Func010C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 4 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Remove_Func012C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 5 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Remove_Func014C takes nothing returns boolean
    if ( not ( udg_Weather_Type == 6 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Weather_Effect_Remove_Func020A takes nothing returns nothing
    call RemoveUnit( GetEnumUnit() )
    call GroupRemoveUnit( udg_Weather_SpellGroup, GetEnumUnit() )
endfunction

function Trig_Weather_Effect_Remove_Actions takes nothing returns nothing
    // ================================================================
    if ( Trig_Weather_Effect_Remove_Func002C() ) then
        call WeatherFogStart(false,1000,3000,50,1,1,1)
    else
    endif
    // ========
    if ( Trig_Weather_Effect_Remove_Func004C() ) then
        call WeatherFogStart(false,1000,3000,100,1,0.6,0.6)
    else
    endif
    // ========
    if ( Trig_Weather_Effect_Remove_Func006C() ) then
        call WeatherFogStart(false,250,3000,100,1,1,1)
        call TriggerExecute( gg_trg_Weather_Spell_02_Off )
    else
    endif
    // ========
    if ( Trig_Weather_Effect_Remove_Func008C() ) then
        call WeatherFogStart(false,600,3000,100,0.6,0.9,0.6)
    else
    endif
    // ========
    if ( Trig_Weather_Effect_Remove_Func010C() ) then
        call WeatherFogStart(false,1000,3000,100,1,0.6,0.9)
    else
    endif
    // ========
    if ( Trig_Weather_Effect_Remove_Func012C() ) then
        call WeatherFogStart(false,2000,4000,100,0.75,0.75,0.7)
    else
    endif
    // ========
    if ( Trig_Weather_Effect_Remove_Func014C() ) then
        call WeatherFogStart(false,1000,3000,70,1,1,1)
    else
    endif
    // ================================================================
    set udg_Weather_Type = -1
    call RemoveWeatherEffect( udg_Weather_Effect[0] )
    call RemoveWeatherEffect( udg_Weather_Effect[1] )
    call ForGroupBJ( udg_Weather_SpellGroup, function Trig_Weather_Effect_Remove_Func020A )
    set udg_WE_FallingLeaves = AddWeatherEffect( gg_rct_FallingLeaves, 'SNbs' )
    call EnableWeatherEffect( udg_WE_FallingLeaves, true )
    set udg_WE_SunShine = AddWeatherEffect( gg_rct_SunShine, 'LRaa' )
    call EnableWeatherEffect( udg_WE_SunShine, true )
endfunction

//===========================================================================
function InitTrig_Weather_Effect_Remove takes nothing returns nothing
    set gg_trg_Weather_Effect_Remove = CreateTrigger(  )
    call TriggerRegisterTimerExpireEventBJ( gg_trg_Weather_Effect_Remove, udg_Weather_Timer[0] )
    call TriggerAddAction( gg_trg_Weather_Effect_Remove, function Trig_Weather_Effect_Remove_Actions )
endfunction

//===========================================================================
// Trigger: Weather Effect Spell
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 天气系统--天气法术效果
// 0.霧雨--全场回魔6/S,持续120秒.          1.红霧--全场吸血光环,15%,持续80秒.
// 2.川霧--全场所有英雄隐身40秒.           3.梅雨--全场减15血光环,持续60秒.
// 4.花曇--全场物理免疫持续8秒.            5.台風--全场攻击提高35%，持续20秒. 
// 6.小雪--全场减速15%，持续2分.
//===========================================================================
//TESH.scrollpos=6
//TESH.alwaysfold=0
/////////////////////////////////////////////////////////////////////////////
//    THDOTA-0.800 for Warcraft 1.24b                                      //
//    Rewritten by HJISTC (System based on THDOTA-0.670 written by Chen)   //
//    If you have any Problem or Suggestion                                //
//    Please visit "http://www.thdota.org/bbs/"                            //
/////////////////////////////////////////////////////////////////////////////

//光环释放函数
function Trig_Weather_Spell_Aura takes integer aID returns nothing //aID对应天气的法术
    local integer tID = 'n00X'//n00X=无形施法单位(永久)
    local real x = GetRectCenterX(udg_Weather_Region)
    local real y = GetRectCenterY(udg_Weather_Region)
    local group g = udg_Weather_SpellGroup
    local unit u
    set u = CreateUnit(Player(PLAYER_NEUTRAL_AGGRESSIVE),tID,x,y,270.0)
    call UnitAddAbility(u,aID)
    call GroupAddUnit(g,u)
    set u = CreateUnit(udg_PlayerA[0],tID,x,y,270.0)
    call UnitAddAbility(u,aID)
    call GroupAddUnit(g,u)
    set u = CreateUnit(udg_PlayerB[0],tID,x,y,270.0)
    call UnitAddAbility(u,aID)
    call GroupAddUnit(g,u)
    set u = null
    set g = null
endfunction

function Trig_Weather_Spell_Actions takes nothing returns nothing
    local group g = udg_Weather_SpellGroup
    local unit u
    local real x = GetRectCenterX(udg_Weather_Region)
    local real y = GetRectCenterY(udg_Weather_Region)
    //========
    if udg_Weather_Type == 0 then
        call Trig_Weather_Spell_Aura('A001') //霧雨--全场回魔6/S,持续120秒.
    endif
    if udg_Weather_Type == 1 then
        call Trig_Weather_Spell_Aura('A005') //红霧--全场吸血光环,15%,持续80秒.
    endif
    if udg_Weather_Type == 2 then
        call TriggerExecute(gg_trg_Weather_Spell_02) //川霧--全场所有英雄隐身40秒.(非光环技能)
        call Trig_Weather_Spell_Aura('A0LJ') //川霧--全场所有英雄隐身40秒.(光环特效)
    endif
    if udg_Weather_Type == 3 then
        call Trig_Weather_Spell_Aura('A007') //梅雨--全场减15血光环,持续30秒.
    endif
    if udg_Weather_Type == 4 then
        call Trig_Weather_Spell_Aura('A004') //花曇--全场物理免疫持续8秒.
    endif
    if udg_Weather_Type == 5 then
        call Trig_Weather_Spell_Aura('A002') //台風--全场攻击提高35%，持续20秒. 
    endif
    if udg_Weather_Type == 6 then
        call Trig_Weather_Spell_Aura('A003') //小雪--全场减速15%，持续2分.
    endif
    //========
    set g = null
    set u = null
endfunction

function InitTrig_Weather_Effect_Spell takes nothing returns nothing
    set gg_trg_Weather_Effect_Spell = CreateTrigger()
    call TriggerAddAction( gg_trg_Weather_Effect_Spell, function Trig_Weather_Spell_Actions )
endfunction
//===========================================================================
// Trigger: Weather Spell 02
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 天气系统--川霧法术效果
// 全场所有英雄隐身45秒.
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Weather_Spell_02_Actions takes nothing returns nothing
    local integer i
    local unit h
    set i = 0
    loop
    set h = udg_PlayerHeroes[i]
        if h != null then
            call UnitAddAbility(h,'A0LI')
        endif
    set i = i + 1
    exitwhen i>=12
    endloop
    set h = null
endfunction

//===========================================================================
function InitTrig_Weather_Spell_02 takes nothing returns nothing
    set gg_trg_Weather_Spell_02 = CreateTrigger()
    call TriggerAddAction( gg_trg_Weather_Spell_02, function Trig_Weather_Spell_02_Actions )
endfunction

//===========================================================================
// Trigger: Weather Spell 02 Off
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 天气系统--川霧法术效果
// 全场所有英雄隐身45秒.
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Weather_Spell_02_Off_Actions takes nothing returns nothing
    local integer i
    local unit h
    set i = 0
    loop
    set h = udg_PlayerHeroes[i]
        if h != null then
            call UnitRemoveAbility(h,'A0LI')
        endif
    set i = i + 1
    exitwhen i>=12
    endloop
    set h = null
endfunction

//===========================================================================
function InitTrig_Weather_Spell_02_Off takes nothing returns nothing
    set gg_trg_Weather_Spell_02_Off = CreateTrigger()
    call TriggerAddAction( gg_trg_Weather_Spell_02_Off, function Trig_Weather_Spell_02_Off_Actions )
endfunction

//===========================================================================
// Trigger: Initialization Defence
//===========================================================================
function Trig_Initialization_Defence_Actions takes nothing returns nothing
    //                          博丽神社                         
    // 紧缚结界
    call TriggerRegisterUnitEvent( gg_trg_Defence_BL, udg_BaseA[0], EVENT_UNIT_SELL )
    call AddUnitToStockBJ( 'n03X', udg_BaseA[0], 1, 1 )
    // 玄爷吃兵
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Defence_Eating, EVENT_PLAYER_UNIT_SELL )
    call AddUnitToStockBJ( 'n00B', udg_BaseA[1], 1, 1 )
    call AddUnitToStockBJ( 'n00B', udg_BaseA[6], 1, 1 )
    call AddUnitToStockBJ( 'n00B', udg_BaseA[7], 1, 1 )
    call AddUnitToStockBJ( 'n00B', udg_BaseA[8], 1, 1 )
    call AddUnitToStockBJ( 'n00B', udg_BaseA[9], 1, 1 )
    call AddUnitToStockBJ( 'n00B', udg_BaseA[10], 1, 1 )
    call AddUnitToStockBJ( 'n00B', udg_BaseA[11], 1, 1 )
    call AddUnitToStockBJ( 'n00B', udg_BaseA[12], 1, 1 )
    call AddUnitToStockBJ( 'n00B', udg_BaseA[13], 1, 1 )
    call AddUnitToStockBJ( 'n00B', udg_BaseA[14], 1, 1 )
    call AddUnitToStockBJ( 'n00B', udg_BaseA[15], 1, 1 )
    // 启动玄爷
    call TriggerRegisterUnitEvent( gg_trg_Defence_Control_1, udg_BaseA[1], EVENT_UNIT_SELL )
    call AddUnitToStockBJ( 'n02W', udg_BaseA[1], 1, 1 )
    call AddUnitToStockBJ( 'n02I', udg_BaseA[1], 1, 1 )
    call AddUnitToStockBJ( 'n02X', udg_BaseA[1], 1, 1 )
    // 防御结界
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Defence_DefArea, EVENT_PLAYER_UNIT_SELL )
    call AddUnitToStockBJ( 'n02J', udg_BaseA[1], 1, 1 )
    call AddUnitToStockBJ( 'n02J', udg_BaseA[6], 1, 1 )
    call AddUnitToStockBJ( 'n02J', udg_BaseA[7], 1, 1 )
    call AddUnitToStockBJ( 'n02J', udg_BaseA[8], 1, 1 )
    call AddUnitToStockBJ( 'n02J', udg_BaseA[9], 1, 1 )
    call AddUnitToStockBJ( 'n02J', udg_BaseA[10], 1, 1 )
    call AddUnitToStockBJ( 'n02J', udg_BaseA[11], 1, 1 )
    call AddUnitToStockBJ( 'n02J', udg_BaseA[12], 1, 1 )
    call AddUnitToStockBJ( 'n02J', udg_BaseA[13], 1, 1 )
    call AddUnitToStockBJ( 'n02J', udg_BaseA[14], 1, 1 )
    call AddUnitToStockBJ( 'n02J', udg_BaseA[15], 1, 1 )
    // -----------------------------------------------------------------------------
    //                          守失神社                         
    // 神之怒
    call TriggerRegisterUnitEvent( gg_trg_Defence_God, udg_BaseB[0], EVENT_UNIT_SELL )
    call AddUnitToStockBJ( 'n02M', udg_BaseB[0], 1, 1 )
    // 河童修理工
    call TriggerRegisterUnitEvent( gg_trg_Defence_SCV, udg_BaseB[0], EVENT_UNIT_SELL )
    call AddUnitToStockBJ( 'e00Y', udg_BaseB[0], 1, 1 )
    // 启动FXTZ
    call TriggerRegisterUnitEvent( gg_trg_Defence_Control_2, udg_BaseB[1], EVENT_UNIT_SELL )
    call TriggerRegisterUnitEvent( gg_trg_Defence_Control_2, udg_BaseB[2], EVENT_UNIT_SELL )
    call AddUnitToStockBJ( 'n03W', udg_BaseB[1], 1, 1 )
    call AddUnitToStockBJ( 'n03U', udg_BaseB[1], 1, 1 )
    call AddUnitToStockBJ( 'n03V', udg_BaseB[1], 1, 1 )
    call AddUnitToStockBJ( 'n03W', udg_BaseB[2], 1, 1 )
    call AddUnitToStockBJ( 'n03U', udg_BaseB[2], 1, 1 )
    call AddUnitToStockBJ( 'n03V', udg_BaseB[2], 1, 1 )
    // 风神祝福
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Defence_SpdArea, EVENT_PLAYER_UNIT_SELL )
    call AddUnitToStockBJ( 'n02K', udg_BaseB[1], 1, 1 )
    call AddUnitToStockBJ( 'n02K', udg_BaseB[2], 1, 1 )
    call AddUnitToStockBJ( 'n02K', udg_BaseB[6], 1, 1 )
    call AddUnitToStockBJ( 'n02K', udg_BaseB[7], 1, 1 )
    call AddUnitToStockBJ( 'n02K', udg_BaseB[8], 1, 1 )
    call AddUnitToStockBJ( 'n02K', udg_BaseB[9], 1, 1 )
    call AddUnitToStockBJ( 'n02K', udg_BaseB[10], 1, 1 )
    call AddUnitToStockBJ( 'n02K', udg_BaseB[11], 1, 1 )
    call AddUnitToStockBJ( 'n02K', udg_BaseB[12], 1, 1 )
    call AddUnitToStockBJ( 'n02K', udg_BaseB[13], 1, 1 )
    call AddUnitToStockBJ( 'n02K', udg_BaseB[14], 1, 1 )
    call AddUnitToStockBJ( 'n02K', udg_BaseB[15], 1, 1 )
endfunction

//===========================================================================
function InitTrig_Initialization_Defence takes nothing returns nothing
    set gg_trg_Initialization_Defence = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initialization_Defence, function Trig_Initialization_Defence_Actions )
endfunction

//===========================================================================
// Trigger: Defence DefArea
//===========================================================================
//TESH.scrollpos=6
//TESH.alwaysfold=0
function Trig_Defence_DefArea_Conditions takes nothing returns boolean
    local unit u = GetSoldUnit()
    local boolean t = GetUnitTypeId(u) == 'n02J'
    set u = null
    return t
endfunction

function Trig_Defence_DefArea_MagicResist_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit v = LoadUnitHandle(udg_ht,task,0)
    call UnitRemoveAbility(v,'A0NR')
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set v = null
endfunction

function Trig_Defence_DefArea_MagicResist_Main takes unit v returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    call UnitAddAbility(v,'A0NR')
    call SaveUnitHandle(udg_ht,task,0,v)
    call TimerStart(t,7.00,false,function Trig_Defence_DefArea_MagicResist_Clear)
    set t = null
endfunction


function Trig_Defence_DefArea_Actions takes nothing returns nothing
    local integer cost = 6    //防御结界需要的信仰
    local unit caster = GetSellingUnit()
    local unit u = GetSoldUnit()
    local player PLY = GetOwningPlayer(u)

    local group g
    local unit v

    call KillUnit(u)
    call RemoveUnit(u)

    if THD_GetSpirit(PLY) < cost then
        call DisplayTextToPlayer( PLY , 0, 0, "信仰不足！需要3信仰才能启动防御结界" )
        call AddUnitToStock( caster, 'n02J', 1, 1 )
        set caster = null
        set u = null
        set PLY = null
        set g = null
        set v = null
        return
    endif

    call THD_AddSpirit(GetOwningPlayer(GetSellingUnit()),-cost) 

    call UnitAddAbility( caster,'A0CT' )
    call IssueImmediateOrderById( caster,852269 )
    call UnitRemoveAbility( caster,'A0CT' )

    set g = CreateGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),250.0,null)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitType(v,UNIT_TYPE_DEAD)==false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and IsUnitAlly(v,GetOwningPlayer(caster)) then
            call Trig_Defence_DefArea_MagicResist_Main(v)
        endif
    endloop
    call DestroyGroup(g)

    set caster = null
    set u = null
    set PLY = null
    set g = null
    set v = null
endfunction

//===========================================================================
function InitTrig_Defence_DefArea takes nothing returns nothing
    set gg_trg_Defence_DefArea = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Defence_DefArea, Condition( function Trig_Defence_DefArea_Conditions ) )
    call TriggerAddAction( gg_trg_Defence_DefArea, function Trig_Defence_DefArea_Actions )
endfunction//===========================================================================
// Trigger: Defence Eating
//===========================================================================
//TESH.scrollpos=12
//TESH.alwaysfold=0
function Trig_Defence_Eating_Conditions takes nothing returns boolean
    local unit u = GetSoldUnit()
    local boolean t = GetUnitTypeId(u) == 'n00B'
    set u = null
    return t
endfunction

function Eating_Filter takes nothing returns boolean
    local unit u = GetFilterUnit()
    local unit caster = GetSellingUnit()
    local player PLY = GetOwningPlayer(caster)
    local boolean t = false
    if IsUnitEnemy(u,PLY) and IsUnitType(u,UNIT_TYPE_HERO)==false and IsUnitType(u,UNIT_TYPE_STRUCTURE)==false and GetUnitState(u,UNIT_STATE_LIFE)>0 and IsUnitType(u,UNIT_TYPE_ANCIENT)==false and IsUnitIllusion(u)==false then
        set t = true
    endif
    set u = null
    set caster = null
    set PLY = null
    return t
endfunction

function Trig_Defence_Eating_Actions takes nothing returns nothing
    local integer cost = 3    //吃兵需要的信仰
    local unit caster = GetSellingUnit()
    local unit u = GetSoldUnit()
    local group g
    local effect e
    local player PLY = GetOwningPlayer(u)
    local boolean eating = false

    call KillUnit(u)
    call RemoveUnit(u)

    if THD_GetSpirit(PLY) < cost then
        call DisplayTextToPlayer( PLY , 0, 0, "信仰不足！需要3信仰才能使用吞噬" )
        call AddUnitToStock( caster, 'n00B', 1, 1 )
        set caster = null
        set u = null
        set g = null
        set e = null
        set PLY = null
        return
    endif

    set g = CreateGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),400,Filter(function Eating_Filter))
    set u = FirstOfGroup(g)
    call DestroyGroup(g)

    if u == null then
        call DisplayTextToPlayer( PLY , 0, 0, "玄爷附近没单位可吃，变成吃空气了，回复所需时间会增加一倍" )
        set eating = false
    else
        set eating = true
    endif
 
    if eating == true then
        call IssueTargetOrder( caster, "attack" , u )
    endif
    call SetUnitAnimation( caster, "Attack Spell" )
    call TriggerSleepAction(0.3)
    if eating == true then
        set e = AddSpecialEffect("Objects\\Spawnmodels\\Orc\\OrcLargeDeathExplode\\OrcLargeDeathExplode.mdl",GetUnitX(u),GetUnitY(u))
        call DestroyEffect(e)
        call KillUnit(u)
        call RemoveUnit(u)
    endif
    set u = CreateUnit(udg_PlayerA[0],'n001',GetUnitX(caster),GetUnitY(caster),0)
    if eating == true then
        call UnitAddAbility(u,'A06N')
    else
        call UnitAddAbility(u,'A0NQ')        
    endif
    call IssueTargetOrder( u, "rejuvination" , caster )
    call THD_AddSpirit(GetOwningPlayer(GetSellingUnit()),-cost) 

    set caster = null
    set u = null 
    set g = null
    set e = null
    set PLY = null
endfunction

//===========================================================================
function InitTrig_Defence_Eating takes nothing returns nothing
    set gg_trg_Defence_Eating = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Defence_Eating, Condition( function Trig_Defence_Eating_Conditions ) )
    call TriggerAddAction( gg_trg_Defence_Eating, function Trig_Defence_Eating_Actions )
endfunction//===========================================================================
// Trigger: Defence BL
//===========================================================================
//TESH.scrollpos=24
//TESH.alwaysfold=0
function Trig_Defence_BL_Conditions takes nothing returns boolean
    local unit u = GetSoldUnit()
    local boolean t = GetUnitTypeId(u) == 'n03X'
    set u = null
    return t
endfunction

function Trig_Defence_BL_Actions takes nothing returns nothing
    local integer cost = 40    //神之怒需要的信仰
    local unit caster = GetSellingUnit()
    local unit u = GetSoldUnit()
    local player PLY = GetOwningPlayer(u)
    local integer i
    local unit h
    local effect e
    
    call KillUnit(u)
    call RemoveUnit(u)
    
    if THD_GetSpirit(PLY) < cost then
        call DisplayTextToPlayer( PLY , 0, 0, "信仰不足！需要40的信仰才能启动" )
        call AddUnitToStock( caster, 'n03X', 1, 1 )
        set caster = null
        set u = null
        set PLY = null
        set h = null
        set e = null
        return
    endif
    
    call THD_AddSpirit(GetOwningPlayer(GetSellingUnit()),-cost)
    
    call DisableTrigger( gg_trg_Weather_Fog_System )
    call WeatherFogStart(true,800,2600,100,1,0.3,0.1)
    call StartSound( gg_snd_RollingThunder1 )
    call TriggerSleepAction(2)
    set i = 0
    loop
        set h = udg_PlayerHeroes[i]
        if h != null and IsUnitEnemy(h,PLY) then
            set u = CreateUnit(PLY,GPSU(),GetUnitX(h),GetUnitY(h),0.0)
            call UnitAddAbility(u,'A0CS')
            call IssueTargetOrder(u,"thunderbolt",h)
            set e = AddSpecialEffect("AObjects\\Spawnmodels\\NightElf\\EntBirthTarget\\EntBirthTarget.mdl",GetUnitX(h),GetUnitY(h))
            call DestroyEffect(e)
        endif
        set i = i + 1
        exitwhen i>=12
    endloop
    call TriggerSleepAction(2)
    call WeatherFogStart(false,800,2600,100,1,0.3,0.1)
    
    set caster = null
    set u = null
    set PLY = null
    set h = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Defence_BL takes nothing returns nothing
    set gg_trg_Defence_BL = CreateTrigger()
    call TriggerAddCondition( gg_trg_Defence_BL, Condition( function Trig_Defence_BL_Conditions ) )
    call TriggerAddAction( gg_trg_Defence_BL, function Trig_Defence_BL_Actions )
endfunction//===========================================================================
// Trigger: Defence Control 1
//
// i中 x右 w左
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Defence_Control_1_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetSoldUnit()) == 'n02I' or GetUnitTypeId(GetSoldUnit()) == 'n02W' or GetUnitTypeId(GetSoldUnit()) == 'n02X'
endfunction

function Trig_Defence_Control_1_Actions takes nothing returns nothing
    local unit caster = GetSellingUnit()
    local unit u = GetSoldUnit()
    local player PLY = GetOwningPlayer(u)
    local integer cost = 100//启动玄爷需要的信仰
    local real time = 360.0
    local timer t
    local real x
    local real y
    local integer d
    local integer uid = GetUnitTypeId(u)
    local integer way
    local unit boss
    
    call KillUnit(u)
    call RemoveUnit(u)
    
    if THD_GetSpirit(PLY) < cost then
        call DisplayTextToPlayer(PLY,0,0,"信仰不足！需要100的信仰才能启动玄爷")
        call AddUnitToStock(caster,uid,1,1)
        set caster = null
        set u = null
        set PLY = null
        set t = null
        return
    endif
    
    call THD_AddSpirit(GetOwningPlayer(GetSellingUnit()),-cost) 
    
    call StartSound( gg_snd_SargerasRoar )
    set x = GetUnitX(caster)
    set y = GetUnitY(caster)
    
    call RemoveUnitFromStock(caster,'n02I')
    call RemoveUnitFromStock(caster,'n02W')
    call RemoveUnitFromStock(caster,'n02X')
    call DisableTrigger(gg_trg_Defence_Control_1)
    
    //set PLY = Player(14)
    //call SetUnitOwner(caster,PLY,false)
    //call IssueImmediateOrder(caster,"unroot")
    
    set u = CreateUnit(udg_PlayerA[0],'h015',x,y,45.0)
    
    if uid=='n02I' then
    set way = 0
    elseif uid=='n02X' then
    set way = 1
    elseif uid=='n02W' then
    set way = 2
    endif
    

    
    call SetUnitVertexColor(u,255,255,255,127)
    call UnitApplyTimedLife(u,'BTLF',time + 5.0)
    call SetUnitPosition(u,x,y)
    call RemoveGuardPosition(u)
    
    call AddUnitWaypointRecord(u,way*16)//route*16)
    call SpawnIssueOrderA(u)
    
    //call IssuePointOrder(u,"attack",GetRectCenterX(gg_rct_TargetA),GetRectCenterY(gg_rct_TargetA))
    set boss = u
    //call TriggerRegisterUnitEvent(gg_trg_Defence_Genji,u,EVENT_UNIT_ISSUED_POINT_ORDER)
    
    set u = CreateUnit(PLY,'n00X',x-250.0,y,0.0)
    call UnitAddAbility(u,'A0GS')
    call IssuePointOrder(u,"cloudoffog",x,y)
    call UnitApplyTimedLife(u,'BTLF',time + 5.0)
    
    set d = OrderId("cloudoffog")
    set t = CreateTimer()
    call TimerStart(t,time,false,null)
    loop
        set time = TimerGetRemaining(t)
        exitwhen time <= 0
        exitwhen IsUnitDead(boss)
        if GetUnitCurrentOrder(u)!=d then
            call IssuePointOrder(u,"cloudoffog",x,y)
            call DebugMsg("X")
        endif
        call TriggerSleepAction(1.0)
    endloop
    call DestroyTimer(t)
    
    call RemoveUnit(u)
    call RemoveUnit(boss)
    call DebugMsg(GetUnitName(caster)+"之魂结束")
    call StartSound(gg_snd_SargerasRoar)
    
    //set PLY = Player(0)
    //call SetUnitOwner(caster,PLY,false)
    
    call TriggerSleepAction(1.0)
    
    call AddUnitToStock(caster,'n02I',0,1)
    call AddUnitToStock(caster,'n02X',0,1)
    call AddUnitToStock(caster,'n02W',0,1)
    call EnableTrigger(gg_trg_Defence_Control_1)
    
    //call SetUnitPosition(caster,x,y)
    //call IssuePointOrder(caster,"root",x,y)
    set boss = null
    set caster = null
    set u = null
    set PLY = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Defence_Control_1 takes nothing returns nothing
    set gg_trg_Defence_Control_1 = CreateTrigger()
    call TriggerAddCondition( gg_trg_Defence_Control_1, Condition( function Trig_Defence_Control_1_Conditions ) )
    call TriggerAddAction( gg_trg_Defence_Control_1, function Trig_Defence_Control_1_Actions )
endfunction//===========================================================================
// Trigger: Defence SpdArea
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Defence_SpdArea_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetSoldUnit()) == 'n02K'
endfunction

function Trig_Defence_SpdArea_Actions takes nothing returns nothing
    local integer cost = 6    //风神祝福需要的信仰
    local unit caster = GetSellingUnit()
    local unit u = GetSoldUnit()
    local player PLY = GetOwningPlayer(u)

    call KillUnit(u)
    call RemoveUnit(u)

    if THD_GetSpirit(PLY) < cost then
        call DisplayTextToPlayer( PLY , 0, 0, "信仰不足！需要3信仰才能获得风神祝福" )
        call AddUnitToStock( caster, 'n02K', 1, 1 )
        set caster = null
        set u = null
        set PLY = null
        return
    endif

    call THD_AddSpirit(GetOwningPlayer(GetSellingUnit()),-cost) 

    call UnitAddAbility( caster,'A0A2' )
    call IssueImmediateOrderById( caster,852285 )
    call UnitRemoveAbility( caster,'A0A2' )

    set caster = null
    set u = null
    set PLY = null
endfunction

//===========================================================================
function InitTrig_Defence_SpdArea takes nothing returns nothing
    set gg_trg_Defence_SpdArea = CreateTrigger()
    call TriggerAddCondition( gg_trg_Defence_SpdArea, Condition( function Trig_Defence_SpdArea_Conditions ) )
    call TriggerAddAction( gg_trg_Defence_SpdArea, function Trig_Defence_SpdArea_Actions )
endfunction
//===========================================================================
// Trigger: Defence SCV
//===========================================================================
//TESH.scrollpos=12
//TESH.alwaysfold=0
function Trig_Defence_SCV_Conditions takes nothing returns boolean
    local unit u = GetSoldUnit()
    local boolean t = GetUnitTypeId(u) == 'e00Y'
    set u = null
    return t
endfunction

function Trig_SCV_Actions takes nothing returns nothing
    local integer cost = 3    //购买修理机器人需要的信仰
    local unit scv = GetSoldUnit()
    local player PLY = GetOwningPlayer(scv)
    
    if PLY == udg_PlayerB[0] then
    call DisplayTextToPlayer( PLY , 0, 0, "只有真实存在的人才能订购河童修理工" )
    call KillUnit(scv)
    call RemoveUnit(scv)
    call AddUnitToStock( udg_BaseB[0], 'e00Y', 1, 1 )
    set scv = null
    set PLY = null 
    return    
    endif

    if THD_GetSpirit(PLY) < cost then
    call DisplayTextToPlayer( PLY , 0, 0, "信仰不足！需要3信仰才能订购河童修理工" )
    call KillUnit(scv)
    call RemoveUnit(scv)
    call AddUnitToStock( udg_BaseB[0], 'e00Y', 1, 1 )
    else
        call THD_AddSpirit(GetOwningPlayer(GetSellingUnit()),-cost) 
    endif
    
    set scv = null
    set PLY = null 
endfunction

//===========================================================================
function InitTrig_Defence_SCV takes nothing returns nothing
    set gg_trg_Defence_SCV = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Defence_SCV, Condition( function Trig_Defence_SCV_Conditions ) )
    call TriggerAddAction( gg_trg_Defence_SCV, function Trig_SCV_Actions )
endfunction

//===========================================================================
// Trigger: Defence God
//===========================================================================
//TESH.scrollpos=12
//TESH.alwaysfold=0
function Trig_Defence_God_Conditions takes nothing returns boolean
    local unit u = GetSoldUnit()
    local boolean t = GetUnitTypeId(u) == 'n02M'
    set u = null
    return t
endfunction

function Trig_Defence_God_Actions takes nothing returns nothing
    local integer cost = 40    //神之怒需要的信仰
    local unit caster = GetSellingUnit()
    local unit u = GetSoldUnit()
    local player PLY = GetOwningPlayer(u)
    local integer i
    local unit h
    local effect e
    
    call KillUnit(u)
    call RemoveUnit(u)
    
    if THD_GetSpirit(PLY) < cost then
        call DisplayTextToPlayer( PLY , 0, 0, "信仰不足！需要40的信仰才能启动神之怒" )
        call AddUnitToStock( caster, 'n02M', 1, 1 )
        set caster = null
        set u = null
        set PLY = null
        set h = null
        set e = null
        return
    endif
    
    call THD_AddSpirit(GetOwningPlayer(GetSellingUnit()),-cost)
    
    call DisableTrigger( gg_trg_Weather_Fog_System )
    call WeatherFogStart(true,800,2600,100,0,0,0.5)
    call StartSound( gg_snd_RollingThunder1 )
    call TriggerSleepAction(2)
    set i = 0
    loop
        set h = udg_PlayerHeroes[i]
        if h != null and IsUnitEnemy(h,PLY) then
            set u = CreateUnit(PLY,GPSU(),GetUnitX(h),GetUnitY(h),0.0)
            call UnitAddAbility(u,'A0CS')
            call IssueTargetOrder(u,"thunderbolt",h)
            set e = AddSpecialEffect("Abilities\\Spells\\Other\\Monsoon\\MonsoonBoltTarget.mdl",GetUnitX(h),GetUnitY(h))
            call DestroyEffect(e)
        endif
        set i = i + 1
        exitwhen i>=12
    endloop
    call TriggerSleepAction(2)
    call WeatherFogStart(false,800,2600,100,0,0,0.5)
    
    set caster = null
    set u = null
    set PLY = null
    set h = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Defence_God takes nothing returns nothing
    set gg_trg_Defence_God = CreateTrigger()
    call TriggerAddCondition( gg_trg_Defence_God, Condition( function Trig_Defence_God_Conditions ) )
    call TriggerAddAction( gg_trg_Defence_God, function Trig_Defence_God_Actions )
endfunction//===========================================================================
// Trigger: Defence Control 2
//
// i中 x右 w左
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Defence_Control_2_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetSoldUnit()) == 'n03U' or GetUnitTypeId(GetSoldUnit()) == 'n03V' or GetUnitTypeId(GetSoldUnit()) == 'n03W'
endfunction

function Trig_Defence_Control_2_Actions takes nothing returns nothing
    local unit caster = GetSellingUnit()
    local unit u = GetSoldUnit()
    local player PLY = GetOwningPlayer(u)
    local integer cost = 50//启动fxtz需要的信仰
    local real time = 360.0
    local timer t
    local real x
    local real y
    local integer d
    local integer uid = GetUnitTypeId(u)
    local integer way
    local unit boss
    
    call KillUnit(u)
    call RemoveUnit(u)
    
    if THD_GetSpirit(PLY) < cost then
        call DisplayTextToPlayer(PLY,0,0,"信仰不足！需要50的信仰才能启动非想天则")
        call AddUnitToStock(caster,uid,1,1)
        set caster = null
        set u = null
        set PLY = null
        set t = null
        return
    endif
    
    call THD_AddSpirit(GetOwningPlayer(GetSellingUnit()),-cost) 
    
    call StartSound( gg_snd_TinkerMorph1 )
    set x = GetUnitX(caster)
    set y = GetUnitY(caster)
    
    call RemoveUnitFromStock(caster,'n03U')
    call RemoveUnitFromStock(caster,'n03V')
    call RemoveUnitFromStock(caster,'n03W')
    //call DisableTrigger(gg_trg_Defence_Control_2)
    
    set u = CreateUnit(udg_PlayerB[0],'h01O',GetRectCenterX(gg_rct_BaseB),GetRectCenterY(gg_rct_BaseB),45.0)
    
    if uid=='n03U' then
    set way = 0
    elseif uid=='n03V' then
    set way = 1
    elseif uid=='n03W' then
    set way = 2
    endif
    

    
    call SetUnitVertexColor(u,255,255,255,127)
    call UnitApplyTimedLife(u,'BTLF',time + 5.0)
    call SetUnitPosition(u,GetRectCenterX(gg_rct_BaseB),GetRectCenterY(gg_rct_BaseB))
    call RemoveGuardPosition(u)
    
    call AddUnitWaypointRecord(u,way*16)//route*16)
    call SpawnIssueOrderA(u)
    
    //call IssuePointOrder(u,"attack",GetRectCenterX(gg_rct_TargetA),GetRectCenterY(gg_rct_TargetA))
    set boss = u
    //call TriggerRegisterUnitEvent(gg_trg_Defence_Genji,u,EVENT_UNIT_ISSUED_POINT_ORDER)
    
    set u = CreateUnit(PLY,'n00X',x-250.0,y,0.0)
    call UnitAddAbility(u,'A0GS')
    call IssuePointOrder(u,"cloudoffog",x,y)
    call UnitApplyTimedLife(u,'BTLF',time + 5.0)
    
    set d = OrderId("cloudoffog")
    set t = CreateTimer()
    call TimerStart(t,time,false,null)
    loop
        set time = TimerGetRemaining(t)
        exitwhen time <= 0
        exitwhen IsUnitDead(boss)
        if GetUnitCurrentOrder(u)!=d then
            call IssuePointOrder(u,"cloudoffog",x,y)
            call DebugMsg("X")
        endif
        call TriggerSleepAction(1.0)
    endloop
    call DestroyTimer(t)
    
    call RemoveUnit(u)
    call RemoveUnit(boss)
    call DebugMsg(GetUnitName(caster)+"结束")
    call StartSound(gg_snd_SteamTankYes1)
        
    call TriggerSleepAction(1.0)
    
    call AddUnitToStock(caster,'n03U',0,1)
    call AddUnitToStock(caster,'n03V',0,1)
    call AddUnitToStock(caster,'n03W',0,1)
    //call EnableTrigger(gg_trg_Defence_Control_2)
    
    
    set caster = null
    set u = null
    set PLY = null
    set t = null
    set boss = null
endfunction

//===========================================================================
function InitTrig_Defence_Control_2 takes nothing returns nothing
    set gg_trg_Defence_Control_2 = CreateTrigger()
    call TriggerAddCondition( gg_trg_Defence_Control_2, Condition( function Trig_Defence_Control_2_Conditions ) )
    call TriggerAddAction( gg_trg_Defence_Control_2, function Trig_Defence_Control_2_Actions )
endfunction//===========================================================================
// Trigger: RuneBorn
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_RuneBorn_Actions takes nothing returns nothing
    local location loc1 = GetRandomLocInRect(gg_rct_Rune1)
    local location loc2 = GetRandomLocInRect(gg_rct_Rune2)
    call RemoveItem(udg_Rune[1])
    call RemoveItem(udg_Rune[2])
    set udg_Rune[1] = CreateItemLoc( 'I000', loc1 )
    set udg_Rune[2] = CreateItemLoc( 'I000', loc2 )
    call RemoveLocation(loc1)
    call RemoveLocation(loc2)
    set loc1 = null
    set loc2 = null
endfunction

//===========================================================================
function InitTrig_RuneBorn takes nothing returns nothing
    set gg_trg_RuneBorn = CreateTrigger(  )
    call TriggerAddAction( gg_trg_RuneBorn, function Trig_RuneBorn_Actions )
endfunction

//===========================================================================
// Trigger: Rune
//===========================================================================
//TESH.scrollpos=17
//TESH.alwaysfold=0
function Trig_Rune_Conditions takes nothing returns boolean
    local item i = GetManipulatedItem()
    local unit u = GetTriggerUnit()
    if GetItemTypeId(i)=='I000' and IsUnitType(u,UNIT_TYPE_HERO) then
        set i = null
        set u = null
        return true
    else
        set i = null
        set u = null
        return false
    endif
endfunction

function Rune07damage takes nothing returns nothing
    local unit target = GetEnumUnit()
    local unit u = LoadUnitHandle(udg_Hashtable,StringHash("Rune07"),1)
    call UnitDamageTarget(u,target,400,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    set target = null
    set u = null
endfunction

function Trig_Rune_Actions takes nothing returns nothing
    local integer i = GetRandomInt(1,15)
    local unit caster = GetTriggerUnit()
    local player PLY = GetOwningPlayer(caster)
    local unit u = CreateUnit(PLY,'n001',GetUnitX(caster),GetUnitY(caster),0)
    local group grp
    local item Rune = GetManipulatedItem()
    if i==1 then//隐形
        call UnitAddAbility(u,'A0C5')
        call IssueTargetOrder(u,"invisibility",caster)
        call DebugMsg("隐形")
    elseif i == 2 then//加速
        call UnitAddAbility(u,'A0DJ')
        call IssueImmediateOrderById( u,852285 )
        call DebugMsg("加速")
    elseif i == 3 then//攻击
        call UnitAddAbility(u,'A0DK')
        call IssueImmediateOrder( u,"roar" )
        call DebugMsg("攻击")
    elseif i == 4 then//防御
        call UnitAddAbility(u,'A0DL')
        call IssueImmediateOrderById( u,852269 )
        call DebugMsg("防御")
    elseif i == 5 then//恢复
        call UnitAddAbility(u,'A0EX')
        call IssueTargetOrder(u,"rejuvination",caster)
        call DebugMsg("恢复")
    elseif i == 6 then//毒药
        call UnitAddAbility(u,'A0EV')
        call IssueTargetOrder(u,"shadowstrike",caster)
        call DebugMsg("毒药")
    elseif i == 7 then//爆炸
        set grp =CreateGroup()
        call UnitAddAbility(u,'A0EW')
        call IssueImmediateOrder( u,"thunderclap" )
        call GroupEnumUnitsInRange(grp,GetUnitX(u),GetUnitY(u),350,null)
        call SaveUnitHandle(udg_Hashtable,StringHash("Rune07"),1,u)
        call ForGroup(grp,function Rune07damage)
        call FlushChildHashtable(udg_Hashtable,StringHash("Rune07"))
        call DestroyGroup(grp)
        call DebugMsg("爆炸")
        call CastSpell(caster,"O_O")
    elseif i == 8 then//减甲
        call UnitAddAbility(u,'A0SL')
        call IssueImmediateOrderById( u,852269 )
        call DebugMsg("减甲")
    elseif i == 9 then//分身
        call UnitAddAbility(u,'A0SM')
        call IssueTargetOrderById(u,852274,caster)
        call DebugMsg("分身")
    elseif i == 10 then//随机传送
        set i = GetRandomInt(1,7)
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTarget.mdl",GetUnitX(caster),GetUnitY(caster)))
        if i == 1 then
            call SetUnitX(caster, GetRectCenterX(gg_rct_RunesTeleport01) )
            call SetUnitY(caster, GetRectCenterY(gg_rct_RunesTeleport01) )
        elseif i == 2 then
            call SetUnitX(caster, GetRectCenterX(gg_rct_RunesTeleport02) )
            call SetUnitY(caster, GetRectCenterY(gg_rct_RunesTeleport02) )
        elseif i == 3 then
            call SetUnitX(caster, GetRectCenterX(gg_rct_RunesTeleport03) )
            call SetUnitY(caster, GetRectCenterY(gg_rct_RunesTeleport03) )
        elseif i == 4 then
            call SetUnitX(caster, GetRectCenterX(gg_rct_RunesTeleport04) )
            call SetUnitY(caster, GetRectCenterY(gg_rct_RunesTeleport04) )
        elseif i == 5 then
            call SetUnitX(caster, GetRectCenterX(gg_rct_RunesTeleport05) )
            call SetUnitY(caster, GetRectCenterY(gg_rct_RunesTeleport05) )
        elseif i == 6 then
            call SetUnitX(caster, GetRectCenterX(gg_rct_RunesTeleport06) )
            call SetUnitY(caster, GetRectCenterY(gg_rct_RunesTeleport06) )
        elseif i == 7 then
            call SetUnitX(caster, GetRectCenterX(gg_rct_RunesTeleport07) )
            call SetUnitY(caster, GetRectCenterY(gg_rct_RunesTeleport07) )
        endif
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportTarget.mdl",GetUnitX(caster),GetUnitY(caster)))
        call DebugMsg("随机传送")
    elseif i == 11 then//Stun
        call UnitAddAbility(u,'A0SN')
        call IssueTargetOrder(u,"thunderbolt",caster)
        call DebugMsg("Stun")
    elseif i == 12 then//AttackSpeed
        call UnitAddAbility(u,'A0SO')
        call IssueTargetOrder(u,"bloodlust",caster)
        call DebugMsg("AttackSpeed")
    elseif i == 13 then//Gold
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Transmute\\GoldBottleMissile.mdl",GetUnitX(caster),GetUnitY(caster)))
        call THD_AddCredit(PLY,250)
        call DebugMsg("Gold")
    elseif i == 14 then//Decrease Gold
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Transmute\\GoldBottleMissile.mdl",GetUnitX(caster),GetUnitY(caster)))
        call THD_AddCredit(PLY,-250)
        call DebugMsg("Decrease Gold")
    elseif i == 15 then//Add Power
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIlm\\AIlmTarget.mdl",GetUnitX(caster),GetUnitY(caster)))
        call SetHeroStr(caster,GetHeroStr(caster,false)+1,true)
        call SetHeroAgi(caster,GetHeroAgi(caster,false)+1,true)
        call SetHeroInt(caster,GetHeroInt(caster,false)+1,true)
        call DebugMsg("Increase Power")
    endif
    call TriggerSleepAction(1)
    call RemoveItem(Rune)
    set caster = null
    set PLY = null
    set u = null
    set grp = null
    set Rune = null
endfunction

//===========================================================================
function InitTrig_Rune takes nothing returns nothing
    set gg_trg_Rune = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Rune, EVENT_PLAYER_UNIT_PICKUP_ITEM )
    call TriggerAddCondition( gg_trg_Rune, Condition( function Trig_Rune_Conditions ) )
    call TriggerAddAction( gg_trg_Rune, function Trig_Rune_Actions )
endfunction

//===========================================================================
// Trigger: Tree Bridge
//===========================================================================
function Trig_Tree_Bridge_Actions takes nothing returns nothing
    call KillDestructable( gg_dest_LTt5_0498 )
    call TriggerSleepAction( 5.00 )
    call DestructableRestoreLife( gg_dest_LTt5_0498, GetDestructableMaxLife(gg_dest_LTt5_0498), true )
    call DestructableRestoreLife( gg_dest_DTlv_1987, GetDestructableMaxLife(gg_dest_DTlv_1987), true )
endfunction

//===========================================================================
function InitTrig_Tree_Bridge takes nothing returns nothing
    set gg_trg_Tree_Bridge = CreateTrigger(  )
    call TriggerRegisterDeathEvent( gg_trg_Tree_Bridge, gg_dest_DTlv_1987 )
    call TriggerAddAction( gg_trg_Tree_Bridge, function Trig_Tree_Bridge_Actions )
endfunction

//===========================================================================
// Trigger: Trees Relife
//
// 树木再生
//===========================================================================
function Trig_Trees_Relife_Func001A takes nothing returns nothing
    if GetEnumDestructable() == gg_dest_DTlv_1987 then//BLTree桥
        return
    endif
    if GetEnumDestructable() == gg_dest_LT07_0951 then//BL桥
        return
    endif
    if GetEnumDestructable() == gg_dest_LT06_0189 then//SS桥
        return
    endif
    if GetEnumDestructable() == gg_dest_LTt5_0498 then//大树桥
        return
    endif
    call DestructableRestoreLife( GetEnumDestructable(), GetDestructableMaxLife(GetEnumDestructable()), true )
endfunction

function Trig_Trees_Relife_Actions takes nothing returns nothing
    call EnumDestructablesInRectAll( udg_MapRegion, function Trig_Trees_Relife_Func001A )
endfunction

//===========================================================================
function InitTrig_Trees_Relife takes nothing returns nothing
    set gg_trg_Trees_Relife = CreateTrigger(  )
    call TriggerRegisterTimerEventPeriodic( gg_trg_Trees_Relife, 180.00 )
    call TriggerAddAction( gg_trg_Trees_Relife, function Trig_Trees_Relife_Actions )
endfunction

//===========================================================================
// Trigger: Bridge Restore
//===========================================================================
function Trig_Bridge_Restore_Func001C takes nothing returns boolean
    if ( not ( IsDestructableDeadBJ(gg_dest_LT07_0951) == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Bridge_Restore_Func002C takes nothing returns boolean
    if ( not ( IsDestructableDeadBJ(gg_dest_LT06_0189) == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Bridge_Restore_Actions takes nothing returns nothing
    if ( Trig_Bridge_Restore_Func001C() ) then
        call DestructableRestoreLife( gg_dest_LT07_0951, 2500.00, true )
    else
        call DoNothing(  )
    endif
    if ( Trig_Bridge_Restore_Func002C() ) then
        call DestructableRestoreLife( gg_dest_LT06_0189, 2500.00, true )
    else
        call DoNothing(  )
    endif
endfunction

//===========================================================================
function InitTrig_Bridge_Restore takes nothing returns nothing
    set gg_trg_Bridge_Restore = CreateTrigger(  )
    call TriggerRegisterTimerEventPeriodic( gg_trg_Bridge_Restore, 9.00 )
    call TriggerAddAction( gg_trg_Bridge_Restore, function Trig_Bridge_Restore_Actions )
endfunction

//===========================================================================
// Trigger: BoatRL
//===========================================================================
//TESH.scrollpos=22
//TESH.alwaysfold=0
function Trig_BoatRL_Conditions takes nothing returns boolean
    local unit u = GetTriggerUnit()
    local boolean t = IsUnitType(u, UNIT_TYPE_HERO) or GetUnitTypeId(u)=='h00B' or GetUnitTypeId(u)=='h00I'
    set u = null
    return t
endfunction

function BoatMoveRL takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_Hashtable,task,1)
    local integer i = GetUnitCurrentOrder(gg_unit_h00V_0012)
    if i == 851986 then
        call SetUnitX(u,GetUnitX(gg_unit_h00V_0012))
        call SetUnitY(u,GetUnitY(gg_unit_h00V_0012))
        call SetUnitFlyHeight(u,GetUnitFlyHeight(gg_unit_h00V_0012)+130,0)
    else
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,task)
        call SetUnitX(u,GetRectCenterX(gg_rct_HarborL)-180.0)
        call SetUnitY(u,GetRectCenterY(gg_rct_HarborL))
        call SetUnitFlyHeight(u,GetUnitDefaultFlyHeight(u),0)
        call SetUnitFacingTimed(gg_unit_h00V_0012,320,0.5)
        call EnableTrigger(gg_trg_BoatLR)
    endif
    set t = null
    set u = null
endfunction

function Trig_BoatRL_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit u = GetTriggerUnit()
    call UnitAddAbility( u , 'Amrf')
    call UnitRemoveAbility( u , 'Amrf')
    call DisableTrigger( gg_trg_BoatRL )
    call IssuePointOrder( gg_unit_h00V_0012, "move", GetRectCenterX(gg_rct_BoatL), GetRectCenterY(gg_rct_BoatL) )
    call SaveTimerHandle(udg_Hashtable,task,0,t)
    call SaveUnitHandle(udg_Hashtable,task,1,u)
    call TimerStart(t,0.02,true,function BoatMoveRL)
    set t = null
    set u = null
endfunction

//===========================================================================
function InitTrig_BoatRL takes nothing returns nothing
    set gg_trg_BoatRL = CreateTrigger()
    call TriggerRegisterEnterRectSimple( gg_trg_BoatRL, gg_rct_HarborR )
    call TriggerAddCondition( gg_trg_BoatRL, Condition( function Trig_BoatRL_Conditions ) )
    call TriggerAddAction( gg_trg_BoatRL, function Trig_BoatRL_Actions )
endfunction//===========================================================================
// Trigger: BoatLR
//===========================================================================
//TESH.scrollpos=6
//TESH.alwaysfold=0
function Trig_BoatLR_Conditions takes nothing returns boolean
    local unit u = GetTriggerUnit()
    local boolean t = IsUnitType(u, UNIT_TYPE_HERO) or GetUnitTypeId(u)=='h00B' or GetUnitTypeId(u)=='h00I' or GetUnitTypeId(u)=='n02P'
    set u = null
    return t
endfunction

function BoatMoveLR takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_Hashtable,task,1)
    local integer i = GetUnitCurrentOrder(gg_unit_h00V_0012)
    if i == 851986 then
        call SetUnitX(u,GetUnitX(gg_unit_h00V_0012))
        call SetUnitY(u,GetUnitY(gg_unit_h00V_0012))
        call SetUnitFlyHeight(u,GetUnitFlyHeight(gg_unit_h00V_0012)+130,0)
    else
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,task)
        call SetUnitX(u,GetRectCenterX(gg_rct_HarborR)+180.0)
        call SetUnitY(u,GetRectCenterY(gg_rct_HarborR))
        call SetUnitFlyHeight(u,GetUnitDefaultFlyHeight(u),0)
        call SetUnitFacingTimed(gg_unit_h00V_0012,140,0.5)
        call EnableTrigger(gg_trg_BoatRL)
    endif
    set t = null
    set u = null
endfunction

function Trig_BoatLR_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit u = GetTriggerUnit()
    call UnitAddAbility( u , 'Amrf')
    call UnitRemoveAbility( u , 'Amrf')
    call DisableTrigger( gg_trg_BoatLR )
    call IssuePointOrder( gg_unit_h00V_0012, "move", GetRectCenterX(gg_rct_BoatR), GetRectCenterY(gg_rct_BoatR) )
    call SaveTimerHandle(udg_Hashtable,task,0,t)
    call SaveUnitHandle(udg_Hashtable,task,1,u)
    call TimerStart(t,0.02,true,function BoatMoveLR)
    set t = null
    set u = null
endfunction

//===========================================================================
function InitTrig_BoatLR takes nothing returns nothing
    set gg_trg_BoatLR = CreateTrigger()
    call DisableTrigger(gg_trg_BoatLR)
    call TriggerRegisterEnterRectSimple( gg_trg_BoatLR, gg_rct_HarborL )
    call TriggerAddCondition( gg_trg_BoatLR, Condition( function Trig_BoatLR_Conditions ) )
    call TriggerAddAction( gg_trg_BoatLR, function Trig_BoatLR_Actions )
endfunction//===========================================================================
// Trigger: Jump1
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Jump1_Conditions takes nothing returns boolean
    if not IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO) then
        return false
    endif
    if GetUnitFlag(GetTriggerUnit(),CS_DASHING()) then
        return false
    endif
    return IsMobileUnit(GetTriggerUnit())
endfunction

function Trig_Jump1_Actions takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local location a = GetRectCenter(gg_rct_Jump1top)
    local location b = GetRectCenter(gg_rct_Jump1bot)
    local real ang = AngleBetweenPoints(a,b)
    local real dst = DistanceBetweenPoints(a,b)
    local effect e
    call DisableTrigger(gg_trg_Jump1)
    set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",a)
    call DestroyEffect(e)
    set e = AddSpecialEffectTarget("belt.mdl",u,"chest")
    call SetUnitFlag(u,CS_DASHING(),true)
    call JumpTimer(u,ang,dst,1.2,0.02,300)
    call TriggerSleepAction(0.2)
    call EnableTrigger(gg_trg_Jump1)
    call TriggerSleepAction(0.8)
    call SetUnitFlag(u,CS_DASHING(),false)
    call DestroyEffect(e)
    set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",b)
    call DestroyEffect(e)
    call SetUnitState(u,UNIT_STATE_LIFE,0.9*GetUnitState(u,UNIT_STATE_LIFE))
    call RemoveLocation(a)
    call RemoveLocation(b)
    set u = null
    set a = null
    set b = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Jump1 takes nothing returns nothing
    set gg_trg_Jump1 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_Jump1, gg_rct_Jump1top )
    call TriggerAddCondition( gg_trg_Jump1, Condition( function Trig_Jump1_Conditions ) )
    call TriggerAddAction( gg_trg_Jump1, function Trig_Jump1_Actions )
endfunction//===========================================================================
// Trigger: Jump2
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Jump2_Conditions takes nothing returns boolean
    if not IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO) then
        return false
    endif
    if GetUnitFlag(GetTriggerUnit(),CS_DASHING()) then
        return false
    endif
    return IsMobileUnit(GetTriggerUnit())
endfunction

function Trig_Jump2_Actions takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local location a = GetRectCenter(gg_rct_Jump2top)
    local location b = GetRectCenter(gg_rct_Jump2bot)
    local real ang = AngleBetweenPoints(a,b)
    local real dst = DistanceBetweenPoints(a,b)
    local effect e
    call DisableTrigger(gg_trg_Jump2)
    set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",a)
    call DestroyEffect(e)
    set e = AddSpecialEffectTarget("belt.mdl",u,"chest")
    call SetUnitFlag(u,CS_DASHING(),true)
    call JumpTimer(u,ang,dst,1.2,0.02,300)
    call TriggerSleepAction(0.2)
    call EnableTrigger(gg_trg_Jump2)
    call TriggerSleepAction(0.8)
    call SetUnitFlag(u,CS_DASHING(),false)
    call DestroyEffect(e)
    set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",b)
    call DestroyEffect(e)
    call SetUnitState(u,UNIT_STATE_LIFE,0.9*GetUnitState(u,UNIT_STATE_LIFE))
    call RemoveLocation(a)
    call RemoveLocation(b)
    set u = null
    set a = null
    set b = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Jump2 takes nothing returns nothing
    set gg_trg_Jump2 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_Jump2, gg_rct_Jump2top )
    call TriggerAddCondition( gg_trg_Jump2, Condition( function Trig_Jump2_Conditions ) )
    call TriggerAddAction( gg_trg_Jump2, function Trig_Jump2_Actions )
endfunction//===========================================================================
// Trigger: Jump3
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Jump3_Conditions takes nothing returns boolean
    if not IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO) then
        return false
    endif
    if GetUnitFlag(GetTriggerUnit(),CS_DASHING()) then
        return false
    endif
    return IsMobileUnit(GetTriggerUnit())
endfunction

function Trig_Jump3_Actions takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local location a = GetRectCenter(gg_rct_Jump3top)
    local location b = GetRectCenter(gg_rct_Jump3bot)
    local real ang = AngleBetweenPoints(a,b)
    local real dst = DistanceBetweenPoints(a,b)
    local effect e
    call DisableTrigger(gg_trg_Jump3)
    set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",a)
    call DestroyEffect(e)
    set e = AddSpecialEffectTarget("belt.mdl",u,"chest")
    call SetUnitFlag(u,CS_DASHING(),true)
    call JumpTimer(u,ang,dst,1.2,0.02,300)
    call TriggerSleepAction(0.2)
    call EnableTrigger(gg_trg_Jump3)
    call TriggerSleepAction(0.8)
    call SetUnitFlag(u,CS_DASHING(),false)
    call DestroyEffect(e)
    set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",b)
    call DestroyEffect(e)
    call SetUnitState(u,UNIT_STATE_LIFE,0.9*GetUnitState(u,UNIT_STATE_LIFE))
    call RemoveLocation(a)
    call RemoveLocation(b)
    set u = null
    set a = null
    set b = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Jump3 takes nothing returns nothing
    set gg_trg_Jump3 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_Jump3, gg_rct_Jump3top )
    call TriggerAddCondition( gg_trg_Jump3, Condition( function Trig_Jump3_Conditions ) )
    call TriggerAddAction( gg_trg_Jump3, function Trig_Jump3_Actions )
endfunction//===========================================================================
// Trigger: Jump4
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Jump4_Conditions takes nothing returns boolean
    if not IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO) then
        return false
    endif
    if GetUnitFlag(GetTriggerUnit(),CS_DASHING()) then
        return false
    endif
    return IsMobileUnit(GetTriggerUnit())
endfunction

function Trig_Jump4_Actions takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local location a = GetRectCenter(gg_rct_Jump4top)
    local location b = GetRectCenter(gg_rct_Jump4bot)
    local real ang = AngleBetweenPoints(a,b)
    local real dst = DistanceBetweenPoints(a,b)
    local effect e
    call DisableTrigger(gg_trg_Jump4)
    set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",a)
    call DestroyEffect(e)
    set e = AddSpecialEffectTarget("belt.mdl",u,"chest")
    call SetUnitFlag(u,CS_DASHING(),true)
    call JumpTimer(u,ang,dst,1.2,0.02,300)
    call TriggerSleepAction(0.2)
    call EnableTrigger(gg_trg_Jump4)
    call TriggerSleepAction(0.8)
    call SetUnitFlag(u,CS_DASHING(),false)
    call DestroyEffect(e)
    set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",b)
    call DestroyEffect(e)
    call SetUnitState(u,UNIT_STATE_LIFE,0.9*GetUnitState(u,UNIT_STATE_LIFE))
    call RemoveLocation(a)
    call RemoveLocation(b)
    set u = null
    set a = null
    set b = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Jump4 takes nothing returns nothing
    set gg_trg_Jump4 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_Jump4, gg_rct_Jump4top )
    call TriggerAddCondition( gg_trg_Jump4, Condition( function Trig_Jump4_Conditions ) )
    call TriggerAddAction( gg_trg_Jump4, function Trig_Jump4_Actions )
endfunction//===========================================================================
// Trigger: Jump5
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Jump5_Conditions takes nothing returns boolean
    if not IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO) then
        return false
    endif
    if GetUnitFlag(GetTriggerUnit(),CS_DASHING()) then
        return false
    endif
    return IsMobileUnit(GetTriggerUnit())
endfunction

function Trig_Jump5_Actions takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local location a = GetRectCenter(gg_rct_Jump5top)
    local location b = GetRectCenter(gg_rct_Jump5bot)
    local real ang = AngleBetweenPoints(a,b)
    local real dst = DistanceBetweenPoints(a,b)
    local effect e
    call DisableTrigger(gg_trg_Jump5)
    set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",a)
    call DestroyEffect(e)
    set e = AddSpecialEffectTarget("belt.mdl",u,"chest")
    call SetUnitFlag(u,CS_DASHING(),true)
    call JumpTimer(u,ang,dst,1.2,0.02,300)
    call TriggerSleepAction(0.2)
    call EnableTrigger(gg_trg_Jump5)
    call TriggerSleepAction(0.8)
    call SetUnitFlag(u,CS_DASHING(),false)
    call DestroyEffect(e)
    set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",b)
    call DestroyEffect(e)
    call SetUnitState(u,UNIT_STATE_LIFE,0.9*GetUnitState(u,UNIT_STATE_LIFE))
    call RemoveLocation(a)
    call RemoveLocation(b)
    set u = null
    set a = null
    set b = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Jump5 takes nothing returns nothing
    set gg_trg_Jump5 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_Jump5, gg_rct_Jump5top )
    call TriggerAddCondition( gg_trg_Jump5, Condition( function Trig_Jump5_Conditions ) )
    call TriggerAddAction( gg_trg_Jump5, function Trig_Jump5_Actions )
endfunction//===========================================================================
// Trigger: Jump6
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Jump6_Conditions takes nothing returns boolean
    if not IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO) then
        return false
    endif
    if GetUnitFlag(GetTriggerUnit(),CS_DASHING()) then
        return false
    endif
    return IsMobileUnit(GetTriggerUnit())
endfunction

function Trig_Jump6_Actions takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local location a = GetRectCenter(gg_rct_Jump6top)
    local location b = GetRectCenter(gg_rct_Jump6bot)
    local real ang = AngleBetweenPoints(a,b)
    local real dst = DistanceBetweenPoints(a,b)
    local effect e
    call DisableTrigger(gg_trg_Jump6)
    set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",a)
    call DestroyEffect(e)
    set e = AddSpecialEffectTarget("belt.mdl",u,"chest")
    call SetUnitFlag(u,CS_DASHING(),true)
    call JumpTimer(u,ang,dst,1.2,0.02,300)
    call TriggerSleepAction(0.2)
    call EnableTrigger(gg_trg_Jump6)
    call TriggerSleepAction(0.8)
    call SetUnitFlag(u,CS_DASHING(),false)
    call DestroyEffect(e)
    set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",b)
    call DestroyEffect(e)
    call SetUnitState(u,UNIT_STATE_LIFE,0.9*GetUnitState(u,UNIT_STATE_LIFE))
    call RemoveLocation(a)
    call RemoveLocation(b)
    set u = null
    set a = null
    set b = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Jump6 takes nothing returns nothing
    set gg_trg_Jump6 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_Jump6, gg_rct_Jump6top )
    call TriggerAddCondition( gg_trg_Jump6, Condition( function Trig_Jump6_Conditions ) )
    call TriggerAddAction( gg_trg_Jump6, function Trig_Jump6_Actions )
endfunction//===========================================================================
// Trigger: GoodMan
//===========================================================================
function Trig_GoodMan_Conditions takes nothing returns boolean
    if ( not ( GetManipulatedItem() == gg_item_I02O_0073 ) ) then
        return false
    endif
    return true
endfunction

function Trig_GoodMan_Actions takes nothing returns nothing
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_4392" )
    call DisableTrigger( GetTriggeringTrigger() )
    call DestroyTrigger( GetTriggeringTrigger() )
endfunction

//===========================================================================
function InitTrig_GoodMan takes nothing returns nothing
    set gg_trg_GoodMan = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_GoodMan, EVENT_PLAYER_UNIT_PICKUP_ITEM )
    call TriggerAddCondition( gg_trg_GoodMan, Condition( function Trig_GoodMan_Conditions ) )
    call TriggerAddAction( gg_trg_GoodMan, function Trig_GoodMan_Actions )
endfunction

//===========================================================================
// Trigger: Initialization Market
//===========================================================================
function Trig_Initialization_Market_Actions takes nothing returns nothing
    set udg_u = gg_unit_h00D_0013
    call TriggerRegisterUnitEvent( gg_trg_Item_Exchange, udg_u, EVENT_UNIT_SELL )
    call AddUnitToStockBJ( 'o00P', udg_u, 0, 1 )
    // ========
    set udg_u = gg_unit_h00U_0019
    call TriggerRegisterUnitEvent( gg_trg_Item_Exchange, udg_u, EVENT_UNIT_SELL )
    call AddUnitToStockBJ( 'o00P', udg_u, 0, 1 )
endfunction

//===========================================================================
function InitTrig_Initialization_Market takes nothing returns nothing
    set gg_trg_Initialization_Market = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initialization_Market, function Trig_Initialization_Market_Actions )
endfunction

//===========================================================================
// Trigger: Item System
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function THD_IsItemTypePrivate takes integer d returns boolean
    if d=='I000' then
        return false
    endif//符
    if d=='I03H' then
        return false
    endif//P点
    if ('I03C'<=d) and (d<='I03E') then
        return false
    endif//蓬莱药  
    if d=='I02U' then
        return false
    endif//树眼
    if d=='I016' then
        return false
    endif//天狗
    if d=='I00F' then
        return false
    endif//和谐
    return true
endfunction

function THD_SetItemOwner takes item w,player who returns nothing
    if w==null or GetWidgetLife(w)<=0 then
        return
    endif
    if who==null or GetPlayerId(who)>=12 then
        call SetItemPlayer(w,Player(PLAYER_NEUTRAL_PASSIVE),false)
    else
        call SetItemPlayer(w,who,false)
    endif
endfunction

function THD_GetItemOwner takes item w returns player
    if w==null or GetWidgetLife(w)<=0 then
        return null
    else
        return GetItemPlayer(w)
    endif
endfunction

//==============================================================================

function Trig_Item_Check_Owner takes nothing returns boolean
    local player who = THD_GetItemOwner(GetManipulatedItem())
    if who==Player(PLAYER_NEUTRAL_PASSIVE) or who==null then
        if GetPlayerSlotState(GetTriggerPlayer())==PLAYER_SLOT_STATE_PLAYING then
            call THD_SetItemOwner(GetManipulatedItem(),GetTriggerPlayer())
        endif
        set who = null
        return true
    endif
    if who!=GetTriggerPlayer() then
        call UnitDropItemPoint(GetTriggerUnit(),GetManipulatedItem(),GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()))
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"此物非你所有")
        set who = null
        return false
    endif
    set who = null
    return true
endfunction

function Trig_Item_Auto_Stack takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local item pick = GetManipulatedItem()
    local item hold = null
    local item temp = null
    local integer w = GetItemTypeId(pick)
    local integer get = GetItemCharges(pick)
    local integer has = 99
    local integer max = 12
    local integer i
    //========
    set i = 0
    loop
        exitwhen i >= bj_MAX_INVENTORY
        set temp = UnitItemInSlot(u,i)
        if GetItemTypeId(temp)==w and temp!=pick then
            if GetItemCharges(temp) < has then
                set hold = temp
                set has = GetItemCharges(hold)
            endif
        endif
        set i = i + 1
    endloop
    //--------
    if hold != null then
        if has <= max - get then
            call RemoveItem(pick)
            call SetItemCharges( hold, has + get )
        else
            call SetItemCharges( hold, max )
            call SetItemCharges( pick, (has+get-max) )
        endif
    endif
    //========
    set u = null
    set pick = null
    set hold = null
    set temp = null
endfunction

function Trig_Item_System_Conditions takes nothing returns boolean
    if GetUnitAbilityLevel(GetTriggerUnit(),'Aloc')>0 then
        return false
    endif
    if THD_IsItemTypePrivate(GetItemTypeId(GetManipulatedItem())) then
        if Trig_Item_Check_Owner()==false then
            return false
        endif
    endif
    if GetItemType(GetManipulatedItem())==ITEM_TYPE_PURCHASABLE then
        call Trig_Item_Auto_Stack()
    endif
    if udg_HC_Lock then
        return false
    endif
    return true
endfunction

function Trig_Item_System_Actions takes nothing returns nothing
    local unit h = GetTriggerUnit()
    local item w = GetManipulatedItem()
    local integer c = GetItemTypeId(w)
    local integer i
    local integer n = HC_GetCapSN()
    local boolean k = false
    
    set udg_HC_Lock = true
    
    set i = 0
    loop
        exitwhen i>=n
        if not HC_IsValidSN(i) then
            set k = false
        elseif HC_CheckPossibilty(i,c)==false then
            set k = false
        elseif HC_PopFormula(i)==false then
            set k = false
        elseif HC_CheckMaterials(h)==false then
            set k = false
        elseif HC_ActivateFormula(h) then
            set k = true
        endif
        exitwhen k
        set i = i + 1
    endloop
    
    if not k then
        set udg_HC_Lock = false
    else
        call DestroyEffect(AddSpecialEffectTarget( "Abilities\\Spells\\Items\\AIem\\AIemTarget.mdl",h,"origin"))
        call DebugMsg("道具合成成功！")
    endif
    
    set h = null
    set w = null
endfunction

//===========================================================================
function InitTrig_Item_System takes nothing returns nothing
    set gg_trg_Item_System = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Item_System, EVENT_PLAYER_UNIT_PICKUP_ITEM )
    call TriggerAddCondition( gg_trg_Item_System, Condition( function Trig_Item_System_Conditions ) )
    call TriggerAddAction( gg_trg_Item_System, function Trig_Item_System_Actions )
endfunction
//===========================================================================
// Trigger: Item Exchange
//
// 用出售单位的方式来出售物品那个中间的替换步骤的触发。
// 使用方式参考现有的那些。
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Item_Exchange_Conditions takes nothing returns boolean
    return GetUnitState(GetSoldUnit(),UNIT_STATE_MAX_MANA)==222
endfunction

function Trig_Item_Exchange_Actions takes nothing returns nothing
    local unit u = GetSellingUnit()
    local unit v = GetSoldUnit()
    local player who = GetOwningPlayer(v)
    local unit h
    local item w
    local real x
    local real y
    local integer d = GetUnitTypeId(v)
    local string data = GetUnitName(v)
    local integer i
    local integer c
    local integer costA = S2I(SubString(data,14,18))
    local integer costB = S2I(SubString(data,18,22))
    local boolean k
    //========
    //call DebugMsg(I2S(costA)+","+I2S(costB))
    if IsPlayerEnemy(who,GetOwningPlayer(GetSellingUnit())) then
        call DisplayTextToPlayer(who,0,0,"不能从对方的神社购买这类物品")
        call RemoveItemFromStock(u,d)
        call AddUnitToStock(u,d,1,1)
        call AdjustPlayerStateSimpleBJ(GetOwningPlayer(GetSoldUnit()),PLAYER_STATE_RESOURCE_GOLD,costA)//退钱
        call THD_SyncSpirit()
    else
        set c = StringToID(SubString(data,6,10))
        
        if THD_GetSpirit(who) < costB then
            call DisplayTextToPlayer( who , 0, 0, "信仰不足！" )
            call RemoveItemFromStock(u,d)
            call AddUnitToStock(u,d,1,1)
            call AdjustPlayerStateSimpleBJ(GetOwningPlayer(GetSoldUnit()),PLAYER_STATE_RESOURCE_GOLD,costA)//退钱
            call THD_SyncSpirit()
        else
            set h = GetPlayerCharacter(who)
            set k = IsUnitAlive(h) and IsUnitInRange(u,h,1000.0)
            if k then
                set x = GetUnitX(h)
                set y = GetUnitY(h)
            else
                set x = GetLocationX(GetPlayerRevivePoint(who))
                set y = GetLocationY(GetPlayerRevivePoint(who))
            endif
            //call RemoveItemFromStock(u,d)
            call THD_AddSpirit(who,-costB)
            set w = CreateItem(c,x,y)
            call THD_SetItemOwner(w,who)
            if k then
                call UnitAddItem(h,w)
            endif
            //call AddUnitToStock(u,d,0,1)
        call DebugMsg("出售特殊物品")
        endif
    endif
    //========
    set u = null
    set v = null
    set h = null
    set w = null
    set who = null
    set data = null
endfunction

//===========================================================================
function InitTrig_Item_Exchange takes nothing returns nothing
    set gg_trg_Item_Exchange = CreateTrigger()
    call TriggerAddCondition( gg_trg_Item_Exchange, Condition( function Trig_Item_Exchange_Conditions ) )
    call TriggerAddAction( gg_trg_Item_Exchange, function Trig_Item_Exchange_Actions )
endfunction
//===========================================================================
// Trigger: Initialization CE
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function CE_Input takes unit h,unit v,real amount returns nothing
    local integer A = GetPlayerId(GetOwningPlayer(h))
    local integer B = GetPlayerId(GetOwningPlayer(v))
    local integer offset = 512 + B*16 + A
    set udg_CE_Response[offset] = udg_CE_Response[offset] + amount
endfunction

function CE_Set takes unit h,unit v,real amount returns nothing
    local integer A = GetPlayerId(GetOwningPlayer(h))
    local integer B = GetPlayerId(GetOwningPlayer(v))
    local integer offset = B*16 + A
    set udg_CE_Response[offset] = udg_CE_Response[offset] + amount
endfunction

function CE_Response_Decay takes nothing returns nothing
    local integer c = udg_CE_state[0]
    local integer i
    local real u
    local real d
    
    if c/2*2==c then
        set i = 256
        loop
            exitwhen i>=512
            set u = udg_CE_Response[i + 256]
            set udg_CE_Response[i] = 0.9*udg_CE_Response[i] + u
            set udg_CE_Response[i + 256] = 0.0
            set i = i + 1
        endloop
    else
        set i = 0
        loop
            exitwhen i>=256
            set d = udg_CE_Response[i + 256]
            set udg_CE_Response[i] = 0.80*udg_CE_Response[i] + 0.5*d
            set i = i + 1
        endloop
    endif
    
    set udg_CE_state[0] = c + 1
    
endfunction

function Trig_Initialization_CE_Actions takes nothing returns nothing
    local integer i
    local timer t
    
    set i = 0
    loop
        exitwhen i>=32
        set udg_CE_state[i] = 0
        set udg_CE_register[i] = 0
        set i = i + 1
    endloop
    
    set i = 0
    loop
        exitwhen i>=1024
        set udg_CE_Response[i] = 0.0
        set i = i + 1
    endloop
    
    set t = CreateTimer()
    call TimerStart(t,0.05,true,function CE_Response_Decay)
    
    set t = null
endfunction

//===========================================================================
function InitTrig_Initialization_CE takes nothing returns nothing
    set gg_trg_Initialization_CE = CreateTrigger()
    call TriggerAddAction( gg_trg_Initialization_CE, function Trig_Initialization_CE_Actions )
endfunction
//===========================================================================
// Trigger: CE Input
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_CE_Input_Conditions takes nothing returns boolean
    return GetEventDamage()>0.0
endfunction

function Trig_CE_Input_Actions takes nothing returns nothing
    local unit h = GetEventDamageSource()
    local unit v = GetTriggerUnit()
    local real HP = GetUnitState(v,UNIT_STATE_LIFE)
    local real MAX = GetUnitState(v,UNIT_STATE_MAX_LIFE)
    local real damage = RMinBJ(GetEventDamage(),HP)
    local real input = 100.0*damage/MAX
    if damage<HP then
        call CE_Input(h,v,input)
    else
        call CE_Set(h,v,input)
    endif
    set h = null
    set v = null
endfunction

//===========================================================================
function InitTrig_CE_Input takes nothing returns nothing
    set gg_trg_CE_Input = CreateTrigger()
    call TriggerAddCondition( gg_trg_CE_Input, Condition( function Trig_CE_Input_Conditions ) )
    call TriggerAddAction( gg_trg_CE_Input, function Trig_CE_Input_Actions )
endfunction

//===========================================================================
// Trigger: CE Bonus
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function CE_Bonus takes unit h, unit v,real total,real extra returns nothing
    local player A = GetOwningPlayer(h)
    local player B = GetOwningPlayer(v)
    local player w
    local integer i
    local integer offset = GetPlayerId(B)*16
    local real p
    local real s
    local integer d
    local string msg
    
    set s = 0.0
    set i = 0
    loop
        exitwhen i>=16
        set w = Player(i)
        if GetPlayerCharacter(w)!=null and IsPlayerOpponent(w,B) then
            set p = udg_CE_Response[offset + i]
            set udg_CE_Response[offset + i] = 0.0
            set s = s + p
            set udg_CE_register[i] = p
        else
            set udg_CE_register[i] = 0.0
        endif
        set i = i + 1
    endloop
    
    set i = 0
    loop
        exitwhen i>=16
        set w = Player(i)
        set p = total*(udg_CE_register[i]/s)
        if w==A then
            set d = R2I(p + extra)
            if d > 0 then
                set msg = "击杀敌方少女得到额外" + I2S(d) + "点奖励"
                call BroadcastMessage(msg)
            endif
            call THD_AddCredit(w,d)
            if GetUnitTypeId(GetPlayerCharacter(w)) == 'H009' then
                call THD_AddSpirit(w,2)
            elseif GetUnitTypeId(GetPlayerCharacter(w)) == 'H001' then
               call THD_AddCredit(w,80)
            endif
        else
            set udg_CE_register[i] = p
        endif
        set i = i + 1
    endloop
    
    set i = 0
    loop
        exitwhen i>=16
        set w = Player(i)
        set d = R2I(udg_CE_register[i])
        if d>0 and w!=A then
            if udg_DebugMode then
                set msg = PlayerName(w) + ": " + I2S(d + 100)
                call DebugMsg(msg)
            else
                set msg = "协助击杀敌方少女得到额外" + I2S(d + 100) + "点奖励"
                call DisplayTimedTextToPlayer(w,0,0,6.0,msg)
            endif
            set udg_FlagAssist[GetPlayerId(w)] = udg_FlagAssist[GetPlayerId(w)] + 1
            call GIB_SetPlayerField(w,GIB_COLUMN_FLAG_ASSIST(),I2S(udg_FlagAssist[GetPlayerId(w)]))
            call THD_AddCredit(w,d + 100)
            if GetUnitTypeId(GetPlayerCharacter(w)) == 'H009' then
                call THD_AddSpirit(w,2)
            elseif GetUnitTypeId(GetPlayerCharacter(w)) == 'H001' then
               call THD_AddCredit(w,80)
            endif
        endif
        set udg_CE_register[i] = 0.0
        set i = i + 1
    endloop
    
    set h = null
    set v = null
    set A = null
    set B = null
    set w = null
    set msg = null
endfunction

//===========================================================================
function InitTrig_CE_Bonus takes nothing returns nothing
    //set gg_trg_CE_Bonus = CreateTrigger()
    //call TriggerAddAction( gg_trg_CE_Bonus, function Trig_CE_Bonus_Actions )
endfunction
//===========================================================================
// Trigger: Announce Bonus
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function AnnounceHeroBonus takes unit killer,unit dead returns boolean
    local player winner = GetOwningPlayer(killer)
    local player loser = GetOwningPlayer(dead)
    local integer giveGold = 100 + 8*GetHeroLevel(dead)
    local integer loseGold = 10*GetHeroLevel(dead)
    local integer bonus = 0
    local force team = null
    local boolean TK = false
    local integer perfect
    local string msg
    
    //========
    
    set udg_FlagDeath[GetPlayerId(loser)] = udg_FlagDeath[GetPlayerId(loser)] + 1
    call THD_AddCredit(loser,-loseGold)
    set bonus = udg_FlagPerfect[GetPlayerId(loser)]
    set udg_FlagPerfect[GetPlayerId(loser)] = 0
    
    //========
    
    if winner == loser then
        set msg = PlayerName(loser) + " 自杀了，损失 " + I2S(loseGold) + " 点"
        call BroadcastMessage(msg)
        set winner = null
        set loser = null
        set team = null
        set msg = null
        return false
    endif
    
    if winner == Player(PLAYER_NEUTRAL_AGGRESSIVE) then
        set msg = PlayerName(loser) + " 被路人推倒了，损失 " + I2S(loseGold) + " 点"
        call BroadcastMessage(msg)
        set udg_FlagKill[GetPlayerId(winner)] = udg_FlagKill[GetPlayerId(winner)] + 1
        set winner = null
        set loser = null
        set team = null
        set msg = null
        return false
    endif
    
    //========
    
    if winner == udg_PlayerA[0] then
        if not IsPlayerInForce(loser,udg_TeamB) then
            set msg = PlayerName(loser) + " 被和谐了！"
            call BroadcastMessage(msg)
            set winner = null
            set loser = null
            set team = null
            set msg = null
            return false
        endif
        
        set msg = PlayerName(udg_PlayerA[0]) + " 击败了 " + PlayerName(loser)
        set msg = msg + "，队友将平分 " + I2S(50 + giveGold) + " 点"
        call BroadcastMessage(msg)
        
        call CE_Bonus(killer,dead,giveGold,0)
        //call ShareGold(udg_TeamA,50 + giveGold)
        
        set udg_FlagKill[GetPlayerId(winner)] = udg_FlagKill[GetPlayerId(winner)] + 1
        
        set winner = null
        set loser = null
        set team = null
        set msg = null
        return true
    endif
    if winner == udg_PlayerB[0] then
        if not IsPlayerInForce(loser,udg_TeamA) then
            set msg = PlayerName(loser) + " 被和谐了！"
            call BroadcastMessage(msg)
            set winner = null
            set loser = null
            set team = null
            set msg = null
            return false
        endif
        
        set msg = PlayerName(udg_PlayerB[0]) + " 击败了 " + PlayerName(loser)
        set msg = msg + "，队友将平分 " + I2S(50 + giveGold) + " 点"
        call BroadcastMessage(msg)
        
        call CE_Bonus(killer,dead,giveGold,0)
        //call ShareGold(udg_TeamB,50 + giveGold)
        
        set udg_FlagKill[GetPlayerId(winner)] = udg_FlagKill[GetPlayerId(winner)] + 1
        set winner = null
        set loser = null
        set team = null
        set msg = null
        return true
    endif
    
    //========
    
    //那纠结的关系。。。。。。 
    if IsPlayerAlly(winner,loser) then
        set team = null
        set TK = true
    elseif IsPlayerInForce(winner,udg_TeamA) or winner==udg_PlayerA[0] then
        if IsPlayerInForce(loser,udg_TeamB) then
            set team = udg_TeamA
            set udg_FlagKill[4] = udg_FlagKill[4] + 1
        else
            set team = null
            set TK = true
        endif
    elseif IsPlayerInForce(winner,udg_TeamB) or winner==udg_PlayerB[0] then
        if IsPlayerInForce(loser,udg_TeamA) then
            set team = udg_TeamB
            set udg_FlagKill[10] = udg_FlagKill[10] + 1
        else
            set team = null
            set TK = true
        endif
    endif
    
    if team != null then
        
        //战胜触手补偿
        if bonus>=12 then
            call AddHeroXP(killer,IMinBJ(212,43 + (bonus-12)*22),true)
            set giveGold = IMinBJ(1000,giveGold + bonus*33)
            set msg = PlayerName(winner) + " 成功推倒了傲气无比的 " + PlayerName(loser)
            call BroadcastMessage(msg)
            call CE_Bonus(killer,dead,giveGold,250)
        else
            set msg = PlayerName(winner) + " 击败了 " + PlayerName(loser)
            call BroadcastMessage(msg)
            call CE_Bonus(killer,dead,giveGold,50)
        endif
        
        //set msg = "获得额外奖励 " + I2S(giveGold) + " 点"
        //call BroadcastMessage(msg)
        //call AdjustPlayerStateBJ(giveGold,winner,PLAYER_STATE_RESOURCE_GOLD)
        
        set udg_FlagKill[GetPlayerId(winner)] = udg_FlagKill[GetPlayerId(winner)] + 1
        
        if udg_FlagFirst then
            set udg_FlagFirst = false
            set msg = "|cffffcc00首次推倒事件，额外奖励300点！|r"
            call BroadcastMessage(msg)
            call THD_AddCredit(winner,300)
        endif
        
        //连杀统计
        set udg_FlagPerfect[GetPlayerId(winner)] = udg_FlagPerfect[GetPlayerId(winner)] + 1
        
        set winner = null
        set loser = null
        set team = null
        set msg = null
        return true
        
    endif
    
    if TK then
        set msg = PlayerName(winner) + " 误推了 " + PlayerName(loser)
        call BroadcastMessage(msg)
        set msg = "啥奖励也没有……"
        call BroadcastMessage(msg)
        set winner = null
        set loser = null
        set team = null
        set msg = null
        return false
    endif
    
    //if winner==udg_PlayerA[5] then
    //    set msg = PlayerName(loser) + " 被玄爷之魂轰飞了……"
    //    call BroadcastMessage(msg)
    //    
    //    set winner = null
    //    set loser = null
    //    set team = null
    //    set msg = null
    //    return false
    //endif
    
    //========
    
    set msg = PlayerName(loser) + " 被UFO带到星莲船里去了……"
    call BroadcastMessage(msg)
    
    set winner = null
    set loser = null
    set team = null
    set msg = null
    return false
endfunction

//===========================================================================
function InitTrig_Announce_Bonus takes nothing returns nothing
    //set gg_trg_Announce_Bonus = CreateTrigger()
    //call TriggerAddAction( gg_trg_Announce_Bonus, function Trig_Bonus_Actions )
endfunction

//===========================================================================
// Trigger: Game Start
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏运行--游戏开始
//===========================================================================
function Trig_Game_Start_Func014A takes nothing returns nothing
    set udg_PlayerPower[GetConvertedPlayerId(GetEnumPlayer())] = udg_GameSetting_Power[0]
endfunction

function Trig_Game_Start_Func015A takes nothing returns nothing
    call THD_AddCredit(GetEnumPlayer(),udg_GameSetting_Gold[0])
    call TriggerRegisterPlayerEventLeave( gg_trg_Player_Left, GetEnumPlayer() )
endfunction

function Trig_Game_Start_Func036A takes nothing returns nothing
    call TriggerRegisterPlayerUnitEventSimple( gg_trg_Power_Get, GetEnumPlayer(), EVENT_PLAYER_UNIT_PICKUP_ITEM )
    call TriggerRegisterPlayerUnitEventSimple( gg_trg_Power_Lost, GetEnumPlayer(), EVENT_PLAYER_UNIT_DEATH )
    call TriggerRegisterPlayerUnitEventSimple( gg_trg_Hero_Event, GetEnumPlayer(), EVENT_PLAYER_UNIT_DEATH )
endfunction

function Trig_Game_Start_Actions takes nothing returns nothing
    call SetSkyModel( "Environment\\Sky\\Sky\\SkyLight.mdl" )
    call EnableTrigger( gg_trg_Weather_Fog_System )
    call TriggerExecute( gg_trg_Weather_Fog_System )
    set udg_WE_FallingLeaves = AddWeatherEffect( gg_rct_FallingLeaves, 'SNbs' )
    call EnableWeatherEffect( udg_WE_FallingLeaves, true )
    set udg_WE_SunShine = AddWeatherEffect( gg_rct_SunShine, 'LRaa' )
    call EnableWeatherEffect( udg_WE_SunShine, true )
    call SetTimeOfDayScalePercentBJ( 50.00 )
    set udg_FlagFirst = true
    set bj_forLoopBIndex = 0
    set bj_forLoopBIndexEnd = 5
    loop
        exitwhen bj_forLoopBIndex > bj_forLoopBIndexEnd
        call SetPlayerFlagBJ( PLAYER_STATE_GIVES_BOUNTY, true, udg_PlayerA[bj_forLoopBIndex] )
        set bj_forLoopBIndex = bj_forLoopBIndex + 1
    endloop
    set bj_forLoopBIndex = 0
    set bj_forLoopBIndexEnd = 5
    loop
        exitwhen bj_forLoopBIndex > bj_forLoopBIndexEnd
        call SetPlayerFlagBJ( PLAYER_STATE_GIVES_BOUNTY, true, udg_PlayerB[bj_forLoopBIndex] )
        set bj_forLoopBIndex = bj_forLoopBIndex + 1
    endloop
    set udg_ScoreSpirit[4] = udg_GameSetting_Spirit[0]
    set udg_ScoreSpirit[10] = udg_GameSetting_Spirit[0]
    call ForForce( udg_OnlinePlayers, function Trig_Game_Start_Func014A )
    call ForForce( udg_OnlinePlayers, function Trig_Game_Start_Func015A )
    // ========
    // 激活其余系统
    // ========
    call TriggerRegisterTimerEventPeriodic( gg_trg_Time_Event, 1.00 )
    call TriggerExecute( gg_trg_Setup_Game_Info_Board )
    // ========
    call Trig_Spawn_Units_AI_Init()
    call TriggerRegisterTimerEventPeriodic( gg_trg_RuneBorn, 120.00 )
    call TriggerExecute( gg_trg_Route_Order )
    call TriggerRegisterTimerEventPeriodic( gg_trg_Refresh_Order, 57.00 )
    call TriggerRegisterTimerEventPeriodic( gg_trg_Spawn_A, 30.00 )
    call DisableTrigger( gg_trg_Spawn_A )
    call TriggerRegisterTimerEventPeriodic( gg_trg_Spawn_B, 30.00 )
    call DisableTrigger( gg_trg_Spawn_B )
    call TriggerRegisterTimerEventPeriodic( gg_trg_Spawn_Levelup, 180.00 )
    call TriggerRegisterPlayerUnitEventSimple( gg_trg_Keep_Order_A, udg_PlayerA[0], EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER )
    call TriggerRegisterPlayerUnitEventSimple( gg_trg_Keep_Order_B, udg_PlayerB[0], EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER )
    // ========
    call ConditionalTriggerExecute( gg_trg_Neutral_System )
    // ========
    call ForForce( udg_OnlinePlayers, function Trig_Game_Start_Func036A )
    call TriggerRegisterPlayerUnitEventSimple( gg_trg_Point_Creat, udg_PlayerA[0], EVENT_PLAYER_UNIT_DEATH )
    call TriggerRegisterPlayerUnitEventSimple( gg_trg_Point_Creat, udg_PlayerB[0], EVENT_PLAYER_UNIT_DEATH )
    call TriggerRegisterUnitEvent( gg_trg_Victory, udg_BaseA[0], EVENT_UNIT_DEATH )
    call TriggerRegisterUnitEvent( gg_trg_Victory, udg_BaseB[0], EVENT_UNIT_DEATH )
    call ConditionalTriggerExecute( gg_trg_AI_Init )
    // 音乐开始
    call EndThematicMusic(  )
    call ResumeMusic(  )
    // ========
    call PolledWait( 20.00 )
    call TriggerExecute( gg_trg_Announce )
    call PolledWait( 30.00 )
    // 刷兵开始
    call EnableTrigger( gg_trg_Spawn_A )
    call EnableTrigger( gg_trg_Spawn_B )
endfunction

//===========================================================================
function InitTrig_Game_Start takes nothing returns nothing
    set gg_trg_Game_Start = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Game_Start, function Trig_Game_Start_Actions )
endfunction

//===========================================================================
// Trigger: Time Event
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 时间显示
// 增加黄金
// 增加信仰
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Time_Event_Func005A takes nothing returns nothing
    call AdjustPlayerStateBJ( udg_GameSetting_Gold[1], GetEnumPlayer(), PLAYER_STATE_RESOURCE_GOLD )
endfunction

function Trig_Time_Event_SyncPower takes nothing returns nothing
    call SetPlayerStateBJ( GetEnumPlayer(), PLAYER_STATE_RESOURCE_FOOD_USED, udg_PlayerPower[GetConvertedPlayerId(GetEnumPlayer())] )
    call SetPlayerStateBJ( GetEnumPlayer(), PLAYER_STATE_RESOURCE_FOOD_CAP, 30 )
endfunction

function Trig_Time_Event_Actions takes nothing returns nothing
    
    set udg_GameTime = ( udg_GameTime + 1 )
    call TriggerExecute( gg_trg_Set_GIB_Clock )
    
    //增加黄金
    call ForForce( udg_OnlinePlayers, function Trig_Time_Event_Func005A )
    
    //每分钟增加信仰
    if udg_GameTime/60*60 == udg_GameTime then
        call THD_AddSpirit(udg_PlayerA[0],udg_GameSetting_Spirit[3])
        call THD_AddSpirit(udg_PlayerB[0],udg_GameSetting_Spirit[3])
    endif
    
    //同步P点的的显示
    call ForForce( udg_OnlinePlayers, function Trig_Time_Event_SyncPower )
    
endfunction

//===========================================================================
function InitTrig_Time_Event takes nothing returns nothing
    set gg_trg_Time_Event = CreateTrigger()
    call TriggerAddAction( gg_trg_Time_Event, function Trig_Time_Event_Actions )
endfunction

//===========================================================================
// Trigger: Money
//===========================================================================
function Trig_Money_Actions takes nothing returns nothing
    call SetPlayerStateBJ( Player(4), PLAYER_STATE_RESOURCE_GOLD, 0 )
    call SetPlayerStateBJ( Player(10), PLAYER_STATE_RESOURCE_GOLD, 0 )
endfunction

//===========================================================================
function InitTrig_Money takes nothing returns nothing
    set gg_trg_Money = CreateTrigger(  )
    call TriggerRegisterPlayerStateEvent( gg_trg_Money, Player(4), PLAYER_STATE_RESOURCE_GOLD, GREATER_THAN_OR_EQUAL, 0.00 )
    call TriggerRegisterPlayerStateEvent( gg_trg_Money, Player(10), PLAYER_STATE_RESOURCE_GOLD, GREATER_THAN_OR_EQUAL, 0.00 )
    call TriggerAddAction( gg_trg_Money, function Trig_Money_Actions )
endfunction

//===========================================================================
// Trigger: Share
//===========================================================================
function Trig_Share_Actions takes nothing returns nothing
    call SetPlayerAlliance( Player(4), Player(0), ALLIANCE_SHARED_CONTROL, false )
    call SetPlayerAlliance( Player(4), Player(1), ALLIANCE_SHARED_CONTROL, false )
    call SetPlayerAlliance( Player(4), Player(2), ALLIANCE_SHARED_CONTROL, false )
    call SetPlayerAlliance( Player(4), Player(3), ALLIANCE_SHARED_CONTROL, false )
    call SetPlayerAlliance( Player(10), Player(6), ALLIANCE_SHARED_CONTROL, false )
    call SetPlayerAlliance( Player(10), Player(7), ALLIANCE_SHARED_CONTROL, false )
    call SetPlayerAlliance( Player(10), Player(8), ALLIANCE_SHARED_CONTROL, false )
    call SetPlayerAlliance( Player(10), Player(9), ALLIANCE_SHARED_CONTROL, false )
endfunction

//===========================================================================
function InitTrig_Share takes nothing returns nothing
    set gg_trg_Share = CreateTrigger(  )
    call TriggerRegisterPlayerAllianceChange( gg_trg_Share, Player(4), ALLIANCE_SHARED_CONTROL )
    call TriggerRegisterPlayerAllianceChange( gg_trg_Share, Player(10), ALLIANCE_SHARED_CONTROL )
    call TriggerAddAction( gg_trg_Share, function Trig_Share_Actions )
endfunction

//===========================================================================
// Trigger: Point Creat
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Point_Creat_Conditions takes nothing returns boolean
    local real rate = 15.0
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_TAUREN) then
        return false
    endif
    if udg_SK_Nazrin04_ON and udg_SK_Nazrin04!=null and IsUnitInRange(GetTriggerUnit(),udg_SK_Nazrin04,1200.0) then
        set rate = rate + 12.0*GetUnitAbilityLevel(udg_SK_Nazrin04,'A0D6')
        //call DebugMsg(R2S(rate))
    endif
    if GetOwningPlayer(GetKillingUnit())==udg_PlayerA[0] then
        return GetRandomReal(0,100)<=rate
    endif
    if GetOwningPlayer(GetKillingUnit())==udg_PlayerB[0] then
        return GetRandomReal(0,100)<=rate
    endif
    return false
endfunction

function Trig_Point_Remove takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local item w = LoadItemHandle(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,0)
    if i==0 and GetWidgetLife(w)>0 then
        call SetWidgetLife(w,-1)
        call SaveInteger(udg_ht,task,0,1)
        call TimerStart(t,0.7,false,function Trig_Point_Remove)
    else
        call RemoveItem(w)
        call DestroyTimer(t)
    endif
    set t = null
    set w = null
endfunction

function Trig_Point_Creat_Actions takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local item w = CreateItem('I03F',GetUnitX(u),GetUnitY(u))
    local timer t
    local integer task
    
    set t = CreateTimer()
    set task = GetHandleId(t)
    call SaveInteger(udg_ht,task,0,0)
    call SaveItemHandle(udg_ht,task,0,w)
    call TimerStart(t,10.0,false,function Trig_Point_Remove)//Point存在时间
    
    set w = null
    set t = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Point_Creat takes nothing returns nothing
    set gg_trg_Point_Creat = CreateTrigger()
    call TriggerAddCondition( gg_trg_Point_Creat, Condition( function Trig_Point_Creat_Conditions ) )
    call TriggerAddAction( gg_trg_Point_Creat, function Trig_Point_Creat_Actions )
endfunction
//===========================================================================
// Trigger: Point Delete
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 删除掉落的点
// (1.24的物品拾取后使用其实没有消失)
// 其实ItemClear触发里每60秒也会删除一次
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Point_Delete_Conditions takes nothing returns boolean
    return GetItemTypeId(GetManipulatedItem())=='I03F'
endfunction

function Trig_Point_Delete_Actions takes nothing returns nothing
    call RemoveItem(GetManipulatedItem())
endfunction

//===========================================================================
function InitTrig_Point_Delete takes nothing returns nothing
    set gg_trg_Point_Delete = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Point_Delete, EVENT_PLAYER_UNIT_PICKUP_ITEM )
    call TriggerAddCondition( gg_trg_Point_Delete, Condition( function Trig_Point_Delete_Conditions ) )
    call TriggerAddAction( gg_trg_Point_Delete, function Trig_Point_Delete_Actions )
endfunction
//===========================================================================
// Trigger: Attack
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 涉及反补等
//===========================================================================
function Trig_Attack_Conditions takes nothing returns boolean
    if ( not ( GetIssuedOrderIdBJ() == String2OrderIdBJ("attack") ) ) then
        return false
    endif
    if ( not ( IsUnitAlly(GetOrderTargetUnit(), GetTriggerPlayer()) == true ) ) then
        return false
    endif
    if ( not ( GetUnitTypeId(GetOrderTargetUnit()) != 'n01M' ) ) then
        return false
    endif
    if ( not ( GetUnitTypeId(GetOrderTargetUnit()) != 'o00C' ) ) then
        return false
    endif
    if ( not ( GetUnitTypeId(GetOrderTargetUnit()) != 'o00D' ) ) then
        return false
    endif
    return true
endfunction

function Trig_Attack_Func003Func001Func001C takes nothing returns boolean
    if ( not ( GetUnitLifePercent(GetOrderTargetUnit()) >= 10.00 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Attack_Func003Func001Func002C takes nothing returns boolean
    if ( not ( GetUnitLifePercent(GetOrderTargetUnit()) >= 50.00 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Attack_Func003Func001C takes nothing returns boolean
    if ( not ( IsUnitType(GetOrderTargetUnit(), UNIT_TYPE_STRUCTURE) == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Attack_Func003C takes nothing returns boolean
    if ( not ( IsUnitType(GetOrderTargetUnit(), UNIT_TYPE_HERO) == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Attack_Actions takes nothing returns nothing
    local real x = GetUnitX(GetOrderTargetUnit())
    local real y = GetUnitY(GetOrderTargetUnit())
    if ( Trig_Attack_Func003C() ) then
        call IssuePointOrder(GetTriggerUnit(),"attack",x,y)
        call DisplayTextToPlayer( GetTriggerPlayer(), 0, 0, "TRIGSTR_6392" )
    else
        if ( Trig_Attack_Func003Func001C() ) then
            if ( Trig_Attack_Func003Func001Func001C() ) then
                call IssuePointOrder(GetTriggerUnit(),"attack",x,y)
                call DisplayTextToPlayer( GetTriggerPlayer(), 0, 0, "TRIGSTR_6390" )
            else
                call DoNothing(  )
            endif
        else
            if ( Trig_Attack_Func003Func001Func002C() ) then
                call IssuePointOrder(GetTriggerUnit(),"attack",x,y)
                call DisplayTextToPlayer( GetTriggerPlayer(), 0, 0, "TRIGSTR_6391" )
            else
                call DoNothing(  )
            endif
        endif
    endif
endfunction

//===========================================================================
function InitTrig_Attack takes nothing returns nothing
    set gg_trg_Attack = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Attack, EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER )
    call TriggerAddCondition( gg_trg_Attack, Condition( function Trig_Attack_Conditions ) )
    call TriggerAddAction( gg_trg_Attack, function Trig_Attack_Actions )
endfunction

//===========================================================================
// Trigger: Deny
//
// 反补出感叹号
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Deny_Conditions takes nothing returns boolean
    if ( not ( IsUnitAlly(GetKillingUnitBJ(), GetTriggerPlayer()) == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Deny_Actions takes nothing returns nothing
    local texttag tag = CreateTextTag()
    local unit u = GetTriggerUnit()
    call SetTextTagText(tag, "!", .03)
    call SetTextTagPosUnit(tag, u, 0)
    call SetTextTagColorBJ(tag, 255, 255, 255, 15)
    call SetTextTagVelocity(tag, 0, .035)
    call SetTextTagFadepoint(tag, 3)
    call SetTextTagLifespan(tag, 1.5)
    call SetTextTagPermanent(tag, false)
    call SetTextTagVisibility(tag, true)
    set tag = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Deny takes nothing returns nothing
    set gg_trg_Deny = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Deny, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_Deny, Condition( function Trig_Deny_Conditions ) )
    call TriggerAddAction( gg_trg_Deny, function Trig_Deny_Actions )
endfunction

//===========================================================================
// Trigger: Hero Event
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Hero_Event_Conditions takes nothing returns boolean
    return IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)
endfunction

function Hero_Reset takes unit hero returns nothing   
    //删除杨教授减智力
    call UnitRemoveAbility(hero,'A0A1')
    //防止各类BUG 
    call SetUnitInvulnerable(hero,false)
    call PauseUnit(hero,false)
    call ShowUnit(hero,true)
    call SetUnitMoveSpeed(hero,GetUnitDefaultMoveSpeed(hero))
    call SetUnitFlyHeight(hero,GetUnitDefaultFlyHeight(hero),1000.0)
    call SetUnitVertexColor(hero,255,255,255,255)
    call SetUnitTimeScale(hero,1.0)
    call ClearUnitFlag(hero)
endfunction

function HeroRevive_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local integer c = LoadInteger(udg_Hashtable,task,0)
    local integer i = LoadInteger(udg_Hashtable,task,1)
    local unit h = LoadUnitHandle(udg_Hashtable,task,0)
    local real x
    local real y
    //========
    if c>0 and IsUnitDead(h) then
        call SaveInteger(udg_Hashtable,task,0,c - 1)
        call SaveInteger(udg_Hashtable,task,1,i + 1)
        call GIB_SetPlayerField(GetOwningPlayer(h),GIB_COLUMN_REVIVE(),"    " + R2SW(c/10.0,3,1))
        if i==30 then
            if IsUnitAlly(h,udg_PlayerA[0]) then
                set x = GetLocationX(udg_RevivePoint[0])
                set y = GetLocationY(udg_RevivePoint[0])
            elseif IsUnitAlly(h,udg_PlayerB[0]) then
                set x = GetLocationX(udg_RevivePoint[1])
                set y = GetLocationY(udg_RevivePoint[1])
            else
                set x = 3500.0
                set y = 1500.0
            endif
            call SetUnitX(h,x)
            call SetUnitY(h,y)
        endif
    else
        call PauseTimer(t)
        call DestroyTimer(t)
        call GIB_SetPlayerField(GetOwningPlayer(h),GIB_COLUMN_REVIVE(),"    -")
        
        if IsUnitAlly(h,udg_PlayerA[0]) then
            set x = GetLocationX(udg_RevivePoint[0])
            set y = GetLocationY(udg_RevivePoint[0])
        elseif IsUnitAlly(h,udg_PlayerB[0]) then
            set x = GetLocationX(udg_RevivePoint[1])
            set y = GetLocationY(udg_RevivePoint[1])
        else
            set x = 3500.0
            set y = 1500.0
        endif
        if IsUnitDead(h) then
            call ReviveHero(h,x,y,true)
        else
            call SetUnitPosition(h,x,y)
        endif
        call SetUnitManaPercentBJ(h,100)
        
        call PanCameraToTimedForPlayer(GetOwningPlayer(h),x,y,0)
        
        call Hero_Reset(h)//英雄恢复
        
        call FlushChildHashtable(udg_Hashtable,task)
    endif
    //========
    set t = null
    set h = null
endfunction

function Trig_Hero_Event_Actions takes nothing returns nothing
    local unit killer = GetKillingUnit()
    local unit dead = GetTriggerUnit()
    local player winner = GetOwningPlayer(killer)
    local player loser = GetOwningPlayer(dead)
    local integer level
    local real cost = udg_ReviveTime[0] + udg_ReviveTime[1]*GetHeroLevel(dead)
    local boolean refresh = false
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)

    //创建特效
    if GetUnitTypeId(killer) == 'E011' then
        //十字特效 
        call TSU_DestroyEffect(1.0,AddSpecialEffect("Koishi04.mdl",GetUnitX(dead),GetUnitY(dead)))
    elseif GetUnitTypeId(dead) == 'U006' and GetUnitAbilityLevel(dead,'A0MM')!=0 then
        //UUZ decreased timer
        set cost = cost - (2.50 + GetUnitAbilityLevel(dead,'A0MM')*2.50)
    else
        call CreateUnit(loser,'n01J',GetUnitX(dead),GetUnitY(dead),270.0)
    endif

    //Item Decrease Timer
    if UnitHasItemOfTypeBJ(dead,'I05W') then
        set cost = cost * 0.75
    endif
    
    //开始计时复活 
    call SaveUnitHandle(udg_Hashtable,task,0,dead)
    call SaveInteger(udg_Hashtable,task,0,R2I(cost/0.1))
    call SaveInteger(udg_Hashtable,task,1,0)
    call TimerStart(t,0.1,true,function HeroRevive_Main)
    
    //处理赏、公告与记分 
    set refresh = AnnounceHeroBonus(killer,dead)
    
    //刷新多面板数据
    call GIB_SetPlayerField(loser,GIB_COLUMN_FLAG_DEATH(),I2S(udg_FlagDeath[GetPlayerId(loser)]))
    if refresh then
        call GIB_SetPlayerField(winner,GIB_COLUMN_FLAG_KILL(),I2S(udg_FlagKill[GetPlayerId(winner)]))
        if IsPlayerInForce(winner,udg_TeamA) or winner==udg_PlayerA[0] then
            call GIB_SetPlayerField(udg_PlayerA[0],GIB_COLUMN_FLAG_KILL(),"|cffffcc00"+I2S(udg_FlagKill[4])+"|r")
        elseif IsPlayerInForce(winner,udg_TeamB) or winner==udg_PlayerB[0] then
            call GIB_SetPlayerField(udg_PlayerB[0],GIB_COLUMN_FLAG_KILL(),"|cffffcc00"+I2S(udg_FlagKill[10])+"|r")
        endif
    endif
    set loser = null
    set winner = null
    set killer = null
    set dead = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Hero_Event takes nothing returns nothing
    set gg_trg_Hero_Event = CreateTrigger()
    call TriggerAddCondition( gg_trg_Hero_Event, Condition( function Trig_Hero_Event_Conditions ) )
    call TriggerAddAction( gg_trg_Hero_Event, function Trig_Hero_Event_Actions )
endfunction
//===========================================================================
// Trigger: Victory
//===========================================================================
function Trig_Victory_Func020C takes nothing returns boolean
    if ( not ( GetTriggerUnit() == udg_BaseB[0] ) ) then
        return false
    endif
    return true
endfunction

function Trig_Victory_Func022C takes nothing returns boolean
    if ( not ( udg_SK_Nazirin != null ) ) then
        return false
    endif
    return true
endfunction

function Trig_Victory_Func024Func001A takes nothing returns nothing
    call CustomVictoryBJ( GetEnumPlayer(), true, true )
endfunction

function Trig_Victory_Func024Func002A takes nothing returns nothing
    call CustomDefeatBJ( GetEnumPlayer(), "TRIGSTR_7637" )
endfunction

function Trig_Victory_Func024Func003A takes nothing returns nothing
    call CustomVictoryBJ( GetEnumPlayer(), true, true )
endfunction

function Trig_Victory_Func024Func004A takes nothing returns nothing
    call CustomDefeatBJ( GetEnumPlayer(), "TRIGSTR_7638" )
endfunction

function Trig_Victory_Func024C takes nothing returns boolean
    if ( not ( GetTriggerUnit() == udg_BaseB[0] ) ) then
        return false
    endif
    return true
endfunction

function Trig_Victory_Func025A takes nothing returns nothing
    call CustomVictoryBJ( GetEnumPlayer(), true, true )
endfunction

function Trig_Victory_Actions takes nothing returns nothing
    local unit v = GetTriggerUnit()
    local real x = GetUnitX(v)
    local real y = GetUnitY(v)
    local unit u
    // ========
    call DestroyTrigger( GetTriggeringTrigger() )
    set u = CreateUnit(Player(15),'n01J',x,y,0.0)
    call SetUnitScale(u,4.0,4.0,4.0)
    set u = CreateUnit(Player(15),'n01J',x,y,90.0)
    call SetUnitScale(u,4.0,4.0,4.0)
    set u = CreateUnit(Player(15),'n01J',x,y,180.0)
    call SetUnitScale(u,4.0,4.0,4.0)
    set u = CreateUnit(Player(15),'n01J',x,y,270.0)
    call SetUnitScale(u,4.0,4.0,4.0)
    call DestroyEffect( AddSpecialEffect("Objects\\Spawnmodels\\Undead\\UDeathMedium\\UDeath.mdl",    (x),    (y)) )
    call DestroyEffect( AddSpecialEffect("Objects\\Spawnmodels\\Undead\\UDeathMedium\\UDeath.mdl",    (x),    (y)) )
    call DestroyEffect( AddSpecialEffect("Objects\\Spawnmodels\\Undead\\UDeathSmall\\UDeathSmall.mdl",    (x),    (y)) )
    call DestroyEffect( AddSpecialEffect("Objects\\Spawnmodels\\Undead\\UDeathSmall\\UDeathSmall.mdl",    (x),    (y)) )
    // ========
    if ( Trig_Victory_Func020C() ) then
        call BroadcastMessage("|cFFFF0000博丽神社|r |cffffcc00获胜！|r")
    else
        call BroadcastMessage("|cFF33CC00守矢神社|r |cffffcc00获胜！|r")
    endif
    call PolledWait( 5.00 )
    if ( Trig_Victory_Func022C() ) then
        call RemoveUnit( udg_SK_Nazirin )
    else
    endif
    call PauseGameOn(  )
    if ( Trig_Victory_Func024C() ) then
        call ForForce( udg_TeamA, function Trig_Victory_Func024Func003A )
        call ForForce( udg_TeamB, function Trig_Victory_Func024Func004A )
    else
        call ForForce( udg_TeamB, function Trig_Victory_Func024Func001A )
        call ForForce( udg_TeamA, function Trig_Victory_Func024Func002A )
    endif
    call ForForce( udg_TeamOB, function Trig_Victory_Func025A )
    set u = null
    set v = null
endfunction

//===========================================================================
function InitTrig_Victory takes nothing returns nothing
    set gg_trg_Victory = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Victory, function Trig_Victory_Actions )
endfunction

//===========================================================================
// Trigger: Player Left
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Player_Left_Control takes nothing returns nothing
    call SetPlayerAllianceBJ( GetTriggerPlayer(), ALLIANCE_SHARED_CONTROL, true, GetEnumPlayer() )
endfunction

function Trig_Player_Left_Item takes nothing returns nothing
    local integer i
    set i = 0
    loop
        exitwhen i >= bj_MAX_INVENTORY
        call THD_SetItemOwner(UnitItemInSlot(GetEnumUnit(),i),null)
        set i = i + 1
    endloop
endfunction

function Trig_Player_Left_Actions takes nothing returns nothing
    local player who = GetTriggerPlayer()
    local unit h = GetPlayerCharacter(who)
    local string msg
    local force m
    local group g
    //========
    call TriggerSleepAction(2.0)
    set msg = PlayerName(who) + " 离开了游戏"
    call BroadcastMessage(msg)
    if IsPlayerInForce(who,udg_TeamA) then
        call SetUnitPositionLoc(h,udg_RevivePoint[0])
        call ShareGold(udg_TeamA,GetPlayerState(who,PLAYER_STATE_RESOURCE_GOLD))
        call SetPlayerState(who,PLAYER_STATE_RESOURCE_GOLD,0)
        call ForForce(udg_TeamA,function Trig_Player_Left_Control)
        call SetPlayerAllianceBJ(who,ALLIANCE_SHARED_CONTROL,true,udg_PlayerA[0])
    elseif IsPlayerInForce(who,udg_TeamB) then
        call SetUnitPositionLoc(h,udg_RevivePoint[1])
        call ShareGold(udg_TeamB,GetPlayerState(who,PLAYER_STATE_RESOURCE_GOLD))
        call SetPlayerState(who,PLAYER_STATE_RESOURCE_GOLD,0)
        call ForForce(udg_TeamB,function Trig_Player_Left_Control)
        call SetPlayerAllianceBJ(who,ALLIANCE_SHARED_CONTROL,true,udg_PlayerB[0])
    endif
    set g = GetUnitsOfPlayerAll(who)
    call ForGroup(g,function Trig_Player_Left_Item)
    call DestroyGroup(g)
    //========
    set who = null
    set msg = null
    set g = null
    set m = null
    set h = null
endfunction

function InitTrig_Player_Left takes nothing returns nothing
    set gg_trg_Player_Left = CreateTrigger()
    call TriggerAddAction( gg_trg_Player_Left, function Trig_Player_Left_Actions )
endfunction
//===========================================================================
// Trigger: FeetManFix
//===========================================================================
function Trig_FeetManFix_Conditions takes nothing returns boolean
    if ( not ( GetPlayerSlotState(GetTriggerPlayer()) == PLAYER_SLOT_STATE_PLAYING ) ) then
        return false
    endif
    return true
endfunction

function Trig_FeetManFix_Func002A takes nothing returns nothing
    call SetPlayerAllianceBJ( GetTriggerPlayer(), ALLIANCE_SHARED_CONTROL, false, GetEnumPlayer() )
endfunction

function Trig_FeetManFix_Actions takes nothing returns nothing
    call ForForce( GetPlayersAll(), function Trig_FeetManFix_Func002A )
endfunction

//===========================================================================
function InitTrig_FeetManFix takes nothing returns nothing
    set gg_trg_FeetManFix = CreateTrigger(  )
    call TriggerRegisterPlayerAllianceChange( gg_trg_FeetManFix, Player(0), ALLIANCE_SHARED_CONTROL )
    call TriggerRegisterPlayerAllianceChange( gg_trg_FeetManFix, Player(1), ALLIANCE_SHARED_CONTROL )
    call TriggerRegisterPlayerAllianceChange( gg_trg_FeetManFix, Player(2), ALLIANCE_SHARED_CONTROL )
    call TriggerRegisterPlayerAllianceChange( gg_trg_FeetManFix, Player(3), ALLIANCE_SHARED_CONTROL )
    call TriggerRegisterPlayerAllianceChange( gg_trg_FeetManFix, Player(6), ALLIANCE_SHARED_CONTROL )
    call TriggerRegisterPlayerAllianceChange( gg_trg_FeetManFix, Player(7), ALLIANCE_SHARED_CONTROL )
    call TriggerRegisterPlayerAllianceChange( gg_trg_FeetManFix, Player(8), ALLIANCE_SHARED_CONTROL )
    call TriggerRegisterPlayerAllianceChange( gg_trg_FeetManFix, Player(9), ALLIANCE_SHARED_CONTROL )
    call TriggerAddCondition( gg_trg_FeetManFix, Condition( function Trig_FeetManFix_Conditions ) )
    call TriggerAddAction( gg_trg_FeetManFix, function Trig_FeetManFix_Actions )
endfunction

//===========================================================================
// Trigger: Neutral System
//===========================================================================
//TESH.scrollpos=52
//TESH.alwaysfold=0

function NC_CreateGroupAtCamp takes nothing returns nothing
    local integer i = 0
    local integer triggerHandle = GetHandleId(GetTriggeringTrigger())
    local integer campSerial = LoadInteger(udg_Hashtable,triggerHandle, StringHash("campSerial"))
    local integer maxTypes = LoadInteger(udg_Hashtable,triggerHandle, StringHash("maxTypes"))
    local integer randomGroup = GetRandomInt(1, maxTypes)
    local real campCenterX = GetRectCenterX(udg_NeutralCamps[campSerial])
    local real campCenterY = GetRectCenterY(udg_NeutralCamps[campSerial])
    local integer groupSerial
    local integer length
    local integer num = LoadInteger(udg_Hashtable,triggerHandle,StringHash("Type" + I2S(randomGroup)))
    local string groupType = udg_NeutralGroups[num]
    local group unitsInCamp = CreateGroup()
    local integer countUnitsInCamp
    local unit u
    call GroupEnumUnitsInRect(unitsInCamp, udg_NeutralCamps[campSerial], null)
    set countUnitsInCamp = CountUnitsInGroup(unitsInCamp)
    call DestroyGroup(unitsInCamp)
    set unitsInCamp = null
    if countUnitsInCamp >0 then
        set groupType = null
        set unitsInCamp = null
        set u = null
        return
    endif
    loop
        set length = StringLength(groupType)
        exitwhen i >= length or length == 0
        if SubString(groupType, i, i + 1) == "," then
            set u = CreateUnit(Player(PLAYER_NEUTRAL_AGGRESSIVE), udg_NeutralTypes[S2I(SubString(groupType, 0, i))], campCenterX, campCenterY, bj_UNIT_FACING)
            call SetUnitAcquireRange(u,200)
            set groupType = SubString(groupType, i + 1, length)
            set i = -1
        endif
        set i = i + 1
    endloop
    if length != 0 then
        set u = CreateUnit(Player(PLAYER_NEUTRAL_AGGRESSIVE), udg_NeutralTypes[S2I(groupType)], campCenterX, campCenterY, bj_UNIT_FACING)
        call SetUnitAcquireRange(u,200)
    endif
    set groupType = null
    set u = null
    set unitsInCamp = null
endfunction

//===========================================================================
function NC_StartTriggersAndFirstRound takes nothing returns nothing
    local integer i = 1
    loop
        exitwhen i > udg_NeutralCampsCount
        call TriggerRegisterTimerEvent(udg_neutralCreepsTriggers[i], udg_NeutralCreatePeriod, true)
        call TriggerAddAction(udg_neutralCreepsTriggers[i], function NC_CreateGroupAtCamp)
        call TriggerExecute(udg_neutralCreepsTriggers[i])
        set i = i + 1
    endloop
endfunction

//===========================================================================
function NC_StartActions takes nothing returns nothing
    if udg_NeutralFirstCreateTime2 > 0 then
        set udg_neutralCreepsTrigger = CreateTrigger()
        call TriggerRegisterTimerEvent(udg_neutralCreepsTrigger, udg_NeutralFirstCreateTime2, false)
        call TriggerAddCondition(udg_neutralCreepsTrigger, Condition(function NC_StartTriggersAndFirstRound))
    else
        call NC_StartTriggersAndFirstRound()
    endif
endfunction

//===========================================================================
function Trig_Neutral_System_Start takes nothing returns nothing  
    set udg_neutralCreepsStarter = CreateTrigger()    
    call TriggerRegisterTimerEvent(udg_neutralCreepsStarter, udg_NeutralFirstCreateTime, false)
    call TriggerAddAction(udg_neutralCreepsStarter, function NC_StartActions)
    call DebugMsg("野怪刷新系统装载完毕")
endfunction

//===========================================================================
function Trig_Neutral_System_Init takes nothing returns nothing
    local integer campSerial = 1
    local integer i
    local integer triggerHandle
    local string campTypes
    local integer maxTypes
    local integer length
    loop
        exitwhen campSerial > udg_NeutralCampsCount
        set udg_neutralCreepsTriggers[campSerial] = CreateTrigger()
        set triggerHandle = GetHandleId(udg_neutralCreepsTriggers[campSerial])
        set i = 0
        set campTypes = udg_NeutralCampTypes[campSerial]
        set maxTypes = 0
        loop
            set length = StringLength(campTypes)
            exitwhen i >= length or length == 0
            if SubString(campTypes, i, i + 1) == "," then
                set maxTypes = maxTypes + 1
                call SaveInteger(udg_Hashtable,triggerHandle, StringHash("Type" + I2S(maxTypes)), S2I(SubString(campTypes, 0, i)))
                set campTypes = SubString(campTypes, i + 1, length)
                set i = -1
            endif
            set i = i + 1
        endloop
        if length != 0 then
            set maxTypes = maxTypes + 1
            call SaveInteger(udg_Hashtable,triggerHandle, StringHash("Type" + I2S(maxTypes)), S2I(campTypes))
        endif
        call SaveInteger(udg_Hashtable,triggerHandle, StringHash("maxTypes"), maxTypes)
        call SaveInteger(udg_Hashtable,triggerHandle, StringHash("campSerial"), campSerial)
        set campSerial = campSerial + 1
    endloop
    call DebugMsg("野怪初始化完毕")
    call Trig_Neutral_System_Start()
endfunction

//===========================================================================
function InitTrig_Neutral_System takes nothing returns nothing
    set gg_trg_Neutral_System = CreateTrigger()
    call TriggerAddAction(gg_trg_Neutral_System,function Trig_Neutral_System_Init)
endfunction
//===========================================================================
// Trigger: ItemClear
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_ItemClear_Main takes nothing returns nothing
    if GetItemLifeBJ(GetEnumItem()) <= 0.00 then
        call RemoveItem(GetEnumItem())
    endif
endfunction

function Trig_ItemClear_Actions takes nothing returns nothing
    call EnumItemsInRect( bj_mapInitialPlayableArea, null, function Trig_ItemClear_Main )
endfunction

//===========================================================================
function InitTrig_ItemClear takes nothing returns nothing
    set gg_trg_ItemClear = CreateTrigger()
    call TriggerRegisterTimerEventPeriodic( gg_trg_ItemClear, 60.00 )
    call TriggerAddAction( gg_trg_ItemClear, function Trig_ItemClear_Actions )
endfunction
//===========================================================================
// Trigger: Init Abilities
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Abilities_HideButtons takes nothing returns nothing
    call SetPlayerAbilityAvailableBJ( false, 'A06Q', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A06Q', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A09O', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A04D', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A055', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A07I', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0A7', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0BB', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0BE', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0CZ', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0DM', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0EO', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0FA', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0HH', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0IM', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0JB', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0L9', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A096', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0ML', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0S1', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0S7', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0SB', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0SC', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0SD', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0SI', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0SK', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0TB', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0TC', GetEnumPlayer() )
    call SetPlayerAbilityAvailableBJ( false, 'A0TD', GetEnumPlayer() )
endfunction

function Trig_Init_Abilities_Actions takes nothing returns nothing
    call ForForce( GetPlayersAll(), function Trig_Init_Abilities_HideButtons )
endfunction

//===========================================================================
function InitTrig_Init_Abilities takes nothing returns nothing
    set gg_trg_Init_Abilities = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Abilities, function Trig_Init_Abilities_Actions )
endfunction

//===========================================================================
// Trigger: Marisa01
//
// A040 炙热之星
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Marisa01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A040'
endfunction

function Trig_Marisa01_Damage takes nothing returns nothing
    local integer task
    local unit caster
    local real damage
    if GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE)<=0 then
        set caster = null
        return
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) then
        set caster = null
        return
    endif
    if IsUnitWard(GetTriggerUnit()) then
        set caster = null
        return
    endif
    set task = GetHandleId(GetTriggeringTrigger())
    set caster = LoadUnitHandle(udg_ht,task,0)
    set damage = LoadReal(udg_ht,task,0)
    call UnitDamageTarget(caster,GetEnteringUnit(),damage,false,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIfb\\AIfbSpecialArt.mdl",GetEnteringUnit(),"chest"))
    set caster = null
endfunction

function Trig_Marisa01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local trigger trg
    local triggeraction tga 
    local real a = LoadReal(udg_ht,task,0)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px = ox + 25*Cos(a)
    local real py = oy + 25*Sin(a)
    local integer z = LoadInteger(udg_ht,task,2)
    //========
    if z>0 then
        if IsTerrainPathable(px,py,PATHING_TYPE_FLYABILITY)==false and GetUnitCurrentOrder(caster)==OrderId("shockwave") then
            call SetUnitX(caster,px)
            call SetUnitY(caster,py)
            call SetUnitX(u,px)
            call SetUnitY(u,py)
            //call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\Shockwave\\ShockwaveMissile.mdl",ox,oy))
            set z = z - 1
        else
            set z = 0
        endif
        call SaveInteger(udg_ht,task,2,z)
    else
        call SetUnitFlag(caster,CS_DASHING(),false)
        call DestroyTimer(t)
        call IssueImmediateOrder(caster,"stop")
        call SetUnitPathing(caster,true)
        call KillUnit(u)
        set trg = LoadTriggerHandle(udg_ht,task,2)
        set tga = LoadTriggerActionHandle(udg_ht,task,3)
        call TriggerRemoveAction(trg,tga)
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set trg = null
    set tga = null
endfunction

function Trig_Marisa01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = Atan2(ty-oy,tx-ox)
    local real d = SquareRoot((ty-oy)*(ty-oy)+(tx-ox)*(tx-ox))
    local real damage
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local trigger trg = CreateTrigger()
    local triggeraction tga
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    local real abilitycooldownlv01 = 11.0
    local real abilitycooldownlv02 = 9.2
    local real abilitycooldownlv03 = 7.4
    local real abilitycooldownlv04 = 5.6
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if GetSpellTargetUnit()!=null then
        set d = d + 150.0
    endif
    if level==1 then
        set damage = 60
        set d = RMinBJ(d,500.0)
        set d = RMaxBJ(d,300.0)
    elseif level==2 then
        set damage = 80
        set d = RMinBJ(d,600.0)
        set d = RMaxBJ(d,300.0)
    elseif level==3 then
        set damage = 100
        set d = RMinBJ(d,700.0)
        set d = RMaxBJ(d,300.0)
    elseif level==4 then
        set damage = 120
        set d = RMinBJ(d,800.0)
        set d = RMaxBJ(d,300.0)
    endif
    //--------
    call TriggerRegisterUnitInRange( trg, caster, 100, iff )
    set tga = TriggerAddAction( trg, function Trig_Marisa01_Damage )
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveReal(udg_ht,GetHandleId(trg),0,damage)
    //--------
    call SetUnitPathing(caster,false)
    call SetUnitFlag(caster,CS_DASHING(),true)
    set u = CreateUnit(GetOwningPlayer(caster),'n00M',ox,oy,a*bj_RADTODEG)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveTriggerHandle(udg_ht,task,2,trg)
    call SaveTriggerActionHandle(udg_ht,task,3,tga)
    call SaveReal(udg_ht,task,0,a)
    call SaveInteger(udg_ht,task,2,R2I(d/25))
    call TimerStart(t,0.01,true,function Trig_Marisa01_Main)
    //========
    set caster = null
    set u = null
    set t = null
    set iff = null
    set trg = null
    set tga = null
endfunction

//===========================================================================
function InitTrig_Marisa01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Marisa02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Stars_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A041'
endfunction

function Trig_Stars_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u1 = LoadUnitHandle(udg_ht,task,1)
    local unit u2 = LoadUnitHandle(udg_ht,task,2)
    local location p = LoadLocationHandle(udg_ht,task,3)
    local integer i = LoadInteger(udg_ht,task,1)
    if GetUnitCurrentOrder(caster)==OrderId("breathoffire") then
        call IssuePointOrderLoc(u1,"breathoffire",p)
        call IssuePointOrderLoc(u2,"breathoffire",p)
        if i==2 then
            call SetUnitTimeScale(caster,0.25)
        endif
        call SaveInteger(udg_ht,task,1,i + 1)
    else
        call RemoveLocation(p)
        call KillUnit(u1)
        call KillUnit(u2)
        call SetUnitTimeScale(caster,1.0)
        call FlushChildHashtable(udg_ht,task)
        call DestroyTimer(t)
    endif
    set t = null
    set caster = null
    set u1 = null
    set u2 = null
    set p = null
endfunction

function Trig_Stars_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u1
    local unit u2
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local location o = GetUnitLoc(caster)
    local location p = PolarProjectionBJ(o, 256, GetUnitFacing(caster))
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //--------
    local real abilitycooldownlv01 = 8.0
    local real abilitycooldownlv02 = 8.0
    local real abilitycooldownlv03 = 8.0
    local real abilitycooldownlv04 = 8.0
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //--------
    call SetUnitTimeScale(caster,2.5)
    set u1 = CreateUnitAtLoc( GetOwningPlayer(caster), 'n00N', o, GetUnitFacing(caster) )
    set u2 = CreateUnitAtLoc( GetOwningPlayer(caster), 'n00N', o, GetUnitFacing(caster) )
    call UnitAddAbility(u1,'A043')
    call SetUnitAbilityLevel(u1,'A043',level)
    call UnitAddAbility(u2,'A044')
    call SetUnitAbilityLevel(u2,'A044',level)
    //--------
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u1)
    call SaveUnitHandle(udg_ht,task,2,u2)
    call SaveInteger(udg_ht,task,1,0)
    call SaveLocationHandle(udg_ht,task,3,p)
    call TimerStart(t,0.1,true,function Trig_Stars_Main )
    //--------
    call RemoveLocation(o)
    set caster = null
    set t = null
    set u1 = null
    set u2 = null
    set o = null
    set p = null
endfunction

//===========================================================================
function InitTrig_Marisa02 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Marisa03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Marisa03_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A03Z'
endfunction

function Trig_Marisa03_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local real a
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local integer i
    //========
    if IsUnitAlive(u) and IsUnitAlive(caster) then
        set i = 1
        loop
            exitwhen i>4    
            //-------
            set u = LoadUnitHandle(udg_ht,task,i)
            set a = LoadReal(udg_ht,task,i)
            set a = a + 1.5
            set px = ox + 150*CosBJ(a)
            set py = oy + 150*SinBJ(a)
            call SetUnitX(u,px)
            call SetUnitY(u,py)
            call SaveReal(udg_ht,task,i,a)
            //-------
            set i = i + 1
        endloop
    else
        set i = 1
        loop
            exitwhen i>4    
            //-------
            set u = LoadUnitHandle(udg_ht,task,i)
            call KillUnit(u)
            //-------
            set i = i + 1
        endloop
        call DestroyTimer(t)
        call FlushChildHashtable( udg_ht, task )
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Marisa03_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local unit u
    local real a
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local integer i = 1
    //--------
    local real abilitycooldownlv01 = 18.0
    local real abilitycooldownlv02 = 18.0
    local real abilitycooldownlv03 = 18.0
    local real abilitycooldownlv04 = 18.0
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //--------
    loop
        exitwhen i>4
        //-------
        set a = 90*i
        set px = ox + 150*CosBJ(a)
        set py = oy + 150*SinBJ(a)
        set u = CreateUnit(GetOwningPlayer(caster),'n00O',px,py,a)
        call SetUnitAbilityLevel(u,'A045',level)
        call UnitApplyTimedLife(u,'BHwe',8.00)
        call SetUnitScale(u,level*0.3+1,level*0.3+1,level*0.3+1)
        call SaveUnitHandle(udg_ht,task,i,u)
        call SaveReal(udg_ht,task,i,a)
        //-------
        set i = i + 1
    endloop
    //--------
    call SaveUnitHandle(udg_ht,task,0,caster)
    call TimerStart(t,0.02,true,function Trig_Marisa03_Main)
    //========
    set t = null
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Marisa03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Marisa04
//
// 
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Marisa04_ID takes nothing returns boolean
    return GetSpellAbilityId()=='A042'
endfunction

function Trig_Marisa04_Cast_Actions takes nothing returns nothing
    local location o = GetUnitLoc(GetTriggerUnit())
    local real a = AngleBetweenPoints(o,GetSpellTargetLoc())
    local location p = PolarProjectionBJ(o,100.00, a)
    local unit u = CreateUnitAtLoc( GetOwningPlayer(GetTriggerUnit()), 'n00P', p, a )
    call UnitApplyTimedLife(u,'BTLF',0.01)
    call RemoveLocation(o)
    call RemoveLocation(p)
    set o = null
    set p = null
    set u = null
endfunction

function UnitRepel_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_ht,task,0)
    local real s = LoadReal(udg_ht,task,0)
    local real d = LoadReal(udg_ht,task,1)
    local real a = LoadReal(udg_ht,task,2)
    local real px = GetUnitX(u) + s*Cos(a)
    local real py = GetUnitY(u) + s*Sin(a)
    local integer c = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    call IssueImmediateOrder(u,"stop")
    if i < 500 then
        if s>0 and IsTerrainPathable(px,py,ConvertPathingType(c))==false then
            call SetUnitX(u,px)
            call SetUnitY(u,py)
            set i = i + 1
        else
            set i = 500
        endif
        call SaveReal(udg_ht,task,0,s+d)
        call SaveInteger(udg_ht,task,1,i)
    else
        call SetUnitFlag(u,CS_REPEL(),false)
        call SetUnitPathing(u,true)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set u = null
    set t = null
endfunction

function UnitRepel takes unit u,real s,real a,real d returns integer
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer c
    //========
    call IssueImmediateOrder(u,"stop")
    call SetUnitPathing( u, false )
    set s = s/50
    set d = -0.05 - RAbsBJ(d/50)
    if IsUnitType(u,UNIT_TYPE_FLYING)  then
        set c = 2
    else
        set c = 1
    endif
    //========
    call SaveUnitHandle( udg_ht, task, 0, u )
    call SaveInteger( udg_ht, task, 0, c )
    call SaveInteger( udg_ht, task, 1, 0 )
    call SaveReal( udg_ht, task, 0, s )
    call SaveReal( udg_ht, task, 1, d )
    call SaveReal( udg_ht, task, 2, a )
    call SetUnitFlag(u,CS_REPEL(),true)
    call TimerStart( t, 0.02, true, function UnitRepel_Main )
    set u = null
    set t = null
    return task
endfunction

function Trig_Marisa04_Repel_Actions takes nothing returns nothing
    local unit caster
    local unit u
    local real a
    if GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE)<=0 then
        set caster = null
        set u = null
        return
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) then
        set caster = null
        set u = null
        return
    endif
    if not IsMobileUnit(GetTriggerUnit()) then
        set caster = null
        set u = null
        return
    endif
    if GetUnitAbilityLevel(GetTriggerUnit(),'B04B') >= 1 then
        set caster = null
        set u = null
        return
    endif
    if GetUnitAbilityLevel(GetTriggerUnit(),'BOvc') >= 1 then
        set caster = null
        set u = null
        return
    endif
    set u = GetTriggerUnit()
    set caster = LoadUnitHandle(udg_ht,GetHandleId(GetTriggeringTrigger()),0)
    set a = Atan2(GetUnitY(u)-GetUnitY(caster),GetUnitX(u)-GetUnitX(caster))
    call UnitRepel(u,200,a,50)
    set caster = null
    set u = null
endfunction
    
function Trig_Marisa04_Repel takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u1 = LoadUnitHandle(udg_ht,task,1)
    local unit u2 = LoadUnitHandle(udg_ht,task,2)
    local unit u3 = LoadUnitHandle(udg_ht,task,3)
    local real ox = LoadReal(udg_ht,task,0)
    local real oy = LoadReal(udg_ht,task,1)
    local real px
    local real py
    local real a = LoadReal(udg_ht,task,2)
    local trigger trg = LoadTriggerHandle(udg_ht,task,4)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer n = LoadInteger(udg_ht,task,2)
    local integer j
    //========
    if i<n and GetUnitCurrentOrder(caster)==OrderId("carrionswarm") then
        //--------
        set j = i + 0
        set px = ox+(130*(j-(j/10)*10))*CosBJ(a)
        set py = oy+(130*(j-(j/10)*10))*SinBJ(a)
        call SetUnitXYFly(u1,px,py)
        set j = i + 3
        set px = ox+(130*(j-(j/10)*10))*CosBJ(a)
        set py = oy+(130*(j-(j/10)*10))*SinBJ(a)
        call SetUnitXYFly(u2,px,py)
        set j = i + 6
        set px = ox+(130*(j-(j/10)*10))*CosBJ(a)
        set py = oy+(130*(j-(j/10)*10))*SinBJ(a)
        call SetUnitXYFly(u3,px,py)
        //--------
        call SaveInteger(udg_ht,task,1,i + 1)
    else
        call RemoveUnit(u1)
        call RemoveUnit(u2)
        call RemoveUnit(u3)
        call DestroyTrigger(trg)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set trg = null
    set u1 = null
    set u2 = null
    set u3 = null
endfunction

function Trig_Marisa04_Damage takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u
    local real ox = LoadReal(udg_ht,task,0)
    local real oy = LoadReal(udg_ht,task,1)
    local real a = LoadReal(udg_ht,task,2)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer z = LoadInteger(udg_ht,task,2)
    //========
    if i<=z and GetUnitCurrentOrder(caster)==OrderId("carrionswarm") then
    //--------
        if i == 0 then
            set u = CreateUnit(GetOwningPlayer(caster),'n00Q',ox+440*CosBJ(a),oy+440*SinBJ(a),a)
            call UnitApplyTimedLife(u,'BTLF',1.0)
            //--------
            set u = CreateUnit(GetOwningPlayer(caster),'n001',ox+70*CosBJ(a),oy+70*SinBJ(a),a)
            call UnitAddAbility(u,'A047')
            call SetUnitAbilityLevel(u,'A047',level)
            call IssuePointOrder(u,"breathoffire",ox+100*CosBJ(a),oy+100*SinBJ(a))
        endif
        //--------
        if i < 3 then
            set u = CreateUnit(GetOwningPlayer(caster),'n00P',ox+70*CosBJ(a),oy+70*SinBJ(a),a)
            call SetUnitTimeScale(u,2.0)
            call UnitApplyTimedLife(u,'BTLF',0.01)
        endif
        //--------
        set u = CreateUnit(GetOwningPlayer(caster),'n001',ox+50*CosBJ(a),oy+50*SinBJ(a),a)
        call UnitAddAbility(u,'A046')
        call SetUnitAbilityLevel(u,'A046',level)
        call IssuePointOrder(u,"breathoffire",ox+100*CosBJ(a),oy+100*SinBJ(a))
        //--------
        call SaveInteger(udg_ht,task,1,i + 1)
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Marisa04_Fire_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local timer st = CreateTimer()
    local integer stask = GetHandleId(st)
    local unit caster = GetTriggerUnit()
    local unit u
    local unit u1
    local unit u2
    local unit u3
    local trigger trg = CreateTrigger()
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px = GetSpellTargetX()
    local real py = GetSpellTargetY()
    local real a = Atan2(py-oy,px-ox)*bj_RADTODEG
    local integer level = GetUnitAbilityLevel(caster,'A042')
    //--------
    local real abilitycooldownlv01 = 100
    local real abilitycooldownlv02 = 85
    local real abilitycooldownlv03 = 70
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //--------
    set u = CreateUnit(GetOwningPlayer(caster),'n00P',ox+70*CosBJ(a),oy+70*SinBJ(a),a)
    call UnitApplyTimedLife(u,'BTLF',0.01)
    call SetUnitTimeScale(u,2.0)
    //--------
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,0)
    call SaveInteger(udg_ht,task,2,9)
    call SaveReal(udg_ht,task,0,ox)
    call SaveReal(udg_ht,task,1,oy)
    call SaveReal(udg_ht,task,2,a)
    call TimerStart(t,0.1,true,function Trig_Marisa04_Damage)
    //--------
    set u1 = CreateUnit(GetOwningPlayer(caster),'n00R',ox+70*CosBJ(a),oy+70*SinBJ(a),a)
    set u2 = CreateUnit(GetOwningPlayer(caster),'n00R',ox+470*CosBJ(a),oy+470*SinBJ(a),a)
    set u3 = CreateUnit(GetOwningPlayer(caster),'n00R',ox+870*CosBJ(a),oy+870*SinBJ(a),a)
    call SaveUnitHandle(udg_ht,stask,0,caster)
    call SaveUnitHandle(udg_ht,stask,1,u1)
    call SaveUnitHandle(udg_ht,stask,2,u2)
    call SaveUnitHandle(udg_ht,stask,3,u3)
    call TriggerRegisterUnitInRange( trg, u1, 150, iff )
    call TriggerRegisterUnitInRange( trg, u2, 150, iff )
    call TriggerRegisterUnitInRange( trg, u3, 150, iff )
    call TriggerAddAction( trg, function Trig_Marisa04_Repel_Actions )
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerHandle(udg_ht,stask,4,trg)
    call SaveInteger(udg_ht,stask,1,0)
    call SaveInteger(udg_ht,stask,2,360)
    call SaveReal(udg_ht,stask,0,ox)
    call SaveReal(udg_ht,stask,1,oy)
    call SaveReal(udg_ht,stask,2,a)
    call TimerStart(st,0.01,true,function Trig_Marisa04_Repel)
    //========
    set t = null
    set st = null
    set caster = null
    set trg = null
    set iff = null
    set u = null
    set u1 = null
    set u2 = null
    set u3 = null
endfunction

//===========================================================================
function InitTrig_Marisa04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Marisa
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Marisa_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H000')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_Marisa01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Marisa01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Marisa01, Condition( function Trig_Marisa01_Conditions ) )
    call TriggerAddAction( gg_trg_Marisa01, function Trig_Marisa01_Actions )

    set gg_trg_Marisa02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Marisa02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Marisa02, Condition( function Trig_Stars_Conditions ) )
    call TriggerAddAction( gg_trg_Marisa02, function Trig_Stars_Actions )

    set gg_trg_Marisa03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Marisa03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Marisa03, Condition( function Trig_Marisa03_Conditions ) )
    call TriggerAddAction( gg_trg_Marisa03, function Trig_Marisa03_Actions )

    set gg_trg_Marisa04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Marisa04, h, EVENT_UNIT_SPELL_CAST )
    call TriggerAddCondition( gg_trg_Marisa04, Condition( function Trig_Marisa04_ID ) )
    call TriggerAddAction( gg_trg_Marisa04, function Trig_Marisa04_Cast_Actions )
    set gg_trg_Marisa04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Marisa04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Marisa04, Condition( function Trig_Marisa04_ID ) )
    call TriggerAddAction( gg_trg_Marisa04, function Trig_Marisa04_Fire_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Marisa takes nothing returns nothing
    set gg_trg_Initial_Marisa = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Marisa, function Trig_Initial_Marisa_Actions )
endfunction

//===========================================================================
// Trigger: SakuyaDS
//===========================================================================
function Trig_SakuyaDS_Conditions takes nothing returns boolean
    return IsUnitAlive(GetPlayerCharacter(GetTriggerPlayer()))
endfunction

function Trig_SakuyaDS_Actions takes nothing returns nothing
    local player who = GetTriggerPlayer()
    local unit caster = GetPlayerCharacter(who)
    local integer level01 = GetUnitAbilityLevel(caster,'A04H')
    local integer level02 = GetUnitAbilityLevel(caster,'A099')
    local real damage01 = ((30.0+15.0*level01)+GetHeroAgi(caster,true)*0.65)*(1+GetHeroInt(caster,true)*0.002)
    local real damage02 = ((30.0+15.0*level01)+GetHeroAgi(caster,true)*0.65+15*level01)*(1+GetHeroInt(caster,true)*0.002)
    local real damage03 = ((60.0+30.0*level02)+GetHeroAgi(caster,true)*1.10)*(1+GetHeroInt(caster,true)*0.002)
    if level01 != 0 then
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00奇术「永恒的小刀」伤害：|r" + R2S(damage01) + "|c00ffff00附加标记[|r" + R2S(damage02) + "|c00ffff00]|r")
    endif
    if level02 != 0 then
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00幻葬「夜雾幻影杀人鬼」：|r" + R2S(damage03))
    endif
    set who = null
    set caster = null
endfunction


//===========================================================================
function InitTrig_SakuyaDS takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: SakuyaClock
//===========================================================================
function Trig_SakuyaClock_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0QT'
endfunction

function Trig_SakuyaClock_Actions takes nothing returns nothing
    if udg_SK_SakuyaEX_ClockSwitch == false then
        set udg_SK_SakuyaEX_Effect = AddSpecialEffectTarget("Abilities\\Weapons\\SpiritOfVengeanceMissile\\SpiritOfVengeanceMissile.mdl",GetTriggerUnit(),"hand")
        set udg_SK_SakuyaEX_ClockSwitch = true
    endif
endfunction

//===========================================================================
function InitTrig_SakuyaClock takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Sakuya01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Sakuya01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A04H'
endfunction

function Trig_Sakuya01_Damage takes nothing returns nothing
    local integer task
    local unit caster
    local real damage
    local integer level
    local boolean ccc
    local unit w
    if IsUnitDead(GetTriggerUnit()) then
        set caster = null
        return
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) then
        set caster = null
        return
    endif
    if IsUnitWard(GetTriggerUnit()) then
        set caster = null
        return
    endif
    set task = GetHandleId(GetTriggeringTrigger())
    set caster = LoadUnitHandle(udg_ht,task,0)
    set damage = LoadReal(udg_ht,task,0)
    set ccc = LoadBoolean(udg_ht,task,1)
    set level = LoadInteger(udg_ht,task,2)
    call UnitDamageTarget(caster,GetEnteringUnit(),damage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_METAL_LIGHT_SLICE)
    if ccc == true then
        set w = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(GetTriggerUnit()),GetUnitY(GetTriggerUnit()),0)
        call UnitAddAbility(w,'A0QU')
        call SetUnitAbilityLevel(w,'A0QU',level)
        call IssueTargetOrder(w,"thunderbolt",GetTriggerUnit())
    endif
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Stampede\\StampedeMissileDeath.mdl",GetEnteringUnit(),"chest"))
    set caster = null
    set w = null
endfunction

function Trig_Sakuya01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local boolean ccc = LoadBoolean(udg_ht,task,4)
    local unit w
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local real px 
    local real py 
    local real a = LoadReal(udg_ht,task,0)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local trigger trg
    local triggeraction tga 
    //========
    if ccc == true then
        set w = LoadUnitHandle(udg_ht,task,5)
    endif
    if i < 24 + level * 4 and IsUnitAliveBJ(caster) then
        set px = ox + 40.0*Cos(a)
        set py = oy + 40.0*Sin(a)
        if IsTerrainPathable(px,py,PATHING_TYPE_FLYABILITY)==false then
            call SetUnitXY(u,px,py)
            if ccc == true then
                call SetUnitXY(w,px,py)
            endif
            call SaveInteger(udg_ht,task,1,i + 1)
        else
            call SaveInteger(udg_ht,task,1,40)
        endif
    else
        call KillUnit(u)
        call KillUnit(w)
        call DestroyTimer(t)
        set trg = LoadTriggerHandle(udg_ht,task,2)
        set tga = LoadTriggerActionHandle(udg_ht,task,3)
        call TriggerRemoveAction(trg,tga)
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set w = null
    set trg = null
    set tga = null
endfunction

function Trig_Sakuya01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local unit w
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real dx = tx - ox
    local real dy = ty - oy
    local real a = Atan2(dy,dx)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local real damage
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local trigger trg = CreateTrigger()
    local triggeraction tga = TriggerAddAction( trg, function Trig_Sakuya01_Damage )
    local boolean ccc = false
    //========
    set u = CreateUnit(GetOwningPlayer(caster),'o00T',ox,oy,bj_RADTODEG*a)
    if udg_SK_SakuyaEX_ClockSwitch == true and udg_SK_Sakuya04_Switch == false then
        set ccc = true
        set udg_SK_SakuyaEX_ClockSwitch = false
        call DestroyEffect(udg_SK_SakuyaEX_Effect)

        set w = CreateUnit(GetOwningPlayer(caster),'o00E',ox,oy,bj_RADTODEG*a)
    endif
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,0)
    call SaveReal(udg_ht,task,0,a)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveBoolean(udg_ht,task,4,ccc)
    if ccc == true then
        call SaveUnitHandle(udg_ht,task,5,w)
    endif
    call SaveTriggerHandle(udg_ht,task,2,trg)
    call SaveTriggerActionHandle(udg_ht,task,3,tga)
    call TimerStart(t,0.02,true,function Trig_Sakuya01_Main)
    //========
    set damage = ((30.0+15.0*level)+GetHeroAgi(caster,true)*0.65)*(1+GetHeroInt(caster,true)*0.002)
    if ccc == true then
        set damage = damage + level*15*GetHeroInt(caster,true)*0.002
    endif
    call TriggerRegisterUnitInRange( trg, u, 120.0, iff )
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveReal(udg_ht,GetHandleId(trg),0,damage)
    call SaveBoolean(udg_ht,GetHandleId(trg),1,ccc)
    call SaveInteger(udg_ht,GetHandleId(trg),2,level)
    //========
    set caster = null
    set u = null
    set w = null
    set t = null
    set iff = null
    set trg = null
    set tga = null
endfunction

//===========================================================================
function InitTrig_Sakuya01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Sakuya02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Sakuya02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A099'
endfunction

function Trig_Sakuya02_SectorDamage takes unit caster,real damage,real ox,real oy,real a,real f,real r returns nothing
    local real e
    local real d
    local real dx
    local real dy
    local unit v
    local group g = CreateGroup()
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    call GroupEnumUnitsInRange(g,ox,oy,r,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitAliveBJ(v) and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and IsUnitWard(v)==false then
            set dx = GetUnitX(v) - ox
            set dy = GetUnitY(v) - oy
            set d = SquareRoot(dx*dx + dy*dy)
            set e = RAbsBJ(YawError(a,bj_RADTODEG*Atan2(dy,dx)))
            if e<=(f + 0.03*(800.0 - d)) then
                call UnitDamageTarget(caster,v,damage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_METAL_LIGHT_SLICE)
            endif
        endif
    endloop
    call DestroyGroup(g)
    set v = null
    set g = null
    set iff = null
endfunction

function Trig_Sakuya02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local player w = GetOwningPlayer(caster)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real dx = tx - ox
    local real dy = ty - oy
    local real a = bj_RADTODEG*Atan2(dy,dx)
    local real f
    local real damage
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local integer i
    local integer n
    //========
    set damage = ((60.0+30.0*level)+GetHeroAgi(caster,true)*1.10)*(1+GetHeroInt(caster,true)*0.002)
    set f = 10.0 + 20.0*level
    call Trig_Sakuya02_SectorDamage(caster,damage,ox,oy,a,f/2.0,600.0)
    //========
    set u = CreateUnit(w,GPSU(),ox,oy,a)
    call UnitApplyTimedLife(u,'BTLF',2)
    call UnitAddAbility(u,'A09G')
    set tx = ox + 200.0*CosBJ(a)
    set ty = oy + 200.0*SinBJ(a)
    call IssuePointOrder(u,"carrionswarm",tx,ty)
    set n = level
    set i = 1
    loop
        exitwhen i > n
        set tx = ox + 200.0*CosBJ(a + 10.0*i)
        set ty = oy + 200.0*SinBJ(a + 10.0*i)
        call IssuePointOrder(u,"carrionswarm",tx,ty)
        set tx = ox + 200.0*CosBJ(a - 10.0*i)
        set ty = oy + 200.0*SinBJ(a - 10.0*i)
        call IssuePointOrder(u,"carrionswarm",tx,ty)
        set i = i + 1
    endloop
    //========
    set caster = null
    set u = null
    set w = null
endfunction

//===========================================================================
function InitTrig_Sakuya02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Sakuya03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Sakuya03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A09A'
endfunction

function Trig_Sakuya03_Speedup_Timeout takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    call UnitRemoveAbility(caster,'A09D')
    call FlushChildHashtable(udg_ht,task)
    call FlushChildHashtable(udg_ht,GetHandleId(caster))
    call DestroyTimer(t)
    set t = null
    set caster = null
endfunction

function Trig_Sakuya03_Speedup takes unit caster returns nothing
    local timer t
    local integer level = GetUnitAbilityLevel(caster,'A09D')
    if level==0 then
        set t = CreateTimer()
        call UnitAddAbility(caster,'A09D')
        call SaveUnitHandle(udg_ht,GetHandleId(t),0,caster)
        call SaveTimerHandle(udg_sht,GetHandleId(caster),0,t)
    else
        set t = LoadTimerHandle(udg_sht,GetHandleId(caster),0)
        call SetUnitAbilityLevel(caster,'A09D',IMinBJ(4,level+1))
    endif
    call TimerStart(t,6.0,false,function Trig_Sakuya03_Speedup_Timeout)
    set t = null
endfunction

function Trig_Sakuya03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real dx = GetSpellTargetX() - ox
    local real dy = GetSpellTargetY() - oy
    local real px
    local real py
    local real a = Atan2(dy,dx)
    local real d = SquareRoot(dx*dx+dy*dy)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local integer i
    
    call Trig_Sakuya03_Speedup(caster)
    
    set d = RMaxBJ(150.0,d)//最小距离150
    set d = RMinBJ(500.0 + level*100.0,d)//最大距离600、700、800、900
    set px = ox + d*Cos(a)
    set py = oy + d*Sin(a)
    call SetUnitXYFly(caster,px,py)
    
    set u = CreateUnit(GetOwningPlayer(caster),'n01R',ox,oy,GetUnitFacing(caster))
    call UnitFade(u,true,true,0.1)
    
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,0)
    call UnitApplyTimedLife(u,'BTLF',1.0)
    call UnitAddAbility(u,'A09E')
    call SetUnitAbilityLevel(u,'A09E',level)
    call IssueImmediateOrder(u,"fanofknives")
    
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),px,py,0.0)
    call UnitApplyTimedLife(u,'BTLF',2)
    call UnitAddAbility(u,'A09F')
    set i = 1
    loop
        exitwhen i > 8
        set px = ox + 250.0*CosBJ(i*45)
        set py = oy + 250.0*SinBJ(i*45)
        call SetUnitX(u,px)
        call SetUnitY(u,py)
        call IssuePointOrder(u,"clusterrockets",ox,oy)
        set i = i + 1
    endloop
    
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Sakuya03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Sakuya04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Sakuya04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A09C'
endfunction

function Trig_Sakuya04_Reset takes unit h,integer d returns nothing
    local integer level = GetUnitAbilityLevel(h,d)
    if level>0 then
        call UnitRemoveAbility(h,d)
        call UnitAddAbility(h,d)
        call SetUnitAbilityLevel(h,d,level)
        call UnitMakeAbilityPermanent(h,true,d)
    endif
endfunction

function Trig_Sakuya04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local texttag e = LoadTextTagHandle(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer level = LoadInteger(udg_ht,task,3)
    //========
    if i>0 and IsUnitType(caster,UNIT_TYPE_DEAD)==false then
        set i = i - 1
        call SaveInteger(udg_ht,task,1,i)
        call SetTextTagTextBJ(e,R2SW(0.1*i,3,1),14.0)
        if IsUnitInRange(u,caster,250 + level * 150.0) then
            call EnableTrigger(gg_trg_Sakuya04_Reset)
        else
            set udg_SK_Sakuya04_Switch = false
            call DisableTrigger(gg_trg_Sakuya04_Reset)
            call EnableTrigger(gg_trg_Sakuya04_Enter)
        endif
    else
        //========记录是否大招状态
        set udg_SK_Sakuya04_Switch = false
        call SaveInteger(udg_sht,GetHandleId(caster),S2I("Sakuya04"),0)
        call DisableTrigger(gg_trg_Sakuya04_Reset)
        call DisableTrigger(gg_trg_Sakuya04_Enter)
        call DestroyTextTag(e)
        call KillUnit(u)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set e = null
endfunction

function Trig_Sakuya04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real s
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t
    local integer task
    local texttag e
    //========
    set udg_SK_Sakuya04_Mana01 = 0
    set udg_SK_Sakuya04_Mana02 = 0
    set udg_SK_Sakuya04_Mana03 = 0
    set udg_SK_Sakuya04_Mana04 = 0
    set udg_SK_Sakuya04_Switch = true
    set s = 2.5 + 2.5 * level
    set e = CreateTextTag()
    call SetTextTagTextBJ(e,R2SW(s,3,1),14.00)
    call SetTextTagPos(e,ox,oy,200.0)
    call SetTextTagColor(e,0,255,255,255)
    set u = CreateUnit(GetOwningPlayer(caster),'h00T',ox,oy,270.0)
    if level == 1 then
        call SetUnitScale(u,0.88,0.88,0.88)
    elseif level == 2 then
        call SetUnitScale(u,1.21,1.21,1.21)
    elseif level == 3 then
        call SetUnitScale(u,1.54,1.54,1.54)
    endif
    set t = CreateTimer()
    set task = GetHandleId(t)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveTextTagHandle(udg_ht,task,2,e)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,25 + 25*level)
    call SaveInteger(udg_ht,task,3,level)
    call TimerStart(t,0.1,true,function Trig_Sakuya04_Main)
    //========
    call Trig_Sakuya04_Reset(caster,'A04H')
    call Trig_Sakuya04_Reset(caster,'A099')
    call Trig_Sakuya04_Reset(caster,'A09A')
    call EnableTrigger(gg_trg_Sakuya04_Reset)
    call TriggerRegisterUnitInRange(gg_trg_Sakuya04_Enter, u, 250.00 + level * 150 , null)
    //========记录是否大招状态
    call SaveInteger(udg_sht,GetHandleId(caster),S2I("Sakuya04"),1)
    //========
    set caster = null
    set u = null
    set t = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Sakuya04 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Sakuya04 Reset
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Sakuya04_Reset_Conditions takes nothing returns boolean
    if GetSpellAbilityId()=='A04H' then
        return true
    endif
    if GetSpellAbilityId()=='A099' then
        return true
    endif
    if GetSpellAbilityId()=='A09A' then
        return true
    endif
    if GetSpellAbilityId()=='A0QT' then
        return true
    endif
    return false
endfunction

function Trig_Sakuya04_Reset_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer d = LoadInteger(udg_ht,task,0)
    //========
    if IsUnitType(caster,UNIT_TYPE_DEAD)==false then
        call Trig_Sakuya04_Reset(caster,d)
    endif
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    //========
    set t = null
    set caster = null
endfunction

function Trig_Sakuya04_Reset_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer d = GetSpellAbilityId()
    local timer t
    local integer task
    if GetSpellAbilityId()=='A04H' then
        set udg_SK_Sakuya04_Mana01 = udg_SK_Sakuya04_Mana01 + 1
        if GetUnitState(caster,UNIT_STATE_MANA) > udg_SK_Sakuya04_Mana01 * 15 then
            call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA) - udg_SK_Sakuya04_Mana01 * 15)
            call DisplayTimedTextToForce(GetForceOfPlayer(GetOwningPlayer(caster)),5.00,"|c00ffff00第|r" + I2S(udg_SK_Sakuya04_Mana01) + "|c00ffff00次使用小刀，额外消耗|r" + R2S(udg_SK_Sakuya04_Mana01 * 15.00)  + "|c00ffff00点法力|r")
            set t = CreateTimer()
            set task = GetHandleId(t)
            call SaveUnitHandle(udg_ht,task,0,caster)
            call SaveInteger(udg_ht,task,0,d)
            call TimerStart(t,0.05,true,function Trig_Sakuya04_Reset_Main)
        else
            call DisplayTimedTextToForce(GetForceOfPlayer(GetOwningPlayer(caster)),5.00,"|c00ff00ff法力不足支付重置冷却|r")
        endif
    elseif GetSpellAbilityId()=='A099' then
        set udg_SK_Sakuya04_Mana02 = udg_SK_Sakuya04_Mana02 + 1
        if GetUnitState(caster,UNIT_STATE_MANA) > udg_SK_Sakuya04_Mana02 * 34 then
            call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA) - udg_SK_Sakuya04_Mana02 * 45)
            call DisplayTimedTextToForce(GetForceOfPlayer(GetOwningPlayer(caster)),5.00,"|c00ffff00第|r" + I2S(udg_SK_Sakuya04_Mana02) + "|c00ffff00次使用幻葬，额外消耗|r" + R2S(udg_SK_Sakuya04_Mana02 * 34.00)  + "|c00ffff00点法力|r")
            set t = CreateTimer()
            set task = GetHandleId(t)
            call SaveUnitHandle(udg_ht,task,0,caster)
            call SaveInteger(udg_ht,task,0,d)
            call TimerStart(t,0.05,true,function Trig_Sakuya04_Reset_Main)
        else
            call DisplayTimedTextToForce(GetForceOfPlayer(GetOwningPlayer(caster)),5.00,"|c00ff00ff法力不足支付重置冷却|r")
        endif
    elseif GetSpellAbilityId()=='A09A' then
        set udg_SK_Sakuya04_Mana03 = udg_SK_Sakuya04_Mana03 + 1
        if GetUnitState(caster,UNIT_STATE_MANA) > udg_SK_Sakuya04_Mana03 * 25 then
            call DisplayTimedTextToForce(GetForceOfPlayer(GetOwningPlayer(caster)),5.00,"|c00ffff00第|r" + I2S(udg_SK_Sakuya04_Mana03) + "|c00ffff00次使用奇术，额外消耗|r" + R2S(udg_SK_Sakuya04_Mana03 * 25.00)  + "|c00ffff00点法力|r")
            call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA) - udg_SK_Sakuya04_Mana03 * 25)
            set t = CreateTimer()
            set task = GetHandleId(t)
            call SaveUnitHandle(udg_ht,task,0,caster)
            call SaveInteger(udg_ht,task,0,d)
            call TimerStart(t,0.05,true,function Trig_Sakuya04_Reset_Main)
        else
            call DisplayTimedTextToForce(GetForceOfPlayer(GetOwningPlayer(caster)),5.00,"|c00ff00ff法力不足支付重置冷却|r")
        endif
    elseif GetSpellAbilityId()=='A0QT' then
        set udg_SK_Sakuya04_Mana04 = udg_SK_Sakuya04_Mana04 + 1
        call DisplayTimedTextToForce(GetForceOfPlayer(GetOwningPlayer(caster)),5.00,"|c00ffff00第|r" + I2S(udg_SK_Sakuya04_Mana04) + "|c00ffff00次使用秒表，额外消耗|r" + R2S(udg_SK_Sakuya04_Mana04 * 0.00)  + "|c00ffff00点法力|r")
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveInteger(udg_ht,task,0,d)
        call TimerStart(t,0.05,true,function Trig_Sakuya04_Reset_Main)
    endif
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Sakuya04_Reset takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Sakuya04 Enter
//===========================================================================
function Trig_Sakuya04_Enter_Actions takes nothing returns nothing
    local unit caster = GetEnteringUnit()
    if LoadInteger(udg_sht,GetHandleId(caster),S2I("Sakuya04"))==1 then
        set udg_SK_Sakuya04_Switch = true
        call DisableTrigger(gg_trg_Sakuya04_Enter)
    endif
    set caster = null
endfunction

//===========================================================================
function InitTrig_Sakuya04_Enter takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Sakuya
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Sakuya_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E000')
    local integer task = GetHandleId(h)
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_SakuyaDS = CreateTrigger()
    call TriggerRegisterPlayerEvent( gg_trg_SakuyaDS, GetOwningPlayer(h), EVENT_PLAYER_END_CINEMATIC)
    call TriggerAddCondition( gg_trg_SakuyaDS, Condition( function Trig_SakuyaDS_Conditions ) )
    call TriggerAddAction( gg_trg_SakuyaDS, function Trig_SakuyaDS_Actions )

    set gg_trg_SakuyaClock = CreateTrigger(  )
    call TriggerRegisterUnitEvent( gg_trg_SakuyaClock, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_SakuyaClock, Condition( function Trig_SakuyaClock_Conditions ) )
    call TriggerAddAction( gg_trg_SakuyaClock, function Trig_SakuyaClock_Actions )

    set gg_trg_Sakuya01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Sakuya01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Sakuya01, Condition( function Trig_Sakuya01_Conditions ) )
    call TriggerAddAction( gg_trg_Sakuya01, function Trig_Sakuya01_Actions )
    
    set gg_trg_Sakuya02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Sakuya02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Sakuya02, Condition( function Trig_Sakuya02_Conditions ) )
    call TriggerAddAction( gg_trg_Sakuya02, function Trig_Sakuya02_Actions )
    
    set gg_trg_Sakuya03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Sakuya03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Sakuya03, Condition( function Trig_Sakuya03_Conditions ) )
    call TriggerAddAction( gg_trg_Sakuya03, function Trig_Sakuya03_Actions )
    
    set gg_trg_Sakuya04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Sakuya04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Sakuya04, Condition( function Trig_Sakuya04_Conditions ) )
    call TriggerAddAction( gg_trg_Sakuya04, function Trig_Sakuya04_Actions )
    
    set gg_trg_Sakuya04_Reset = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Sakuya04_Reset, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Sakuya04_Reset, Condition( function Trig_Sakuya04_Reset_Conditions ) )
    call TriggerAddAction( gg_trg_Sakuya04_Reset, function Trig_Sakuya04_Reset_Actions )
    call DisableTrigger(gg_trg_Sakuya04_Reset)

    set gg_trg_Sakuya04_Enter = CreateTrigger()
    call TriggerAddAction( gg_trg_Sakuya04_Enter, function Trig_Sakuya04_Enter_Actions )
    call DisableTrigger(gg_trg_Sakuya04_Enter)    

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Sakuya takes nothing returns nothing
    set gg_trg_Initial_Sakuya = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Sakuya, function Trig_Initial_Sakuya_Actions )
endfunction

//===========================================================================
// Trigger: ReimuEx
//===========================================================================
function Trig_ReimuEx_Actions takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    call THD_AddCredit(GetOwningPlayer(caster),4)
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_ReimuEx takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Reimu01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Reimu01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A048'
endfunction

function Trig_Reimu01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local integer z = LoadInteger(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,1)
    local real v = LoadReal(udg_ht,task,0)
    local real g = -1.2
    local real h = LoadReal(udg_ht,task,1)
    //========
    if i<z then
        set h = h + v
        call SetUnitFlyHeight(u,h,2000)
        if h<5.0 and v<0 then
            set v = -0.75*v
            call IssueImmediateOrder(u,"stomp")
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",GetUnitX(u),GetUnitY(u)))
            call SetUnitAbilityLevel(u,'A04C',GetUnitAbilityLevel(u,'A04C')-4)
        endif
        set v = v + g
        set i = i + 1
        call SaveInteger(udg_ht,task,1,i)
        call SaveReal(udg_ht,task,1,h)
        call SaveReal(udg_ht,task,0,v)
    else
        call RemoveUnit(u)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set u = null
endfunction

function Trig_Reimu01_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local unit u
    local real px = GetSpellTargetX()
    local real py = GetSpellTargetY()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    local real abilitycooldownlv01 = 14
    local real abilitycooldownlv02 = 14
    local real abilitycooldownlv03 = 14
    local real abilitycooldownlv04 = 14
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set u = CreateUnit(GetOwningPlayer(caster),'n00S',px,py,0.0)
    call SetUnitAbilityLevel(u,'A04C',level+8)
    call SetUnitScale(u,1.5+0.3*level,1.5+0.3*level,1.5+0.3*level)
    //--------
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,1,0)
    call SaveInteger(udg_ht,task,2,R2I((1.5+level*0.2)*50))
    call SaveReal(udg_ht,task,0,0)
    call SaveReal(udg_ht,task,1,600)
    call TimerStart(t,0.02,true,function Trig_Reimu01_Main)
    //========
    set t = null
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Reimu01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Reimu02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Reimu02_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A049'
endfunction

function UnitBump_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_ht,task,0)
    local real v = LoadReal(udg_ht,task,0)
    local real f = LoadReal(udg_ht,task,1)
    local real g = -1.2
    local real h = GetUnitFlyHeight(u)
    //========
    if IsUnitAliveBJ(u) then
        set h = h + v
        call SetUnitFlyHeight(u,h,2000)
        if h<5.0 and v<0 then
            set v = -1*f*v
        endif
        call SaveReal(udg_ht,task,0,v + g)
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set u = null
endfunction

function UnitBump takes unit u,real f returns integer
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    call SaveUnitHandle(udg_ht,task,0,u)
    call SaveReal(udg_ht,task,0,0)
    call SaveReal(udg_ht,task,1,f)
    call TimerStart( t, 0.02, true, function UnitBump_Main )
    //========
    set t = null
    return task
endfunction

function Trig_Reimu02_Lockdown takes nothing returns boolean
    if GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)<=0 then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if IsUnitWard(GetFilterUnit()) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_MAGIC_IMMUNE) then
        return false
    endif
    return IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))
endfunction

function Trig_Reimu02_Target takes nothing returns boolean
    local trigger trg
    local integer task
    if GetTriggerEventId()==EVENT_UNIT_DEATH then
        set trg = GetTriggeringTrigger()
        set task = GetHandleId(trg)
        call DestroyBoolExpr(LoadBooleanExprHandle(udg_ht,task,3))
        call TriggerRemoveCondition(trg,LoadTriggerConditionHandle(udg_ht,task,4))
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,5))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        return false
    endif
    if GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE)<=0 then
        return false
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if IsUnitWard(GetTriggerUnit()) then
        return false
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_MAGIC_IMMUNE) then
        return false
    endif
    return true
endfunction

function Trig_Reimu02_Damage takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v = GetTriggerUnit()
    local real damage = LoadReal(udg_ht,task,0)
    //========
    call DestroyBoolExpr(LoadBooleanExprHandle(udg_ht,task,3))
    call TriggerRemoveCondition(trg,LoadTriggerConditionHandle(udg_ht,task,4))
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,5))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    call UnitDamageTarget(caster,v,damage,true,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\StormBolt\\StormBoltMissile.mdl",v,"chest"))
    call KillUnit(u)
    //========
    set trg = null
    set caster = null
    set u = null
    set v = null
endfunction

function Trig_Reimu02_Remove takes nothing returns nothing
    call KillUnit(GetEnumUnit())
endfunction

function Trig_Reimu02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target
    local unit u
    local trigger trg
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local triggeraction tga
    local triggercondition tgc
    local integer task
    local real a
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local real h
    local real damage
    local boolexpr f
    local group g = CreateGroup()
    local group v = CreateGroup()
    local integer i
    local integer n
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    local real abilitycooldownlv01 = 9.0
    local real abilitycooldownlv02 = 9.0
    local real abilitycooldownlv03 = 9.0
    local real abilitycooldownlv04 = 9.0
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if level == 1 then
        set n = 4
        set damage = 70.0
    elseif level == 2 then
        set n = 5
        set damage = 80.0
    elseif level == 3 then
        set n = 6
        set damage = 90.0
    elseif level == 4 then
        set n = 7
        set damage = 100.0
    endif
    set f = Filter(function Trig_Reimu02_Lockdown)
    call GroupEnumUnitsInRange(v,ox,oy,650.0,f)
    call DestroyBoolExpr(f)
    //========
    set i = 1
    loop
        exitwhen i>n
        //--------
        set a = GetRandomReal(0,360)
        set px = ox + 70.0*CosBJ(a)
        set py = oy + 70.0*SinBJ(a)
        set h = GetRandomReal(80,180)
        set u = CreateUnit(GetOwningPlayer(caster),'n00T' + GetRandomInt(0,2),px,py,a)
        call SetUnitFlyHeight(u,h,1000.0)
        call UnitBump(u,1.07)
        call GroupAddUnit(g,u)
        //--------
        set trg = CreateTrigger()
        set task = GetHandleId(trg)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveUnitHandle(udg_ht,task,1,u)
        call SaveReal(udg_ht,task,0,damage)
        call TriggerRegisterUnitInRange( trg, u, 120.0, iff )
        call TriggerRegisterUnitEvent( trg, u, EVENT_UNIT_DEATH )
        set f = Condition( function Trig_Reimu02_Target )
        set tgc = TriggerAddCondition( trg, f )
        set tga = TriggerAddAction( trg, function Trig_Reimu02_Damage )
        call SaveBooleanExprHandle(udg_ht,task,3,f)
        call SaveTriggerConditionHandle(udg_ht,task,4,tgc)
        call SaveTriggerActionHandle(udg_ht,task,5,tga)
        //--------
        set target = GroupPickRandomUnit(v)
        if target!=null then
            call IssueTargetOrder(u,"attack",target)
        else
            call IssuePointOrder(u,"attack",ox + 800.0*CosBJ(a),oy + 800.0*SinBJ(a))
        endif
        //--------
        set i = i + 1
    endloop
    call DestroyGroup(v)
    call CastSpell(caster,"灵符--「梦想封印」!!")
    call TriggerSleepAction(3.5)
    //========
    call ForGroup(g,function Trig_Reimu02_Remove)
    call DestroyGroup(g)
    set caster = null
    set target = null
    set trg = null
    set tgc = null
    set tga = null
    set iff = null
    set u = null
    set f = null
    set g = null
    set v = null
endfunction

//===========================================================================
function InitTrig_Reimu02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Reimu03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Reimu03_Conditions takes nothing returns boolean
    if GetSpellAbilityId()!='A04A' then
        return false
    endif
    if GetUnitAbilityLevel(GetSpellTargetUnit(),'A04D')>0 then
        return false
    endif
    if IsUnitAntiDebuff(GetSpellTargetUnit()) then
        return false
    endif
    return true
endfunction

function Trig_Reimu03_Remove takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local effect e = LoadEffectHandle(udg_ht,task,2)
    //========
    call UnitRemoveAbility(u,'A04D')
    call DestroyEffect(e)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    //========
    set t = null
    set caster = null
    set u = null
    set e = null
endfunction

function Trig_Reimu03_Actions takes nothing returns nothing
    local timer t
    local integer task
    local unit caster = GetTriggerUnit()
    local unit u = GetSpellTargetUnit()
    local unit v
    local effect e
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local real d
    //========
    local real abilitycooldownlv01 = 12.0
    local real abilitycooldownlv02 = 12.0
    local real abilitycooldownlv03 = 12.0
    local real abilitycooldownlv04 = 12.0
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set t = null
            set caster = null
            set u = null
            set v = null
            set e = null
        endif
    endif
    //========
    set t = CreateTimer()
    set task = GetHandleId(t)
    set e = AddSpecialEffectTarget("MagicShell.mdl",u,"overhead")
    if IsUnitAlly(u,GetTriggerPlayer()) then
        call UnitAddAbility(u,'A04D')
        set d = 1.0 + 1.0*level
    else
        set d = 1.0 + 1.0*level
        set v = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(caster),GetUnitY(caster),GetUnitFacing(caster))
        call UnitAddAbility(v,'A04E')
        call SetUnitAbilityLevel(v,'A04E',level)
        call IssueTargetOrder(v,"drunkenhaze",u)
    endif
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveEffectHandle(udg_ht,task,2,e)
    call TimerStart(t,d,false,function Trig_Reimu03_Remove)
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Reimu03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Reimu04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Reimu04_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A04B'
endfunction

function Trig_Reimu04_Target takes nothing returns boolean
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if IsUnitDead(GetFilterUnit()) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function Trig_Reimu04_Clear takes nothing returns nothing
    call UnitRemoveAbility(GetEnumUnit(),'B04K')
endfunction

function Trig_Reimu04_Trace takes nothing returns nothing
    local integer task = GetHandleId(GetExpiredTimer())
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v = GetEnumUnit()
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local real r = LoadReal(udg_ht,task,0)
    if IsUnitInRangeXY(v,ox,oy,r)==false then
        call UnitRemoveAbility(v,'B04K')
    endif
    set u = null
    set v = null
endfunction

function Trig_Reimu04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local real r = LoadReal(udg_ht,task,0)
    local group m = LoadGroupHandle(udg_ht,task,3)
    local group g
    local boolexpr f
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer n = LoadInteger(udg_ht,task,2)
    local integer j
    local integer k
    //========
    if i<10 then
        if i==8 then
            call KillUnit(LoadUnitHandle(udg_ht,task,2))
        endif
        call SaveInteger(udg_ht,task,1,i + 1)
        call SetUnitLifePercentBJ(u,100.0)
        call ForGroup(m,function Trig_Reimu04_Trace)
        call GroupClear(m)
        set g = CreateGroup()
        set f = Filter(function Trig_Reimu04_Target)
        call GroupEnumUnitsInRange(g,ox,oy,r,f)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            call GroupAddUnit(m,v)
            if IsUnitAlly(v,GetOwningPlayer(caster)) then
                if GetUnitAbilityLevel(v,'B04K')==0 then
                    call IssueTargetOrder(u,"antimagicshell",v)
                endif
            else
                set k = GetHandleId(v)
                if HaveSavedInteger(udg_ht,task,k) then
                    set j = LoadInteger(udg_ht,task,k)
                else
                    set j = 0
                endif
                if j<n then
                    if IssueTargetOrder(u,"thunderbolt",v) then
                        if IsUnitType(v,UNIT_TYPE_HERO) then
                            call KillUnit(CreateUnit(Player(PLAYER_NEUTRAL_PASSIVE),'e014',GetUnitX(v),GetUnitY(v),22.5))
                            call KillUnit(CreateUnit(Player(PLAYER_NEUTRAL_PASSIVE),'e014',GetUnitX(v),GetUnitY(v),22.5))
                            call KillUnit(CreateUnit(Player(PLAYER_NEUTRAL_PASSIVE),'e014',GetUnitX(v),GetUnitY(v),22.5))
                        endif
                        set j = j + 1
                    endif
                    call SaveInteger(udg_ht,task,k,j)
                endif
            endif
        endloop
        call DestroyBoolExpr(f)
        call DestroyGroup(g)
    else
        call RemoveUnit(u)
        call ForGroup(m,function Trig_Reimu04_Clear)
        call GroupClear(m)
        call DestroyGroup(m)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set m = null
    set g = null
    set f = null
endfunction

function Trig_Reimu04_Field_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_ht,task,0)
    local real a = LoadReal(udg_ht,task,0)
    local real b = LoadReal(udg_ht,task,1)
    local real k = LoadReal(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i<50 then
        set a = a + k*(b - a)
        call SaveReal(udg_ht,task,0,a)
        call SaveInteger(udg_ht,task,1,i + 1)
        call SetUnitScale(u,a,a,a)
    else
        call SetUnitScale(u,b,b,b)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set u = null
endfunction

function Trig_Reimu04_Field takes unit u,real begin,real end,real k returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    call SetUnitScale(u,begin,begin,begin)
    call SaveUnitHandle(udg_ht,task,0,u)
    call SaveInteger(udg_ht,task,1,1)
    call SaveReal(udg_ht,task,0,begin)
    call SaveReal(udg_ht,task,1,end)
    call SaveReal(udg_ht,task,2,k)
    call TimerStart(t,0.02,true,function Trig_Reimu04_Field_Main)
    set t = null
endfunction

function Trig_Reimu04_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local unit u
    local unit v
    local unit w
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real s
    local real r
    local group m = CreateGroup()
    local group g
    local boolexpr f
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local integer i
    //========
    local real abilitycooldownlv01 = 120.0
    local real abilitycooldownlv02 = 120.0
    local real abilitycooldownlv03 = 120.0
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    set s = 1.1 + 0.25*(level-1)
    set r = 316.0 + 100.0*level
    set w = CreateUnit(GetOwningPlayer(caster),'n00W',ox,oy,180)
    call SetUnitVertexColor(w,255,255,255,220)
    call Trig_Reimu04_Field(w,0.3,s,0.08)
    //========
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,0)
    call UnitAddAbility(u,'A0CC')
    call UnitAddAbility(u,'A0A0')
    call SetUnitAbilityLevel(u,'A0A0',level)
    set g = CreateGroup()
    set f = Filter(function Trig_Reimu04_Target)
    call GroupEnumUnitsInRange(g,ox,oy,r,f)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitAlly(v,GetOwningPlayer(caster)) then
            call GroupAddUnit(m,v)
            call IssueTargetOrder(u,"antimagicshell",v)
        endif
    endloop
    call DestroyBoolExpr(f)
    call DestroyGroup(g)
    //========
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,0)
    call SaveInteger(udg_ht,task,2,1 + level)
    call SaveReal(udg_ht,task,0,r)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveUnitHandle(udg_ht,task,2,w)
    call SaveGroupHandle(udg_ht,task,3,m)
    call TimerStart(t,0.4,true,function Trig_Reimu04_Main)
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set w = null
    set m = null
    set g = null
    set f = null
endfunction

//===========================================================================
function InitTrig_Reimu04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Reimu
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Reimu_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H001')

    local timer t = CreateTimer()
    local integer task = GetHandleId(t)

    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
   
    call SaveUnitHandle(udg_ht,task,0,h)
    call TimerStart(t,12.00,true,function Trig_ReimuEx_Actions)

    set gg_trg_Reimu01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Reimu01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Reimu01, Condition( function Trig_Reimu01_Conditions ) )
    call TriggerAddAction( gg_trg_Reimu01, function Trig_Reimu01_Actions )

    set gg_trg_Reimu02 = CreateTrigger()
    call TriggerRegisterUnitEvent(gg_trg_Reimu02, h, EVENT_UNIT_SPELL_EFFECT)
    call TriggerAddCondition(gg_trg_Reimu02, Condition(function Trig_Reimu02_Conditions) )
    call TriggerAddAction(gg_trg_Reimu02, function Trig_Reimu02_Actions)

    set gg_trg_Reimu03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Reimu03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Reimu03, Condition( function Trig_Reimu03_Conditions ) )
    call TriggerAddAction( gg_trg_Reimu03, function Trig_Reimu03_Actions )

    set gg_trg_Reimu04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Reimu04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Reimu04, Condition( function Trig_Reimu04_Conditions ) )
    call TriggerAddAction( gg_trg_Reimu04, function Trig_Reimu04_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Reimu takes nothing returns nothing
    set gg_trg_Initial_Reimu = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Reimu, function Trig_Initial_Reimu_Actions )
endfunction

//===========================================================================
// Trigger: YukariEyebug
//===========================================================================
function Trig_YukariEyebug_Conditions takes nothing returns boolean
    if IsUnitSpawn(GetEnteringUnit()) != true then
        return false
    endif
    return GetOwningPlayer(GetEnteringUnit()) == Player(4) or GetOwningPlayer(GetEnteringUnit()) == Player(10)
endfunction

function Trig_YukariEyebug_Actions takes nothing returns nothing
    call KillUnit(GetEnteringUnit())
endfunction

//===========================================================================
function InitTrig_YukariEyebug takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yukari02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Yukari02_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A04L'
endfunction

function Trig_Yukari02_End takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    //========
    call SetUnitFlag(target,CS_LOST(),false)
    call ShowUnit(target,true)
    call PauseUnit(target,false)
    call SetUnitInvulnerable(target,false)
    call SelectUnitForPlayerSingle(target,GetOwningPlayer(target))
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    //========
    set t = null
    set caster = null
    set target = null
endfunction

function Trig_Yukari02_Unit takes unit caster,unit target returns nothing
    if IsUnitDead(target) then
        return
    endif
    call IssueImmediateOrder(target,"stop")
    call SetUnitInvulnerable(target,true)
    call PauseUnit(target,true)
    call ShowUnit(target,false)
    call SetUnitPositionLoc(target,udg_BackStage)
    call GroupAddUnit(udg_SK_Yukari_Gap,target)
    set udg_SK_Yukari_Count = udg_SK_Yukari_Count + 1
    if GetUnitAbilityLevel(caster,'A0GL')==0 then
        call UnitAddAbility(caster,'A0GL')
    endif
    if GetHeroLevel(caster)>=6 then
        call SetUnitAbilityLevel(caster,'A0GL',2)
    endif
    if GetHeroLevel(caster)>=11 then
        call SetUnitAbilityLevel(caster,'A0GL',3)
    endif
    if GetHeroLevel(caster)>=16 then
        call SetUnitAbilityLevel(caster,'A0GL',4)
    endif
    if GetHeroLevel(caster)>=21 then
        call SetUnitAbilityLevel(caster,'A0GL',5)
    endif
endfunction

function Trig_Yukari02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local integer level = GetUnitAbilityLevel(caster,'A04L')
    local timer t
    local integer task
    //========
    local real abilitycooldownlv01 = 27
    local real abilitycooldownlv02 = 22
    local real abilitycooldownlv03 = 17
    local real abilitycooldownlv04 = 12
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set t = null
            set u = null
            return
        endif
    endif
    //========
    set t = CreateTimer()
    set task = GetHandleId(t)
    set tx = tx - 64.0*CosBJ(a)
    set ty = ty - 64.0*SinBJ(a)
    set u = CreateUnit(GetOwningPlayer(caster),'h011',tx,ty,a+180.0)
    call UnitApplyTimedLife(u,'BTLF',0.4)
    call SetUnitTimeScale(u,2.0)
    
    call TriggerSleepAction(0.3)
    
    if IsUnitAliveBJ(target) and GetUnitCurrentOrder(target)!=OrderId("metamorphosis") then
        if IsUnitSpawn(target) and udg_SK_Yukari_Count<36 then
            call Trig_Yukari02_Unit(caster,target)
            call DisplayTextToPlayer(GetOwningPlayer(caster),0.0,0.0,"当前间隙中单位的数量：" + I2S(udg_SK_Yukari_Count))
        else
            if (not GetUnitFlag(target,CS_DASHING())) and (not IsUnitAntiDebuff(target)) then
                call IssueImmediateOrder(target,"stop")
                call PauseUnit(target,true)
                call ShowUnit(target,false)
                call SetUnitInvulnerable(target,true)
                set t = CreateTimer()
                set task = GetHandleId(t)
                call SaveUnitHandle(udg_ht,task,0,caster)
                call SaveUnitHandle(udg_ht,task,1,target)
                call SetUnitFlag(target,CS_LOST(),true)
                call TimerStart(t,1.0 + 0.5*level,false,function Trig_Yukari02_End)
            endif
        endif
    endif
    //========
    set caster = null
    set target = null
    set t = null
    set u = null
endfunction

function InitTrig_Yukari02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Yukari02 Gap Dump
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Yukari02_Dump_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local player w = GetOwningPlayer(caster)
    local real r
    local real x
    local real y
    local effect e = LoadEffectHandle(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer level
    local integer abilevel = GetUnitAbilityLevel(caster,'A04L')
    local real damage
    local group g
    local boolexpr iff
    //========
    if i>0 then
        if IsUnitDead(u) then
            call DestroyEffect(e)
            call SaveEffectHandle(udg_ht,task,2,null)
        endif
        call SetUnitFlyHeight(u,80.0*i,1600.00)
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        if e!=null then
            call DestroyEffect(e)
        endif
        if true then
            call PauseUnit(u,false)
            call SetUnitFlyHeight(u,0.0,1600.0)
            call THD_ResetSpawnUnitOrder(u)
            set level = abilevel
            set r = 210.0
            set x = GetUnitX(u)
            set y = GetUnitY(u)
            set damage = 100 + abilevel * 35.0
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",x,y))
            set u = CreateUnit(GetOwningPlayer(caster),GPSU(),x,y,0.0)
            call UnitAddAbility(u,'A0GJ')
            call SetUnitAbilityLevel(u,'A0GJ',level)
            set g = CreateGroup()
            set iff = GetPlayerFilter(w)
            call GroupEnumUnitsInRange(g,x,y,r,iff)
            loop
                set v = FirstOfGroup(g)
                exitwhen v == null
                call GroupRemoveUnit(g,v)
                if IsUnitAliveBJ(v) and IsUnitEnemy(v,w) and IsUnitWard(v)==false and IsUnitType(v,UNIT_TYPE_MECHANICAL)==false then
                    call UnitDamageTarget(caster,v,damage,false,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,null)
                    call IssueTargetOrder(u,"thunderbolt",v)
                endif
            endloop
            call DestroyGroup(g)
            call UnitDamageTarget(caster,u,0.30*GetUnitState(u,UNIT_STATE_MAX_LIFE),false,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,null)
        endif
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set e = null
    set u = null
    set v = null
    set w = null
    set g = null
    set iff = null
endfunction

function Trig_Yukari02_Dump takes unit caster,real tx,real ty returns nothing
    local timer t
    local integer task
    local group g = udg_SK_Yukari_Gap
    local unit u
    local effect e
    //========
    if udg_SK_Yukari_Count<=0 then
        set udg_SK_Yukari_Count = 0
        set t = null
        set g = null
        set u = null
        set e = null
        set caster = null
        return
    endif
    //========
    set bj_groupRandomConsidered = 0
    set bj_groupRandomCurrentPick = null
    call ForGroup(g,function GroupPickRandomUnitEnum)
    set u = bj_groupRandomCurrentPick
    //========
    if u!=null then
        call GroupRemoveUnit(g,u)
        set udg_SK_Yukari_Count = udg_SK_Yukari_Count - 1
        call ShowUnit(u,true)
        call SetUnitInvulnerable(u,false)
        call EnableHeight(u)
        call SetUnitFlyHeight(u,800.0,100000.0)
        call SetUnitPosition(u,tx,ty)
        set e = AddSpecialEffectTarget("nebula.mdl",u,"origin")
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveUnitHandle(udg_ht,task,1,u)
        call SaveEffectHandle(udg_ht,task,2,e)
        call SaveInteger(udg_ht,task,1,10)
        call TimerStart(t,0.05,true,function Trig_Yukari02_Dump_Main)
    endif
    set bj_groupCountUnits = 0
    call ForGroup(g,function CountUnitsInGroupEnum)
    set udg_SK_Yukari_Count = bj_groupCountUnits
    //========
    set t = null
    set caster = null
    set g = null
    set u = null
    set e = null
endfunction

function Trig_Yukari02_Gap_Dump_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0GK'
endfunction

function Trig_Yukari02_Gap_Dump_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real px
    local real py
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local unit u
    //========
    local real abilitycooldownlv01 = 7
    local real abilitycooldownlv02 = 6
    local real abilitycooldownlv03 = 5
    local real abilitycooldownlv04 = 4
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set px = tx - 64.0*CosBJ(a)
    set py = ty - 64.0*SinBJ(a)
    set u = CreateUnit(GetOwningPlayer(caster),'h014',px,py,a+180.0)
    call UnitApplyTimedLife(u,'BTLF',0.4)
    call SetUnitTimeScale(u,2.0)
    
    call Trig_Yukari02_Dump(caster,tx,ty)
    //========
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Yukari02_Gap_Dump takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Yukari02 Mega Dump
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Yukari02_Mega_Dump_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0GL'
endfunction

function Trig_Yukari02_Mega_Dump_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u
    local location o = Location(LoadReal(udg_ht,task,0),LoadReal(udg_ht,task,1))
    local location p
    local real px 
    local real py 
    local integer level
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i>0 then
        set p = GetRandomLocInRange(o,250.0)
        call Trig_Yukari02_Dump(caster,GetLocationX(p),GetLocationY(p))
        call RemoveLocation(o)
        call RemoveLocation(p)
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set o = null
    set p = null
endfunction

function Trig_Yukari02_Mega_Dump_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real px
    local real py
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local real d = SquareRoot(Pow(ty-oy,2)+Pow(tx-ox,2))
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer level = GetUnitAbilityLevel(caster,'A0GL')
    local integer n = IMinBJ(level*2,udg_SK_Yukari_Count)
    //========
    local real abilitycooldownlv01 = 45
    local real abilitycooldownlv02 = 45
    local real abilitycooldownlv03 = 45
    local real abilitycooldownlv04 = 45
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set px = tx - 256.0*CosBJ(a)
    set py = ty - 256.0*SinBJ(a)
    set u = CreateUnit(GetOwningPlayer(caster),'h014',px,py,a+180.0)
    call SetUnitScale(u,1.2,1.2,1.2)
    call UnitApplyTimedLife(u,'BTLF',4.4)
    call SetUnitTimeScale(u,2.0)
    
    call TriggerSleepAction(0.3)
    
    if GetUnitCurrentOrder(caster)==OrderId("impale") then
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveInteger(udg_ht,task,1,n)
        call SaveReal(udg_ht,task,0,tx)
        call SaveReal(udg_ht,task,1,ty)
        call TimerStart(t,0.33,true,function Trig_Yukari02_Mega_Dump_Main)
    else
        call KillUnit(u)
        call DestroyTimer(t)
    endif
    //========
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Yukari02_Mega_Dump takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Yukari03
//===========================================================================
function Trig_Yukari03_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A04N'
endfunction

function Trig_Yukari03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    //========
    local real abilitycooldownlv01 = 75
    local real abilitycooldownlv02 = 60
    local real abilitycooldownlv03 = 45
    local real abilitycooldownlv04 = 30
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set caster = null
endfunction

//===========================================================================
function InitTrig_Yukari03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yukari04 New
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Yukari04_New_Conditions takes nothing returns boolean
    local integer d = GetSpellAbilityId()
    return ('A0IA'<=d)and(d<='A0IG')
endfunction

function Trig_Yukari04_New_Distance takes real distance returns integer
    local real d = 1800.0
    local integer i = 1
    loop
        exitwhen i>=7
        exitwhen distance<=d
        set i = i + 1
        set d = d + 1800.0 + 200.0*i
    endloop
    return i
endfunction

function Trig_Yukari04_New_Target takes nothing returns boolean
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')>0 then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_TAUREN) then
        return false
    endif
    if GetOwningPlayer(GetFilterUnit())==Player(PLAYER_NEUTRAL_PASSIVE) then
        return false
    endif
    if IsUnitDeadBJ(GetFilterUnit()) then
        return false
    endif
    if IsUnitWard(GetFilterUnit()) then
        return false
    endif
    if IsUnitGiant(GetFilterUnit()) then
        return false
    endif
    return true
endfunction

function Trig_Yukari04_New_Active takes nothing returns nothing
    local integer task = GetHandleId(GetExpiredTimer())
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = GetEnumUnit()
    local real ox = GetUnitX(target)
    local real oy = GetUnitY(target)
    local real dx = ox - LoadReal(udg_ht,task,0)
    local real dy = oy - LoadReal(udg_ht,task,1)
    local real a = Atan2(dy,dx)
    local real d = SquareRoot(dx*dx+dy*dy)
    if IsUnitAlly(target,GetOwningPlayer(caster)) then
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\MassTeleport\\MassTeleportCaster.mdl",ox,oy))
        set dx = LoadReal(udg_ht,task,2) + 0.4*d*Cos(a)
        set dy = LoadReal(udg_ht,task,3) + 0.4*d*Sin(a)
        call SetUnitPosition(target,dx,dy)
        call DestroyEffect(AddSpecialEffectTarget("nebula.mdl",target,"origin"))
    else
        if IsUnitSpawn(target) and udg_SK_Yukari_Count<36 then
            call Trig_Yukari02_Unit(caster,target)
            call DestroyEffect(AddSpecialEffect("Yukari04LockOnA.mdl",ox,oy))
        endif
    endif
    set caster = null
    set target = null
endfunction

function Trig_Yukari04_New_Clear takes nothing returns nothing
    local integer task = GetHandleId(GetExpiredTimer())
    local effect e = LoadEffectHandle(udg_ht,task,GetHandleId(GetEnumUnit()))
    call DestroyEffect(e)
    set e = null
endfunction

function Trig_Yukari04_New_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local player w = GetOwningPlayer(caster)
    local effect e
    local real ox = LoadReal(udg_ht,task,0)
    local real oy = LoadReal(udg_ht,task,1)
    local real tx = LoadReal(udg_ht,task,2)
    local real ty = LoadReal(udg_ht,task,3)
    local real r = LoadReal(udg_ht,task,4)
    local real s
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer n
    local boolexpr f
    local group g
    local group m = LoadGroupHandle(udg_ht,task,2)
    //========
    if GetUnitCurrentOrder(caster)==OrderId("massteleport") and i<100 then
        set s = 1.0 + r/100.0
        call SetUnitScale(u,s,s,s)
        set r = r + 0.02*(900.0 - r)
        call SaveReal(udg_ht,task,4,r)
        call SaveInteger(udg_ht,task,1,i + 1)
        if i*5/5==i then
            set n = LoadInteger(udg_ht,task,2)
            set g = CreateGroup()
            set f = Filter(function Trig_Yukari04_New_Target)
            call GroupEnumUnitsInRange(g,ox,oy,r,f)
            loop
                set v = FirstOfGroup(g)
                exitwhen v == null
                call GroupRemoveUnit(g,v)
                if IsUnitAlly(v,w) then
                    if IsUnitSpawn(v)==false then
                        set e = LoadEffectHandle(udg_ht,task,GetHandleId(v))
                        if e==null then
                            set e = AddSpecialEffectTarget("Yukari04LockOnB.mdl",v,"origin")
                            call SaveEffectHandle(udg_ht,task,GetHandleId(v),e)
                            call GroupAddUnit(m,v)
                        endif
                    endif
                else
                    if IsUnitSpawn(v) and n<8 then
                        set e = LoadEffectHandle(udg_ht,task,GetHandleId(v))
                        if e==null then
                            set e = AddSpecialEffectTarget("Yukari04LockOnA.mdl",v,"origin")
                            call SaveEffectHandle(udg_ht,task,GetHandleId(v),e)
                            call GroupAddUnit(m,v)
                            set n = n + 1
                        endif
                    endif
                endif
            endloop
            call DestroyBoolExpr(f)
            call DestroyGroup(g)
            call SaveInteger(udg_ht,task,1,n)
        endif
    else
        call ForGroup(m,function Trig_Yukari04_New_Clear)
        if IsUnitAlive(caster) then
            call ForGroup(m,function Trig_Yukari04_New_Active)
            call DisplayTextToPlayer(GetOwningPlayer(caster),0.0,0.0,"当前间隙中单位的数量：" + I2S(udg_SK_Yukari_Count))
        endif
        call RemoveUnit(u)
        call DestroyGroup(m)
        call DestroyEffect(LoadEffectHandle(udg_ht,task,3))
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set w = null
    set m = null
    set g = null
    set f = null
    set e = null
endfunction

function Trig_Yukari04_New_Position_Target takes nothing returns boolean
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitDead(GetFilterUnit()) then
        return false
    endif
    if IsUnitWard(GetFilterUnit()) then
        return false
    endif
    if GetOwningPlayer(GetFilterUnit())==Player(PLAYER_NEUTRAL_PASSIVE) then
        return false
    endif
    return IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))
endfunction

function Trig_Yukari04_New_Position takes real tx,real ty,boolean k returns unit
    local unit target
    local unit v
    local real dx
    local real dy
    local real d
    local real min = 99999.0
    local group g
    local boolexpr f
    //========
    set target = null
    set g = CreateGroup()
    set f = Filter(function Trig_Yukari04_New_Position_Target)
    call GroupEnumUnitsInRange(g,tx,ty,800.0,f)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if k or IsUnitType(v,UNIT_TYPE_STRUCTURE) then
            set dx = GetUnitX(v) - tx
            set dy = GetUnitY(v) - ty
            set d = SquareRoot(dx*dx + dy*dy)
            if d<min then
                set target = v
                set min = d
            endif
        endif
    endloop
    call DestroyBoolExpr(f)
    call DestroyGroup(g)
    //========
    set bj_lastLoadedUnit = target
    set target = null
    set g = null
    set f = null
    set v = null
    return bj_lastLoadedUnit
endfunction

function Trig_Yukari04_New_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx
    local real ty
    local real dx
    local real dy
    local real d
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t
    local integer task
    local integer i
    //========
    if GetTriggerEventId()==EVENT_UNIT_SPELL_CAST then
        set tx = GetSpellTargetX()
        set ty = GetSpellTargetY()
        if level<3 then
            set target = Trig_Yukari04_New_Position(tx,ty,level>=2)
            if target==null then
                call IssueImmediateOrder(caster,"stop")
                call DisplayTextToPlayer(GetOwningPlayer(caster),0,0,"|cffff0000附近没有可用的目标|r")
                set caster = null
                set target = null
                set u = null
                set t = null
                return
            else
                set tx = GetUnitX(target)
                set ty = GetUnitY(target)
            endif
        endif
        call SaveReal(udg_sht,GetHandleId(caster),0,tx)
        call SaveReal(udg_sht,GetHandleId(caster),1,ty)
        if GetUnitAbilityLevel(caster,'A0I9')>0 then
            call UnitRemoveAbility(caster,'A0I8')
        endif
        set dx = tx - ox
        set dy = ty - oy
        set d = SquareRoot(dx*dx+dy*dy)
        set level = Trig_Yukari04_New_Distance(d)
        if level>1 then
            call UnitAddAbility(caster,'A0I8')
            set i = 2
            loop
                call SetUnitAbilityLevel(caster,'A0I9',i)
                set i = i + 1
                exitwhen i>level
                exitwhen i>7
            endloop
        endif
        call DebugMsg(R2S(d))
        call DebugMsg(I2S(level))
    else
        set tx = LoadReal(udg_sht,GetHandleId(caster),0)
        set ty = LoadReal(udg_sht,GetHandleId(caster),1)
        set u = CreateUnit(GetOwningPlayer(caster),'n03M',ox,oy,270.0)
        call SetUnitVertexColor(u,255,255,255,160)
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveUnitHandle(udg_ht,task,1,u)
        call SaveGroupHandle(udg_ht,task,2,CreateGroup())
        call SaveEffectHandle(udg_ht,task,3,AddSpecialEffect("nebula.mdl",tx,ty))
        call SaveReal(udg_ht,task,0,ox)
        call SaveReal(udg_ht,task,1,oy)
        call SaveReal(udg_ht,task,2,tx)
        call SaveReal(udg_ht,task,3,ty)
        call SaveReal(udg_ht,task,4,100.0)
        call SaveInteger(udg_ht,task,0,level)
        call SaveInteger(udg_ht,task,1,0)
        call SaveInteger(udg_ht,task,2,0)
        call TimerStart(t,0.02,true,function Trig_Yukari04_New_Main)
    endif
    //========
    set caster = null
    set target = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Yukari04_New takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Yukari04 New Effect
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Yukari04_New_Effect_Conditions takes nothing returns boolean
    local integer d = GetSpellAbilityId()
    return ('A0IA'<=d)and(d<='A0IG')
endfunction

function Trig_Yukari04_New_Effect_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u
    local unit v
    local real ox
    local real oy
    local real px
    local real py
    local real tx
    local real ty
    local real r = LoadReal(udg_ht,task,4)
    local real a
    local real d
    local integer c = LoadInteger(udg_ht,task,1)
    local integer i
    local integer j
    //========
    if GetUnitCurrentOrder(caster)==OrderId("massteleport") and c<300 then
        
        set r = r + 0.03*(900.0 - r)
        call SaveReal(udg_ht,task,4,r)
        call SaveInteger(udg_ht,task,1,c + 1)
        
        set d = r*0.85
        set ox = LoadReal(udg_ht,task,0)
        set oy = LoadReal(udg_ht,task,1)
        set i = 1
        loop
            set u = LoadUnitHandle(udg_ht,task,i)
            set a = 60.0*i + c*12.0
            set px = ox + d*CosBJ(a)
            set py = oy + d*SinBJ(a)
            call SetUnitX(u,px)
            call SetUnitY(u,py)
            set a = a - 135.0 + c/1.8
            set tx = px + 380.0*CosBJ(a)
            set ty = py + 380.0*SinBJ(a)
            call IssuePointOrder(u,"clusterrockets",tx,ty)
            set i = i + 1
            exitwhen i>6
        endloop
        
        set d = (r - 50.0)*0.5
        set ox = LoadReal(udg_ht,task,2)
        set oy = LoadReal(udg_ht,task,3)
        set i = 1
        loop
            set u = LoadUnitHandle(udg_ht,task,6 + i)
            set a = 60.0*i + c*12.0
            set px = ox + d*CosBJ(a)
            set py = oy + d*SinBJ(a)
            call SetUnitX(u,px)
            call SetUnitY(u,py)
            set a = a - 100.0
            set tx = px + 500.0*CosBJ(a)
            set ty = py + 500.0*SinBJ(a)
            call IssuePointOrder(u,"breathoffrost",tx,ty)
            set i = i + 1
            exitwhen i>6
        endloop
        
        set a = 1.0 + 0.5*r/100.0
        call SetUnitScale(LoadUnitHandle(udg_ht,task,13),a,a,a)
        
    else
        set i = 1
        loop
            call RemoveUnit(LoadUnitHandle(udg_ht,task,i))
            set i = i + 1
            exitwhen i>12
        endloop
        call RemoveUnit(LoadUnitHandle(udg_ht,task,13))
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
endfunction

function Trig_Yukari04_New_Effect_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real px
    local real py
    local real s
    local player w = GetOwningPlayer(caster)
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer i
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    set i = 1
    loop
        set u = CreateUnit(w,'n03N',ox,oy,60.0*i)
        call SetUnitScale(u,1.5,1.5,1.5)
        call SaveUnitHandle(udg_ht,task,i,u)
        set i = i + 1
        exitwhen i>6
    endloop
    set s = 1.8 + level*0.2
    loop
        set u = CreateUnit(w,'n03N',ox,oy,60.0*i)
        call SetUnitScale(u,s,s,s)
        call SetUnitAbilityLevel(u,'A0II',level)
        call SaveUnitHandle(udg_ht,task,i,u)
        set i = i + 1
        exitwhen i>12
    endloop
    set u = CreateUnit(GetOwningPlayer(caster),'n03M',tx,ty,270.0)
    call SetUnitVertexColor(u,255,255,255,160)
    call SaveUnitHandle(udg_ht,task,13,u)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,0)
    call SaveReal(udg_ht,task,0,ox)
    call SaveReal(udg_ht,task,1,oy)
    call SaveReal(udg_ht,task,2,tx)
    call SaveReal(udg_ht,task,3,ty)
    call SaveReal(udg_ht,task,4,100.0)
    call TimerStart(t,0.03,true,function Trig_Yukari04_New_Effect_Main)
    //========
    set caster = null
    set u = null
    set w = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Yukari04_New_Effect takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Yukari04 DS
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Yukari04_DS_Conditions takes nothing returns boolean
    return IsUnitAlive(GetPlayerCharacter(GetTriggerPlayer()))
endfunction

function Trig_Yukari04_DS_Actions takes nothing returns nothing
    local player who = GetTriggerPlayer()
    local unit h = GetPlayerCharacter(who)
    local real ox = GetUnitX(h)
    local real oy = GetUnitY(h)
    local real dx = GetCameraTargetPositionX() - ox
    local real dy = GetCameraTargetPositionY() - oy
    local real d = SquareRoot(dx*dx+dy*dy)
    local integer l = Trig_Yukari04_New_Distance(d)
    
    call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"距离：" + R2S(d) + "，深幕结界冷却时间：" + I2S(100 + 15*l) + "秒")
    call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"间隙中的单位数量：" + R2S(udg_SK_Yukari_Count))

    set who = null
    set h = null
endfunction

//===========================================================================
function InitTrig_Yukari04_DS takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initial Yukari
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Yukari_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E00F')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    if udg_SK_EyeBugModeOn == false then
        set udg_SK_EyeBugModeOn = true
        set gg_trg_YukariEyebug = CreateTrigger()
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint01 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint02 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint03 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint04 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint05 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint06 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint07 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint08 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint09 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint10 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint11 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint12 )
        call TriggerAddCondition( gg_trg_YukariEyebug, Condition( function Trig_YukariEyebug_Conditions ) )
        call TriggerAddAction( gg_trg_YukariEyebug, function Trig_YukariEyebug_Actions )
    endif
    
    set udg_SK_Yukari_Count = 0
    set gg_trg_Yukari02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yukari02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yukari02, Condition( function Trig_Yukari02_Conditions ) )
    call TriggerAddAction( gg_trg_Yukari02, function Trig_Yukari02_Actions )
    
    set gg_trg_Yukari02_Gap_Dump = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yukari02_Gap_Dump, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yukari02_Gap_Dump, Condition( function Trig_Yukari02_Gap_Dump_Conditions ) )
    call TriggerAddAction( gg_trg_Yukari02_Gap_Dump, function Trig_Yukari02_Gap_Dump_Actions )
    
    set gg_trg_Yukari02_Mega_Dump = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yukari02_Mega_Dump, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yukari02_Mega_Dump, Condition( function Trig_Yukari02_Mega_Dump_Conditions ) )
    call TriggerAddAction( gg_trg_Yukari02_Mega_Dump, function Trig_Yukari02_Mega_Dump_Actions )
    
    call SetPlayerAbilityAvailable(GetOwningPlayer(h),'A0I8',false)

    set gg_trg_Yukari03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yukari03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yukari03, Condition( function Trig_Yukari03_Conditions ) )
    call TriggerAddAction( gg_trg_Yukari03, function Trig_Yukari03_Actions )
    
    set gg_trg_Yukari04_New = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yukari04_New, h, EVENT_UNIT_SPELL_CAST )
    call TriggerRegisterUnitEvent( gg_trg_Yukari04_New, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yukari04_New, Condition( function Trig_Yukari04_New_Conditions ) )
    call TriggerAddAction( gg_trg_Yukari04_New, function Trig_Yukari04_New_Actions )
    
    set gg_trg_Yukari04_New_Effect = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yukari04_New_Effect, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yukari04_New_Effect, Condition( function Trig_Yukari04_New_Effect_Conditions ) )
    call TriggerAddAction( gg_trg_Yukari04_New_Effect, function Trig_Yukari04_New_Effect_Actions )
    
    set gg_trg_Yukari04_DS = CreateTrigger()
    call TriggerRegisterPlayerEvent( gg_trg_Yukari04_DS, GetOwningPlayer(h), EVENT_PLAYER_END_CINEMATIC)
    call TriggerAddCondition( gg_trg_Yukari04_DS, Condition( function Trig_Yukari04_DS_Conditions ) )
    call TriggerAddAction( gg_trg_Yukari04_DS, function Trig_Yukari04_DS_Actions )
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Yukari takes nothing returns nothing
    set gg_trg_Initial_Yukari = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Yukari, function Trig_Initial_Yukari_Actions )
endfunction

//===========================================================================
// Trigger: IkuTime
//===========================================================================
function Trig_IkuTime_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetHeroLevel(caster)
    call SetUnitAbilityLevel(caster,'A0OY',level)
    call addlife(caster,10)
    set caster = null
endfunction

//===========================================================================
function InitTrig_IkuTime takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Iku01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Iku01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A04O'
endfunction

function Trig_Iku01_Check takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,0)
    //========
    if GetUnitAbilityLevel(caster,'B01T')==0 or IsUnitMorphed(caster) then
        call UnitRemoveAbility(caster,'B00S')
        call UnitRemoveAbility(caster,'B01T')
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
endfunction

function Trig_Iku01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local integer level = GetUnitAbilityLevel(caster,'A04O')
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    //永琳加速药取消
    if GetUnitAbilityLevel(caster,'B00A')>0 then
        call UnitRemoveAbility(caster,'B00A')
    endif
    //========
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),GetUnitX(caster),GetUnitY(caster),0)
    call UnitAddAbility(u,'A04P')
    call SetUnitAbilityLevel(u,'A04P',level)
    call IssueTargetOrder(u,"bloodlust",caster)
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,0,level)
    call TimerStart(t,0.1,true,function Trig_Iku01_Check)
    //========
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Iku01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Iku02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Iku02_Target takes unit target returns boolean
    if IsUnitDeadBJ(target) then
        return false
    endif
    if IsUnitType(target,UNIT_TYPE_STRUCTURE) then
        return false
    endif
    return true
endfunction

function Trig_Iku02_Repel_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local real ox = GetUnitX(target)
    local real oy = GetUnitY(target)
    local real px
    local real py
    local real a = LoadReal(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i>0 then
        call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\SteamMissile\\SteamMissile.mdl",ox,oy))
        set px = ox + 30.0*CosBJ(a)
        set py = oy + 30.0*SinBJ(a)
        if IsTerrainPathable(px,py,PATHING_TYPE_WALKABILITY) then
            call SaveInteger(udg_ht,task,1,0)
        else
            call SetUnitXY(target,px,py)
            call SaveInteger(udg_ht,task,1,i - 1)
        endif
    else
        call SetUnitPathing(target,true)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set target = null
endfunction

function Trig_Iku02_Repel takes unit caster,unit target returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local real a = AngleBetweenUnits(caster,target)
    local unit u = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(caster),GetUnitY(caster),a)
    call UnitAddAbility(u,'A0A3')
    call SetUnitAbilityLevel(u,'A0A3',GetUnitAbilityLevel(caster,'A04S'))
    call IssueTargetOrder(u,"chainlightning",target)
    call SaveInteger(udg_ht,task,1,10)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveReal(udg_ht,task,0,a)
    call TimerStart(t,0.02,true,function Trig_Iku02_Repel_Main)
    set t = null
    set u = null
endfunction

function Trig_Iku02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit v
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer i = LoadInteger(udg_ht,task,1)
    local group g
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    //========
    if i>0 and IsUnitAlive(caster) then
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,ox,oy,250.0,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if Trig_Iku02_Target(v) and IsUnitInRange(v,caster,200.0) and GetUnitAbilityLevel(GetTriggerUnit(),'B04B') == 0 and GetUnitAbilityLevel(GetTriggerUnit(),'BOvc') == 0 then
                call Trig_Iku02_Repel(caster,v)
            endif
        endloop
        call DestroyGroup(g)
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call DestroyEffect(LoadEffectHandle(udg_ht,task,1))
        call UnitRemoveAbility(caster,'A04T')
        call UnitRemoveAbility(caster,'A09Z')
        call SetUnitMoveSpeed(caster,GetUnitDefaultMoveSpeed(caster))
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set v = null
    set g = null
    set iff = null
endfunction

function Trig_Iku02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A04S'
endfunction

function Trig_Iku02_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A04S')
    local effect e = AddSpecialEffectTarget("GlowingRunes2.mdl",caster,"origin")
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 15
    local real abilitycooldownlv03 = 15
    local real abilitycooldownlv04 = 15
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    
    call UnitAddAbility(caster,'A09Z')
    call UnitAddAbility(caster,'A04T')
    call SetUnitAbilityLevel(caster,'A09Z',level)
    call SetUnitAbilityLevel(caster,'A04T',level)
    call SetUnitMoveSpeed(caster,220.0)
    
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveEffectHandle(udg_ht,task,1,e)
    call SaveInteger(udg_ht,task,1,8)
    call TimerStart(t,0.5,true,function Trig_Iku02_Main)
    
    set t = null
    set caster = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Iku02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Iku03 Active
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Iku03_Active_Conditions takes nothing returns boolean
    if GetUnitTypeId(GetEventDamageSource())!='U003' then
        return false
    endif
    if GetUnitAbilityLevel(GetTriggerUnit(),'B02Q')==0 then
        return false
    endif
    call UnitRemoveAbility(GetTriggerUnit(),'B02Q')
    return true
endfunction

function Trig_Iku03_Active_Actions takes nothing returns nothing
    local unit caster = GetEventDamageSource()
    local unit target = GetTriggerUnit()
    local unit u
    local integer rate
    local integer dice = GetRandomInt(0,100)
    local integer level = GetUnitAbilityLevel(caster,'A05M')
    if GetUnitAbilityLevel(target,'B027')>0 then
        set rate = 100
    else
        set rate = 8 + 2*level
    endif
    //call DebugMsg("Iku03: 0~100掷出的数值："+R2S(dice)+"，需要的小于的数值："+R2S(rate))
    if dice <= rate then
        //call DebugMsg("Iku03 CD")
        //call DisableTrigger(gg_trg_Iku03_Active)
        set u = CreateUnit(GetOwningPlayer(caster),'n00E',GetUnitX(caster),GetUnitY(caster),0)
        call UnitAddAbility(u,'A04R')
        call SetUnitAbilityLevel(u,'A04R',level)
        call IssueTargetOrder(u,"chainlightning",target)
        //call TriggerSleepAction(1.9)
        //call EnableTrigger(gg_trg_Iku03_Active)
        //call DebugMsg("Iku03 CD END")
    endif
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Iku03_Active takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Iku03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Iku03_Conditions takes nothing returns boolean
    if GetUnitTypeId(GetEventDamageSource())!='n00E' then
        return false
    endif
    if GetUnitFlag(GetTriggerUnit(),CS_LOST()) then
        return false
    endif
    if GetUnitFlag(GetTriggerUnit(),CS_DASHING()) then
        return false
    endif
    return IsMobileUnit(GetTriggerUnit())
endfunction

function Trig_Iku03_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local real ox = GetUnitX(target)
    local real oy = GetUnitY(target)
    local real px = LoadReal(udg_ht,task,0) - ox
    local real py = LoadReal(udg_ht,task,1) - oy
    local real a = Atan2(py,px)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i<20 then
        set px = ox + 20.0*Cos(a)
        set py = oy + 20.0*Sin(a)
        if IsTerrainPathable(px,py,PATHING_TYPE_FLYABILITY) or IsUnitInRange(caster,target,60.0) then
            call SaveInteger(udg_ht,task,1,20)
        else
            call SetUnitX(target,px)
            call SetUnitY(target,py)
            call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\SteamMissile\\SteamMissile.mdl",px,py))
            call SaveInteger(udg_ht,task,1,i + 1)
        endif
    else
        call SetUnitPathing(target,true)
        call SetUnitFlag(target,CS_DRAG(),false)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set target = null
endfunction

function Trig_Iku03_Actions takes nothing returns nothing
    local unit caster = GetEventDamageSource()
    local unit target = GetTriggerUnit()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    
    call SetUnitPathing(target,false)
    call SetUnitFlag(target,CS_DRAG(),true)
    
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveInteger(udg_ht,task,1,0)
    call SaveReal(udg_ht,task,0,GetUnitX(caster))
    call SaveReal(udg_ht,task,1,GetUnitY(caster))
    call TimerStart(t,0.04,true,function Trig_Iku03_Main)
    
    set t = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Iku03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Iku04
//===========================================================================
function Trig_Iku04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0A4'
endfunction

function Trig_Iku04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local unit v
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real dx = GetSpellTargetX() - ox
    local real dy = GetSpellTargetY() - oy
    local real px
    local real py
    local real a = Atan2(dy,dx)
    local real d
    local real e
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local real damage = 200.0 + level*75.0
    local group g
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    //========
    local real abilitycooldownlv01 = 100
    local real abilitycooldownlv02 = 90
    local real abilitycooldownlv03 = 80
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========    

    //========
    
    set px = ox + 550.0*Cos(a)
    set py = oy + 550.0*Sin(a)
    set u = CreateUnit(GetOwningPlayer(caster),'n01Z',px,py,bj_RADTODEG*a)
    call SetUnitScale(u,5.0,5.0,5.0)
    call SetUnitTimeScale(u,3.0)
    call UnitApplyTimedLife(u,'BTLF',0.1)
    call PlaySoundOnUnitBJ(gg_snd_LightningShieldTarget,100,u)
    
    set px = ox + 630.0*Cos(a)
    set py = oy + 630.0*Sin(a)
    set u = CreateUnit(GetOwningPlayer(caster),'n01Z',px,py,bj_RADTODEG*a)
    call SetUnitScale(u,3.5,3.5,3.5)
    call SetUnitTimeScale(u,3.0)
    call UnitApplyTimedLife(u,'BTLF',0.1)
    
    set px = ox + 700.0*Cos(a)
    set py = oy + 700.0*Sin(a)
    set u = CreateUnit(GetOwningPlayer(caster),'n01Z',px,py,bj_RADTODEG*a)
    call SetUnitScale(u,2.5,2.5,2.5)
    call SetUnitTimeScale(u,3.0)
    call UnitApplyTimedLife(u,'BTLF',0.1)
    
    //========
    
    set px = ox + 750.0*Cos(a)
    set py = oy + 750.0*Sin(a)
    
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),px,py,0)
    call UnitAddAbility(u,'A0B6')
    call SetUnitAbilityLevel(u,'A0B6',level)
    
    set a = bj_RADTODEG*a + 180.0
    if a>=360.0 then
        set a = a - 360.0
    endif
    
    set g = CreateGroup()
    call GroupEnumUnitsInRange(g,px,py,800.0,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitDead(v)==false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and IsUnitWard(v)==false then
            set dx = GetUnitX(v) - px
            set dy = GetUnitY(v) - py
            set d = SquareRoot(dx*dx + dy*dy)
            set e = RAbsBJ(YawError(a,bj_RADTODEG*Atan2(dy,dx)))
            if e<=(15.0 + 0.03*(800.0 - d)) then
                call IssueTargetOrder(u,"purge",v)
                call UnitDamageTarget(caster,v,damage,false,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,null)
            endif
        endif
    endloop
    call DestroyGroup(g)
    
    call RemoveUnit(u)
    
    //========
    
    set caster = null
    set u = null
    set v = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_Iku04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Iku
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Iku_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('U003')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    call addlife(h,10)

    set gg_trg_IkuTime = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_IkuTime, h, EVENT_UNIT_HERO_LEVEL )
    call TriggerAddAction( gg_trg_IkuTime, function Trig_IkuTime_Actions )

    set gg_trg_Iku01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Iku01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Iku01, Condition( function Trig_Iku01_Conditions ) )
    call TriggerAddAction( gg_trg_Iku01, function Trig_Iku01_Actions )
    
    set gg_trg_Iku02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Iku02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Iku02, Condition( function Trig_Iku02_Conditions ) )
    call TriggerAddAction( gg_trg_Iku02, function Trig_Iku02_Actions )
    
    set gg_trg_Iku03_Active = CreateTrigger()
    call RegisterAnyUnitDamage( gg_trg_Iku03_Active )
    call TriggerAddCondition( gg_trg_Iku03_Active, Condition( function Trig_Iku03_Active_Conditions ) )
    call TriggerAddAction( gg_trg_Iku03_Active, function Trig_Iku03_Active_Actions )
    
    set gg_trg_Iku03 = CreateTrigger()
    call RegisterAnyUnitDamage( gg_trg_Iku03 )
    call TriggerAddCondition( gg_trg_Iku03, Condition( function Trig_Iku03_Conditions ) )
    call TriggerAddAction( gg_trg_Iku03, function Trig_Iku03_Actions )
    
    set gg_trg_Iku04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Iku04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Iku04, Condition( function Trig_Iku04_Conditions ) )
    call TriggerAddAction( gg_trg_Iku04, function Trig_Iku04_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Iku takes nothing returns nothing
    set gg_trg_Initial_Iku = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Iku, function Trig_Initial_Iku_Actions )
endfunction
//===========================================================================
// Trigger: Mokou01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Mokou01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A04U'
endfunction

function Trig_Mokou01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px 
    local real py 
    local real a = LoadReal(udg_ht,task,0)
    local real d
    local integer level
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i>0 then
        
        set px = ox + 30.0*Cos(a)
        set py = oy + 30.0*Sin(a)
        if IsTerrainPathable(px,py,PATHING_TYPE_FLYABILITY)==false then
            call SetUnitX(u,px)
            call SetUnitY(u,py)
            call SetUnitX(caster,px)
            call SetUnitY(caster,py)
            call SaveInteger(udg_ht,task,1,i - 1)
        else
            call SaveInteger(udg_ht,task,1,0)
        endif
        
    else
        
        call KillUnit(u)
        call SetUnitFlag(caster,CS_DASHING(),false)
        call SetUnitPathing(caster,true)
        call SetUnitVertexColor(caster,255,255,255,255)
        call SetUnitInvulnerable(caster,false)
        
        set level = LoadInteger(udg_ht,task,0)
        call UnitDamageTarget(caster,caster,(100.0 + 100.0*level)*1.25,false,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,null)
        set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,270.0)
        call UnitAddAbility(u,'A04V')
        call SetUnitAbilityLevel(u,'A04V',level)
        call IssueImmediateOrder(u,"thunderclap")
        
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        
        set u = CreateUnit(GetOwningPlayer(caster),'u009',ox,oy,a)
        call UnitApplyTimedLife(u,'BTLF',0.01)
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Incinerate\\FireLordDeathExplode.mdl",ox,oy))
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Volcano\\VolcanoDeath.mdl",ox,oy))
        set i = 0
        loop
            set a = bj_DEGTORAD*36.0*i
            set d = 20.0
            loop
                set d = d + 100.0
                set px = ox + d*Cos(a)
                set py = oy + d*Sin(a)
                call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Incinerate\\FireLordDeathExplode.mdl",px,py))
                call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Volcano\\VolcanoDeath.mdl",px,py))
                exitwhen d>300.0
            endloop
            set i = i + 1
            exitwhen i>=10
        endloop
        
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Mokou01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real dx = GetSpellTargetX() - ox
    local real dy = GetSpellTargetY() - oy
    local real a = Atan2(dy,dx)
    local real d = SquareRoot(dy*dy+dx*dx)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 13
    local real abilitycooldownlv02 = 15
    local real abilitycooldownlv03 = 17
    local real abilitycooldownlv04 = 19
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set u = CreateUnit(GetOwningPlayer(caster),'u00A',ox,oy,bj_RADTODEG*a)
    call SetUnitFlag(caster,CS_DASHING(),true)
    call SetUnitPathing(caster,false)
    call SetUnitVertexColor(caster,255,255,255,0)
    call SetUnitInvulnerable(caster,true)
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,R2I((d/30.0)+0.5))
    call SaveReal(udg_ht,task,0,a)
    call SaveReal(udg_ht,task,1,d)
    call TimerStart(t,0.02,true,function Trig_Mokou01_Main)
    //========
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Mokou01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Mokou02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Mokou02_Conditions takes nothing returns boolean
    if GetTriggerEventId()==EVENT_UNIT_DEATH then
        call SaveInteger(udg_sht,GetHandleId(GetTriggerUnit()),0,0)
        call UnitRemoveAbility(GetTriggerUnit(),udg_SK_Mokou02[0])
        call UnitRemoveAbility(GetTriggerUnit(),udg_SK_Mokou02[1])
        call UnitRemoveAbility(GetTriggerUnit(),udg_SK_Mokou02[2])
        call UnitRemoveAbility(GetTriggerUnit(),udg_SK_Mokou02[3])
        call UnitRemoveAbility(GetTriggerUnit(),udg_SK_Mokou02[4])
        return false
    endif
    if GetUnitTypeId(GetAttacker())!='N00J' then
        return false
    endif
    if IsUnitIllusion(GetAttacker()) then
        return false
    endif
    if GetUnitAbilityLevel(GetAttacker(),'A04W')==0 then
        return false
    endif
    return true
endfunction

function Mokou02_Resolve takes unit u,integer x returns nothing
    local integer i = 5
    loop
        exitwhen i==0
        set i = i - 1
        call UnitRemoveAbility(u,udg_SK_Mokou02[i])
        if GetBitBoolean(x,i) then
            call UnitAddAbility(u,udg_SK_Mokou02[i])
        endif
    endloop
endfunction

function Trig_Mokou02_Fade takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer x
    set task = GetHandleId(caster)
    set x = LoadInteger(udg_sht,task,0)
    if x>0 then
        set x = IMaxBJ(0,x - 4)
        call SaveInteger(udg_sht,task,0,x)
        call Mokou02_Resolve(caster,x)
        call DisplayTextToPlayer(GetOwningPlayer(caster),0,0,I2S(x*5)+"%")
    else
        call PauseTimer(t)
    endif
    set t = null
    set caster = null
endfunction

function Trig_Mokou02_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local integer task = GetHandleId(caster)
    local integer x = LoadInteger(udg_sht,task,0)
    local timer t = LoadTimerHandle(udg_sht,task,0)
    local unit u = LoadUnitHandle(udg_sht,task,1)
    call DisableTrigger(GetTriggeringTrigger())
    //========
    if target != u then
        set x = x/2
        call Mokou02_Resolve(caster,x)
        call SaveInteger(udg_sht,task,0,x)
        call SaveUnitHandle(udg_sht,task,1,target)
    else
        set x = IMinBJ(x+GetUnitAbilityLevel(caster,'A04W'),20)
        call Mokou02_Resolve(caster,x)
        call SaveInteger(udg_sht,task,0,x)
    endif
    call DisplayTextToPlayer(GetOwningPlayer(caster),0,0,I2S(x*5)+"%")
    call TimerStart(t,3.0,true,function Trig_Mokou02_Fade)
    //========
    set caster = null
    set target = null
    set u = null
    set t = null
    call TriggerSleepAction( 0.30 )
    call EnableTrigger(GetTriggeringTrigger())
endfunction

//===========================================================================

function Trig_Mokou02_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A04W'
endfunction

function Trig_Mokou02_Learn_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t
    
    call DestroyTrigger(gg_trg_Mokou02)
    
    set gg_trg_Mokou02 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Mokou02, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerRegisterUnitEvent( gg_trg_Mokou02, caster, EVENT_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_Mokou02, Condition( function Trig_Mokou02_Conditions ) )
    call TriggerAddAction( gg_trg_Mokou02, function Trig_Mokou02_Actions )
    
    set t = CreateTimer()
    call SaveUnitHandle(udg_ht,GetHandleId(t),0,caster)
    call SaveTimerHandle(udg_sht,GetHandleId(caster),0,t)
    call TimerStart(t,3.0,true,function Trig_Mokou02_Fade)
    
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Mokou02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Mokou03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Mokou03_Conditions takes nothing returns boolean
    local integer task
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_DEATH then
        if GetUnitTypeId(GetTriggerUnit())=='h00O' and GetKillingUnit()!=null then
            set task = GetHandleId(GetTriggerUnit())
            call SaveUnitHandle(udg_ht,task,0,GetKillingUnit())
        endif
        return false
    endif
    return GetSpellAbilityId()=='A052'
endfunction

function Trig_Mokou03_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i>0 then
        if IsUnitAlive(u) then
            call SaveInteger(udg_ht,task,1,i - 1)
        else
            call SaveInteger(udg_ht,task,1,-1)
            call ShowUnit(caster,true)
            call PauseUnit(caster,false)
            call SetUnitInvulnerable(caster,false)
            set u = LoadUnitHandle(udg_ht,GetHandleId(u),0)
            if u==null then
                call UnitRemoveBuffs(caster,true,true)
                call KillUnit(caster)
            else
                call UnitRemoveBuffs(caster,true,true)
                call InstantKill(u,caster)
            endif
            call FlushChildHashtable(udg_ht,GetHandleId(u))
        endif
    else
        if i>=0 then
            call ShowUnit(caster,true)
            call PauseUnit(caster,false)
            call SetUnitInvulnerable(caster,false)
            if IsUnitDead(caster) then
                call ReviveHero(caster,GetUnitX(u),GetUnitY(u),false)
            endif
            call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_MAX_LIFE))
            call SelectUnitForPlayerSingle(caster,GetOwningPlayer(caster))
            call KillUnit(u)
        endif
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set caster = null
    set u = null
endfunction

function Trig_Mokou03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real period
    local integer c
    local integer level = GetUnitAbilityLevel(caster,'A052')
    local timer t
    local integer task
    //========
    local real abilitycooldownlv01 = 70
    local real abilitycooldownlv02 = 40
    local real abilitycooldownlv03 = 20
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    
    call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl",GetUnitX(caster),GetUnitY(caster)))
    call PauseUnit(caster,true)
    call ShowUnit(caster,false)
    call SetUnitInvulnerable(caster,true)
    call UnitRemoveAbility(caster,'Bvul')
    call UnitRemoveAbility(caster,'A053')
    call UnitRemoveAbility(caster,'A054')
    call UnitRemoveAbility(caster,'A055')
    call UnitRemoveAbility(caster,'A056')
    call UnitRemoveAbility(caster,'A057')
    call UnitRemoveAbility(caster,'A058')
    call UnitRemoveAbility(caster,'B00U')
    call UnitRemoveAbility(caster,'B00V')
    call UnitRemoveAbility(caster,'B00W')
    call UnitRemoveAbility(caster,'B00X')
    
    if level == 1 then
        set period = 7.0
    elseif level == 2 then
        set period = 6.0
    elseif level == 3 then
        set period = 5.0
    else
        set period = 4.0
    endif
    
    set u = CreateUnit(GetOwningPlayer(caster),'h00O',GetUnitX(caster),GetUnitY(caster),270.0)
    call SelectUnitForPlayerSingle(u,GetOwningPlayer(caster))
    call SetUnitAnimation(u,"stand alternate")
    call UnitApplyTimedLife(u,'Bphx',period + 0.1)
    
    set t = CreateTimer()
    set task = GetHandleId(t)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,1,R2I(period/0.02))
    call TimerStart(t,0.02,true,function Trig_Mokou03_Main)
    
    //========
    set caster = null
    set t = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Mokou03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Mokou04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Mokou04_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A059'
endfunction

function Trig_Mokou04_Finish takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = LoadInteger(udg_ht,task,0)
    //========
    //正常持续完毕后的燃烧伤害
    if GetUnitAbilityLevel(caster,'A053')>0 then
        call UnitRemoveAbility(caster,'A055')
        call UnitAddAbility(caster,'A056' + level - 1)
    endif
    call DisableTrigger(gg_trg_Mokou04_AOE)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    //========
    set t = null
    set caster = null
endfunction

function Trig_Mokou04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A059')
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 95
    local real abilitycooldownlv02 = 95
    local real abilitycooldownlv03 = 95
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_LIFE)*0.80)
    call UnitRemoveAbility(caster,'A053')
    call UnitRemoveAbility(caster,'A054')
    call UnitRemoveAbility(caster,'A055')
    call UnitRemoveAbility(caster,'A056')
    call UnitRemoveAbility(caster,'A057')
    call UnitRemoveAbility(caster,'A058')
    call UnitRemoveAbility(caster,'B00U')
    call UnitRemoveAbility(caster,'B00V')
    call UnitRemoveAbility(caster,'B00W')
    call UnitRemoveAbility(caster,'B00X')
    //========
    call UnitAddAbility(caster,'A055')
    call SetPlayerAbilityAvailableBJ(false,'A055',GetOwningPlayer(caster))
    call SetUnitAbilityLevel(caster,'A053',level)//攻击力
    call SetUnitAbilityLevel(caster,'A054',level)//生命恢复
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,0,level)
    call EnableTrigger(gg_trg_Mokou04_AOE)
    call TimerStart(t,20.0,false,function Trig_Mokou04_Finish)
    //========
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Mokou04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Mokou04 End
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Mokou04_End_Conditions takes nothing returns boolean
    return true
endfunction

function Trig_Mokou04_End_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    call UnitRemoveAbility(caster,'A053')
    call UnitRemoveAbility(caster,'A054')
    call UnitRemoveAbility(caster,'A055')
    call UnitRemoveAbility(caster,'A056')
    call UnitRemoveAbility(caster,'A057')
    call UnitRemoveAbility(caster,'A058')
    call UnitRemoveAbility(caster,'B00U')
    call UnitRemoveAbility(caster,'B00V')
    call UnitRemoveAbility(caster,'B00W')
    call UnitRemoveAbility(caster,'B00X')
    set caster = null
endfunction

//===========================================================================
function InitTrig_Mokou04_End takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Mokou04 AOE
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Mokou04_AOE_Conditions takes nothing returns boolean
    if GetUnitTypeId(GetAttacker())!='N00J' then
        return false
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if GetUnitAbilityLevel(GetAttacker(),'A053')==0 then
        return false
    endif
    return GetRandomInt(0,100) < 18
endfunction

function Trig_Mokou04_AOE_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local real x = GetUnitX(target)
    local real y = GetUnitY(target)
    local unit u = CreateUnit(GetOwningPlayer(caster),'n001',x,y,0.0)
    call UnitAddAbility(u,'A05A')
    call SetUnitAbilityLevel(u,'A05A',GetUnitAbilityLevel(caster,'A059'))
    call IssueImmediateOrder(u,"fanofknives")
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Mokou04_AOE takes nothing returns nothing
    set gg_trg_Mokou04_AOE = CreateTrigger()
    call TriggerAddAction( gg_trg_Mokou04_AOE, function Trig_Mokou04_AOE_Actions )
endfunction

//===========================================================================
// Trigger: Initial Mokou
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Mokou_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('N00J')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_Mokou01 = CreateTrigger()
    call TriggerRegisterUnitEvent(gg_trg_Mokou01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition(gg_trg_Mokou01, Condition( function Trig_Mokou01_Conditions ) )
    call TriggerAddAction(gg_trg_Mokou01, function Trig_Mokou01_Actions )
    
    set udg_SK_Mokou02[0] = 'A04X'
    set udg_SK_Mokou02[1] = 'A04Y'
    set udg_SK_Mokou02[2] = 'A04Z'
    set udg_SK_Mokou02[3] = 'A050'
    set udg_SK_Mokou02[4] = 'A051'
    
    set gg_trg_Mokou02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Mokou02, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Mokou02, Condition( function Trig_Mokou02_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Mokou02, function Trig_Mokou02_Learn_Actions )
    
    set gg_trg_Mokou03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Mokou03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerRegisterPlayerUnitEvent( gg_trg_Mokou03, GetOwningPlayer(h), EVENT_PLAYER_UNIT_DEATH, null )
    call TriggerAddCondition( gg_trg_Mokou03, Condition( function Trig_Mokou03_Conditions ) )
    call TriggerAddAction( gg_trg_Mokou03, function Trig_Mokou03_Actions )

    set gg_trg_Mokou04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Mokou04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Mokou04, Condition( function Trig_Mokou04_Conditions ) )
    call TriggerAddAction( gg_trg_Mokou04, function Trig_Mokou04_Actions )
    
    set gg_trg_Mokou04_AOE = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Mokou04_AOE, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Mokou04_AOE, Condition( function Trig_Mokou04_AOE_Conditions ) )
    call TriggerAddAction( gg_trg_Mokou04_AOE, function Trig_Mokou04_AOE_Actions )
    call DisableTrigger(gg_trg_Mokou04_AOE)
    
    set gg_trg_Mokou04_End = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Mokou04_End, h, EVENT_UNIT_DEATH )
    call TriggerRegisterUnitEvent( gg_trg_Mokou04_End, h, EVENT_UNIT_HERO_REVIVE_FINISH )
    call TriggerAddCondition( gg_trg_Mokou04_End, Condition( function Trig_Mokou04_End_Conditions ) )
    call TriggerAddAction( gg_trg_Mokou04_End, function Trig_Mokou04_End_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Mokou takes nothing returns nothing
    set gg_trg_Initial_Mokou = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Mokou, function Trig_Initial_Mokou_Actions )
endfunction
//===========================================================================
// Trigger: Yuyuko Rekill
//===========================================================================
function Trig_Yuyuko_Rekill_Conditions takes nothing returns boolean
    if GetUnitAbilityLevel(GetTriggerUnit(),'B00B')>0 then
        return false
    endif
    if GetUnitAbilityLevel(GetTriggerUnit(),'A0MM')==0 then
        return false
    endif
    if udg_SK_uuzre_switch == 1 then
        return false
    endif
    if GetEventDamage()>GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE)-5.0 then
        set udg_SK_uuzre_switch = 1
        call TSU_SetUnitInvulnerable(GetTriggerUnit(),0.01)
        call UnitAddAbility(GetTriggerUnit(),'A0MQ')
        call UnitAddAbility(GetTriggerUnit(),'A0MR')
        call UnitAddAbility(GetTriggerUnit(),'A0MS')
        return true
    endif
    if GetUnitAbilityLevel(GetTriggerUnit(),'B006') > 0 and GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE) <= 5.0 then
        set udg_SK_uuzre_switch = 1
        call TSU_SetUnitInvulnerable(GetTriggerUnit(),0.01)
        call UnitAddAbility(GetTriggerUnit(),'A0MQ')
        call UnitAddAbility(GetTriggerUnit(),'A0MR')
        call UnitAddAbility(GetTriggerUnit(),'A0MS')
        return true
    endif
    return false    
endfunction

function Trig_Yuyuko_Rekill_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local real ox = LoadReal(udg_ht,task,2)
    local real oy = LoadReal(udg_ht,task,3)
    local unit illusion = LoadUnitHandle(udg_ht,task,4)
    local player ply = LoadPlayerHandle(udg_ht,task,5)
    local unit u
    local integer j
    local real a
    local unit v
    local integer level = GetUnitAbilityLevel(caster,'A0MM')

    //Carrionswarm
    set u = caster
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",u,"origin"))
    set u = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,0)
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,0.0)
    call SetUnitScale(u,2.0,2.0,2.0)
    call UnitAddAbility(u,'A05G' + GetRandomInt(0,3))
    set j = 1
    loop
        set a = j*12.0
        call IssuePointOrder(u,"carrionswarm",ox+100*CosBJ(a),oy+100*SinBJ(a))
        set j = j + 1
        exitwhen j > 30
    endloop

    //Killing
    call RemoveUnit(illusion)
    call SetUnitVertexColor(caster,255,255,255,255)
    call UnitRemoveAbility(caster,'A0MQ')
    call UnitRemoveAbility(caster,'A0MR')
    call UnitRemoveAbility(caster,'A0MS')
    call SetUnitInvulnerable(caster,false)
    call UnitRemoveBuffs(caster, true, true)
    call SetUnitXY(caster,ox,oy)
    set v = CreateUnit(ply,'n001',ox,oy,0)
    call InstantKill(v,caster)
    //Debuff
    if GetUnitState(caster,UNIT_STATE_LIFE) > 0 then
        call SetUnitLifePercentBJ(caster,1.00)
        call KillUnit(caster)
    endif

    set udg_SK_uuzre_switch = 0

    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)

    set t = null
    set caster = null
    set illusion = null
    set u = null
    set v = null
    set ply = null
endfunction

function Trig_Yuyuko_Rekill_Movement takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit illusion = LoadUnitHandle(udg_ht,task,1)
    local integer level = LoadInteger(udg_ht,task,2)
    local integer v = LoadInteger(udg_ht,task,3)
    local real ox = GetUnitX(illusion)
    local real oy = GetUnitY(illusion)
    local real kx = GetUnitX(caster)
    local real ky = GetUnitY(caster)
    local real d = SquareRoot((ox-kx)*(ox-kx) + (oy-ky)*(oy-ky))
    local real a = Atan2(ky-oy,kx-ox)
    if IsUnitType(caster,UNIT_TYPE_DEAD) or v >= 125 then
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    else
        set v = v + 1
        call SetUnitVertexColor(caster,255,255,255,170-v*3/4)
        if d > 100 + 100 * level then
            call SetUnitXY(caster,ox+(100+100*level-10)*Cos(a),oy+(100+100*level-10)*Sin(a))
            call IssueImmediateOrder(caster,"stop")
        endif
        call SaveInteger(udg_ht,task,3,v)
    endif
    set t = null
    set caster = null
    set illusion = null
endfunction

function Trig_Yuyuko_Rekill_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local timer t2 = CreateTimer()
    local integer task2 = GetHandleId(t2)
    local unit caster = GetTriggerUnit()
    local unit killer = GetEventDamageSource()
    local unit illusion
    local player ply = GetOwningPlayer(killer)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local unit u
    local integer j
    local real a
    local integer level = GetUnitAbilityLevel(caster,'A0MM')

    //Carrionswarm
    set u = caster
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",u,"origin"))
    set u = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,0)
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,0)
    call SetUnitScale(u,2.0,2.0,2.0)
    call UnitAddAbility(u,'A05G' + GetRandomInt(0,3))
    set j = 1
    loop
        set a = j*12.0
        call IssuePointOrder(u,"carrionswarm",ox+100*CosBJ(a),oy+100*SinBJ(a))
        set j = j + 1
        exitwhen j > 30
    endloop
    call CreateUnit(GetOwningPlayer(caster),'n01J',GetUnitX(caster),GetUnitY(caster),270.0)

    //Setting Start
    set illusion = CreateUnit(GetOwningPlayer(caster),'n02N',ox,oy,0)
    call UnitRemoveBuffs(caster,true,true)
    call SetUnitLifePercentBJ(caster,100.00)
    call IssueImmediateOrder(caster,"stop")
    call SetUnitVertexColor(caster,255,255,255,170)

    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveReal(udg_ht,task,2,ox)
    call SaveReal(udg_ht,task,3,oy)
    call SaveUnitHandle(udg_ht,task,4,illusion)
    call SavePlayerHandle(udg_ht,task,5,ply)
    call TimerStart(t,2.5 + level*2.5,false,function Trig_Yuyuko_Rekill_Clear)
    //Reminder: Time Value should be changed also in HeroEvent

    call SaveUnitHandle(udg_ht,task2,0,caster)
    call SaveUnitHandle(udg_ht,task2,1,illusion)
    call SaveInteger(udg_ht,task2,2,level)
    call SaveInteger(udg_ht,task2,3,0)
    call TimerStart(t2,0.1,true,function Trig_Yuyuko_Rekill_Movement)

    //Special Killer - Nue
    if GetOwningPlayer(killer) == udg_SK_nue_rscd_player and udg_SK_nue_rscd_player != null then
        call NueResetCD(GetPlayerCharacter(GetOwningPlayer(killer)),caster)
    endif

    set t = null
    set caster = null
    set killer = null
    set illusion = null
    set u = null
    set ply = null
endfunction

//===========================================================================
function InitTrig_Yuyuko_Rekill takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yuyuko01
//===========================================================================
function Trig_Yuyuko01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A05D'
endfunction

function Trig_Yuyuko01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    //========
    local real abilitycooldownlv01 = 7
    local real abilitycooldownlv02 = 7
    local real abilitycooldownlv03 = 7
    local real abilitycooldownlv04 = 7
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set caster = null
endfunction

//===========================================================================
function InitTrig_Yuyuko01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yuyuko02
//===========================================================================
function Trig_Yuyuko02_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0QM'
endfunction

function Trig_Yuyuko02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local unit w
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 15
    local real abilitycooldownlv03 = 15
    local real abilitycooldownlv04 = 15
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set w = null
            return
        endif
    endif
    //========
    set w = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0)
    call UnitAddAbility(w,'A05B')
    call SetUnitAbilityLevel(w,'A05B',level)
    call IssueTargetOrder(w,"sleep",target)
    set caster = null
    set target = null
    set w = null
endfunction

//===========================================================================
function InitTrig_Yuyuko02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yuyuko03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Yuyuko03_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetKillingUnit())=='U006'
endfunction

function Trig_Yuyuko03_Actions takes nothing returns nothing
    local integer level = GetUnitAbilityLevel(GetKillingUnit(),'A0MN')
    local real mp = GetUnitState(GetKillingUnit(),UNIT_STATE_MANA)
    call SetUnitState( GetKillingUnit(), UNIT_STATE_MANA, mp + 5*(1+level) )
endfunction

function Trig_Yuyuko03_ID takes nothing returns boolean
    return GetLearnedSkill()=='A0MN'
endfunction

function Trig_Yuyuko03_Learn takes nothing returns nothing
    call DestroyTrigger(GetTriggeringTrigger())
    set gg_trg_Yuyuko03 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Yuyuko03, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_Yuyuko03, Condition( function Trig_Yuyuko03_Conditions ) )
    call TriggerAddAction( gg_trg_Yuyuko03, function Trig_Yuyuko03_Actions )
endfunction

//===========================================================================
function InitTrig_Yuyuko03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yuyuko03 Damage
//===========================================================================
function Trig_Yuyuko03_Damage_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A0MN'
endfunction

function Trig_Yuyuko03_Damage_Target takes nothing returns boolean
    if GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)<=0 then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(LoadUnitHandle(udg_ht,GetHandleId(GetExpiredTimer()),0))) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) == true then
        return false
    endif
    return true
endfunction

function Trig_Yuyuko03_Damage_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = GetUnitAbilityLevel(caster,'A0MN')
    local real damage
    local boolexpr f
    local group g
    local unit v
    if IsUnitAlive(caster) and udg_SK_uuz03_switch == 1 then
        set g = CreateGroup()
        set f = Filter(function Trig_Yuyuko03_Damage_Target)
        call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),500,f)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            set damage = GetUnitState(v, UNIT_STATE_MAX_LIFE) * 0.003 * (2+level)
            set damage = damage * 0.25
            if UnitHasBuffBJ(v,'BUsl') and GetUnitState(v,UNIT_STATE_LIFE) > damage then
                call SetUnitState(v,UNIT_STATE_LIFE,GetUnitState(v,UNIT_STATE_LIFE)-damage)
            else
                call UnitDamageTarget(caster,v,damage,true,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
            endif
        endloop
        call DestroyGroup(g) 
    endif
    set t = null
    set caster = null
    set f = null
    set g = null
    set v = null          
endfunction

function Trig_Yuyuko03_Damage_Learn takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0MN') 
    if level == 1 then
        call SaveUnitHandle(udg_ht,task,0,caster)
        call TimerStart(t,0.25,true,function Trig_Yuyuko03_Damage_Main)
    endif
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Yuyuko03_Damage takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yuyuko03 Switch
//===========================================================================
function Trig_Yuyuko03_Switch_Actions takes nothing returns nothing
    if GetIssuedOrderId()==OrderId("parasiteon") then
        set udg_SK_uuz03_switch = 1
    endif
    if GetIssuedOrderId()==OrderId("parasiteoff") then
        set udg_SK_uuz03_switch = 0
    endif
endfunction

//===========================================================================
function InitTrig_Yuyuko03_Switch takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yuyuko04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Yuyuko04_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A05C'
endfunction

function Trig_Yuyuko04_Target takes nothing returns boolean
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_DEAD) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_MECHANICAL) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(LoadUnitHandle(udg_ht,GetHandleId(GetExpiredTimer()),0))) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Avul')!=0 then
        return false
    endif
    if IsUnitWard(GetFilterUnit()) then
        return false
    endif
    return true
endfunction

function Trig_Yuyuko04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u
    local real x
    local real y
    local real a
    local group g
    local boolexpr f
    local real d
    local real hp
    local integer aID
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer j
    //========
    if i>0 and GetUnitCurrentOrder(caster)==OrderId("starfall") then
        set g = CreateGroup()
        set f = Filter(function Trig_Yuyuko04_Target)
        call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),650,f)
        set u = GroupPickRandomUnit(g)
        if u != null then
            set hp = GetUnitState(u,UNIT_STATE_LIFE)
            if IsUnitType(u,UNIT_TYPE_HERO) then
                set d = (level*0.1+0.4)*(GetUnitState(u,UNIT_STATE_MAX_LIFE)-hp)
                call UnitDamageTarget(caster,u,d,false,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,null)
            else
                call InstantKill(caster,u)
            endif
            call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",u,"origin"))
            if GetUnitState(u,UNIT_STATE_LIFE) <= 0 then
                set x = GetUnitX(u)
                set y = GetUnitY(u)
                set u = CreateUnit(GetOwningPlayer(caster),'n001',x,y,0)
                call UnitAddAbility(u,'A05F')
                call SetUnitAbilityLevel(u,'A05F',level)
                call IssueImmediateOrder(u,"fanofknives")
                set u = CreateUnit(GetOwningPlayer(caster),GPSU(),x,y,0.0)
                call SetUnitScale(u,2.0,2.0,2.0)
                call UnitAddAbility(u,'A05G' + GetRandomInt(0,3))
                set j = 1
                loop
                    set a = j*12.0
                    call IssuePointOrder(u,"carrionswarm",x+100*CosBJ(a),y+100*SinBJ(a))
                    set j = j + 1
                    exitwhen j > 30
                endloop
            endif
        endif
        call DestroyGroup(g)
        call DestroyBoolExpr(f)
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set g = null
    set f = null
endfunction

function Trig_Yuyuko04_Animation takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    //========
    call SetUnitAnimation(caster,"Spell")
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    //========
    set t = null
    set caster = null
endfunction

function Trig_Yuyuko04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t
    local integer task
    local unit u
    local real ox
    local real oy
    local integer level = GetUnitAbilityLevel(caster,'A05C')
    local integer n
    local real a = GetUnitFacing(caster)
    //========
        local real abilitycooldownlv01 = 110
        local real abilitycooldownlv02 = 110
        local real abilitycooldownlv03 = 110
    //========
    if GetTriggerEventId() == EVENT_UNIT_SPELL_CHANNEL then
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call TimerStart(t,0.1,false,function Trig_Yuyuko04_Animation)
        set ox = GetUnitX(caster)
        set oy = GetUnitY(caster)
        if (0.0<=a) and (a<45.0) then
            set a = 45.0
        elseif (45.0<=a) and (a<135.0) then
            set a = 90.0
        elseif (135.0<=a) and (a<180.0) then
            set a = 135.0
        elseif (180.0<=a) and (a<225.0) then
            set a = 225.0
        elseif (225.0<=a) and (a<315.0) then
            set a = 270.0
        else
            set a = 315.0
        endif
        call SetUnitFacing(caster,a)
        set u = CreateUnit(GetOwningPlayer(caster),'h00P',ox,oy,a)
        call SetUnitAnimation(u,"birth")
        call SaveUnitHandle(udg_sht,GetHandleId(caster),0,u)
    elseif GetTriggerEventId() == EVENT_UNIT_SPELL_EFFECT then
        //========
        if UnitHasItemOfTypeBJ(caster, 'I00B') then
            if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
            endif
        endif
    //========
        set n = 1 + level*2
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveInteger(udg_ht,task,0,level)
        call SaveInteger(udg_ht,task,1,n)
        call TimerStart(t,2.0/I2R(n),true,function Trig_Yuyuko04_Main)
    elseif GetTriggerEventId() ==  EVENT_UNIT_SPELL_ENDCAST then
        set u = LoadUnitHandle(udg_sht,GetHandleId(caster),0)
        call KillUnit(u)
    endif
    //========
    set caster = null
    set t = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Yuyuko04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Yuyuko04 Learn
//===========================================================================
function Trig_Yuyuko04_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A05C'
endfunction

function Trig_Yuyuko04_Learn_Actions takes nothing returns nothing
    local unit learner = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(learner,'A05C') 
    if level == 1 then
        call UnitAddAbility(learner,'A0MM')
    endif
    call SetUnitAbilityLevel(learner,'A0MM',level)
    set learner = null
endfunction

//===========================================================================
function InitTrig_Yuyuko04_Learn takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Init Yuyuko
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Yuyuko_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('U006')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set udg_SK_uuzre_switch = 0
    set udg_SK_uuz03_switch = 0

    set gg_trg_Yuyuko_Rekill = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yuyuko_Rekill, h, EVENT_UNIT_DAMAGED )
    call TriggerRegisterUnitLifeEvent( gg_trg_Yuyuko_Rekill, h, LESS_THAN, 5.00 )
    call TriggerAddCondition( gg_trg_Yuyuko_Rekill, Condition( function Trig_Yuyuko_Rekill_Conditions ) )
    call TriggerAddAction( gg_trg_Yuyuko_Rekill, function Trig_Yuyuko_Rekill_Actions )

    set gg_trg_Yuyuko01 = CreateTrigger()
    call TriggerRegisterUnitEvent(gg_trg_Yuyuko01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition(gg_trg_Yuyuko01, Condition( function Trig_Yuyuko01_Conditions ) )
    call TriggerAddAction(gg_trg_Yuyuko01, function Trig_Yuyuko01_Actions )

    set gg_trg_Yuyuko02 = CreateTrigger()
    call TriggerRegisterUnitEvent(gg_trg_Yuyuko02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition(gg_trg_Yuyuko02, Condition( function Trig_Yuyuko02_Conditions ) )
    call TriggerAddAction(gg_trg_Yuyuko02, function Trig_Yuyuko02_Actions )

    set gg_trg_Yuyuko03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yuyuko03, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Yuyuko03, Condition( function Trig_Yuyuko03_ID ) )
    call TriggerAddAction( gg_trg_Yuyuko03, function Trig_Yuyuko03_Learn )

    set gg_trg_Yuyuko03_Damage = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yuyuko03_Damage, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Yuyuko03_Damage, Condition( function Trig_Yuyuko03_Damage_Conditions ) )
    call TriggerAddAction( gg_trg_Yuyuko03_Damage, function Trig_Yuyuko03_Damage_Learn )

    set gg_trg_Yuyuko03_Switch = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yuyuko03_Switch, h, EVENT_UNIT_ISSUED_ORDER )
    call TriggerAddAction( gg_trg_Yuyuko03_Switch, function Trig_Yuyuko03_Switch_Actions )

    set gg_trg_Yuyuko04 = CreateTrigger()
    call TriggerRegisterUnitEvent(gg_trg_Yuyuko04, h, EVENT_UNIT_SPELL_CHANNEL)
    call TriggerRegisterUnitEvent(gg_trg_Yuyuko04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerRegisterUnitEvent(gg_trg_Yuyuko04, h, EVENT_UNIT_SPELL_ENDCAST )
    call TriggerAddCondition( gg_trg_Yuyuko04, Condition( function Trig_Yuyuko04_Conditions ) )
    call TriggerAddAction( gg_trg_Yuyuko04, function Trig_Yuyuko04_Actions )

    set gg_trg_Yuyuko04_Learn = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yuyuko04_Learn, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Yuyuko04_Learn, Condition( function Trig_Yuyuko04_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Yuyuko04_Learn, function Trig_Yuyuko04_Learn_Actions )
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Yuyuko takes nothing returns nothing
    set gg_trg_Init_Yuyuko = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Yuyuko, function Trig_Init_Yuyuko_Actions )
endfunction

//===========================================================================
// Trigger: AyaDS
//===========================================================================
function Trig_AyaDS_Conditions takes nothing returns boolean
    return IsUnitAlive(GetPlayerCharacter(GetTriggerPlayer()))
endfunction

function Trig_AyaDS_Actions takes nothing returns nothing
    local player who = GetTriggerPlayer()
    local unit caster = GetPlayerCharacter(who)
    local integer level01 = GetUnitAbilityLevel(caster,'A05S')
    local real damage01 = (13 + level01*7 + (0.75 + level01*0.15)*GetHeroAgi(caster,true))
    if level01 != 0 then
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00风符「风神一扇」伤害：|r" + R2S(damage01))
    endif
    set who = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_AyaDS takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Aya01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Aya01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A05K'
endfunction

function Trig_Aya01_Target takes nothing returns boolean
    if GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE)<=0 then
        return false
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if IsUnitWard(GetTriggerUnit()) then
        return false
    endif
    return true
endfunction

function Trig_Aya01_Damage takes nothing returns nothing
    local integer task = GetHandleId(GetTriggeringTrigger())
    local unit caster = LoadUnitHandle(udg_Hashtable,task,0)
    local real damage = LoadReal(udg_Hashtable,task,0)
    call UnitDamageTarget(caster,GetEnteringUnit(),damage,true,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    set caster = null
endfunction

function Trig_Aya01_Loop takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,0)
    local unit u = LoadUnitHandle(udg_Hashtable,task,1)
    //local effect e = LoadEffectHandle(udg_Hashtable,task,2)
    local trigger trg = LoadTriggerHandle(udg_Hashtable,task,4)
    local real a = LoadReal(udg_Hashtable,task,0)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px = ox + 15*Cos(a)
    local real py = oy + 15*Sin(a)
    local integer z = LoadInteger(udg_Hashtable,task,2)
    //========
    if z>0 and GetUnitFlag(caster,CS_FROZEN())==false then
        if IsTerrainPathable(px,py,PATHING_TYPE_FLYABILITY)==false then
            call SetUnitX(caster,px)
            call SetUnitY(caster,py)
            call SetUnitAnimation(caster,"Walk")
            call SetUnitFacing(caster,a*bj_RADTODEG)
            set px = ox - 550.0*Cos(a)
            set py = oy - 550.0*Sin(a)
            call SetUnitX(u,px)
            call SetUnitY(u,py)
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\Shockwave\\ShockwaveMissile.mdl",ox,oy))
            set z = z - 1
        else
            set z = 0
        endif
        call SaveInteger(udg_Hashtable,task,2,z)
    else
    //--------
        call SetUnitFlag(caster,CS_DASHING(),false)
        call IssueImmediateOrder(caster,"stop")
        call SetUnitPathing(caster,true)
        call KillUnit(u)
        //call DestroyEffect(e)
        call DestroyTimer(t)
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_Hashtable,task)
    endif
    //========
    set t = null
    set caster = null
    set trg = null
    set u = null
    //set e = null
endfunction

function Trig_Aya01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t = CreateTimer()
    local trigger trg = CreateTrigger()
    local integer task = GetHandleId(t)
    local integer stask = GetHandleId(trg)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = Atan2(ty-oy,tx-ox)
    local real d = SquareRoot((ty-oy)*(ty-oy)+(tx-ox)*(tx-ox))
    local real damage
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local integer lv = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //local effect e = AddSpecialEffectTarget("Abilities\\Spells\\Other\\Tornado\\TornadoElemental.mdl",caster,"origin")
    local unit u
    //========
    local real abilitycooldownlv01 = 11
    local real abilitycooldownlv02 = 11
    local real abilitycooldownlv03 = 11
    local real abilitycooldownlv04 = 11
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if lv==1 then
        set damage = 70
        set d = RMinBJ(d,500.0)
        set d = RMaxBJ(d,200.0)
    elseif lv==2 then
        set damage = 140
        set d = RMinBJ(d,900.0)
        set d = RMaxBJ(d,200.0)
    elseif lv==3 then
        set damage = 190
        set d = RMinBJ(d,1300.0)
        set d = RMaxBJ(d,200.0)
    else
        set damage = 210
        set d = RMinBJ(d,2100.0)
        set d = RMaxBJ(d,200.0)
    endif
    call SetUnitPathing(caster,false)
    
    //--------
    
    call TriggerRegisterUnitInRange( trg, caster, 120, iff )
    call TriggerAddCondition( trg, Condition( function Trig_Aya01_Target ) )
    call TriggerAddAction( trg, function Trig_Aya01_Damage )
    call SaveUnitHandle(udg_Hashtable,stask,0,caster)
    call SaveReal(udg_Hashtable,stask,0,damage)
    
    //--------
    
    set u = CreateUnit(GetOwningPlayer(caster),'n010',ox - 500*Cos(a),oy - 500*Sin(a),a*bj_RADTODEG)
    call SetUnitTimeScale(u,3.0)
    
    //========
    
    call SaveUnitHandle(udg_Hashtable,task,0,caster)
    call SaveUnitHandle(udg_Hashtable,task,1,u)
    call SaveTriggerHandle(udg_Hashtable,task,4,trg)
    call SaveReal(udg_Hashtable,task,0,a)
    call SaveInteger(udg_Hashtable,task,2,R2I(d/15))
    call SetUnitFlag(caster,CS_DASHING(),true)
    call TimerStart(t,0.01,true,function Trig_Aya01_Loop)
    
    //========
    
    set caster = null
    set t = null
    set iff = null
    set trg = null
    //set e = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Aya01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Aya02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Aya02_Conditions takes nothing returns boolean
    local unit attacked = GetTriggerUnit()
    local unit attacker = GetAttacker()
    if GetUnitAbilityLevel(attacker,'A05L')<=0 then
        set attacked = null
        set attacker = null
        return false
    endif
    if GetUnitAbilityLevel(attacked,'B00Y')==0 then
        set attacked = null
        set attacker = null
        return false
    endif
    set attacked = null
    set attacker = null
    return true
endfunction

function Trig_Aya02_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local integer level
    local real damage = 0
    local effect e
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        set e = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        //call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        //call DestroyTrigger(trg)
        //call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        set e = null
        return
    endif
    set target = GetTriggerUnit()
    set level = GetUnitAbilityLevel(caster,'A05L')
    //========
    call DisableTrigger(trg)
    //========
    if level==1 then
        set damage = 15
    elseif level==2 then
        set damage = 27
    elseif level==3 then
        set damage = 46
    elseif level==4 then
        set damage = 67
    endif
    call UnitDamageTargetHJ(caster,target,damage,2)
    set e = AddSpecialEffectTarget("Abilities\\Weapons\\SorceressMissile\\SorceressMissile.mdl",target,"chest")
    call DestroyEffect(e)
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
    set e = null
endfunction

function Trig_Aya02_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_Aya02_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Aya02 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Aya02 Use
//===========================================================================
function Trig_Aya02_Use_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A05L'
endfunction

function Trig_Aya02_Use_BLT_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit target = LoadUnitHandle(udg_Hashtable,task,0)
    call UnitRemoveAbility(target,'B00Y')
    call DestroyTimer(t)
    call FlushChildHashtable(udg_Hashtable,task)
    set t = null
    set target = null
endfunction

function Trig_Aya02_Use_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t
    local integer task
    //========
    local real abilitycooldownlv01 = 5
    local real abilitycooldownlv02 = 5
    local real abilitycooldownlv03 = 5
    local real abilitycooldownlv04 = 5
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set t = CreateTimer()
            set task = GetHandleId(t)
            call SaveUnitHandle(udg_Hashtable,task,0,GetSpellTargetUnit())
            call TimerStart(t,0.01,false,function Trig_Aya02_Use_BLT_Clear)
            set caster = null
            set t = null
            return
        endif
    endif
    //========
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Aya02_Use takes nothing returns nothing
    set gg_trg_Aya02_Use = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Aya02_Use, function Trig_Aya02_Use_Actions )
endfunction

//===========================================================================
// Trigger: Aya03
//===========================================================================
//TESH.scrollpos=9
//TESH.alwaysfold=0
function Trig_Aya03_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A05S'
endfunction

function Aya03_Attack_Conditions takes nothing returns boolean
    local unit caster = GetTriggerUnit()
    local unit source = GetEventDamageSource()
    local real damage = GetEventDamage()
    if (caster == source) and (damage < 0.02)then
        set caster = null
        set source = null
        return true
    endif
    set caster = null
    set source = null
    return false
endfunction

function Aya03_Group_Filter takes nothing returns boolean
    local unit u = GetFilterUnit()
    local unit caster = GetTriggerUnit()
    local player PLY = GetOwningPlayer(caster)
    if IsUnitAlly(u,PLY) or IsUnitType(u,UNIT_TYPE_DEAD) or IsUnitType(u,UNIT_TYPE_MECHANICAL) or IsUnitType(u,UNIT_TYPE_STRUCTURE) then
        set u = null
        set caster = null
        set PLY = null
        return false
    endif
    set u = null
    set caster = null
    set PLY = null
    return true
endfunction

function Aya03_Attack_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real facing = GetUnitFacing(caster)
    local real x = GetUnitX(caster) + 100 * Cos(facing * bj_DEGTORAD)
    local real y = GetUnitY(caster) + 100 * Sin(facing * bj_DEGTORAD)
    local integer level = GetUnitAbilityLevel(caster,'A05S')
    local unit u = CreateUnit(GetOwningPlayer(caster),'n00Z',x,y,0)
    local group g
    local real damage = (13 + level*7 + (0.75 + level*0.15)*GetHeroAgi(caster,true))
    local unit v
    //========
    call UnitApplyTimedLife(u,'BTLF',1.5)
    set g = CreateGroup()
    call GroupEnumUnitsInRange(g, x , y , 200, Filter(function Aya03_Group_Filter))
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        call UnitDamageTargetHJ(caster,v,damage,0)
    endloop
    call DestroyGroup(g)
    //========
    set u = null
    set v = null
    set g = null
    set caster = null
endfunction

function Trig_Aya03_Actions takes nothing returns nothing
    local trigger trg
    local unit caster = GetTriggerUnit()
    if GetUnitAbilityLevel(caster,'A05S')==1 and IsUnitIllusion(caster)==false then
        set trg = CreateTrigger()
        call TriggerRegisterUnitEvent( trg, caster, EVENT_UNIT_DAMAGED )
        call TriggerAddCondition( trg, Condition( function Aya03_Attack_Conditions ) )
        call TriggerAddAction( trg, function Aya03_Attack_Actions )
    endif
    set trg = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Aya03 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Aya04
//===========================================================================
//TESH.scrollpos=65
//TESH.alwaysfold=0
function Trig_Aya04_Lv3_Use_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A05O'
endfunction

function Trig_Aya04_Lv3_Use_Actions_Loop takes nothing returns nothing
    local string task = I2S(H2I(GetTriggeringTrigger()))
    local timer tmloop = I2T(GetStoredInteger(udg_gc,task,"TMLoop"))
    local timer tmstop = I2T(GetStoredInteger(udg_gc,task,"TMStop"))
    
    local unit u = I2U(GetStoredInteger(udg_gc,task,"Aya"))
    local real ux = GetUnitX(u)
    local real uy = GetUnitY(u)

    local real lx
    local real ly
    local unit target
    local integer i = GetUnitCurrentOrder(u)
    //========
    if TimerGetRemaining(tmstop)==0 then
        call PauseTimer(tmloop)
        call PauseTimer(tmstop)
        call DestroyTimer(tmloop)
        call DestroyTimer(tmstop)
        call FlushStoredMission(udg_gc,task)
        call DestroyTrigger(GetTriggeringTrigger())
        set tmloop = null
        set tmstop = null
        set u = null
        set target = null
        return
    endif
    
    if GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER then
        if i==851971 then
            set lx=GetUnitX(GetOrderTargetUnit())
            set ly=GetUnitY(GetOrderTargetUnit())
            call StoreInteger(udg_gc,task,"OrderType",1)
            call StoreInteger(udg_gc,task,"OrderTatget",H2I(GetOrderTargetUnit()))
        endif
    elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_POINT_ORDER then
        if i==851971 then
            set lx=GetOrderPointX()
            set ly=GetOrderPointY()
            call StoreInteger(udg_gc,task,"OrderType",2)
            call StoreReal(udg_gc,task,"OrderX",lx)
            call StoreReal(udg_gc,task,"OrderY",ly)
        endif
    endif
    
    if TimerGetRemaining(tmloop)>0 then
        set tmloop = null
        set tmstop = null
        set u = null
        set target = null
        return
    endif
    
    if GetTriggerEventId()==EVENT_GAME_TIMER_EXPIRED and (i==851971) then
        if GetStoredInteger(udg_gc,task,"OrderType")==1 then
            set target=I2U(GetStoredInteger(udg_gc,task,"OrderTatget"))
            set lx=GetUnitX(target)
            set ly=GetUnitY(target)
        elseif GetStoredInteger(udg_gc,task,"OrderType")==2 then
            set lx=GetStoredReal(udg_gc,task,"OrderX")
            set ly=GetStoredReal(udg_gc,task,"OrderY")
        endif
    endif
    
    if (i==851971) then
        if SquareRoot((lx-ux)*(lx-ux)+(ly-uy)*(ly-uy))>250 then
            call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl",u,"chest"))
            call SetUnitX(u,ux+200*Cos(Atan2(ly-uy,lx-ux)))
            call SetUnitY(u,uy+200*Sin(Atan2(ly-uy,lx-ux)))
            call TimerStart( tmloop, 0.3, false, null )
        else
            call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl",u,"chest"))
            call SetUnitX(u,ux+SquareRoot((lx-ux)*(lx-ux)+(ly-uy)*(ly-uy))*Cos(Atan2(ly-uy,lx-ux)))
            call SetUnitY(u,uy+SquareRoot((lx-ux)*(lx-ux)+(ly-uy)*(ly-uy))*Sin(Atan2(ly-uy,lx-ux)))
            call TimerStart( tmloop, 0.3, false, null )          
        endif
    endif
    //========
    set tmloop = null
    set tmstop = null
    set target = null
    set u = null
endfunction

function Trig_Aya04_Lv3_Use_Actions takes nothing returns nothing
    local trigger t = CreateTrigger()
    local timer tmloop = CreateTimer()
    local timer tmstop = CreateTimer()
    local string task=I2S(H2I(t))
    //========
    local real abilitycooldownlv01 = 44
    local real abilitycooldownlv02 = 44
    local real abilitycooldownlv03 = 22
    if UnitHasItemOfTypeBJ(GetTriggerUnit(), 'I00B') then
        if GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(GetTriggerUnit(),GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(GetTriggerUnit(),GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(GetTriggerUnit(),GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    call StoreInteger(udg_gc,task,"Aya",H2I(GetTriggerUnit()))
    call StoreInteger(udg_gc,task,"TMLoop",H2I(tmloop))
    call StoreInteger(udg_gc,task,"TMStop",H2I(tmstop))
    call TriggerAddAction(t,function Trig_Aya04_Lv3_Use_Actions_Loop)
    call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_ISSUED_TARGET_ORDER)
    call TriggerRegisterUnitEvent(t,GetTriggerUnit(),EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterTimerExpireEvent(t,tmloop)
    if GetUnitAbilityLevel(GetTriggerUnit(),'A05O') == 1 then
        call TimerStart(tmstop,2.0,false,null)
    else
        call TimerStart(tmstop,4.0,false,null)
    endif
    //call CastSpell(GetTriggerUnit(),"人称--「风神少女」!!!")
    set t = null
    set tmloop = null
    set tmstop = null
endfunction

//===========================================================================

function Trig_Aya04_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A05P'
endfunction

function Trig_Aya04_Learn_Actions takes nothing returns nothing
    local trigger trg
    local integer level = GetUnitAbilityLevel(GetTriggerUnit(),'A05P')
    local unit u = GetTriggerUnit()
    //========
    if GetUnitAbilityLevel(u,'A05Q')==0 then
        call UnitAddAbility(u,'A05Q')
    else
        call SetUnitAbilityLevel(u,'A05Q',level)
    endif
    //--------
    if level>=1 then
        if GetUnitAbilityLevel(u,'A05O')==0 and IsUnitIllusion(u)==false then
            set trg = CreateTrigger()
            call TriggerAddCondition(trg, Condition( function Trig_Aya04_Lv3_Use_Conditions ) )
            call TriggerAddAction(trg, function Trig_Aya04_Lv3_Use_Actions )
            call TriggerRegisterUnitEvent(trg,u, EVENT_UNIT_SPELL_EFFECT)
            call UnitAddAbility(u,'A05O')
        else
            call SetUnitAbilityLevel(u,'A05O',level)
        endif
    endif
    //翅膀特效
    if level==2 then
    call UnitAddAbility(u,'A0LG')
    elseif level==3 then
    call UnitAddAbility(u,'A0LH')
    endif
    //========
    set trg = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Aya04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initial Aya
//===========================================================================
//TESH.scrollpos=16
//TESH.alwaysfold=0
function Trig_Initial_Aya_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E008')
    local integer task = GetHandleId(h)
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_AyaDS = CreateTrigger()
    call TriggerRegisterPlayerEvent( gg_trg_AyaDS, GetOwningPlayer(h), EVENT_PLAYER_END_CINEMATIC)
    call TriggerAddCondition( gg_trg_AyaDS, Condition( function Trig_AyaDS_Conditions ) )
    call TriggerAddAction( gg_trg_AyaDS, function Trig_AyaDS_Actions )

    set gg_trg_Aya01 = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Aya01, Condition( function Trig_Aya01_Conditions ) )
    call TriggerAddAction( gg_trg_Aya01, function Trig_Aya01_Actions )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Aya01, EVENT_PLAYER_UNIT_SPELL_EFFECT)

    set gg_trg_Aya02 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Aya02, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Aya02, Condition( function Trig_Aya02_Conditions ) )
    call TriggerAddAction( gg_trg_Aya02, function Trig_Aya02_Actions )

    set gg_trg_Aya02_Use = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Aya02_Use, Condition( function Trig_Aya02_Use_Conditions ) )
    call TriggerAddAction( gg_trg_Aya02_Use, function Trig_Aya02_Use_Actions )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Aya02_Use, EVENT_PLAYER_UNIT_SPELL_EFFECT)

    set gg_trg_Aya03 = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Aya03 , EVENT_PLAYER_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Aya03, Condition( function Trig_Aya03_Conditions ) )
    call TriggerAddAction( gg_trg_Aya03, function Trig_Aya03_Actions )

    set gg_trg_Aya04 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Aya04, EVENT_PLAYER_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Aya04, Condition( function Trig_Aya04_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Aya04, function Trig_Aya04_Learn_Actions )

endfunction

//===========================================================================
function InitTrig_Initial_Aya takes nothing returns nothing
    set gg_trg_Initial_Aya = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Aya, function Trig_Initial_Aya_Actions )
endfunction

//===========================================================================
// Trigger: Suika01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Suika01_Use_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A05R'
endfunction

function Trig_Suika01_Use_Actions_Sources_Filter takes nothing returns boolean
    if(IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT))then
        return false
    elseif IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    elseif IsUnitType(GetFilterUnit(),UNIT_TYPE_FLYING) then
        return false
    elseif GetFilterUnit()==GetSpellAbilityUnit()then
        return false
    elseif IsUnitDeadBJ(GetFilterUnit())then
        return false
    elseif IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT) then
        return false
    elseif IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    elseif IsUnitVisible(GetFilterUnit(),GetOwningPlayer(GetSpellAbilityUnit()))==false then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    elseif GetUnitTypeId(GetFilterUnit())=='n001' or GetUnitTypeId(GetFilterUnit())=='n004' then
        return false
    endif
    return IsMobileUnit(GetFilterUnit())
endfunction

function Trig_Suika01_Use_Actions_Kill_Trees takes nothing returns nothing
    call KillDestructable(GetEnumDestructable())
endfunction

function Trig_Suika01_Use_Actions_Loop takes nothing returns nothing
    local timer tm = GetExpiredTimer()
    local string task = I2S(H2I(tm))
    local integer i = GetStoredInteger(udg_gc,task,"Counter")
    local unit suika
    local unit target
    local unit obj = I2U(GetStoredInteger(udg_gc,task,"Object"))
    local unit m
    local real h = (i-25)*(i-25)
    local real ux = GetStoredReal(udg_gc,task,"SrcX")
    local real uy = GetStoredReal(udg_gc,task,"SrcY")
    local real lx = GetStoredReal(udg_gc,task,"TarX")
    local real ly = GetStoredReal(udg_gc,task,"TarY")
    local real x = GetUnitX(obj)
    local real y = GetUnitY(obj)
    local real damage
    local group g
    local boolexpr iff
    local location loc = Location(x,y)
    //========
    if IsTerrainPathable(lx,ly,PATHING_TYPE_WALKABILITY)==false then
        call SetUnitX(obj,ux + ( lx - ux )/50*i)
        call SetUnitY(obj,uy + ( ly - uy )/50*i)
    else
        if IsTerrainPathable(x,y,PATHING_TYPE_WALKABILITY)==false then
            call SetUnitX(obj,ux + ( lx - ux )/50*i)
            call SetUnitY(obj,uy + ( ly - uy )/50*i)
        else
            call SetUnitX(obj,x)
            call SetUnitY(obj,y)
        endif
    endif
    call SetUnitFlyHeight(obj,775-h,0)
    call StoreInteger(udg_gc,task,"Counter",i + 1)
    if(i>50)then
        call SetUnitFlyHeight(obj,GetUnitDefaultFlyHeight(obj),0)
        call PauseUnit(obj,false)
        call SetUnitPathing(obj,true)
        call SetUnitFlag(obj,CS_REPEL(),false)
        call SetUnitFlag(obj,CS_DRAG(),false)
        call TerrainDeformationRippleBJ(0.2,true,loc,1.,300.,96.,1,64.)
        set suika = I2U(GetStoredInteger(udg_gc,task,"Suika"))
        set target = I2U(GetStoredInteger(udg_gc,task,"Target"))
        set damage = GetStoredReal(udg_gc,task,"Damage")
        call UnitDamageTarget(suika, target, 0.5*damage, true, false, ATTACK_TYPE_HERO, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS)
        if IsUnitAlly(obj,GetOwningPlayer(suika)) then
            call UnitDamageTarget(suika, obj, 0.5*damage, true, false, ATTACK_TYPE_HERO, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS)
        else
            call UnitDamageTarget(suika, obj, 1.5*damage, true, false, ATTACK_TYPE_HERO, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS)
        endif
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",GetUnitX(obj),GetUnitY(obj)))
        set iff = GetPlayerFilter(GetOwningPlayer(suika))
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,x,y,220,iff)
        loop
            set m = FirstOfGroup(g)
            exitwhen m==null
            if m!=obj and IsUnitAliveBJ(m) and not IsUnitWard(m) then
                call UnitDamageTarget(suika, m, damage, true, false, ATTACK_TYPE_HERO, DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS)
            endif
            call GroupRemoveUnit(g,m)
        endloop
        call DestroyGroup(g)
        set iff = null
        call EnumDestructablesInCircleBJ(300,loc,function Trig_Suika01_Use_Actions_Kill_Trees)
        call FlushStoredMission(udg_gc,task)
        call DestroyTimer(tm)
    endif
    call RemoveLocation(loc)
    //========
    set tm = null
    set suika = null
    set target = null
    set obj = null
    set loc = null
    set g = null
    set m = null
endfunction

function Trig_Suika01_Use_Actions takes nothing returns nothing
    local timer tm
    local string task
    local group g = CreateGroup()
    local boolexpr f = Condition(function Trig_Suika01_Use_Actions_Sources_Filter)
    local unit u = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit obj
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 15
    local real abilitycooldownlv03 = 15
    local real abilitycooldownlv04 = 15
    if UnitHasItemOfTypeBJ(u, 'I00B') then
        if GetUnitAbilityLevel(u,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(u,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(u,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(u,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(u,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(u,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(u,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(u,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_CAST then
        call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),300,f)
    else
        call GroupEnumUnitsInRange(g,GetUnitX(u),GetUnitY(u),275,f)
    endif
    call GroupRemoveUnit(g,GetSpellTargetUnit())
    set obj = GroupPickRandomUnit(g)
    call DestroyBoolExpr(f)
    call DestroyGroup(g)
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_CAST then
        if obj == null then
            call DisplayTextToPlayer(GetOwningPlayer(u),0,0,"没有可以投掷的目标")
            call IssueImmediateOrder(u,"stop")
            call PauseUnit(u,true)
            call PauseUnit(u,false)
            call IssueImmediateOrder(u,"stop")
        endif
    else
        if obj != null then
            //========
            if IsUnitAlly(obj,GetTriggerPlayer()) == false then
                if IsUnitType(obj,UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(obj))] == true and IsUnitIllusionBJ(obj) == false then
                    call Item_BLTalismanicRunningCD(obj)
                    set target = null
                    set f = null
                    set tm = null
                    set g = null
                    set u = null
                    set obj = null
                    return
                endif
            endif
            //========
            call SetUnitAnimationByIndex(u,4)
            call PauseUnit(obj,true)
            call SetUnitPathing(obj,false)
            call EnableHeight(obj)
            call SetUnitFlag(obj,CS_REPEL(),true)
            call SetUnitFlag(obj,CS_DRAG(),true)
            set tm = CreateTimer()
            set task = I2S(H2I(tm))
            call StoreInteger(udg_gc,task,"Suika",H2I(u))
            call StoreInteger(udg_gc,task,"Object",H2I(obj))
            call StoreInteger(udg_gc,task,"Target",H2I(target))
            call StoreReal(udg_gc,task,"SrcX",GetUnitX(u))
            call StoreReal(udg_gc,task,"SrcY",GetUnitY(u))
            call StoreReal(udg_gc,task,"TarX",GetLocationX(GetSpellTargetLoc()))
            call StoreReal(udg_gc,task,"TarY",GetLocationY(GetSpellTargetLoc()))
            call StoreReal(udg_gc,task,"Damage",75*GetUnitAbilityLevel(u,'A05R'))
            call StoreInteger(udg_gc,task,"Counter",1)
            call TimerStart(tm,0.02,true,function Trig_Suika01_Use_Actions_Loop)
        endif
    endif
    set target = null
    set f = null
    set tm = null
    set g = null
    set u = null
    set obj = null
endfunction

//===========================================================================
function InitTrig_Suika01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Suika02
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 利用一个对自己造成伤害的粉碎进行判断触发
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Suika02_Conditions takes nothing returns boolean
    local unit caster
    local integer rate
    if GetEventDamage()>0.02 then
        set caster = null
        return false
    endif
    set caster = GetTriggerUnit()
    if GetEventDamageSource()==caster and GetUnitAbilityLevel(caster,'A0BC')==0 then
        if GetUnitTypeId(caster)=='H00Q' then
            set rate = 25 + 25 * GetUnitAbilityLevel(caster,'A05W')
        else
            set rate = 30
        endif
        if GetRandomInt(0,100)<=rate then
            set caster = null
            return true
        endif
    endif
    set caster = null
    return false
endfunction

function Trig_Suika02_Delay takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local real x = LoadReal(udg_ht,task,1)
    local real y = LoadReal(udg_ht,task,2)
    local unit u = CreateUnit(GetOwningPlayer(caster),GPSU(),x,y,0)
    local integer level = GetUnitAbilityLevel(caster,'A02I')
    call UnitAddAbility(u,'A05U')
    call SetUnitAbilityLevel(u,'A05U',level)
    call IssueImmediateOrder(u,"thunderclap")
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Suika02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real x = GetUnitX(caster)
    local real y = GetUnitY(caster)
    local real a = GetUnitFacing(caster)
    local real d
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    if GetUnitTypeId(caster)=='H00Q' then
        set d = 150.0
    else
        set d = 100.0
    endif
    set x = x + d*CosBJ(a)
    set y = y + d*SinBJ(a)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveReal(udg_ht,task,1,x)
    call SaveReal(udg_ht,task,2,y)
    call TimerStart(t,0.01,false,function Trig_Suika02_Delay)
    //========
    set caster = null
    set t = null
endfunction

function Trig_Suika02_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A02I'
endfunction

function Trig_Suika02_Learn_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    call DestroyTrigger(gg_trg_Suika02)
    set gg_trg_Suika02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Suika02, caster, EVENT_UNIT_DAMAGED )
    call TriggerAddCondition( gg_trg_Suika02, Condition( function Trig_Suika02_Conditions ) )
    call TriggerAddAction( gg_trg_Suika02, function Trig_Suika02_Actions )
    set caster = null
endfunction

//===========================================================================
function InitTrig_Suika02 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Suika03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Suika03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A05V'
endfunction

function Trig_Suika03_Frame takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if GetUnitAbilityLevel(caster,'B03G')>0 then
        set u = CreateUnit(GetOwningPlayer(caster),'n030',ox,oy,GetRandomReal(0,360))
        call UnitApplyTimedLife(u,'BTLF',6.0)
        call IssueImmediateOrder(u,"elementalfury")
    else
        call SetUnitMoveSpeed(caster,GetUnitDefaultMoveSpeed(caster))
        call UnitRemoveAbility(caster,'A0BC')
        
        //call UnitRemoveAbility(caster,'B047')
        
        call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A05R',true)
        call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A05V',true)
        call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A05W',true)
        call SetUnitVertexColor(caster,255,255,255,255)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Suika03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local integer i = (level*2)*5 
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //local unit u
    //========
    local real abilitycooldownlv01 = 30
    local real abilitycooldownlv02 = 25
    local real abilitycooldownlv03 = 20
    local real abilitycooldownlv04 = 15
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========

    call IssueImmediateOrder(caster, "stop" )
    
    call SetUnitMoveSpeed(caster,150)
    call UnitAddAbility(caster,'A0BC')
    
    //set u = CreateUnit(GetOwningPlayer(caster),GPSU(),GetUnitX(caster),GetUnitY(caster),0.0)
    //call UnitAddAbility(u,'A0IN')
    //call IssueTargetOrder(u,"banish",caster)
    
    call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A05R',false)
    call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A05V',false)
    call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A05W',false)
    call SetUnitVertexColor(caster,255,255,255,1)
    
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,i)
    call TimerStart(t,0.4,true,function Trig_Suika03_Frame)
    
    //========
    set caster = null
    set t = null
    //set u = null
endfunction

//===========================================================================
function InitTrig_Suika03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Suika04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Suika04_Conditions takes nothing returns boolean
    if GetUnitTypeId(GetTriggerUnit())!='H00Q' then
        return false
    endif
    return GetSpellAbilityId()=='A05W'
endfunction

function Trig_Suika04_End takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local boolean o = IsUnitAlive(caster)
    local boolean k = GetUnitTypeId(caster)=='H00Q'
    //========
    if (not o)or(not k) then
        if o then
            call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Other\\ToonBoom\\ToonBoom.mdl",caster,"origin"))
            call PlaySoundOnUnitBJ(gg_snd_Suika04,100,caster)
        endif
        call UnitRemoveAbility(caster,'B045')
        call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A05V',true)
        call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A05W',true)
        call DebugMsg("MPP OFF")
        call SetUnitScale(caster,1,1,1)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
endfunction

function Trig_Suika04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t
    local real s
    //========
    local real abilitycooldownlv01 = 100
    local real abilitycooldownlv02 = 100
    local real abilitycooldownlv03 = 100
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    set s = 2.0 + level*2.0
    call SetUnitScale(caster,s,s,s)
    call UnitAddAbility(caster,'A0BB')
    call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A05V',false)
    call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A05W',false)
    call SetUnitAbilityLevel(caster,'A0HZ',level)
    call SetUnitState(caster,UNIT_STATE_MANA,1)
    call DestroyEffect(AddSpecialEffectTarget("Objects\\Spawnmodels\\Other\\ToonBoom\\ToonBoom.mdl",caster,"origin"))
    call PlaySoundOnUnitBJ(gg_snd_Suika04,100,caster)
    call CastSpell(caster,"Missing Power!!!!!!")
    set t = CreateTimer()
    call SaveUnitHandle(udg_ht,GetHandleId(t),0,caster)
    call TimerStart(t,0.1,true,function Trig_Suika04_End)
    call DebugMsg("MPP ON")
    //========
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Suika04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Suika
//===========================================================================
//TESH.scrollpos=16
//TESH.alwaysfold=0

function Trig_Initial_Suika_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H00L')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    if udg_SK_EyeBugModeOn == false then
        set udg_SK_EyeBugModeOn = true
        set gg_trg_YukariEyebug = CreateTrigger()
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint01 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint02 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint03 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint04 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint05 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint06 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint07 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint08 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint09 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint10 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint11 )
        call TriggerRegisterEnterRectSimple( gg_trg_YukariEyebug, gg_rct_EyePoint12 )
        call TriggerAddCondition( gg_trg_YukariEyebug, Condition( function Trig_YukariEyebug_Conditions ) )
        call TriggerAddAction( gg_trg_YukariEyebug, function Trig_YukariEyebug_Actions )
    endif

    set gg_trg_Suika01 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Suika01, EVENT_PLAYER_UNIT_SPELL_CAST)
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Suika01, EVENT_PLAYER_UNIT_SPELL_EFFECT)
    call TriggerAddCondition( gg_trg_Suika01, Condition( function Trig_Suika01_Use_Conditions ) )
    call TriggerAddAction( gg_trg_Suika01, function Trig_Suika01_Use_Actions )
    
    set gg_trg_Suika02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Suika02, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Suika02, Condition( function Trig_Suika02_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Suika02, function Trig_Suika02_Learn_Actions )
    
    set gg_trg_Suika03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Suika03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Suika03, Condition( function Trig_Suika03_Conditions ) )
    call TriggerAddAction( gg_trg_Suika03, function Trig_Suika03_Actions )
    
    set gg_trg_Suika04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Suika04, h, EVENT_UNIT_SPELL_FINISH )
    call TriggerAddCondition( gg_trg_Suika04, Condition( function Trig_Suika04_Conditions ) )
    call TriggerAddAction( gg_trg_Suika04, function Trig_Suika04_Actions )
    
    set h = null
endfunction

function InitTrig_Initial_Suika takes nothing returns nothing
    set gg_trg_Initial_Suika = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Suika, function Trig_Initial_Suika_Actions )
endfunction
//===========================================================================
// Trigger: Youmu01
//===========================================================================
function Trig_Youmu01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A05X'
endfunction

function Trig_Youmu01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_sht,GetHandleId(caster),1)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local real a = LoadReal(udg_ht,task,0)
    local real d = LoadReal(udg_ht,task,1)
    local real damage
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local unit v
    local group g
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    //========
    if IsUnitAlive(caster) then
        set px = ox + d*Cos(a)
        set py = oy + d*Sin(a)
        if SetUnitXYFly(caster,px,py)==false then
            set px = ox
            set py = oy
        endif
        if u!=null then
            call SetUnitX(u,px - 30.0*Cos(a))
            call SetUnitY(u,py - 30.0*Sin(a))
            call SetUnitFacing(u,bj_RADTODEG*a)
        endif
    endif
    call SaveInteger(udg_ht,task,1,i + 1)
    //========
    if IsUnitAlive(caster) and i<2 then
        set damage = 25.0 + level*25.0
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,px,py,304.0,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitAliveBJ(v) and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and IsUnitWard(v)==false then
                call UnitDamageTarget(caster,v,damage,true,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_METAL_HEAVY_SLICE)
                call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\OrbOfDeath\\OrbOfDeathMissile.mdl",v,"chest"))
            endif
        endloop
        call DestroyGroup(g)
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\OrbOfDeath\\AnnihilationMissile.mdl",px,py))
    else
        call SetUnitPathing(caster,true)
        call SetUnitFlag(caster,CS_DASHING(),false)
        call SetUnitFlag(caster,CS_LOST(),false)
        call SetUnitVertexColor(caster,255,255,255,255)
        if u!=null then
            call SetUnitVertexColor(u,255,255,255,160)
        endif
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set g = null
    set iff = null
endfunction

function Trig_Youmu01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u = LoadUnitHandle(udg_sht,GetHandleId(caster),1)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = Atan2(ty-oy,tx-ox)
    local real d = SquareRoot(Pow(ty-oy,2)+Pow(tx-ox,2))
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 13
    local real abilitycooldownlv02 = 11
    local real abilitycooldownlv03 = 9
    local real abilitycooldownlv04 = 7
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set d = RMinBJ(600+level*100,d)
    set d = RMaxBJ(100.0,d)/3.0
    call SetUnitFlag(caster,CS_DASHING(),true)
    call SetUnitFlag(caster,CS_LOST(),true)
    call SetUnitVertexColor(caster,0,0,0,0)
    call SetUnitPathing(caster,false)
    if u!=null then
        call SetUnitVertexColor(u,0,0,0,0)
        call SetUnitX(u,ox - 30.0*Cos(a))
        call SetUnitY(u,oy - 30.0*Sin(a))
        call SetUnitFacing(u,bj_RADTODEG*a)
    endif
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,0)
    call SaveReal(udg_ht,task,0,a)
    call SaveReal(udg_ht,task,1,d)
    call TimerStart(t,0.2,true,function Trig_Youmu01_Main)
    //========
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Youmu01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Youmu02
//
// 2。每次攻击50/70/85/100%降低敌人4甲
// 可叠加最多60
// 持续13秒。
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Youmu02_Conditions takes nothing returns boolean
    if GetUnitAbilityLevel(GetAttacker(),'A05Y')==0 then
        return false
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(GetAttacker())) then
        return false
    endif
    return true
endfunction

function Trig_Youmu02_Fade takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit target = LoadUnitHandle(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer difflevel = LoadInteger(udg_ht,task,2)
    local integer armorlevel
    //========
    if IsUnitDead(target) then
        call UnitRemoveAbility(target,'A0RV')
        call UnitRemoveAbility(target,'X000')
        call FlushChildHashtable(udg_ht,task)
        call DestroyTimer(t)
    elseif i==0 then
        set armorlevel = GetUnitAbilityLevel(target,'A0RV') - difflevel
        if armorlevel <= 0 then
            call UnitRemoveAbility(target,'A0RV')
        else
            call SetUnitAbilityLevel(target,'A0RV',armorlevel)
        endif
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    else
        call SaveInteger(udg_ht,task,1,i - 1)
    endif
    //========
    set t = null
    set target = null
endfunction

function Trig_Youmu02_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local unit u
    local timer t
    local boolean b
    local integer level
    local integer changelevel
    local integer armorlevel
    local integer oldlevel
    local integer difflevel
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        set u = null
        set t = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        set trg = null
        set caster = null
        set target = null
        set u = null
        set t = null
        return
    endif
    //========
    set target = GetTriggerUnit()
    //========
    call DisableTrigger(trg)
    set b = false
    set level = LoadInteger(udg_ht,task,2)
    set changelevel = level
    if IsUnitIllusion(caster) then
        if level == 1 then
            if udg_SK_Youmu02_Illusion_Count == false then
                set udg_SK_Youmu02_Illusion_Count = true
                set changelevel = 0
            else
                set udg_SK_Youmu02_Illusion_Count = false
                set changelevel = 1
            endif
        elseif level == 2 or level == 4 then
            set changelevel = level/2
        else
            if udg_SK_Youmu02_Illusion_Count == false then
                set udg_SK_Youmu02_Illusion_Count = true
                set changelevel = 1
            else
                set udg_SK_Youmu02_Illusion_Count = false
                set changelevel = 2
            endif
        endif
    endif
    set oldlevel = GetUnitAbilityLevel(target,'A0RV')
    set armorlevel = oldlevel + changelevel
    if armorlevel > level * 16 then
        set armorlevel = level * 16
    endif
    if armorlevel > oldlevel then
        set difflevel = armorlevel - oldlevel
        if GetUnitAbilityLevel(target,'A0RV') == 0 then
            call UnitAddAbility(target,'A0RV')
        endif
        call SetUnitAbilityLevel(target,'A0RV',armorlevel)
        set b = true
    endif
    if b then
        set t = CreateTimer()
        call SaveUnitHandle(udg_ht,GetHandleId(t),0,target)
        call SaveInteger(udg_ht,GetHandleId(t),1,8)
        call SaveInteger(udg_ht,GetHandleId(t),2,difflevel)
        call TimerStart(t,1.0,true,function Trig_Youmu02_Fade)
        set u = CreateUnit(GetOwningPlayer(caster),GPSU(),GetUnitX(caster),GetUnitY(caster),0)
        call UnitApplyTimedLife(u,'BTLF',1)
        call UnitAddAbility(u,'A063')
        call IssueTargetOrder(u,"innerfire",target)
    endif
    call UnitDamageTargetHJ(caster,target,level*5+5,1)
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
    set u = null
    set t = null
endfunction

function Trig_Youmu02_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    local integer level = GetUnitAbilityLevel(caster,'A05Y')
    //========
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_Youmu02_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call SaveInteger(udg_ht,GetHandleId(trg),2,level)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Youmu02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Youmu03
//===========================================================================
function Trig_Youmu03_Conditions takes nothing returns boolean
    if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
        return GetSpellAbilityId()=='A064'
    endif
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_SUMMON then
        if GetUnitTypeId(GetSummoningUnit())!='o00O' then
            return false
        endif
        return GetUnitTypeId(GetSummonedUnit())=='O00B'
    endif
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_DEATH then
        return IsUnitIllusion(GetTriggerUnit())
    endif
    return false
endfunction

function Trig_Youmu03_Duplicate_Order_Issue takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit v = LoadUnitHandle(udg_ht,task,0)
    local integer ID = LoadInteger(udg_ht,task,0)
    local integer k = LoadInteger(udg_ht,task,1)
    //========
    if k==1 then
        call IssueImmediateOrderById(v,ID)
    elseif k==2 then
        call IssuePointOrderById(v,ID,LoadReal(udg_ht,task,0),LoadReal(udg_ht,task,1))
    elseif k==3 then
        call IssueTargetOrderById(v,ID,LoadUnitHandle(udg_ht,task,1))
    endif
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    //========
    set t = null
    set v = null
endfunction

function Trig_Youmu03_Duplicate_Order takes nothing returns nothing
    local integer ID = GetIssuedOrderId()
    local unit caster = GetTriggerUnit()
    local unit target = GetOrderTargetUnit()
    local unit v = LoadUnitHandle(udg_sht,GetHandleId(caster),1)
    local real tx = GetOrderPointX()
    local real ty = GetOrderPointY()
    local timer t
    local integer task
    if v!=null and ID<=0xD0040 then
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,v)
        call SaveInteger(udg_ht,task,0,ID)
        if GetTriggerEventId()==EVENT_UNIT_ISSUED_ORDER then
            call SaveInteger(udg_ht,task,1,1)
        elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_POINT_ORDER then
            call SaveInteger(udg_ht,task,1,2)
            call SaveReal(udg_ht,task,0,tx)
            call SaveReal(udg_ht,task,1,ty)
        elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER then
            call SaveInteger(udg_ht,task,1,3)
            call SaveUnitHandle(udg_ht,task,1,target)
        endif
        call TimerStart(t,0.3,false,function Trig_Youmu03_Duplicate_Order_Issue)
    endif
    set caster = null
    set target = null
    set v = null
    set t = null
endfunction

function Trig_Youmu03_Actions takes nothing returns nothing
    local integer task = GetHandleId(GetTriggeringTrigger())
    local unit caster = LoadUnitHandle(udg_sht,task,0)
    local unit u
    local unit v
    //========
    local real abilitycooldownlv01 = 18
    local real abilitycooldownlv02 = 18
    local real abilitycooldownlv03 = 18
    local real abilitycooldownlv04 = 18
    //========
    if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
        if UnitHasItemOfTypeBJ(caster, 'I00B') then
            if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
            endif
        endif
        set caster = GetTriggerUnit()
        call SaveUnitHandle(udg_sht,task,0,caster)
        set u = CreateUnit(GetOwningPlayer(caster),'o00O',GetUnitX(caster),GetUnitY(caster),270.0)
        call UnitAddAbility(u,'A0E0')
        call SetUnitAbilityLevel(u,'A0E0',GetUnitAbilityLevel(caster,'A064'))
        call IssueTargetOrderById(u,852274,caster)
    elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SUMMON then
        set u = LoadUnitHandle(udg_sht,GetHandleId(caster),0)
        set v = GetSummonedUnit()
        call UnitAddAbility(v,'Aloc')
        call SetUnitVertexColor(v,255,255,255,160)
        call SetUnitX(v,GetUnitX(u))
        call SetUnitY(v,GetUnitY(u))
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIil\\AIilTarget.mdl",v,"origin"))
        call SaveBoolean(udg_sht,GetHandleId(caster),1,false)
        call SaveUnitHandle(udg_sht,GetHandleId(caster),1,v)
        call EnableTrigger(gg_trg_Youmu03)
    elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_DEATH then
        call DisableTrigger(gg_trg_Youmu03)
        set v = LoadUnitHandle(udg_sht,GetHandleId(caster),1)
        if GetTriggerUnit()==v then
            call SaveBoolean(udg_sht,GetHandleId(caster),1,true)
            call SaveUnitHandle(udg_sht,GetHandleId(caster),1,null)
        endif
    endif
    //========
    set caster = null
    set u = null
    set v = null
endfunction

function Trig_Youmu03_Follow takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local unit caster = LoadUnitHandle(udg_sht,GetHandleId(t),0)
    local integer i = LoadInteger(udg_sht,GetHandleId(t),1)
    local integer task = GetHandleId(caster)
    local unit u = LoadUnitHandle(udg_sht,task,0)
    local unit v = LoadUnitHandle(udg_sht,task,1)
    local boolean k = LoadBoolean(udg_sht,task,0)
    local boolean q = LoadBoolean(udg_sht,task,1)
    local boolean l = IsUnitAlive(caster)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local real dx
    local real dy
    local real a = GetUnitFacing(caster) - 75.0
    local real d
    //========
    if q and l then
        if not k then
            call ShowUnit(u,true)
            call UnitAddAbility(u,'Aloc')
            call SaveBoolean(udg_sht,task,0,true)
        endif
        set px = ox + 75.0*CosBJ(a)
        set py = oy + 75.0*SinBJ(a)
        set ox = GetUnitX(u)
        set oy = GetUnitY(u)
        set dx = px - ox
        set dy = py - oy
        set d = SquareRoot(dx*dx + dy*dy)
        set a = Atan2(dy,dx)
        call SetUnitFacing(u,bj_RADTODEG*a)
        if d<=400.0 then
            set d = d/40.0
            set px = ox + d*Cos(a)
            set py = oy + d*Sin(a)
            call SetUnitX(u,px)
            call SetUnitY(u,py)
            call TimerStart(t,0.02,false,function Trig_Youmu03_Follow)
        elseif d<=1500.0 then
            call IssuePointOrder(u,"move",px,py)
            call TimerStart(t,0.50,false,function Trig_Youmu03_Follow)
        else
            call SetUnitPosition(u,px,py)
            call TimerStart(t,0.02,false,function Trig_Youmu03_Follow)
        endif
        if i/256*256==i then
            call SetUnitFlyHeight(u,GetRandomReal(30.0,70.0),10.0)
        endif
        call SaveInteger(udg_sht,GetHandleId(t),1,i + 1)
    else
        if IsUnitDead(caster) and not q then
            call KillUnit(v)
        endif
        if k then
            call ShowUnit(u,false)
            call UnitRemoveAbility(u,'Aloc')
            call SaveBoolean(udg_sht,task,0,false)
        endif
        call SetUnitX(u,ox)
        call SetUnitY(u,oy)
        call TimerStart(t,0.02,false,function Trig_Youmu03_Follow)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
endfunction

function Trig_Youmu03_Init takes unit h returns nothing
    local timer t = CreateTimer()
    local integer task
    local unit u
    //========
    call SaveUnitHandle(udg_sht,GetHandleId(t),0,h)
    call SaveInteger(udg_sht,GetHandleId(t),1,0)
    set u = CreateUnit(GetOwningPlayer(h),'n02S',GetUnitX(h),GetUnitY(h),0.0)
    set task = GetHandleId(h)
    call SaveUnitHandle(udg_sht,task,0,u)
    call SaveUnitHandle(udg_sht,task,1,null)
    call SaveBoolean(udg_sht,task,0,true)
    call SaveBoolean(udg_sht,task,1,true)
    call TimerStart(t,0.02,false,function Trig_Youmu03_Follow)
    //========
    set t = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Youmu03 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Youmu04
//
// 4。距离900闪击。
// 对目标造成（敏捷*3.4/4/5.2+100/150/210）点物理伤害。（一道白光）
// MP：100/150/200点 CD130
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Youmu04_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A065'
endfunction

function Trig_Youmu04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,0)
    local unit target = LoadUnitHandle(udg_Hashtable,task,1)
    local integer i = LoadInteger(udg_Hashtable,task,1)
    local real damage = LoadReal(udg_Hashtable,task,0)
    local real a = LoadReal(udg_Hashtable,task,1)
    local real ox = LoadReal(udg_Hashtable,task,2)
    local real oy = LoadReal(udg_Hashtable,task,3)
    local real px
    local real py
    local unit u
    //========
    call SetUnitPosition(target,GetUnitX(target),GetUnitY(target))
    if i > 1  then
        if i==10 then
            set px = ox
            set py = oy
            call PauseUnit(target,true)
        else
            set px = ox + 250.0*CosBJ(210.0*i)
            set py = oy + 250.0*SinBJ(210.0*i)
        endif
        call SetUnitPosition(caster,px,py)
        call SetUnitAnimation(caster,"attack")
        call UnitDamageTarget(caster,target,1.0,true,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_METAL_HEAVY_SLICE)
        call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\ZigguratMissile\\ZigguratMissile.mdl",px,py))
        call SaveInteger(udg_Hashtable,task,1,i - 1)
        call TimerStart(t,0.10,false,function Trig_Youmu04_Main)
    else
        set px = ox + 100.0*CosBJ(a)
        set py = oy + 100.0*SinBJ(a)
        call SetUnitX(caster,px)
        call SetUnitY(caster,py)
        call SetUnitAnimation(caster,"attack")
        call KillUnit(CreateUnit(Player(15), 'e00H',ox,oy,0))
        call UnitDamageTarget(caster,target,damage,true,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_METAL_HEAVY_SLICE)
        call PauseUnit(target,false)
        call DestroyEffect(AddSpecialEffectTarget("shot.mdl",caster,"chest"))
        call DestroyEffect(LoadEffectHandle(udg_Hashtable,task,2))
        call DestroyEffect(LoadEffectHandle(udg_Hashtable,task,3))
        call DestroyEffect(LoadEffectHandle(udg_Hashtable,task,4))
        call SetUnitTimeScale(caster,1.0)
        call SetUnitInvulnerable(caster,false)
        call SetUnitVertexColor(caster,255,255,255,255)
        call SetUnitPathing(caster,true)
        call SetUnitFlag(caster,CS_LOST(),false)
        call CastSpell(caster,"人鬼·「未来永劫斩」----")
        call IssueImmediateOrder(caster,"phaseshiftoff")
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,task)
    endif
    //========
    set t = null
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_Youmu04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local real damage
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local effect array e
    //========
    local real abilitycooldownlv01 = 100
    local real abilitycooldownlv02 = 85
    local real abilitycooldownlv03 = 70
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    //call SetUnitTimeScale(caster,5.0)
    call SetUnitVertexColor(caster,255,255,255,0)
    call SetUnitInvulnerable(caster,true)
    call SetUnitAnimation(caster,"stand ready")
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl",caster,"chest"))
    set e[0] = AddSpecialEffectTarget("Abilities\\Weapons\\ZigguratMissile\\ZigguratMissile.mdl",caster,"weapon")
    set e[1] = AddSpecialEffectTarget("Abilities\\Weapons\\ZigguratMissile\\ZigguratMissile.mdl",caster,"weapon")
    set e[2] = AddSpecialEffectTarget("Abilities\\Weapons\\ZigguratMissile\\ZigguratMissile.mdl",caster,"weapon")
    call SetUnitPathing(caster,false)
    if level==1 then
        set damage = 90 + 3.2*GetHeroAgi(caster,true)
    elseif level==2 then
        set damage = 180 + 4.2*GetHeroAgi(caster,true)
    elseif level==3 then
        set damage = 270 + 5.2*GetHeroAgi(caster,true)
    endif
    //========
    call SaveUnitHandle(udg_Hashtable,task,0,caster)
    call SaveUnitHandle(udg_Hashtable,task,1,target)
    call SaveEffectHandle(udg_Hashtable,task,2,e[0])
    call SaveEffectHandle(udg_Hashtable,task,3,e[1])
    call SaveEffectHandle(udg_Hashtable,task,4,e[2])
    call SaveInteger(udg_Hashtable,task,1,10)
    call SaveReal(udg_Hashtable,task,0,damage)
    call SaveReal(udg_Hashtable,task,1,a)
    call SaveReal(udg_Hashtable,task,2,tx)
    call SaveReal(udg_Hashtable,task,3,ty)
    if GetUnitAbilityLevel(caster,'A0E1')==0 then
        call UnitAddAbility(caster,'A0E1')
    endif
    call SetUnitFlag(caster,CS_LOST(),true)
    call TimerStart(t,0.10,true,function Trig_Youmu04_Main)
    //========
    set caster = null
    set target = null
    set e[0] = null
    set e[1] = null
    set e[2] = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Youmu04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Youmu
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Youmu_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('O00B')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    call UnitAddAbility(h,'A0RV')
    call UnitRemoveAbility(h,'A0RV')

    set gg_trg_Youmu01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Youmu01, h, EVENT_UNIT_SPELL_EFFECT)
    call TriggerAddCondition( gg_trg_Youmu01, Condition( function Trig_Youmu01_Conditions ) )
    call TriggerAddAction( gg_trg_Youmu01, function Trig_Youmu01_Actions )
    
    set gg_trg_Youmu02 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Youmu02, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Youmu02, Condition( function Trig_Youmu02_Conditions ) )
    call TriggerAddAction( gg_trg_Youmu02, function Trig_Youmu02_Actions )
    
    set gg_trg_Youmu03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Youmu03, h, EVENT_UNIT_SPELL_EFFECT)
    call TriggerRegisterPlayerUnitEvent( gg_trg_Youmu03, GetOwningPlayer(h), EVENT_PLAYER_UNIT_SUMMON, null )
    call TriggerRegisterPlayerUnitEvent( gg_trg_Youmu03, GetOwningPlayer(h), EVENT_PLAYER_UNIT_DEATH, null )
    call TriggerAddCondition( gg_trg_Youmu03, Condition( function Trig_Youmu03_Conditions ) )
    call TriggerAddAction( gg_trg_Youmu03, function Trig_Youmu03_Actions )
    call Trig_Youmu03_Init(h)
    
    set gg_trg_Youmu03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Youmu03, h, EVENT_UNIT_ISSUED_ORDER )
    call TriggerRegisterUnitEvent( gg_trg_Youmu03, h, EVENT_UNIT_ISSUED_POINT_ORDER )
    call TriggerRegisterUnitEvent( gg_trg_Youmu03, h, EVENT_UNIT_ISSUED_TARGET_ORDER )
    call TriggerAddAction( gg_trg_Youmu03, function Trig_Youmu03_Duplicate_Order )
    call DisableTrigger(gg_trg_Youmu03)
    
    set gg_trg_Youmu04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Youmu04, h, EVENT_UNIT_SPELL_EFFECT)
    call TriggerAddCondition( gg_trg_Youmu04, Condition( function Trig_Youmu04_Conditions ) )
    call TriggerAddAction( gg_trg_Youmu04, function Trig_Youmu04_Actions )

    set h = null
endfunction

function InitTrig_Initial_Youmu takes nothing returns nothing
    set gg_trg_Initial_Youmu = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Youmu, function Trig_Initial_Youmu_Actions )
endfunction

//===========================================================================
// Trigger: Reisen Attack
//===========================================================================
//TESH.scrollpos=9
//TESH.alwaysfold=0
function Trig_Reisen_Attack_Conditions takes nothing returns boolean
    local real k
    local real l
    if GetTriggerEventId() == EVENT_UNIT_DAMAGED then
        if GetUnitTypeId(GetEventDamageSource()) != 'O007' then
            return false
        endif
        if GetEventDamage() != 0.00 then
            return false
        endif
        if GetUnitAbilityLevel(GetTriggerUnit(),'B043')==0 then
            return false
        endif
        call UnitRemoveAbility(GetTriggerUnit(),'B043')
        return true
    elseif GetTriggerEventId() == EVENT_PLAYER_UNIT_SUMMON then
        if GetUnitTypeId(GetSummonedUnit()) != 'O007' then
            return false
        endif
        if IsUnitIllusion(GetSummonedUnit()) != true then
            return false
        endif
        set k = GetRandomReal(0,360)
        set l = GetRandomReal(50,200)
        call SetUnitXYGround(GetSummonedUnit(),GetUnitX(GetSummoningUnit())+l*CosBJ(k),GetUnitY(GetSummoningUnit())+l*SinBJ(k))
        if udg_SK_Reisen01_Target != null and IsUnitType(udg_SK_Reisen01_Target,UNIT_TYPE_DEAD) == false then
            call IssueTargetOrder(GetSummonedUnit(),"attack",udg_SK_Reisen01_Target)
        endif
        return false
    endif
    return false
endfunction

function Trig_Reisen_Attack_Actions takes nothing returns nothing
    local unit caster = GetEventDamageSource()
    local unit target = GetTriggerUnit()
    local integer ab01level = GetUnitAbilityLevel(GetPlayerCharacter(GetOwningPlayer(caster)),'A0PI')
    local unit u
    local real rate
    local boolean tf
    local integer ab02level = GetUnitAbilityLevel(GetPlayerCharacter(GetOwningPlayer(caster)),'A0PJ')
    local real damage = 1.0
    set udg_SK_Reisen01_Target = target
    if ab01level >= 1 then
        if udg_SK_Reisen[1] < 8 then
            if IsUnitIllusion(caster) then
                set rate = 1.50
            elseif udg_SK_Reisen[0]==1 then
                set rate = 100.0
            else
                set rate = 10.0
            endif
            if GetRandomReal(0,100) < rate then
                set u = CreateUnit(GetOwningPlayer(caster),GPSU(),GetUnitX(caster),GetUnitY(caster),0)
                call UnitAddAbility(u,'A067')
                call SetUnitAbilityLevel(u,'A067',ab01level)
                set tf = IssueTargetOrderById(u,852274,caster)
                if tf then
                    set udg_SK_Reisen[1] = udg_SK_Reisen[1] + 1
                    call DisplayTextToPlayer(GetOwningPlayer(caster),0,0,"幻象：" + I2S(udg_SK_Reisen[1])+"/8")
                endif
            endif
        endif
    endif
    if ab02level >= 1 and not(IsUnitType(target,UNIT_TYPE_MECHANICAL)) then
        if IsUnitIllusion(caster) then
            set rate = 3.0
            set damage = 1.0
        elseif udg_SK_Reisen02 == true then
            set udg_SK_Reisen02 = false
            set rate = 100.0
            set damage = 2.0
        else
            set rate = 20.0
            set damage = 1.0
        endif
        if GetRandomReal(0,100) < rate then
            call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\VengeanceMissile\\VengeanceMissile.mdl",GetUnitX(target),GetUnitY(target)))
            set u = CreateUnit(GetOwningPlayer(caster),GPSU(),GetUnitX(target),GetUnitY(target),270.0)
            call UnitAddAbility(u,'A06A')
            call SetUnitAbilityLevel(u,'A06A',ab02level)
            call IssueTargetOrder(u,"slow",target)
            set u = CreateUnit(GetOwningPlayer(caster),GPSU(),GetUnitX(target),GetUnitY(target),270.0)
            call UnitAddAbility(u,'A000')
            call SetUnitAbilityLevel(u,'A000',ab02level)
            call IssueTargetOrder(u,"curse",target)
            set damage = (7 + 7 * ab02level) * damage
            call UnitDamageTargetHJ(u,target,damage,4)
        endif
    endif
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Reisen_Attack takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Reisen01
//===========================================================================
function Trig_Reisen01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0PI'
endfunction

function Trig_Reisen01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local integer level = GetUnitAbilityLevel(caster,'A0PI')
    local boolean tf
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx
    local real ty
    //========
    local real abilitycooldownlv01 = 16
    local real abilitycooldownlv02 = 16
    local real abilitycooldownlv03 = 16
    local real abilitycooldownlv04 = 16
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if udg_SK_Reisen01_Target != null then
        set tx = GetUnitX(udg_SK_Reisen01_Target)
        set ty = GetUnitY(udg_SK_Reisen01_Target)
        if SquareRoot((ox-tx)*(ox-tx)+(oy-ty)*(oy-ty)) > 800.00 + GetUnitAbilityLevel(caster,'A069') * 35.0 then
            set udg_SK_Reisen01_Target = null
        endif
    endif
    if udg_SK_Reisen[1] < 8 then
        set u = CreateUnit(GetOwningPlayer(caster),GPSU(),GetUnitX(caster),GetUnitY(caster),0)
        call UnitAddAbility(u,'A067')
        call SetUnitAbilityLevel(u,'A067',level)
        set tf = IssueTargetOrderById(u,852274,caster)
        if tf then
            set udg_SK_Reisen[1] = udg_SK_Reisen[1] + 1
            call DisplayTextToPlayer(GetOwningPlayer(caster),0,0,"幻象：" + I2S(udg_SK_Reisen[1])+"/8")
        endif
    endif
    if udg_SK_Reisen[1] < 8 then
        set u = CreateUnit(GetOwningPlayer(caster),GPSU(),GetUnitX(caster),GetUnitY(caster),0)
        call UnitAddAbility(u,'A067')
        call SetUnitAbilityLevel(u,'A067',level)
        set tf = IssueTargetOrderById(u,852274,caster)
        if tf then
            set udg_SK_Reisen[1] = udg_SK_Reisen[1] + 1
            call DisplayTextToPlayer(GetOwningPlayer(caster),0,0,"幻象：" + I2S(udg_SK_Reisen[1])+"/8")
        endif
    endif
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Reisen01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Reisen01 Count
//===========================================================================
function Trig_Reisen01_Count_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit())=='O007' and IsUnitIllusion(GetTriggerUnit())
endfunction

function Trig_Reisen01_Count_Filter takes nothing returns boolean
    if GetUnitTypeId(GetFilterUnit())!='O007' then
        return false
    endif
    if IsUnitIllusion(GetFilterUnit())==false then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'B04C')==0 then
        return false
    endif
    return IsUnitAlive(GetFilterUnit())
endfunction

function Trig_Reisen01_Count_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit v
    local group g = CreateGroup()
    local boolexpr f = Filter(function Trig_Reisen01_Count_Filter)
    local integer n
    //========
    call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(caster),f)
    set n = 0
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        set n = n + 1
    endloop
    set udg_SK_Reisen[1] = n
    call DisplayTextToPlayer(GetOwningPlayer(caster),0,0,"幻象：" + I2S(udg_SK_Reisen[1])+"/8")
    //========
    call DestroyBoolExpr(f)
    call DestroyGroup(g)
    set caster = null
    set v = null
    set g = null
    set f = null
endfunction

//===========================================================================
function InitTrig_Reisen01_Count takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Reisen02 New
//===========================================================================
function Trig_Reisen02_New_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0PJ'
endfunction

function Trig_Reisen02_New_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real abilitycooldownlv01 = 6
    local real abilitycooldownlv02 = 6
    local real abilitycooldownlv03 = 6
    local real abilitycooldownlv04 = 6
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set udg_SK_Reisen02 = true
    set caster = null
endfunction

//===========================================================================
function InitTrig_Reisen02_New takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Reisen03
//===========================================================================
function Trig_Reisen03_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A069'
endfunction

function Trig_Reisen03_Learn takes nothing returns nothing
    local integer level = GetUnitAbilityLevel(GetTriggerUnit(),'A069')
    call SetPlayerTechResearched(GetOwningPlayer(GetTriggerUnit()),'R000',level)
endfunction

//===========================================================================

function InitTrig_Reisen03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Reisen04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Reisen04_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetSummonedUnit())=='n018'
endfunction

function Trig_Reisen04_Buff_Target takes nothing returns boolean
    if GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)<=0 then
        return false
    endif
    if not IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetSummonedUnit())) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return IsUnitType(GetFilterUnit(), UNIT_TYPE_HERO)
endfunction

function Trig_Reisen04_Debuff_Target takes nothing returns boolean
    if GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)<=0 then
        return false
    endif
    if IsUnitType(GetFilterUnit(), UNIT_TYPE_MECHANICAL) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(LoadUnitHandle(udg_ht,GetHandleId(GetExpiredTimer()),0))) then
        return false
    endif
    return true
endfunction

function Trig_Reisen04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local real x = GetUnitX(caster)
    local real y = GetUnitY(caster)
    local boolexpr f
    local group g
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i>0 then
        call SetUnitX(u,x)
        call SetUnitY(u,y)
        if i==(i/10)*10 then
            call SetUnitAnimation(u,"birth")
            set u = CreateUnit(GetOwningPlayer(caster),GPSU(),x,y,0.0)
            call UnitAddAbility(u,'A06A')
            call UnitAddAbility(u,'A06C')
            set g = CreateGroup()
            set f = Filter(function Trig_Reisen04_Debuff_Target)
            call GroupEnumUnitsInRange(g,x,y,500.0,f)
            loop
                set v = FirstOfGroup(g)
                exitwhen v == null
                call GroupRemoveUnit(g,v)
                call IssueTargetOrder(u,"curse",v)
                call IssueTargetOrder(u,"slow",v)
            endloop
            call DestroyBoolExpr(f)
            call DestroyGroup(g)
        endif
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        set udg_SK_Reisen[0] = 0
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set f = null
    set g = null
endfunction

function Trig_Reisen04_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetSummoningUnit()
    local unit u = GetSummonedUnit()
    local unit v
    local real x = GetUnitX(caster)
    local real y = GetUnitY(caster)
    local boolexpr f = Filter(function Trig_Reisen04_Buff_Target)
    local group g = CreateGroup()
    local integer level = GetUnitAbilityLevel(caster,'A06D')
    //========
    local real abilitycooldownlv01 = 120
    local real abilitycooldownlv02 = 100
    local real abilitycooldownlv03 = 80
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,'A06D') == 1 then
            call Item_HeroAbilityCoolDownReset(caster,'A06D',abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,'A06D') == 2 then
            call Item_HeroAbilityCoolDownReset(caster,'A06D',abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,'A06D') == 3 then
            call Item_HeroAbilityCoolDownReset(caster,'A06D',abilitycooldownlv03)
        endif
    endif
    //========
    set udg_SK_Reisen[0] = 1
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,1,20 + level*20)
    call TimerStart(t,0.1,true,function Trig_Reisen04_Main)
    //========
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),x,y,270.0)
    call UnitAddAbility(u,'A06B')
    call GroupEnumUnitsInRange(g,x,y,500.0,f)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        call IssueTargetOrder(u,"invisibility",v)
    endloop
    call DestroyBoolExpr(f)
    call DestroyGroup(g)
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set f = null
    set g = null
endfunction

//===========================================================================
function InitTrig_Reisen04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Init Reisen
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Reisen_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('O007')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set udg_SK_Reisen[0] = 0
    set udg_SK_Reisen[1] = 0
    
    set gg_trg_Reisen_Attack = CreateTrigger()
    call RegisterAnyUnitDamage(gg_trg_Reisen_Attack)
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Reisen_Attack, EVENT_PLAYER_UNIT_SUMMON )
    call TriggerAddCondition( gg_trg_Reisen_Attack, Condition( function Trig_Reisen_Attack_Conditions ) )
    call TriggerAddAction( gg_trg_Reisen_Attack, function Trig_Reisen_Attack_Actions )

    set gg_trg_Reisen01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Reisen01, h, EVENT_UNIT_SPELL_EFFECT)
    call TriggerAddCondition( gg_trg_Reisen01, Condition( function Trig_Reisen01_Conditions ) )
    call TriggerAddAction( gg_trg_Reisen01, function Trig_Reisen01_Actions )
    
    set gg_trg_Reisen01_Count = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_Reisen01_Count, GetOwningPlayer(h), EVENT_PLAYER_UNIT_DEATH, null )
    call TriggerAddCondition( gg_trg_Reisen01_Count, Condition( function Trig_Reisen01_Count_Conditions ) )
    call TriggerAddAction( gg_trg_Reisen01_Count, function Trig_Reisen01_Count_Actions )
    
    set gg_trg_Reisen02_New = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Reisen02_New, h, EVENT_UNIT_SPELL_EFFECT)
    call TriggerAddCondition( gg_trg_Reisen02_New, Condition( function Trig_Reisen02_New_Conditions ) )
    call TriggerAddAction( gg_trg_Reisen02_New, function Trig_Reisen02_New_Actions )
    
    set gg_trg_Reisen03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Reisen03, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Reisen03, Condition( function Trig_Reisen03_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Reisen03, function Trig_Reisen03_Learn )

    set gg_trg_Reisen04 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Reisen04, EVENT_PLAYER_UNIT_SUMMON )
    call TriggerAddCondition( gg_trg_Reisen04, Condition( function Trig_Reisen04_Conditions ) )
    call TriggerAddAction( gg_trg_Reisen04, function Trig_Reisen04_Actions )
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Reisen takes nothing returns nothing
    set gg_trg_Init_Reisen = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Init_Reisen, function Trig_Init_Reisen_Actions )
endfunction

//===========================================================================
// Trigger: CirnoBaga
//===========================================================================
function Trig_CirnoBaga_Conditions takes nothing returns boolean
    return GetHeroInt(udg_SK_Cirno_Cirno, true) != 9
endfunction

function Trig_CirnoBaga_Actions takes nothing returns nothing
    local unit baga = udg_SK_Cirno_Cirno
    local integer diff
    local real counter
    local real m0
    local real m1
    local integer c1
    local integer c10
    local integer c100

    set diff = GetHeroInt(udg_SK_Cirno_Cirno, true) - 9
    set udg_SK_Cirno_Baga = udg_SK_Cirno_Baga + diff 
    if udg_SK_Cirno_Baga < 0 then
        set baga = null
        return
    endif
    set m0 = GetUnitState(baga,UNIT_STATE_MAX_MANA)
    set m1 = GetUnitState(baga,UNIT_STATE_MANA)
    call UnitAddAbility(baga, 'A0TE')

    set counter = udg_SK_Cirno_Baga
    if GetUnitAbilityLevel(baga,'A0MZ') == 0 then
        call UnitAddAbility(baga, 'A0MZ')
    endif
    if GetUnitAbilityLevel(baga,'A0MY') == 0 then
        call UnitAddAbility(baga, 'A0MY')
    endif
    if GetUnitAbilityLevel(baga,'A0MX') == 0 then
        call UnitAddAbility(baga, 'A0MX')
    endif

    set c100 = R2I(counter/100)+1
    set counter = counter - R2I(counter/100)*100
    set c10 = R2I(counter/10)+1
    set counter = counter - R2I(counter/10)*10
    set c1 = R2I(counter)+1
    set counter = 0

    call SetUnitAbilityLevel(baga, 'A0MX', c1)
    call SetUnitAbilityLevel(baga, 'A0MY', c10)
    call SetUnitAbilityLevel(baga, 'A0MZ', c100)

    call UnitRemoveAbility(baga, 'A0TE')

    call SetUnitState(baga,UNIT_STATE_MANA,GetUnitState(baga,UNIT_STATE_MAX_MANA)*(m1/m0))
    set baga = null
endfunction

//===========================================================================
function InitTrig_CirnoBaga takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Cirno01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Cirno01_ID takes nothing returns boolean
    return GetSpellAbilityId()=='A06E'
endfunction

function IFF_Life takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) then
        return false
    endif
    if GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)<=0 then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_MECHANICAL) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_ANCIENT) then
        return false
    endif
    return true
endfunction

function Trig_Cirno01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target
    local unit u
    local group g = CreateGroup()
    local boolexpr f = Condition(function IFF_Life)
    local integer level = GetUnitAbilityLevel(caster,'A06E')
    local integer z = IMaxBJ(1,level-1)
    //========
    local real abilitycooldownlv01 = 5
    local real abilitycooldownlv02 = 5
    local real abilitycooldownlv03 = 5
    local real abilitycooldownlv04 = 5
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),230,f)
    loop
        exitwhen z == 0
        set z = z - 1
        set target = GroupPickRandomUnit(g)
        exitwhen target == null
        call DisplayTextToPlayer(GetOwningPlayer(caster),0,0,"++")
        set u = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0)
        call UnitAddAbility(u,'A06F')
        call SetUnitAbilityLevel(u,'A06F',level)
        call IssueTargetOrder(u,"frostnova",target)
        call GroupRemoveUnit(g,target)
    endloop
    //========
    call DestroyBoolExpr(f)
    call DestroyGroup(g)
    set caster = null
    set target = null
    set g = null
    set f = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Cirno01 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Cirno02
//===========================================================================
//TESH.scrollpos=16
//TESH.alwaysfold=0
function Trig_Cirno02_Conditions takes nothing returns boolean
    local integer level
    if GetUnitTypeId(GetAttacker())!='E009' then
        return false
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_MECHANICAL) then
        return false
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_ANCIENT) then
        return false
    endif
    set level = GetUnitAbilityLevel(GetAttacker(),'A06G')
    if level > 0 then
        return GetRandomInt(0,100)<9+4*level
    else
        return false
    endif
endfunction

function Trig_Cirno02_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local unit u
    local integer level
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED or GetEventDamage()<=1.0 then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        set u = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        set trg = null
        set caster = null
        set target = null
        set u = null
        return
    endif
    set target = GetTriggerUnit()
    //========
    call DisableTrigger(trg)
    //========
    set level = IMaxBJ(1,GetUnitAbilityLevel(caster,'A06E'))
    set u = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0)
    call UnitAddAbility(u,'A06F')
    call SetUnitAbilityLevel(u,'A06F',level)
    call IssueTargetOrder(u,"frostnova",target)
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_Cirno02_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_Cirno02_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Cirno02 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Cirno03
//===========================================================================
//TESH.scrollpos=70
//TESH.alwaysfold=0
function Cirno03_ID takes nothing returns boolean
local unit u = GetTriggerUnit()
    if GetLearnedSkill()!='A06H' then
        set u = null
        return false
    endif
    if IsUnitIllusion(u) then
        set u = null
        return false
    endif    
    if GetUnitAbilityLevel(u,'A06H')==1 then
        set u = null
        return true    
    endif
set u = null
return false
endfunction

function Cirno03_CD takes nothing returns nothing
    set udg_SK_Cirno03_CD = false
    call DestroyTimer(GetExpiredTimer())
endfunction

function Cirno03_Active takes trigger trg,unit target returns nothing
    local string task = I2S(H2I(trg))
    local unit caster = I2U(GetStoredInteger(udg_gc,task,"caster"))
    local unit u
    local timer t = CreateTimer()
    local integer level = IMaxBJ(1,GetUnitAbilityLevel(caster,'A06E'))
    //========
    set u = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(caster),GetUnitY(caster),0)
    call UnitAddAbility(u,'A06F')
    call SetUnitAbilityLevel(u,'A06F',level)
    call IssueTargetOrder(u,"frostnova",target)
    set udg_SK_Cirno03_CD = true
    call TimerStart(t,12-3*GetUnitAbilityLevel(caster,'A06H'),false,function Cirno03_CD)
    //========
    set caster = null
    set u = null
    set t = null
endfunction

function Cirno03_Active_Conditions takes nothing returns boolean
    local integer level
    if udg_SK_Cirno03_CD then
        return false
    endif
    if GetTriggerEventId()==EVENT_UNIT_ATTACKED then
        //--------
        if IsUnitType(GetAttacker(),UNIT_TYPE_MECHANICAL) then
            return false
        endif
        if IsUnitType(GetAttacker(),UNIT_TYPE_ANCIENT) then
            return false
        endif
        set level = GetUnitAbilityLevel(GetTriggerUnit(),'A06H')
        if level==0 then
            return false
        endif
        if GetRandomInt(0,100) < 12 + 3*level then
            call Cirno03_Active(GetTriggeringTrigger(),GetAttacker())
        endif
        //--------
    elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
        //--------
        if GetUnitTypeId(GetSpellTargetUnit())!='E009' then
            return false
        endif
        set level = GetUnitAbilityLevel(GetSpellTargetUnit(),'A06H')
        if level==0 then
            return false
        endif
        if GetRandomInt(0,100) < 12 + 3*level then
            call Cirno03_Active(GetTriggeringTrigger(),GetTriggerUnit())
        endif
        //--------
    endif
    return false
endfunction

function Cirno03_Learn takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local trigger trg = CreateTrigger()
    local string task = I2S(H2I(trg))
    call StoreInteger(udg_gc,task,"caster",H2I(caster))
    call TriggerRegisterUnitEvent( trg, caster, EVENT_UNIT_ATTACKED )
    call TriggerRegisterAnyUnitEventBJ( trg, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( trg, Condition( function Cirno03_Active_Conditions ) )
    set trg = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Cirno03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Cirno04
//===========================================================================
function Trig_Cirno04_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0MW'
endfunction

function Trig_Cirno04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = LoadInteger(udg_ht,task,1)
    local real intcount = LoadReal(udg_ht,task,2)
    local effect ice = LoadEffectHandle(udg_ht,task,3)
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local group g
    local unit v
    set intcount = intcount + 0.01
    set g = CreateGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),250+50*level,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if intcount <= 1.00 and IsUnitAliveBJ(v) and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and IsUnitType(v,UNIT_TYPE_HERO)==false and GetUnitAbilityLevel(v,'B04B') == 0 and GetUnitAbilityLevel(v,'BOvc') == 0 then
            call IssueTargetOrderById(v,851983,caster)
        endif
        if intcount <= 1.00 + GetHeroInt(v,true)*0.04 and IsUnitAliveBJ(v) and IsUnitType(v,UNIT_TYPE_HERO) and GetUnitAbilityLevel(v,'B04B') == 0 and GetUnitAbilityLevel(v,'BOvc') == 0 then
            call IssueTargetOrderById(v,851983,caster)
        endif
    endloop
    call DestroyGroup(g)
    call SaveReal(udg_ht,task,0,intcount)
    if intcount > 5.00 or GetUnitCurrentOrder(caster)!=OrderId("starfall") then
        call DestroyEffect(ice)
        call UnitRemoveAbility(caster,'A0C6')
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,task)
    endif
    set t = null
    set caster = null
    set iff = null
    set g = null
    set v = null
    set ice = null
endfunction

function Trig_Cirno04_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0MW')
    local effect e = AddSpecialEffect("Abilities\\Spells\\NightElf\\Taunt\\TauntCaster.mdl",GetUnitX(caster),GetUnitY(caster))
    local effect ice = AddSpecialEffectTarget("FreezingBreathTargetArt.mdx",caster,"origin")

    //========
    local real abilitycooldownlv01 = 119
    local real abilitycooldownlv02 = 119
    local real abilitycooldownlv03 = 119
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========

    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,1,level)
    call SaveReal(udg_ht,task,2,0)
    call SaveEffectHandle(udg_ht,task,3,ice)

    call TimerStart(t,0.01,true,function Trig_Cirno04_Main)
    call CastSpell(caster,"我才不是笨蛋！你们全部都是笨蛋！")
    call UnitAddAbility(caster,'A0C6')
    call DestroyEffect(e)

    set t = null
    set caster = null
    set e = null
    set ice = null
endfunction

//===========================================================================
function InitTrig_Cirno04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initial Cirno
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Initial_Cirno_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E009')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set udg_SK_Cirno_Cirno = h

    set gg_trg_CirnoBaga = CreateTrigger()
    call TriggerRegisterTimerEventPeriodic( gg_trg_CirnoBaga, 0.1 )
    //call TriggerRegisterUnitEvent( gg_trg_CirnoBaga,h, EVENT_UNIT_HERO_SKILL )
    //call TriggerRegisterUnitEvent( gg_trg_CirnoBaga,h, EVENT_UNIT_PICKUP_ITEM )
    //call TriggerRegisterUnitEvent( gg_trg_CirnoBaga,h, EVENT_UNIT_DROP_ITEM )
    call TriggerAddCondition( gg_trg_CirnoBaga, Condition( function Trig_CirnoBaga_Conditions ) )
    call TriggerAddAction( gg_trg_CirnoBaga, function Trig_CirnoBaga_Actions )

    set gg_trg_Cirno01 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Cirno01, EVENT_PLAYER_UNIT_SPELL_CAST )
    call TriggerAddCondition( gg_trg_Cirno01, Condition( function Trig_Cirno01_ID ) )
    call TriggerAddAction( gg_trg_Cirno01, function Trig_Cirno01_Actions )

    set gg_trg_Cirno02 = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Cirno02, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Cirno02, Condition( function Trig_Cirno02_Conditions ) )
    call TriggerAddAction( gg_trg_Cirno02, function Trig_Cirno02_Actions )

    set gg_trg_Cirno03 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Cirno03, EVENT_PLAYER_HERO_SKILL)
    call TriggerAddCondition( gg_trg_Cirno03, Condition( function Cirno03_ID ) )
    call TriggerAddAction( gg_trg_Cirno03, function Cirno03_Learn )

    set gg_trg_Cirno04 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Cirno04, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Cirno04, Condition( function Trig_Cirno04_Conditions ) )
    call TriggerAddAction( gg_trg_Cirno04, function Trig_Cirno04_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Cirno takes nothing returns nothing
    set gg_trg_Initial_Cirno = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Cirno, function Trig_Initial_Cirno_Actions )
endfunction

//===========================================================================
// Trigger: FlandreBroker
//===========================================================================
function Trig_FlandreBroker_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetEventDamageSource()) == 'U007'
endfunction

function Trig_FlandreBroker_Actions takes nothing returns nothing
    local unit caster = GetEventDamageSource()
    local unit target = GetTriggerUnit()
    local real damage = GetEventDamage()
    if IsUnitType(target,UNIT_TYPE_STRUCTURE) == false then
        call UnitDamageTargetHJ(caster,target,damage * 0.15,4)
    endif
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_FlandreBroker takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Flandre01
//===========================================================================
function Trig_Flandre01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A06J'
endfunction

function Trig_Flandre01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    //========
    local real abilitycooldownlv01 = 25
    local real abilitycooldownlv02 = 25
    local real abilitycooldownlv03 = 25
    local real abilitycooldownlv04 = 25
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set caster = null
endfunction

//===========================================================================
function InitTrig_Flandre01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Flandre02
//===========================================================================
//TESH.scrollpos=36
//TESH.alwaysfold=0
function Trig_Flandre02_Conditions takes nothing returns boolean
    if GetUnitAbilityLevel(GetAttacker(),'A06L') == 0 then
        return false
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_MECHANICAL) then
        return false
    endif
    return true
endfunction

function Trig_Flandre02_Slow takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local unit u
    local integer level
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        set u = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,GetHandleId(trg),0)
    if GetEventDamageSource()!=caster then
        set trg = null
        set caster = null
        set target = null
        set u = null
        return
    endif
    //========
    set target = GetTriggerUnit()
    //========
    call DisableTrigger(trg)
    //========
    if GetUnitAbilityLevel(target,'B012')>0 then
    set level = 1
    elseif GetUnitAbilityLevel(target,'B013')>0 then
    set level = 2
    elseif GetUnitAbilityLevel(target,'B014')>0 then
    set level = 3
    elseif GetUnitAbilityLevel(target,'B015')>0 then
    set level = 4
    else
    set level = 0
    endif
    
    set level = level + 1
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),GetUnitX(caster),GetUnitY(caster),0)
    call UnitAddAbility(u,'A06O')
    if level > GetUnitAbilityLevel(caster,'A06L') then
        set level = GetUnitAbilityLevel(caster,'A06L')
    endif
    call SetUnitAbilityLevel(u,'A06O',level)
    call IssueTargetOrder(u,"slow",target)
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_Flandre02_Slow_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_Flandre02_Slow)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Flandre02 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Flandre02 Skill
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Flandre02_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A06L'
endfunction

function Trig_Flandre02_Learn_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A06L')
    //========
    if GetUnitAbilityLevel(caster,'A06P')==0 then
        call UnitAddAbility(caster,'A06P')
        call UnitMakeAbilityPermanent(caster,true,'A06P')
    endif
    call SetUnitAbilityLevel(caster,'A06P',level)
    //========
    set caster = null
endfunction

//===========================================================================
function InitTrig_Flandre02_Skill takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Flandre04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Flandre04_Count takes nothing returns boolean
    local integer x
    local unit attacked = GetTriggerUnit()
    local unit attacker = GetAttacker()
    if GetUnitTypeId(attacker)!='U007' then
        set attacked = null
        set attacker = null
        return false
    endif
    if IsUnitType(attacked, UNIT_TYPE_STRUCTURE) then
        set attacked = null
        set attacker = null
        return false
    endif
    if GetUnitAbilityLevel(attacker,'A06Q')==0 then
        set attacked = null
        set attacker = null
        return false
    endif
    if GetUnitAbilityLevel(attacker,'B00G')>0 then
        set attacked = null
        set attacker = null
        return false
    endif
    set x = LoadInteger(udg_sht,GetHandleId(attacker),0)
    if x==1 then
        call DestroyEffect(LoadEffectHandle(udg_sht,GetHandleId(attacker),2))
        call DestroyEffect(LoadEffectHandle(udg_sht,GetHandleId(attacker),3))
    endif
    if x==0 then
        call UnitRemoveAbility(attacker,'A06Q')
    else
        call SaveInteger(udg_sht,GetHandleId(attacker),0,x-1)
    endif
    set attacked = null
    set attacker = null
    return false
endfunction

function Trig_Flandre04_ID takes nothing returns boolean
    return GetSpellAbilityId()=='A06M'
endfunction

function Trig_Flandre04_Filter takes nothing returns boolean
    if GetUnitTypeId(GetFilterUnit())!='U007' then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'B04E')==0 then
        return false
    endif
    return IsUnitIllusion(GetFilterUnit())
endfunction

function Trig_Flandre04_Clear takes nothing returns nothing
    call KillUnit(GetEnumUnit())
endfunction

function Trig_Flandre04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer task = GetHandleId(caster)
    local unit u
    local group g = CreateGroup()
    local boolexpr f = Filter(function Trig_Flandre04_Filter)
    local integer level = GetUnitAbilityLevel(caster,'A06M')
    local integer x
    local effect e1 = AddSpecialEffectTarget("Abilities\\Spells\\Orc\\TrollBerserk\\HeadhunterWEAPONSLeft.mdl",caster,"hand left")
    local effect e2 = AddSpecialEffectTarget("Abilities\\Spells\\Orc\\TrollBerserk\\HeadhunterWEAPONSRight.mdl",caster,"hand left")
    //========
    local real abilitycooldownlv01 = 135
    local real abilitycooldownlv02 = 135
    local real abilitycooldownlv03 = 135
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(caster),f)
    set x = CountUnitsInGroup(g)
    call ForGroup(g,function Trig_Flandre04_Clear)
    call SaveInteger(udg_sht,task,0,x+1)
    call SaveEffectHandle(udg_sht,task,2,e1)
    call SaveEffectHandle(udg_sht,task,3,e2)
    call UnitAddAbility(caster,'A06Q')
    call SetUnitAbilityLevel(caster,'A06R',level)
    call UnitMakeAbilityPermanent(caster,true,'A06Q')
    call UnitMakeAbilityPermanent(caster,true,'A06R')
    call DestroyBoolExpr(f)
    call DestroyGroup(g)
    //========
    call EnableTrigger(gg_trg_Flandre04)
    call PolledWait(15.0)
    call DisableTrigger(gg_trg_Flandre04)
    //========
    call UnitRemoveAbility(caster,'A06Q')
    call SaveInteger(udg_sht,task,0,0)
    call DestroyEffect(e1)
    call DestroyEffect(e2)
    //========
    set caster = null
    set u = null
    set f = null
    set g = null
    set e1 = null
    set e2 = null
endfunction

//===========================================================================
function InitTrig_Flandre04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Flandre
//===========================================================================
//TESH.scrollpos=1
//TESH.alwaysfold=0
function Trig_Initial_Flandre_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('U007')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    call UnitAddAbility(h,'A062')
    call UnitRemoveAbility(h,'A062')

    set gg_trg_FlandreBroker = CreateTrigger()
    call RegisterAnyUnitDamage(gg_trg_FlandreBroker)
    call TriggerAddCondition( gg_trg_FlandreBroker, Condition( function Trig_FlandreBroker_Conditions ) )
    call TriggerAddAction( gg_trg_FlandreBroker, function Trig_FlandreBroker_Actions )

    set gg_trg_Flandre01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Flandre01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Flandre01, Condition( function Trig_Flandre01_Conditions ) )
    call TriggerAddAction( gg_trg_Flandre01, function Trig_Flandre01_Actions )
    
    set gg_trg_Flandre02_Skill = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Flandre02_Skill, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Flandre02_Skill, Condition( function Trig_Flandre02_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Flandre02_Skill, function Trig_Flandre02_Learn_Actions )
    
    set gg_trg_Flandre02 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Flandre02, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Flandre02, Condition( function Trig_Flandre02_Conditions ) )
    call TriggerAddAction( gg_trg_Flandre02, function Trig_Flandre02_Slow_Actions )
    
    set gg_trg_Flandre04 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Flandre04, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Flandre04, Condition( function Trig_Flandre04_ID ) )
    call TriggerAddAction( gg_trg_Flandre04, function Trig_Flandre04_Actions )
    
    set gg_trg_Flandre04 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Flandre04, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Flandre04, Condition( function Trig_Flandre04_Count ) )
    call DisableTrigger(gg_trg_Flandre04)

    set h = null
//=====================================================================================================
endfunction

//===========================================================================
function InitTrig_Initial_Flandre takes nothing returns nothing
    set gg_trg_Initial_Flandre = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Flandre, function Trig_Initial_Flandre_Actions )
endfunction

//===========================================================================
// Trigger: SanaeEx
//===========================================================================
function Trig_SanaeEx_Actions takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    call THD_AddSpirit(GetOwningPlayer(caster),1)
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_SanaeEx takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Sanae01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Sanae01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A06U'
endfunction

function Trig_Sanae01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 15
    local real abilitycooldownlv03 = 15
    local real abilitycooldownlv04 = 15
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set u = CreateUnit(GetOwningPlayer(caster),'n019',tx,ty,270.0)
    call SetUnitAbilityLevel(u,'A06S',level)
    call SetUnitAbilityLevel(u,'A06T',level)
    call UnitApplyTimedLife(u,'B04F',4.2)
    //========
    set caster = null
    set u = null
endfunction

function InitTrig_Sanae01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Sanae02
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Sanae02_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A06V'
endfunction

function Trig_Sanae02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,0)
    local unit u
    local real px = LoadReal(udg_Hashtable,task,0)
    local real py = LoadReal(udg_Hashtable,task,1)
    local integer i = LoadInteger(udg_Hashtable,task,1)
    //========
    if i>0 then
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Monsoon\\MonsoonBoltTarget.mdl",px,py))
        call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\ChimaeraLightningMissile\\ChimaeraLightningMissile.mdl",px,py))
        if i==3 then
            set u = CreateUnit(GetOwningPlayer(caster),'n01A',px,py,0)
            call UnitAddAbility(u,'A06X')
            call SetUnitAbilityLevel(u,'A06X',GetUnitAbilityLevel(caster,'A06V'))
            call IssueImmediateOrder(u,"stomp")
            call UnitAddAbility(u,'A06Z')
            call SetUnitAbilityLevel(u,'A06Z',GetUnitAbilityLevel(caster,'A06V'))
            call IssueImmediateOrder(u,"fanofknives")
        endif
        call SaveInteger(udg_Hashtable,task,1,i - 1)
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Sanae02_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    //========
    local real abilitycooldownlv01 = 10
    local real abilitycooldownlv02 = 10
    local real abilitycooldownlv03 = 10
    local real abilitycooldownlv04 = 10
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call SaveUnitHandle(udg_Hashtable,task,0,caster)
    call SaveInteger(udg_Hashtable,task,1,5)
    call SaveReal(udg_Hashtable,task,0,GetSpellTargetX())
    call SaveReal(udg_Hashtable,task,1,GetSpellTargetY())
    call TimerStart(t,0.10,true,function Trig_Sanae02_Main)
    //========
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Sanae02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Sanae03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Sanae03_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A06W'
endfunction

function Trig_Sanae03_Effect takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i
    local unit h
    if level==GetUnitAbilityLevel(caster,'A06W') then
        set i = 0
        loop
            exitwhen i>=12
            set h = udg_PlayerHeroes[i]
            if h!= null and IsUnitAlive(caster) and IsUnitAlive(h) and IsUnitAlly(h,GetOwningPlayer(caster)) then
                call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Starfall\\StarfallTarget.mdl",h,"origin"))
                call SetUnitState(h,UNIT_STATE_MANA,GetUnitState(h,UNIT_STATE_MANA) + 30.0)
                call UnitRemoveBuffs(h,false,true) 
            endif
            set i = i + 1
        endloop
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set h = null
endfunction

function Trig_Sanae03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer level = GetUnitAbilityLevel(caster,'A06W')
    local real period = 34.0 - 4.0*level
    call SaveInteger(udg_ht,task,0,level)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call TimerStart(t,period,true,function Trig_Sanae03_Effect)
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Sanae03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Sanae04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Sanae04_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A06Y'
endfunction

function Trig_Sanae04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,0)
    local integer i = LoadInteger(udg_Hashtable,task,1)
    local integer z = LoadInteger(udg_Hashtable,task,2)
    local real x0 = GetUnitX(caster)
    local real y0 = GetUnitY(caster)
    local real x1
    local real y1
    local real x2
    local real y2
    local real cz = GetPositionZ(x0,y0)
    local real d = LoadReal(udg_Hashtable,task,0)
    local real f = LoadReal(udg_Hashtable,task,1)
    local real a
    local real b
    local integer j
    local lightning e
    //========
    if i<z and GetUnitCurrentOrder(caster)==OrderId("voodoo") then
    //--------
        if i<81 then
            if (i/20)*20==i then
                set j = i/20
                set a = f + 144*j
                set b = f + 144*(j+1)
                set x1 = x0 + d*CosBJ(a)
                set y1 = y0 + d*SinBJ(a)
                set x2 = x0 + d*CosBJ(b)
                set y2 = y0 + d*SinBJ(b)
                set e = AddLightningEx("HWPB",false,x1,y1,cz+10,x2,y2,cz+10)
                call SaveLightningHandle(udg_Hashtable,task,j + 1,e)
            endif
        endif
        call SaveInteger(udg_Hashtable,task,1,i + 1)
    else
        call DestroyTimer(t)
        call SetUnitInvulnerable(caster,false)
        if GetUnitCurrentOrder(caster)==OrderId("voodoo") then
            call IssueImmediateOrder(caster,"stop")
        endif
        set j = 5
        loop
            exitwhen j == 0
            set e = LoadLightningHandle(udg_Hashtable,task,j)
            call DestroyLightning(e)
            set j = j - 1
        endloop
        //--------
        call FlushChildHashtable(udg_Hashtable,task)
    endif
    //========
    set t = null
    set caster = null
    set e = null
endfunction

function Trig_Sanae04_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    local real abilitycooldownlv01 = 120
    local real abilitycooldownlv02 = 120
    local real abilitycooldownlv03 = 120
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    call CastSpell(caster,"神德--「五谷丰登」!!!")
    call SetUnitInvulnerable(caster,true)
    call SaveUnitHandle(udg_Hashtable,task,0,caster)
    call SaveInteger(udg_Hashtable,task,1,0)
    call SaveInteger(udg_Hashtable,task,2,R2I(80+100*(2.0+level)))
    call SaveReal(udg_Hashtable,task,0,270.0 + 150.0*level)
    call SaveReal(udg_Hashtable,task,1,GetUnitFacing(caster))
    call TimerStart(t,0.01,true,function Trig_Sanae04_Main)
    //========
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Sanae04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Sanae
//===========================================================================
//TESH.scrollpos=3
//TESH.alwaysfold=0
function Trig_Initial_Sanae_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H009')

    local timer t = CreateTimer()
    local integer task = GetHandleId(t)

    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    call SaveUnitHandle(udg_ht,task,0,h)
    call TimerStart(t,120.00,true,function Trig_SanaeEx_Actions)
    
    set gg_trg_Sanae01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Sanae01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Sanae01, Condition( function Trig_Sanae01_Conditions ) )
    call TriggerAddAction( gg_trg_Sanae01, function Trig_Sanae01_Actions )
    
    set gg_trg_Sanae02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Sanae02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Sanae02, Condition( function Trig_Sanae02_Conditions ) )
    call TriggerAddAction( gg_trg_Sanae02, function Trig_Sanae02_Actions )
    
    set gg_trg_Sanae03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Sanae03, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Sanae03, Condition( function Trig_Sanae03_Conditions ) )
    call TriggerAddAction( gg_trg_Sanae03, function Trig_Sanae03_Actions )
    
    set gg_trg_Sanae04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Sanae04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Sanae04, Condition( function Trig_Sanae04_Conditions ) )
    call TriggerAddAction( gg_trg_Sanae04, function Trig_Sanae04_Actions )
    
    set h = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Initial_Sanae takes nothing returns nothing
    set gg_trg_Initial_Sanae = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Sanae, function Trig_Initial_Sanae_Actions )
endfunction

//===========================================================================
// Trigger: TensiDS
//===========================================================================
function Trig_TensiDS_Conditions takes nothing returns boolean
    return IsUnitAlive(GetPlayerCharacter(GetTriggerPlayer()))
endfunction

function Trig_TensiDS_Actions takes nothing returns nothing
    local player who = GetTriggerPlayer()
    local unit caster = GetPlayerCharacter(who)
    local integer level01 = GetUnitAbilityLevel(caster,'A071')
    local real damage01 = RMaxBJ(320.00/GetHeroStr(caster,true),1.20)
    if level01 != 0 then
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00天道「天道是非之剑」间隔：|r" + R2S(damage01))
    endif
    set who = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_TensiDS takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Tensi01
//===========================================================================
function Trig_Tensi01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0T6'
endfunction

function Trig_Tensi01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,0)
    local real ox = LoadReal(udg_Hashtable,task,1)
    local real oy = LoadReal(udg_Hashtable,task,2)
    local real a = LoadReal(udg_Hashtable,task,3)
    local real px
    local real py
    local destructable w
    local integer z = LoadInteger(udg_Hashtable,task,4)
    local group m = LoadGroupHandle(udg_Hashtable,task,11)
    local integer level = LoadInteger(udg_Hashtable,task,6)
    local group g
    local unit v
    local unit u
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    //========
    if z>0 then
        set px = ox + 128*(11-z)*Cos(a)
        set py = oy + 128*(11-z)*Sin(a)
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Volcano\\VolcanoDeath.mdl",px,py))
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",px,py))
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,px,py,250.0,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and IsUnitInGroup(v,m)==false then
                call GroupAddUnit(m,v)
                set u = CreateUnit(GetOwningPlayer(caster),'n041',px,py,0)
                call UnitAddAbility(u,'A0T5')
                call SetUnitAbilityLevel(u,'A0T5',level)
                call IssueTargetOrder(u,"thunderbolt",v)
            endif
        endloop
        call DestroyGroup(g)
        set w = CreateDestructable('B01X',px,py,a*bj_RADTODEG,0.7,0)
        call SaveDestructableHandle(udg_Hashtable,task,z,w)
        set z = z - 1
        call SaveInteger(udg_Hashtable,task,4,z)
    elseif z==0 then
        set z = -1
        call SaveInteger(udg_Hashtable,task,4,z)
        call TimerStart(t,5.5,false,function Trig_Tensi01_Main)
    else
        call DestroyTimer(t)
        call DestroyGroup(m)
        set z = 10
        loop
            exitwhen z==0
            set w = LoadDestructableHandle(udg_Hashtable,task,z)
            call RemoveDestructable(w)
            set z = z - 1
        endloop
        call FlushChildHashtable(udg_Hashtable,task)
    endif
    //========
    set t = null
    set caster = null
    set w = null
    set m = null
    set g = null
    set v = null
    set u = null
    set iff = null
endfunction

function Trig_Tensi01_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px = GetSpellTargetX()
    local real py = GetSpellTargetY()
    local real a = Atan2(py-oy,px-ox)
    local group m = CreateGroup()
    local integer level = GetUnitAbilityLevel(caster,'A0T6')
    //========
    local real abilitycooldownlv01 = 16
    local real abilitycooldownlv02 = 15
    local real abilitycooldownlv03 = 14
    local real abilitycooldownlv04 = 13
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call SaveUnitHandle(udg_Hashtable,task,0,caster)
    call SaveReal(udg_Hashtable,task,1,ox)
    call SaveReal(udg_Hashtable,task,2,oy)
    call SaveReal(udg_Hashtable,task,3,a)
    call SaveInteger(udg_Hashtable,task,4,10)
    call SaveGroupHandle(udg_Hashtable,task,11,m)
    call SaveInteger(udg_Hashtable,task,6,level)
    call TimerStart(t,0.03,true,function Trig_Tensi01_Main)
    //========
    set t = null
    set caster = null
    set m = null
endfunction

//===========================================================================
function InitTrig_Tensi01 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Tensi02
//===========================================================================
function Trig_Tensi02_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A071'
endfunction

function Trig_Tensi02_Active_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetAttacker())=='H002' and IsUnitIllusion(GetAttacker())==false
endfunction

function Trig_Tensi02_Active_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local unit u
    //========
    call DisableTrigger(gg_trg_Tensi02)
    call SetUnitAnimation(caster,"attack slam")
    call TriggerSleepAction(0.1)
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),GetUnitX(target),GetUnitY(target),0.0)
    call UnitAddAbility(u,'A072')
    call SetUnitAbilityLevel(u,'A072',GetUnitAbilityLevel(caster,'A071'))
    call IssueImmediateOrder(u,"stomp")
    call SaveInteger(udg_sht,GetHandleId(caster),0,0)
    //========
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_Tensi02_Orbitting_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local integer i = LoadInteger(udg_ht,task,1)
    local integer k = LoadInteger(udg_sht,GetHandleId(caster),0)
    //========
    if IsUnitAliveBJ(caster) and k>=1 then
        set px = ox + 80.0*CosBJ(i*2.0)
        set py = oy + 80.0*SinBJ(i*2.0)
        call SetUnitX(u,px)
        call SetUnitY(u,py)
        call SaveInteger(udg_ht,task,1,i + 1)
    else
        call KillUnit(u)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Tensi02_Orbitting takes unit h returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit u
    //========
    set u = CreateUnit(GetOwningPlayer(h),'n02R',GetUnitX(h),GetUnitY(h),270.0)
    call SaveUnitHandle(udg_ht,task,0,h)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,1,0)
    call TimerStart(t,0.02,true,function Trig_Tensi02_Orbitting_Main)
    //========
    set t = null
    set h = null
    set u = null
endfunction

function Trig_Tensi02_Charge_Actions takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_sht,task,0)
    local integer k = LoadInteger(udg_sht,task,0)
    local real period
    //========
    if (not IsTriggerEnabled(gg_trg_Tensi02)) and IsUnitAliveBJ(caster) then
        if k==0 then
            call EnableTrigger(gg_trg_Tensi02)
            call SaveInteger(udg_sht,task,0,1)
            call SaveInteger(udg_sht,GetHandleId(caster),0,1)
            call TimerStart(t,1.0,false,function Trig_Tensi02_Charge_Actions)
            call SaveInteger(udg_sht,GetHandleId(caster),0,1)
            call Trig_Tensi02_Orbitting(caster)
        else
            call SaveInteger(udg_sht,task,0,0)
            set period = 320.00/GetHeroStr(caster,true)
            call TimerStart(t,period,false,function Trig_Tensi02_Charge_Actions)
        endif
    else
        if IsUnitAliveBJ(caster) then
            call TimerStart(t,1.0,false,function Trig_Tensi02_Charge_Actions)
        else
            call DisableTrigger(gg_trg_Tensi02)
            call SaveInteger(udg_sht,task,0,0)
            call TimerStart(t,1.0,false,function Trig_Tensi02_Charge_Actions)
        endif
    endif
    //========
    set t = null
    set caster = null
endfunction

function Trig_Tensi02_Learn takes nothing returns nothing
    local unit caster = GetLearningUnit()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local real period
    //========
    call SaveUnitHandle(udg_sht,task,0,caster)
    call SaveInteger(udg_sht,task,0,0)
    set period = 320.00/GetHeroStr(caster,true)
    call TimerStart(t,period,false,function Trig_Tensi02_Charge_Actions)
    //========
    call DestroyTrigger(gg_trg_Tensi02)
    set gg_trg_Tensi02 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Tensi02, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Tensi02, Condition( function Trig_Tensi02_Active_Conditions ) )
    call TriggerAddAction( gg_trg_Tensi02, function Trig_Tensi02_Active_Actions )
    call DisableTrigger(gg_trg_Tensi02)
    set task = GetHandleId(gg_trg_Tensi02)
    call SaveUnitHandle(udg_sht,task,0,caster)
    //========
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Tensi02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Tensi03
//===========================================================================
function TensiSkillThree2 takes nothing returns nothing
    local integer level
    local unit u = GetTriggerUnit()
    local trigger trg = GetTriggeringTrigger()
    if  GetTriggerEventId() == EVENT_UNIT_DAMAGED then
        set level = GetUnitAbilityLevel(u, 'A073') 
        call UnitGainLife(u, level * 2)
        call UnitGainMana(u, level * 2)
    endif
    call DisableTrigger(trg)
    call DestroyTrigger(trg)
    set u = null
    set trg = null
endfunction

function TensiSkillThree1 takes nothing returns nothing
    local trigger t = GetTriggeringTrigger()
    local integer task = GetHandleId(t)
    local unit hero = LoadUnitHandle(udg_Hashtable,task,1)
    local unit u = GetTriggerUnit()
    if u == hero then
        set t = CreateTrigger()
        call TriggerRegisterTimerEvent(t,2,false)
        call TriggerRegisterUnitEvent(t,hero , EVENT_UNIT_DAMAGED)
        call TriggerAddCondition(t,Condition(function TensiSkillThree2))
    endif
    set hero = null
    set t = null
    set u = null
endfunction

function Trig_Tensi03_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A073'
endfunction

function Trig_Tensi03_Actions takes nothing returns nothing
    local trigger t = CreateTrigger()
    local integer task = GetHandleId(t)
    local unit u = GetTriggerUnit()
    call SaveUnitHandle(udg_Hashtable,task,1, u)
    call TriggerRegisterAnyUnitEventBJ(t, EVENT_PLAYER_UNIT_ATTACKED)
    call TriggerAddCondition(t,Condition(function TensiSkillThree1))
    call DisableTrigger(gg_trg_Tensi03)
    call DestroyTrigger(gg_trg_Tensi03)
    set t = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Tensi03 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Tensi04
//===========================================================================
function Trig_Tensi04_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0AJ'
endfunction

function Trig_Tensi04_Target takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) then
        return false
    elseif IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    elseif GetOwningPlayer(GetFilterUnit())==Player(12) then
        return false
    elseif GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return IsUnitVisible(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))
endfunction

function Trig_Tensi04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local group g
    local unit u
    local unit v
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i==0 and IsUnitAlive(caster) then
        call SaveInteger(udg_ht,task,1,i + 1)
        call SetCineFilterTexture("ReplaceableTextures\\CameraMasks\\White_mask.blp")
        call SetCineFilterBlendMode(BLEND_MODE_BLEND)
        call SetCineFilterTexMapFlags(TEXMAP_FLAG_NONE)
        call SetCineFilterStartUV(0, 0, 1, 1)
        call SetCineFilterEndUV(0, 0, 1, 1)
        call SetCineFilterStartColor(255,32,0,0)
        call SetCineFilterEndColor(255,32,0,240)
        call SetCineFilterDuration(0.2)
        call DisplayCineFilter(true)
        call TimerStart(t,0.4,false,function Trig_Tensi04_Main)
    elseif i==1 then
        if IsUnitAlive(caster) then
            call SaveInteger(udg_ht,task,1,i + 1)
            call SetCineFilterTexture("ReplaceableTextures\\CameraMasks\\White_mask.blp")
            call SetCineFilterBlendMode(BLEND_MODE_BLEND)
            call SetCineFilterTexMapFlags(TEXMAP_FLAG_NONE)
            call SetCineFilterStartUV(0, 0, 1, 1)
            call SetCineFilterEndUV(0, 0, 1, 1)
            call SetCineFilterStartColor(255,32,0,240)
            call SetCineFilterEndColor(255,32,0,0)
            call SetCineFilterDuration(1.5)
            call DisplayCineFilter(true)
            call TimerStart(t,0.3,false,function Trig_Tensi04_Main)
        else
            call SaveInteger(udg_ht,task,1,3)
            call SetCineFilterTexture("ReplaceableTextures\\CameraMasks\\White_mask.blp")
            call SetCineFilterBlendMode(BLEND_MODE_BLEND)
            call SetCineFilterTexMapFlags(TEXMAP_FLAG_NONE)
            call SetCineFilterStartUV(0, 0, 1, 1)
            call SetCineFilterEndUV(0, 0, 1, 1)
            call SetCineFilterStartColor(255,32,0,220)
            call SetCineFilterEndColor(255,32,0,0)
            call SetCineFilterDuration(0.3)
            call DisplayCineFilter(true)
            call TimerStart(t,0.3,false,function Trig_Tensi04_Main)
        endif
    elseif i==2 then
        call SaveInteger(udg_ht,task,1,i + 1)
        
        set g = LoadGroupHandle(udg_ht,task,1)
        loop
            set v = FirstOfGroup(g)
            exitwhen v==null
            set u = CreateUnit(GetOwningPlayer(caster),'n01W',GetUnitX(v)-5.0,GetUnitY(v),0.0)
            call UnitAddAbility(u,'A0AL')
            call SetUnitAbilityLevel(u,'A0AL',level)
            call IssueTargetOrder(u,"fingerofdeath",v)
            call GroupRemoveUnit(g,v)
        endloop
        call DestroyGroup(g)
        
        set i = 0
        loop
            exitwhen i>=12
            set v = udg_PlayerHeroes[i]
            if v!= null and IsUnitAlive(v) and IsUnitEnemy(v,GetOwningPlayer(caster)) then
                set u = CreateUnit(GetOwningPlayer(caster),'n01W',GetUnitX(v)-5.0,GetUnitY(v),0.0)
                call UnitAddAbility(u,'A0AK')
                call SetUnitAbilityLevel(u,'A0AK',level)
                call IssueTargetOrder(u,"fingerofdeath",v)
                call UnitDamageTarget(caster,v,100*(level+1),false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS) 
            endif
            set i = i + 1
        endloop
        
        call TimerStart(t,1.0,false,function Trig_Tensi04_Main)
    else
        call SetUnitTimeScale(caster,1.0)
        call DisplayCineFilter(false)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        call EnableTrigger(gg_trg_Tensi04)
    endif
    //========
    set t = null
    set caster = null
    set g = null
    set u = null
    set v = null
endfunction

function Trig_Tensi04_FOW takes nothing returns nothing
    local timer t = GetExpiredTimer()
    call FogEnable(true)
    call FogMaskEnable(true)
    call DestroyTimer(t)
    set t = null
endfunction

function Trig_Tensi04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local group g
    local timer t
    local integer task
    local unit k
    //========
    local real abilitycooldownlv01 = 120
    local real abilitycooldownlv02 = 120
    local real abilitycooldownlv03 = 120
    //========
    if GetTriggerEventId()==EVENT_UNIT_SPELL_ENDCAST then
        set caster = null
        set g = null
        set t = null
        return
    endif
    if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
        if UnitHasItemOfTypeBJ(caster, 'I00B') then
            if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
            endif
        endif
        set t = CreateTimer()
        call FogEnable(false)
        call FogMaskEnable(false)
        call TimerStart(t,4.0,false,function Trig_Tensi04_FOW)
        set caster = null
        set g = null
        set t = null
        return
    endif
    //========
    call DisableTrigger(gg_trg_Tensi04)
    set t = CreateTimer()
    set task = GetHandleId(t)
    set g = GetUnitsInRectMatching(bj_mapInitialPlayableArea,Filter(function Trig_Tensi04_Target))
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveGroupHandle(udg_ht,task,1,g)
    call SaveInteger(udg_ht,task,0,GetUnitAbilityLevel(caster,'A0AJ'))
    call SaveInteger(udg_ht,task,1,0)
    call SetUnitTimeScale(caster,0.0)
    call TimerStart(t,0.3,false,function Trig_Tensi04_Main)
    call CastSpell(caster,"全人类的-绯-想-天-!!!")
    set k = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(caster)-5.0,GetUnitY(caster),0.0)
    call UnitAddAbility(k,'A0MK')
    //========
    set caster = null
    set g = null
    set t = null
    set k = null
endfunction

//===========================================================================
function InitTrig_Tensi04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Init Tensi
//===========================================================================
function Trig_Init_Tensi_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H002')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_TensiDS = CreateTrigger()
    call TriggerRegisterPlayerEvent( gg_trg_TensiDS, GetOwningPlayer(h), EVENT_PLAYER_END_CINEMATIC)
    call TriggerAddCondition( gg_trg_TensiDS, Condition( function Trig_TensiDS_Conditions ) )
    call TriggerAddAction( gg_trg_TensiDS, function Trig_TensiDS_Actions )

    set gg_trg_Tensi01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Tensi01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Tensi01, Condition( function Trig_Tensi01_Conditions ) )
    call TriggerAddAction( gg_trg_Tensi01, function Trig_Tensi01_Actions )
    
    set gg_trg_Tensi02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Tensi02, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Tensi02, Condition( function Trig_Tensi02_Conditions ) )
    call TriggerAddAction( gg_trg_Tensi02, function Trig_Tensi02_Learn )
    
    set gg_trg_Tensi03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Tensi03, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Tensi03, Condition( function Trig_Tensi03_Conditions ) )
    call TriggerAddAction( gg_trg_Tensi03, function Trig_Tensi03_Actions )
    
    set gg_trg_Tensi04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Tensi04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerRegisterUnitEvent( gg_trg_Tensi04, h, EVENT_UNIT_SPELL_ENDCAST )
    call TriggerRegisterUnitEvent( gg_trg_Tensi04, h, EVENT_UNIT_SPELL_FINISH )
    call TriggerAddCondition( gg_trg_Tensi04, Condition( function Trig_Tensi04_Conditions ) )
    call TriggerAddAction( gg_trg_Tensi04, function Trig_Tensi04_Actions )
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Tensi takes nothing returns nothing
    set gg_trg_Init_Tensi = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Tensi, function Trig_Init_Tensi_Actions )
endfunction

//===========================================================================
// Trigger: UtsuhoEx
//===========================================================================
function Trig_UtsuhoEx_Actions takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local player w = GetOwningPlayer(caster)
    local integer level
    local group g
    local unit v
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    //========
    call SetUnitAbilityLevel(caster,'A05Z',1 + R2I(GetHeroLevel(caster)/3))
    set level = GetUnitAbilityLevel(caster,'A05Z')
    //========
    set g = CreateGroup()
    call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),99999.0,iff)
    if IsUnitAlive(caster) then
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitInRange(caster,v,900.0) and IsUnitAlive(v) and IsUnitType(v,UNIT_TYPE_SUMMONED)==false then
                if GetUnitAbilityLevel(v,'A061')==0 then
                    call UnitAddAbility(v,'A061')
                    call UnitMakeAbilityPermanent(v,true,'A061')
                    call SetPlayerAbilityAvailableBJ(false,'A061',GetOwningPlayer(v))
                endif
                call SetUnitAbilityLevel(v,'A060',level)
            elseif GetUnitAbilityLevel(v,'A061')>0 then
                call UnitRemoveAbility(v,'A061')
            endif
        endloop
    else
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if GetUnitAbilityLevel(v,'A061')>0 then
                call UnitRemoveAbility(v,'A061')
            endif
        endloop
    endif
    call DestroyGroup(g)
    //========
    set t = null
    set caster = null
    set w = null
    set g = null
    set v = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_UtsuhoEx takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Utsuho01
//===========================================================================
//TESH.scrollpos=33
//TESH.alwaysfold=0
function Trig_Utsuho01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0QN'
endfunction

function Trig_Utsuho01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local unit u
    local unit w
    //========
    local real abilitycooldownlv01 = 10
    local real abilitycooldownlv02 = 9
    local real abilitycooldownlv03 = 8
    local real abilitycooldownlv04 = 7
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set u = null
            set w = null
            return
        endif
    endif
    //========
    set w = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0)
    call UnitAddAbility(w,'A074')
    call SetUnitAbilityLevel(w,'A074',level)
    call IssueTargetOrder(w,"acidbomb",target)

    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,0.0)
    call UnitAddAbility(u,'A075')
    call SetUnitAbilityLevel(u,'A075',level)
    call IssueTargetOrder(u,"fingerofdeath",target)

    set caster = null
    set target = null
    set u = null
    set w = null
endfunction

//===========================================================================
function InitTrig_Utsuho01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Utsuho02
//===========================================================================
//TESH.scrollpos=46
//TESH.alwaysfold=0
function Trig_Utsuho02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A076'
endfunction

function Trig_Utsuho02_Main_Target takes nothing returns boolean
    return true
endfunction

function Trig_Utsuho02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local integer i = LoadInteger(udg_ht,task,1)
    local real damage = LoadReal(udg_ht,task,2)
    local group g
    local unit v
    local boolexpr iff
    //========
    if i>0 and IsUnitAlive(caster) and GetUnitAbilityLevel(caster,'B01F')>0 then
        call SetUnitX(u,GetUnitX(caster))
        call SetUnitY(u,GetUnitY(caster))
        if i/20*20 == i then
            call UnitDamageTarget(caster,caster,damage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
            set g = CreateGroup()
            set iff = Filter(function Trig_Utsuho02_Main_Target)
            call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),450,iff)
            loop
                set v = FirstOfGroup(g)
                exitwhen v == null
                call GroupRemoveUnit(g,v)
                if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and v != caster then
                    call UnitDamageTarget(u,v,damage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
                endif
            endloop
            call DestroyGroup(g)
        endif
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call RemoveUnit(u)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set g = null
    set v = null
    set iff = null
endfunction

function Trig_Utsuho02_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real damage
    local unit u
    local integer level = GetUnitAbilityLevel(caster,'A076')
    local integer time
    //========
    local real abilitycooldownlv01 = 10
    local real abilitycooldownlv02 = 10
    local real abilitycooldownlv03 = 10
    local real abilitycooldownlv04 = 10
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    
    if level == 1 then
        set time = 10
        set damage = 5
    elseif level ==2 then
        set time = 10
        set damage = 10
    elseif level ==3 then
        set time = 10
        set damage = 20
    else
        set time = 10
        set damage = 40
    endif
    
    set u = CreateUnit(GetOwningPlayer(caster),'n00X',ox,oy,0)
    call UnitAddAbility(u,'A077')
    call SetUnitAbilityLevel(u,'A077',level)
    call PauseUnit(u,true)
    call PauseUnit(u,false)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,1,time*20)
    call SaveReal(udg_ht,task,2,damage)
    call TimerStart(t,0.05,true,function Trig_Utsuho02_Main)
    
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,0)
    call UnitAddAbility(u,'A078')
    call SetUnitAbilityLevel(u,'A078',level)
    call IssueTargetOrder(u,"rejuvination",caster)
    //========
    set t = null
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Utsuho02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Utsuho03
//===========================================================================
//TESH.scrollpos=51
//TESH.alwaysfold=0
function Trig_Utsuho03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A079'
endfunction

function Trig_Utsuho03_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer c = LoadInteger(udg_ht,task,2)
    local real d = LoadReal(udg_ht,task,0)
    local real h = LoadReal(udg_ht,task,1)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local unit u
    local integer j
    //========
    if IsUnitType(caster,UNIT_TYPE_DEAD)==false and h<5000.0 then
        if h > c*500.0 then
            set u = CreateUnit(GetOwningPlayer(caster),'h00R',ox,oy,270.0)
            set px = 3.2 + c*0.2
            call SetUnitScale(u,px,px,px)
            set udg_SK_Utsuho03_Units[c] = u
            call SaveInteger(udg_ht,task,2,c + 1)
        endif
        loop
            exitwhen c==0
            set c = c - 1
            call SetUnitX(udg_SK_Utsuho03_Units[c],ox)
            call SetUnitY(udg_SK_Utsuho03_Units[c],oy)
        endloop
        call SaveReal(udg_ht,task,1,h + d)
    elseif 5000.0<=h and i<5 then
        if i==0 then
            call SaveReal(udg_ht,task,2,ox)
            call SaveReal(udg_ht,task,3,oy)
        else
            set ox = LoadReal(udg_ht,task,2)
            set oy = LoadReal(udg_ht,task,3)
        endif
        if i==1 then
            set u = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,270.0)
            call UnitAddAbility(u,'A07A')
            call SetUnitAbilityLevel(u,'A07A',c)
            call IssueImmediateOrder(u,"thunderclap")
        endif
        if i==4 then
            set j = 0
            loop
                set d = j*12.0 + 0.0
                set px = ox + 80.0*(i + 1)*CosBJ(d)
                set py = oy + 80.0*(i + 1)*SinBJ(d)
                call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Incinerate\\FireLordDeathExplode.mdl",px,py))
                call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HCancelDeath\\HCancelDeath.mdl",px,py))
                set d = j*12.0 + 120.0
                set px = ox + 80.0*(i + 1)*CosBJ(d)
                set py = oy + 80.0*(i + 1)*SinBJ(d)
                call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Incinerate\\FireLordDeathExplode.mdl",px,py))
                call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HCancelDeath\\HCancelDeath.mdl",px,py))
                set d = j*12.0 + 240.0
                set px = ox + 80.0*(i + 1)*CosBJ(d)
                set py = oy + 80.0*(i + 1)*SinBJ(d)
                call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Incinerate\\FireLordDeathExplode.mdl",px,py))
                call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HCancelDeath\\HCancelDeath.mdl",px,py))
                set j = j + 1
                exitwhen j>5
            endloop
        else
            set j = 0
            loop
                set px = ox + 80.0*(i + 1)*CosBJ(j*60.0)
                set py = oy + 80.0*(i + 1)*SinBJ(j*60.0)
                call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Incinerate\\FireLordDeathExplode.mdl",px,py))
                call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HCancelDeath\\HCancelDeath.mdl",px,py))
                set j = j + 1
                exitwhen j>5
            endloop
        endif
        call SaveInteger(udg_ht,task,1,i + 1)
        call TimerStart(t,0.1,false,function Trig_Utsuho03_Main)
    else
        loop
            exitwhen c==0
            set c = c - 1
            call KillUnit(udg_SK_Utsuho03_Units[c])
        endloop
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Utsuho03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local real d = 100.0/(25.0-level*5.0)
    //========
    local real abilitycooldownlv01 = 20.5
    local real abilitycooldownlv02 = 17.0
    local real abilitycooldownlv03 = 13.5
    local real abilitycooldownlv04 = 10.0
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,1,0)
    call SaveInteger(udg_ht,task,2,0)
    call SaveReal(udg_ht,task,0,d)
    call SaveReal(udg_ht,task,1,0.0)
    call TimerStart(t,0.02,true,function Trig_Utsuho03_Main)
    //========
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Utsuho03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Utsuho04
//===========================================================================
function Trig_Utsuho04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A07B'
endfunction

function Trig_Utsuho04_Target takes nothing returns boolean
    if GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)<=0 then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(LoadUnitHandle(udg_ht,GetHandleId(GetExpiredTimer()),0))) then
        return false
    endif
    return true
endfunction

function Trig_Utsuho04_Damage takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = GetEnumUnit()
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local real damage = 300 * (level+1) * i / 630
    if IsUnitType(target,UNIT_TYPE_MECHANICAL) then
        set damage = damage / 2
    endif
    call UnitDamageTarget(caster,target,damage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    set caster = null
    set target = null
    set t = null
endfunction

function Trig_Utsuho04_Explosion takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local real x = LoadReal(udg_ht,task,0)
    local real y = LoadReal(udg_ht,task,1)
    local real px
    local real py
    local real a
    local integer c = LoadInteger(udg_ht,task,2)
    local integer i
    local integer z
    local group g
    local boolexpr f
    //========
    if c>0 then
        
        set z = 24 - (c - 1)*2
        set a = 360.0/I2R(z)
        set i = 1
        loop
            exitwhen i>z
            set px = x + I2R(9-c)*75.0*CosBJ(a*i)
            set py = y + I2R(9-c)*75.0*SinBJ(a*i)
            call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl",px,py))
            set i = i + 1
        endloop
        
        if c==8 then
            set g = CreateGroup()
            set f = Filter(function Trig_Utsuho04_Target)
            call GroupEnumUnitsInRange(g,x,y,750,f)
            call ForGroup(g,function Trig_Utsuho04_Damage)
            call DestroyGroup(g)
            call DestroyBoolExpr(f)
        endif
        
        call SaveInteger(udg_ht,task,2,c - 1)
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set g = null
    set f = null
endfunction

function Trig_Utsuho04_SunFallen takes nothing returns nothing 
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local real i = LoadReal(udg_ht,task,0)
    local real k = LoadReal(udg_ht,task,1)
    if i > 0 then
        set i = i - 16
        call SetUnitFlyHeight(udg_SK_Utsuho04_Sun[0],i,0)
        call SetUnitFlyHeight(udg_SK_Utsuho04_Sun[1],i,0)
        call SetUnitFlyHeight(udg_SK_Utsuho04_Sun[2],i,0)
        call SetUnitFlyHeight(udg_SK_Utsuho04_Sun[3],i,0)
        call SetUnitScale(udg_SK_Utsuho04_Sun[0],20*(i/k*0.5+0.5),20*(i/k*0.5+0.5),20*(i/k*0.5+0.5))
        call SetUnitScale(udg_SK_Utsuho04_Sun[1],19*(i/k*0.5+0.5),19*(i/k*0.5+0.5),19*(i/k*0.5+0.5))
        call SetUnitScale(udg_SK_Utsuho04_Sun[2],18*(i/k*0.5+0.5),18*(i/k*0.5+0.5),18*(i/k*0.5+0.5))
        call SetUnitScale(udg_SK_Utsuho04_Sun[3],17*(i/k*0.5+0.5),17*(i/k*0.5+0.5),17*(i/k*0.5+0.5))
        call SaveReal(udg_ht,task,0,i)
    else
        call KillUnit(udg_SK_Utsuho04_Sun[0])
        call KillUnit(udg_SK_Utsuho04_Sun[1])
        call KillUnit(udg_SK_Utsuho04_Sun[2])
        call KillUnit(udg_SK_Utsuho04_Sun[3])
        call KillUnit(udg_SK_Utsuho04_Sun[4])
        call KillUnit(udg_SK_Utsuho04_Sun[5])
        call KillUnit(udg_SK_Utsuho04_Sun[6])
        call RemoveUnit(udg_SK_Utsuho04_Sun[0])
        call RemoveUnit(udg_SK_Utsuho04_Sun[1])
        call RemoveUnit(udg_SK_Utsuho04_Sun[2])
        call RemoveUnit(udg_SK_Utsuho04_Sun[3])
        call RemoveUnit(udg_SK_Utsuho04_Sun[4])
        call RemoveUnit(udg_SK_Utsuho04_Sun[5])
        call RemoveUnit(udg_SK_Utsuho04_Sun[6])
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
endfunction

function Trig_Utsuho04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local timer t2
    local integer task2
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local real x = LoadReal(udg_ht,task,0)
    local real y = LoadReal(udg_ht,task,1)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local unit u
    local group g
    local unit v
    local boolexpr iff
    local real px
    local real py
    local real a
    //========
    if i < 630 and GetUnitCurrentOrder(caster)==OrderId("cyclone") then
        call SaveInteger(udg_ht,task,1,i + 1)
        if i < 240 then
            call SetUnitFlyHeight(udg_SK_Utsuho04_Sun[0],R2I(i*1.25),0)
            call SetUnitFlyHeight(udg_SK_Utsuho04_Sun[1],R2I(i*1.25),0)
            call SetUnitFlyHeight(udg_SK_Utsuho04_Sun[2],R2I(i*1.25),0)
            call SetUnitFlyHeight(udg_SK_Utsuho04_Sun[3],R2I(i*1.25),0)
        endif
        set g = CreateGroup()
        set iff = Filter(function Trig_Utsuho04_Target)
        call GroupEnumUnitsInRange(g,x,y,750,iff)
        if i/5*5 == i then
            loop
                set v = FirstOfGroup(g)
                exitwhen v == null
                call GroupRemoveUnit(g,v)
                set a = Atan2(GetUnitY(v)-y,GetUnitX(v)-x)
                set px = GetUnitX(v) - (110 + level*30) * i*2/630 * Cos(a) / 20.00
                set py = GetUnitY(v) - (110 + level*30) * i*2/630 * Sin(a) / 20.00
                if SquareRoot((px-x)*(px-x)+(py-y)*(py-y)) >= 80 and IsUnitType(v,UNIT_TYPE_MECHANICAL) == false and GetUnitFlag(v,CS_YUUGI())==false and GetUnitTypeId(v)!='U00M' then
                    call SetUnitXYGround(v,px,py)
                endif
                if SquareRoot((px-x)*(px-x)+(py-y)*(py-y)) <= 250 then
                    if IsUnitType(v,UNIT_TYPE_MECHANICAL) then
                        call UnitDamageTarget(udg_SK_Utsuho04_Sun[0],v,40*(level+1)/20/3,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)        
                    else
                        call UnitDamageTarget(udg_SK_Utsuho04_Sun[0],v,40*(level+1)/20,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)            
                    endif
                endif
            endloop
        endif
    else
        call DestroyEffect(LoadEffectHandle(udg_ht,task,1))
        call DestroyEffect(LoadEffectHandle(udg_ht,task,2))
        set u = CreateUnit(GetOwningPlayer(caster),'n01H',x,y,0)
        call UnitApplyTimedLife(u,'BTLF',15.0)
        call SetUnitTimeScale(u,3.00)
        call SetUnitVertexColor(u,255,255,255,R2I(255*i/630))
        set u = CreateUnit(GetOwningPlayer(caster),'n01I',x,y,0)
        call UnitApplyTimedLife(u,'BTLF',15.0)
        call SetUnitTimeScale(u,0.20)
        call SetUnitVertexColor(u,255,255,255,R2I(255*i/630))
        set u = CreateUnit(GetOwningPlayer(caster),'n01I',x,y,0)
        call UnitApplyTimedLife(u,'BTLF',15.0)
        call SetUnitTimeScale(u,0.10)
        call SetUnitVertexColor(u,255,255,255,R2I(255*i/630))
        set u = CreateUnit(GetOwningPlayer(caster),'n01I',x,y,0)
        call UnitApplyTimedLife(u,'BTLF',15.0)
        call SetUnitTimeScale(u,0.08)
        call SetUnitVertexColor(u,255,255,255,R2I(255*i/630))
        set u = CreateUnit(GetOwningPlayer(caster),'n01I',x,y,0)
        call UnitApplyTimedLife(u,'BTLF',15.0)
        call SetUnitTimeScale(u,0.08)
        call SetUnitVertexColor(u,255,255,255,R2I(255*i/630))
        set u = CreateUnit(GetOwningPlayer(caster),'n01I',x,y,0)
        call UnitApplyTimedLife(u,'BTLF',15.0)
        call SetUnitTimeScale(u,0.08)
        call SetUnitVertexColor(u,255,255,255,R2I(255*i/630))
        call SaveInteger(udg_ht,task,1,i)
        call SaveInteger(udg_ht,task,2,8)
        call TimerStart(t,0.27,true,function Trig_Utsuho04_Explosion)
        call DebugMsg("Damage:" + R2S(i/630 * (level+1) * 300))
        set t2 = CreateTimer()
        set task2 = GetHandleId(t2)
        call SaveReal(udg_ht,task2,0,RMinBJ(i*1.25,300))
        call SaveReal(udg_ht,task2,1,RMinBJ(i*1.25,300))
        call TimerStart(t2,0.01,true,function Trig_Utsuho04_SunFallen)
    endif
    //========
    set t = null
    set t2 = null
    set caster = null
    set u = null
    set g = null
    set v = null
    set iff = null
endfunction

function Trig_Utsuho04_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A07B')
    local real x = GetSpellTargetX()
    local real y = GetSpellTargetY()
    local effect e1 = AddSpecialEffect("AuraNuke.mdl",x,y)
    local effect e2 = AddSpecialEffect("SelfbuffFX.mdx",x,y)
    //========
    local real abilitycooldownlv01 = 120
    local real abilitycooldownlv02 = 120
    local real abilitycooldownlv03 = 120
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    call DisplayTextToForce(GetPlayersAll(),"|cFFFFCC00================|r")
    call DisplayTextToForce(GetPlayersAll(),"|cFFFFCC00    CAUTION!    |r")
    call DisplayTextToForce(GetPlayersAll(),"|cFFFFCC00================|r")
    call PingMinimapEx(x,y,6.0,0xFF,0xFF,0xEE,true)

    set udg_SK_Utsuho04_Sun[0] = CreateUnit(GetOwningPlayer(caster),'h01L',x,y,0)
    set udg_SK_Utsuho04_Sun[1] = CreateUnit(GetOwningPlayer(caster),'h01L',x,y,90)
    set udg_SK_Utsuho04_Sun[2] = CreateUnit(GetOwningPlayer(caster),'h01L',x,y,180)
    set udg_SK_Utsuho04_Sun[3] = CreateUnit(GetOwningPlayer(caster),'h01L',x,y,270)
    call SetUnitScale(udg_SK_Utsuho04_Sun[0],20,20,20)
    call SetUnitScale(udg_SK_Utsuho04_Sun[1],19,19,19)
    call SetUnitScale(udg_SK_Utsuho04_Sun[2],18,18,18)
    call SetUnitScale(udg_SK_Utsuho04_Sun[3],17,17,17)
    set udg_SK_Utsuho04_Sun[4] = CreateUnit(GetOwningPlayer(caster),'h01M',x,y,0)
    set udg_SK_Utsuho04_Sun[5] = CreateUnit(GetOwningPlayer(caster),'h01M',x,y,120)
    set udg_SK_Utsuho04_Sun[6] = CreateUnit(GetOwningPlayer(caster),'h01M',x,y,240)

    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveEffectHandle(udg_ht,task,1,e1)
    call SaveEffectHandle(udg_ht,task,2,e2)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,0)
    call SaveInteger(udg_ht,task,2,8)
    call SaveReal(udg_ht,task,0,x)
    call SaveReal(udg_ht,task,1,y)
    call TimerStart(t,0.01,true,function Trig_Utsuho04_Main)
    //========
    set t = null
    set caster = null
    set e1 = null
    set e2 = null
endfunction

function InitTrig_Utsuho04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Utsuho
//===========================================================================
//TESH.scrollpos=12
//TESH.alwaysfold=0
function Trig_Initial_Utsuho_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('O009')
    local timer t
    local integer task
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set t = CreateTimer()
    set task = GetHandleId(t)
    call SaveUnitHandle(udg_ht,task,0,h)
    call TimerStart(t,1.0,true,function Trig_UtsuhoEx_Actions)
    
    set gg_trg_Utsuho01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Utsuho01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Utsuho01, Condition( function Trig_Utsuho01_Conditions ) )
    call TriggerAddAction( gg_trg_Utsuho01, function Trig_Utsuho01_Actions )
    
    set gg_trg_Utsuho02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Utsuho02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Utsuho02, Condition( function Trig_Utsuho02_Conditions ) )
    call TriggerAddAction( gg_trg_Utsuho02, function Trig_Utsuho02_Actions )

    set gg_trg_Utsuho03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Utsuho03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Utsuho03, Condition( function Trig_Utsuho03_Conditions ) )
    call TriggerAddAction( gg_trg_Utsuho03, function Trig_Utsuho03_Actions )

    set gg_trg_Utsuho04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Utsuho04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Utsuho04, Condition( function Trig_Utsuho04_Conditions ) )
    call TriggerAddAction( gg_trg_Utsuho04, function Trig_Utsuho04_Actions )
    
    call UnitMakeAbilityPermanent(h,true,'A0IM')
    call UnitMakeAbilityPermanent(h,true,'A0IO')
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Utsuho takes nothing returns nothing
    set gg_trg_Initial_Utsuho = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Utsuho, function Trig_Initial_Utsuho_Actions )
endfunction//===========================================================================
// Trigger: Rumia01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Rumia01_Conditions takes nothing returns boolean
    if GetSpellAbilityId() != 'A07C' then
        return false
    endif
    return GetUnitTypeId(GetTriggerUnit())=='E00I'
endfunction

function Trig_Rumia01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,0)
    local unit u = LoadUnitHandle(udg_Hashtable,task,1)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer i = LoadInteger(udg_Hashtable,task,1)
    //========
    if IsUnitAlive(caster) and (i<10 or GetUnitTypeId(caster)=='E00J') then
        call SetUnitX(u,ox)
        call SetUnitY(u,oy)
        if i/20*20 == i then
            call IssuePointOrder(u,"silence",ox,oy)
        endif
        call SaveInteger(udg_Hashtable,task,1,i + 1)
    else
        call RemoveUnit(u)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,task)
    call DebugMsg("OFF")
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Rumia01_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local unit u = CreateUnit(GetOwningPlayer(caster),'n01K',ox,oy,90.0)
    local integer level = GetUnitAbilityLevel(caster,'A07C')
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 15
    local real abilitycooldownlv03 = 15
    local real abilitycooldownlv04 = 15
if GetUnitTypeId(caster)=='E00J' then
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
endif
    //========
    call DebugMsg("ON")
    call SaveUnitHandle(udg_Hashtable,task,0,caster)
    call SaveUnitHandle(udg_Hashtable,task,1,u)
    call SaveInteger(udg_Hashtable,task,1,0)
    call TimerStart(t,0.02,true,function Trig_Rumia01_Main)
    //========
    set t = null
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Rumia01 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Rumia02
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Rumia02_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A07E'
endfunction

function Trig_Rumia02_Actions takes nothing returns nothing
    local unit u = GetTriggerUnit() 
    call UnitAddAbility( u,'A07F' )
    call SetUnitAbilityLevel( u,'A07F', GetUnitAbilityLevel(u,'A07E') )
    call UnitMakeAbilityPermanent( u, true, 'A07F' )
    set u = null
endfunction

//===========================================================================
function InitTrig_Rumia02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Rumia03
//===========================================================================
//TESH.scrollpos=28
//TESH.alwaysfold=0
function RumiaSpeedUpAtNight takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local unit hero = LoadUnitHandle(udg_Hashtable,GetHandleId(trg), 1)
    local integer level = GetUnitAbilityLevel(hero, 'A07G')
    local player PLY = GetOwningPlayer(hero)
    if IsUnitType(hero,UNIT_TYPE_DEAD) then
        set trg = null
        set hero = null
        set PLY = null
        return
    endif
    if IsDayTime() == false and GetUnitAbilityLevel(hero, 'A07H') != level*2 then
        call UnitAddAbility(hero, 'A07I')
        call SetUnitAbilityLevel(hero, 'A07H', level*2)
        call SetPlayerAbilityAvailable( PLY,'A07I',false)
        
        call DebugMsg("on")
        
    elseif IsDayTime() == true and GetUnitAbilityLevel(hero, 'A07H') != 5 then
        call UnitRemoveAbility(hero, 'A07H')
        call UnitRemoveAbility(hero, 'A07I')
    endif
    set trg = null
    set hero = null
    set PLY = null
endfunction

function RumiaLearnSkillThreeConditions takes nothing returns boolean
    return GetLearnedSkill() == 'A07G'
endfunction

function RumiaLearnSkillThreeActions takes nothing returns nothing
    local trigger trg
    local unit u = GetTriggerUnit()
    if GetUnitAbilityLevel(u, 'A07G') != 1 or IsUnitIllusion(u) then
        set trg = null
        set u = null
        return
    endif
    call UnitMakeAbilityPermanent(u, true, 'A07G')
    set trg = CreateTrigger()
    call SaveUnitHandle(udg_Hashtable,GetHandleId(trg), 1, u)
    call TriggerRegisterTimerEvent(trg, 2., true)
    call TriggerRegisterGameStateEventTimeOfDay(trg, GREATER_THAN_OR_EQUAL, 6.)
    call TriggerRegisterGameStateEventTimeOfDay(trg, LESS_THAN, 6.)
    call TriggerRegisterGameStateEventTimeOfDay(trg, GREATER_THAN_OR_EQUAL, 18.)
    call TriggerRegisterGameStateEventTimeOfDay(trg, LESS_THAN, 18.)
    call TriggerAddCondition(trg, Condition(function RumiaSpeedUpAtNight))
    set trg = GetTriggeringTrigger()
    call DisableTrigger(trg)
    call DestroyTrigger(trg)
    set trg = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Rumia03 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Rumia04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Rumia04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A07J'
endfunction

function Trig_Rumia04_Actions takes nothing returns nothing
    local unit hero = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local real heroX = GetUnitX(hero)
    local real heroY = GetUnitY(hero)
    local integer level = GetUnitAbilityLevel(hero, 'A07J')
    local real targetLife = GetUnitState(target, UNIT_STATE_LIFE)
    local real gainLife
    local real damage
    local boolean k = false
    local boolean uuz = false
    //========
    local real abilitycooldownlv01 = 36
    local real abilitycooldownlv02 = 36
    local real abilitycooldownlv03 = 36
    if UnitHasItemOfTypeBJ(hero, 'I00B') then
        if GetUnitAbilityLevel(hero,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(hero,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(hero,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(hero,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(hero,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(hero,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    if IsUnitType(target, UNIT_TYPE_HERO) then
        if targetLife<(level*150 + 150) then
            call InstantKill(hero,target)
            if GetUnitAbilityLevel(target,'A0MM')!=0 then
                set uuz = true
            endif
            set k = true
        else
            set damage = level*50.0 + 100.0
            call UnitDamageTargetBJ(hero,target,damage,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC)
        endif
        set gainLife = level*50.0 + 100.0
    else
        if level == 1 then
            set gainLife = targetLife*0.3
        elseif level == 2 then
            set gainLife = targetLife*0.5
        else
            set gainLife = targetLife*0.8
        endif
        call InstantKill(hero,target)
        call SetHeroStr(hero,GetHeroStr(hero,false)+1,true)
        set udg_SK_Rumia04_Str = udg_SK_Rumia04_Str + 1
    endif
    
    call UnitGainLife(hero,gainLife)
    
    if k then
        call TriggerSleepAction(0.2)
        if IsUnitDead(target) or uuz == true then
            call SetHeroStr(hero,GetHeroStr(hero,false)+5,true)
            set udg_SK_Rumia04_Str = udg_SK_Rumia04_Str + 5
        endif
    endif
    
    set hero = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Rumia04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Rumia04 Lost
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Rumia04_Lost_Actions takes nothing returns nothing
    local integer lost
    call TriggerSleepAction(0.3)
    set lost = R2I(udg_SK_Rumia04_Str*0.2)
    set udg_SK_Rumia04_Str = udg_SK_Rumia04_Str - lost
    call SetHeroStr(GetTriggerUnit(),GetHeroStr(GetTriggerUnit(),false)-lost,true)
endfunction

//===========================================================================
function InitTrig_Rumia04_Lost takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initial Rumia
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Rumia_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E00I')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
//=====================================  1  ===========================================================

    set gg_trg_Rumia01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Rumia01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Rumia01, Condition( function Trig_Rumia01_Conditions ) )
    call TriggerAddAction( gg_trg_Rumia01, function Trig_Rumia01_Actions )

//=====================================  2  ===========================================================

    set gg_trg_Rumia02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Rumia02, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Rumia02, Condition( function Trig_Rumia02_Conditions ) )
    call TriggerAddAction( gg_trg_Rumia02, function Trig_Rumia02_Actions )
    
//=====================================  3  ===========================================================
    
    set gg_trg_Rumia03 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(gg_trg_Rumia03 , EVENT_PLAYER_HERO_SKILL)
    call TriggerAddCondition(gg_trg_Rumia03 , Condition(function RumiaLearnSkillThreeConditions))
    call TriggerAddAction(gg_trg_Rumia03 , function RumiaLearnSkillThreeActions)

//=====================================  4  ===========================================================

    set udg_SK_Rumia04_Str = 0
    
    set gg_trg_Rumia04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Rumia04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Rumia04, Condition( function Trig_Rumia04_Conditions ) )
    call TriggerAddAction( gg_trg_Rumia04, function Trig_Rumia04_Actions )
    
    set gg_trg_Rumia04_Lost = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Rumia04_Lost, h, EVENT_UNIT_DEATH )
    call TriggerAddAction( gg_trg_Rumia04_Lost, function Trig_Rumia04_Lost_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Rumia takes nothing returns nothing
    set gg_trg_Initial_Rumia = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Rumia, function Trig_Initial_Rumia_Actions )
endfunction

//===========================================================================
// Trigger: YukaFlower
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function YukaFlower_ID takes nothing returns boolean
    return GetUnitTypeId(GetSummonedUnit())=='o00C'
endfunction

function YukaFlower_Filter takes nothing returns boolean
    return GetUnitTypeId(GetFilterUnit()) == 'o00C'
endfunction

function YukaFlower_Filter_All takes nothing returns boolean
    if GetUnitTypeId(GetFilterUnit()) == 'o00C' then
        return true
    endif
    if GetUnitTypeId(GetFilterUnit()) == 'o00D' then
        return true
    endif
    return false
endfunction

function YukaFlower_Aura takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local unit h = I2U(GetStoredInteger(udg_gc,H2S(t),"H"))
    local unit u
    local real ox = GetUnitX(h)
    local real oy = GetUnitY(h)
    local real dx
    local real dy
    local integer sum = 0
    local group g = CreateGroup()
    local boolexpr f = Filter(function YukaFlower_Filter_All)
    call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(h),f)
    loop
        set u = FirstOfGroup(g)
        exitwhen u == null
        call GroupRemoveUnit(g,u)
        set dx = GetUnitX(u) - ox
        set dy = GetUnitY(u) - oy
        set sum = sum + 1
    endloop
    call SetUnitAbilityLevel(h,'A07L',1 + sum - sum/10*10) //+ 5 atk
    call SetUnitAbilityLevel(h,'A07M',1 + sum/10) //+ 50 atk
    if udg_SK_Yuka_Unit != null then
        call SetUnitAbilityLevel(udg_SK_Yuka_Unit,'A07L',1 + sum - sum/10*10)
        call SetUnitAbilityLevel(udg_SK_Yuka_Unit,'A07M',1 + sum/10)
    endif
    call DestroyBoolExpr(f)
    set t = null
    set h = null
    set u = null
    set g = null
    set f = null
endfunction

function YukaFlower_Actions takes nothing returns nothing
    local unit h = GetSummoningUnit()
    local unit v = GetSummonedUnit()
    local unit u
    local unit k
    local string task = H2S(h)
    local timer t
    local group g
    local boolexpr f
    local integer i
    local integer max
    local integer age = GetStoredInteger(udg_gc,task,"S") + 1
    //========
    local real abilitycooldownlv01 = 4
    if UnitHasItemOfTypeBJ(h, 'I00B') then
        if GetUnitAbilityLevel(h,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(h,GetSpellAbilityId(),abilitycooldownlv01)
        endif
    endif
    //========
    if not HaveStoredInteger(udg_gc,task,"T") then
        set t = CreateTimer()
        call StoreInteger(udg_gc,task,"T",H2I(t))
        call StoreInteger(udg_gc,H2S(t),"H",H2I(h))
        call TimerStart(t,0.5,true,function YukaFlower_Aura)
    endif
    //========
    call SetUnitUserData(v,age)
    call StoreInteger(udg_gc,task,"S",age)
    call SetUnitFacing(v,225.0)
    call SetUnitX(v,(R2I(GetUnitX(v))/64)*64)
    call SetUnitY(v,(R2I(GetUnitY(v))/64)*64)
    call UnitRemoveAbility(v,'Amov')
    set g = CreateGroup()
    set f = Filter(function YukaFlower_Filter)
    call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(h),f)
    set max = 5
    set v = FirstOfGroup(g)
    set age = 99999
    set i = 0
    loop
        set u = FirstOfGroup(g)
        exitwhen u == null
        call GroupRemoveUnit(g,u)
        set i = i + 1
        if GetUnitUserData(u)<age then
            set age = GetUnitUserData(u)
            set v = u
        endif
    endloop
    if i>max then
        call KillUnit(v)
    endif
    if udg_SK_Yuka_Unit != null then
        call SetUnitState(udg_SK_Yuka_Unit,UNIT_STATE_MANA,GetUnitState(udg_SK_Yuka_Unit,UNIT_STATE_MANA)-20)
        call IssueImmediateOrderById(udg_SK_Yuka_Unit,851972)
        set k = CreateUnit(GetOwningPlayer(udg_SK_Yuka_Unit),'o00D',GetUnitX(udg_SK_Yuka_Unit),GetUnitY(udg_SK_Yuka_Unit),225.0)
        call UnitApplyTimedLife(k,'BTLF',30.0)
        call UnitRemoveAbility(k,'Amov')
    endif
    //========
    call DestroyBoolExpr(f)
    set t = null
    set h = null
    set u = null
    set v = null
    set g = null
    set f = null
    set k = null
endfunction

//===========================================================================
function InitTrig_YukaFlower takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: YukaFlower Levelup
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_YukaFlower_Levelup_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetHeroLevel(caster)
    call SetPlayerTechResearched(GetOwningPlayer(caster),'R005',level-1)
    set caster = null
endfunction

//===========================================================================
function InitTrig_YukaFlower_Levelup takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yuka01
//===========================================================================
function Trig_Yuka01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A068'
endfunction

function Trig_Yuka01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A068')
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx
    local real ty
    local integer i = 0
    local integer k
    local real r
    local real a
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 14
    local real abilitycooldownlv03 = 13
    local real abilitycooldownlv04 = 12
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if level == 1 then
        set k = 8
        set r = 125
        set a = 45
    elseif level == 2 then
        set k = 10
        set r = 150
        set a = 36.00
    elseif level == 3 then
        set k = 12
        set r = 175
        set a = 30.00
    elseif level == 4 then
        set k = 14
        set r = 200
        set a = 25.71
    endif
    loop
        exitwhen i == k
        set tx = ox + r*Cos(i*a/bj_RADTODEG)
        set ty = oy + r*Sin(i*a/bj_RADTODEG)
        set u = CreateUnit(GetOwningPlayer(caster),'o00D',tx,ty,225.0)
        call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\GlaiveMissile\\GlaiveMissileTarget.mdl",tx,ty))
        call UnitApplyTimedLife(u,'BTLF',1.20+0.80*level+GetRandomReal(0,100)*0.01-0.50)
        call UnitRemoveAbility(u,'Amov')
        set i = i + 1
    endloop
    if udg_SK_Yuka_Unit != null then
        call SetUnitState(udg_SK_Yuka_Unit,UNIT_STATE_MANA,GetUnitState(udg_SK_Yuka_Unit,UNIT_STATE_MANA)-(80+level*10))
        call IssueImmediateOrderById(udg_SK_Yuka_Unit, 851972 )
        set ox = GetUnitX(udg_SK_Yuka_Unit)
        set oy = GetUnitY(udg_SK_Yuka_Unit)
        set i = 0
        loop
            exitwhen i == k
            set tx = ox + r*Cos(i*a/bj_RADTODEG)
            set ty = oy + r*Sin(i*a/bj_RADTODEG)
            set u = CreateUnit(GetOwningPlayer(udg_SK_Yuka_Unit),'o00D',tx,ty,225.0)
            call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\GlaiveMissile\\GlaiveMissileTarget.mdl",tx,ty))
            call UnitApplyTimedLife(u,'BTLF',1.20+0.80*level+GetRandomReal(0,100)*0.01-0.50)
            call UnitRemoveAbility(u,'Amov')
            set i = i + 1
        endloop
    endif
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Yuka01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yuka02
//===========================================================================
function Trig_Yuka02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A06I'
endfunction

function Trig_Yuka02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local unit u
    local unit w
    local integer i = LoadInteger(udg_ht,task,2)
    local integer j = LoadInteger(udg_ht,task,3)
    local real damage = LoadReal(udg_ht,task,4)
    local real ox = LoadReal(udg_ht,task,5)
    local real oy = LoadReal(udg_ht,task,6)
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local real a = Atan2(ty-oy,tx-ox)
    set ox = ox + 10.0*Cos(a)
    set oy = oy + 10.0*Sin(a)
    set j = j - 1
    if j == 0 then
        set j = 8
        set i = i - 1
        set u = CreateUnit(GetOwningPlayer(caster),'o00D',ox,oy,225.0)
        call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\GlaiveMissile\\GlaiveMissileTarget.mdl",ox,oy))
        call UnitApplyTimedLife(u,'BTLF',4.00)
        call UnitRemoveAbility(u,'Amov')
    endif
    call SaveInteger(udg_ht,task,2,i)
    call SaveInteger(udg_ht,task,3,j)
    call SaveReal(udg_ht,task,5,ox)
    call SaveReal(udg_ht,task,6,oy)
    if SquareRoot((ox-tx)*(ox-tx)+(oy-ty)*(oy-ty)) < 20.00 then
        call UnitDamageTarget(caster,target,damage - 5.00,true,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
        set w = CreateUnit(GetOwningPlayer(caster),'n001',tx,ty,0)
        call UnitAddAbility(w,'A04M')
        call IssueTargetOrder(w,"thunderbolt",target)
        set i = 0
    endif
    if i == 0 then
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set target = null
    set u = null
    set w = null
endfunction

function Trig_Yuka02_Actions takes nothing returns nothing
    local timer t
    local integer task
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,'A06I')
    local real damage = 50 + level * 50
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetUnitX(target)
    local real ty
    local real a 
    local timer t2
    local integer task2
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 15
    local real abilitycooldownlv03 = 15
    local real abilitycooldownlv04 = 15
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set t = null
            set t2 = null
            return
        endif
    endif
    //========
    set t = CreateTimer()
    set task = GetHandleId(t)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveInteger(udg_ht,task,2,20)
    call SaveInteger(udg_ht,task,3,8)
    call SaveReal(udg_ht,task,4,damage)
    call SaveReal(udg_ht,task,5,ox)
    call SaveReal(udg_ht,task,6,oy)
    call TimerStart(t,0.01,true,function Trig_Yuka02_Main)
    if udg_SK_Yuka_Unit != null then
        set t2 = CreateTimer()
        set task2 = GetHandleId(t2)
        set ox = GetUnitX(udg_SK_Yuka_Unit)
        set oy = GetUnitY(udg_SK_Yuka_Unit)
        set tx = GetUnitX(target)
        set ty = GetUnitY(target)
        set a = Atan2(ty-oy,tx-ox)
        call SetUnitState(udg_SK_Yuka_Unit,UNIT_STATE_MANA,GetUnitState(udg_SK_Yuka_Unit,UNIT_STATE_MANA)-100)
        call SetUnitFacing(udg_SK_Yuka_Unit,bj_RADTODEG*a)
        call IssueImmediateOrderById(udg_SK_Yuka_Unit,851972)
        call SaveUnitHandle(udg_ht,task2,0,caster)
        call SaveUnitHandle(udg_ht,task2,1,target)
        call SaveInteger(udg_ht,task2,2,20)
        call SaveInteger(udg_ht,task2,3,8)
        call SaveReal(udg_ht,task2,4,damage)
        call SaveReal(udg_ht,task2,5,ox)
        call SaveReal(udg_ht,task2,6,oy)
        call TimerStart(t2,0.01,true,function Trig_Yuka02_Main)
    endif
    set caster = null
    set target = null
    set t = null
    set t2 = null
endfunction

//===========================================================================
function InitTrig_Yuka02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yuka03
//===========================================================================
function Trig_Yuka03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A07Q'
endfunction

function Trig_Yuka03_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local rect rt = LoadRectHandle(udg_Hashtable,GetHandleId(t),StringHash("rt"))
    call RemoveRect(rt)
    call RemoveWeatherEffect(udg_SK_Yuka_Weather)
    call FlushStoredMission(udg_gc,H2S(t))
    set t = null
    set rt = null
    set udg_SK_Yuka_Weather = null
endfunction

function Trig_Yuka03_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local location p = GetSpellTargetLoc()
    local unit u
    local rect rt
    local integer w
    local integer level = GetUnitAbilityLevel(GetTriggerUnit(),'A07Q')
    //========
    local real abilitycooldownlv01 = 18
    local real abilitycooldownlv02 = 18
    local real abilitycooldownlv03 = 18
    local real abilitycooldownlv04 = 18
    if UnitHasItemOfTypeBJ(GetTriggerUnit(), 'I00B') then
        if GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(GetTriggerUnit(),GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(GetTriggerUnit(),GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(GetTriggerUnit(),GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(GetTriggerUnit(),GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set u = CreateUnitAtLoc(GetOwningPlayer(GetTriggerUnit()),'n01L',p,0)
    call SetUnitAbilityLevel(u,'A07R',level)
    call SetUnitAbilityLevel(u,'A07S',level)
    call UnitApplyTimedLife(u,'BHwe',12.00)
    //========
    set w = 600
    set rt = RectFromCenterSizeBJ(p,w,w)
    set udg_SK_Yuka_Weather = AddWeatherEffect(rt,'LRaa')
    call EnableWeatherEffect(udg_SK_Yuka_Weather,true)
    call SaveRectHandle(udg_Hashtable,GetHandleId(t),StringHash("rt"),rt)
    call TimerStart(t,12.0,false,function Trig_Yuka03_Clear)
    if udg_SK_Yuka_Unit != null then
        call SetUnitState(udg_SK_Yuka_Unit,UNIT_STATE_MANA,GetUnitState(udg_SK_Yuka_Unit,UNIT_STATE_MANA)-(40+level*15))
        call IssueImmediateOrderById(udg_SK_Yuka_Unit,851972)
    endif
    //========
    call RemoveLocation(p)
    set rt = null
    set p = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Yuka03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yuka04
//===========================================================================
function Trig_Yuka04_Conditions takes nothing returns boolean
    if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
        return GetSpellAbilityId() == 'A0DA'
    endif
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_SUMMON then
        if GetUnitTypeId(GetSummoningUnit())!='o00U' then
            return false
        endif
        return GetUnitTypeId(GetSummonedUnit())=='N00L'
    endif
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_DEATH then
        return IsUnitIllusion(GetTriggerUnit())
    endif
    return false
endfunction

function Trig_Yuka04_Actions takes nothing returns nothing
    local integer task = GetHandleId(GetTriggeringTrigger())
    local unit caster 
    local unit target 
    local unit u
    local real tx
    local real ty
    //========
    local real abilitycooldownlv01 = 140
    local real abilitycooldownlv02 = 130
    local real abilitycooldownlv03 = 120
    //========
    if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
        set caster = GetTriggerUnit()
        set target = GetSpellTargetUnit()
        if UnitHasItemOfTypeBJ(caster, 'I00B') then
            if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
            endif
        endif
        if GetUnitTypeId(target) == 'o00C' or GetUnitTypeId(target) == 'o00D' then
            set tx = GetUnitX(target)
            set ty = GetUnitY(target)
            call SaveUnitHandle(udg_ht,task,0,caster)
            call SaveReal(udg_ht,task,1,tx)
            call SaveReal(udg_ht,task,2,ty)
            set u = CreateUnit(GetOwningPlayer(caster),'o00U',GetUnitX(caster),GetUnitY(caster),270.0)
            call UnitAddAbility(u,'A04I')
            call SetUnitAbilityLevel(u,'A04I',GetUnitAbilityLevel(caster,'A0DA'))
            call IssueTargetOrderById(u,852274,caster)
            call RemoveUnit(target)
        endif
    elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_SUMMON then
        set u = GetSummonedUnit()
        set caster = LoadUnitHandle(udg_ht,task,0)
        set tx = LoadReal(udg_ht,task,1)
        set ty = LoadReal(udg_ht,task,2)
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIil\\AIilTarget.mdl",u,"origin"))
        call SetUnitXY(u,tx,ty)
        set udg_SK_Yuka_Unit = u
    elseif GetTriggerEventId()==EVENT_PLAYER_UNIT_DEATH then
        if GetTriggerUnit() == udg_SK_Yuka_Unit then
            set udg_SK_Yuka_Unit = null
        endif
    endif
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Yuka04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initial Yuka
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Yuka_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('N00L')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_YukaFlower = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_YukaFlower, h, EVENT_UNIT_SUMMON )
    call TriggerAddCondition( gg_trg_YukaFlower, Condition( function YukaFlower_ID ) )
    call TriggerAddAction( gg_trg_YukaFlower, function YukaFlower_Actions )
    
    set gg_trg_YukaFlower_Levelup = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_YukaFlower_Levelup, h, EVENT_UNIT_HERO_LEVEL )
    call TriggerAddAction( gg_trg_YukaFlower_Levelup, function Trig_YukaFlower_Levelup_Actions )

    set gg_trg_Yuka01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yuka01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yuka01, Condition( function Trig_Yuka01_Conditions ) )
    call TriggerAddAction( gg_trg_Yuka01, function Trig_Yuka01_Actions )
    
    set gg_trg_Yuka02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yuka02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yuka02, Condition( function Trig_Yuka02_Conditions ) )
    call TriggerAddAction( gg_trg_Yuka02, function Trig_Yuka02_Actions )

    set gg_trg_Yuka03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yuka03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yuka03, Condition( function Trig_Yuka03_Conditions ) )
    call TriggerAddAction( gg_trg_Yuka03, function Trig_Yuka03_Actions )

    set gg_trg_Yuka04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yuka04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerRegisterPlayerUnitEvent( gg_trg_Yuka04, GetOwningPlayer(h), EVENT_PLAYER_UNIT_SUMMON, null )
    call TriggerRegisterPlayerUnitEvent( gg_trg_Yuka04, GetOwningPlayer(h), EVENT_PLAYER_UNIT_DEATH, null )
    call TriggerAddCondition( gg_trg_Yuka04, Condition( function Trig_Yuka04_Conditions ) )
    call TriggerAddAction( gg_trg_Yuka04, function Trig_Yuka04_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Yuka takes nothing returns nothing
    set gg_trg_Initial_Yuka = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Yuka, function Trig_Initial_Yuka_Actions )
endfunction

//===========================================================================
// Trigger: Medi02
//===========================================================================
//TESH.scrollpos=24
//TESH.alwaysfold=0
function Medi02_ID takes nothing returns boolean
    return GetUnitTypeId(GetSummonedUnit())=='n01M'
endfunction

function Medi02_Filter takes nothing returns boolean
    return GetUnitTypeId(GetFilterUnit()) == 'n01M'
endfunction

function Medi02_Actions takes nothing returns nothing
    local unit h = GetSummoningUnit()
    local unit v = GetSummonedUnit()
    local unit u
    local string task = H2S(h)
    local timer t
    local group g
    local boolexpr f
    local integer i
    local integer max
    local integer age = GetStoredInteger(udg_gc,task,"S") + 1
    //========
    local real abilitycooldownlv01 = 10
    local real abilitycooldownlv02 = 10
    local real abilitycooldownlv03 = 10
    local real abilitycooldownlv04 = 10
    if UnitHasItemOfTypeBJ(h, 'I00B') then
        if GetUnitAbilityLevel(h,'A07W') == 1 then
            call Item_HeroAbilityCoolDownReset(h,'A07W',abilitycooldownlv01)
        elseif GetUnitAbilityLevel(h,'A07W') == 2 then
            call Item_HeroAbilityCoolDownReset(h,'A07W',abilitycooldownlv02)
        elseif GetUnitAbilityLevel(h,'A07W') == 3 then
            call Item_HeroAbilityCoolDownReset(h,'A07W',abilitycooldownlv03)
        elseif GetUnitAbilityLevel(h,'A07W') == 4 then
            call Item_HeroAbilityCoolDownReset(h,'A07W',abilitycooldownlv04)
        endif
    endif
    //========
    if not HaveStoredInteger(udg_gc,task,"T") then
        set t = CreateTimer()
        call StoreInteger(udg_gc,task,"T",H2I(t))
        call StoreInteger(udg_gc,H2S(t),"H",H2I(h))
    endif
    //========
    call SetUnitUserData(v,age)
    call StoreInteger(udg_gc,task,"S",age)
    set g = CreateGroup()
    set f = Filter(function Medi02_Filter)
    call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(h),f)
    set max = 1*GetUnitAbilityLevel(h,'A07W')
    set v = FirstOfGroup(g)
    set age = 99999
    set i = 0
    loop
        set u = FirstOfGroup(g)
        exitwhen u == null
        call GroupRemoveUnit(g,u)
        set i = i + 1
        if GetUnitUserData(u)<age then
            set age = GetUnitUserData(u)
            set v = u
        endif
    endloop
    if i>max then
        call KillUnit(v)
    endif
    //========
    call DestroyBoolExpr(f)
    set t = null
    set h = null
    set u = null
    set v = null
    set g = null
    set f = null
endfunction

//===========================================================================
function InitTrig_Medi02 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Medi03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Medi03_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A07Y'
endfunction

function Trig_Medi03_Conditions takes nothing returns boolean
    if IsUnitType(GetAttacker(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    return DistanceBetweenUnits(GetTriggerUnit(),GetAttacker())<=150.0
endfunction

function Trig_Medi03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetAttacker()
    local unit u
    local unit v = LoadUnitHandle(udg_Hashtable,GetHandleId(GetTriggeringTrigger()),0)
    local integer level = GetUnitAbilityLevel(caster,'A07Y')
    local location p = GetUnitLoc(target)
    //========
    call SetUnitAbilityLevel(caster,'A080',level + 1)
    //沉默和沉默
    set u = CreateUnitAtLoc(GetOwningPlayer(caster),GPSU(),p,270.0)
    call UnitAddAbility(u,'A07Z')
    call SetUnitAbilityLevel(u,'A07Z',level)
    call UnitAddAbility(v,'A04Q')
    call SetUnitAbilityLevel(v,'A04Q',level)
    call IssueTargetOrder(u,"soulburn",target)
    call IssueTargetOrder(v,"shadowstrike",target)
    call DebugMsg("Medi03")
    //========
    call RemoveLocation(p)
    set p = null
    set u = null
    set v = null
    set caster = null
    set target = null
endfunction

function Trig_Medi03_Learn_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u = CreateUnitAtLoc(GetOwningPlayer(caster),'n00X',udg_BackStage,0)
    call DestroyTrigger(gg_trg_Medi03)
    
    set gg_trg_Medi03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Medi03, caster, EVENT_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Medi03, Condition( function Trig_Medi03_Conditions ) )
    call TriggerAddAction( gg_trg_Medi03, function Trig_Medi03_Actions )
    call UnitAddAbility(caster,'A080')
    
    call SaveUnitHandle(udg_Hashtable,GetHandleId(gg_trg_Medi03),0,u)
    
    set u = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Medi03 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Medi04
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 修改联盟状态法+关闭操作+镜头跟随
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Medi04_Conditions takes nothing returns boolean
    if GetSpellAbilityId()!='A0AM' then
        return false
    endif
    if IsUnitIllusion(GetSpellTargetUnit()) then
        return false
    endif
    return true
endfunction

function stopattack takes nothing returns nothing
    local unit target = GetEnumUnit()
    call IssueImmediateOrder(target,"stop")
    set target = null
endfunction

function Medi04_TimeOut takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit target = LoadUnitHandle(udg_Hashtable,task,0)
    local player targetplayer = LoadPlayerHandle(udg_Hashtable,task,1)
    local integer whichteam = LoadInteger(udg_Hashtable,task,0)
    local integer i = LoadInteger(udg_Hashtable,task,1)
    local group grp
    //========
    if i>0 and IsUnitAliveBJ(target) then
        call SaveInteger(udg_Hashtable,task,1,i - 1)
    else
        set grp = GetUnitsOfPlayerAll(targetplayer)
        //使玩家可以控制单位
        call CameraSetupApplyForPlayer( true, GetCurrentCameraSetup(), targetplayer, 0 )
        call SetUserControlForceOn(udg_SK_Medi_Team)
        call DebugMsg("ControlOn")
        //恢复联盟关系     
        if whichteam==1 then
            call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamA , bj_ALLIANCE_ALLIED_VISION )
            call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamB , bj_ALLIANCE_UNALLIED )
            call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamSpawnA , bj_ALLIANCE_ALLIED_VISION )
            call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamSpawnB , bj_ALLIANCE_UNALLIED )
            call ForceRemovePlayer(udg_SK_Medi_Team,targetplayer)
        else
            call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamA , bj_ALLIANCE_UNALLIED )
            call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamB , bj_ALLIANCE_ALLIED_VISION)
            call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamSpawnA , bj_ALLIANCE_UNALLIED )
            call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamSpawnB , bj_ALLIANCE_ALLIED_VISION )
            call ForceRemovePlayer(udg_SK_Medi_Team,targetplayer)  
        endif
        call ForGroupBJ( grp, function stopattack )
        call DestroyGroup(grp)
        call ForceClear(udg_SK_Medi_Team)
        call FlushChildHashtable(udg_Hashtable,task)
        call PauseTimer(t)
        call DestroyTimer(t)
    endif
    //========
    set t = null
    set target = null 
    set targetplayer = null
    set grp = null
endfunction

function Trig_Medi04_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit target = GetSpellTargetUnit()
    local player targetplayer= GetOwningPlayer(target)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0AM')
    local integer whichteam = 0
    local unit u = CreateUnit(targetplayer,'n001',GetUnitX(target),GetUnitY(target),0)
    //========
    local real abilitycooldownlv01 = 120
    local real abilitycooldownlv02 = 100
    local real abilitycooldownlv03 = 80
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    //修改联盟关系 
    if IsPlayerInForce(targetplayer,udg_TeamA) then
        set whichteam = 1
        call ForceAddPlayer(udg_SK_Medi_Team,targetplayer)
        call DebugMsg("Add A")
        call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamA , bj_ALLIANCE_UNALLIED_VISION )
        call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamB , bj_ALLIANCE_UNALLIED )
        call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamSpawnA , bj_ALLIANCE_UNALLIED_VISION )
        call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamSpawnB , bj_ALLIANCE_UNALLIED )
        call DebugMsg("Set A")    
    else
        call ForceAddPlayer(udg_SK_Medi_Team,targetplayer)
        call DebugMsg("Add B")
        call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamA , bj_ALLIANCE_UNALLIED )
        call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamB , bj_ALLIANCE_UNALLIED_VISION )
        call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamSpawnA , bj_ALLIANCE_UNALLIED )
        call SetForceAllianceStateBJ( udg_SK_Medi_Team, udg_TeamSpawnB , bj_ALLIANCE_UNALLIED_VISION )
        call DebugMsg("Set B") 
    endif
    //使玩家无法操作单位
    call SetCameraTargetControllerNoZForPlayer( targetplayer, target, 0, 0, false )
    call SetUserControlForceOff(udg_SK_Medi_Team)
    call DebugMsg("ControlOff")
    //A地板 
    call IssueImmediateOrder(target,"stop")
    call IssuePointOrder(target,"attack",GetUnitX(target) + GetRandomReal(-200.0,200.0),GetUnitY(target) + GetRandomReal(-200.0,200.0))
    //释放技能部分
    call UnitAddAbility(u,'A081')
    call SetUnitAbilityLevel(u,'A081',level)
    call IssueTargetOrder(u,"bloodlust",target)
    //TimerStart
    call SaveInteger(udg_Hashtable,task,0,whichteam)
    call SaveInteger(udg_Hashtable,task,1,5+level*1)
    call SaveUnitHandle(udg_Hashtable,task,0,target)
    call SavePlayerHandle(udg_Hashtable,task,1,targetplayer)
    call TimerStart(t,1.0,true,function Medi04_TimeOut)
    set t = null
    set u = null
    set target = null
    set targetplayer = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Medi04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Medi
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Medi_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('N00K')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_Medi02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Medi02, h, EVENT_UNIT_SUMMON )
    call TriggerAddCondition( gg_trg_Medi02, Condition( function Medi02_ID ) )
    call TriggerAddAction( gg_trg_Medi02, function Medi02_Actions )

    set gg_trg_Medi03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Medi03, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Medi03, Condition( function Trig_Medi03_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Medi03, function Trig_Medi03_Learn_Actions )

    set gg_trg_Medi04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Medi04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Medi04, Condition( function Trig_Medi04_Conditions ) )
    call TriggerAddAction( gg_trg_Medi04, function Trig_Medi04_Actions )

    set h = null
endfunction

function InitTrig_Initial_Medi takes nothing returns nothing
    set gg_trg_Initial_Medi = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Medi, function Trig_Initial_Medi_Actions )
endfunction

//===========================================================================
// Trigger: EirinSage
//===========================================================================
function Trig_EirinSage_Actions takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    call SetHeroInt(caster,GetHeroInt(caster,false)+1,true)
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_EirinSage takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Eirin01
//===========================================================================
function Trig_Eirin01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0OT'
endfunction

function Trig_Eirin01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0OT')
    local unit u
    //========
    local real abilitycooldownlv01 = 14
    local real abilitycooldownlv02 = 12
    local real abilitycooldownlv03 = 10
    local real abilitycooldownlv04 = 8
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if caster == target then
        call UnitRemoveBuffs(caster,false,true)
        call UnitRemoveAbility(caster,'B009')
        if GetUnitAbilityLevel(caster,'B00S')>0 then
            call UnitRemoveAbility(caster,'B00S')
            call UnitRemoveAbility(caster,'B01T')
        endif
        set u = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(caster),GetUnitY(caster),0)
        call UnitAddAbility(u,'A03S')
        call SetUnitAbilityLevel(u,'A03S',level+4)
        call IssueTargetOrder(u,"bloodlust",caster)
    else
        call UnitRemoveBuffs(caster,false,true)
        call UnitRemoveAbility(caster,'B009')
        if GetUnitAbilityLevel(caster,'B00S')>0 then
            call UnitRemoveAbility(caster,'B00S')
            call UnitRemoveAbility(caster,'B01T')
        endif
        set u = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(caster),GetUnitY(caster),0)
        call UnitAddAbility(u,'A03S')
        call SetUnitAbilityLevel(u,'A03S',level)
        call IssueTargetOrder(u,"bloodlust",caster)

        call UnitRemoveBuffs(target,false,true)
        call UnitRemoveAbility(target,'B009')
        if GetUnitAbilityLevel(target,'B00S')>0 then
            call UnitRemoveAbility(target,'B00S')
            call UnitRemoveAbility(target,'B01T')
        endif
        set u = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0)
        call UnitAddAbility(u,'A03S')
        call SetUnitAbilityLevel(u,'A03S',level)
        call IssueTargetOrder(u,"bloodlust",target)
    endif
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Eirin01 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Eirin02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Eirin02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A083'
endfunction

function Trig_Eirin02_Target takes nothing returns boolean
    if IsUnitDeadBJ(GetFilterUnit()) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')>0 then
        return false
    endif
    return true
endfunction

function Trig_Eirin02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local real a = LoadReal(udg_ht,task,0)
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local real px 
    local real py 
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local group g = CreateGroup()
    local boolexpr f = Filter(function Trig_Eirin02_Target)
    //========
    call GroupEnumUnitsInRange(g,ox,oy,80.0,f)
    call DestroyBoolExpr(f)
    set v = FirstOfGroup(g)
    if v != null then
        call KillUnit(u)
        set i = -1
        //========
        if IsUnitAlly(v,GetOwningPlayer(caster)) == false then
            if IsUnitType(v,UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(v))] == true and IsUnitIllusionBJ(v) == false then
                call Item_BLTalismanicRunningCD(v)
                call DestroyGroup(g)
                call DestroyTimer(t)
                call FlushChildHashtable(udg_ht,task)
                set t = null
                set caster = null
                set u = null
                set v = null
                set g = null
                set f = null
                return
            endif
        endif
        //========
        if IsUnitEnemy(v,GetOwningPlayer(caster)) then
            call UnitDamageTargetHJ(caster,v,40.0*level,2)
        endif
        set u = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,0.0)
        call UnitAddAbility(u,'A084')
        call SetUnitAbilityLevel(u,'A084',level)
        call IssuePointOrder(u,"blizzard",ox,oy)
        set u = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,180.0)
        call UnitAddAbility(u,'A085')
        call SetUnitAbilityLevel(u,'A085',level)
        call IssuePointOrder(u,"healingspray",ox,oy)
    endif
    call DestroyGroup(g)
    if i>0 then
        set px = ox + 25.0*CosBJ(a)
        set py = oy + 25.0*SinBJ(a)
        if SetUnitXYFly(u,px,py) then
            call SaveInteger(udg_ht,task,1,i - 1)
        else
            call SaveInteger(udg_ht,task,1,0)
        endif
    else
        if i==0 then
            call KillUnit(u)
        endif
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set g = null
    set f = null
endfunction

function Trig_Eirin02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real px 
    local real py 
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 9
    local real abilitycooldownlv02 = 9
    local real abilitycooldownlv03 = 9
    local real abilitycooldownlv04 = 9
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set px = ox + 100.0*CosBJ(a)
    set py = oy + 100.0*SinBJ(a)
    set u = CreateUnit(GetOwningPlayer(caster),'e00K',px,py,a)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,R2I(6300.0/18.0))
    call SaveReal(udg_ht,task,0,a)
    call TimerStart(t,0.02,true,function Trig_Eirin02_Main)
    //========
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Eirin02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Eirin03
//===========================================================================
function Trig_Eirin03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A086'
endfunction

function Trig_Eirin03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = GetUnitAbilityLevel(caster,'A086')
    local unit u = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,0)
    //========
    local real abilitycooldownlv01 = 5
    local real abilitycooldownlv02 = 5
    local real abilitycooldownlv03 = 5
    local real abilitycooldownlv04 = 5
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call UnitAddAbility(u,'A087')
    call SetUnitAbilityLevel(u,'A087',level)
    call IssueTargetOrder(u,"invisibility",target)
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Eirin03 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Eirin04
//===========================================================================
function Trig_Eirin04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A088'
endfunction

function Trig_Eirin04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = GetUnitAbilityLevel(caster,'A088')
    local integer ID = level - 1 + 'I03C'
    local item w = CreateItem(ID,ox,oy)
    //========
    local real abilitycooldownlv01 = 140
    local real abilitycooldownlv02 = 130
    local real abilitycooldownlv03 = 120
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    call UnitAddItem(caster,w)
    set caster = null
    set w = null
endfunction

//===========================================================================
function InitTrig_Eirin04 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Initial Eirin
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Eirin_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('O006')
    local integer i

    local timer t = CreateTimer()
    local integer task = GetHandleId(t)

    if h==null then
        return
    endif

    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    //gg_trg_EirinSage
    call SaveUnitHandle(udg_ht,task,0,h)
    call TimerStart(t,81.00,true,function Trig_EirinSage_Actions)
    
    set gg_trg_Eirin01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Eirin01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Eirin01, Condition( function Trig_Eirin01_Conditions ) )
    call TriggerAddAction( gg_trg_Eirin01, function Trig_Eirin01_Actions )

    set gg_trg_Eirin02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Eirin02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Eirin02, Condition( function Trig_Eirin02_Conditions ) )
    call TriggerAddAction( gg_trg_Eirin02, function Trig_Eirin02_Actions )
    
    set gg_trg_Eirin03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Eirin03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Eirin03, Condition( function Trig_Eirin03_Conditions ) )
    call TriggerAddAction( gg_trg_Eirin03, function Trig_Eirin03_Actions )

    set gg_trg_Eirin04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Eirin04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Eirin04, Condition( function Trig_Eirin04_Conditions ) )
    call TriggerAddAction( gg_trg_Eirin04, function Trig_Eirin04_Actions )
    
    set h = null
    set t = null
endfunction

function InitTrig_Initial_Eirin takes nothing returns nothing
    set gg_trg_Initial_Eirin = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Eirin, function Trig_Initial_Eirin_Actions )
endfunction

//===========================================================================
// Trigger: KaguyaEx
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_KaguyaEx_Conditions takes nothing returns boolean
    local real manacost = GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_MANA) * 0.20 + 200
    if GetUnitState(GetTriggerUnit(),UNIT_STATE_MANA) < manacost then
        return false
    endif
    if GetEventDamage()>GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE)-5.0 then
        call TSU_SetUnitInvulnerable(GetTriggerUnit(),0.01)
        return true
    endif
    if GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE) <= 5.0 then
        call TSU_SetUnitInvulnerable(GetTriggerUnit(),0.01)
        return true
    endif
    return false
endfunction

function Trig_KaguyaEx_Clear takes nothing returns nothing
    set udg_SK_Kaguya_RewindIncre = udg_SK_Kaguya_RewindIncre - 1
    if udg_SK_Kaguya_RewindIncre == 0 then
        set udg_SK_Kaguya_Rewind = 0
    endif
endfunction

function Trig_KaguyaEx_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local timer t = CreateTimer()
    local real manacost = GetUnitState(GetTriggerUnit(),UNIT_STATE_MAX_MANA) * 0.20 + 200
    local integer k = udg_SK_Kaguya_Rewind
    local real decre = 1.00
    loop
        exitwhen k == 0
        set k = k - 1
        set decre = decre * 0.70
    endloop
    call SetUnitLifePercentBJ(caster,100.0*decre)
    set udg_SK_Kaguya_Rewind = udg_SK_Kaguya_Rewind + 1
    set udg_SK_Kaguya_RewindIncre = udg_SK_Kaguya_RewindIncre + 1
    call TimerStart(t,10.0,false,function Trig_KaguyaEx_Clear)
    call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA) - manacost)
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\ReviveHuman\\ReviveHuman.mdl",ox,oy))
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_KaguyaEx takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Kaguya01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Kaguya01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0D0'
endfunction

function Trig_Kaguya01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local unit u
    local real a = GetUnitFacing(caster)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local integer R
    local integer G
    local integer B
    //========
    if i<7 and IsUnitAlive(caster) then
        if i<3 then
            set a = a - 51.0*(i + 1)
        elseif i<6 then
            set a = a + 51.0*(6 - i)
        else
            set a = a + 0.0
        endif
        set px = ox + 350.0*CosBJ(a)
        set py = oy + 350.0*SinBJ(a)
        set R = udg_SK_Kaguya01_RGB[i*3+0]
        set G = udg_SK_Kaguya01_RGB[i*3+1]
        set B = udg_SK_Kaguya01_RGB[i*3+2]
        set u = CreateUnit(GetOwningPlayer(caster),'n02Q',px,py,a)
        call SetUnitVertexColor(u,R,G,B,255)
        call SetUnitTimeScale(u,1.5)
        set u = CreateUnit(GetOwningPlayer(caster),'n02Q',px,py,a)
        call SetUnitVertexColor(u,R,G,B,255)
        call SetUnitTimeScale(u,1.5)
        set u = CreateUnit(GetOwningPlayer(caster),'n02Q',px,py,a+180.0)
        call SetUnitVertexColor(u,R,G,B,255)
        call SetUnitTimeScale(u,1.5)
        set px = ox + 355.0*CosBJ(a)
        set py = oy + 355.0*SinBJ(a)
        call SetUnitAbilityLevel(u,'A0CU',level)
        call IssuePointOrder(u,"breathoffrost",px,py)
        call SaveInteger(udg_ht,task,1,i + 1)
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Kaguya01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 14
    local real abilitycooldownlv02 = 14
    local real abilitycooldownlv03 = 14
    local real abilitycooldownlv04 = 14
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call UnitDamageTargetHJ(caster,caster,60+level*60,2)
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,0,GetUnitAbilityLevel(caster,GetSpellAbilityId()))
    call SaveInteger(udg_ht,task,1,0)
    call TimerStart(t,0.35,true,function Trig_Kaguya01_Main)
    //========
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Kaguya01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Kaguya02
//===========================================================================
//TESH.scrollpos=39
//TESH.alwaysfold=0
function Trig_Kaguya02_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetSummonedUnit())=='o010'
endfunction

function Trig_Kaguya02_Up02 takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit target = LoadUnitHandle(udg_ht,task,0)
    if IsUnitType(target,UNIT_TYPE_DEAD) == false and target != null then
        call KillUnit(target)
        call RemoveUnit(target) 
    endif
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set target = null
endfunction

function Trig_Kaguya02_Up01 takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit target = LoadUnitHandle(udg_ht,task,0)
    local unit caster = LoadUnitHandle(udg_ht,task,1)
    local real ox
    local real oy
    if IsUnitType(target,UNIT_TYPE_DEAD) == false and target != null then
        set ox = GetUnitX(target)
        set oy = GetUnitY(target)
        call KillUnit(target)
        call RemoveUnit(target) 
        set target = CreateUnit(GetOwningPlayer(caster),'o011',ox,oy,0)
        call SaveUnitHandle(udg_ht,task,0,target)
        call TimerStart(t,120.0,false,function Trig_Kaguya02_Up02)
    endif
    set t = null
    set caster = null
    set target = null
endfunction

function Trig_Kaguya02_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetSummoningUnit()
    local unit target = GetSummonedUnit()
    local real ox
    local real oy
    //========
    local real abilitycooldownlv01 = 190
    local real abilitycooldownlv02 = 150
    local real abilitycooldownlv03 = 110
    local real abilitycooldownlv04 = 70
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,'A0SP') == 1 then
            call Item_HeroAbilityCoolDownReset(caster,'A0SP',abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,'A0SP') == 2 then
            call Item_HeroAbilityCoolDownReset(caster,'A0SP',abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,'A0SP') == 3 then
            call Item_HeroAbilityCoolDownReset(caster,'A0SP',abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,'A0SP') == 4 then
            call Item_HeroAbilityCoolDownReset(caster,'A0SP',abilitycooldownlv04)
        endif
    endif
    //========
    call UnitDamageTargetHJ(caster,caster,60,2)
    set ox = GetUnitX(target)
    set oy = GetUnitY(target)
    call KillUnit(target)
    call RemoveUnit(target)
    set target = CreateUnit(GetOwningPlayer(caster),'o010',ox,oy,0)
    call SaveUnitHandle(udg_ht,task,0,target)
    call SaveUnitHandle(udg_ht,task,1,caster)
    call TimerStart(t,120.0,false,function Trig_Kaguya02_Up01)
    set t = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Kaguya02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Kaguya03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Kaguya03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0D2'
endfunction

function Trig_Kaguya03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    //========
    local real abilitycooldownlv01 = 70
    local real abilitycooldownlv02 = 60
    local real abilitycooldownlv03 = 50
    local real abilitycooldownlv04 = 40
    //========
    if GetTriggerEventId()==EVENT_UNIT_SPELL_CAST then
        if UnitHasItemOfTypeBJ(caster, 'I00B') then
            if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
               call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
               call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
            endif
        endif
        call CastSpell(caster,"Eirin!! Eirin!!!")
        call UnitDamageTargetHJ(caster,caster,250,2)
        set udg_SK_Kaguya_Target = target
        set caster = null
        set target = null
        return
    endif
    set target = udg_SK_Kaguya_Target
    if IsUnitType(target,UNIT_TYPE_DEAD) == false then
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",GetUnitX(target),GetUnitY(target)))
        call SetUnitPosition(target,ox,oy)
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",GetUnitX(target),GetUnitY(target)))
    endif
    call CastSpell(caster,"\\>o</ Help Me !! Eirin!!!")
    //========
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Kaguya03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Kaguya04
//===========================================================================
function Trig_Kaguya04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0SQ'
endfunction

function Trig_Kaguya04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local unit summon01 = LoadUnitHandle(udg_ht,task,2)
    local unit summon02 = LoadUnitHandle(udg_ht,task,3)
    local unit summon03 = LoadUnitHandle(udg_ht,task,4)
    local unit summon04 = LoadUnitHandle(udg_ht,task,5)
    local real ox = LoadReal(udg_ht,task,6)
    local real oy = LoadReal(udg_ht,task,7)
    local boolean endingornot = true
    set i = i + 1
    if i >= 720 then
        set i = i - 720
    endif
    if summon01 != null and IsUnitType(summon01,UNIT_TYPE_DEAD) == false then
        call SetUnitXY(summon01,ox+300*CosBJ(i/2),oy+300*SinBJ(i/2))
        set endingornot = false
    endif
    if summon02 != null and IsUnitType(summon02,UNIT_TYPE_DEAD) == false then
        call SetUnitXY(summon02,ox+300*CosBJ(i/2+90),oy+300*SinBJ(i/2+90))
        set endingornot = false
    endif
    if summon03 != null and IsUnitType(summon03,UNIT_TYPE_DEAD) == false then
        call SetUnitXY(summon03,ox+300*CosBJ(i/2+180),oy+300*SinBJ(i/2+180))
        set endingornot = false
    endif
    if summon04 != null and IsUnitType(summon04,UNIT_TYPE_DEAD) == false then
        call SetUnitXY(summon04,ox+300*CosBJ(i/2+270),oy+300*SinBJ(i/2+270))
        set endingornot = false
    endif
    if IsUnitType(caster,UNIT_TYPE_DEAD) then
        if IsUnitType(udg_SK_Kaguya_Summon01,UNIT_TYPE_DEAD) == false then
            call KillUnit(udg_SK_Kaguya_Summon01)
            call RemoveUnit(udg_SK_Kaguya_Summon01)
        endif
        if IsUnitType(udg_SK_Kaguya_Summon02,UNIT_TYPE_DEAD) == false  then
            call KillUnit(udg_SK_Kaguya_Summon02)
            call RemoveUnit(udg_SK_Kaguya_Summon02)
        endif
        if IsUnitType(udg_SK_Kaguya_Summon03,UNIT_TYPE_DEAD) == false  then
            call KillUnit(udg_SK_Kaguya_Summon03)
            call RemoveUnit(udg_SK_Kaguya_Summon03)
        endif
        if IsUnitType(udg_SK_Kaguya_Summon04,UNIT_TYPE_DEAD) == false  then
           call KillUnit(udg_SK_Kaguya_Summon04)
           call RemoveUnit(udg_SK_Kaguya_Summon04)
        endif
        set endingornot = true
    endif
    call SaveInteger(udg_ht,task,1,i)
    if endingornot then
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set summon01 = null
    set summon02 = null
    set summon03 = null
    set summon04 = null
endfunction

function Trig_Kaguya04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = GetUnitAbilityLevel(caster,'A0SQ')
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer i = 0
    //========
    local real abilitycooldownlv01 = 60
    local real abilitycooldownlv02 = 60
    local real abilitycooldownlv03 = 60
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    call UnitDamageTargetHJ(caster,caster,200+level*300,2)
    if IsUnitType(udg_SK_Kaguya_Summon01,UNIT_TYPE_DEAD) == false then
        call KillUnit(udg_SK_Kaguya_Summon01)
        call RemoveUnit(udg_SK_Kaguya_Summon01)
    endif
    if IsUnitType(udg_SK_Kaguya_Summon02,UNIT_TYPE_DEAD) == false  then
        call KillUnit(udg_SK_Kaguya_Summon02)
        call RemoveUnit(udg_SK_Kaguya_Summon02)
    endif
    if IsUnitType(udg_SK_Kaguya_Summon03,UNIT_TYPE_DEAD) == false  then
        call KillUnit(udg_SK_Kaguya_Summon03)
        call RemoveUnit(udg_SK_Kaguya_Summon03)
    endif
    if IsUnitType(udg_SK_Kaguya_Summon04,UNIT_TYPE_DEAD) == false  then
        call KillUnit(udg_SK_Kaguya_Summon04)
        call RemoveUnit(udg_SK_Kaguya_Summon04)
    endif
    set udg_SK_Kaguya_Summon01 = CreateUnit(GetOwningPlayer(caster),'o00W',ox+300*CosBJ(i),oy+300*SinBJ(i),0)
    set udg_SK_Kaguya_Summon02 = CreateUnit(GetOwningPlayer(caster),'o00X',ox+300*CosBJ(i+90),oy+300*SinBJ(i+90),0)
    set udg_SK_Kaguya_Summon03 = CreateUnit(GetOwningPlayer(caster),'o00Y',ox+300*CosBJ(i+180),oy+300*SinBJ(i+180),0)
    set udg_SK_Kaguya_Summon04 = CreateUnit(GetOwningPlayer(caster),'o00Z',ox+300*CosBJ(i+270),oy+300*SinBJ(i+270),0)
    call addlife(udg_SK_Kaguya_Summon01,level*200)
    call addlife(udg_SK_Kaguya_Summon02,level*200)
    call addlife(udg_SK_Kaguya_Summon03,level*200)
    call addlife(udg_SK_Kaguya_Summon04,level*200)
    call SetUnitAbilityLevel(udg_SK_Kaguya_Summon01,'A0CY',level)
    call SetUnitAbilityLevel(udg_SK_Kaguya_Summon02,'A0CV',level)
    call SetUnitAbilityLevel(udg_SK_Kaguya_Summon03,'A0CW',level)
    call SetUnitAbilityLevel(udg_SK_Kaguya_Summon04,'A0CX',level)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,1,i)
    call SaveUnitHandle(udg_ht,task,2,udg_SK_Kaguya_Summon01)
    call SaveUnitHandle(udg_ht,task,3,udg_SK_Kaguya_Summon02)
    call SaveUnitHandle(udg_ht,task,4,udg_SK_Kaguya_Summon03)
    call SaveUnitHandle(udg_ht,task,5,udg_SK_Kaguya_Summon04)
    call SaveReal(udg_ht,task,6,ox)
    call SaveReal(udg_ht,task,7,oy)
    call TimerStart(t,0.03,true,function Trig_Kaguya04_Main)
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Kaguya04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Init Kaguya
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Kaguya_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H00W')
    local integer i
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set gg_trg_KaguyaEx = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_KaguyaEx, h, EVENT_UNIT_DAMAGED )
    call TriggerRegisterUnitLifeEvent( gg_trg_KaguyaEx, h, LESS_THAN, 5.00 )
    call TriggerAddCondition( gg_trg_KaguyaEx, Condition( function Trig_KaguyaEx_Conditions ) )
    call TriggerAddAction( gg_trg_KaguyaEx, function Trig_KaguyaEx_Actions )
    
    set gg_trg_Kaguya01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kaguya01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Kaguya01, Condition( function Trig_Kaguya01_Conditions ) )
    call TriggerAddAction( gg_trg_Kaguya01, function Trig_Kaguya01_Actions )

    set gg_trg_Kaguya02 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Kaguya02, EVENT_PLAYER_UNIT_SUMMON )
    call TriggerAddCondition( gg_trg_Kaguya02, Condition( function Trig_Kaguya02_Conditions ) )
    call TriggerAddAction( gg_trg_Kaguya02, function Trig_Kaguya02_Actions )
    
    set gg_trg_Kaguya03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kaguya03, h, EVENT_UNIT_SPELL_CAST )
    call TriggerRegisterUnitEvent( gg_trg_Kaguya03, h, EVENT_UNIT_SPELL_FINISH )
    call TriggerAddCondition( gg_trg_Kaguya03, Condition( function Trig_Kaguya03_Conditions ) )
    call TriggerAddAction( gg_trg_Kaguya03, function Trig_Kaguya03_Actions )
    
    set gg_trg_Kaguya04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kaguya04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Kaguya04, Condition( function Trig_Kaguya04_Conditions ) )
    call TriggerAddAction( gg_trg_Kaguya04, function Trig_Kaguya04_Actions )

    set i = 0
    set udg_SK_Kaguya01_RGB[i+0] = 255
    set udg_SK_Kaguya01_RGB[i+1] = 0
    set udg_SK_Kaguya01_RGB[i+2] = 0
    set i = i + 3
    set udg_SK_Kaguya01_RGB[i+0] = 255
    set udg_SK_Kaguya01_RGB[i+1] = 63
    set udg_SK_Kaguya01_RGB[i+2] = 0
    set i = i + 3
    set udg_SK_Kaguya01_RGB[i+0] = 255
    set udg_SK_Kaguya01_RGB[i+1] = 255
    set udg_SK_Kaguya01_RGB[i+2] = 0
    set i = i + 3
    set udg_SK_Kaguya01_RGB[i+0] = 0
    set udg_SK_Kaguya01_RGB[i+1] = 255
    set udg_SK_Kaguya01_RGB[i+2] = 51
    set i = i + 3
    set udg_SK_Kaguya01_RGB[i+0] = 0
    set udg_SK_Kaguya01_RGB[i+1] = 255
    set udg_SK_Kaguya01_RGB[i+2] = 255
    set i = i + 3
    set udg_SK_Kaguya01_RGB[i+0] = 0
    set udg_SK_Kaguya01_RGB[i+1] = 51
    set udg_SK_Kaguya01_RGB[i+2] = 255
    set i = i + 3
    set udg_SK_Kaguya01_RGB[i+0] = 204
    set udg_SK_Kaguya01_RGB[i+1] = 0
    set udg_SK_Kaguya01_RGB[i+2] = 255
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Kaguya takes nothing returns nothing
    set gg_trg_Init_Kaguya = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Kaguya, function Trig_Init_Kaguya_Actions )
endfunction
//===========================================================================
// Trigger: Letty01
//
// 减速？？
//===========================================================================
//TESH.scrollpos=27
//TESH.alwaysfold=0
function Trig_Letty01_Conditions takes nothing returns boolean
    if GetSpellAbilityId() == 'A08W' then
        return true
    endif
    if GetSpellAbilityId() == 'A08X' then
        return true
    endif
    if GetSpellAbilityId() == 'A08Y' then
        return true
    endif
    if GetSpellAbilityId() == 'A08Z' then
        return true
    endif
    if GetSpellAbilityId() == 'A090' then
        return true
    endif
    return false
endfunction

function Trig_Letty01_Stop takes nothing returns nothing
    local unit caster
    local integer task
    local unit u
    local trigger trg
    local triggeraction tga
    //========
    set caster = GetTriggerUnit()
    set task = GetHandleId(caster)
    set u = LoadUnitHandle(udg_Hashtable,task,StringHash("u"))
    set trg = GetTriggeringTrigger()
    set tga = LoadTriggerActionHandle(udg_Hashtable,task,StringHash("tga"))
    //========
    call RemoveUnit(u)
    call TriggerRemoveAction(trg,tga)
    call DestroyTrigger(trg)
    //========
    set caster = null
    set trg = null
    set tga = null
    set u = null
endfunction

function Trig_Letty01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer task = GetHandleId(caster)
    local integer level = 0
    local unit u
    local real ox = GetLocationX(GetSpellTargetLoc())
    local real oy = GetLocationY(GetSpellTargetLoc())
    local trigger trg = CreateTrigger()
    local triggeraction tga
call DebugMsg("Start")
    set level = level + GetUnitAbilityLevel(caster,'A08W')
    set level = level + GetUnitAbilityLevel(caster,'A08X')
    set level = level + GetUnitAbilityLevel(caster,'A08Y')
    set level = level + GetUnitAbilityLevel(caster,'A08Z')
    set level = level + GetUnitAbilityLevel(caster,'A090')
call DebugMsg(I2S(level))
    set level = (level - 1)*5 + (GetUnitAbilityLevel(caster,'A08Q')+1)
    set u = CreateUnit(GetOwningPlayer(caster),'n00R',ox,oy,0)
    call UnitAddAbility(u,'A091')
    call SetUnitAbilityLevel(u,'A091',level)
    //--------
    call TriggerRegisterUnitEvent( trg,caster,EVENT_UNIT_SPELL_ENDCAST )
    set tga = TriggerAddAction( trg, function Trig_Letty01_Stop )
    call SaveUnitHandle(udg_Hashtable,task,StringHash("u"),u)
    call SaveTriggerActionHandle(udg_Hashtable,task,StringHash("tga"),tga)
    //========
    set trg = null
    set tga = null
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Letty01 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Letty02New
//===========================================================================
function Trig_Letty02New_Actions takes nothing returns nothing
endfunction

//===========================================================================
function InitTrig_Letty02New takes nothing returns nothing
    set gg_trg_Letty02New = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Letty02New, function Trig_Letty02New_Actions )
endfunction

//===========================================================================
// Trigger: Letty02
//
//     set udg_LLTunit = GetTriggerUnit()
//     set udg_LLLevel = GetUnitAbilityLevel(udg_LLTunit,'A08Q')
//     set udg_LLTpoint = GetUnitLoc(udg_LLTunit)
//     set udg_LLSpoint = GetSpellTargetLoc()
//     set udg_LLangle
//===========================================================================
function Trig_Letty02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A092'
endfunction

function Trig_Letty02_Actions takes nothing returns nothing  
    local real abilitycooldownlv01 = 11.50
    local real abilitycooldownlv02 = 11.50
    local real abilitycooldownlv03 = 11.50
    local real abilitycooldownlv04 = 11.50
    if UnitHasItemOfTypeBJ(GetTriggerUnit(), 'I00B') then
        if GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(GetTriggerUnit(),GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(GetTriggerUnit(),GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(GetTriggerUnit(),GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(GetTriggerUnit(),GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(GetTriggerUnit(),GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========  
    set udg_SK_Letty02_Tunit = GetTriggerUnit()
    set udg_SK_Letty02_Level = GetUnitAbilityLevel(udg_SK_Letty02_Tunit,'A08Q')
    set udg_SK_Letty02_Tpoint = GetUnitLoc(udg_SK_Letty02_Tunit)
    set udg_SK_Letty02_Spoint = GetSpellTargetLoc()
    set udg_SK_Letty02_angle = AngleBetweenPoints(udg_SK_Letty02_Tpoint, udg_SK_Letty02_Spoint)
    call CreateNUnitsAtLoc( 1, 'e00P', GetOwningPlayer(udg_SK_Letty02_Tunit), udg_SK_Letty02_Tpoint, ( udg_SK_Letty02_angle - 60.00 ) )
    set udg_SK_Letty02_Lunit = GetLastCreatedUnit()
    set udg_SK_Letty02_Jpoint = PolarProjectionBJ(udg_SK_Letty02_Tpoint, 30.00, udg_SK_Letty02_angle)
    set udg_SK_Letty02_in = -1.00
    set udg_SK_Letty02_i = 1
    call GroupClear( udg_SK_Letty02_Group )
    call GroupClear( udg_SK_Letty02_Group2 )
    call RemoveLocation( udg_SK_Letty02_Spoint )
    call EnableTrigger( gg_trg_Letty02main )
endfunction

//===========================================================================
function InitTrig_Letty02 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Letty02main
//===========================================================================
function Trig_Letty02main_Func009Func002001003001 takes nothing returns boolean
    return ( IsUnitType(GetFilterUnit(), UNIT_TYPE_STRUCTURE) == false )
endfunction

function Trig_Letty02main_Func009Func002001003002001 takes nothing returns boolean
    return ( IsUnitType(GetFilterUnit(), UNIT_TYPE_DEAD) == false )
endfunction

function Trig_Letty02main_Func009Func002001003002002001 takes nothing returns boolean
    return ( IsUnitAlly(GetFilterUnit(), GetOwningPlayer(udg_SK_Letty02_Lunit)) == false )
endfunction

function Trig_Letty02main_Func009Func002001003002002002 takes nothing returns boolean
    return ( IsUnitInGroup(GetFilterUnit(), udg_SK_Letty02_Group2) == false )
endfunction

function Trig_Letty02main_Func009Func002001003002002 takes nothing returns boolean
    return GetBooleanAnd( Trig_Letty02main_Func009Func002001003002002001(), Trig_Letty02main_Func009Func002001003002002002() )
endfunction

function Trig_Letty02main_Func009Func002001003002 takes nothing returns boolean
    return GetBooleanAnd( Trig_Letty02main_Func009Func002001003002001(), Trig_Letty02main_Func009Func002001003002002() )
endfunction

function Trig_Letty02main_Func009Func002001003 takes nothing returns boolean
    return GetBooleanAnd( Trig_Letty02main_Func009Func002001003001(), Trig_Letty02main_Func009Func002001003002() )
endfunction

function Trig_Letty02main_Func009Func002A takes nothing returns nothing
    call GroupAddUnit( udg_SK_Letty02_Group, GetEnumUnit() )
endfunction

function Trig_Letty02main_Func009Func003Func002C takes nothing returns boolean
    if ( not ( udg_SK_Letty02_i <= ( 1 + udg_SK_Letty02_Level ) ) ) then
        return false
    endif
    return true
endfunction

function Trig_Letty02main_Func009Func003C takes nothing returns boolean
    if ( not ( IsUnitGroupEmptyBJ(udg_SK_Letty02_Group) == false ) ) then
        return false
    endif
    return true
endfunction

function Trig_Letty02main_Func009C takes nothing returns boolean
    if ( not ( udg_SK_Letty02_Distance > 900.00 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Letty02main_Actions takes nothing returns nothing
    call SetUnitPositionLoc( udg_SK_Letty02_Lunit, udg_SK_Letty02_Jpoint )
    call RemoveLocation( udg_SK_Letty02_Lpoint )
    call RemoveLocation( udg_SK_Letty02_Jpoint )
    set udg_SK_Letty02_Lpoint = GetUnitLoc(udg_SK_Letty02_Lunit)
    set udg_SK_Letty02_in = ( udg_SK_Letty02_in + 1 )
    call SetUnitFacing( udg_SK_Letty02_Lunit, ( udg_SK_Letty02_angle + ( 60.00 * Sin(( udg_SK_Letty02_in * ( bj_PI / 25.00 ) )) ) ) )
    set udg_SK_Letty02_Jpoint = PolarProjectionBJ(udg_SK_Letty02_Lpoint, 10.00, GetUnitFacing(udg_SK_Letty02_Lunit))
    set udg_SK_Letty02_Distance = DistanceBetweenPoints(udg_SK_Letty02_Tpoint, udg_SK_Letty02_Lpoint)
    if ( Trig_Letty02main_Func009C() ) then
        call ExplodeUnitBJ( udg_SK_Letty02_Lunit )
        call GroupClear( udg_SK_Letty02_Group )
        call RemoveLocation( udg_SK_Letty02_Tpoint )
        call RemoveLocation( udg_SK_Letty02_Jpoint )
        call RemoveLocation( udg_SK_Letty02_Lpoint )
        set udg_SK_Letty02_Distance = 0.00
        call DisableTrigger( GetTriggeringTrigger() )
    else
        call ForGroupBJ( GetUnitsInRangeOfLocMatching(100.00, udg_SK_Letty02_Lpoint, Condition(function Trig_Letty02main_Func009Func002001003)), function Trig_Letty02main_Func009Func002A )
        if ( Trig_Letty02main_Func009Func003C() ) then
            call GroupAddUnitSimple( FirstOfGroup(udg_SK_Letty02_Group), udg_SK_Letty02_Group2 )
            if ( Trig_Letty02main_Func009Func003Func002C() ) then
                call CreateNUnitsAtLoc( 1, 'n001', GetOwningPlayer(udg_SK_Letty02_Tunit), udg_SK_Letty02_Lpoint, bj_UNIT_FACING )
                set udg_SK_Letty02_Sunit = GetLastCreatedUnit()
                call UnitApplyTimedLife( udg_SK_Letty02_Sunit, 'BHwe', 5.00 )
                call UnitAddAbilityBJ( 'A093', udg_SK_Letty02_Sunit )
                call SetUnitAbilityLevelSwapped( 'A093', udg_SK_Letty02_Sunit, GetUnitAbilityLevelSwapped('A092', udg_SK_Letty02_Tunit) )
                call IssueTargetOrder( udg_SK_Letty02_Sunit, "thunderbolt", FirstOfGroup(udg_SK_Letty02_Group) )
                call GroupClear( udg_SK_Letty02_Group )
                set udg_SK_Letty02_i = ( udg_SK_Letty02_i + 1 )
            else
                call KillUnit( udg_SK_Letty02_Lunit )
                call GroupClear( udg_SK_Letty02_Group )
                call GroupClear( udg_SK_Letty02_Group2 )
                set udg_SK_Letty02_Distance = 0.00
                call RemoveLocation( udg_SK_Letty02_Tpoint )
                call RemoveLocation( udg_SK_Letty02_Lpoint )
                call RemoveLocation( udg_SK_Letty02_Jpoint )
            endif
        else
            call DoNothing(  )
        endif
    endif
endfunction

//===========================================================================
function InitTrig_Letty02main takes nothing returns nothing
    set gg_trg_Letty02main = CreateTrigger(  )
    call DisableTrigger( gg_trg_Letty02main )
    call TriggerRegisterTimerEventPeriodic( gg_trg_Letty02main, 0.02 )
    call TriggerAddAction( gg_trg_Letty02main, function Trig_Letty02main_Actions )
endfunction

//===========================================================================
// Trigger: Letty04
//===========================================================================
//TESH.scrollpos=18
//TESH.alwaysfold=0
function Trig_Letty04_Conditions takes nothing returns boolean
    if ( not ( GetSpellAbilityId() == 'A08P' ) ) then
        return false
    endif
    return true
endfunction


function Trig_Letty04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local location loc = GetUnitLoc(caster)
    local unit LD04 =  CreateUnitAtLoc( GetTriggerPlayer(), 'n01P', loc , 0 )
    local integer level = GetUnitAbilityLevelSwapped('A08Q', GetTriggerUnit())
    local unit LD04FOG = CreateUnitAtLoc( GetTriggerPlayer(), 'n01Q', loc , 0 )
    //========
    local real abilitycooldownlv01 = 100
    local real abilitycooldownlv02 = 85
    local real abilitycooldownlv03 = 70
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========    
    call SetUnitAnimation(LD04, "birth" )    
    call UnitApplyTimedLife(LD04, 'BHwe', 12 )
    call UnitApplyTimedLife(LD04FOG, 'BHwe', 12 )
    if     level==1 then
        call UnitAddAbilityBJ( 'A08R', LD04 )
        call SetUnitAbilityLevelSwapped( 'A08S', LD04, GetUnitAbilityLevelSwapped('A08P', GetTriggerUnit()) )
    elseif level==2 then
        call UnitAddAbilityBJ( 'A08S', LD04 )
        call SetUnitAbilityLevelSwapped( 'A08T', LD04, GetUnitAbilityLevelSwapped('A08P', GetTriggerUnit()) )
    elseif level==3 then
        call UnitAddAbilityBJ( 'A08T', LD04 )
        call SetUnitAbilityLevelSwapped( 'A0U8', LD04, GetUnitAbilityLevelSwapped('A08P', GetTriggerUnit()) )
    elseif level==4  then
        call UnitAddAbilityBJ( 'A08U', LD04 )
        call SetUnitAbilityLevelSwapped( 'A08V', LD04, GetUnitAbilityLevelSwapped('A08P', GetTriggerUnit()) )
    else
        call UnitAddAbilityBJ( 'A08V', LD04 )
        call SetUnitAbilityLevelSwapped( 'A08R', LD04, GetUnitAbilityLevelSwapped('A08P', GetTriggerUnit()) )
    endif
    call RemoveLocation(loc)
    set caster = null
    set LD04 =  null
    set LD04FOG = null
    set loc = null
endfunction

//===========================================================================
function InitTrig_Letty04 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Initial Letty
//===========================================================================
//TESH.scrollpos=10
//TESH.alwaysfold=0
function Trig_Initial_Letty_Actions takes nothing returns nothing

//=====================================  1  ===========================================================

    set gg_trg_Letty01 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Letty01, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Letty01, Condition( function Trig_Letty01_Conditions ) )
    call TriggerAddAction( gg_trg_Letty01, function Trig_Letty01_Actions )

//=====================================  2  ===========================================================

    set gg_trg_Letty02 = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Letty02, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Letty02, Condition( function Trig_Letty02_Conditions ) )
    call TriggerAddAction( gg_trg_Letty02, function Trig_Letty02_Actions )

//=====================================  3  ===========================================================



//=====================================  4  ===========================================================

    set gg_trg_Letty04 = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Letty04, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Letty04, Condition( function Trig_Letty04_Conditions ) )
    call TriggerAddAction( gg_trg_Letty04, function Trig_Letty04_Actions )

//=====================================================================================================
endfunction

//===========================================================================
function InitTrig_Initial_Letty takes nothing returns nothing
    set gg_trg_Initial_Letty = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Letty, function Trig_Initial_Letty_Actions )
endfunction

//===========================================================================
// Trigger: Nitori Bag
//
// 河童能量槽
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Nitori_Bag_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A03T'
endfunction

function Trig_Nitori_Bag_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetLocationX(udg_BackStage)
    local real ty = GetLocationY(udg_BackStage)
    local item w
    local item v
    local integer i
    //========
    if udg_SK_Nitori_Load == false then
    set udg_SK_Nitori_Load = true
    call DisplayTextToPlayer(GetOwningPlayer(caster),0.0,0.0,"|cffffcc00能量槽打开|r")
    else
    set udg_SK_Nitori_Load = false
    call DisplayTextToPlayer(GetOwningPlayer(caster),0.0,0.0,"|cffffcc00能量槽关闭|r")
    endif
    //========
    set i = 0
    loop
        exitwhen i>=bj_MAX_INVENTORY
        
        set w = UnitItemInSlot(caster,i)
        set v = udg_SK_Nitori_Bag[i]
        set udg_SK_Nitori_Bag[i] = w
        
        call UnitRemoveItem(caster,w)
        call SetItemVisible(w,false)
        call SetItemPosition(w,tx,ty)
        
        call SetItemPosition(v,ox,oy)
        call SetItemVisible(v,true)
        call UnitAddItem(caster,v)
        
        set i = i + 1
    endloop
    //========
    set caster = null
    set w = null
    set v = null
endfunction

//===========================================================================
function InitTrig_Nitori_Bag takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Nitori Loaded
//
// 河童能量槽不能放别的物品
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Nitori_Loaded_Conditions takes nothing returns boolean
    return (GetItemTypeId(GetManipulatedItem()) != 'I01E') and (udg_SK_Nitori_Load == true)
endfunction

function Trig_Nitori_Loaded_Actions takes nothing returns nothing
    call UnitRemoveItem(GetTriggerUnit(), GetManipulatedItem())
    call DisplayTextToPlayer( GetOwningPlayer(GetTriggerUnit()), 0, 0, "|cffff0000能量槽中只能装填小黄瓜|r" )
endfunction

//===========================================================================
function InitTrig_Nitori_Loaded takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Nitori01
//===========================================================================
//TESH.scrollpos=18
//TESH.alwaysfold=0
function Trig_Nitori01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A094' and GetUnitTypeId(GetTriggerUnit())=='H00M'
endfunction

function Trig_Nitori01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,1)
    local real facing = GetUnitFacing(caster)*bj_DEGTORAD
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real speed = (GetUnitMoveSpeed(caster) * 0.60 + 200) / 50

    if GetUnitAbilityLevel(caster, 'B051') > 0 then
        if IsUnitLimited(caster)==false then
            call SetUnitXY(caster,ox+speed*Cos(facing),oy+speed*Sin(facing))
        endif
    else
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,task)
        call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A0GF',true)
        call UnitRemoveAbility(caster,'A0LL')
    endif
    set t = null
    set caster = null
endfunction

function Trig_Nitori01_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    //========
    local real abilitycooldownlv01 = 20
    local real abilitycooldownlv02 = 18
    local real abilitycooldownlv03 = 16
    local real abilitycooldownlv04 = 14
    if GetUnitAbilityLevel(caster, 'B051') > 0 then
        if UnitHasItemOfTypeBJ(caster, 'I00B') then
            if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
            endif
        endif
    endif
    //========
    call SaveTimerHandle(udg_Hashtable,task,0,t)
    call SaveUnitHandle(udg_Hashtable,task,1,caster)
    call TimerStart(t,0.02,true,function Trig_Nitori01_Main)
    call SetPlayerAbilityAvailable(GetOwningPlayer(caster),'A0GF',false)
    call UnitAddAbility(caster,'A0LL')
    call UnitMakeAbilityPermanent( caster, true, 'A0LL' )
    call PlayUnitAnimeNoLoop(caster,"Stand Alternate")
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Nitori01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Nitori02
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Nitori02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0GF'
endfunction

function Trig_Nitori02_Bullet takes nothing returns nothing
    local timer t2 = GetExpiredTimer()
    local integer task2 = GetHandleId(t2)
    local unit u = LoadUnitHandle(udg_ht,task2,1)
    local real a = bj_DEGTORAD*LoadReal(udg_ht,task2,2)
    local real i = LoadReal(udg_ht,task2,3)
    local lightning lt = LoadLightningHandle(udg_ht,task2,4)
    local group grp1 = LoadGroupHandle(udg_ht,task2,5)
    local group grp2 = LoadGroupHandle(udg_ht,task2,6)
    local real damage = LoadReal(udg_ht,task2,7)
    local real d = 80
    local real x = GetUnitX(u)+d*Cos(a)
    local real y = GetUnitY(u)+d*Sin(a)
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(u))
    local unit v
    if i>=0 then
        call SetUnitXY(u,x,y)
        call DestroyEffect(AddSpecialEffect("NewDirtEX.mdx",x,y))
        call SaveReal(udg_ht,task2,3,i-d)
        call SetLightningColor( lt, 0.00, 1, 0.00, i/2000 )
        call GroupEnumUnitsInRange(grp1,x,y,150,iff)
        loop
        set v = FirstOfGroup(grp1)
        exitwhen v == null
            if IsUnitInGroup(v,grp2) then
                call GroupRemoveUnit(grp1,v)
            else
                call GroupRemoveUnit(grp1,v)
                call GroupAddUnit(grp2,v)
                call IssueTargetOrder(u,"slow",v)
                if IsUnitType(v,UNIT_TYPE_STRUCTURE) then
                    call UnitDamageTarget(u,v,damage*0.50,false,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
                else 
                    call UnitDamageTarget(u,v,damage,false,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
                endif
                set damage = damage*0.90
            endif
        endloop
        call SaveReal(udg_ht,task2,7,damage)
        call GroupClear(grp1)
    else
        call KillUnit(u)
        call DestroyGroup(grp1)
        call DestroyGroup(grp2)
        call DestroyLightning(lt)
        call PauseTimer(t2)
        call DestroyTimer(t2)
        call FlushChildHashtable(udg_ht,task2)
    endif
    set t2 = null
    set u = null
    set lt = null
    set grp1 = null
    set grp2 = null
    set iff = null
    set v = null
endfunction

function Trig_Nitori02_Frame takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,1)
    local integer level = LoadInteger(udg_ht,task,2)
    local real a = LoadReal(udg_ht,task,3)
    local integer i = LoadInteger(udg_ht,task,4)
    local timer t2
    local integer task2
    local unit u
    local lightning lt
    local real ox
    local real oy
    local real oz
    local real px
    local real py
    local real pz
    local group grp1
    local group grp2
    local item itm = null
    local integer j
    local real damage = 70+level*80 //最大伤害
    //========
    if i<10 and GetUnitCurrentOrder(caster)==OrderId("clusterrockets") then
        if i==0 then
            call SetUnitFacing(caster,a)
            call DestroyEffect(AddSpecialEffectTarget("GreenShotExplod.mdx",caster,"sprite first"))
            call DestroyEffect(AddSpecialEffectTarget("GreenShotExplod.mdx",caster,"sprite first"))
            call AttachSoundToUnit(gg_snd_GetPower, caster)
            call SetSoundVolume(gg_snd_GetPower, 127)
            call StartSound(gg_snd_GetPower)
        endif
        
        if i==7 then
        //判断黄瓜弹药
            if udg_SK_Nitori_Load == false then
                set j = 0
                loop
                exitwhen j>=bj_MAX_INVENTORY
                    if GetItemTypeId(udg_SK_Nitori_Bag[j])=='I01E' then
                        set itm = udg_SK_Nitori_Bag[j]
                    endif        
                set j = j + 1
                endloop
            endif
        //发射
            if itm == null then
                call DisplayTextToPlayer(GetOwningPlayer(caster),0.0,0.0,"|cffff0000能量不足！需在能量槽放入小黄瓜以提供能源|r")
            else
                call RemoveItem(itm)

                call AdjustPlayerStateBJ( 13, GetOwningPlayer(caster),PLAYER_STATE_RESOURCE_GOLD)

                set ox = GetUnitX(caster)+80*Cos(bj_DEGTORAD*a)
                set oy = GetUnitY(caster)+80*Sin(bj_DEGTORAD*a)
                set oz = GetPositionZ(ox,oy)+60
                set px = GetUnitX(caster)+2000*Cos(bj_DEGTORAD*a)
                set py = GetUnitY(caster)+2000*Sin(bj_DEGTORAD*a)
                set pz = GetPositionZ(px,py)+60
            
                set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,a)
                call UnitAddAbility(u,'A0GH')
                set lt = AddLightningEx("TCLE",true,ox,oy,oz,px,py,pz)
                call SetLightningColor( lt, 0.00, 1, 0.00, 1 )
                set grp1 = CreateGroup()
                set grp2 = CreateGroup()
                //==
                set t2 = CreateTimer()
                set task2 = GetHandleId(t2)
                call SaveTimerHandle(udg_ht,task2,0,t2)
                call SaveUnitHandle(udg_ht,task2,1,u)
                call SaveReal(udg_ht,task2,2,a)
                call SaveReal(udg_ht,task2,3,2000)//射程
                call SaveLightningHandle(udg_ht,task2,4,lt)
                call SaveGroupHandle(udg_ht,task2,5,grp1)
                call SaveGroupHandle(udg_ht,task2,6,grp2)
                call SaveReal(udg_ht,task2,7,damage)
                //==
                call TimerStart(t2,0.02,true,function Trig_Nitori02_Bullet)
            endif
            call StopSound(gg_snd_GetPower,false,true)
        endif
        
        call SaveInteger(udg_ht,task,4,i + 1)
    else
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set t2 = null
    set u = null
    set caster = null
    set lt = null
    set grp1 = null
    set grp2 = null
    set itm = null
endfunction

function Trig_Nitori02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 9
    local real abilitycooldownlv02 = 7
    local real abilitycooldownlv03 = 5
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    call SaveTimerHandle(udg_ht,task,0,t)
    call SaveUnitHandle(udg_ht,task,1,caster)
    call SaveInteger(udg_ht,task,2,level)
    call SaveReal(udg_ht,task,3,a)
    call SaveInteger(udg_ht,task,4,0)
    call TimerStart(t,0.1,true,function Trig_Nitori02_Frame)
    //========
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Nitori02 takes nothing returns nothing
endfunction


//===========================================================================
// Trigger: Nitori03
//===========================================================================
//TESH.scrollpos=18
//TESH.alwaysfold=0
function Trig_Nitori03_Conditions takes nothing returns boolean
    local integer j
    local item itm = null
    //判断黄瓜弹药
    if udg_SK_Nitori_Load == false then
        set j = 0
        loop
        exitwhen j>=bj_MAX_INVENTORY
            if GetItemTypeId(udg_SK_Nitori_Bag[j])=='I01E' then
                set itm = udg_SK_Nitori_Bag[j]
            endif        
        set j = j + 1
        endloop
    endif
    if GetUnitAbilityLevel(GetTriggerUnit(),'A095')==0 then
        set itm = null
        return false
    endif
    if GetUnitAbilityLevel(GetTriggerUnit(),'A096')!=0 then
        set itm = null
        return false
    endif
    if GetSpellAbilityId()!='A094' and GetSpellAbilityId()!='A0GF' and GetSpellAbilityId()!='A0LK' then
        set itm = null
        return false
    endif
    if GetSpellAbilityId()=='A094' then
        if GetUnitTypeId(GetTriggerUnit())=='H00S' then
        set itm = null
        return false
        endif
    endif
    if GetSpellAbilityId()=='A0GF' and itm == null then
        set itm = null
        return false
    endif
    set itm = null
    return true
endfunction

function Trig_Nitori03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A095')
    local integer atklevel = 0
    call UnitAddAbility(caster,'A096')
    call UnitMakeAbilityPermanent( caster, true, 'A096' )
    call UnitMakeAbilityPermanent( caster, true, 'A0GG' )
    call UnitMakeAbilityPermanent( caster, true, 'A006' )
    call UnitMakeAbilityPermanent( caster, true, 'A097' )
    call UnitMakeAbilityPermanent( caster, true, 'A0LN' )
    if GetHeroLevel(caster) < 6 then
        set atklevel = 0
    elseif GetHeroLevel(caster) < 11 then
        set atklevel = 1
    elseif GetHeroLevel(caster) < 16 then
        set atklevel = 2
    elseif GetHeroLevel(caster) < 21 then
        set atklevel = 3
    elseif GetHeroLevel(caster) < 26 then
        set atklevel = 4
    endif
    call SetUnitAbilityLevel(caster,'A097',level + atklevel * 4)
    set caster = null
endfunction

//===========================================================================
function InitTrig_Nitori03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Nitori03 Active
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Nitori03_Active_Conditions takes nothing returns boolean
    if GetUnitAbilityLevel(GetEventDamageSource(),'A006')==0 then
        return false
    endif
    if GetTriggerUnit() != GetEventDamageSource() then
        return false
    endif
    if GetEventDamage() > 0.01 or GetEventDamage() <= 0 then
        return false
    endif
    call UnitRemoveAbility(GetEventDamageSource(),'A096')
    return false
endfunction
//===========================================================================
function InitTrig_Nitori03_Active takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Nitori04
//===========================================================================
//TESH.scrollpos=209
//TESH.alwaysfold=0
function Trig_Nitori04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0LK'
endfunction

//=============================================
//Script:  Nitori_Skill4
//=============================================
//Skill Id:         'A0LK'
//RocketUnit Id:    'u00T'
//AttackUnit:       'o000' 
//AttackAbility:    'A0OE' 

//---------------------------------------------
//Support Functions
//---------------------------------------------
function Nitori_SK4_DegreeApproach takes real targetdeg, real currentdeg, real maxrotation returns real
    local real flag1 = SinBJ(targetdeg-currentdeg)
    local real flag2 = CosBJ(maxrotation)
    local real flag3 = CosBJ(targetdeg-currentdeg)
    
    if flag1 >=0 then
        if flag2>flag3 then
            return currentdeg+maxrotation
        else
            return targetdeg
        endif
    else
        if flag2>flag3 then
            return currentdeg-maxrotation
        else
            return targetdeg
        endif
    endif
endfunction

function Nitori_SK4_Abs takes real x returns real
    if x>=0 then
        return x
    else
        return -1.0*x
    endif
endfunction

function Nitori_SK4_Degree takes real deg1, real deg2 returns boolean
    return true//Nitori_SK4_Abs((deg1-deg2)-180.0*R2I((deg1-deg2)/180.0)) <= 15.0   //此值为攻击精度 即浮游炮面向目标+-5.0度范围内才会攻击
endfunction

//---------------------------------------------
//Main Trigger
//---------------------------------------------
function Nitori_Skill4_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer tid = GetHandleId(t)
    
    //总体控制数据
    local integer count = LoadInteger(udg_Hashtable, tid, 1)
    local integer countmax = LoadInteger(udg_Hashtable, tid, 2)
    local integer attbk = LoadInteger(udg_Hashtable, tid, 3)
    local real maxro = LoadReal(udg_Hashtable, tid, 4)
    //local integer level = LoadInteger(udg_Hashtable, tid, 5)
    local unit target = LoadUnitHandle(udg_Hashtable, tid, 6)
    local unit caster = LoadUnitHandle(udg_Hashtable, tid, 7) 
    local real speed = LoadReal(udg_Hashtable, tid, 8)
    local real range = LoadReal(udg_Hashtable, tid, 12)
    local real endrange = LoadReal(udg_Hashtable, tid, 13)
    local integer attp = LoadInteger(udg_Hashtable, tid, 14)
    local integer fdl = LoadInteger(udg_Hashtable, tid, 15)
    //火箭飞行控制
    local unit Rocket
    local integer RocketState
    local unit RocketTarget
    local real RocketX
    local real RocketY
    local real RocketFac
    local real RocketTargetXFix
    local real RocketTargetYFix
    local boolean RocketLockOn
    //临时数据
    local real x
    local real y
    local real deg
    local real fac
    local unit helper
    //控制数据
    local integer index = 0
    local integer maxindex = LoadInteger(udg_Hashtable, tid, 9)
    local integer i = 1
    local integer RocketNum = LoadInteger(udg_Hashtable, tid, 10)
    local real FrameRate = LoadReal(udg_Hashtable, tid, 11)

    if count>=countmax or IsUnitType(target, UNIT_TYPE_DEAD) then
        if countmax != 0 then
            call SaveInteger(udg_Hashtable, tid, 2, 0) 
            call SaveInteger(udg_Hashtable, tid, 1, -1)
            loop
                exitwhen(i>RocketNum)
                set index = index+100
                call SaveUnitHandle(udg_Hashtable, tid, index+2, caster)
                set i = i + 1
            endloop
        else
            if count+1 <= -1*RocketNum then
                call PauseTimer(t)
                call DestroyTimer(t)
                call FlushChildHashtable(udg_Hashtable, tid)
            endif
        endif
    endif
    loop
        exitwhen(i>RocketNum)
        set index = index + 100
        set Rocket = LoadUnitHandle(udg_Hashtable, tid, index)
        set RocketState = LoadInteger(udg_Hashtable, tid, index+1)
        set RocketTarget = LoadUnitHandle(udg_Hashtable, tid, index+2)
        set RocketTargetXFix = LoadReal(udg_Hashtable, tid, index+3)
        set RocketTargetYFix = LoadReal(udg_Hashtable, tid, index+4)
        set RocketLockOn = LoadBoolean(udg_Hashtable, tid, index+5)
        if Rocket == null and countmax != 0 then
            if RocketState >=0 then
                set helper = CreateUnit(GetOwningPlayer(caster), 'u00T', GetUnitX(caster), GetUnitY(caster), GetUnitFacing(caster)+180.0+GetRandomReal(-90, 90))

                call SaveUnitHandle(udg_Hashtable, tid, index, helper)
                call SaveUnitHandle(udg_Hashtable, tid, index+2, target)
                call SaveReal(udg_Hashtable, tid, index+3, 0)
                call SaveReal(udg_Hashtable, tid, index+4, 0)
                call SaveBoolean(udg_Hashtable, tid, index+5, true)
            else
                call SaveInteger(udg_Hashtable, tid, index+1, RocketState+1)
            endif
        endif
        if Rocket != null then
            set RocketX = GetUnitX(Rocket)
            set RocketY = GetUnitY(Rocket)
            set RocketFac = GetUnitFacing(Rocket)
            set x = GetUnitX(RocketTarget)+RocketTargetXFix
            set y = GetUnitY(RocketTarget)+RocketTargetYFix
            set deg = Atan2(y-RocketY, x-RocketX)/3.1415926*180.0
            if RocketTarget == target and RocketState<=0 then
                if (x-RocketX)*(x-RocketX)+(y-RocketY)*(y-RocketY)<=range then
                    if Nitori_SK4_Degree(RocketFac, deg) then
                        set helper = CreateUnit(GetOwningPlayer(Rocket), 'o000', RocketX, RocketY, RocketFac)
                        call UnitAddAbility(helper, 'A0OE')
                        call SetUnitAbilityLevel(helper, 'A0OE', fdl)
                        //call SetUnitAbilityLevel(helper, 'A001', level)
                        call IssuePointOrder(helper, "breathoffire", x, y) //RocketX+100.0*CosBJ(RocketFac), RocketY+100.0*SinBJ(RocketFac))
                        //call IssueTargetOrder(helper, "breathoffire", RocketTarget)
                    endif
                    call SaveInteger(udg_Hashtable, tid, index+1, attbk)
                    call SaveUnitHandle(udg_Hashtable, tid, index+2, target)
                    call SaveReal(udg_Hashtable, tid, index+3, GetRandomReal(-100,100))
                    call SaveReal(udg_Hashtable, tid, index+4, GetRandomReal(-100,100))
                    call SaveBoolean(udg_Hashtable, tid, index+5, false)
                endif
            endif
            if RocketTarget == caster and countmax == 0 then
                if (x-RocketX)*(x-RocketX)+(y-RocketY)*(y-RocketY)<=endrange then
                    call KillUnit(Rocket)
                    call RemoveUnit(Rocket)
                    call SaveUnitHandle(udg_Hashtable, tid, index, null)
                    call SaveInteger(udg_Hashtable, tid, 1, count-1)
                endif
            endif
            //if RocketState<=attp then
                set fac = Nitori_SK4_DegreeApproach(deg, RocketFac, maxro)
                call SetUnitFacingTimed(Rocket, fac, FrameRate)
            if RocketState<=attp then
                set deg = fac/180.0*3.1415926
                set RocketX = RocketX+speed*Cos(deg)
                set RocketY = RocketY+speed*Sin(deg)
                call SetUnitXY(Rocket, RocketX, RocketY)                            //此函数改为THD中移动单位函数   <<<------
            endif

            if RocketState > 0 then
                call SaveInteger(udg_Hashtable, tid, index+1, RocketState-1)
            else
                if RocketLockOn == false and countmax != 0 then
                    call SaveUnitHandle(udg_Hashtable, tid, index+2, target)
                    call SaveReal(udg_Hashtable, tid, index+3, 0)
                    call SaveReal(udg_Hashtable, tid, index+4, 0)
                    call SaveBoolean(udg_Hashtable, tid, index+5, true)
                endif
            endif
        endif
        set i = i + 1
    endloop
    
    if countmax != 0  then
        call SaveInteger(udg_Hashtable, tid, 1, count+1)
    endif
    
    set t = null
    set caster = null
    set target = null
    set Rocket = null
    set RocketTarget = null
    set helper = null
endfunction

function Trig_Nitori_Skill4_Actions takes nothing returns nothing
    local unit target = GetSpellTargetUnit()
    local unit caster = GetTriggerUnit()
    local timer t = CreateTimer()
    local integer tid = GetHandleId(t)
    local integer level = GetUnitAbilityLevel(caster, 'A0LK')
    local integer i = 1
    local integer index = 0  
    //----------------         
    //参数设定
    //----------------   
    local real FrameRate = 0.02         //帧率
    local integer RocketNum = 2*level   //火箭弹数量
    local real speed = 900.0            //飞行速度
    local real SkillLastTime = 8.0      //技能持续时间
    local real CreateBlank = 0.15       //召唤子机间隔
    local real AttackBlank = 1.5        //攻击间隔 在此间隔内子机向英雄飞行 包含停顿时间
    local real AttackPause = 0.5        //攻击后停顿时间(此值要小于攻击间隔)
    local real MaxRotation = 10.0       //每帧的最大转动角度 意义不明...总之数值越小绕圈越大..
    local real AttackRange = 250.0      //子机攻击范围 距离目标此值时开始攻击
    local real SkillEndRange = 25.0     //回收子机距离判定
                                        //攻击精度设定详见SupportFunction --> function Nitori_SK4_Degree
    //----------------
    local integer FireDamageLevel = 1
    //========
    local real abilitycooldownlv01 = 60
    local real abilitycooldownlv02 = 60
    local real abilitycooldownlv03 = 60
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========   
    if GetHeroLevel(caster) >= 6 and GetHeroLevel(caster) < 10 then
        set FireDamageLevel = 1
    elseif GetHeroLevel(caster) >= 10 and GetHeroLevel(caster) < 15 then
        set FireDamageLevel = 2
    elseif GetHeroLevel(caster) >= 15 and GetHeroLevel(caster) < 20 then
        set FireDamageLevel = 3
    elseif GetHeroLevel(caster) >= 20 and GetHeroLevel(caster) < 25 then
        set FireDamageLevel = 4
    elseif GetHeroLevel(caster) == 25 then
        set FireDamageLevel = 5
    endif
    //----------------

    call TimerStart(t, FrameRate, true, function Nitori_Skill4_Main)
    call SaveTimerHandle(udg_Hashtable, tid, 0, t)
    call SaveInteger(udg_Hashtable, tid, 1, 1)
    call SaveInteger(udg_Hashtable, tid, 2, R2I(SkillLastTime/FrameRate))
    call SaveInteger(udg_Hashtable, tid, 3, R2I(AttackBlank/FrameRate))
    call SaveReal(udg_Hashtable, tid, 4, MaxRotation)
    //call SaveInteger(udg_Hashtable, tid, 5, level)
    call SaveUnitHandle(udg_Hashtable, tid, 6, target)
    call SaveUnitHandle(udg_Hashtable, tid, 7, caster) 
    call SaveReal(udg_Hashtable, tid, 8, speed*FrameRate)
    call SaveReal(udg_Hashtable, tid, 12, AttackRange*AttackRange) 
    call SaveReal(udg_Hashtable, tid, 13, SkillEndRange*SkillEndRange) 
    call SaveInteger(udg_Hashtable, tid, 14, R2I((AttackBlank-AttackPause)/FrameRate)) 
    call SaveInteger(udg_Hashtable, tid, 15, FireDamageLevel)
    loop
        exitwhen(i>RocketNum)
        set index = index+100
        call SaveUnitHandle(udg_Hashtable, tid, index, null)
        call SaveInteger(udg_Hashtable, tid, index+1, -1*(i-1)*R2I(CreateBlank/FrameRate))
        call SaveUnitHandle(udg_Hashtable, tid, index+2, caster)
        call SaveReal(udg_Hashtable, tid, index+3, 0)
        call SaveReal(udg_Hashtable, tid, index+4, 0)
        call SaveBoolean(udg_Hashtable, tid, index+5, false)
        set i = i + 1
    endloop                    
    call SaveInteger(udg_Hashtable, tid, 9, index)
    call SaveInteger(udg_Hashtable, tid, 10, RocketNum)
    call SaveReal(udg_Hashtable, tid, 11, FrameRate)


    
    set target = null
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Nitori04 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Initial Nitori
//===========================================================================
//TESH.scrollpos=23
//TESH.alwaysfold=0
function Trig_Initial_Nitori_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H00M')
    local integer i
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_Nitori_Bag = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Nitori_Bag, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Nitori_Bag, Condition( function Trig_Nitori_Bag_Conditions ) )
    call TriggerAddAction( gg_trg_Nitori_Bag, function Trig_Nitori_Bag_Actions )
    
    set gg_trg_Nitori_Loaded = CreateTrigger(  )
    call TriggerRegisterUnitEvent( gg_trg_Nitori_Loaded, h, EVENT_UNIT_PICKUP_ITEM )
    call TriggerAddCondition( gg_trg_Nitori_Loaded, Condition( function Trig_Nitori_Loaded_Conditions ) )
    call TriggerAddAction( gg_trg_Nitori_Loaded, function Trig_Nitori_Loaded_Actions )

    set gg_trg_Nitori01 = CreateTrigger(  )
    call TriggerRegisterUnitEvent( gg_trg_Nitori01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Nitori01, Condition( function Trig_Nitori01_Conditions ) )
    call TriggerAddAction( gg_trg_Nitori01, function Trig_Nitori01_Actions )
    
    set gg_trg_Nitori02 = CreateTrigger(  )
    call TriggerRegisterUnitEvent( gg_trg_Nitori02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Nitori02, Condition( function Trig_Nitori02_Conditions ) )
    call TriggerAddAction( gg_trg_Nitori02, function Trig_Nitori02_Actions )
    
    set gg_trg_Nitori03 = CreateTrigger(  )
    call TriggerRegisterUnitEvent( gg_trg_Nitori03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Nitori03, Condition( function Trig_Nitori03_Conditions ) )
    call TriggerAddAction( gg_trg_Nitori03, function Trig_Nitori03_Actions )
    
    set gg_trg_Nitori03_Active = CreateTrigger(  )
    call TriggerRegisterUnitEvent( gg_trg_Nitori03_Active, h, EVENT_UNIT_DAMAGED )
    call TriggerAddCondition( gg_trg_Nitori03_Active, Condition( function Trig_Nitori03_Active_Conditions ) )  
    
    set gg_trg_Nitori04 = CreateTrigger(  )
    call TriggerRegisterUnitEvent( gg_trg_Nitori04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Nitori04, Condition( function Trig_Nitori04_Conditions ) )
    call TriggerAddAction( gg_trg_Nitori04, function Trig_Nitori_Skill4_Actions )

    call UnitAddAbility(h,'A096')
    call UnitRemoveAbility(h,'A096')

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Nitori takes nothing returns nothing
    set gg_trg_Initial_Nitori = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Nitori, function Trig_Initial_Nitori_Actions )
endfunction//===========================================================================
// Trigger: YamameDS
//===========================================================================
function Trig_YamameDS_Conditions takes nothing returns boolean
    return IsUnitAlive(GetPlayerCharacter(GetTriggerPlayer()))
endfunction

function Trig_YamameDS_Actions takes nothing returns nothing
    local player who = GetTriggerPlayer()
    local unit caster = GetPlayerCharacter(who)
    local integer atk = 13 + R2I(GetHeroStr(caster,true)/4.5)
    local integer spe = R2I(GetHeroAgi(caster,true)/4.5)
    call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00小蜘蛛攻击力：|r" + I2S(atk) + "|c00ffff00 攻击速度：|r+" + I2S(spe) + "%")
    set who = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_YamameDS takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yamame Dis
//===========================================================================
function Trig_Yamame_Dis_Conditions takes nothing returns boolean
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if GetUnitTypeId(GetEventDamageSource()) == 'n03T' then
        return false
    endif
    if GetEventDamage() == 0.00 then
        return false
    endif
    return GetUnitTypeId(GetPlayerCharacter(GetOwningPlayer(GetEventDamageSource()))) == 'O008'
endfunction

function Trig_Yamame_Dis_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local unit u
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local real damage = LoadReal(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,3)
    set i = i - 1
    call SaveInteger(udg_ht,task,3,i)
    if IsUnitType(target,UNIT_TYPE_DEAD) == false then
        call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\PoisonArrow\\PoisonArrowMissile.mdl",tx,ty))   
        set u = CreateUnit(GetOwningPlayer(caster),'n03T',tx,ty,0)
        call UnitDamageTarget(u,target,damage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    endif
    if i == 0 or IsUnitType(target,UNIT_TYPE_DEAD) then
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_Yamame_Dis_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetPlayerCharacter(GetOwningPlayer(GetEventDamageSource()))
    local unit target = GetTriggerUnit()
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local real damage = GetEventDamage() * 0.05
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\PoisonArrow\\PoisonArrowMissile.mdl",tx,ty))
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveReal(udg_ht,task,2,damage)
    call SaveInteger(udg_ht,task,3,6)
    call TimerStart(t,2.00,true,function Trig_Yamame_Dis_Main)
    set t = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Yamame_Dis takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yamame01
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Yamame01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A08F'
endfunction

function Trig_Yamame01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local real px
    local real py
    local real a = LoadReal(udg_ht,task,0)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local group g
    local boolexpr iff
    //========
    if i>0 then
        set px = ox + 18.0*CosBJ(a)
        set py = oy + 18.0*SinBJ(a)
        call SetUnitX(u,px)
        call SetUnitY(u,py)
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call KillUnit(u)
        set px = ox + 18.0*CosBJ(a)
        set py = oy + 18.0*SinBJ(a)
        set u = CreateUnit(GetOwningPlayer(caster),'e00M',px,py,a)
        call SetUnitAbilityLevel(u,'A08G',level)
        call SetUnitAnimation(u,"birth")
        call UnitApplyTimedLife(u,'BTLF',level + 1.5)
        set g = CreateGroup()
        set iff = GetPlayerFilter(GetOwningPlayer(caster))
        call GroupEnumUnitsInRange(g,px,py,150.0+level*25.0,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if GetUnitCurrentOrder(v)!=OrderId("metamorphosis") then
                call IssueTargetOrder(u,"entanglingroots",v)
            endif
        endloop
        call DestroyGroup(g)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set g = null
    set iff = null
endfunction

function Trig_Yamame01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local real d = SquareRoot(Pow(ty-oy,2)+Pow(tx-ox,2))
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local unit u
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 14
    local real abilitycooldownlv03 = 13
    local real abilitycooldownlv04 = 12
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set u = CreateUnit(GetOwningPlayer(caster),'e00L',ox,oy,a)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,R2I(d/18.0))
    call SaveReal(udg_ht,task,0,a)
    call TimerStart(t,0.02,true,function Trig_Yamame01_Main)
    //========
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Yamame01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Yamame02
//===========================================================================
function Trig_Yamame02_SpiderAB takes unit u, unit caster returns nothing
    local integer atk = R2I(GetHeroStr(caster,true)/4.5)
    local integer spe = R2I(GetHeroAgi(caster,true)/4.5)
    call SetUnitAbilityLevel(u,'A0RF',R2I(atk/10)+1)
    set atk = atk - R2I(atk/10)*10
    call SetUnitAbilityLevel(u,'A0RE',atk+1)
    call SetUnitAbilityLevel(u,'A0RH',R2I(spe/10)+1)
    set spe = spe - R2I(spe/10)*10
    call SetUnitAbilityLevel(u,'A0RG',spe+1)
endfunction

function Trig_Yamame02_Conditions takes nothing returns boolean
    if GetUnitTypeId(GetSummonedUnit()) == 'n01N' then
        call Trig_Yamame02_SpiderAB(GetSummonedUnit(),GetPlayerCharacter(GetOwningPlayer(GetSummoningUnit())))
        return false
    endif
    return GetUnitTypeId(GetSummonedUnit()) == 'e00N'
endfunction

function Trig_Yamame02_Actions takes nothing returns nothing
    local unit caster = GetSummoningUnit()
    local unit Web = GetSummonedUnit()
    local integer num = GetUnitAbilityLevel(caster,'A08I')*5 
    local integer i = 1
    local real x
    local real y
    //========
    local real abilitycooldownlv01 = 22
    local real abilitycooldownlv02 = 22
    local real abilitycooldownlv03 = 22
    local real abilitycooldownlv04 = 22
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,'A08I') == 1 then
            call Item_HeroAbilityCoolDownReset(caster,'A08I',abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,'A08I') == 2 then
            call Item_HeroAbilityCoolDownReset(caster,'A08I',abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,'A08I') == 3 then
            call Item_HeroAbilityCoolDownReset(caster,'A08I',abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,'A08I') == 4 then
            call Item_HeroAbilityCoolDownReset(caster,'A08I',abilitycooldownlv04)
        endif
    endif
    //========
    call SetUnitVertexColorBJ( Web, 100, 100, 100, 75.00 )
    loop
        exitwhen i > num
        call TriggerSleepAction(0.01 *(5-GetUnitAbilityLevel(caster,'A08I')))
        set x = GetUnitX(Web) + GetRandomReal(-355.00, 355.00)
        set y = GetUnitY(Web) + GetRandomReal(-355.00, 355.00)
        call IssuePointOrder( Web, "ward", x, y )
        set i = i + 1
    endloop    
    set caster = null
    set Web = null
endfunction

//===========================================================================
function InitTrig_Yamame02 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Yamame03
//===========================================================================
function Trig_Yamame03_Conditions takes nothing returns boolean
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if GetUnitAbilityLevel(GetAttacker(),'A08J') == 0 then
        return false
    endif
    if GetRandomInt(0,100) > 20 then
        return false
    endif
    return GetUnitTypeId(GetAttacker()) == 'O008'
endfunction

function Trig_Yamame03_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local unit u
    local integer level
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        set u = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        set trg = null
        set caster = null
        set target = null
        set u = null
        return
    endif
    set target = GetTriggerUnit()
    //========
    call DisableTrigger(trg)
    //========
    set level = GetUnitAbilityLevel(caster,'A08J')
    set u = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0)
    call UnitAddAbility(u,'A0RI')
    call SetUnitAbilityLevel(u,'A0RI',level)
    call IssueTargetOrder(u,"chainlightning",target)
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_Yamame03_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_Yamame03_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Yamame03 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Yamame04
//===========================================================================
function Trig_Yamame04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0RJ'
endfunction

function Trig_Yamame04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local lightning e1 = LoadLightningHandle(udg_ht,task,2)
    local lightning e2 = LoadLightningHandle(udg_ht,task,3)
    local lightning e3 = LoadLightningHandle(udg_ht,task,4)
    local integer i = LoadInteger(udg_ht,task,5)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real oz = GetPositionZ(ox,oy)
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local real tz = GetPositionZ(tx,ty)
    local real px
    local real py
    local real a = Atan2(ty-oy,tx-ox)
    if i > 0 and not IsUnitType(target,UNIT_TYPE_DEAD) and target != null then
        set i = i - 1
        set px = ox + 30.0*Cos(a)
        set py = oy + 30.0*Sin(a)
        call SetUnitXY(caster,px,py)
        call SetUnitFacing(caster,bj_RADTODEG*a)
        call MoveLightningEx(e1,false,ox,oy,oz+75.0,tx,ty,tz+75.0)
        call MoveLightningEx(e2,false,ox,oy,oz+55.0,tx,ty,tz+55.0)
        call MoveLightningEx(e3,false,ox,oy,oz+35.0,tx,ty,tz+35.0)
        if SquareRoot((ox-tx)*(ox-tx)+(oy-ty)*(oy-ty)) < 120.00 then
            set i = 0
        endif
        call SaveInteger(udg_ht,task,5,i)
    else
        call DestroyLightning(e1)
        call DestroyLightning(e2)
        call DestroyLightning(e3)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)   
    endif
    set t = null
    set caster = null
    set target = null
    set e1 = null
    set e2 = null
    set e3 = null
endfunction

function Trig_Yamame04_Actions takes nothing returns nothing
    local timer t
    local integer task
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local lightning e1
    local lightning e2
    local lightning e3
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real oz = GetPositionZ(ox,oy)
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local real tz = GetPositionZ(tx,ty)
    //========
    local real abilitycooldownlv01 = 0.5
    local real abilitycooldownlv02 = 0.5
    local real abilitycooldownlv03 = 0.5
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    set t = CreateTimer()
    set task = GetHandleId(t)
    set e1 = AddLightningEx("DSTR",false,ox,oy,oz+75.0,tx,ty,tz+75.0)
    set e2 = AddLightningEx("DSTR",false,ox,oy,oz+55.0,tx,ty,tz+55.0)
    set e3 = AddLightningEx("DSTR",false,ox,oy,oz+35.0,tx,ty,tz+35.0)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveLightningHandle(udg_ht,task,2,e1)
    call SaveLightningHandle(udg_ht,task,3,e2)
    call SaveLightningHandle(udg_ht,task,4,e3)
    call SaveInteger(udg_ht,task,5,90)
    call TimerStart(t,0.02,true,function Trig_Yamame04_Main)
    set t = null
    set caster = null
    set target = null
    set e1 = null
    set e2 = null
    set e3 = null
endfunction

//===========================================================================
function InitTrig_Yamame04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initial Spider
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Initial_Spider_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('O008')
    local integer i
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set gg_trg_YamameDS = CreateTrigger()
    call TriggerRegisterPlayerEvent( gg_trg_YamameDS, GetOwningPlayer(h), EVENT_PLAYER_END_CINEMATIC)
    call TriggerAddCondition( gg_trg_YamameDS, Condition( function Trig_YamameDS_Conditions ) )
    call TriggerAddAction( gg_trg_YamameDS, function Trig_YamameDS_Actions )

    set gg_trg_Yamame_Dis = CreateTrigger()
    call RegisterAnyUnitDamage(gg_trg_Yamame_Dis)
    call TriggerAddCondition( gg_trg_Yamame_Dis, Condition( function Trig_Yamame_Dis_Conditions ) )
    call TriggerAddAction( gg_trg_Yamame_Dis, function Trig_Yamame_Dis_Actions )

    set gg_trg_Yamame01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yamame01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yamame01, Condition( function Trig_Yamame01_Conditions ) )
    call TriggerAddAction( gg_trg_Yamame01, function Trig_Yamame01_Actions )

    set gg_trg_Yamame02 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Yamame02, EVENT_PLAYER_UNIT_SUMMON )
    call TriggerAddCondition( gg_trg_Yamame02, Condition( function Trig_Yamame02_Conditions ) )
    call TriggerAddAction( gg_trg_Yamame02, function Trig_Yamame02_Actions )

    set gg_trg_Yamame03 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Yamame03, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Yamame03, Condition( function Trig_Yamame03_Conditions ) )
    call TriggerAddAction( gg_trg_Yamame03, function Trig_Yamame03_Actions )

    set gg_trg_Yamame04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Yamame04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yamame04, Condition( function Trig_Yamame04_Conditions ) )
    call TriggerAddAction( gg_trg_Yamame04, function Trig_Yamame04_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Spider takes nothing returns nothing
    set gg_trg_Initial_Spider = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Spider, function Trig_Initial_Spider_Actions )
endfunction

//===========================================================================
// Trigger: Yuugi Roar
//===========================================================================
function Trig_Yuugi_Roar_Conditions takes nothing returns boolean
    if IsUnitType(udg_SK_Yuugi,UNIT_TYPE_DEAD) then
        return false
    endif
    if udg_SK_Yuugi_Roar_CD == true then
        return false
    endif
    return GetUnitState(udg_SK_Yuugi,UNIT_STATE_LIFE)/GetUnitState(udg_SK_Yuugi,UNIT_STATE_MAX_LIFE) <= 0.20
endfunction

function Trig_Yuugi_Roar_Target takes nothing returns boolean
    if GetFilterUnit() == udg_SK_Yuugi then
        return false
    endif
    return IsUnitAlly(GetFilterUnit(),GetOwningPlayer(udg_SK_Yuugi))
endfunction

function Trig_Yuugi_Roar_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    set udg_SK_Yuugi_Roar_CD = false
    call PauseTimer(t)
    call DestroyTimer(t)
    set t = null
endfunction

function Trig_Yuugi_Roar_Actions takes nothing returns nothing
    local unit caster = udg_SK_Yuugi
    local unit v
    local unit w
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local group g = CreateGroup()
    local boolexpr iff = Filter(function Trig_Yuugi_Roar_Target)
    local timer t = CreateTimer()
    set udg_SK_Yuugi_Roar_CD = true
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\NightElf\\BattleRoar\\RoarCaster.mdl",ox,oy))
    set w = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,0)
    call UnitAddAbility(w,'A0RM')
    call SetUnitAbilityLevel(w,'A0RM',1)
    call IssueTargetOrder(w,"innerfire",caster)
    call GroupEnumUnitsInRange(g,ox,oy,600.0,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitAliveBJ(v) and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
            set w = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,0)
            call UnitAddAbility(w,'A0RM')
            call SetUnitAbilityLevel(w,'A0RM',2)
            call IssueTargetOrder(w,"innerfire",v)
        endif
    endloop
    call DestroyGroup(g)
    call TimerStart(t,90.0,false,function Trig_Yuugi_Roar_Clear)
    set caster = null
    set v = null
    set w = null
    set g = null
    set iff = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Yuugi_Roar takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Yuugi01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Yuugi01_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A08A'
endfunction

function Trig_Yuugi01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    call SetUnitPosition( caster, GetUnitX(caster), GetUnitY(caster) )
    call SetUnitAnimation( caster, "spell" )
    set caster = null
endfunction

//===========================================================================
function InitTrig_Yuugi01 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Yuugi02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Yuugi02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A08B'
endfunction

function Trig_Yuugi02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local location loc1 = GetUnitLoc(caster)
    local integer level = GetUnitAbilityLevel(caster,'A08B')
    local location loc2
    local integer i
    local effect e
    //========
    local real abilitycooldownlv01 = 8
    local real abilitycooldownlv02 = 8
    local real abilitycooldownlv03 = 8
    local real abilitycooldownlv04 = 8
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set i = 1
    loop
        exitwhen i > 10
        set loc2 = PolarProjectionBJ(loc1, level * 50.00 + 150.00 , 60.00 * i )
        set e = AddSpecialEffectLoc( "Abilities\\Spells\\Human\\ThunderClap\\ThunderClapCaster.mdl" , loc2 )
        call DestroyEffect(e)
        call RemoveLocation( loc2 )
        set i = i + 1
    endloop
    call RemoveLocation( loc1 )
    set caster = null
    set loc1 = null
    set loc2 = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Yuugi02 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Yuugi03
//
// udg_SK_Yuugi02I
// 全局循环变量 求改为本地
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function AngleBetween takes unit u1, unit u2 returns real//角度
    return bj_RADTODEG * Atan2(GetUnitY(u2) - GetUnitY(u1), GetUnitX(u2) - GetUnitX(u1))
endfunction

function DistanceBetween2 takes unit u,real x,real y returns real//距离
    local real dx = GetUnitX(u) - x
    local real dy = GetUnitY(u) - y
    return SquareRoot(dx * dx + dy * dy)
endfunction

function PolarProjection takes unit u, real dist, real angle,boolean f returns real//位移
    local real x = GetUnitX(u) + dist * Cos(angle * bj_DEGTORAD)
    if f then
       return x
    endif
    set x = GetUnitY(u) + dist * Sin(angle * bj_DEGTORAD)
    return x
endfunction

function XXYY3X takes nothing returns nothing
    set udg_SK_Yuugi02I = udg_SK_Yuugi02I + 1
endfunction

function XXYY3S takes nothing returns nothing
    if GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE) > 0 then
        if GetFilterUnit() != udg_SK_Yuugi02U1 and GetFilterUnit() != udg_SK_Yuugi02U2 then
            set udg_SK_Yuugi02I = udg_SK_Yuugi02I + 1
        endif
    endif
endfunction

function XXYY3M takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local unit u = LoadUnitHandle(udg_Hashtable,GetHandleId(t),StringHash("u"))
    local unit ud = LoadUnitHandle(udg_Hashtable,GetHandleId(t),StringHash("ud"))
    local group g = CreateGroup()
    local real f = LoadReal(udg_Hashtable,GetHandleId(t),StringHash("f"))
    local real d = LoadReal(udg_Hashtable,GetHandleId(t),StringHash("d"))
    local real x = LoadReal(udg_Hashtable,GetHandleId(t),StringHash("x"))
    local real y = LoadReal(udg_Hashtable,GetHandleId(t),StringHash("y"))
    local real xt = PolarProjection(u,9,f,true)
    local real yt = PolarProjection(u,9,f,false)
    local location p
    set udg_SK_Yuugi02I = 0
    set udg_SK_Yuugi02U1 = u
    set udg_SK_Yuugi02U2 = ud
    if DistanceBetween2(u,x,y) < 700 then
        call GroupEnumUnitsInRange(g,xt,yt,75,Condition(function XXYY3S))
        call DestroyGroup(g)
        set p  = Location(xt,yt)
        call EnumDestructablesInCircleBJ(100,p,function XXYY3X)
        call RemoveLocation(p)
        set p = null
        if udg_SK_Yuugi02I <= 0 and IsTerrainPathable(xt,yt,PATHING_TYPE_WALKABILITY) == false then          
            call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GetUnitX(u),GetUnitY(u)))
            call SetUnitX(u,xt)
            call SetUnitY(u,yt)
        else
            call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",GetUnitX(u),GetUnitY(u)))
            call PauseUnit(u,false)
            call SetUnitPathing(u,true)
            call SetUnitFlag(u,CS_REPEL(),false)
            call UnitDamageTarget(ud,u,d,false,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
            call PauseTimer(t)
            call FlushChildHashtable(udg_Hashtable,GetHandleId(t))
            call DestroyTimer(t)
        endif
    else
        call PauseUnit(u,false)
        call SetUnitPathing(u,true)
        call SetUnitFlag(u,CS_REPEL(),false)
        call UnitDamageTarget(ud,u,d,false,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
        call PauseTimer(t)
        call FlushChildHashtable(udg_Hashtable,GetHandleId(t))
        call DestroyTimer(t)
    endif
    set udg_SK_Yuugi02U1 = null
    set udg_SK_Yuugi02U2 = null
    set t = null
    set ud = null
    set u = null
    set g = null
endfunction

function XXYY3J takes nothing returns nothing
    local unit caster 
    local unit target
    local integer level
    local integer task
    local timer t
    local real f
    local real d
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) then
        return
    endif
    if GetUnitAbilityLevel(GetTriggerUnit(),'B01Q')==0 then
        return
    endif
    call UnitRemoveAbility(GetTriggerUnit(),'B01Q')
    if not IsMobileUnit(GetTriggerUnit()) then
        return
    endif
    set caster = GetEventDamageSource()
    set target = GetTriggerUnit()
    set level = GetUnitAbilityLevel(caster,'A08C')
    if level>=1 then
        call SetUnitAnimation(caster, "Attack Slam" )
        set t = CreateTimer()
        set task = GetHandleId(t)
        set d = 250+GetUnitAbilityLevel(caster,'A08C')*50
        set f = AngleBetween(caster,target)
        call SaveUnitHandle(udg_Hashtable,task,StringHash("u"),target)
        call SaveUnitHandle(udg_Hashtable,task,StringHash("ud"),caster)
        call SaveReal(udg_Hashtable,task,StringHash("d"),d)
        call SaveReal(udg_Hashtable,task,StringHash("f"),f)
        call SaveReal(udg_Hashtable,task,StringHash("x"),GetUnitX(caster))
        call SaveReal(udg_Hashtable,task,StringHash("y"),GetUnitY(caster))
        call PauseUnit(target,false)
        call SetUnitPathing(target,true)
        call SetUnitFlag(target,CS_REPEL(),true)
        call TimerStart(t,0.01,true,function XXYY3M)
    endif
    set t = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Yuugi03 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Yuugi04
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 重写过了
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Yuugi04_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A08D'
endfunction

function Yuugi04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,1)
    local unit target = LoadUnitHandle(udg_Hashtable,task,2)
    local integer i = LoadInteger(udg_Hashtable,task,3)
    local location loc1 = LoadLocationHandle(udg_Hashtable,task,4)
    local real distance = LoadReal(udg_Hashtable,task,5)
    local location loc2 = GetUnitLoc(target)
    local real inc = DistanceBetweenPoints(loc1,loc2)
    local effect e
    local terraindeformation terrain
    
    set i = i - 1
    call SaveInteger(udg_Hashtable,task,3,i)
    call RemoveLocation(loc1)
    call SaveLocationHandle(udg_Hashtable,task,4,loc2)
    if GetUnitFlag(target,CS_DRAG())==false and GetUnitAbilityLevel(target,'B05F') == 0 then
        set distance = distance + inc
        call SaveReal(udg_Hashtable,task,5,distance)
    endif
    
    if distance>300.0 and IsUnitAlive(target) then
        call SetUnitFlag(target,CS_YUUGI(),false)
        call SetUnitInvulnerable(target,false)
        call UnitRemoveBuffs(target, true, true)
        call InstantKill(caster,target)
        //if IsUnitType(target,UNIT_TYPE_DEAD)==true then
        //    call SetUnitState(target, UNIT_STATE_LIFE, 0.00 )
        //endif
        
        set terrain = TerrainDeformationRippleBJ(1.00,true,loc2,400.00,400.00,90.00,0.10,100.00)        
        set e = AddSpecialEffectLoc("Abilities\\Spells\\Human\\ThunderClap\\ThunderClapCaster.mdl",loc2)
        call DestroyEffect(e)
        set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",loc2)
        call DestroyEffect(e)
        set e = AddSpecialEffectLoc("Objects\\Spawnmodels\\Orc\\OrcLargeDeathExplode\\OrcLargeDeathExplode.mdl",loc2)
        call DestroyEffect(e)
        
        call RemoveLocation(loc2)
        call PauseTimer(t)
        call DestroyTimer(t)
        set t = null
        set caster = null
        set target = null
        set loc1 = null
        set loc2 = null
        set e = null
        set terrain = null
        return
    endif
    
    if i<0 or IsUnitDead(target) then
        if IsUnitAlive(caster) and i<0 then
            call UnitDamageTargetHJ(caster,target,0.25*GetUnitState(target,UNIT_STATE_MAX_LIFE),4)
            set terrain = TerrainDeformationRippleBJ(1.00,true,loc2,400.00,400.00,90.00,0.10,100.00)        
            set e = AddSpecialEffectLoc("Abilities\\Spells\\Human\\ThunderClap\\ThunderClapCaster.mdl",loc2)
            call DestroyEffect(e)
            set e = AddSpecialEffectLoc("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",loc2)
            call DestroyEffect(e)
            set e = AddSpecialEffectLoc("Objects\\Spawnmodels\\Orc\\OrcLargeDeathExplode\\OrcLargeDeathExplode.mdl",loc2)
            call DestroyEffect(e)
        endif
        call SetUnitFlag(target,CS_YUUGI(),false)
        call RemoveLocation(loc2)
        call PauseTimer(t)
        call DestroyTimer(t)
        set t = null
        set caster = null
        set target = null
        set loc1 = null
        set loc2 = null
        set e = null
        set terrain = null
        return
    endif
    
    set t = null
    set caster = null
    set target = null
    set loc1 = null
    set loc2 = null
    set e = null
    set terrain = null
endfunction

function Trig_Yuugi04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local location loc = GetUnitLoc(target)
    local real r = 0.00
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local player PLY = GetOwningPlayer(caster)
    local unit u
    local integer i = 20+(10*GetUnitAbilityLevel(caster,'A08D'))//持续时间 
    //========
    local real abilitycooldownlv01 = 115
    local real abilitycooldownlv02 = 100
    local real abilitycooldownlv03 = 85
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========

    set u = CreateUnitAtLoc(PLY,'n02A',loc,0)
    call SetUnitPathing(u,false)

    call SetUnitFlag(target,CS_YUUGI(),true)

    call SetUnitX(u,GetLocationX(loc))
    call SetUnitY(u,GetLocationY(loc))
    
    call AttachSoundToUnit(gg_snd_Yuugi,target)
    call SetSoundVolume(gg_snd_Yuugi,PercentToInt(100,127))
    call StartSound(gg_snd_Yuugi)
    call TerrainDeformationRippleBJ(1.00,true,loc,400.00,400.00,64.00,0.10,100.00)
    
    call SaveTimerHandle(udg_Hashtable,task,0,t)
    call SaveUnitHandle(udg_Hashtable,task,1,caster) 
    call SaveUnitHandle(udg_Hashtable,task,2,target)
    call SaveInteger(udg_Hashtable,task,3,i)
    call SaveLocationHandle(udg_Hashtable,task,4,loc)
    call SaveReal(udg_Hashtable,task,5,0)
    
    call TimerStart(t,0.1,true,function Yuugi04_Main)
    
    call CastSpell(caster,"四天王奥义--「三步必杀」!!!")
    
    set t = null
    set caster = null
    set target = null
    set loc = null
    set PLY = null
    set u = null
endfunction

function InitTrig_Yuugi04 takes nothing returns nothing    
endfunction//===========================================================================
// Trigger: Initial Yuugi
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Initial_Yuugi_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H00K')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set udg_SK_Yuugi = h

    set gg_trg_Yuugi_Roar = CreateTrigger()
    call TriggerRegisterTimerEventPeriodic(gg_trg_Yuugi_Roar,0.50)
    call TriggerAddCondition( gg_trg_Yuugi_Roar, Condition( function Trig_Yuugi_Roar_Conditions ) )
    call TriggerAddAction(gg_trg_Yuugi_Roar, function Trig_Yuugi_Roar_Actions)

    set gg_trg_Yuugi01 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Yuugi01, EVENT_PLAYER_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Yuugi01, Condition( function Trig_Yuugi01_Conditions ) )
    call TriggerAddAction( gg_trg_Yuugi01, function Trig_Yuugi01_Actions )

    set gg_trg_Yuugi02 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Yuugi02, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yuugi02, Condition( function Trig_Yuugi02_Conditions ) )
    call TriggerAddAction( gg_trg_Yuugi02, function Trig_Yuugi02_Actions )
    
    set gg_trg_Yuugi03 = CreateTrigger()
    call RegisterAnyUnitDamage( gg_trg_Yuugi03 )
    call TriggerAddCondition(gg_trg_Yuugi03,Condition(function XXYY3J))

    set gg_trg_Yuugi04 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Yuugi04, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yuugi04, Condition( function Trig_Yuugi04_Conditions ) )
    call TriggerAddAction( gg_trg_Yuugi04, function Trig_Yuugi04_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Yuugi takes nothing returns nothing
    set gg_trg_Initial_Yuugi = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Yuugi, function Trig_Initial_Yuugi_Actions )
endfunction

//===========================================================================
// Trigger: Wriggle01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Wriggle01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A09N' and GetUnitAbilityLevel(GetTriggerUnit(),'A09O')==0
endfunction

function Trig_Wriggle01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local fogmodifier v = LoadFogModifierHandle(udg_ht,task,1)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local real r = LoadReal(udg_ht,task,0)
    //========
    if IsUnitAliveBJ(caster) and i>0 then
        call DestroyFogModifier(v)
        set v = CreateFogModifierRadius(GetOwningPlayer(caster),FOG_OF_WAR_VISIBLE,GetUnitX(caster),GetUnitY(caster),r,true,false)
        call FogModifierStart(v)
        call SaveFogModifierHandle(udg_ht,task,1,v)
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call UnitRemoveAbility(caster,'A09O')
        call DestroyFogModifier(v)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set v = null
endfunction

function Trig_Wriggle01_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local fogmodifier v
    local integer level = GetUnitAbilityLevel(caster,'A09N')
    local real r
    //========
    local real abilitycooldownlv01 = 30
    local real abilitycooldownlv02 = 30
    local real abilitycooldownlv03 = 30
    local real abilitycooldownlv04 = 30
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set r = 1000.0 + level*200.0
    call UnitAddAbility(caster,'A09O') 
    call SetUnitAbilityLevel(caster,'A09O',level)
    set v = CreateFogModifierRadius(GetOwningPlayer(caster),FOG_OF_WAR_VISIBLE,GetUnitX(caster),GetUnitY(caster),r,true,false)
    call FogModifierStart(v)
    //--------
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveFogModifierHandle(udg_ht,task,1,v)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,200)
    call SaveReal(udg_ht,task,0,r)
    call TimerStart(t,0.1,true,function Trig_Wriggle01_Main)
    //========
    set t = null
    set caster = null
    set v = null
endfunction

//===========================================================================
function InitTrig_Wriggle01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Wriggle02
//===========================================================================
function Trig_Wriggle02_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A09R'
endfunction

function Trig_Wriggle02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    //========
    local real abilitycooldownlv01 = 23
    local real abilitycooldownlv02 = 23
    local real abilitycooldownlv03 = 23
    local real abilitycooldownlv04 = 23
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set caster = null
endfunction

//===========================================================================
function InitTrig_Wriggle02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Wriggle03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Wriggle03_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A09M'
endfunction

function Trig_Wriggle03_Filter takes nothing returns boolean
    local integer d = GetUnitTypeId(GetFilterUnit())
    return d=='u004' or d=='u00S'
endfunction

function Trig_Wriggle03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit v
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real a = GetUnitFacing(caster)
    local integer task = GetHandleId(caster)
    local timer t
    local group g
    local boolexpr f
    local integer i
    local integer max
    local integer age = LoadInteger(udg_sht,task,0) + 1
    //========
    set v = CreateUnit(GetOwningPlayer(caster),'u004',ox + 100.0*CosBJ(a),oy + 100.0*SinBJ(a),a)
    call SetUnitUserData(v,age)
    call SaveInteger(udg_sht,task,0,age)
    //========
    set g = CreateGroup()
    set f = Filter(function Trig_Wriggle03_Filter)
    call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(caster),f)
    set max = 2*GetUnitAbilityLevel(caster,'A09M')
    set v = FirstOfGroup(g)
    set age = 99999
    set i = 0
    loop
        set u = FirstOfGroup(g)
        exitwhen u == null
        call GroupRemoveUnit(g,u)
        set i = i + 1
        if GetUnitUserData(u)<age then
            set age = GetUnitUserData(u)
            set v = u
        endif
    endloop
    call DebugMsg(I2S(i) + "/" + I2S(max))
    if i>max then
        call KillUnit(v)
        call RemoveUnit(v)
    endif
    //========
    call DestroyBoolExpr(f)
    set caster = null
    set t = null
    set u = null
    set v = null
    set g = null
    set f = null
endfunction

//===========================================================================
function InitTrig_Wriggle03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Wriggle04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Wriggle04_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A09K'
endfunction

function Trig_Wriggle04_Actions takes nothing returns nothing
    if GetUnitAbilityLevel(GetTriggerUnit(),'A09L')==0 then
        call UnitAddAbility(GetTriggerUnit(),'A09L')
    endif
    call SetUnitAbilityLevel(GetTriggerUnit(),'A09L',GetUnitAbilityLevel(GetTriggerUnit(),'A09K'))
endfunction

//===========================================================================
function InitTrig_Wriggle04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initial Wriggle
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Wriggle_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E00A')
    local integer i
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_Wriggle01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Wriggle01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Wriggle01, Condition( function Trig_Wriggle01_Conditions ) )
    call TriggerAddAction( gg_trg_Wriggle01, function Trig_Wriggle01_Actions )

    set gg_trg_Wriggle02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Wriggle02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Wriggle02, Condition( function Trig_Wriggle02_Conditions ) )
    call TriggerAddAction( gg_trg_Wriggle02, function Trig_Wriggle02_Actions )
    
    set gg_trg_Wriggle03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Wriggle03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Wriggle03, Condition( function Trig_Wriggle03_Conditions ) )
    call TriggerAddAction( gg_trg_Wriggle03, function Trig_Wriggle03_Actions )
    
    set gg_trg_Wriggle04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Wriggle04, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Wriggle04, Condition( function Trig_Wriggle04_Conditions ) )
    call TriggerAddAction( gg_trg_Wriggle04, function Trig_Wriggle04_Actions )
    
    set h = null
endfunction

function InitTrig_Initial_Wriggle takes nothing returns nothing
    set gg_trg_Initial_Wriggle = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Wriggle, function Trig_Initial_Wriggle_Actions )
endfunction

//===========================================================================
// Trigger: CaptainEyebug01
//===========================================================================
function Trig_CaptainEyebug01_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit()) == 'E00Q'
endfunction

function Trig_CaptainEyebug01_Actions takes nothing returns nothing
    call SetUnitX( GetTriggerUnit(), GetRectCenterX(gg_rct_EyePoint01resort) )
    call SetUnitY( GetTriggerUnit(), GetRectCenterY(gg_rct_EyePoint01resort) )
endfunction

//===========================================================================
function InitTrig_CaptainEyebug01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: CaptainEyebug02
//===========================================================================
function Trig_CaptainEyebug02_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit()) == 'E00Q'
endfunction

function Trig_CaptainEyebug02_Actions takes nothing returns nothing
    call SetUnitX( GetTriggerUnit(), GetRectCenterX(gg_rct_EyePoint02resort) )
    call SetUnitY( GetTriggerUnit(), GetRectCenterY(gg_rct_EyePoint02resort) )
endfunction

//===========================================================================
function InitTrig_CaptainEyebug02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: CaptainEyebug03
//===========================================================================
function Trig_CaptainEyebug03_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit()) == 'E00Q'
endfunction

function Trig_CaptainEyebug03_Actions takes nothing returns nothing
    call SetUnitX( GetTriggerUnit(), GetRectCenterX(gg_rct_EyePoint03resort) )
    call SetUnitY( GetTriggerUnit(), GetRectCenterY(gg_rct_EyePoint03resort) )
endfunction

//===========================================================================
function InitTrig_CaptainEyebug03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: CaptainEyebug04
//===========================================================================
function Trig_CaptainEyebug04_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit()) == 'E00Q'
endfunction

function Trig_CaptainEyebug04_Actions takes nothing returns nothing
    call SetUnitX( GetTriggerUnit(), GetRectCenterX(gg_rct_EyePoint04resort) )
    call SetUnitY( GetTriggerUnit(), GetRectCenterY(gg_rct_EyePoint04resort) )
endfunction

//===========================================================================
function InitTrig_CaptainEyebug04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: CaptainEyebug05
//===========================================================================
function Trig_CaptainEyebug05_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit()) == 'E00Q'
endfunction

function Trig_CaptainEyebug05_Actions takes nothing returns nothing
    call SetUnitX( GetTriggerUnit(), GetRectCenterX(gg_rct_EyePoint05resort) )
    call SetUnitY( GetTriggerUnit(), GetRectCenterY(gg_rct_EyePoint05resort) )
endfunction

//===========================================================================
function InitTrig_CaptainEyebug05 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: CaptainEyebug06
//===========================================================================
function Trig_CaptainEyebug06_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit()) == 'E00Q'
endfunction

function Trig_CaptainEyebug06_Actions takes nothing returns nothing
    call SetUnitX( GetTriggerUnit(), GetRectCenterX(gg_rct_EyePoint06resort) )
    call SetUnitY( GetTriggerUnit(), GetRectCenterY(gg_rct_EyePoint06resort) )
endfunction

//===========================================================================
function InitTrig_CaptainEyebug06 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: CaptainEyebug07
//===========================================================================
function Trig_CaptainEyebug07_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit()) == 'E00Q'
endfunction

function Trig_CaptainEyebug07_Actions takes nothing returns nothing
    call SetUnitX( GetTriggerUnit(), GetRectCenterX(gg_rct_EyePoint07resort) )
    call SetUnitY( GetTriggerUnit(), GetRectCenterY(gg_rct_EyePoint07resort) )
endfunction

//===========================================================================
function InitTrig_CaptainEyebug07 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: CaptainEyebug08
//===========================================================================
function Trig_CaptainEyebug08_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit()) == 'E00Q'
endfunction

function Trig_CaptainEyebug08_Actions takes nothing returns nothing
    call SetUnitX( GetTriggerUnit(), GetRectCenterX(gg_rct_EyePoint08resort) )
    call SetUnitY( GetTriggerUnit(), GetRectCenterY(gg_rct_EyePoint08resort) )
endfunction

//===========================================================================
function InitTrig_CaptainEyebug08 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: CaptainEyebug09
//===========================================================================
function Trig_CaptainEyebug09_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit()) == 'E00Q'
endfunction

function Trig_CaptainEyebug09_Actions takes nothing returns nothing
    call SetUnitX( GetTriggerUnit(), GetRectCenterX(gg_rct_EyePoint09resort) )
    call SetUnitY( GetTriggerUnit(), GetRectCenterY(gg_rct_EyePoint09resort) )
endfunction

//===========================================================================
function InitTrig_CaptainEyebug09 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: CaptainEyebug10
//===========================================================================
function Trig_CaptainEyebug10_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit()) == 'E00Q'
endfunction

function Trig_CaptainEyebug10_Actions takes nothing returns nothing
    call SetUnitX( GetTriggerUnit(), GetRectCenterX(gg_rct_EyePoint10resort) )
    call SetUnitY( GetTriggerUnit(), GetRectCenterY(gg_rct_EyePoint10resort) )
endfunction

//===========================================================================
function InitTrig_CaptainEyebug10 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: CaptainEyebug11
//===========================================================================
function Trig_CaptainEyebug11_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit()) == 'E00Q'
endfunction

function Trig_CaptainEyebug11_Actions takes nothing returns nothing
    call SetUnitX( GetTriggerUnit(), GetRectCenterX(gg_rct_EyePoint11resort) )
    call SetUnitY( GetTriggerUnit(), GetRectCenterY(gg_rct_EyePoint11resort) )
endfunction

//===========================================================================
function InitTrig_CaptainEyebug11 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: CaptainEyebug12
//===========================================================================
function Trig_CaptainEyebug12_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit()) == 'E00Q'
endfunction

function Trig_CaptainEyebug12_Actions takes nothing returns nothing
    call SetUnitX( GetTriggerUnit(), GetRectCenterX(gg_rct_EyePoint12resort) )
    call SetUnitY( GetTriggerUnit(), GetRectCenterY(gg_rct_EyePoint12resort) )
endfunction

//===========================================================================
function InitTrig_CaptainEyebug12 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Captain01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Captain01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0AB'
endfunction

function Trig_Captain01_Target takes nothing returns boolean
    local unit caster = LoadUnitHandle(udg_ht,GetHandleId(GetExpiredTimer()),0)
    if caster==GetFilterUnit() then
        set caster= null
        return false
    endif
    set caster = null
    if not IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) then
        return false
    endif
    if GetUnitFlag(GetFilterUnit(),CS_DASHING()) then
        return false
    endif
    if GetUnitFlag(GetFilterUnit(),CS_LOST()) then
        return false
    endif
    if IsUnitAntiDebuff(GetFilterUnit()) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'B04B') >= 1 then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'BOvc') >= 1 then
        return false
    endif
    return IsMobileUnit(GetFilterUnit())
endfunction

function Trig_Captain01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,2)
    local unit u
    local unit v = LoadUnitHandle(udg_ht,task,1)
    local group g = CreateGroup()
    local real damage = LoadReal(udg_ht,task,0)
    local real a = LoadReal(udg_ht,task,1)
    local real ox = LoadReal(udg_ht,task,2)
    local real oy = LoadReal(udg_ht,task,3)
    local real px
    local real py
    local boolexpr f = Filter(function Trig_Captain01_Target)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer z = LoadInteger(udg_ht,task,2)
    local boolean k = LoadBoolean(udg_ht,task,3)
    //========
    if i<z and z!=0 then
    //--------
        set px = ox + 20*i*CosBJ(a)
        set py = oy + 20*i*SinBJ(a)
        set u = CreateUnit(GetOwningPlayer(caster),'e00U',px,py,a)
        call SaveUnitHandle(udg_ht,task,3+i,u)
        if v!=null then
            call SetUnitXY(v,px+50*CosBJ(a),py+50*SinBJ(a))
        else
            set v = CreateUnit(GetOwningPlayer(caster),'e00T',px+60*CosBJ(a),py+60*SinBJ(a),a)
            call SaveUnitHandle(udg_ht,task,1,v)
        endif
        if i>3 and k==false then
            call GroupEnumUnitsInRange(g,px,py,100,f)
            if FirstOfGroup(g)!=null then
                set target = FirstOfGroup(g)
                call SetUnitFlag(target,CS_DRAG(),true)
                if IsUnitEnemy(target,GetOwningPlayer(caster)) then
                    call UnitDamageTarget(caster,target,damage,true,true,ATTACK_TYPE_HERO, DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
                endif
                call SaveUnitHandle(udg_ht,task,2,target)
                call SaveBoolean(udg_ht,task,3,true)
                call SaveInteger(udg_ht,task,2,0)
            endif
        endif
        set i = i + 1
        if i==z or GetUnitCurrentOrder(caster)!=OrderId("thunderbolt") then
            set z = 0
            call SaveInteger(udg_ht,task,2,z)
        endif 
        call SaveInteger(udg_ht,task,1,i)
    elseif i!=-1 and z==0 then
        set px = ox + 20*i*CosBJ(a)
        set py = oy + 20*i*SinBJ(a)
        set v = LoadUnitHandle(udg_ht,task,1)
        call SetUnitXY(v,px+50*CosBJ(a),py+50*SinBJ(a))
        if k==true then
            call SetUnitXY(target,px,py)
            call IssueImmediateOrder(target,"stop")
        else
            call GroupEnumUnitsInRange(g,px,py,100,f)
            if FirstOfGroup(g)!=null then
                set target = FirstOfGroup(g)
                if IsUnitEnemy(target,GetOwningPlayer(caster)) then
                    call UnitDamageTarget(caster,target,damage,true,true,ATTACK_TYPE_HERO, DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
                endif
                call SaveUnitHandle(udg_ht,task,2,target)
                call SaveBoolean(udg_ht,task,3,true)
                call SetUnitFlag(target,CS_DRAG(),true)
            endif
        endif
        set u = LoadUnitHandle(udg_ht,task,3+i)
        call RemoveUnit(u)
        set i = i - 1
        call SaveInteger(udg_ht,task,1,i)
    elseif i==-1 and z==0 then
        if k then
            call SetUnitFlag(target,CS_DRAG(),false)
        endif
        call PauseTimer(t)
        call DestroyTimer(t)
        call IssueImmediateOrder(caster,"stop")
        set v = LoadUnitHandle(udg_ht,task,1)
        call SetUnitScale(v,0.01,0.01,0.01)
        call KillUnit(v)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    call DestroyBoolExpr(f)
    call DestroyGroup(g)
    set t = null
    set caster = null
    set target = null
    set u = null
    set v = null
    set g = null
    set f = null
endfunction

function Trig_Captain01_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local location o = GetUnitLoc(caster)
    local location p = GetSpellTargetLoc()
    local real a = AngleBetweenPoints(o,p)
    local real d
    local integer level = GetUnitAbilityLevel(caster,'A0AB')
    //========
    local real abilitycooldownlv01 = 14
    local real abilitycooldownlv02 = 14
    local real abilitycooldownlv03 = 14
    local real abilitycooldownlv04 = 14
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========

    if level == 1 then
        set d = 550
    elseif level == 2 then
        set d = 700
    elseif level == 3 then
        set d = 850
    elseif level == 4 then
        set d = 1000
    endif
    call SaveReal(udg_ht,task,0,60.0 + 30.0*level)//damage
    //--------
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,1,0)
    call SaveInteger(udg_ht,task,2,R2I(d/20))
    call SaveBoolean(udg_ht,task,3,false)
    call SaveReal(udg_ht,task,1,a)
    call SaveReal(udg_ht,task,2,GetUnitX(caster)+80*CosBJ(a))
    call SaveReal(udg_ht,task,3,GetUnitY(caster)+80*SinBJ(a))
    call TimerStart(t,0.01,true,function Trig_Captain01_Main)
    //========
    call RemoveLocation(o)
    call RemoveLocation(p)
    set o = null
    set p = null
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Captain01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Captain02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Captain02_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0AA'
endfunction

function Trig_Captain02_Target takes nothing returns boolean
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if GetUnitFlag(GetFilterUnit(),CS_DASHING()) then
        return false
    endif
    if GetUnitFlag(GetFilterUnit(),CS_LOST()) then
        return false
    endif
    if IsUnitAntiDebuff(GetFilterUnit()) then
        return false
    endif
    if IsUnitGiant(GetFilterUnit()) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'B04B') >= 1 then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'BOvc') >= 1 then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'B052') >= 1 then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Avul') >= 1 then
        return false
    endif
    return IsMobileUnit(GetFilterUnit())
endfunction

function Trig_Captain02_Damage takes nothing returns nothing
    local integer task = GetHandleId(GetExpiredTimer())
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = LoadInteger(udg_ht,task,0)
    call UnitDamageTarget(caster,GetEnumUnit(),20.0+level*10.0,false,false,ATTACK_TYPE_NORMAL, DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    set caster = null
endfunction

function Trig_Captain02_Release takes nothing returns nothing
    local unit u = GetEnumUnit()
    call PauseUnit(u,false)
    call SetUnitPathing(u,true)
    call SetUnitFlag(u,CS_DRAW(),false)
    set u = null
endfunction

function Trig_Captain02_Rise takes nothing returns nothing
    local integer task = GetHandleId(GetExpiredTimer())
    local real tx = LoadReal(udg_ht,task,0)
    local real ty = LoadReal(udg_ht,task,1)
    local unit u = GetEnumUnit()
    call SetUnitXY(u,tx,ty)
    call ShowUnit(u,true)
    call PauseUnit(u,false)
    call SetUnitFlag(u,CS_DRAW(),false)
    call SetUnitFlag(u,CS_LOST(),false)
    call EnableHeight(u)
    call SetUnitFlyHeight(u,400.00,500.00)
    set u = null
endfunction

function Trig_Captain02_Fall takes nothing returns nothing
    local unit u = GetEnumUnit()
    call SetUnitFlyHeight(u,0.00,600.00)
    call SetUnitPathing(u,true)
    set u = null
endfunction

function Trig_Captain02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local real ox
    local real oy
    local real tx = LoadReal(udg_ht,task,0)
    local real ty = LoadReal(udg_ht,task,1)
    local real r
    local real a
    local real d
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local boolexpr f = Filter(function Trig_Captain02_Target)
    local group w = LoadGroupHandle(udg_ht,task,2)//正在卷的单位的单位组
    local group m = LoadGroupHandle(udg_ht,task,3)//已经被卷入的单位的单位组
    local group g
    //========
    if i<=100 then
        call SaveInteger(udg_ht,task,1,i + 1)
        set r = 100.0 + 60.0*level
        loop
            set v = FirstOfGroup(w)
            exitwhen v == null
            call GroupRemoveUnit(w,v)
            if DistanceBetweenUnits(v,u)>r then
                call PauseUnit(v,false)
                call SetUnitPathing(v,true)
                call SetUnitFlag(v,CS_DRAW(),false)
            endif
        endloop
        //========
        set d = 3.0 + 2.0*level
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,tx,ty,r,f)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitAlly(v,GetOwningPlayer(caster))==false then
                call PauseUnit(v,true)
                call SetUnitPathing(v,false)
                call SetUnitFlag(v,CS_DRAW(),true)
                set ox = GetUnitX(v)
                set oy = GetUnitY(v)
                set a = Atan2(ty-oy,tx-ox) - bj_DEGTORAD*60.0
                call SetUnitXY(v,ox + d*Cos(a),oy + d*Sin(a))
                if IsUnitInRange(v,u,30.00) then
                    call ShowUnit(v,false)
                    call SetUnitFlag(v,CS_LOST(),true)
                    call GroupAddUnit(m,v)
                else
                    call GroupAddUnit(w,v)
                endif
            endif
        endloop
        call DestroyBoolExpr(f)
        call DestroyGroup(g)
        //伤害
        if i/25*25==i then
            call ForGroup(m,function Trig_Captain02_Damage)
        endif
        //泡泡特效
        if i/6*6==i then
            set u = CreateUnit(GetOwningPlayer(caster),'e00S',ox,oy,0)
            call UnitApplyTimedLife(u,'BTLF',1.00)
        endif
    elseif i==101 then
        call SaveInteger(udg_ht,task,1,i + 1)
        call RemoveUnit(u)
        call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",tx,ty))
        call ForGroup(w,function Trig_Captain02_Release)
        call ForGroup(m,function Trig_Captain02_Rise)
        call TimerStart(t,1.0,false,function Trig_Captain02_Main)
    elseif i==102 then
        call ForGroup(m,function Trig_Captain02_Fall)
        call DestroyGroup(w)
        call DestroyGroup(m)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set w = null
    set m = null
    set g = null
    set f = null
endfunction

function Trig_Captain02_Frame takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u
    local real tx = LoadReal(udg_ht,task,0)
    local real ty = LoadReal(udg_ht,task,1)
    local real s
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    set s = 2.0 + level
    set u = CreateUnit(GetOwningPlayer(caster),'e00R',tx,ty,270.0)
    call SetUnitScale(u,s,s,s)
    call PlaySoundOnUnitBJ(gg_snd_BattleShipDeath1,100,u)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveGroupHandle(udg_ht,task,2,CreateGroup())
    call SaveGroupHandle(udg_ht,task,3,CreateGroup())
    call SaveInteger(udg_ht,task,1,i + 1)
    call TimerStart(t,0.04,true,function Trig_Captain02_Main)
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Captain02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local real d = SquareRoot(Pow(ty-oy,2)+Pow(tx-ox,2))
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 45
    local real abilitycooldownlv02 = 45
    local real abilitycooldownlv03 = 45
    local real abilitycooldownlv04 = 45
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,0)
    call SaveReal(udg_ht,task,0,tx)
    call SaveReal(udg_ht,task,1,ty)
    call TimerStart(t,1.5,false,function Trig_Captain02_Frame)
    //========
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Captain02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Captain03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_bocai_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0A6'
endfunction

function bocai_stop takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,0)
    if not UnitHasBuffBJ(caster,'B01Z') then
        if IsUnitAlive(caster) then
           call UnitRemoveAbility(caster,'A0A7')
           call PauseTimer(t)
           call DestroyTimer(t)
           call FlushChildHashtable(udg_Hashtable,task)
        endif
    endif
    set t = null
    set caster = null
endfunction

function Trig_bocai_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0A6')
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 15
    local real abilitycooldownlv03 = 15
    local real abilitycooldownlv04 = 15
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call UnitAddAbility(caster,'A0A7')
    call SetUnitAbilityLevel(caster,'A0A8', level )
    call SetUnitAbilityLevel(caster,'A0A9', level )
    call SaveUnitHandle(udg_Hashtable,task,0,caster)    
    call TimerStart(t,0.5,true,function bocai_stop)
    call TriggerSleepAction(0.6)
    call PlaySoundOnUnitBJ( gg_snd_Dlss, 100, caster)
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Captain03 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Captain04 Learn
//===========================================================================
function Trig_Captain04_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A0RQ'
endfunction

function Trig_Captain04_Learn_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0RQ')
    local unit oldboat
    local real hppercentage
    local real ox
    local real oy
    if level == 1 then
        call UnitAddAbility(caster,'A0AC')
    elseif GetUnitAbilityLevel(caster,'A0AC') > 1 then
        call SetUnitAbilityLevel(caster,'A0AC',level)
    endif
    if udg_SK_Caption04_Ship != null then
        set oldboat = udg_SK_Caption04_Ship
        set hppercentage = GetUnitState(udg_SK_Caption04_Ship,UNIT_STATE_LIFE)/GetUnitState(udg_SK_Caption04_Ship,UNIT_STATE_MAX_LIFE)
        set ox = GetUnitX(udg_SK_Caption04_Ship)
        set oy = GetUnitY(udg_SK_Caption04_Ship)
        if level == 2 then
            set udg_SK_Caption04_Ship = CreateUnit(GetOwningPlayer(udg_SK_Caption04_Hero),'n01U',ox,oy,0)
        else
            set udg_SK_Caption04_Ship = CreateUnit(GetOwningPlayer(udg_SK_Caption04_Hero),'n01V',ox,oy,0)
        endif
        call SetUnitState(udg_SK_Caption04_Ship,UNIT_STATE_LIFE,hppercentage*GetUnitState(udg_SK_Caption04_Ship,UNIT_STATE_MAX_LIFE))
        call KillUnit(oldboat)
        call SetUnitXY(udg_SK_Caption04_Ship,ox,oy)
    endif
    set caster = null
    set oldboat = null
endfunction

//===========================================================================
function InitTrig_Captain04_Learn takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Captain04 Reg
//
// TTTTTTTTTTTTTTTT
//===========================================================================
function Trig_Captain04_Reg_Conditions takes nothing returns boolean
    if GetUnitTypeId(GetSummonedUnit())=='n01S' then
        return true
    endif
    if GetUnitTypeId(GetSummonedUnit())=='n01U' then
        return true
    endif
    if GetUnitTypeId(GetSummonedUnit())=='n01V' then
        return true
    endif
    return false
    //return GetSpellAbilityId() == 'A0AC'
endfunction

function Trig_Captain04_Reg_Actions takes nothing returns nothing
    local integer level = GetUnitAbilityLevel(udg_SK_Caption04_Hero,'A0AC')
    local integer uttype = GetUnitTypeId(GetSummonedUnit())
    local real ox = GetUnitX(GetSummonedUnit())
    local real oy = GetUnitY(GetSummonedUnit())
    call UnitRemoveAbility(udg_SK_Caption04_Hero,'A0AC')
    call UnitAddAbility(udg_SK_Caption04_Hero,'A0RO')
    set udg_SK_Caption04_Ship = CreateUnit(GetOwningPlayer(udg_SK_Caption04_Hero),uttype,ox,oy,0)
    if level == 1 then
    elseif level == 2 then
        call SetUnitAbilityLevel(udg_SK_Caption04_Ship,'A0AG',1)
    elseif level == 3 then
        call SetUnitAbilityLevel(udg_SK_Caption04_Ship,'A0AG',2)
    endif
endfunction

//===========================================================================
function InitTrig_Captain04_Reg takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Captain04 LostShip
//===========================================================================
function Trig_Captain04_LostShip_Conditions takes nothing returns boolean
    return GetTriggerUnit() == udg_SK_Caption04_Ship
endfunction

function Trig_Captain04_LostShip_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer level = GetUnitAbilityLevel(udg_SK_Caption04_Hero,'A0RQ')
    call UnitRemoveAbility(udg_SK_Caption04_Hero,'A0RR')
    call UnitAddAbility(udg_SK_Caption04_Hero,'A0AC')
    call SetUnitAbilityLevel(udg_SK_Caption04_Hero,'A0AC',level)
    call PauseTimer(t)
    call DestroyTimer(t)
    set t = null
endfunction

function Trig_Captain04_LostShip_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    set udg_SK_Caption04_Ship = null
    call UnitRemoveAbility(udg_SK_Caption04_Hero,'A0RO')
    call UnitAddAbility(udg_SK_Caption04_Hero,'A0RR')
    call TimerStart(t,60,false,function Trig_Captain04_LostShip_Clear)
    set t = null
endfunction

//===========================================================================
function InitTrig_Captain04_LostShip takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Captain04 jiasu
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Captain04_jiasu_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetLoadedUnitBJ()) == 'E00Q'
endfunction

function Trig_Captain04_jiasu_Actions takes nothing returns nothing
    call UnitAddAbility( udg_SK_Caption04_Ship, 'A0AF' )
    call SetPlayerAbilityAvailableBJ( false, 'A0AI', GetOwningPlayer(GetLoadedUnitBJ()) )
    call EnableTrigger( gg_trg_Captain04_jiansu )
endfunction

//===========================================================================
function InitTrig_Captain04_jiasu takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Captain04 jiansu
//
// TTTTTTTTTTT
//===========================================================================
function Trig_Captain04_jiansu_Conditions takes nothing returns boolean
    if ( not ( IsUnitLoadedBJ(udg_SK_Caption04_Hero) == false ) ) then
        return false
    endif
    return true
endfunction

function Trig_Captain04_jiansu_Actions takes nothing returns nothing
    call UnitRemoveAbilityBJ( 'A0AF', udg_SK_Caption04_Ship )
    call SetPlayerAbilityAvailableBJ( true, 'A0AI', GetOwningPlayer(udg_SK_Caption04_Hero) )
    call DisableTrigger( gg_trg_Captain04_jiansu )
endfunction

//===========================================================================
function InitTrig_Captain04_jiansu takes nothing returns nothing
    set gg_trg_Captain04_jiansu = CreateTrigger(  )
    call DisableTrigger( gg_trg_Captain04_jiansu )
    call TriggerRegisterTimerEventPeriodic( gg_trg_Captain04_jiansu, 1.00 )
    call TriggerAddCondition( gg_trg_Captain04_jiansu, Condition( function Trig_Captain04_jiansu_Conditions ) )
    call TriggerAddAction( gg_trg_Captain04_jiansu, function Trig_Captain04_jiansu_Actions )
endfunction

//===========================================================================
// Trigger: Captain04 yongjiutingbo
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_yongjiutingbo_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0AG'
endfunction

function zisha takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster =  LoadUnitHandle(udg_Hashtable,task,StringHash("caster"))
    local location p = LoadLocationHandle(udg_Hashtable,task,StringHash("p"))
    local location loc = GetUnitLoc(caster)
    set loc = PolarProjectionBJ(loc, 17.00, AngleBetweenPoints(loc, p))
    call SetUnitPositionLoc( caster, loc )
    if IsUnitInRangeLoc(caster,p,9.00) then
        if IsUnitAliveBJ(caster) then
            call UnitDamagePointLoc( caster, 0, 300.0, p, 100.00 + GetUnitAbilityLevel(caster,'A0AG') * 200, ATTACK_TYPE_HERO, DAMAGE_TYPE_MAGIC )
            call KillUnit(caster)
            call DestroyEffect(AddSpecialEffectLoc("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl", p ))
        endif
        call DestroyTimer(t)
        call RemoveLocation(p)
        call FlushChildHashtable(udg_Hashtable,task)
    endif
    call RemoveLocation(loc)
    set t = null
    set caster = null
    set p = null
    set loc = null
endfunction

function Trig_yongjiutingbo_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local location p = GetSpellTargetLoc()
    call SetUnitFlyHeight( caster, 0.00, 500.00 )
    call SaveUnitHandle(udg_Hashtable,task,StringHash("caster"),caster)
    call SaveLocationHandle(udg_Hashtable,task,StringHash("p"),p)   
    call TimerStart(t,0.02,true,function zisha)
    set t =null
    set caster = null
    set p = null
endfunction

//===========================================================================
function InitTrig_Captain04_yongjiutingbo takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Captain04 nihility
//===========================================================================
function Trig_Captain04_nihility_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0RP'
endfunction

function Trig_Captain04_nihility_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    if udg_SK_Caption04_Ship != null then
        if IsUnitType(udg_SK_Caption04_Ship,UNIT_TYPE_DEAD) == false then
            if GetUnitAbilityLevel(udg_SK_Caption04_Ship,'A0AH') > 0 then
                call UnitRemoveAbility(udg_SK_Caption04_Ship,'A0AH')
            endif
        endif
    endif
    call PauseTimer(t)
    call DestroyTimer(t)
    set t = null
endfunction

function Trig_Captain04_nihility_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    call UnitAddAbility(udg_SK_Caption04_Ship,'A0AH')
    call TimerStart(t,6.0,false,function Trig_Captain04_nihility_Clear)
    set t = null
endfunction

//===========================================================================
function InitTrig_Captain04_nihility takes nothing returns nothing

endfunction

//===========================================================================
// Trigger: Captain04 CallBack
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Captain04_CallBack_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0AI'
endfunction

function Trig_Captain04_CallBack_Actions takes nothing returns nothing
    local location loc = GetUnitLoc(udg_SK_Caption04_Hero)
    local unit u = GetTriggerUnit()
    call SetUnitPositionLoc( u , loc )
    call RemoveLocation(loc)
    set loc = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Captain04_CallBack takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Initial Captain
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Captain_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E00Q')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set gg_trg_Captain01 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Captain01, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Captain01, Condition( function Trig_Captain01_Conditions ) )
    call TriggerAddAction( gg_trg_Captain01, function Trig_Captain01_Actions )
    
    set gg_trg_Captain02 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Captain02, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Captain02, Condition( function Trig_Captain02_Conditions ) )
    call TriggerAddAction( gg_trg_Captain02, function Trig_Captain02_Actions )

    set gg_trg_Captain03 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Captain03, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Captain03, Condition( function Trig_bocai_Conditions ) )
    call TriggerAddAction( gg_trg_Captain03, function Trig_bocai_Actions )

    set udg_SK_Caption04_Hero = h

    set gg_trg_Captain04_Learn = CreateTrigger(  )
    call TriggerRegisterUnitEvent( gg_trg_Captain04_Learn, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Captain04_Learn, Condition( function Trig_Captain04_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Captain04_Learn, function Trig_Captain04_Learn_Actions )

    set gg_trg_Captain04_Reg = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Captain04_Reg, EVENT_PLAYER_UNIT_SUMMON )
    //call TriggerRegisterAnyUnitEventBJ( gg_trg_Captain04_Reg, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Captain04_Reg, Condition( function Trig_Captain04_Reg_Conditions ) )
    call TriggerAddAction( gg_trg_Captain04_Reg, function Trig_Captain04_Reg_Actions )

    set gg_trg_Captain04_LostShip = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Captain04_LostShip, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_Captain04_LostShip, Condition( function Trig_Captain04_LostShip_Conditions ) )
    call TriggerAddAction( gg_trg_Captain04_LostShip, function Trig_Captain04_LostShip_Actions )

    set gg_trg_Captain04_jiasu = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Captain04_jiasu, EVENT_PLAYER_UNIT_LOADED )
    call TriggerAddCondition( gg_trg_Captain04_jiasu, Condition( function Trig_Captain04_jiasu_Conditions ) )
    call TriggerAddAction( gg_trg_Captain04_jiasu, function Trig_Captain04_jiasu_Actions )

    set gg_trg_Captain04_yongjiutingbo = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Captain04_yongjiutingbo, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Captain04_yongjiutingbo, Condition( function Trig_yongjiutingbo_Conditions ) )
    call TriggerAddAction( gg_trg_Captain04_yongjiutingbo, function Trig_yongjiutingbo_Actions )

    set gg_trg_Captain04_nihility = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Captain04_nihility, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Captain04_nihility, Condition( function Trig_Captain04_nihility_Conditions ) )
    call TriggerAddAction( gg_trg_Captain04_nihility, function Trig_Captain04_nihility_Actions )

    set gg_trg_Captain04_CallBack = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Captain04_CallBack, EVENT_PLAYER_UNIT_SPELL_FINISH )
    call TriggerAddCondition( gg_trg_Captain04_CallBack, Condition( function Trig_Captain04_CallBack_Conditions ) )
    call TriggerAddAction( gg_trg_Captain04_CallBack, function Trig_Captain04_CallBack_Actions )

    //=====================================================================================================
    set gg_trg_CaptainEyebug01 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_CaptainEyebug01, gg_rct_EyePoint01 )
    call TriggerAddCondition( gg_trg_CaptainEyebug01, Condition( function Trig_CaptainEyebug01_Conditions ) )
    call TriggerAddAction( gg_trg_CaptainEyebug01, function Trig_CaptainEyebug01_Actions )

    set gg_trg_CaptainEyebug02 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_CaptainEyebug02, gg_rct_EyePoint02 )
    call TriggerAddCondition( gg_trg_CaptainEyebug02, Condition( function Trig_CaptainEyebug02_Conditions ) )
    call TriggerAddAction( gg_trg_CaptainEyebug02, function Trig_CaptainEyebug02_Actions )

    set gg_trg_CaptainEyebug03 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_CaptainEyebug03, gg_rct_EyePoint03 )
    call TriggerAddCondition( gg_trg_CaptainEyebug03, Condition( function Trig_CaptainEyebug03_Conditions ) )
    call TriggerAddAction( gg_trg_CaptainEyebug03, function Trig_CaptainEyebug03_Actions )

    set gg_trg_CaptainEyebug04 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_CaptainEyebug04, gg_rct_EyePoint04 )
    call TriggerAddCondition( gg_trg_CaptainEyebug04, Condition( function Trig_CaptainEyebug04_Conditions ) )
    call TriggerAddAction( gg_trg_CaptainEyebug04, function Trig_CaptainEyebug04_Actions )

    set gg_trg_CaptainEyebug05 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_CaptainEyebug05, gg_rct_EyePoint05 )
    call TriggerAddCondition( gg_trg_CaptainEyebug05, Condition( function Trig_CaptainEyebug05_Conditions ) )
    call TriggerAddAction( gg_trg_CaptainEyebug05, function Trig_CaptainEyebug05_Actions )

    set gg_trg_CaptainEyebug06 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_CaptainEyebug06, gg_rct_EyePoint06 )
    call TriggerAddCondition( gg_trg_CaptainEyebug06, Condition( function Trig_CaptainEyebug06_Conditions ) )
    call TriggerAddAction( gg_trg_CaptainEyebug06, function Trig_CaptainEyebug06_Actions )

    set gg_trg_CaptainEyebug07 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_CaptainEyebug07, gg_rct_EyePoint07 )
    call TriggerAddCondition( gg_trg_CaptainEyebug07, Condition( function Trig_CaptainEyebug07_Conditions ) )
    call TriggerAddAction( gg_trg_CaptainEyebug07, function Trig_CaptainEyebug07_Actions )

    set gg_trg_CaptainEyebug08 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_CaptainEyebug08, gg_rct_EyePoint08 )
    call TriggerAddCondition( gg_trg_CaptainEyebug08, Condition( function Trig_CaptainEyebug08_Conditions ) )
    call TriggerAddAction( gg_trg_CaptainEyebug08, function Trig_CaptainEyebug08_Actions )

    set gg_trg_CaptainEyebug09 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_CaptainEyebug09, gg_rct_EyePoint09 )
    call TriggerAddCondition( gg_trg_CaptainEyebug09, Condition( function Trig_CaptainEyebug09_Conditions ) )
    call TriggerAddAction( gg_trg_CaptainEyebug09, function Trig_CaptainEyebug09_Actions )

    set gg_trg_CaptainEyebug10 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_CaptainEyebug10, gg_rct_EyePoint10 )
    call TriggerAddCondition( gg_trg_CaptainEyebug10, Condition( function Trig_CaptainEyebug10_Conditions ) )
    call TriggerAddAction( gg_trg_CaptainEyebug10, function Trig_CaptainEyebug10_Actions )

    set gg_trg_CaptainEyebug11 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_CaptainEyebug11, gg_rct_EyePoint11 )
    call TriggerAddCondition( gg_trg_CaptainEyebug11, Condition( function Trig_CaptainEyebug11_Conditions ) )
    call TriggerAddAction( gg_trg_CaptainEyebug11, function Trig_CaptainEyebug11_Actions )

    set gg_trg_CaptainEyebug12 = CreateTrigger(  )
    call TriggerRegisterEnterRectSimple( gg_trg_CaptainEyebug12, gg_rct_EyePoint12 )
    call TriggerAddCondition( gg_trg_CaptainEyebug12, Condition( function Trig_CaptainEyebug12_Conditions ) )
    call TriggerAddAction( gg_trg_CaptainEyebug12, function Trig_CaptainEyebug12_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Captain takes nothing returns nothing
    set gg_trg_Initial_Captain = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Captain, function Trig_Initial_Captain_Actions )
endfunction

//===========================================================================
// Trigger: Shikieiki01
//
// Shikieiki
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Shikieiki01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0B7'
endfunction

function Trig_Shikieiki01_Debuff_Degree takes unit h returns integer
    return GetUnitAbilityLevel(h,'A0B0')
endfunction

function Trig_Shikieiki01_Debuff_Display takes unit caster,unit target returns nothing
    local string msg = GetHeroProperName(target)
    local integer degree = GetUnitAbilityLevel(target,'A0B0')
    set msg = msg + "：|cffff0000"
    set msg = msg + udg_SK_Shikieiki_Degree[degree] + "|r"
    call DisplayTextToPlayer(GetOwningPlayer(caster),0.0,0.0,msg)
    //call DebugMsg(msg)
    set msg = null
endfunction

function Trig_Shikieiki01_Debuff_Clear takes unit caster,unit target returns nothing
    if IsUnitIllusion(target) or (not IsUnitType(target,UNIT_TYPE_HERO)) then
        set caster = null
        set target = null
        return
    endif
    call SaveInteger(udg_SK_Shikieiki_Count,GetHandleId(target),1,LoadInteger(udg_SK_Shikieiki_Count,GetHandleId(target),0))
    call UnitRemoveAbility(target,'A0B0')
    call Trig_Shikieiki01_Debuff_Display(caster,target)
    call Trig_Shikieiki01_Debuff_Display(target,target)
    set caster = null
    set target = null
endfunction

function Trig_Shikieiki01_Debuff_Fade takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local integer d = LoadInteger(udg_ht,task,2)
    local integer i = LoadInteger(udg_SK_Shikieiki_Count,GetHandleId(target),1)
    local integer level
    //========
    if LoadInteger(udg_SK_Shikieiki_Count,GetHandleId(target),2) != 0 then
        call SaveInteger(udg_SK_Shikieiki_Count,GetHandleId(target),2,LoadInteger(udg_SK_Shikieiki_Count,GetHandleId(target),2)-1)
    elseif d > i then
        set level = GetUnitAbilityLevel(target,'A0B0')
        if level>1 then
            call SetUnitAbilityLevel(target,'A0B0',level - 1)
        else
            call UnitRemoveAbility(target,'A0B0')
        endif
        call Trig_Shikieiki01_Debuff_Display(caster,target)
        call Trig_Shikieiki01_Debuff_Display(target,target)
    endif
    call FlushChildHashtable(udg_ht,task)
    call DestroyTimer(t)
    //========
    set t = null
    set caster = null
    set target = null
endfunction

function Trig_Shikieiki01_Debuff_Add takes unit caster,unit target,real bufftime returns nothing
    local timer t
    local integer task
    local integer level
    //========
    if IsUnitIllusion(target) or (not IsUnitType(target,UNIT_TYPE_HERO)) then
        set t = null
        set caster = null
        set target = null
        return
    endif
    set t = CreateTimer()
    set task = GetHandleId(t)
    if HaveSavedInteger(udg_SK_Shikieiki_Count,GetHandleId(target),0) then
        call SaveInteger(udg_SK_Shikieiki_Count,GetHandleId(target),0,LoadInteger(udg_SK_Shikieiki_Count,GetHandleId(target),0)+1)
    else
        call SaveInteger(udg_SK_Shikieiki_Count,GetHandleId(target),0,1)
        call SaveInteger(udg_SK_Shikieiki_Count,GetHandleId(target),1,0)
        call SaveInteger(udg_SK_Shikieiki_Count,GetHandleId(target),2,0)
    endif
    if GetUnitAbilityLevel(target,'A0B0') <= 0 then
        call UnitAddAbility(target,'A0B0')
        call UnitMakeAbilityPermanent(target,true,'A0B0')
    else
        if GetUnitAbilityLevel(target,'A0B0') < 10 then
            call SetUnitAbilityLevel(target,'A0B0',GetUnitAbilityLevel(target,'A0B0')+1)
        else
            call SaveInteger(udg_SK_Shikieiki_Count,GetHandleId(target),2,LoadInteger(udg_SK_Shikieiki_Count,GetHandleId(target),2)+1)
        endif        
    endif
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveInteger(udg_ht,task,2,LoadInteger(udg_SK_Shikieiki_Count,GetHandleId(target),0))
    call TimerStart(t,bufftime,false,function Trig_Shikieiki01_Debuff_Fade)
    call Trig_Shikieiki01_Debuff_Display(caster,target)
    call Trig_Shikieiki01_Debuff_Display(target,target)
    //========
    set t = null
    set caster = null
    set target = null
endfunction

function Trig_Shikieiki01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit u
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    //========
    local real abilitycooldownlv01 = 16
    local real abilitycooldownlv02 = 14
    local real abilitycooldownlv03 = 12
    local real abilitycooldownlv04 = 10
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set u = null
            return
        endif
    endif
    //========
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),tx - 5.0,ty,0.0)
    call UnitAddAbility(u,'A0B8')
    call IssuePointOrder(u,"breathoffrost",tx,ty)
    if IsUnitType(target,UNIT_TYPE_HERO) then
        call Trig_Shikieiki01_Debuff_Add(caster,target,330.0)
    endif
    if GetUnitAbilityLevel(caster,'A0I1')==0 then
        call UnitAddAbility(caster,'A0I1')
        call UnitMakeAbilityPermanent(caster,true,'A0I1')
    endif
    //========
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Shikieiki01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Shikieiki01 Active
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Shikieiki01_Active_Conditions takes nothing returns boolean
    local unit target
    local boolean k
    if GetKillingUnit()==null then
        return false
    endif
    if GetUnitAbilityLevel(GetTriggerUnit(),'Aloc')>0 then
        return false
    endif
    if IsUnitIllusion(GetTriggerUnit()) then
        return false
    endif
    set target = GetPlayerCharacter(GetOwningPlayer(GetKillingUnit()))
    if target==null then
        return false
    endif
    set k = IsUnitAlive(target) and GetUnitAbilityLevel(target,'B02A')>0
    set target = null
    return k
endfunction

function Trig_Shikieiki01_Active_Actions takes nothing returns nothing
    local unit caster = LoadUnitHandle(udg_sht,GetHandleId(GetTriggeringTrigger()),0)
    local unit target = GetPlayerCharacter(GetOwningPlayer(GetKillingUnit()))
    local integer level = GetUnitAbilityLevel(caster,'A0B7')
    local real damage
    local unit u = GetTriggerUnit()
    //========
    if IsUnitType(u,UNIT_TYPE_HERO) then
        set damage = GetUnitState(target,UNIT_STATE_MAX_LIFE)*(0.20+0.05*level)
    else
        set damage = GetUnitState(target,UNIT_STATE_MAX_LIFE)*(0.02+0.02*level)
        if GetUnitState(u,UNIT_STATE_MAX_LIFE) < 200 then
            set damage = damage*0.5
        endif
    endif
    call DebugMsg("惩罚伤害"+R2S(damage))
    call UnitDamageTargetHJ(caster,target,damage,2)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Demon\\DarkPortal\\DarkPortalTarget.mdl",target,"origin"))
    //========
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Shikieiki01_Active takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Shikieiki01 Display
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Shikieiki01_Display_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0I1'
endfunction

function Trig_Shikieiki01_Display_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit h
    local group g = CreateGroupOfAllHeroes()
    loop
        set h = FirstOfGroup(g)
        exitwhen h==null
        call GroupRemoveUnit(g,h)
        if IsUnitEnemy(h,GetOwningPlayer(caster)) then
            call Trig_Shikieiki01_Debuff_Display(caster,h)
        endif
    endloop
    set caster = null
    set h = null
    set g = null
endfunction

//===========================================================================
function InitTrig_Shikieiki01_Display takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Shikieiki01 Death
//===========================================================================
function Trig_Shikieiki01_Death_Conditions takes nothing returns boolean
    if IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO) == false then
        return false
    endif
    if IsUnitIllusionBJ(GetTriggerUnit()) then
        return false
    endif
    if IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(udg_SK_Shikieiki)) then                        
        return false
    endif
    if IsUnitAlly(GetKillingUnitBJ(),GetOwningPlayer(udg_SK_Shikieiki)) == false then                        
        return false
    endif
    return true
endfunction

function Trig_Shikieiki01_Death_Actions takes nothing returns nothing
    call Trig_Shikieiki01_Debuff_Clear(udg_SK_Shikieiki,GetTriggerUnit())
endfunction

//===========================================================================
function InitTrig_Shikieiki01_Death takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Shikieiki02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Shikieiki02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0I4'
endfunction

function Trig_Shikieiki02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit w
    local integer level = GetUnitAbilityLevel(caster,'A0I4')
    local integer degree = Trig_Shikieiki01_Debuff_Degree(target)
    local real s
    //========
    local real abilitycooldownlv01 = 30
    local real abilitycooldownlv02 = 25
    local real abilitycooldownlv03 = 20
    local real abilitycooldownlv04 = 15
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            return
        endif
    endif
    //======== 
    if degree>0 then
        set s = (0.12+0.06*degree)*GetUnitState(target,UNIT_STATE_MAX_LIFE)
        call UnitDamageTargetHJ(caster,target,s,2)
        if IsUnitType(target,UNIT_TYPE_HERO) then
            call Trig_Shikieiki01_Debuff_Clear(caster,target)
        endif
        set w = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0)
        call UnitAddAbility(w,'A0BA')
        call IssueTargetOrder(w,"thunderbolt",target)
    elseif IsUnitAlly(caster,GetOwningPlayer(target)) then
        set s = level*50 + 50
        call SetUnitState(target, UNIT_STATE_LIFE, GetUnitState(target,UNIT_STATE_LIFE)+s) 
    else
        set w = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0)
        call UnitAddAbility(w,'A0BA')
        call IssueTargetOrder(w,"thunderbolt",target)
    endif
    set caster = null
    set target = null
    set w = null 
endfunction

//===========================================================================
function InitTrig_Shikieiki02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Shikieiki03
//===========================================================================
function Trig_Shikieiki03_Conditions takes nothing returns boolean
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) == false then
        return false
    endif
    if IsUnitIllusion(GetTriggerUnit()) then
        return false
    endif
    if GetUnitAbilityLevel(GetAttacker(),'A0SY') == 0 then
        return false
    endif
    return GetUnitTypeId(GetAttacker()) == 'E00V'
endfunction

function Trig_Shikieiki03_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local integer level
    local real damage
    local integer buffcount
    local integer buffneed
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        set trg = null
        set caster = null
        set target = null
        return
    endif
    set target = GetTriggerUnit()
    set level = GetUnitAbilityLevel(caster,'A0SY')
    //========
    call DisableTrigger(trg)
    //========
    set damage = level * 2 + 2
    set buffcount = GetUnitAbilityLevel(target,'A0SZ') + 1
    set buffneed = 10 - Trig_Shikieiki01_Debuff_Degree(target)
    call DisplayTextToPlayer(GetOwningPlayer(caster),0,0,I2S(buffcount)+"/"+I2S(buffneed))
    if buffcount >= buffneed then
        set damage = damage + 30 * level + 30
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Demon\\ReviveDemon\\ReviveDemon.mdl",GetUnitX(target),GetUnitY(target)))
        call Trig_Shikieiki01_Debuff_Add(caster,target,level*45+45.0)
        if GetUnitAbilityLevel(target,'A0SZ') != 0 then
            call UnitRemoveAbility(target,'A0SZ')
        endif
    else
        if GetUnitAbilityLevel(target,'A0SZ') == 0 then
            call UnitAddAbility(target,'A0SZ')
            call UnitMakeAbilityPermanent(target,true,'A0SZ')
        else
            call SetUnitAbilityLevel(target,'A0SZ',buffcount)
        endif
    endif
    call UnitDamageTargetHJ(caster,target,damage,2)
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
endfunction

function Trig_Shikieiki03_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_Shikieiki03_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Shikieiki03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Shikieiki04
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 无法对友军和镜像释放
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Shikieiki04_Conditions takes nothing returns boolean
    if GetSpellAbilityId() != 'A0BF' then
        return false
    endif
    if IsUnitIllusion(GetSpellTargetUnit()) then
        return false
    endif
    if not IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) then
        return false
    endif
    return IsUnitEnemy(GetSpellTargetUnit(),GetOwningPlayer(GetTriggerUnit()))
endfunction

function Trig_Shikieiki04_Damage takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit u = LoadUnitHandle(udg_ht,task,2)
    local real damage
    local integer level =  LoadInteger(udg_ht,task,0)
    local triggeraction tga
    //========
    if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
        set damage = (3.5-level*0.5)*GetEventDamage()
        call SetUnitState(u,UNIT_STATE_LIFE,GetUnitState(u,UNIT_STATE_LIFE) - damage)
    elseif GetTriggerEventId()==EVENT_UNIT_DEATH then
        set tga = LoadTriggerActionHandle(udg_ht,task,3)
        call FlushChildHashtable(udg_ht,task)
        call TriggerRemoveAction(trg,tga)
        call DestroyTrigger(trg)
    endif
    //========
    set u = null
    set trg = null
    set tga = null
endfunction

function Trig_Shikieiki04_Main_Action takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local unit u = GetSummonedUnit()
    local integer level = LoadInteger(udg_ht,task,0)
    local triggeraction tga = LoadTriggerActionHandle(udg_ht,task,3)
    //========
    call FlushChildHashtable(udg_ht,task)
    call TriggerRemoveAction(trg,tga)
    call DestroyTrigger(trg)
    //========
    set trg = CreateTrigger()
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,u,EVENT_UNIT_DEATH)
    set tga = TriggerAddAction(trg,function Trig_Shikieiki04_Damage)
    set task = GetHandleId(trg)
    call SaveInteger(udg_ht,task,0,level)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveUnitHandle(udg_ht,task,2,u)
    call SaveTriggerActionHandle(udg_ht,task,3,tga)
    call DebugMsg("四季04")
    //========
    set caster = null
    set target = null
    set u = null
    set trg = null
    set tga = null
endfunction

function Trig_Shikieiki04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local integer degree = Trig_Shikieiki01_Debuff_Degree(target)
    local unit u = CreateUnit(GetOwningPlayer(caster),'n020',GetUnitX(target),GetUnitY(target),0)
    local trigger trg = CreateTrigger()
    local triggeraction tga = TriggerAddAction(trg,function Trig_Shikieiki04_Main_Action)
    local integer task
    //========
    local real abilitycooldownlv01 = 75
    local real abilitycooldownlv02 = 75
    local real abilitycooldownlv03 = 75
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========    
    call TriggerRegisterUnitEvent(trg,u,EVENT_UNIT_SUMMON)
    
    set task = GetHandleId(trg)
    call SaveInteger(udg_ht,task,0,level)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveTriggerActionHandle(udg_ht,task,3,tga)
    
    call UnitAddAbility(u,'A0BG')
    call SetUnitAbilityLevel(u,'A0BG',degree + 1)
    call IssueTargetOrderById(u,852274,target)
    
    if IsUnitType(target,UNIT_TYPE_HERO) then
        call Trig_Shikieiki01_Debuff_Clear(caster,target)
    endif
     
    set caster = null
    set target = null
    set u = null
    set trg = null
    set tga = null    
endfunction

//===========================================================================
function InitTrig_Shikieiki04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Shikieiki
//
// Shikieiki变量名修复 原来打错了
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Shikieiki_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E00V')
    local integer i
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set udg_SK_Shikieiki = h
    set udg_SK_Shikieiki_Count = InitHashtable()

    set gg_trg_Shikieiki01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Shikieiki01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Shikieiki01, Condition( function Trig_Shikieiki01_Conditions ) )
    call TriggerAddAction( gg_trg_Shikieiki01, function Trig_Shikieiki01_Actions )
    
    set gg_trg_Shikieiki01_Active = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Shikieiki01_Active, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_Shikieiki01_Active, Condition( function Trig_Shikieiki01_Active_Conditions ) )
    call TriggerAddAction( gg_trg_Shikieiki01_Active, function Trig_Shikieiki01_Active_Actions )
    call SaveUnitHandle(udg_sht,GetHandleId(gg_trg_Shikieiki01_Active),0,h)
    
    set gg_trg_Shikieiki01_Display = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Shikieiki01_Display, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Shikieiki01_Display, Condition( function Trig_Shikieiki01_Display_Conditions ) )
    call TriggerAddAction( gg_trg_Shikieiki01_Display, function Trig_Shikieiki01_Display_Actions )

    set gg_trg_Shikieiki01_Death = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Shikieiki01_Death, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_Shikieiki01_Death, Condition( function Trig_Shikieiki01_Death_Conditions ) )
    call TriggerAddAction( gg_trg_Shikieiki01_Death, function Trig_Shikieiki01_Death_Actions )
    
    set gg_trg_Shikieiki02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Shikieiki02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Shikieiki02, Condition( function Trig_Shikieiki02_Conditions ) )
    call TriggerAddAction( gg_trg_Shikieiki02, function Trig_Shikieiki02_Actions )
    
    set gg_trg_Shikieiki03 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Shikieiki03, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Shikieiki03, Condition( function Trig_Shikieiki03_Conditions ) )
    call TriggerAddAction( gg_trg_Shikieiki03, function Trig_Shikieiki03_Actions )
    
    set gg_trg_Shikieiki04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Shikieiki04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Shikieiki04, Condition( function Trig_Shikieiki04_Conditions ) )
    call TriggerAddAction( gg_trg_Shikieiki04, function Trig_Shikieiki04_Actions )
    
    set udg_SK_Shikieiki_Degree[0] = "无"
    set udg_SK_Shikieiki_Degree[1] = "一"
    set udg_SK_Shikieiki_Degree[2] = "二"
    set udg_SK_Shikieiki_Degree[3] = "三"
    set udg_SK_Shikieiki_Degree[4] = "四"
    set udg_SK_Shikieiki_Degree[5] = "五"
    set udg_SK_Shikieiki_Degree[6] = "六"
    set udg_SK_Shikieiki_Degree[7] = "七"
    set udg_SK_Shikieiki_Degree[8] = "八"
    set udg_SK_Shikieiki_Degree[9] = "九"
    set udg_SK_Shikieiki_Degree[10] = "十"
    set udg_SK_Shikieiki_Degree[11] = "十一"
    set udg_SK_Shikieiki_Degree[12] = "十二"
    
    call UnitMakeAbilityPermanent(h,true,'A0IM')
    call UnitMakeAbilityPermanent(h,true,'A0IO')
    
    set h = null
endfunction

function InitTrig_Initial_Shikieiki takes nothing returns nothing
    set gg_trg_Initial_Shikieiki = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Shikieiki, function Trig_Initial_Shikieiki_Actions )
endfunction

//===========================================================================
// Trigger: Cat01 Reg
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0

function Trig_Cat01_Reg_Conditions takes nothing returns boolean
    local integer ID = GetUnitTypeId(GetSummonedUnit()) 
    return ('u00C'<=ID) and (ID<='u00E')
endfunction

function Trig_Cat01_Reg_Actions takes nothing returns nothing
    local real abilitycooldownlv01 = 40
    local real abilitycooldownlv02 = 40
    local real abilitycooldownlv03 = 40
    local real abilitycooldownlv04 = 40
    if UnitHasItemOfTypeBJ(GetSummoningUnit(), 'I00B') then
        if GetUnitAbilityLevel(GetSummoningUnit(),'A0BH') == 1 then
            call Item_HeroAbilityCoolDownReset(GetSummoningUnit(),'A0BH',abilitycooldownlv01)
        elseif GetUnitAbilityLevel(GetSummoningUnit(),'A0BH') == 2 then
            call Item_HeroAbilityCoolDownReset(GetSummoningUnit(),'A0BH',abilitycooldownlv02)
        elseif GetUnitAbilityLevel(GetSummoningUnit(),'A0BH') == 3 then
            call Item_HeroAbilityCoolDownReset(GetSummoningUnit(),'A0BH',abilitycooldownlv03)
        elseif GetUnitAbilityLevel(GetSummoningUnit(),'A0BH') == 4 then
            call Item_HeroAbilityCoolDownReset(GetSummoningUnit(),'A0BH',abilitycooldownlv04)
        endif
    endif
    //========
    call EnableTrigger( gg_trg_Cat01_BodyRemove )
    set udg_SK_Cat01_Hero = GetSummoningUnit()
    set udg_SK_Cat01_Wagon = GetSummonedUnit()
    set udg_SK_Cat01_BodyNo = 0
endfunction

//===========================================================================
function InitTrig_Cat01_Reg takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Cat01 BodyGet
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Cat01_BodyGet_Conditions takes nothing returns boolean
    return GetTransportUnit() == udg_SK_Cat01_Wagon
endfunction

function Trig_Cat01_BodyGet_Actions takes nothing returns nothing
    call GroupAddUnit( udg_SK_Cat01_BodyGrp, GetTriggerUnit() )
endfunction

//===========================================================================
function InitTrig_Cat01_BodyGet takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Cat01 BodyRemove
//===========================================================================
function Trig_Cat01_BodyRemove_Func001002001 takes nothing returns boolean
    return ( IsUnitLoadedBJ(GetEnumUnit()) == true )
endfunction

function Trig_Cat01_BodyRemove_Func001002 takes nothing returns nothing
    if ( Trig_Cat01_BodyRemove_Func001002001() ) then
        call DoNothing(  )
    else
        call GroupRemoveUnitSimple( GetEnumUnit(), udg_SK_Cat01_BodyGrp )
    endif
endfunction

function Trig_Cat01_BodyRemove_Func003Func001C takes nothing returns boolean
    if ( not ( udg_SK_Cat01_BodyNo == 1 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Cat01_BodyRemove_Func003Func002C takes nothing returns boolean
    if ( not ( udg_SK_Cat01_BodyNo == 2 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Cat01_BodyRemove_Func003Func003C takes nothing returns boolean
    if ( not ( udg_SK_Cat01_BodyNo == 3 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Cat01_BodyRemove_Func003C takes nothing returns boolean
    if ( not ( udg_SK_Cat01_BodyNo == 0 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Cat01_BodyRemove_Actions takes nothing returns nothing
    call ForGroupBJ( udg_SK_Cat01_BodyGrp, function Trig_Cat01_BodyRemove_Func001002 )
    set udg_SK_Cat01_BodyNo = CountUnitsInGroup(udg_SK_Cat01_BodyGrp)
    if ( Trig_Cat01_BodyRemove_Func003C() ) then
        call UnitRemoveAbilityBJ( 'A0BJ', udg_SK_Cat01_Hero )
        call UnitRemoveAbilityBJ( 'A0BK', udg_SK_Cat01_Hero )
        call UnitRemoveAbilityBJ( 'A0BL', udg_SK_Cat01_Hero )
        call UnitRemoveAbilityBJ( 'A0IT', udg_SK_Cat01_Hero )
        call UnitRemoveAbilityBJ( 'A0IU', udg_SK_Cat01_Hero )
        call UnitRemoveAbilityBJ( 'A0IV', udg_SK_Cat01_Hero )
    else
        if ( Trig_Cat01_BodyRemove_Func003Func001C() ) then
            call UnitAddAbilityBJ( 'A0BJ', udg_SK_Cat01_Hero )
            call UnitRemoveAbilityBJ( 'A0BK', udg_SK_Cat01_Hero )
            call UnitRemoveAbilityBJ( 'A0BL', udg_SK_Cat01_Hero )
            call UnitAddAbilityBJ( 'A0IT', udg_SK_Cat01_Hero )
            call UnitRemoveAbilityBJ( 'A0IU', udg_SK_Cat01_Hero )
            call UnitRemoveAbilityBJ( 'A0IV', udg_SK_Cat01_Hero )
            return
        else
            call DoNothing(  )
        endif
        if ( Trig_Cat01_BodyRemove_Func003Func002C() ) then
            call UnitRemoveAbilityBJ( 'A0BJ', udg_SK_Cat01_Hero )
            call UnitAddAbilityBJ( 'A0BK', udg_SK_Cat01_Hero )
            call UnitRemoveAbilityBJ( 'A0BL', udg_SK_Cat01_Hero )
            call UnitRemoveAbilityBJ( 'A0IT', udg_SK_Cat01_Hero )
            call UnitAddAbilityBJ( 'A0IU', udg_SK_Cat01_Hero )
            call UnitRemoveAbilityBJ( 'A0IV', udg_SK_Cat01_Hero )
            return
        else
            call DoNothing(  )
        endif
        if ( Trig_Cat01_BodyRemove_Func003Func003C() ) then
            call UnitRemoveAbilityBJ( 'A0BJ', udg_SK_Cat01_Hero )
            call UnitRemoveAbilityBJ( 'A0BK', udg_SK_Cat01_Hero )
            call UnitAddAbilityBJ( 'A0BL', udg_SK_Cat01_Hero )
            call UnitRemoveAbilityBJ( 'A0IT', udg_SK_Cat01_Hero )
            call UnitRemoveAbilityBJ( 'A0IU', udg_SK_Cat01_Hero )
            call UnitAddAbilityBJ( 'A0IV', udg_SK_Cat01_Hero )
            return
        else
            call DoNothing(  )
        endif
    endif
endfunction

//===========================================================================
function InitTrig_Cat01_BodyRemove takes nothing returns nothing
    set gg_trg_Cat01_BodyRemove = CreateTrigger(  )
    call DisableTrigger( gg_trg_Cat01_BodyRemove )
    call TriggerRegisterTimerEventPeriodic( gg_trg_Cat01_BodyRemove, 1.00 )
    call TriggerAddAction( gg_trg_Cat01_BodyRemove, function Trig_Cat01_BodyRemove_Actions )
endfunction

//===========================================================================
// Trigger: Cat02
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_zhenshan_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0BM'
endfunction

function Trig_zhenshan_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local player PLY = GetOwningPlayer(caster)
    local real x = GetSpellTargetX()
    local real y = GetSpellTargetY()
    local unit u = CreateUnit( PLY, 'n00R', x, y, 0 )
    //========
    local real abilitycooldownlv01 = 12
    local real abilitycooldownlv02 = 12
    local real abilitycooldownlv03 = 12
    local real abilitycooldownlv04 = 12
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call UnitAddAbility( u, 'A0BN' )
    call SetUnitAbilityLevel( u, 'A0BN', GetUnitAbilityLevel(caster, 'A0BM') )
    call TriggerSleepAction( 1.0 )
    call IssuePointOrder( u, "rainoffire", x,y)
    call TriggerSleepAction( 6 )
    call KillUnit(u)  
    set caster = null
    set PLY = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Cat02 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Cat03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Cat03_Conditions takes nothing returns boolean
    return GetUnitAbilityLevel(GetSummonedUnit(),'BUan') > 0
endfunction

function Trig_Cat03_Actions takes nothing returns nothing
    local unit u = GetSummonedUnit()
    local unit hero = GetPlayerCharacter(GetOwningPlayer(u))
    local integer level = GetUnitAbilityLevel(hero,'A0BO')
    local real life = GetUnitState(u,UNIT_STATE_MAX_LIFE)
    //========
    local real abilitycooldownlv01 = 16
    local real abilitycooldownlv02 = 10
    local real abilitycooldownlv03 = 8
    local real abilitycooldownlv04 = 4
    if UnitHasItemOfTypeBJ(GetSummoningUnit(), 'I00B') then
        if GetUnitAbilityLevel(GetSummoningUnit(),'A0BO') == 1 then
            call Item_HeroAbilityCoolDownReset(GetSummoningUnit(),'A0BO',abilitycooldownlv01)
        elseif GetUnitAbilityLevel(GetSummoningUnit(),'A0BO') == 2 then
            call Item_HeroAbilityCoolDownReset(GetSummoningUnit(),'A0BO',abilitycooldownlv02)
        elseif GetUnitAbilityLevel(GetSummoningUnit(),'A0BO') == 3 then
            call Item_HeroAbilityCoolDownReset(GetSummoningUnit(),'A0BO',abilitycooldownlv03)
        elseif GetUnitAbilityLevel(GetSummoningUnit(),'A0BO') == 4 then
            call Item_HeroAbilityCoolDownReset(GetSummoningUnit(),'A0BO',abilitycooldownlv04)
        endif
    endif
    //========
    call addlife(u,R2I(life*(0.10+0.10*level)))
    set u = null
    set hero = null
endfunction

//===========================================================================
function InitTrig_Cat03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Cat04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Rin04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0BP'
endfunction

function Trig_Rin04_Recursive_Target takes nothing returns boolean
    return GetUnitAbilityLevel(GetFilterUnit(),'BUan')>=0
endfunction

function Trig_Rin04_Recursive takes nothing returns nothing
    local unit caster = udg_SK_Cat04_Hero
    local unit u
    local unit v = GetEnumUnit()
    if not IsUnitInGroup(v,udg_SK_Cat04_Group) then
        set u = CreateUnit(GetOwningPlayer(caster),GPSU(),GetUnitX(v),GetUnitY(v),0.0)
        call UnitAddAbility(u,'A0BP')
        call IssueTargetOrder(u,"cripple",v)
    endif
    set caster = null
    set u = null
    set v = null
endfunction

function Trig_Rin04_Damage takes unit u,unit v,unit h,integer level returns nothing
    local real damage = 80.00 + 40.00*level
    if GetUnitState(u,UNIT_STATE_MAX_LIFE)<=200.0 then
        set damage = damage*0.5
    endif
    call UnitDamageTarget(h,v,damage,false,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
endfunction

function Trig_Rin04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local unit u
    local unit v
    local real px 
    local real py 
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local group g
    local boolexpr f
    local boolexpr iff
    //========
    if IsUnitAlive(target) and UnitHasBuffBJ(target,'B02G') then
        set px = GetUnitX(target)
        set py = GetUnitY(target)
        
        set iff = GetPlayerFilter(GetOwningPlayer(caster))
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,px,py,360.0,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            call Trig_Rin04_Damage(target,v,caster,level)
        endloop
        call DestroyGroup(g)
        call KillUnit(target)
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl",px,py))
        call GroupRemoveUnit(udg_SK_Cat04_Group,target)
        
        if IsUnitAlive(caster) and IsUnitInRange(target,caster,1500.0) then
            set u = CreateUnit(GetOwningPlayer(caster),GPSU(),px,py,0.0)
            call UnitAddAbility(u,'A0BQ')
            call IssueImmediateOrder(u,"animatedead")
            
            set f = Filter(function Trig_Rin04_Recursive_Target)
            set g = CreateGroup()
            call GroupEnumUnitsInRange(g,px,py,380.0,f)
            call ForGroup(g,function Trig_Rin04_Recursive)
            call DestroyGroup(g)
            call DestroyBoolExpr(f)
        endif
    endif
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    //========
    set t = null
    set caster = null
    set target = null
    set u = null
    set v = null
    set g = null
    set f = null
    set iff = null
endfunction

function Trig_Rin04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer level
    //========
    local real abilitycooldownlv01 = 90
    local real abilitycooldownlv02 = 72
    local real abilitycooldownlv03 = 54
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    if GetUnitTypeId(caster)=='E00W' then
        call GroupClear(udg_SK_Cat04_Group)
        set udg_SK_Cat04_Hero = caster
        set level = GetUnitAbilityLevel(caster,'A0BP')
    else
        set caster = udg_SK_Cat04_Hero
        set level = GetUnitAbilityLevel(caster,'A0BP')
    endif
    call GroupAddUnit(udg_SK_Cat04_Group,target)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,0)
    call TimerStart(t,7.25 + GetRandomReal(0.0,0.5),false,function Trig_Rin04_Main)
    //========
    set caster = null
    set target = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Cat04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Cat
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Cat_Actions takes nothing returns nothing

call DebugMsg("猫车技能加载完毕")
//=====================================  1  ===========================================================

    set gg_trg_Cat01_Reg = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Cat01_Reg, EVENT_PLAYER_UNIT_SUMMON )
    call TriggerAddCondition( gg_trg_Cat01_Reg, Condition( function Trig_Cat01_Reg_Conditions ) )
    call TriggerAddAction( gg_trg_Cat01_Reg, function Trig_Cat01_Reg_Actions )

    set gg_trg_Cat01_BodyGet = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Cat01_BodyGet, EVENT_PLAYER_UNIT_LOADED )
    call TriggerAddCondition( gg_trg_Cat01_BodyGet, Condition( function Trig_Cat01_BodyGet_Conditions ) )
    call TriggerAddAction( gg_trg_Cat01_BodyGet, function Trig_Cat01_BodyGet_Actions )

    //set gg_trg_Cat01_LimitBodyGet = CreateTrigger(  )
    //call TriggerRegisterAnyUnitEventBJ( gg_trg_Cat01_LimitBodyGet, EVENT_PLAYER_UNIT_SPELL_CHANNEL )
    //call TriggerAddCondition( gg_trg_Cat01_LimitBodyGet, Condition( function Trig_Cat01_LimitBodyGet_Conditions ) )
    //call TriggerAddAction( gg_trg_Cat01_LimitBodyGet, function Trig_Cat01_LimitBodyGet_Actions )

//=====================================  2  ===========================================================

    set gg_trg_Cat02 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Cat02, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Cat02, Condition( function Trig_zhenshan_Conditions ) )
    call TriggerAddAction( gg_trg_Cat02, function Trig_zhenshan_Actions )

//=====================================  3  ===========================================================

    set gg_trg_Cat03 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Cat03, EVENT_PLAYER_UNIT_SUMMON )
    call TriggerAddCondition( gg_trg_Cat03, Condition( function Trig_Cat03_Conditions ) )
    call TriggerAddAction( gg_trg_Cat03, function Trig_Cat03_Actions )

//=====================================  4  ===========================================================

    set gg_trg_Cat04 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Cat04, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Cat04, Condition( function Trig_Rin04_Conditions ) )
    call TriggerAddAction( gg_trg_Cat04, function Trig_Rin04_Actions )

//=====================================================================================================
endfunction

//===========================================================================
function InitTrig_Initial_Cat takes nothing returns nothing
    set gg_trg_Initial_Cat = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Cat, function Trig_Initial_Cat_Actions )
endfunction

//===========================================================================
// Trigger: KogasaDS
//===========================================================================
function Trig_KogasaDS_Conditions takes nothing returns boolean
    return IsUnitAlive(GetPlayerCharacter(GetTriggerPlayer()))
endfunction

function Trig_KogasaDS_Actions takes nothing returns nothing
    local player who = GetTriggerPlayer()
    local unit caster = GetPlayerCharacter(who)
    local integer level01 = GetUnitAbilityLevel(caster,'A0LS')
    local real damage01 = 70 + level01 * 10 + I2R(GetHeroAgi(caster,true)) * (0.50 + level01 * 0.15)
    if level01 != 0 then
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00化铁「备用雨伞特急列车黑夜嘉年华」伤害：|r" + R2S(damage01))
    endif
    set who = null
    set caster = null
endfunction


//===========================================================================
function InitTrig_KogasaDS takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Kogasa01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Kogasa01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0C3'
endfunction

function Trig_Kogasa01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i>0 and IsUnitAlive(caster) then
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call UnitRemoveAbility(caster,'A0C4')
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
endfunction

function Trig_Kogasa01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer s = 12
    //========
    call UnitAddAbility(caster,'A0C4')
    call SetUnitAbilityLevel(caster,'A0C4',level)
    call UnitMakeAbilityPermanent(caster,true,'A0C4')
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,s*10)
    call TimerStart(t,0.1,true,function Trig_Kogasa01_Main)
    //========
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Kogasa01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Kogasa02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Kogasa02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0LS'
endfunction

function Trig_Kogasa02_Target takes nothing returns boolean
    if GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)<=0 then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(LoadUnitHandle(udg_ht,GetHandleId(GetExpiredTimer()),0))) then
        return false
    endif
    if GetUnitTypeId(GetFilterUnit()) == 'n01N' then
        return false
    endif
    return true
endfunction

function Trig_Kogasa02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = LoadInteger(udg_ht,task,1)
    local integer i = LoadInteger(udg_ht,task,2) 
    local real damage = 70 + level * 10 + I2R(GetHeroAgi(caster,true))*(0.50+level*0.15)
    local real damage2 
    local boolexpr f
    local group g
    local unit v
    if i > 0 and GetUnitState(caster, UNIT_STATE_LIFE) >= 1 then
        set i = i - 1
        set g = CreateGroup()
        set f = Filter(function Trig_Kogasa02_Target)
        call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),300,f)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            set damage2 = damage
            if IsUnitType(v,UNIT_TYPE_STRUCTURE) == true then
                set damage2 = damage * 0.50
            endif
            call UnitDamageTarget(caster,v,damage2*0.1,true,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
        endloop
        call DestroyGroup(g) 
        call SaveInteger(udg_ht,task,2,i)   
    else
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set f = null
    set g = null
    set v = null          
endfunction

function Trig_Kogasa02_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0LS') 
    local integer i = 25 + level * 5
    //========
    local real abilitycooldownlv01 = 12
    local real abilitycooldownlv02 = 12
    local real abilitycooldownlv03 = 12
    local real abilitycooldownlv04 = 12
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,1,level)
    call SaveInteger(udg_ht,task,2,i)
    call TimerStart(t,0.1,true,function Trig_Kogasa02_Main)
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Kogasa02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Kogasa03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Kogasa03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0C8'
endfunction

function Trig_Kogasa03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    //========
    local real abilitycooldownlv01 = 40
    local real abilitycooldownlv02 = 30
    local real abilitycooldownlv03 = 20
    local real abilitycooldownlv04 = 10
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call PauseUnit( caster, true )
    call SetUnitInvulnerable( caster, true )
    call SetUnitAnimation( caster, "spell" )
    call TriggerSleepAction( 1.00 )
    call ResetUnitAnimation( caster )
    call SetUnitInvulnerable( caster, false )
    call PauseUnit( caster, false )
    set caster = null
endfunction

//===========================================================================
function InitTrig_Kogasa03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Kogasa03 Learn
//===========================================================================
function Trig_Kogasa03_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A0C8'
endfunction

function Trig_Kogasa03_Learn_Actions takes nothing returns nothing
    if GetUnitAbilityLevel(GetTriggerUnit(),'A0LT') == 0 then
        call UnitAddAbility(GetTriggerUnit(),'A0LT')
    endif
    call SetUnitAbilityLevel(GetTriggerUnit(),'A0LT',GetUnitAbilityLevel(GetTriggerUnit(),'A0C8'))
endfunction

//===========================================================================
function InitTrig_Kogasa03_Learn takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Kogasa04 Check
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Kogasa04_Check_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0C7'
endfunction

function Trig_Kogasa04_Check takes unit caster returns boolean
    local player w = GetOwningPlayer(caster)
    local unit h
    local integer i
    set i = 0
    loop
        exitwhen i>=12
        set h = udg_PlayerHeroes[i]
        if h!= null and IsUnitAlive(h) and IsUnitEnemy(h,w) then
            if IsUnitVisible(caster,GetOwningPlayer(h)) and IsUnitInRange(caster,h,600.0) then
                set w = null
                set h = null
                return false
            endif
        endif
        set i = i + 1
    endloop
    set w = null
    set h = null
    return true
endfunction

function Trig_Kogasa04_Check_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer d = GetUnitCurrentOrder(caster)
    //local real ox = LoadReal(udg_ht,task,0)
    //local real oy = LoadReal(udg_ht,task,1)
    //local real dx = GetUnitX(caster) - ox
    //local real dy = GetUnitY(caster) - oy
    //local boolean k = SquareRoot(dx*dx + dy*dy) <= 1.0
    local boolean k = (d==OrderId("windwalk"))
    set k = k or (d>=0xD0004 and d<=0xD0008)
    set k = k or (d==0xD0019)
    set k = k or (d==0)
    //========
    if GetUnitAbilityLevel(caster,'B02K')>0 and IsUnitAlive(caster) and k then
        call TimerStart(t,0.05,false,function Trig_Kogasa04_Check_Main)
    else
        call UnitRemoveAbility(caster,'B02K')
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        call DebugMsg("小伞04取消")
    endif
    //========
    set t = null
    set caster = null
endfunction

function Trig_Kogasa04_Check_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    set udg_SK_Kogasa04_Stun = Trig_Kogasa04_Check(caster)
    if udg_SK_Kogasa04_Stun then
        call DebugMsg("true")
    else
        call DebugMsg("false")
    endif
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveReal(udg_ht,task,0,ox)
    call SaveReal(udg_ht,task,1,oy)
    call TimerStart(t,0.5,false,function Trig_Kogasa04_Check_Main)
    //========
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Kogasa04_Check takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Kogasa04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Kogasa04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0C7'
endfunction

function Trig_Kogasa04_Target takes nothing returns boolean
    return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)
endfunction

function Trig_Kogasa04_End takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local effect e = LoadEffectHandle(udg_ht,task,2)
    //========
    call DestroyEffect(e)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    //========
    set t = null
    set caster = null
    set target = null
    set e = null
endfunction

function Trig_Kogasa04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u
    local effect e
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = LoadInteger(udg_ht,task,0)
    local boolean o = false
    local boolean k = udg_SK_Kogasa04_Stun
    local group g
    local boolexpr f
    //========
    if IsUnitAlive(caster) and GetUnitAbilityLevel(caster,'B02K')>0 then
        
        set g = CreateGroup()
        set f = Filter(function Trig_Kogasa04_Target)
        call GroupEnumUnitsInRange(g,ox,oy,450.0,f)
        loop
            set u = FirstOfGroup(g)
            exitwhen u == null
            call GroupRemoveUnit(g,u)
            if IsUnitEnemy(u,GetOwningPlayer(caster)) and IsUnitVisible(u,GetOwningPlayer(caster)) then
                set o = true
            endif
            exitwhen o
        endloop
        call DestroyBoolExpr(f)
        call DestroyGroup(g)
        
        if o then
            
            call DisableTrigger(gg_trg_Kogasa04_Cancel)
            call UnitRemoveAbility(caster,'B02K')
            call ResetUnitAnimation(caster)
            call IssuePointOrder(caster,"attack",GetUnitX(u),GetUnitY(u))
            set e = AddSpecialEffectTarget("Abilities\\Spells\\Other\\TalkToMe\\TalkToMe.mdl",u,"overhead")
            call CastSpell(caster,"哇噢!!!")
            call SaveUnitHandle(udg_ht,task,1,u)
            call SaveEffectHandle(udg_ht,task,2,e)
            
            if k then
                set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,0)
                call UnitAddAbility(u,'A0C9')
                call SetUnitAbilityLevel(u,'A0C9',level)
                call IssueImmediateOrder(u,"stomp")
                call SetUnitAbilityLevel(caster,'A0SH',GetUnitAbilityLevel(caster,'A0SH')+1)
                call SetUnitAbilityLevel(caster,'A0SG',GetUnitAbilityLevel(caster,'A0SG')+1)                  
            endif
            
            call TimerStart(t,4.0,false,function Trig_Kogasa04_End)
            
        endif
        
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set e = null
    set u = null
    set g = null
    set f = null
endfunction


function Trig_Kogasa04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0C7')
    local timer t
    //========
    local real abilitycooldownlv01 = 20
    local real abilitycooldownlv02 = 16
    local real abilitycooldownlv03 = 12
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    call SetUnitAnimation(caster,"spell slam")
    call IssueImmediateOrder(caster,"holdposition")
    call EnableTrigger(gg_trg_Kogasa04_Cancel)
    
    call TriggerSleepAction(4.0 - 1.0*level)
    
    if GetUnitAbilityLevel(caster,'B02K')>0 then
        set t = CreateTimer()
        call SaveUnitHandle(udg_ht,GetHandleId(t),0,caster)
        call SaveInteger(udg_ht,GetHandleId(t),0,level)
        call TimerStart(t,0.2,true,function Trig_Kogasa04_Main)
    endif
    
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Kogasa04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Kogasa04 Cancel
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Kogasa04_Cancel_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    call UnitRemoveAbility(caster,'B02K')
    call DisableTrigger(gg_trg_Kogasa04_Cancel)
    set caster = null
endfunction

//===========================================================================
function InitTrig_Kogasa04_Cancel takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Umbrella
//===========================================================================
//TESH.scrollpos=12
//TESH.alwaysfold=0
function Trig_Initial_Umbrella_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E00X')
    local integer i
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_KogasaDS = CreateTrigger()
    call TriggerRegisterPlayerEvent( gg_trg_KogasaDS, GetOwningPlayer(h), EVENT_PLAYER_END_CINEMATIC)
    call TriggerAddCondition( gg_trg_KogasaDS, Condition( function Trig_KogasaDS_Conditions ) )
    call TriggerAddAction( gg_trg_KogasaDS, function Trig_KogasaDS_Actions )

    set gg_trg_Kogasa01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kogasa01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Kogasa01, Condition( function Trig_Kogasa01_Conditions ) )
    call TriggerAddAction( gg_trg_Kogasa01, function Trig_Kogasa01_Actions )

    set gg_trg_Kogasa02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kogasa02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Kogasa02, Condition( function Trig_Kogasa02_Conditions ) )
    call TriggerAddAction( gg_trg_Kogasa02, function Trig_Kogasa02_Actions )
    
    set gg_trg_Kogasa03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kogasa03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Kogasa03, Condition( function Trig_Kogasa03_Conditions ) )
    call TriggerAddAction( gg_trg_Kogasa03, function Trig_Kogasa03_Actions )

    set gg_trg_Kogasa03_Learn = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kogasa03_Learn, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Kogasa03_Learn, Condition( function Trig_Kogasa03_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Kogasa03_Learn, function Trig_Kogasa03_Learn_Actions )
    
    set gg_trg_Kogasa04_Check = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kogasa04_Check, h, EVENT_UNIT_SPELL_CAST )
    call TriggerAddCondition( gg_trg_Kogasa04_Check, Condition( function Trig_Kogasa04_Check_Conditions ) )
    call TriggerAddAction( gg_trg_Kogasa04_Check, function Trig_Kogasa04_Check_Actions )
    
    set gg_trg_Kogasa04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kogasa04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Kogasa04, Condition( function Trig_Kogasa04_Conditions ) )
    call TriggerAddAction( gg_trg_Kogasa04, function Trig_Kogasa04_Actions )
    
    set gg_trg_Kogasa04_Cancel = CreateTrigger()
    call DisableTrigger( gg_trg_Kogasa04_Cancel )
    call TriggerRegisterUnitEvent( gg_trg_Kogasa04_Cancel, h, EVENT_UNIT_ISSUED_TARGET_ORDER )
    call TriggerRegisterUnitEvent( gg_trg_Kogasa04_Cancel, h, EVENT_UNIT_ISSUED_POINT_ORDER )
    call TriggerAddAction( gg_trg_Kogasa04_Cancel, function Trig_Kogasa04_Cancel_Actions )
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Umbrella takes nothing returns nothing
    set gg_trg_Initial_Umbrella = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Umbrella, function Trig_Initial_Umbrella_Actions )
endfunction

//===========================================================================
// Trigger: Remilia01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Remilia01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0CD'
endfunction

function Trig_Remilia01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local group m = LoadGroupHandle(udg_ht,task,2)
    local group g
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local real px 
    local real py 
    local real a = LoadReal(udg_ht,task,0)
    local real d = LoadReal(udg_ht,task,1)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local boolean k = false
    //========
    if i>0 then
        set px = ox + d*Cos(a)
        set py = oy + d*Sin(a)
        if IsTerrainPathable(px,py,PATHING_TYPE_FLYABILITY)==false then
            call SetUnitX(u,px)
            call SetUnitY(u,py)
            call SaveInteger(udg_ht,task,1,i - 1)
        else
            call SaveInteger(udg_ht,task,1,0)
        endif
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,px,py,90.0,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitAliveBJ(v) and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and IsUnitInGroup(v,m)==false then
                call GroupAddUnit(m,v)//伤害过的单位增加到单位组 
                call UnitDamageTarget(caster,v,20+level*45,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
                if IsUnitType(v,UNIT_TYPE_HERO) then
                    call UnitDamageTarget(caster,v,20+level*45,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS )
                    set k = true
                endif
            endif
        endloop
        call DestroyGroup(g)
        if k then
            call KillUnit(u)
            call SaveInteger(udg_ht,task,1,0)
        endif
    else
        if IsUnitAliveBJ(u) then
            call RemoveUnit(u)
        endif
        call DestroyTimer(t)
        call DestroyGroup(m)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set m = null
    set g = null
    set iff = null
endfunction

function Trig_Remilia01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = Atan2(ty-oy,tx-ox)
    local integer level = GetUnitAbilityLevel(caster,'A0CD')
    local group m = CreateGroup()//已经伤害过的单位保存于此 
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 8
    local real abilitycooldownlv02 = 8
    local real abilitycooldownlv03 = 8
    local real abilitycooldownlv04 = 8
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    
    set u = CreateUnit(GetOwningPlayer(caster),'n029',ox,oy,bj_RADTODEG*a)
    
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveGroupHandle(udg_ht,task,2,m)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,84)//射程：84*24.0 = 2016
    call SaveReal(udg_ht,task,0,a)
    call SaveReal(udg_ht,task,1,24.0)
    call TimerStart(t,0.02,true,function Trig_Remilia01_Main)
    
    set caster = null
    set u = null
    set m = null 
    set t = null
endfunction

function InitTrig_Remilia01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Remilia02
//===========================================================================
//TESH.scrollpos=158
//TESH.alwaysfold=0
function Trig_Remilia02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0CG'
endfunction

function Trig_Remilia02_BatDeath takes nothing returns nothing
local unit u = GetTriggerUnit()
local unit killer = GetKillingUnit()
local group grp = LoadGroupHandle(udg_Hashtable,GetHandleId(u)+S2I("remilia02"),0)
local unit caster = LoadUnitHandle(udg_Hashtable,GetHandleId(u)+S2I("remilia02"),1)
local real x = GetUnitX(u)
local real y = GetUnitY(u)
call GroupRemoveUnit(grp,u)
call FlushChildHashtable(udg_Hashtable,GetHandleId(u)+S2I("remilia02"))
call DestroyEffect(AddSpecialEffect("BatAppear.mdx",GetUnitX(u),GetUnitY(u)))
call RemoveUnit(u)
if CountUnitsInGroup(grp) == 0 then
call SetUnitState(caster,UNIT_STATE_LIFE,5)
//call ShowUnit(caster,true)
call SetUnitPosition(caster,x,y)
call PauseUnit(caster,false)
call SetUnitInvulnerable(caster,false)
call InstantKill(killer,caster)//change      ==========================================
endif
set u = null
set grp = null
set caster = null
set killer = null
endfunction

function Trig_Remilia02_Loop takes nothing returns nothing
local timer t = GetExpiredTimer()
local integer task = GetHandleId(t)
local unit caster = LoadUnitHandle(udg_Hashtable,task,8)
local integer count =  LoadInteger(udg_Hashtable,task,9)
local integer time = LoadInteger(udg_Hashtable,task,10)
local group grp = LoadGroupHandle(udg_Hashtable,task,11)
local trigger trg = LoadTriggerHandle(udg_Hashtable,task,12)
local triggeraction tga = LoadTriggerActionHandle(udg_Hashtable,task,13)
local unit u
local unit birth=null
local real x
local real y
//创建部分
    if count>=5 and count <=11then
        set u = LoadUnitHandle(udg_Hashtable,task,count-4)
        call DestroyEffect(AddSpecialEffect("Bat-2.mdx",GetUnitX(u),GetUnitY(u)))
    endif
    //关闭4技能用 放在前面会导致变身没声音
    if count==2 then
        if GetUnitAbilityLevel(caster,'B02O') > 0 then 
            call IssueImmediateOrder(caster,"unimmolation")
            call UnitRemoveAbility(caster,'B02O')
        endif
        call IssueImmediateOrder(caster,"stop")
        call PauseUnit(caster,true)
    endif
    
    if count>=10 and count <=16then
        set u = LoadUnitHandle(udg_Hashtable,task,count-9)
        call ShowUnit(u,true)
        //call SelectGroupForPlayerBJ(grp,GetOwningPlayer(caster))
        if GetLocalPlayer() == GetOwningPlayer(caster) then
        call SelectUnit( u, true )
        endif
        call IssueImmediateOrder(u,"windwalk")
        call DestroyEffect(AddSpecialEffect("BatAppear.mdx",GetUnitX(u),GetUnitY(u)))
    endif
    call SaveInteger(udg_Hashtable,task,9,count+1)

//Timer检查部分
if time>0 then
    call SaveInteger(udg_Hashtable,task,10,time-1)
else
//到期
    //关闭触发
    call TriggerRemoveAction(trg,tga)
    call DestroyTrigger(trg)
    //最高血量出现
    if CountUnitsInGroup(grp) != 0 then
        loop
        set u = FirstOfGroup(grp)
        exitwhen u == null
        if birth == null then
            set birth = u
            set x = GetUnitX(birth)
            set y = GetUnitY(birth)
        elseif GetUnitState(birth,UNIT_STATE_LIFE) < GetUnitState(u,UNIT_STATE_LIFE) then
            set birth = u
            set x = GetUnitX(birth)
            set y = GetUnitY(birth)
        endif
        call GroupRemoveUnit(grp,u)
        call FlushChildHashtable(udg_Hashtable,GetHandleId(u)+S2I("remilia02"))
        call ShowUnit(u,false)
        call KillUnit(u)
        call RemoveUnit(u)
        call DestroyEffect(AddSpecialEffect("BatAppear.mdx",GetUnitX(u),GetUnitY(u)))
        endloop
        call SetUnitPosition( caster, x, y )
        call ShowUnit(caster,true)
        call PauseUnit(caster,false)
        call SetUnitInvulnerable(caster,false)
        call SelectUnitForPlayerSingle(caster,GetOwningPlayer(caster))
    endif
    call GroupClear(grp)
    call DestroyGroup(grp)
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_Hashtable,task)
endif

set t = null
set caster = null
set u = null
set grp = null
set birth = null
set trg = null
set tga = null
endfunction

function Trig_Remilia02_Actions takes nothing returns nothing
local unit caster = GetTriggerUnit()
local timer t = CreateTimer()
local integer task = GetHandleId(t)
local group grp = CreateGroup()
local trigger trg = CreateTrigger()
local triggeraction tga = TriggerAddAction(trg,function Trig_Remilia02_BatDeath)
local unit bat
local integer i
local integer level = GetUnitAbilityLevel(caster,'A0CG')
local integer uid
local integer time
    //========
    local real abilitycooldownlv01 = 24
    local real abilitycooldownlv02 = 24
    local real abilitycooldownlv03 = 24
    local real abilitycooldownlv04 = 24
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
//等级设置
if level == 1 then
set uid = 'u00F'
set time = 7
elseif level == 2 then
set uid = 'u00G'
set time = 9
elseif level == 3 then
set uid = 'u00H'
set time = 10
elseif level == 4 then
set uid = 'u00I'
set time = 13
endif
//创建BAT===========
set i = 7
loop
exitwhen i==0
set bat = CreateUnit(GetOwningPlayer(caster),uid,GetUnitX(caster)+150*Cos(bj_DEGTORAD*i*52),GetUnitY(caster)+150*Sin(bj_DEGTORAD*i*52),0) 
call SaveUnitHandle(udg_Hashtable,task,i,bat)
call GroupAddUnit(grp,bat)
call ShowUnit(bat,false)
call TriggerRegisterUnitEvent(trg,bat,EVENT_UNIT_DEATH)
call SaveGroupHandle(udg_Hashtable,GetHandleId(bat)+S2I("remilia02"),0,grp)
call SaveUnitHandle(udg_Hashtable,GetHandleId(bat)+S2I("remilia02"),1,caster)
set i = i-1
endloop
//==================
call ShowUnit(caster,false)
call SetUnitInvulnerable(caster,true)
call DestroyEffect(AddSpecialEffect("Bat-1.mdx",GetUnitX(caster)+30,GetUnitY(caster)-30))
call DestroyEffect(AddSpecialEffect("Bat-1.mdx",GetUnitX(caster)-30,GetUnitY(caster)+30))
call DestroyEffect(AddSpecialEffect("Bat-1.mdx",GetUnitX(caster),GetUnitY(caster)))
//=================

call SaveTimerHandle(udg_Hashtable,task,0,t)
call SaveUnitHandle(udg_Hashtable,task,8,caster)
call SaveInteger(udg_Hashtable,task,9,0)
call SaveInteger(udg_Hashtable,task,10,time*10)//持续时长
call SaveGroupHandle(udg_Hashtable,task,11,grp)
call SaveTriggerHandle(udg_Hashtable,task,12,trg)
call SaveTriggerActionHandle(udg_Hashtable,task,13,tga)
call TimerStart(t,0.1,true,function Trig_Remilia02_Loop)

set caster = null
set t = null
set grp = null
set trg = null
set tga =null
set bat = null
endfunction

//===========================================================================
function InitTrig_Remilia02 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Remilia03
//===========================================================================
//TESH.scrollpos=75
//TESH.alwaysfold=0
function Trig_Remilia03_Conditions takes nothing returns boolean
    local unit u = GetTriggerUnit()
    if ( not ( GetLearnedSkill() == 'A0CH' ) ) then//技能ID
        set u = null
        return false
    endif
    if IsUnitIllusion(u) then//幻象不注册事件 
        set u = null
        return false
    endif
    set u = null 
    return true
endfunction

function Remilia03_Main takes nothing returns nothing //吸血动作
    local real damage = GetEventDamage() //受的伤害 
    local unit attacker = GetEventDamageSource()  //攻击单位 
    local player PLY1 = GetOwningPlayer(attacker) //攻击单位的玩家 
    local unit caster = udg_PlayerHeroes[GetPlayerId(PLY1)]//伤害单位的玩家的英雄 
    local integer level =  GetUnitAbilityLevel(caster,'A0CH')// 吸血单位吸血技能等级
    if level > 0 and IsUnitGiant(GetEventDamageSource()) == false then // 吸血单位吸血技能等级判断是否吸血 
        call SetUnitState( caster, UNIT_STATE_LIFE, GetUnitState(caster , UNIT_STATE_LIFE) + damage*(0.04+0.04*level) )//加血 
    endif
    set caster = null
    set attacker = null
    set PLY1 = null
endfunction

function Remilia03_Death takes nothing returns nothing //销毁触发以及销毁触发的触发 
    local trigger death = GetTriggeringTrigger()  //销毁触发的触发
    local integer task = GetHandleId(death) //索引 
    local trigger trg = LoadTriggerHandle( udg_Hashtable,task,1)
    local triggeraction tga = LoadTriggerActionHandle( udg_Hashtable,task,2)
    local triggeraction deathtga = LoadTriggerActionHandle( udg_Hashtable,task,3)
    call TriggerRemoveAction(trg,tga)
    call TriggerRemoveAction(death,deathtga)
    call DestroyTrigger(trg)
    call DestroyTrigger(death)
    set trg = null
    set tga = null
    set death = null
    set deathtga= null
endfunction

function Trig_Remilia03_Reg takes nothing returns nothing //选取单位注册事件和销毁事件的事件。。。 
    local unit u = GetEnumUnit() //选取的单位 
    local trigger trg = CreateTrigger() //建立触发 
    local trigger death
    local triggeraction tga
    local triggeraction deathtga
    local integer task
    
    call TriggerRegisterUnitEvent(trg,u,EVENT_UNIT_DAMAGED) //单位受伤害事件 
    set tga = TriggerAddAction( trg, function Remilia03_Main ) //吸血动作
    
    if not (IsUnitType(u,UNIT_TYPE_HERO) and not IsUnitIllusion(u)) then//英雄死亡不销毁（幻影要销毁） 
        set death =  CreateTrigger()  //单位死亡销毁用触发
        set task = GetHandleId(death) //索引 
        call TriggerRegisterUnitEvent(death,u,EVENT_UNIT_DEATH) //单位死亡事件
        set deathtga = TriggerAddAction( death, function Remilia03_Death ) //销毁动作
    
        call SaveTriggerHandle( udg_Hashtable,task,1,trg)
        call SaveTriggerActionHandle( udg_Hashtable,task,2,tga)
        call SaveTriggerActionHandle( udg_Hashtable,task,3,deathtga)
    endif
    
    set u = null
    set trg = null
    set death = null
    set tga = null
    set deathtga = null
endfunction

function Trig_Remilia03_Reg2 takes nothing returns nothing //进入区域单位注册事件和销毁事件的事件。。。
    local unit u = GetTriggerUnit() //触发的单位 
    local trigger trg = CreateTrigger() //建立触发 
    local trigger death
    local triggeraction tga
    local triggeraction deathtga
    local integer task
    
    call TriggerRegisterUnitEvent(trg,u,EVENT_UNIT_DAMAGED) //单位受伤害事件 
    set tga = TriggerAddAction( trg, function Remilia03_Main ) //吸血动作
    
    if not (IsUnitType(u,UNIT_TYPE_HERO) and not IsUnitIllusion(u)) then//英雄死亡不销毁（幻影要销毁）
        set death =  CreateTrigger()  //单位死亡销毁用触发
        set task = GetHandleId(death) //索引 
        call TriggerRegisterUnitEvent(death,u,EVENT_UNIT_DEATH) //单位死亡事件
        set deathtga = TriggerAddAction( death, function Remilia03_Death ) //销毁动作
    
        call SaveTriggerHandle( udg_Hashtable,task,1,trg)
        call SaveTriggerActionHandle( udg_Hashtable,task,2,tga)
        call SaveTriggerActionHandle( udg_Hashtable,task,3,deathtga)
    endif
    
    set u = null
    set trg = null
    set death = null
    set tga = null
    set deathtga = null
endfunction

function Remilia03_Enum_Condition takes nothing returns boolean//判断选取单位是否死亡 
    local unit u = GetFilterUnit()
    if IsUnitType(u,UNIT_TYPE_DEAD) then
        set u = null
        return false
    endif
    set u = null
    return true
endfunction

function Trig_Remilia03_Start_Actions takes nothing returns nothing
    local group grp = CreateGroup() 
    local rect r = GetWorldBounds() //可用地形区域 
    local unit caster = GetTriggerUnit()  //蕾米利亚
    local integer level = GetUnitAbilityLevel(caster,'A0CH')//技能等级 
    local trigger trg //单位进入区域的触发 
    local region rectRegion //可用完整地图区域 
    if level == 1 then //只注册1次 
        set trg = CreateTrigger() //单位进入区域的触发
        set rectRegion = CreateRegion()//可用完整地图区域
        call RegionAddRect(rectRegion, r)
        call TriggerRegisterEnterRegion(trg, rectRegion, null) //进入区域单位注册事件 
        call TriggerAddAction(trg, function Trig_Remilia03_Reg2)//单位注册事件 
    
        call GroupEnumUnitsInRect(grp, r, Condition(function Remilia03_Enum_Condition))//选取全地图活着的单位注册事件
        call ForGroup( grp , function Trig_Remilia03_Reg )//注册
        call RemoveRect(r)//删除Rect 
        call DestroyGroup(grp)//删除单位组 
    endif
    set grp = null
    set r = null
    set caster = null
    set trg = null
    set rectRegion = null
endfunction

//===========================================================================
function InitTrig_Remilia03 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Remilia04
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Remilia04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0CI'
endfunction

function Remilia04_Timer_out takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,1)
    local real damage = LoadReal(udg_Hashtable,task,3)
    local group g
    local boolexpr iff
    local unit v
    set g = CreateGroup()
    set iff = GetPlayerFilter(GetOwningPlayer(caster))
    call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),350,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
            call UnitDamageTarget(caster,v,damage*0.10,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
        endif
    endloop
    call DestroyGroup(g)
    if GetUnitAbilityLevel(caster,'B02O')<=0 then
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,task)
    endif
    set t = null
    set caster = null
    set g = null
    set iff = null
    set v = null
endfunction

function Trig_Remilia04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer level = GetUnitAbilityLevel(caster,'A0CI')
    local real damage
    if level == 1 then
        set damage = 100
    elseif level == 2 then
        set damage = 170
    else
        set damage = 240
    endif
    call SaveUnitHandle(udg_Hashtable,task,1,caster)
    call SaveTimerHandle(udg_Hashtable,task,2,t)
    call SaveReal(udg_Hashtable,task,3,damage)
    call TimerStart(t,0.1,true,function Remilia04_Timer_out)
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Remilia04 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Initial Remilia
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Remilia_Actions takes nothing returns nothing
    local trigger gg_trg_Remilia02_Damage

call DebugMsg("蕾米莉亚技能加载完毕")
//=====================================  1  ===========================================================
    set gg_trg_Remilia01 = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Remilia01, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Remilia01, Condition( function Trig_Remilia01_Conditions ) )
    call TriggerAddAction( gg_trg_Remilia01, function Trig_Remilia01_Actions )

//=====================================  2  ===========================================================

    set gg_trg_Remilia02 = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Remilia02, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Remilia02, Condition( function Trig_Remilia02_Conditions ) )
    call TriggerAddAction( gg_trg_Remilia02, function Trig_Remilia02_Actions )
    
//=====================================  3  ===========================================================

    set gg_trg_Remilia03 = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Remilia03, EVENT_PLAYER_HERO_SKILL ) //学习技能注册 
    call TriggerAddCondition( gg_trg_Remilia03, Condition( function Trig_Remilia03_Conditions ) )
    call TriggerAddAction( gg_trg_Remilia03, function Trig_Remilia03_Start_Actions )

//=====================================  4  ===========================================================

    set gg_trg_Remilia04 = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Remilia04, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Remilia04, Condition( function Trig_Remilia04_Conditions ) )
    call TriggerAddAction( gg_trg_Remilia04, function Trig_Remilia04_Actions )

//=====================================================================================================
endfunction

//===========================================================================
function InitTrig_Initial_Remilia takes nothing returns nothing
    set gg_trg_Initial_Remilia = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Remilia, function Trig_Initial_Remilia_Actions )
endfunction

//===========================================================================
// Trigger: Komachi01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Komachi01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0CK'
endfunction

function Trig_Komachi01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local real ox
    local real oy
    local real px
    local real py
    local effect e1
    local effect e2
    local real angle
    //========
    local real abilitycooldownlv01 = 20
    local real abilitycooldownlv02 = 18
    local real abilitycooldownlv03 = 16
    local real abilitycooldownlv04 = 14
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set e1 = null
            set e2 = null
            return
        endif
    endif
    //======== 
    
    set e1 = AddSpecialEffectTarget("Abilities\\Spells\\Items\\OrbCorruption\\OrbCorruptionMissile.mdl",caster,"overhead")
    set e2 = AddSpecialEffectTarget("Abilities\\Spells\\Items\\OrbCorruption\\OrbCorruptionMissile.mdl",target,"overhead")
    
    call TriggerSleepAction(2.0)
      
    if IsUnitInRange(caster,target,3600.0) and not(IsUnitType(caster,UNIT_TYPE_DEAD) or IsUnitType(target,UNIT_TYPE_DEAD)) and GetUnitFlag(target,CS_YUUGI())==false then
        set ox = GetUnitX(caster)
        set oy = GetUnitY(caster)
        set px = GetUnitX(target)
        set py = GetUnitY(target)
        call SetUnitX(caster,px)
        call SetUnitY(caster,py)
        call SetUnitPosition( target, ox, oy )
        set angle = bj_RADTODEG * Atan2(oy - py, ox - px)
        call SetUnitFacing(caster,angle)
    endif
    
    call DestroyEffect(e1)
    call DestroyEffect(e2)
    set e1 = AddSpecialEffectTarget("Abilities\\Spells\\Undead\\OrbOfDeath\\OrbOfDeathMissile.mdl",caster,"origin")
    set e2 = AddSpecialEffectTarget("Abilities\\Spells\\Undead\\OrbOfDeath\\OrbOfDeathMissile.mdl",target,"origin")
    call DestroyEffect(e1)
    call DestroyEffect(e2)
    set e1 = AddSpecialEffectTarget("Komachi_Change.mdl",caster,"origin")
    set e2 = AddSpecialEffectTarget("Komachi_Change.mdl",target,"origin")
    call DestroyEffect(e1)
    call DestroyEffect(e2)
    set caster = null
    set target = null
    set e1 = null
    set e2 = null
endfunction

//===========================================================================
function InitTrig_Komachi01 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Komachi03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Komachi03_LifeChange_Target takes nothing returns boolean
    return GetUnitTypeId(GetFilterUnit())=='n01G'
endfunction

function Trig_Komachi03_LifeChange takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local group g = CreateGroup() 
    local boolexpr iff = Filter(function Trig_Komachi03_LifeChange_Target)
    local unit v
    local real range
    local real anse = 0.00
    local real ox = GetUnitX(udg_SK_Komachi)
    local real oy = GetUnitY(udg_SK_Komachi)
    local real tx
    local real ty
    call GroupEnumUnitsInRange(g,ox,oy,99999,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        set tx = GetUnitX(v)
        set ty = GetUnitY(v)
        set range = SquareRoot((ox-tx)*(ox-tx)+(oy-ty)*(oy-ty))
        if range < 800.00 then
            set anse = -1.00
        elseif range < 1000.00 then
            set anse = -2.00
        elseif range < 1200.00 then
            set anse = -3.00
        elseif range < 1400.00 then
            set anse = -4.00
        elseif range < 1600.00 then
            set anse = -5.00
        else
            set anse = -6.00
        endif
        if IsUnitType(udg_SK_Komachi,UNIT_TYPE_DEAD) then
            set anse = -6.00
        endif
        call SetUnitState(v,UNIT_STATE_LIFE,GetUnitState(v,UNIT_STATE_LIFE) + anse)
    endloop
    call DestroyGroup(g)
    set t = null
    set g = null
    set iff = null
    set v = null
endfunction

function Trig_Komachi03_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A0CL'
endfunction

function Trig_Komachi03_Spirit_Remove takes nothing returns nothing
    local unit caster = LoadUnitHandle(udg_sht,GetHandleId(GetTriggeringTrigger()),0)
    local integer task = GetHandleId(caster)
    local integer x = LoadInteger(udg_sht,task,0)
    local group g = LoadGroupHandle(udg_sht,task,0)
    local unit u = GetTriggerUnit()
    call GroupRemoveUnit(g,u)
    set x = x - 1
    call SaveInteger(udg_sht,task,0,x)
    call DebugMsg("魂的总数："+I2S(x))
    set g = null
    set u = null
    set caster = null
endfunction

function Trig_Komachi03_Spirit_Conditions takes nothing returns boolean
    if IsUnitIllusion(GetTriggerUnit()) then
        return false
    endif
    if GetUnitTypeId(GetTriggerUnit())=='n01G' then
        call Trig_Komachi03_Spirit_Remove()
        return false
    endif
    if IsUnitIllusion(GetKillingUnit()) then
        return false
    endif
    return GetUnitTypeId(GetKillingUnit())=='U00J' or (GetUnitTypeId(GetKillingUnit())=='n00F' and GetUnitTypeId(GetPlayerCharacter(GetOwningPlayer(GetKillingUnit()))) == 'U00J')
endfunction

function Trig_Komachi03_Spirit_Actions takes nothing returns nothing
    local unit caster = GetPlayerCharacter(GetOwningPlayer(GetKillingUnit()))
    local unit target = GetTriggerUnit()
    local integer task = GetHandleId(caster)
    local integer level = GetUnitAbilityLevel(caster,'A0CL')
    local integer x = LoadInteger(udg_sht,task,0)
    local group g = LoadGroupHandle(udg_sht,task,0)
    local unit u
    if x < (1 + 2*level) then
        set u = CreateUnit(GetOwningPlayer(caster),'n01G',GetUnitX(target),GetUnitY(target),270.0)
        call SetUnitMoveSpeed(u,250+20*(level-1))
        call GroupAddUnit(g,u)
        set x = x + 1
        call SaveInteger(udg_sht,task,0,x)
        call DebugMsg("魂的总数："+I2S(x))
    endif
    set target = null
    set caster = null
    set g = null
    set u = null
endfunction

function Trig_Komachi03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer task = GetHandleId(caster)
    //========
    call DestroyTrigger(gg_trg_Komachi03)
    call DebugMsg("Komachi03 Init")
    //========
    call SaveInteger(udg_sht,task,0,0)
    call SaveGroupHandle(udg_sht,task,0,CreateGroup())
    //========
    set gg_trg_Komachi03 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Komachi03, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_Komachi03, Condition( function Trig_Komachi03_Spirit_Conditions ) )
    call TriggerAddAction( gg_trg_Komachi03, function Trig_Komachi03_Spirit_Actions )
    call SaveUnitHandle(udg_sht,GetHandleId(gg_trg_Komachi03),0,caster)
    //========
    set caster = null
endfunction

//===========================================================================
function InitTrig_Komachi03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Komachi04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Komachi04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0CM'
endfunction

function Komachi04_Main takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task2 = GetHandleId(trg)
    local timer t = LoadTimerHandle(udg_Hashtable,task2,1)
    local integer task = GetHandleId(t)
    local effect e = LoadEffectHandle(udg_Hashtable,task2,2)
    local triggeraction tga = LoadTriggerActionHandle(udg_Hashtable,task2,4)
    local unit caster = LoadUnitHandle(udg_Hashtable,task2,5)
    local unit target = LoadUnitHandle(udg_Hashtable,task2,6)
    local real angle
    local effect e2
    
    if GetUnitState(target,UNIT_STATE_LIFE) <= 0.5 * GetUnitState(target,UNIT_STATE_MAX_LIFE) then
        call DisableTrigger(trg)
        call PauseTimer(t)
        call DestroyTimer(t)
        
        call SetUnitPosition(target,GetUnitX(target),GetUnitY(target))
        call PauseUnit(target,true)
        
        call UnitFade(caster,false,true,0.05)
        
        call TriggerSleepAction(0.5)
        
        set angle = GetUnitFacing(target)
        call SetUnitX(caster,GetUnitX(target)+100*Cos((angle-180)* bj_DEGTORAD))
        call SetUnitY(caster,GetUnitY(target)+100*Sin((angle-180)* bj_DEGTORAD))
        set angle = bj_RADTODEG * Atan2(GetUnitY(target) - GetUnitY(caster), GetUnitX(target) - GetUnitX(caster))
        call SetUnitFacing(caster,angle)
        call UnitFade(caster,false,false,0.05)
        
        call PauseUnit(caster,true)
        call SetUnitInvulnerable(caster,true)
        call SetUnitInvulnerable(target,true)
        call SetUnitAnimation(caster,"Spell")
        call TriggerSleepAction(1.0)
        
        call SetUnitVertexColor(caster,255,255,255,255)
        
        call DestroyEffect(e)
        call SetUnitInvulnerable(caster,false)
        call PauseUnit(caster,false)
        call PauseUnit(target,false)
        if IsUnitAlive(caster) then
            call SetUnitInvulnerable(target,false)
            call UnitRemoveBuffs(target, true, true)
            call InstantKill(caster,target)
            //if IsUnitType(target,UNIT_TYPE_DEAD)==true then
            //    call SetUnitState(target, UNIT_STATE_LIFE, 0.00 )
            //endif

            set e2 = AddSpecialEffect("Objects\\Spawnmodels\\Undead\\UndeadDissipate\\UndeadDissipate.mdl",GetUnitX(target),GetUnitY(target))
            call DestroyEffect(e2)
        endif

        call SetUnitInvulnerable(target,false)
        call TriggerRemoveAction(trg,tga)
        call DisableTrigger(trg)
        call DestroyTrigger(trg)
        
        call FlushChildHashtable(udg_Hashtable,task)
        call FlushChildHashtable(udg_Hashtable,task2)
        
    endif
    
    set trg = null
    set t = null
    set e = null
    set tga = null
    set caster = null
    set target = null
    set e2 = null 
endfunction

function Komachi04_TimeOut takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local effect e = LoadEffectHandle(udg_Hashtable,task,2)
    local trigger trg = LoadTriggerHandle(udg_Hashtable,task,3)
    local triggeraction tga = LoadTriggerActionHandle(udg_Hashtable,task,4)
    local integer task2 = LoadInteger(udg_Hashtable,task,5)
    
    call DebugMsg("销毁")
    
    call DestroyEffect(e)
    call TriggerRemoveAction(trg,tga)
    call DisableTrigger(trg)
    call DestroyTrigger(trg)
    
    call PauseTimer(t)
    call DestroyTimer(t) 
    call FlushChildHashtable(udg_Hashtable,task)
    call FlushChildHashtable(udg_Hashtable,task2)
    
    set t = null
    set e = null
    set trg = null
    set tga = null
endfunction

function Trig_Komachi04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0CM')
    local effect e = AddSpecialEffectTarget("Komachi_Change.mdl",target,"origin")
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local trigger trg = CreateTrigger()
    local integer task2 = GetHandleId(trg)
    local triggeraction tga
    local real life = 0.5*GetUnitState(target,UNIT_STATE_MAX_LIFE)
    //========
    local real abilitycooldownlv01 = 75
    local real abilitycooldownlv02 = 60
    local real abilitycooldownlv03 = 45
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    if IsUnitIllusion(target) then
    call KillUnit(target)
    else
    //========
    call TriggerRegisterTimerEventPeriodic( trg, 0.10 )
    call TriggerRegisterUnitEvent( trg, target, EVENT_UNIT_DAMAGED )
    set tga = TriggerAddAction(trg,function Komachi04_Main )
    
    call SaveTimerHandle(udg_Hashtable,task,1,t)
    call SaveEffectHandle(udg_Hashtable,task,2,e)
    call SaveTriggerHandle(udg_Hashtable,task,3,trg)
    call SaveTriggerActionHandle(udg_Hashtable,task,4,tga)
    call SaveInteger(udg_Hashtable,task,5,task2)
    call TimerStart(t,20+level*5,false,function Komachi04_TimeOut)
    
    call SaveTimerHandle(udg_Hashtable,task2,1,t)
    call SaveEffectHandle(udg_Hashtable,task2,2,e)
    call SaveTriggerHandle(udg_Hashtable,task2,3,trg)
    call SaveTriggerActionHandle(udg_Hashtable,task2,4,tga)
    call SaveUnitHandle(udg_Hashtable,task2,5,caster)    
    call SaveUnitHandle(udg_Hashtable,task2,6,target)
    
    if GetUnitState(target,UNIT_STATE_LIFE) < life then
        call TriggerExecute(trg)
    endif
    //==========
    endif
    
    set caster = null
    set target = null
    set e = null
    set t = null
    set trg = null
    set tga = null
endfunction

//===========================================================================
function InitTrig_Komachi04 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: KomachiGhostExplosion
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_KomachiGhostExplosion_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0CO'
endfunction

function Trig_KomachiGhostExplosion_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit v
    local group g = CreateGroup()
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local player w = GetOwningPlayer(caster)
    local real damage
    call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),320.0,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitEnemy(v,w) and (not IsUnitType(v,UNIT_TYPE_STRUCTURE)) and (not IsUnitWard(v)) then
            set damage = 80.0 + 0.04*GetUnitState(v,UNIT_STATE_MAX_LIFE)
            call UnitDamageTarget(caster,v,damage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
        endif
    endloop
    call SetUnitExploded(caster,true)
    call KillUnit(caster)
    call DestroyGroup(g)
    set caster = null
    set w = null
    set v = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_KomachiGhostExplosion takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: KomachiALLExplosion
//
// 单位组在3技能内创建
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_KomachiALLExplosion_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0CN'
endfunction

function  Trig_KomachiALLExplosion_Start takes nothing returns nothing
    local unit u = GetEnumUnit()
    call IssueImmediateOrder(u,"stomp")
    set u = null
endfunction

function Trig_KomachiALLExplosion_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer task = GetHandleId(caster)
    local group g = LoadGroupHandle(udg_sht,task,0)
    call ForGroup(g,function Trig_KomachiALLExplosion_Start)
    set caster = null
    set g = null
endfunction

//===========================================================================
function InitTrig_KomachiALLExplosion takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Komachi
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Komachi_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('U00J')
    local timer t = CreateTimer()
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set udg_SK_Komachi = h

    set gg_trg_Komachi01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Komachi01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Komachi01, Condition( function Trig_Komachi01_Conditions ) )
    call TriggerAddAction( gg_trg_Komachi01, function Trig_Komachi01_Actions )
    
    set gg_trg_Komachi03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Komachi03, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Komachi03, Condition( function Trig_Komachi03_Conditions ) )
    call TriggerAddAction( gg_trg_Komachi03, function Trig_Komachi03_Actions )

    call TimerStart(t,1.00,true,function Trig_Komachi03_LifeChange)
    
    set gg_trg_KomachiGhostExplosion = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_KomachiGhostExplosion, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_KomachiGhostExplosion, Condition( function Trig_KomachiGhostExplosion_Conditions ) )
    call TriggerAddAction( gg_trg_KomachiGhostExplosion, function Trig_KomachiGhostExplosion_Actions )
    
    set gg_trg_KomachiALLExplosion = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_KomachiALLExplosion, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_KomachiALLExplosion, Condition( function Trig_KomachiALLExplosion_Conditions ) )
    call TriggerAddAction( gg_trg_KomachiALLExplosion, function Trig_KomachiALLExplosion_Actions )
    
    set gg_trg_Komachi04 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Komachi04, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Komachi04, Condition( function Trig_Komachi04_Conditions ) )
    call TriggerAddAction( gg_trg_Komachi04, function Trig_Komachi04_Actions )
    
    set t = null
    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Komachi takes nothing returns nothing
    set gg_trg_Initial_Komachi = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Komachi, function Trig_Initial_Komachi_Actions )
endfunction

//===========================================================================
// Trigger: Nazrin Pet
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Nazrin_Pet_Collect takes nothing returns nothing
    local integer task = GetHandleId(GetExpiredTimer())
    local item w = GetEnumItem()
    if GetItemTypeId(w)=='I03F' and GetWidgetLife(w)>0 then
        call SaveBoolean(udg_ht,task,1,true)
        call SaveItemHandle(udg_ht,task,2,w)
    endif
    set w = null
endfunction

function Trig_Nazrin_Pet_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit h = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local item w
    local rect r
    local real ox = GetUnitX(h)
    local real oy = GetUnitY(h)
    local real px
    local real py
    local real a
    local real d
    local integer i = LoadInteger(udg_ht,task,1)
    local boolean k = LoadBoolean(udg_ht,task,0)
    //========
    if IsUnitAlive(h) then
        if k then
            call ShowUnit(u,true)
            call PauseUnit(u,false)
            call SaveBoolean(udg_ht,task,0,false)
            call UnitRemoveAbility(u,'Aloc')
            call UnitAddAbility(u,'Aloc')
            call SetUnitPosition(u,ox,oy)
        endif
        if DistanceBetweenUnits(u,h) > 1200.0 then
            call SetUnitPosition(u,ox,oy)
        endif
        set w = null
        set k = false
        if udg_SK_Nazrin_Pick then
            set r = Rect(ox - 512.0,oy - 512.0,ox + 512.0,oy + 512.0)
            call SaveBoolean(udg_ht,task,1,false)
            call EnumItemsInRect(r,null,function Trig_Nazrin_Pet_Collect)
            set k = LoadBoolean(udg_ht,task,1)
            set w = LoadItemHandle(udg_ht,task,2)
            call RemoveRect(r)
        endif
        if k then
            call IssueTargetOrder(u,"smart",w)
            call SaveInteger(udg_ht,task,1,i + 5)
            call TimerStart(t,2.5,false,function Trig_Nazrin_Pet_Main)
        else
            if IsUnitInRange(u,h,250.0)==false or GetRandomReal(0.0,100.0)<15.0 then
                set a = GetRandomReal(0.0,360.0)
                set d = GetRandomReal(40.0,160.0)
                set px = ox + d*CosBJ(a)
                set py = oy + d*SinBJ(a)
                call IssuePointOrder(u,"move",px,py)
            endif
            call SaveInteger(udg_ht,task,1,i + 1)
            call TimerStart(t,0.5,false,function Trig_Nazrin_Pet_Main)
        endif
    else
        if k==false then
            call ShowUnit(u,false)
            call PauseUnit(u,true)
            call SaveBoolean(udg_ht,task,0,true)
        endif
        call SaveInteger(udg_ht,task,1,i + 2)
        call TimerStart(t,1.0,false,function Trig_Nazrin_Pet_Main)
    endif
    //========
    set t = null
    set h = null
    set u = null
    set w = null
    set r = null
endfunction

function Trig_Nazrin_Pet_Conditions takes nothing returns boolean
    if GetIssuedOrderId()==OrderId("parasiteon") then
        set udg_SK_Nazrin_Pick = true
        return false
    endif
    if GetIssuedOrderId()==OrderId("parasiteoff") then
        set udg_SK_Nazrin_Pick = false
        return false
    endif
    return false
endfunction

function Trig_Nazrin_Pet_Actions takes nothing returns nothing
endfunction

//===========================================================================
function InitTrig_Nazrin_Pet takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Nazrin01
//===========================================================================
function Trig_Nazrin01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0OO'
endfunction

function Trig_Nazrin01_Jump takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,1)
    local integer i = LoadInteger(udg_Hashtable,task,2)
    local effect e
    local real x
    local real y
    if i>0 then 
        set i = i - 1
        call SaveInteger(udg_Hashtable,task,2,i)
        set x = GetUnitX(caster)+16*Cos(GetUnitFacing(caster)*bj_DEGTORAD)
        set y = GetUnitY(caster)+16*Sin(GetUnitFacing(caster)*bj_DEGTORAD)  
        call SetUnitXYGround(caster,x,y) 
        set e = AddSpecialEffect("Abilities\\Weapons\\WingedSerpentMissile\\WingedSerpentMissile.mdl",GetUnitX(caster),GetUnitY(caster)) 
        call DestroyEffect(e) 
    else
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,task)
    endif 
    set t = null
    set caster = null
    set e = null 
endfunction

function Trig_Nazrin01_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    //========
    local real abilitycooldownlv01 = 10
    local real abilitycooldownlv02 = 8
    local real abilitycooldownlv03 = 6
    local real abilitycooldownlv04 = 4
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call SaveTimerHandle(udg_Hashtable,task,0,t)
    call SaveUnitHandle(udg_Hashtable,task,1,caster)
    call SaveInteger(udg_Hashtable,task,2,25)
    call TimerStart(t,0.02,true,function Trig_Nazrin01_Jump)
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Nazrin01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Nazrin02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Nazrin02_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0D8'
endfunction

function Trig_Nazrin02_Damage takes nothing returns nothing
    local integer task = GetHandleId(GetTriggeringTrigger())
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = GetEnteringUnit()
    local integer level = LoadInteger(udg_ht,task,0)
    if IsUnitAliveBJ(target) and IsUnitType(target,UNIT_TYPE_STRUCTURE)==false and IsUnitWard(target)==false then
        call UnitDamageTarget(caster,target,18.0 + 12.0*level,false,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,null)
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\DragonHawkMissile\\DragonHawkMissile.mdl",target,"chest"))
    endif
    set caster = null
    set target = null
endfunction

function Trig_Nazrin02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local unit u
    local real ox
    local real oy
    local real px
    local real py
    local real a = LoadReal(udg_ht,task,0)
    local real d = LoadReal(udg_ht,task,1)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local trigger trg
    local triggeraction tga
    //========
    if i>0 and IsUnitAlive(target) then
        call SaveReal(udg_ht,task,0,a + 3.6)
        call SaveInteger(udg_ht,task,1,i - 1)
        
        set ox = GetUnitX(target)
        set oy = GetUnitY(target)
        
        set u = LoadUnitHandle(udg_ht,task,4)
        set a = a + 120.0
        set px = ox + d*CosBJ(a)
        set py = oy + d*SinBJ(a)
        call SetUnitXYFly(u,px,py)
        
        set u = LoadUnitHandle(udg_ht,task,5)
        set a = a + 120.0
        set px = ox + d*CosBJ(a)
        set py = oy + d*SinBJ(a)
        call SetUnitXYFly(u,px,py)
        
        set u = LoadUnitHandle(udg_ht,task,6)
        set a = a + 120.0
        set px = ox + d*CosBJ(a)
        set py = oy + d*SinBJ(a)
        call SetUnitXYFly(u,px,py)
        
    else
        call UnitRemoveAbility(target,'A0L9')
        set trg = LoadTriggerHandle(udg_ht,task,2)
        set tga = LoadTriggerActionHandle(udg_ht,task,3)
        call TriggerRemoveAction(trg,tga)
        call DestroyTrigger(trg)
        call RemoveUnit(LoadUnitHandle(udg_ht,task,4))
        call RemoveUnit(LoadUnitHandle(udg_ht,task,5))
        call RemoveUnit(LoadUnitHandle(udg_ht,task,6))
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set caster = null
    set target = null
    set u = null
    set t = null
    set trg = null
    set tga = null
endfunction

function Trig_Nazrin02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit u
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local integer c
    local real ox = GetUnitX(target)
    local real oy = GetUnitY(target)
    local real px
    local real py
    local real a = 0.0
    local real d = 120.0
    local real s
    local real r
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local trigger trg = CreateTrigger()
    local triggeraction tga = TriggerAddAction(trg,function Trig_Nazrin02_Damage)
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 15
    local real abilitycooldownlv03 = 15
    local real abilitycooldownlv04 = 15
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    
    call UnitAddAbility(target,'A0L9')
    call UnitMakeAbilityPermanent(target,true,'A0I6')
    call UnitMakeAbilityPermanent(target,true,'A0I7')
    call UnitMakeAbilityPermanent(target,true,'A0L8')
    call UnitMakeAbilityPermanent(target,true,'A0L9')
    call SetUnitAbilityLevel(target,'A0I6',level)
    call SetUnitAbilityLevel(target,'A0I7',level)
    call SetUnitAbilityLevel(target,'A0L8',level)
    
    if caster==target then
        set c = 50*10
    else
        set c = 50*7
    endif
    
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveTriggerHandle(udg_ht,task,2,trg)
    call SaveTriggerActionHandle(udg_ht,task,3,tga)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,c)
    call SaveReal(udg_ht,task,0,a)
    call SaveReal(udg_ht,task,1,d)
    
    set s = 2.0 + 0.3*(level-1)
    set r = 85.0 + 5.0*level
    
    set a = a + 120.0
    set px = ox + d*CosBJ(a)
    set py = oy + d*SinBJ(a)
    set u = CreateUnit(GetOwningPlayer(caster),'n03L',px,py,a)
    call SetUnitScale(u,s,s,s)
    call SaveUnitHandle(udg_ht,task,4,u)
    call TriggerRegisterUnitInRange(trg,u,r,iff)
    
    set a = a + 120.0
    set px = ox + d*CosBJ(a)
    set py = oy + d*SinBJ(a)
    set u = CreateUnit(GetOwningPlayer(caster),'n03L',px,py,a)
    call SetUnitScale(u,s,s,s)
    call SaveUnitHandle(udg_ht,task,5,u)
    call TriggerRegisterUnitInRange(trg,u,r,iff)
    
    set a = a + 120.0
    set px = ox + d*CosBJ(a)
    set py = oy + d*SinBJ(a)
    set u = CreateUnit(GetOwningPlayer(caster),'n03L',px,py,a)
    call SetUnitScale(u,s,s,s)
    call SaveUnitHandle(udg_ht,task,6,u)
    call TriggerRegisterUnitInRange(trg,u,r,iff)
    
    call TimerStart(t,0.02,true,function Trig_Nazrin02_Main)
    
    set task = GetHandleId(trg)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,0,level)
    
    //========
    set caster = null
    set target = null
    set u = null
    set t = null
    set iff = null
    set trg = null
    set tga = null
endfunction

//===========================================================================
function InitTrig_Nazrin02 takes nothing returns nothing
    set gg_trg_Nazrin02 = CreateTrigger()
    call TriggerAddAction( gg_trg_Nazrin02, function Trig_Nazrin02_Actions )
endfunction
//===========================================================================
// Trigger: Nazrin03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Nazrin03_Conditions takes nothing returns boolean
    if GetUnitTypeId(GetAttacker())!='U00K' then
        return false
    endif
    if IsUnitIllusion(GetAttacker()) then
        return false
    endif
    return GetRandomInt(0,100)<= 8 + 8*GetUnitAbilityLevel(GetAttacker(),'A0D7')
endfunction

function Trig_Nazrin03_Sync takes unit h,unit u returns nothing
    local item v
    local item w
    local integer i
    local integer d
    call SetHeroLevel(u,GetHeroLevel(h),false)
    call SetHeroStr(u,GetHeroStr(h,false),true)
    call SetHeroAgi(u,GetHeroAgi(h,false),true)
    call SetHeroInt(u,GetHeroInt(h,false),true)
    call SetUnitAbilityLevel(u,'A03Y',GetUnitAbilityLevel(h,'A03Y'))
    set i = 0
    loop
        exitwhen i>=bj_MAX_INVENTORY
        set w = UnitItemInSlot(u,i)
        set v = UnitItemInSlot(h,i)
        if w==null then
            if v!=null then
                set w = CreateItem(GetItemTypeId(v),GetUnitX(u),GetUnitY(u))
                call UnitAddItem(u,w)
            endif
        else
            if v==null then
                call UnitRemoveItem(u,w)
                call RemoveItem(w)
            else
                set d = GetItemTypeId(v)
                if d!=GetItemTypeId(w) then
                    call UnitRemoveItem(u,w)
                    call RemoveItem(w)
                    set w = CreateItem(d,GetUnitX(u),GetUnitY(u))
                    call UnitAddItem(u,w)
                endif
            endif
        endif
        set i = i + 1
    endloop
    set v = null
    set w = null
endfunction

function Trig_Nazrin03_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local unit u = LoadUnitHandle(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i==0 and IsUnitAliveBJ(target) and IsUnitAlive(caster) then
        call SetUnitX(u,GetUnitX(caster))
        call SetUnitY(u,GetUnitY(caster))
        call PauseUnit(u,false)
        call IssueTargetOrderById(u,0x0D0011,target)
        call SaveInteger(udg_ht,task,1,2)
        call TimerStart(t,0.5,false,function Trig_Nazrin03_Main)
    else
        call ShowUnit(u,false)
        call PauseUnit(u,true)
        call SetUnitPositionLoc(u,udg_BackStage)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        call EnableTrigger(gg_trg_Nazrin03)
    endif
    //========
    set caster = null
    set target = null
    set u = null
    set t = null
endfunction

function Trig_Nazrin03_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local unit u = LoadUnitHandle(udg_sht,GetHandleId(caster),0)
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    call DisableTrigger(gg_trg_Nazrin03)
    call ShowUnit(u,true)
    call UnitRemoveAbility(u,'Aloc')
    call UnitAddAbility(u,'Aloc')
    call SetUnitFacing(u,GetUnitFacing(caster))
    call Trig_Nazrin03_Sync(caster,u)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveUnitHandle(udg_ht,task,2,u)
    call SaveInteger(udg_ht,task,1,0)
    call TimerStart(t,0.1,false,function Trig_Nazrin03_Main)
    //========
    set caster = null
    set target = null
    set u = null
    set t = null
endfunction

function Trig_Nazrin03_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A0D7'
endfunction

function Trig_Nazrin03_Learn_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    
    call DestroyTrigger(gg_trg_Nazrin03)
    set gg_trg_Nazrin03 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Nazrin03, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Nazrin03, Condition( function Trig_Nazrin03_Conditions ) )
    call TriggerAddAction( gg_trg_Nazrin03, function Trig_Nazrin03_Actions )
    
    set u = CreateUnitAtLoc(GetOwningPlayer(caster),'U00R',udg_BackStage,0.0)
    call ShowUnit(u,false)
    call PauseUnit(u,true)
    call SaveUnitHandle(udg_sht,GetHandleId(caster),0,u)
    set udg_SK_Nazirin = u
    
    call DebugMsg("Nazrin03")
    
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Nazrin03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Nazrin04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Nazrin04_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetSummonedUnit()) == 'o00M'
endfunction

function Trig_Nazrin04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local player w = GetOwningPlayer(caster)
    local integer level = GetUnitAbilityLevel(u,'A0D6')
    local integer n = LoadInteger(udg_ht,task,0)
    local integer c = LoadInteger(udg_ht,task,1)
    local real ox
    local real oy
    local real oz
    local real x0
    local real y0
    local real z0
    local real x1
    local real y1
    local real z1
    local real r = 1500.0 + 500.0*level
    local real a
    local real q = LoadReal(udg_ht,task,0)
    local group g
    local boolexpr iff = GetPlayerFilter(w)
    local lightning e
    local integer i
    local boolean k
    //========
    set i = 0
    loop
        exitwhen i>=64
        set e = udg_SK_Nazrin04_Lightning[i]
        exitwhen e==null
        call DestroyLightning(e)
        set udg_SK_Nazrin04_Lightning[i] = null
        set i = i + 1
    endloop
    //========
    if IsUnitAliveBJ(u) then
        set ox = GetUnitX(u)
        set oy = GetUnitY(u)
        set oz = GetPositionZ(ox,oy)
        set i = 0
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,ox,oy,r,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitAliveBJ(v) and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
                if GetOwningPlayer(v)!=Player(PLAYER_NEUTRAL_AGGRESSIVE) and IsUnitVisible(v,w)==false then
                    set x0 = ox
                    set y0 = oy
                    set z0 = oz + 60.0
                    set x1 = GetUnitX(v)
                    set y1 = GetUnitY(v)
                    set z1 = GetPositionZ(x1,y1) + 30.0
                    set e = AddLightningEx("GREL",false,x0,y0,z0,x1,y1,z1)
                    set a = 0.8 - 0.5*RMaxBJ(DistanceBetweenUnits(u,v),1200.0)/r
                    if IsUnitAlly(caster,GetLocalPlayer()) then                        
                        if IsUnitType(v,UNIT_TYPE_HERO) then
                            call SetLightningColor(e,1.0,1.0,0.0,a)
                        else
                            call SetLightningColor(e,1.0,1.0,1.0,a)
                        endif
                    else
                        call SetLightningColor(e,0.0,0.0,0.0,0.0)
                    endif
                    set udg_SK_Nazrin04_Lightning[i] = e
                    set i = i + 1
                    exitwhen i>=64
                endif
            endif
        endloop
        if c==0 then
            if i>n then
                call SaveInteger(udg_ht,task,1,100)
                if GetLocalPlayer()==w then
                    call PingMinimapEx(ox,oy,3.0,255,96,0,true)
                endif
            endif
            call SaveInteger(udg_ht,task,0,i)
        else
            call SaveInteger(udg_ht,task,1,c - 1)
        endif
        call DestroyGroup(g)
        if udg_SK_Nazrin04_Lightning[64]==null then
            set i = 0
            loop
                exitwhen i>=64
                set e = AddLightningEx("GREL",false,ox,oy,oz,ox,oy,oz+300.0)
                call SetLightningColor(e,0.0,0.0,0.0,0.0)
                set udg_SK_Nazrin04_Lightning[64+i] = e
                set i = i + 1
            endloop
        else
            set k = udg_SK_Nazrin04_ON and IsUnitAlly(caster,GetLocalPlayer())
            set i = 0
            loop
                exitwhen i>=60
                set e = udg_SK_Nazrin04_Lightning[64+i]
                set a = 6.0*i + q
                set x0 = ox + 1200.0*CosBJ(a)
                set y0 = oy + 1200.0*SinBJ(a)
                set z0 = oz + 45.0
                set a = a + 3.0
                set x1 = ox + 1200.0*CosBJ(a)
                set y1 = oy + 1200.0*SinBJ(a)
                set z1 = z0
                call MoveLightningEx(e,false,x0,y0,z0,x1,y1,z1)
                if k then
                    call SetLightningColor(e,1.0,0.5,1.0,0.75)
                else
                    call SetLightningColor(e,0.0,0.0,0.0,0.0)
                endif
                set i = i + 1
            endloop
            loop
                exitwhen i>=64
                set a = (i-64)*90.0 + q
                set x0 = ox + 1200.0*CosBJ(a)
                set y0 = oy + 1200.0*SinBJ(a)
                set z0 = oz + 45.0
                set a = a + 18.0
                set x1 = ox + 1200.0*CosBJ(a)
                set y1 = oy + 1200.0*SinBJ(a)
                set z1 = z0
                set e = udg_SK_Nazrin04_Lightning[64+i]
                call MoveLightningEx(e,false,ox,oy,oz,x0,y0,z0)
                if k then
                    call SetLightningColor(e,1.0,0.5,1.0,0.33)
                else
                    call SetLightningColor(e,0.0,0.0,0.0,0.0)
                endif
                set e = udg_SK_Nazrin04_Lightning[65+i]
                call MoveLightningEx(e,false,ox,oy,oz,x1,y1,z1)
                if k then
                    call SetLightningColor(e,1.0,0.5,1.0,0.33)
                else
                    call SetLightningColor(e,0.0,0.0,0.0,0.0)
                endif
                set i = i + 2
            endloop
            call SaveReal(udg_ht,task,0,q + 0.18)
        endif
    else
        set i = 0
        loop
            exitwhen i>=64
            set e = udg_SK_Nazrin04_Lightning[64 + i]
            exitwhen e==null
            call DestroyLightning(e)
            set udg_SK_Nazrin04_Lightning[64 + i] = null
            set i = i + 1
        endloop
        set udg_SK_Nazrin04 = null
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        call DebugMsg("Nazrin04 End")
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set w = null
    set g = null
    set iff = null
    set e = null
endfunction

function Trig_Nazrin04_Actions takes nothing returns nothing
    local unit caster = GetSummoningUnit()
    local unit u = GetSummonedUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0ED')
    local integer i
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 30
    local real abilitycooldownlv02 = 30
    local real abilitycooldownlv03 = 30
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,'A0ED') == 1 then
            call Item_HeroAbilityCoolDownReset(caster,'A0ED',abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,'A0ED') == 2 then
            call Item_HeroAbilityCoolDownReset(caster,'A0ED',abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,'A0ED') == 3 then
            call Item_HeroAbilityCoolDownReset(caster,'A0ED',abilitycooldownlv03)
        endif
    endif
    //========
    if udg_SK_Nazrin04!=null then
        call RemoveUnit(udg_SK_Nazrin04)
    endif
    call TriggerSleepAction(0.5)
    //========
    set udg_SK_Nazrin04 = u
    call SetUnitAbilityLevel(u,'A0D6',level)
    call IssueImmediateOrder(u,"defend")
    call SetUnitAbilityLevel(u,'A0ON',level)
    call addlife(u,200*level)
    set i = 0
    loop
        exitwhen i>=128
        set udg_SK_Nazrin04_Lightning[i] = null
        set i = i + 1
    endloop
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,0,0)
    call SaveInteger(udg_ht,task,1,0)
    call SaveReal(udg_ht,task,0,0.0)
    call TimerStart(t,0.05,true,function Trig_Nazrin04_Main)
    //========
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Nazrin04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Nazrin04 Switch
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Nazrin04_Switch_Conditions takes nothing returns boolean
    if GetTriggerUnit()!=udg_SK_Nazrin04 then
        return false
    endif
    if GetIssuedOrderId()==OrderId("defend") then
        set udg_SK_Nazrin04_ON = true
        call DebugMsg("Nazrin04 ON")
        return false
    endif
    if GetIssuedOrderId()==OrderId("undefend") then
        set udg_SK_Nazrin04_ON = false
        call DebugMsg("Nazrin04 OFF")
        return false
    endif
    return false
endfunction

function Trig_Nazrin04_Switch_Actions takes nothing returns nothing
endfunction

//===========================================================================
function InitTrig_Nazrin04_Switch takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Init Nazrin
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Nazrin_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('U00K')
    local unit u
    local timer t
    local integer task
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set t = CreateTimer()
    set task = GetHandleId(t)
    
    set u = CreateUnit(GetOwningPlayer(h),'o00L',GetUnitX(h),GetUnitY(h),0.0)
    call SaveUnitHandle(udg_ht,task,0,h)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,1,0)
    call SaveBoolean(udg_ht,task,0,false)
    call TimerStart(t,0.5,false,function Trig_Nazrin_Pet_Main)
    
    set gg_trg_Nazrin_Pet = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Nazrin_Pet, h, EVENT_UNIT_ISSUED_ORDER )
    call TriggerAddCondition( gg_trg_Nazrin_Pet, Condition( function Trig_Nazrin_Pet_Conditions ) )
    //call TriggerAddAction( gg_trg_Nazrin_Pet, function Trig_Nazrin_Pet_Actions )

    set gg_trg_Nazrin01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Nazrin01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Nazrin01, Condition( function Trig_Nazrin01_Conditions ) )
    call TriggerAddAction( gg_trg_Nazrin01, function Trig_Nazrin01_Actions )

    set gg_trg_Nazrin02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Nazrin02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Nazrin02, Condition( function Trig_Nazrin02_Conditions ) )
    call TriggerAddAction( gg_trg_Nazrin02, function Trig_Nazrin02_Actions )
    
    set gg_trg_Nazrin03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Nazrin03, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Nazrin03, Condition( function Trig_Nazrin03_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Nazrin03, function Trig_Nazrin03_Learn_Actions )

    set udg_SK_Nazrin04 = null
    set gg_trg_Nazrin04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Nazrin04, h, EVENT_UNIT_SUMMON )
    call TriggerAddCondition( gg_trg_Nazrin04, Condition( function Trig_Nazrin04_Conditions ) )
    call TriggerAddAction( gg_trg_Nazrin04, function Trig_Nazrin04_Actions )
    
    set gg_trg_Nazrin04_Switch = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_Nazrin04_Switch, GetOwningPlayer(h), EVENT_PLAYER_UNIT_ISSUED_ORDER, null )
    call TriggerAddCondition( gg_trg_Nazrin04_Switch, Condition( function Trig_Nazrin04_Switch_Conditions ) )
    //call TriggerAddAction( gg_trg_Nazrin04_Switch, function Trig_Nazrin04_Switch_Actions )
    
    set h = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Init_Nazrin takes nothing returns nothing
    set gg_trg_Init_Nazrin = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Nazrin, function Trig_Init_Nazrin_Actions )
endfunction

//===========================================================================
// Trigger: MystiaFly
//===========================================================================
function Trig_MystiaFly_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0PK'
endfunction

function Trig_MystiaFly_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    //========
    local real abilitycooldownlv01 = 20
    local real abilitycooldownlv02 = 20
    local real abilitycooldownlv03 = 20
    local real abilitycooldownlv04 = 20
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set caster = null
endfunction

//===========================================================================
function InitTrig_MystiaFly takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Mystia01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Mystia01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0DE'
endfunction

function Trig_Mystia01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local integer i
    local unit u
    local group g = CreateGroup()
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local unit v
    local unit w
    //========
    local real abilitycooldownlv01 = 10
    local real abilitycooldownlv02 = 10
    local real abilitycooldownlv03 = 10
    local real abilitycooldownlv04 = 10
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,270.0)
    call UnitAddAbility(u,'A0DC')
    call SetUnitAbilityLevel(u,'A0DC',level)
    call IssuePointOrder(u,"silence",ox,oy)
    call UnitApplyTimedLife(u,'BTLF',0.5)
    //========
    call GroupEnumUnitsInRange(g,ox,oy,400.0,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if GetUnitCurrentOrder(v)!=OrderId("metamorphosis") then
            set w = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(v),GetUnitY(v),0)
            call UnitAddAbility(w,'A0T7')
            call SetUnitAbilityLevel(w,'A0T7',level)
            call IssueTargetOrder(w,"drunkenhaze",v)
        endif
    endloop
    call DestroyGroup(g)
    //========
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,270.0)
    call UnitApplyTimedLife(u,'BTLF',0.5)
    //call SetUnitScale(u,1.5,1.5,1.5)
    call UnitAddAbility(u,'A0E3')
    set i = 0
    loop
        exitwhen i>=12
        set px = ox + 100.0*CosBJ(30.0*i)
        set py = oy + 100.0*SinBJ(30.0*i)
        call IssuePointOrder(u,"breathoffrost",px,py)
        set i = i + 1
    endloop
    //========
    set caster = null
    set u = null
    set g = null
    set iff = null
    set v = null
    set w = null
endfunction

//===========================================================================
function InitTrig_Mystia01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Mystia02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Mystia02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0DI'
endfunction

function Trig_Mystia02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer level = LoadInteger(udg_ht,task,2)
    //========
    if i>0 and IsUnitAliveBJ(caster) then
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        if level == 1 then
            call UnitRemoveAbility(caster,'A0DM')
        elseif level == 2 then
            call UnitRemoveAbility(caster,'A0TB')
        elseif level == 3 then
            call UnitRemoveAbility(caster,'A0TC')
        elseif level == 4 then
            call UnitRemoveAbility(caster,'A0TD')
        endif
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
endfunction

function Trig_Mystia02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer i
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local unit u
    //========
    local real abilitycooldownlv01 = 10
    local real abilitycooldownlv02 = 10
    local real abilitycooldownlv03 = 10
    local real abilitycooldownlv04 = 10
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if level == 1 then
        call UnitAddAbility(caster,'A0DM')
        call UnitMakeAbilityPermanent(caster,true,'A0DM')
    elseif level == 2 then
        call UnitAddAbility(caster,'A0TB')
        call UnitMakeAbilityPermanent(caster,true,'A0TB')
    elseif level == 3 then
        call UnitAddAbility(caster,'A0TC')
        call UnitMakeAbilityPermanent(caster,true,'A0TC')
    elseif level == 4 then
        call UnitAddAbility(caster,'A0TD')
        call UnitMakeAbilityPermanent(caster,true,'A0TD')
    endif
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,1,10)
    call SaveInteger(udg_ht,task,2,level)
    call TimerStart(t,0.5,true,function Trig_Mystia02_Main)
    //========
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,270.0)
    call UnitApplyTimedLife(u,'BTLF',0.5)
    call UnitAddAbility(u,'A0E2')
    set i = 0
    loop
        exitwhen i>=24
        set px = ox + 100.0*CosBJ(15.0*i)
        set py = oy + 100.0*SinBJ(15.0*i)
        call IssuePointOrder(u,"breathoffrost",px,py)
        set i = i + 1
    endloop
    call CastSpell(caster,"啦啦啦～")
    //========
    set caster = null
    set t = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Mystia02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Mystia03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Mystia03_Conditions takes nothing returns boolean
    if not IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO) then
        return false
    endif
    if not IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(udg_SK_Mystia)) then
        return false
    endif
    if IsUnitType(udg_SK_Mystia,UNIT_TYPE_DEAD) then
        return false
    endif
    if GetRandomReal(0,100)>35.0 then
        return false
    endif
    //==========
    if ( not ( GetSpellAbilityId() != 'A0OQ' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0QP' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0OS' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0OR' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A029' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A02A' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A02B' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A035' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A02C' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A02K' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A02L' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A02M' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0LC' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0GZ' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0I1' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A04O' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A07V' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0FK' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A03T' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0CI' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0N3' ) ) then
        return false
    endif
    //==========
    return DistanceBetweenUnits(GetTriggerUnit(),udg_SK_Mystia)<=450.0
endfunction

function Trig_Mystia03_Actions takes nothing returns nothing
    local unit caster = udg_SK_Mystia
    local unit target = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0DH')
    local effect e = AddSpecialEffectTarget("MusicTarget.mdx",target,"head")
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIma\\AImaTarget.mdl",target,"chest"))
    call SetUnitManaPercentBJ(target,GetUnitManaPercent(target) + ( 4 + 2.0*level))
    call TriggerSleepAction(1.0)
    call DestroyEffect(e)
    set target = null
    set caster = null
    set e = null
endfunction

function Trig_Mystia03_Learn takes nothing returns nothing
    if GetLearnedSkill() == 'A0DH' then
        set udg_SK_Mystia = GetTriggerUnit()
        call DestroyTrigger(GetTriggeringTrigger())
        set gg_trg_Mystia03 = CreateTrigger()
        call TriggerRegisterAnyUnitEventBJ( gg_trg_Mystia03, EVENT_PLAYER_UNIT_SPELL_EFFECT )
        call TriggerAddCondition( gg_trg_Mystia03, Condition( function Trig_Mystia03_Conditions ) )
        call TriggerAddAction( gg_trg_Mystia03, function Trig_Mystia03_Actions )
    endif
endfunction

//===========================================================================
function InitTrig_Mystia03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Mystia04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Mystia04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0DN'
endfunction

function Trig_Mystia04_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    //========
    call DisplayCineFilter(false)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    call EnableTrigger(gg_trg_Mystia04)
    //========
    set t = null
endfunction

function Trig_Mystia04_Fade takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local integer i
    local unit v
    //========
    call TimerStart(t,0.5,false,function Trig_Mystia04_Clear)
    set i = 0
    loop
        set v = udg_PlayerHeroes[i]
        if LoadBoolean(udg_ht,task,i) then
            if GetPlayerId(GetLocalPlayer())==i then
                call SetCineFilterTexture("ReplaceableTextures\\CameraMasks\\Black_mask.blp")
                call SetCineFilterBlendMode(BLEND_MODE_BLEND)
                call SetCineFilterTexMapFlags(TEXMAP_FLAG_NONE)
                call SetCineFilterStartUV(0, 0, 1, 1)
                call SetCineFilterEndUV(0, 0, 1, 1)
                call SetCineFilterStartColor(0,0,0,255)
                call SetCineFilterEndColor(0,0,0,0)
                call SetCineFilterDuration(0.5)
                //call ShowInterface(true,0.5)
                //call EnableUserControl(true)
                call EnablePreSelect(true,true)
            endif
        endif
        set i = i + 1
        exitwhen i>=12
    endloop
    //========
    set t = null
    set v = null
endfunction

function Trig_Mystia04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local unit v
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer i
    local real time = GetTimeOfDay()
    local group g = CreateGroup()
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    //========
    local real abilitycooldownlv01 = 20
    local real abilitycooldownlv02 = 20
    local real abilitycooldownlv03 = 20
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,270.0)
    call UnitApplyTimedLife(u,'BTLF',1.0)
    call UnitAddAbility(u,'A0DO')
    call UnitAddAbility(u,'A0JO')
    call SetUnitAbilityLevel(u,'A0DO',level)
    call GroupEnumUnitsInRange(g,ox,oy,600.0,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitAliveBJ(v) then
            call IssueTargetOrder(u,"slow",v)
        endif
    endloop
    call DestroyGroup(g)
    //========
    call SetUnitScale(u,2.0,2.0,2.0)
    set i = 0
    loop
        exitwhen i>=36
        set px = ox + 100.0*CosBJ(10.0*i)
        set py = oy + 100.0*SinBJ(10.0*i)
        call IssuePointOrder(u,"breathoffrost",px,py)
        set i = i + 1
    endloop
    //========
    if (time<=6.0) or (time>18.0) then
        call DisableTrigger(gg_trg_Mystia04)
        set i = 0
        loop
            set v = udg_PlayerHeroes[i]
            if v!=null and IsUnitAlive(v) then
                if (not IsUnitAlly(v,GetOwningPlayer(caster))) and IsUnitInRange(caster,v,600.0) then
                    call SaveBoolean(udg_ht,task,i,true)
                    if GetPlayerId(GetLocalPlayer())==i then
                        call SetCineFilterTexture("ReplaceableTextures\\CameraMasks\\Black_mask.blp")
                        call SetCineFilterBlendMode(BLEND_MODE_BLEND)
                        call SetCineFilterTexMapFlags(TEXMAP_FLAG_NONE)
                        call SetCineFilterStartUV(0, 0, 1, 1)
                        call SetCineFilterEndUV(0, 0, 1, 1)
                        call SetCineFilterStartColor(0,0,0,0)
                        call SetCineFilterEndColor(0,0,0,255)
                        call SetCineFilterDuration(0.2)
                        call DisplayCineFilter(true)
                        //call ShowInterface(false,0.2)
                        //call EnableUserControl(true)
                        call EnablePreSelect(false,false)
                    endif
                else
                    call SaveBoolean(udg_ht,task,i,false)
                endif
            endif
            set i = i + 1
            exitwhen i>=12
        endloop
        call TimerStart(t,2.0 + 1.0*level,false,function Trig_Mystia04_Fade)
    endif
    //========
    set caster = null
    set t = null
    set u = null
    set v = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_Mystia04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Init Mystia
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Mystia_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E00Z')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_MystiaFly = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_MystiaFly, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_MystiaFly, Condition( function Trig_MystiaFly_Conditions ) )
    call TriggerAddAction( gg_trg_MystiaFly, function Trig_MystiaFly_Actions )

    set gg_trg_Mystia01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Mystia01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Mystia01, Condition( function Trig_Mystia01_Conditions ) )
    call TriggerAddAction( gg_trg_Mystia01, function Trig_Mystia01_Actions )
    
    set gg_trg_Mystia02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Mystia02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Mystia02, Condition( function Trig_Mystia02_Conditions ) )
    call TriggerAddAction( gg_trg_Mystia02, function Trig_Mystia02_Actions )
    
    set gg_trg_Mystia03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Mystia03, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddAction( gg_trg_Mystia03, function Trig_Mystia03_Learn )
    
    set gg_trg_Mystia04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Mystia04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Mystia04, Condition( function Trig_Mystia04_Conditions ) )
    call TriggerAddAction( gg_trg_Mystia04, function Trig_Mystia04_Actions )
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Mystia takes nothing returns nothing
    set gg_trg_Init_Mystia = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Mystia, function Trig_Init_Mystia_Actions )
endfunction

//===========================================================================
// Trigger: Koishi01
//
// Koishi02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Koishi01_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A0DR'
endfunction

function Koishi01_Resolve takes unit h,integer x returns nothing
    local integer i = 6
    loop
        exitwhen i==0
        set i = i - 1
        call UnitRemoveAbility(h,'A0DS'+i)
        if GetBitBoolean(x,i) then
            call UnitAddAbility(h,'A0DS'+i)
        endif
    endloop
endfunction

function Trig_Koishi01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_sht,task,0)
    local unit h
    local integer level = GetUnitAbilityLevel(caster,'A0DR')
    local integer i
    local integer n
    local integer d
    //========
    if IsUnitAliveBJ(caster) then
        set n = 0
        set i = 0
        loop
            exitwhen i>=12
            set h = udg_PlayerHeroes[i]
            if h!= null and IsUnitAliveBJ(h) then
                if IsUnitInRange(caster,h,1000.0) then
                    set n = n + 1
                endif
            endif
            set i = i + 1
        endloop
        set d = n*((level+1)*3)/3
        call Koishi01_Resolve(caster,d)
    else
        call Koishi01_Resolve(caster,0)
    endif
    //========
    set t = null
    set h = null
    set caster = null
endfunction

function Trig_Koishi01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    call SaveUnitHandle(udg_sht,task,0,caster)
    call TimerStart(t,0.2,true,function Trig_Koishi01_Main)
    call DestroyTrigger(GetTriggeringTrigger())
    //========
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Koishi01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Koishi02
//===========================================================================
function Trig_Koishi02_Conditions takes nothing returns boolean
    if GetEventDamage() <= 1.00 then
        return false
    endif
    if IsUnitGiant(GetEventDamageSource()) then
        return false
    endif
    if GetUnitAbilityLevel(GetEventDamageSource(),'A0MI') == 0 then
        return false
    endif
    return true
endfunction

function Trig_Koishi02_Actions takes nothing returns nothing
    local unit attacker = GetEventDamageSource()
    local unit damager = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(attacker,'A0MI')
    local real k = 4 + 2*level + GetEventDamage()*(0.05*(level+1))
    local effect e
    call SetUnitState(damager,UNIT_STATE_MANA,GetUnitState(damager,UNIT_STATE_MANA)-k)
    if IsUnitType(damager,UNIT_TYPE_HERO) then
        set e = AddSpecialEffect("Abilities\\Spells\\Human\\Feedback\\SpellBreakerAttack.mdl",GetUnitX(damager),GetUnitY(damager))
        call DestroyEffect(e)
    endif
    set attacker = null
    set damager = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Koishi02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Koishi04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Koishi04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0DY'
endfunction

function Trig_Koishi04_View takes unit caster returns nothing
    local real a = GetUnitFacing(caster)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real oz = GetPositionZ(ox,oy)
    local real tx = ox + 128.0*CosBJ(a)
    local real ty = oy + 128.0*SinBJ(a)
    local real dz = oz - GetPositionZ(tx,ty)
    local real o
    set o = bj_RADTODEG*Atan2(-dz,128.0)
    set o = RMaxBJ(-24.0,o)
    set o = RMinBJ(o,24.0)
    set dz = dz + 128.0*SinBJ(o)
    if GetOwningPlayer(caster)==GetLocalPlayer() then
        call PanCameraToTimed(tx,ty,0.0)
        call SetCameraField(CAMERA_FIELD_ZOFFSET        , 270.0, 0 )
        call SetCameraField(CAMERA_FIELD_ROTATION       , a, 0 )
        call SetCameraField(CAMERA_FIELD_ANGLE_OF_ATTACK, 348.0 + o, 0 )
        call SetCameraField(CAMERA_FIELD_ROLL           , 0.00, 0 )
        call SetCameraField(CAMERA_FIELD_TARGET_DISTANCE, 500.00, 0 )
        call SetCameraField(CAMERA_FIELD_FARZ           , 6000.00, 0 )
        call SetCameraField(CAMERA_FIELD_FIELD_OF_VIEW  , 120.00, 0 )
        //call CameraSetupApplyForceDuration(gg_cam_Koishi04,true,0.0)
    else
        if IsUnitAlly(caster,GetLocalPlayer()) then
            call SelectUnit(caster,false)
        endif
    endif
endfunction

function Trig_Koishi04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local real k0
    local real m0
    local real k1
    local real m1
    //========
    if GetUnitTypeId(caster)=='E011' and IsUnitType(caster,UNIT_TYPE_DEAD) == false then
        if i==0 and udg_SK_Koishi04_value == false then
            set k0 = GetUnitState(caster,UNIT_STATE_MAX_LIFE)
            set m0 = GetUnitState(caster,UNIT_STATE_MAX_MANA)
            set k1 = GetUnitState(caster,UNIT_STATE_LIFE)
            set m1 = GetUnitState(caster,UNIT_STATE_MANA)
            set udg_SK_Koishi04_value = true
            call SetHeroStr(caster,GetHeroStr(caster,false)+50*level,true)
            call SetHeroAgi(caster,GetHeroAgi(caster,false)+50*level,true)
            call SetHeroInt(caster,GetHeroInt(caster,false)+50*level,true)
            call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_MAX_LIFE)*(k1/k0))
            call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MAX_MANA)*(m1/m0))
            call IssuePointOrder(caster,"attack",ox + GetRandomReal(-100,100),oy + GetRandomReal(-100,100))
        endif
        set i = i + 1
        call SaveInteger(udg_ht,task,1,i)
        if i/300*300==i then
            call IssuePointOrder(caster,"attack",ox + GetRandomReal(-100,100),oy + GetRandomReal(-100,100))
        endif
        call Trig_Koishi04_View(caster)
    else
        if udg_SK_Koishi04_value == true then
            set k0 = GetUnitState(caster,UNIT_STATE_MAX_LIFE)
            set m0 = GetUnitState(caster,UNIT_STATE_MAX_MANA)
            set k1 = GetUnitState(caster,UNIT_STATE_LIFE)
            set m1 = GetUnitState(caster,UNIT_STATE_MANA)
            set udg_SK_Koishi04_value = false
            call SetHeroStr(caster,GetHeroStr(caster,false)-50*level,true)
            call SetHeroAgi(caster,GetHeroAgi(caster,false)-50*level,true)
            call SetHeroInt(caster,GetHeroInt(caster,false)-50*level,true)
        endif
        call SelectUnitForPlayerSingle(caster,GetOwningPlayer(caster))
        if GetOwningPlayer(caster)==GetLocalPlayer() then
            call EnableUserControl(true)
            call EnableOcclusion(true)
            call ResetToGameCamera(0.5)
            call PanCameraToTimed(ox,oy,0.0)
            call VolumeGroupSetVolume( SOUND_VOLUMEGROUP_SPELLS, 1.0 )
            call VolumeGroupSetVolume( SOUND_VOLUMEGROUP_COMBAT, 1.0 )
            call VolumeGroupSetVolume( SOUND_VOLUMEGROUP_FIRE, 1.0 )
            call VolumeGroupSetVolume( SOUND_VOLUMEGROUP_UI, 1.0 )
        endif
        call DisplayTextToPlayer(GetOwningPlayer(caster),0.0,0.0,"|cffff66cc内心隔绝解除|r")
        if GetUnitState(caster,UNIT_STATE_LIFE) > 0 then
            call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_MAX_LIFE)*(k1/k0))
            call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MAX_MANA)*(m1/m0))
        endif
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        call DisableTrigger(gg_trg_Koishi04_DS)
    endif
    //========
    set t = null
    set caster = null
endfunction

function Trig_Koishi04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0DY')
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local timer t
    local integer task
    //========
    local real abilitycooldownlv01 = 95
    local real abilitycooldownlv02 = 95
    local real abilitycooldownlv03 = 95
    //========
    if GetUnitTypeId(caster)=='E010' then
        if UnitHasItemOfTypeBJ(caster, 'I00B') then
            if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
            endif
        endif
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveInteger(udg_ht,task,0,level)
        call SaveInteger(udg_ht,task,1,0)
        call TimerStart(t,0.02,true,function Trig_Koishi04_Main)
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DarkRitual\\DarkRitualTarget.mdl",ox,oy))
        if GetOwningPlayer(caster)==GetLocalPlayer() then
            call EnableUserControl(false)
            call EnableOcclusion(false)
            call ClearTextMessages()
            //call CameraSetupApplyForceDuration(gg_cam_Koishi04,true,0.0)
            call VolumeGroupSetVolume( SOUND_VOLUMEGROUP_SPELLS, 0.0 )
            call VolumeGroupSetVolume( SOUND_VOLUMEGROUP_COMBAT, 0.0 )
            call VolumeGroupSetVolume( SOUND_VOLUMEGROUP_FIRE, 0.0 )
            call VolumeGroupSetVolume( SOUND_VOLUMEGROUP_UI, 0.0 )
        else
            call SelectUnit(caster,false)
        endif
        call DisplayTimedTextToPlayer(GetOwningPlayer(caster),0.0,0.0,9.0,"|cffeeeeee内心隔绝状态|r")
        call EnableTrigger(gg_trg_Koishi04_DS)
    endif
    //========
    set caster = null
    set t = null
endfunction

function InitTrig_Koishi04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Koishi04 DS
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Koishi04_DS_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetTriggerUnit()) == 'E011'
endfunction

function Trig_Koishi04_DS_Actions takes nothing returns nothing
    if IsUnitAlly(GetTriggerUnit(),GetLocalPlayer()) then
        call SelectUnit(GetTriggerUnit(),false)
    endif
endfunction

//===========================================================================
function InitTrig_Koishi04_DS takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Init Koishi
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Koishi_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E010')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set udg_SK_Koishi04_value = false

    set gg_trg_Koishi01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Koishi01, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Koishi01, Condition( function Trig_Koishi01_Conditions ) )
    call TriggerAddAction( gg_trg_Koishi01, function Trig_Koishi01_Actions )
    
    set gg_trg_Koishi02 = CreateTrigger()
    call RegisterAnyUnitDamage(gg_trg_Koishi02)
    call TriggerAddCondition( gg_trg_Koishi02, Condition( function Trig_Koishi02_Conditions ) )
    call TriggerAddAction( gg_trg_Koishi02, function Trig_Koishi02_Actions )

    set gg_trg_Koishi04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Koishi04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Koishi04, Condition( function Trig_Koishi04_Conditions ) )
    call TriggerAddAction( gg_trg_Koishi04, function Trig_Koishi04_Actions )
    
    set gg_trg_Koishi04_DS = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Koishi04_DS, h, EVENT_UNIT_SELECTED )
    call TriggerAddCondition( gg_trg_Koishi04_DS, Condition( function Trig_Koishi04_DS_Conditions ) )
    call TriggerAddAction( gg_trg_Koishi04_DS, function Trig_Koishi04_DS_Actions )
    call DisableTrigger(gg_trg_Koishi04_DS)
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Koishi takes nothing returns nothing
    set gg_trg_Init_Koishi = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Koishi, function Trig_Init_Koishi_Actions )
endfunction

//===========================================================================
// Trigger: Hina01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Hina01_Conditions takes nothing returns boolean
    local unit u
    if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
        return GetSpellAbilityId()=='A0E4'
    endif
    if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
        return (GetEventDamage()>1.0)and(GetEventDamage()<500.0)
    endif
    set u = GetTriggerUnit()
    if GetUnitTypeId(u)=='n02T' and IsUnitIllusion(u)==false then
        call GroupRemoveUnit(LoadGroupHandle(udg_ht,GetHandleId(u),0),u)
        call FlushChildHashtable(udg_ht,GetHandleId(u))
    endif
    set u = null
    return false
endfunction

function Trig_Hina01_Actions takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local unit caster
    local unit target
    local unit u
    local real ox
    local real oy
    local real px
    local real py
    local real a
    local real d
    local group g
    local boolean k
    local integer level
    local integer n
    //========
    local real abilitycooldownlv01 = 9
    local real abilitycooldownlv02 = 9
    local real abilitycooldownlv03 = 9
    local real abilitycooldownlv04 = 9
    //========
    if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
        set caster = GetTriggerUnit()
        set target = GetSpellTargetUnit()
        set ox = GetUnitX(target)
        set oy = GetUnitY(target)
        set level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
        if UnitHasItemOfTypeBJ(caster, 'I00B') then
            if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
            endif
        endif
        call SaveUnitHandle(udg_sht,GetHandleId(trg),0,caster)
        if HaveSavedHandle(udg_sht,GetHandleId(caster),GetHandleId(target)) then
            set g = LoadGroupHandle(udg_sht,GetHandleId(caster),GetHandleId(target))
        else
            call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
            set g = CreateGroup()
            call SaveGroupHandle(udg_sht,GetHandleId(caster),GetHandleId(target),g)
        endif
        set n = level + 2
        loop
            set a = GetRandomReal(0.0,360.0)
            set d = GetRandomReal(80.0,320.0)
            set px = ox + d*CosBJ(a)
            set py = oy + d*SinBJ(a)
            set u = CreateUnit(GetOwningPlayer(caster),'n02T',px,py,a)
            call UnitApplyTimedLife(u,'BTLF',16.0)
            call GroupAddUnit(g,u)
            call SaveGroupHandle(udg_ht,GetHandleId(u),0,g)
            set n = n - 1
            exitwhen n==0
        endloop
    elseif GetTriggerEventId()==EVENT_UNIT_DAMAGED then
        set caster = LoadUnitHandle(udg_sht,GetHandleId(trg),0)
        set target = GetTriggerUnit()
        set k = false
        set d = GetEventDamage()
        set g = LoadGroupHandle(udg_sht,GetHandleId(caster),GetHandleId(target))
        loop
            set u = FirstOfGroup(g)
            exitwhen u==null
            if IsUnitAlive(u) then
                set k = true
                //call TSU_SetUnitInvulnerable(target,0.001)
                set a = RMinBJ(d,GetUnitState(u,UNIT_STATE_LIFE))
                set d = d - a
                call SetUnitState(target,UNIT_STATE_LIFE,GetUnitState(target,UNIT_STATE_LIFE) + a)
                call SetUnitState(u,UNIT_STATE_LIFE,GetUnitState(u,UNIT_STATE_LIFE) - a)
                call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\AvengerMissile\\AvengerMissile.mdl",u,"chest"))
                call DebugMsg(R2S(a))
                exitwhen d<=0.0
            else
                call GroupRemoveUnit(g,u)
            endif
        endloop
        if k then
            call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Defend\\DefendCaster.mdl",target,"origin"))
        endif
    endif
    //========
    set trg = null
    set g = null
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Hina01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Hina02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Hina02_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0DZ'
endfunction

function Trig_Hina02_Effect takes nothing returns nothing
    //call UnitAddAbility(GetEnumUnit(),'A0P2')
endfunction

function Trig_Hina02_Clear takes nothing returns nothing
    //call UnitRemoveAbility(GetEnumUnit(),'A0P2')
endfunction

function Trig_Hina02_Lightning takes unit u1,unit u2 returns nothing
    local real x1
    local real y1
    local real z1
    local real x2
    local real y2
    local real z2
    if u1!=null and u2!=null then
        set x1 = GetUnitX(u1)
        set y1 = GetUnitY(u1)
        set z1 = 50.0 + GetPositionZ(x1,y1)
        set x2 = GetUnitX(u2)
        set y2 = GetUnitY(u2)
        set z2 = 50.0 + GetPositionZ(x2,y2)
        call TSU_DestroyLightning(0.25,AddLightningEx("MBUR",false,x1,y1,z1,x2,y2,z2))
    endif
endfunction

function Trig_Hina02_Damage takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = GetTriggerUnit()
    local unit v = GetEnumUnit()
    local integer level = LoadInteger(udg_ht,task,0)
    local real damage = level*0.07*GetEventDamage()
    local real HP = GetUnitState(v,UNIT_STATE_LIFE)
    //========
    set damage = RMinBJ(damage,GetUnitState(u,UNIT_STATE_LIFE))
    if HP>1.0 and v!=u then
        if HP < damage then
            set damage = damage - HP - 1.0
        endif
        call UnitDamageTargetHina(caster,v,damage,2,GetRandomInt(1,10)*0.01)
    endif
    //========
    set trg = null
    set caster = null
    set u = null
    set v = null
endfunction

function Trig_Hina02_Main takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local group g = LoadGroupHandle(udg_ht,task,2)
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call ForGroup(g,function Trig_Hina02_Clear)
        call FlushChildHashtable(udg_ht,task)
        call DestroyGroup(g)
        call DestroyTrigger(trg)
    elseif GetEventDamage()>10 and GetEventDamage()<6000 and GetUnitTypeId(GetEventDamageSource()) != 'n02V'then
        call DisableTrigger(trg)
        call ForGroup(g,function Trig_Hina02_Damage)
        call EnableTrigger(trg)
    endif
    set trg = null
    set g = null
endfunction

function Trig_Hina02_Filter takes nothing returns boolean
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE) < 1.0 then
        return false
    endif
    if not IsUnitEnemy(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) then
        return false
    endif
    if not IsUnitVisible(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) then
        return false
    endif
    return GetFilterUnit()!=GetSpellTargetUnit()
endfunction

function Trig_Hina02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local boolexpr f = Filter(function Trig_Hina02_Filter)
    local group g = CreateGroup()
    local group m = CreateGroup()
    local unit array v
    local unit u
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local trigger trg = CreateTrigger()
    local integer task = GetHandleId(trg)
    local integer i
    local string StringFX = "Abilities\\Spells\\Undead\\Curse\\CurseTarget.mdl"
    //========
    local real abilitycooldownlv01 = 25
    local real abilitycooldownlv02 = 25
    local real abilitycooldownlv03 = 25
    local real abilitycooldownlv04 = 25
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call GroupEnumUnitsInRange(m,GetUnitX(target),GetUnitY(target),600.0,f)
    set v[0] = caster
    set v[1] = target
    set i = 1
    set u = v[1]
    loop
        call Trig_Hina02_Lightning(v[i-1],u)
        call TSU_AddSpecialEffectTarget(StringFX,u,"overhead",20.0)
        call TriggerRegisterUnitEvent(trg,u,EVENT_UNIT_DAMAGED)
        call GroupAddUnit(g,u)
        set i = i + 1
        exitwhen i>5
        set u = FirstOfGroup(m)
        exitwhen u == null
        call GroupRemoveUnit(m,u)
        set v[i] = u
    endloop
    //========
    call ForGroup(g,function Trig_Hina02_Effect)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveGroupHandle(udg_ht,task,2,g)
    call SaveInteger(udg_ht,task,0,level)
    call TriggerRegisterTimerEvent(trg,20.0,false)
    call TriggerAddAction(trg,function Trig_Hina02_Main)
    //========
    call DestroyGroup(m)
    set caster = null
    set target = null
    set trg = null
    set g = null
    set m = null
    set f = null
    set v[0] = null
    set v[1] = null
    set v[2] = null
    set v[3] = null
    set v[4] = null
    set v[5] = null
endfunction

function InitTrig_Hina02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Hina03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Hina03_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0E8'
endfunction

function Trig_Hina03_Main takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit target = GetTriggerUnit()
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = LoadInteger(udg_ht,task,0)
    local real damage
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call DestroyEffect(LoadEffectHandle(udg_ht,task,1))
        call FlushChildHashtable(udg_ht,task)
        call DestroyTrigger(trg)
    elseif GetEventDamage()>1 and GetEventDamage()<6000 and GetUnitTypeId(GetEventDamageSource()) != 'n02U' then
        call DisableTrigger(trg)
        set damage = GetEventDamage()*(0.1 + 0.1*level)
        call UnitDamageTargetHinaII(caster,target,damage,2)
        call EnableTrigger(trg)
    endif
    set trg = null
    set target = null
    set caster = null
endfunction

function Trig_Hina03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local trigger trg
    local integer task
    local effect e
    //========
    local real abilitycooldownlv01 = 13
    local real abilitycooldownlv02 = 13
    local real abilitycooldownlv03 = 13
    local real abilitycooldownlv04 = 13
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set trg = null
            set e = null
            return
        endif
    endif
    //========
    set trg = CreateTrigger() 
    set task = GetHandleId(trg)
    set e = AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\shadowstrike\\shadowstrike.mdl",target,"overhead")
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveEffectHandle(udg_ht,task,1,e)
    call SaveInteger(udg_ht,task,0,level)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterTimerEvent(trg,6.0,false)
    call TriggerAddAction(trg,function Trig_Hina03_Main)
    //========
    set caster = null
    set target = null
    set trg = null
    set e = null
endfunction

function InitTrig_Hina03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Hina04
//
// 1-->Caster         4-->EndDamage         7-->Spell Effect
// 2-->Skill Time     5-->Level
// 3-->Time Count     6-->TriggeredGroup
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Hina04_Target takes nothing returns boolean
    if IsUnitDeadBJ(GetFilterUnit()) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitWard(GetFilterUnit()) then
        return false
    endif
    return true
endfunction

function Hina04_Act_Main_End takes unit caster,integer level,real damage returns nothing
    local unit u
    local unit v
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local player w = GetOwningPlayer(caster)
    local group g = CreateGroup()
    local boolexpr f
    local integer i
    
    //击晕转转自己 
    set u = CreateUnit(w,GPSU(),ox,oy,0.0)
    call UnitApplyTimedLife(u,'BTLF',1.0)
    if GetUnitAbilityLevel(caster,'BPSE')<=0 then
        call UnitAddAbility(u,'A0EA')
        call IssueTargetOrder(u,"thunderbolt",caster)
        call SetUnitAnimation(caster,"Spell Channel")
    endif
    
    //AOE特效
    call UnitAddAbility(u,'A0EB')
    set i = 1
    loop
        exitwhen i > 12
        set px = ox + 100.0*CosBJ(i*30.0)
        set py = oy + 100.0*SinBJ(i*30.0)
        call IssuePointOrder(u,"carrionswarm",px,py)
        set i = i + 1
    endloop
    
    set u = CreateUnit(w,GPSU(),ox,oy,0.0)
    call UnitApplyTimedLife(u,'BTLF',1.0)
    call UnitAddAbility(u,'A0L7')
    call SetUnitAbilityLevel(u,'A0L7',level)
    
    set f = Filter(function Trig_Hina04_Target)
    call GroupEnumUnitsInRange(g,ox,oy,650.0,f)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitEnemy(v,w) then
            call UnitDamageTarget(caster,v,damage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,null)
            call IssueTargetOrder(u,"thunderbolt",v)
        endif
    endloop
    call DestroyGroup(g)
    call DestroyBoolExpr(f)
    
    set w = null
    set u = null
    set v = null
    set g = null
    set f = null
endfunction

function Hina04_UnitDamaged takes nothing returns nothing
    local trigger tr = GetTriggeringTrigger()
    local integer task_tr = GetHandleId(tr)
    local unit damaged = GetTriggerUnit()
    local unit caster = LoadUnitHandle(udg_Hashtable, task_tr, 1)
    local timer t = LoadTimerHandle(udg_Hashtable, task_tr, 2)
    local integer task_t = GetHandleId(t)
    local real damage = LoadReal(udg_Hashtable, task_t, 4)
    local integer level = LoadInteger(udg_Hashtable, task_t, 5)
    local group triggeredgroup = LoadGroupHandle(udg_Hashtable, task_t, 6)
    local unit helper
    local real dx
    local real dy
    
    if GetTriggerEventId() == EVENT_UNIT_DAMAGED then
        set damaged = GetTriggerUnit()
        set damage = damage + GetEventDamage()*(0.3 + level*0.1)
        call SaveReal(udg_Hashtable, task_t, 4, damage)
        //特效
        if damaged!=caster then
            set helper = CreateUnit(GetOwningPlayer(damaged),GPSU(),GetUnitX(damaged),GetUnitY(damaged),0.0)
            call SetUnitScale(helper,2.0,2.0,2.0)
            call UnitAddAbility(helper,'A0EC')
            call UnitApplyTimedLife( helper, 'BHwe', 0.2 )
            call IssueTargetOrder(helper,"shadowstrike", caster)
        endif
    else
        set damaged = LoadUnitHandle(udg_Hashtable, task_tr, 3)
        set dx = GetUnitX(damaged)-GetUnitX(caster)
        set dy = GetUnitY(damaged)-GetUnitY(caster)
        //范围
        if SquareRoot(dx*dx+dy*dy)>650 then
            call GroupRemoveUnit(triggeredgroup, damaged)
            call SaveGroupHandle(udg_Hashtable, task_t, 6, triggeredgroup)
            call FlushChildHashtable(udg_Hashtable, task_tr)
            call RemoveSavedHandle(udg_Hashtable, task_t, GetHandleId(damaged))
            call TriggerClearActions(tr)
            call DestroyTrigger(tr)
        endif
    endif

    set tr = null
    set damaged = null
    set caster = null
    set t = null
    set helper = null
    set triggeredgroup = null
endfunction

function Hina04_Clear takes nothing returns nothing
    local unit target = GetEnumUnit()
    local integer task = GetHandleId(GetExpiredTimer())
    local trigger trg = LoadTriggerHandle(udg_Hashtable,task,GetHandleId(target))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_Hashtable,GetHandleId(trg))
    set target = null
    set trg = null
endfunction

function Hina04_Act_Main takes nothing returns nothing
    local timer main_t = GetExpiredTimer()
    local integer task = GetHandleId(main_t)
    local unit caster = LoadUnitHandle(udg_Hashtable, task, 1)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx
    local real ty
    local real angle
    local real dis
    local integer skilltime = LoadInteger(udg_Hashtable, task, 2)
    local integer count = LoadInteger(udg_Hashtable, task, 3)
    local real damage = LoadReal(udg_Hashtable, task, 4)
    local integer level = LoadInteger(udg_Hashtable, task, 5)
    local group triggeredgroup = LoadGroupHandle(udg_Hashtable, task, 6)
    local player castplayer = GetOwningPlayer(caster)
    local group g = CreateGroup()
    local boolexpr f
    local integer countbuff = 0
    local unit target
    local unit helper
    local trigger tr
    local integer task_tr
    
    if count > skilltime or IsUnitDeadBJ(caster) then
        call DestroyEffect(LoadEffectHandle(udg_Hashtable, task, 7))
        call SetUnitTimeScale(caster, 1.00)
        if GetUnitState(caster, UNIT_STATE_LIFE) > 0 then
            call IssueImmediateOrder(caster,"phaseshiftoff")
        else
            set ox = LoadReal(udg_Hashtable,task,2)
            set oy = LoadReal(udg_Hashtable,task,3)
        endif
        call AddUnitAnimationProperties(caster,"Spin",false)
        
        if IsUnitDeadBJ(caster) then
            set damage = damage*0.75
        endif
        
        call Hina04_Act_Main_End(caster,level,damage)
        
        call ForGroup(triggeredgroup,function Hina04_Clear)
        
        call DebugMsg("Hina04 End")
        
        call DestroyGroup(triggeredgroup)
        call DestroyGroup(g)
        call DestroyTimer(main_t)
        
        set main_t = null
        set caster = null
        set castplayer = null
        set g = null
        set target = null
        set tr = null
        set triggeredgroup = null
        set helper = null
        set f = null
        return
    endif
    
    call SaveReal(udg_Hashtable,task,2,ox)
    call SaveReal(udg_Hashtable,task,3,oy)
    
//范围
    set f = Filter(function Trig_Hina04_Target)
    call GroupEnumUnitsInRangeOfLoc(g,GetUnitLoc(caster),650.0,f)
    loop
        set target = FirstOfGroup(g)
        exitwhen(target==null)
        //友军单位清理buff 敌军单位中心吸引 
        if (not IsUnitEnemy(target, castplayer)) then
            set countbuff = UnitCountBuffsEx(target, false, true, false, false, false, false, true)
            call UnitRemoveBuffsEx( target, false, true, false, false, false, false, true )
            if countbuff != 0 then
                //特效
                if target!=caster then
                    set helper = CreateUnit(GetOwningPlayer(target),GPSU(),GetUnitX(target),GetUnitY(target),0.0)
                    call SetUnitScale(helper,2.0,2.0,2.0)
                    call UnitAddAbility(helper,'A0EC')
                    call UnitApplyTimedLife( helper, 'BHwe', 0.2 )
                    call IssueTargetOrder(helper,"shadowstrike", caster)
                endif
            endif
            set damage = damage + countbuff*20
            if not IsUnitInGroup(target, triggeredgroup) then
                set tr = CreateTrigger()
                set task_tr = GetHandleId(tr)
                call TriggerRegisterUnitEvent(tr, target, EVENT_UNIT_DAMAGED)
                call TriggerRegisterTimerEvent(tr, 0.03, true)
                call TriggerAddAction(tr, function Hina04_UnitDamaged)
                call SaveUnitHandle(udg_Hashtable, task_tr, 1, caster)
                call SaveTimerHandle(udg_Hashtable, task_tr, 2, main_t)
                call SaveUnitHandle(udg_Hashtable, task_tr, 3, target)
                call SaveTriggerHandle(udg_Hashtable, task, GetHandleId(target), tr)
                call GroupAddUnit(triggeredgroup, target) 
            endif
        elseif IsMobileUnit(target) and GetUnitFlag(target,CS_YUUGI())==false and GetUnitTypeId(target)!='U00M' then
            set tx = GetUnitX(target)
            set ty = GetUnitY(target)
            set angle = Atan2(oy-ty, ox-tx)
            set dis = SquareRoot((oy-ty)*(oy-ty)+(ox-tx)*(ox-tx))
            if dis>=100*0.03 then
                set tx = tx + (50*0.03)*Cos(angle)
                set ty = ty + (50*0.03)*Sin(angle)
                call SetUnitXYGround(target,tx,ty)
            endif
        endif 
        call GroupRemoveUnit(g, target)
    endloop
    call DestroyGroup(g)
    call DestroyBoolExpr(f)

    call SaveReal(udg_Hashtable, task, 4, damage)
    call SaveInteger(udg_Hashtable, task, 3, count+1)
    call SaveGroupHandle(udg_Hashtable, task, 6, triggeredgroup)

    set main_t = null
    set caster = null
    set castplayer = null
    set g = null
    set f = null
    set target = null
    set tr = null
    set triggeredgroup = null
    set helper = null
endfunction

function Hina04_Con takes nothing returns boolean
    return GetSpellAbilityId() == 'A0E9'
endfunction

function Hina04_Act takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local timer efft = CreateTimer()
    local integer efftid = GetHandleId(efft)
    local group g = CreateGroup()
    local integer i = 1
    local unit helper
    local real unitX = GetUnitX(caster)
    local real unitY = GetUnitY(caster)
    //技能特效
    local effect spelleff = AddSpecialEffectTarget("Abilities\\Spells\\Items\\VampiricPotion\\VampPotionCaster.mdl", caster, "origin")
    //========
    local real abilitycooldownlv01 = 90
    local real abilitycooldownlv02 = 90
    local real abilitycooldownlv03 = 90
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    call SetUnitTimeScale(caster, 15.00)

    call TimerStart(t, 0.03, true, function Hina04_Act_Main)
    call SaveUnitHandle(udg_Hashtable, task, 1, caster)
    call SaveInteger(udg_Hashtable, task, 2, 233)
    call SaveInteger(udg_Hashtable, task, 3, 0)
    call SaveReal(udg_Hashtable,task,2,unitX)
    call SaveReal(udg_Hashtable,task,3,unitY)
    call SaveReal(udg_Hashtable,task,4,0)//Damage
    call SaveInteger(udg_Hashtable, task, 5, GetUnitAbilityLevel(caster,GetSpellAbilityId()))
    call SaveGroupHandle(udg_Hashtable, task, 6, g)
    call SaveEffectHandle(udg_Hashtable, task, 7, spelleff)
    
    call AddUnitAnimationProperties(caster,"Spin",true)
    if GetUnitAbilityLevel(caster,'A0EY')==0 then
        call UnitAddAbility(caster,'A0EY')
    endif
    set efft = null
    set spelleff = null
    set caster = null
    set helper = null
    set t = null
    set g = null
endfunction

function InitTrig_Hina04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Initial Hina
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Hina_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H00X')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_Hina01 = CreateTrigger()
    call TriggerRegisterUnitEvent(gg_trg_Hina01, h, EVENT_UNIT_SPELL_EFFECT)
    call TriggerRegisterAnyUnitEventBJ(gg_trg_Hina01, EVENT_PLAYER_UNIT_DEATH)
    call TriggerAddCondition(gg_trg_Hina01, Condition(function Trig_Hina01_Conditions))
    call TriggerAddAction(gg_trg_Hina01, function Trig_Hina01_Actions)
    
    set gg_trg_Hina02 = CreateTrigger()
    call TriggerRegisterUnitEvent(gg_trg_Hina02, h, EVENT_UNIT_SPELL_EFFECT)
    call TriggerAddCondition(gg_trg_Hina02,Condition(function Trig_Hina02_Conditions))
    call TriggerAddAction(gg_trg_Hina02,function Trig_Hina02_Actions)
    //call TriggerRegisterUnitEvent(gg_trg_Hina02, h, EVENT_UNIT_SPELL_EFFECT)
    //call TriggerAddCondition(gg_trg_Hina02, Condition(function Hina02_Con))
    //call TriggerAddAction(gg_trg_Hina02, function Hina02_Act)
    
    set gg_trg_Hina03 = CreateTrigger()
    call TriggerRegisterUnitEvent(gg_trg_Hina03, h, EVENT_UNIT_SPELL_EFFECT)
    call TriggerAddCondition(gg_trg_Hina03, Condition(function Trig_Hina03_Conditions))
    call TriggerAddAction(gg_trg_Hina03, function Trig_Hina03_Actions)
    
    set gg_trg_Hina04 = CreateTrigger()
    call TriggerRegisterUnitEvent(gg_trg_Hina04, h, EVENT_UNIT_SPELL_EFFECT)
    call TriggerAddCondition(gg_trg_Hina04, Condition(function Hina04_Con))
    call TriggerAddAction(gg_trg_Hina04, function Hina04_Act)
    
    set h = null
endfunction

function InitTrig_Initial_Hina takes nothing returns nothing
    set gg_trg_Initial_Hina = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Hina, function Trig_Initial_Hina_Actions )
endfunction//===========================================================================
// Trigger: Ran01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Ran_01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0EE'
endfunction

function Trig_Ran_01_Distance takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local integer level = GetUnitAbilityLevel(caster,'A0EE')
    local boolean o = IsUnitInRange(caster,u,1500.0)
    local boolean k = IsUnitInRange(caster,u,600.0)
    if IsUnitAlive(u) then
        if o then
            call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A0EQ',true)
            if GetUnitAbilityLevel(u,'A0HV')==0 then
                call UnitAddAbility(u,'A0HV')
                call UnitMakeAbilityPermanent(u,true,'A0HV')
            endif
            call SetUnitAbilityLevel(u,'A0HV',level)
        else
            call SetPlayerAbilityAvailable(GetOwningPlayer(u),'A0EQ',false)
            if GetUnitAbilityLevel(u,'A0HV')>0 then
                call UnitRemoveAbility(u,'A0HV')
            endif
        endif
        set level = GetUnitAbilityLevel(caster,'A0EM')
        if k and level>0 then
            if GetUnitAbilityLevel(u,'A0EJ')>0 then
                call UnitRemoveAbility(u,'A0EJ')
                call UnitAddAbility(u,'A0EK')
                call UnitAddAbility(u,'A0EL')
                call SetUnitAbilityLevel(u,'A0EK',level)
                call SetUnitAbilityLevel(u,'A0EL',level)
                call UnitMakeAbilityPermanent(u,true,'A0EK')
                call UnitMakeAbilityPermanent(u,true,'A0EL')
            endif
        else
            if GetUnitAbilityLevel(u,'A0EK')>0 then
                call UnitRemoveAbility(u,'A0EK')
                call UnitRemoveAbility(u,'A0EL')
                call UnitAddAbility(u,'A0EJ')
                call UnitMakeAbilityPermanent(u,true,'A0EJ')
            endif
        endif
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Ran_01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer task = GetHandleId(caster)
    local unit u = LoadUnitHandle(udg_sht,task,0)
    local item w
    local effect e
    local timer t
    local integer level = GetUnitAbilityLevel(caster,'A0EE')
    local integer i
    local real a = GetUnitFacing(caster)
    local real x = GetUnitX(caster) + 80.0*CosBJ(a)
    local real y = GetUnitY(caster) + 80.0*SinBJ(a)
    //========
    local real abilitycooldownlv01 = 60
    local real abilitycooldownlv02 = 60
    local real abilitycooldownlv03 = 60
    local real abilitycooldownlv04 = 60
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //======== 
    if u==null or IsUnitDead(u) then
        set u = CreateUnit(GetOwningPlayer(caster),'n02P',x,y,a)
        set e = AddSpecialEffectTarget("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosTarget.mdl",u,"origin")
        call DestroyEffect(e)
        call SaveUnitHandle(udg_sht,task,0,u)
        call SaveUnitHandle(udg_sht,GetHandleId(u),0,caster)
        
        call UnitAddAttackDamage(u,1*GetHeroAgi(caster,true))
        call AddUnitMaxLife(u,(level-1)*200 + 5*GetHeroInt(caster,true))
        
        set i = 0
        loop
            exitwhen i > bj_MAX_INVENTORY
            set w = LoadItemHandle(udg_sht,task,i+1)
            if w!= null then
                call SetItemVisible(w,true)
                call UnitAddItem(u,w)
                call UnitDropItemSlot(u,w,i)
            endif
            set i = i + 1
        endloop
        
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveUnitHandle(udg_ht,task,1,u)
        call TimerStart(t,0.5,true,function Trig_Ran_01_Distance)
    else
        call SetUnitPosition(u,x,y)
        call SetUnitLifePercentBJ(u,100.0)
        call SetUnitManaPercentBJ(u,100.0)
        set e = AddSpecialEffectTarget("Abilities\\Spells\\Human\\MarkOfChaos\\MarkOfChaosTarget.mdl",u,"origin")
        call DestroyEffect(e)
    endif
    
    set caster = null
    set u = null
    set w = null
    set e = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Ran01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Ran01Up
//===========================================================================
//TESH.scrollpos=11
//TESH.alwaysfold=0

function Trig_Ran01Up_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A0EE'
endfunction

function Trig_Ran01Up_Death takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u = LoadUnitHandle(udg_sht,GetHandleId(caster),0)
    if u!=null then
        call KillUnit(u)
    endif
    set caster = null
    set u = null
endfunction

function Trig_Ran01Up_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0EE')
    local trigger trg
    
    if level == 1 then
        set trg = CreateTrigger()
        call TriggerRegisterUnitEvent( trg, caster, EVENT_UNIT_DEATH )
        call TriggerAddAction( trg, function Trig_Ran01Up_Death )
    endif
    
    if level>=1 then
        call SetPlayerTechResearched(GetOwningPlayer(caster),'R001',level)
    endif
    
    set caster = null
    set trg = null
endfunction

//===========================================================================
function InitTrig_Ran01Up takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Ran02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Ran_02_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0EF'
endfunction

function Trig_Ran_02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    //========
    local real abilitycooldownlv01 = 10
    local real abilitycooldownlv02 = 10
    local real abilitycooldownlv03 = 10
    local real abilitycooldownlv04 = 10
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call UnitAddAbility( caster, 'A0ES' )
    call TriggerSleepAction( 1.50 + 0.50 * GetUnitAbilityLevel(caster, 'A0EF'))
    call UnitRemoveAbility( caster,'A0ES' )
    set caster = null
endfunction

//===========================================================================
function InitTrig_Ran02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Ran03
//===========================================================================
//TESH.scrollpos=59
//TESH.alwaysfold=0
function Trig_Ran_03_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0EG'
endfunction

function Trig_Ran_03_Filter takes nothing returns boolean
    local unit u1 = GetFilterUnit()
    local unit u2 = LoadUnitHandle(udg_Hashtable,StringHash("Trig_Ran_03_Filter"),1)
    local player PLY = LoadPlayerHandle(udg_Hashtable,StringHash("Trig_Ran_03_Filter"),2)
    if u1 != u2 and GetUnitAbilityLevel(u1,'Avul') == 0 and GetUnitAbilityLevel(u1,'Bvul') == 0 and IsUnitEnemy(u1,PLY) and IsUnitType(u1,UNIT_TYPE_STRUCTURE)==false and IsUnitType(u1,UNIT_TYPE_MECHANICAL)==false and IsUnitType(u1,UNIT_TYPE_DEAD)==false then
    set u1 = null
    set u2 = null
    set PLY = null
    return true
    endif
    set u1 = null
    set u2 = null
    set PLY = null
    return false
endfunction

function Trig_Ran_03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local player PLY = GetOwningPlayer(caster)
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0EG')
    local integer time = level*2+1
    local integer color
    local unit u
    local group grp
    //========
    local real abilitycooldownlv01 = 10
    local real abilitycooldownlv02 = 10
    local real abilitycooldownlv03 = 10
    local real abilitycooldownlv04 = 10
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set PLY = null
            set target = null
            set u = null
            set grp = null
            return
        endif
    endif
    //========    

    loop
    exitwhen ( time < 1 or target == null )
call DebugMsg(I2S(time))
        //change color
        if ModuloInteger(time,2) == 0 then
        set color = 'A0ET'
        else
        set color = 'A0EU'
        endif
        //issue order
        set u = CreateUnit(PLY,'n02Y',GetUnitX(caster),GetUnitY(caster),0)
        call UnitAddAbility(u,color)
        call SetUnitAbilityLevel(u,color,level)
        call IssueTargetOrder(u,"chainlightning",target)
        //next target
        set grp = CreateGroup()
        call SaveUnitHandle(udg_Hashtable,StringHash("Trig_Ran_03_Filter"),1,target)
        call SavePlayerHandle(udg_Hashtable,StringHash("Trig_Ran_03_Filter"),2,PLY)
        call GroupEnumUnitsInRange(grp,GetUnitX(target),GetUnitY(target),600,Filter(function Trig_Ran_03_Filter))
        call FlushChildHashtable(udg_Hashtable,StringHash("Trig_Ran_03_Filter"))
        set caster = target
        set target = GroupPickRandomUnit(grp)
        call DestroyGroup(grp)
        set grp = null
        set time = time - 1
        call TriggerSleepAction(0.2)
    endloop
call DebugMsg("end")
set caster = null
set PLY = null
set target = null
set u = null
set grp = null
endfunction


//===========================================================================
function InitTrig_Ran03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Ran04
//===========================================================================
//TESH.scrollpos=16
//TESH.alwaysfold=0
function Trig_Ran_04_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0EH'
endfunction

function Trig_Ran_04_Timeout takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,1)
    local unit summoned = LoadUnitHandle(udg_Hashtable,(GetHandleId(caster)+StringHash("Ran01")),1)
    call UnitRemoveAbility( caster,'A0EO' )
    call UnitRemoveAbility( summoned,'A0EK' )
    call UnitRemoveAbility( summoned,'A0EL' )
    call UnitAddAbility( summoned, 'A0EJ' )
    call PauseTimer(t)
    call DestroyTimer(t)
    set t = null
    set caster = null
    set summoned = null
endfunction

function Trig_Ran_04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit summoned = LoadUnitHandle(udg_sht,GetHandleId(caster),0)
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer level = GetUnitAbilityLevel(caster,'A0EH')
    //========
    local real abilitycooldownlv01 = 100
    local real abilitycooldownlv02 = 100
    local real abilitycooldownlv03 = 100
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //======== 
    call UnitAddAbility( caster, 'A0EO' )
    call SetUnitAbilityLevel( caster, 'A0EM', level )
    call SetUnitAbilityLevel( caster, 'A0EN', level )
    
    call SaveUnitHandle(udg_Hashtable,task,1,caster)
    call TimerStart(t,10,false,function Trig_Ran_04_Timeout)
    set t = null
    set caster = null
    set summoned = null
endfunction

//===========================================================================
function InitTrig_Ran04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Chen
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Chen_Conditions takes nothing returns boolean
    if IsUnitIllusion(GetTriggerUnit()) then
        return false
    endif
    return GetUnitTypeId(GetTriggerUnit())=='n02P'
endfunction

function Trig_Chen_Actions takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local unit h = LoadUnitHandle(udg_sht,GetHandleId(u),0)
    local integer task = GetHandleId(h)
    local effect e
    local item w
    local integer i
    local real damage = 0.3*GetUnitState(h,UNIT_STATE_MAX_LIFE)
    
    set i = 0
    loop
        exitwhen i >= bj_MAX_INVENTORY
        set w = UnitItemInSlot(u,i)
        if THD_IsItemTypePrivate(GetItemTypeId(w)) then
            //舞蝶梦丸四种 蓬莱药三种 天狗宝宝 和谐
            call SaveItemHandle(udg_sht,task,i+1,w)
            call SetItemVisible(w,false)
            call SetItemPositionLoc(w,udg_BackStage)
        endif
        set i = i + 1
    endloop
    
    call UnitDamageTarget(h,h,damage,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS)
    call SaveUnitHandle(udg_sht,task,0,null)
    set e = AddSpecialEffectTarget("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",u,"origin")
    call DestroyEffect(e)
    
    call FlushChildHashtable(udg_sht,GetHandleId(u))
    
    set u = null
    set h = null
    set e = null
    set w = null
endfunction

//===========================================================================
function InitTrig_Chen takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Chen02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Chen02_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0LP'
endfunction

function Trig_Chen02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local real a = LoadReal(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local boolean o
    //========
    if t==LoadTimerHandle(udg_ht,GetHandleId(caster),0) then
        set o = GetUnitCurrentOrder(caster)==OrderId("whirlwind")
        if i>0 and o then
            set px = ox + 15.0*Cos(a)
            set py = oy + 15.0*Sin(a)
            call SetUnitXYGround(caster,px,py)
            call SaveInteger(udg_ht,task,1,i - 1)
        else
            if o then
                call IssueImmediateOrder(caster,"stop")
            endif
            call SetUnitFlag(caster,CS_DASHING(),false)
            call SetUnitPathing(caster,true)
            call SetUnitAnimationByIndex(caster,0)
            call DestroyTimer(t)
            call FlushChildHashtable(udg_ht,task)
            call FlushChildHashtable(udg_ht,GetHandleId(caster))
        endif
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
endfunction

function Trig_Chen02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = Atan2(ty-oy,tx-ox)
    local real d = SquareRoot(Pow(ty-oy,2)+Pow(tx-ox,2))
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    set d = RMinBJ(600.0,d)
    set d = RMaxBJ(225.0,d)
    call SetUnitFacing(caster,bj_RADTODEG*a)
    if GetUnitAbilityLevel(caster,'A0EP')==0 then
        call UnitAddAbility(caster,'A0EP')
    endif
    call IssueImmediateOrder(caster,"whirlwind")
    call SetUnitFlag(caster,CS_DASHING(),true)
    call SetUnitPathing(caster,false)
    call SetUnitAnimation(caster,"Spell")
    call SaveTimerHandle(udg_ht,GetHandleId(caster),0,t)
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,1,R2I(d/15.0))
    call SaveReal(udg_ht,task,0,a)
    call TimerStart(t,0.02,true,function Trig_Chen02_Main)
    //========
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Chen02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Chen03
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Chen03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0EQ'
endfunction

function Chen03TimerOut takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,1)
    local unit summoned = LoadUnitHandle(udg_Hashtable,task,2)
    call UnitRemoveAbility(caster,'A0ER')
    call UnitRemoveAbility(summoned,'A0ER')
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_Hashtable,task)
    set t = null
    set caster = null
    set summoned = null
endfunction

function Trig_Chen03_Actions takes nothing returns nothing
    local unit summoned = GetTriggerUnit()
    local unit caster = LoadUnitHandle(udg_sht,GetHandleId(summoned),0)
    local real ox = GetUnitX(summoned)
    local real oy = GetUnitY(summoned)
    local real px = GetUnitX(caster)
    local real py = GetUnitY(caster)
    local effect e1 = AddSpecialEffectTarget("Abilities\\Spells\\Orc\\AncestralSpirit\\AncestralSpiritCaster.mdl",summoned,"origin")
    local effect e2 = AddSpecialEffectTarget("Abilities\\Spells\\Orc\\AncestralSpirit\\AncestralSpiritCaster.mdl",caster,"origin")
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    call SetUnitX(summoned,px)
    call SetUnitY(summoned,py)
    call SetUnitX(caster,ox)
    call SetUnitY(caster,oy)
    call TriggerSleepAction(1)
    call DestroyEffect(e1)
    call DestroyEffect(e2)
    call UnitAddAbility(caster,'A0ER')
    call UnitAddAbility(summoned,'A0ER')
    call SaveUnitHandle(udg_Hashtable,task,1,caster)
    call SaveUnitHandle(udg_Hashtable,task,2,summoned)
    call TimerStart(t,3.5,false,function Chen03TimerOut)
    set summoned = null
    set caster = null
    set e1 = null
    set e2 = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Chen03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initial Ran
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Initial_Ran_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E00G')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

//=====================================  1  ===========================================================

    set gg_trg_Chen = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_Chen, GetOwningPlayer(h), EVENT_PLAYER_UNIT_DEATH, null )
    call TriggerAddCondition( gg_trg_Chen, Condition( function Trig_Chen_Conditions ) )
    call TriggerAddAction( gg_trg_Chen, function Trig_Chen_Actions )
    
    set gg_trg_Chen02 = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_Chen02, GetOwningPlayer(h), EVENT_PLAYER_UNIT_SPELL_EFFECT, null )
    call TriggerAddCondition( gg_trg_Chen02, Condition( function Trig_Chen02_Conditions ) )
    call TriggerAddAction( gg_trg_Chen02, function Trig_Chen02_Actions )
    
    set gg_trg_Ran01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Ran01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Ran01, Condition( function Trig_Ran_01_Conditions ) )
    call TriggerAddAction( gg_trg_Ran01, function Trig_Ran_01_Actions )
    
    set gg_trg_Ran01Up = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Ran01Up, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Ran01Up, Condition( function Trig_Ran01Up_Conditions ) )
    call TriggerAddAction( gg_trg_Ran01Up, function Trig_Ran01Up_Actions )
//=====================================  2  ===========================================================
    set gg_trg_Ran02 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Ran02, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Ran02, Condition( function Trig_Ran_02_Conditions ) )
    call TriggerAddAction( gg_trg_Ran02, function Trig_Ran_02_Actions )
//=====================================  3  ===========================================================
    set gg_trg_Ran03 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Ran03, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Ran03, Condition( function Trig_Ran_03_Conditions ) )
    call TriggerAddAction( gg_trg_Ran03, function Trig_Ran_03_Actions )
//=====================================  4  ===========================================================
    set gg_trg_Ran04 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Ran04, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Ran04, Condition( function Trig_Ran_04_Conditions ) )
    call TriggerAddAction( gg_trg_Ran04, function Trig_Ran_04_Actions )
    
    set gg_trg_Chen03 = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Chen03, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Chen03, Condition( function Trig_Chen03_Conditions ) )
    call TriggerAddAction( gg_trg_Chen03, function Trig_Chen03_Actions )
    
    set h = null
endfunction

function InitTrig_Initial_Ran takes nothing returns nothing
    set gg_trg_Initial_Ran = CreateTrigger()
    call TriggerAddAction( gg_trg_Initial_Ran, function Trig_Initial_Ran_Actions )
endfunction//===========================================================================
// Trigger: Kanako01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Kanako01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0F1' or GetSpellAbilityId()=='A0F0'
endfunction

function Trig_Kanako01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local real tx
    local real ty
    local integer level
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i>0 then
        call SetUnitFlyHeight(u,100.0*(i-1),2000.00)
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        set tx = GetUnitX(u)
        set ty = GetUnitY(u)
        set caster = LoadUnitHandle(udg_ht,task,0)
        set level = LoadInteger(udg_ht,task,0)
        call KillUnit(u)
        set u = CreateUnit(GetOwningPlayer(caster),GPSU(),tx,ty,270.0)
        call UnitAddAbility(u,'A0F5')
        call SetUnitAbilityLevel(u,'A0F5',level)
        call IssueImmediateOrder(u,"stomp")
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl",tx,ty))
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Kanako01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    if IsUnitType(caster,UNIT_TYPE_HERO) then
        set level = level + 2
    else
        set level = 7
    endif
    set u = CreateUnit(GetOwningPlayer(caster),'n031',tx,ty,270.0)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,10)
    call SaveReal(udg_ht,task,0,0.0)
    call TimerStart(t,0.05,true,function Trig_Kanako01_Main)
    //========
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Kanako01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Kanako02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Kanako02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0F4'
endfunction  

function Trig_Kanako02_Target takes nothing returns boolean
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_DEAD) then
        return false
    endif
    
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_MECHANICAL) then
        return false
    endif
    
    if GetUnitAbilityLevel(GetFilterUnit(),'Avul')!=0 then
        return false
    endif
    
    if IsUnitWard(GetFilterUnit()) then
        return false
    endif
    
    return true
endfunction

function Trig_Kanako02_Actions takes nothing returns nothing
    local unit u1 = GetTriggerUnit()
    local unit u2 = GetSpellTargetUnit()
    local player who = GetOwningPlayer(u1)
    local integer level = GetUnitAbilityLevel(u1,GetSpellAbilityId())
    local integer i = 1
    local integer n = (level + 1 )*2
    local real ox
    local real oy
    local unit u
    local group g
    local boolexpr f = Filter(function Trig_Kanako02_Target)
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set u = null
            set u1 = null
            set u2 = null
            set g = null
            set f = null
            return
        endif
    endif
    //======== 
    loop
        set ox = GetUnitX(u1)
        set oy = GetUnitY(u1)
        set u = CreateUnit(who,GPSU(),ox,oy,bj_UNIT_FACING)
        if IsUnitAlly(u2,who) then
            call UnitAddAbility(u,'A0F2')
            call SetUnitAbilityLevel(u,'A0F2',level)
            call IssueTargetOrder(u,"healingwave",u2)
        else
            call UnitAddAbility(u,'A0F3')
            call SetUnitAbilityLevel(u,'A0F3',level)
            call IssueTargetOrder(u,"chainlightning",u2)
        endif
        call TriggerSleepAction(0.20)
        
        call RemoveUnit(u)
        set u1 = u2
        set ox = GetUnitX(u1)
        set oy = GetUnitY(u1)
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,ox,oy,500.00,f)
        call GroupRemoveUnit(g,u1)
        set u2 = GroupPickRandomUnit(g)
        call DestroyGroup(g)
        
        set i = i + 1
        exitwhen i > n
    endloop
    
    call DestroyBoolExpr(f)
    set u = null
    set u1 = null
    set u2 = null
    set g = null
    set f = null
endfunction

//===========================================================================
function InitTrig_Kanako02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Kanako03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Kanako03_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0F6'
endfunction

function Trig_Kanako03_Target takes nothing returns boolean
    if IsUnitDead(GetFilterUnit()) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) then
        return false
    endif
    if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit())) then
        return false
    endif
    if GetUnitFlag(GetFilterUnit(),CS_LOST()) or GetUnitFlag(GetFilterUnit(),CS_DASHING()) then
        return false
    endif
    return true
endfunction

function Trig_Kanako03_Shoot_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local unit u = LoadUnitHandle(udg_ht,task,2)
    local real px
    local real py
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i>0 then
        call SetUnitX(u,GetUnitX(target))
        call SetUnitY(u,GetUnitY(target))
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        if IsUnitType(target,UNIT_TYPE_STRUCTURE) then
            call UnitDamageTarget(caster,target,50.00,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
        else
            call UnitDamageTarget(caster,target,100.00,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
        endif
        call KillUnit(u)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_Kanako03_Shoot takes unit caster,unit target,integer level returns nothing
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit u = CreateUnit(GetOwningPlayer(caster),'n03C',GetUnitX(target),GetUnitY(target),0.0)
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveUnitHandle(udg_ht,task,2,u)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,16)
    call TimerStart(t,0.05,true,function Trig_Kanako03_Shoot_Main)
    //========
    set u = null
    set t = null
endfunction

function Trig_Kanako03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local location target = GetSpellTargetLoc()
    local location p
    local unit v
    local integer i
    local integer n = level*2
    local real s = 1.00/level
    local group g = CreateGroup()
    local boolexpr f = Filter(function Trig_Kanako03_Target)
    //========
    set i = 1
    loop
        exitwhen i > n
        call GroupEnumUnitsInRangeOfLoc(g,target,200.00,f)
        set v = GroupPickRandomUnit(g)
        if v==null then
            set p = GetRandomLocInRange(target,200.0)
            call DestroyEffect(AddSpecialEffectLoc("Abilities\\Spells\\NightElf\\Starfall\\StarfallTarget.mdl",p))
            call RemoveLocation(p)
        else
            call Trig_Kanako03_Shoot(caster,v,level)
        endif
        call GroupClear(g)
        set i = i + 1
        call TriggerSleepAction(s)
    endloop
    //========
    call DestroyGroup(g)
    call RemoveLocation(target)
    set caster = null
    set target = null
    set p = null
    set g = null
    set f = null
    set v = null
endfunction

//===========================================================================
function InitTrig_Kanako03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Kanako04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Kanako04_Thunder_Effect takes unit caster,integer level,real px,real py returns nothing
    local unit u
    local unit v
    local group g = CreateGroup()
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    //========
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),px,py,270.0)
    call UnitAddAbility(u,'A0FF')
    call SetUnitAbilityLevel(u,'A0FF',level)
    call GroupEnumUnitsInRange(g,px,py,220.0,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitAlive(v) and not IsUnitType(v,UNIT_TYPE_MECHANICAL) then
            call IssueTargetOrder(u,"thunderbolt",v)
        endif
    endloop
    call DestroyGroup(g)
    //========
    set u = null
    set v = null
    set g = null
    set iff = null
endfunction

function Trig_Kanako04_Thunder_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u
    local real le 
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px 
    local real py 
    local real a
    local boolean k = LoadBoolean(udg_sht,GetHandleId(caster),0)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if IsUnitAliveBJ(caster) and (k or i<5) then
        set a = GetUnitFacing(caster) + i*90.0 + 90.0 * GetRandomInt(0,100)/100
        set le = GetRandomInt(200,600)
        set px = ox + le*CosBJ(a)
        set py = oy + le*SinBJ(a)
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Monsoon\\MonsoonBoltTarget.mdl",px,py))
        //call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\Thunderclap\\ThunderClapCaster.mdl",px,py))
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Monsoon\\MonsoonBoltTarget.mdl",px,py))
        if GetUnitTypeId(caster)=='U00M' then
            
            call Trig_Kanako04_Thunder_Effect(caster,level,px,py)
            
            call SetUnitAbilityLevel(caster,'A0FB',level)
            
            set u = LoadUnitHandle(udg_sht,GetHandleId(caster),0)
            if u != null then
                call SetUnitX(u,ox)
                call SetUnitY(u,oy)
            endif
            set u = LoadUnitHandle(udg_sht,GetHandleId(caster),1)
            if u != null then
                call SetUnitX(u,ox)
                call SetUnitY(u,oy)
            endif
            set u = LoadUnitHandle(udg_sht,GetHandleId(caster),2)
            if u != null then
                call SetUnitX(u,ox)
                call SetUnitY(u,oy)
            endif
            
            if GetUnitAbilityLevel(caster,'A0FE') == 0 then
                call UnitAddAbility(caster,'A0FE')
            endif
            set level = GetUnitAbilityLevel(caster,'A0F1')
            call SetUnitAbilityLevel(caster,'A0FE',level)
            
            if GetUnitAbilityLevel(caster,'A0F8') == 0 then
                call UnitAddAbility(caster,'A0F8')
            endif
            set level = GetUnitAbilityLevel(caster,'A0F4')
            call SetUnitAbilityLevel(caster,'A0F8',level)
            
            if GetUnitAbilityLevel(caster,'A0FC') == 0 then
                call UnitAddAbility(caster,'A0FC')
            endif
            set level = GetUnitAbilityLevel(caster,'A0F6')
            call SetUnitAbilityLevel(caster,'A0FC',level)
            
        endif
        call SaveInteger(udg_ht,task,1,i + 1)
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        set u = LoadUnitHandle(udg_sht,GetHandleId(caster),0)
        if u != null then
            call RemoveUnit(u)
        endif
        set u = LoadUnitHandle(udg_sht,GetHandleId(caster),1)
        if u != null then
            call RemoveUnit(u)
        endif
        set u = LoadUnitHandle(udg_sht,GetHandleId(caster),2)
        if u != null then
            call RemoveUnit(u)
        endif
        call DebugMsg("MOF END")
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Kanako04_Thunder takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    call DebugMsg("MOF START")
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,0)
    call TimerStart(t,0.75,true,function Trig_Kanako04_Thunder_Main)
    //========
    set caster = null
    set t = null
endfunction

function Trig_Kanako04_Conditions takes nothing returns boolean
    if GetSpellAbilityId() != 'A0F7' then
        return false
    endif
    if GetUnitTypeId(GetTriggerUnit())=='U00M' then
        return true
    endif
    if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
        call Trig_Kanako04_Thunder()
    endif
    return false
endfunction

function Trig_Kanako04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local integer level = GetUnitAbilityLevel(caster,'A0F7')
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local timer t
    local integer task
    //========
    if GetTriggerEventId()==EVENT_UNIT_SPELL_FINISH then
    
        call SaveBoolean(udg_sht,GetHandleId(caster),0,true)
        call DebugMsg("MOF ON")
        
        set u = CreateUnit(GetOwningPlayer(caster),'n032',ox,oy,GetUnitFacing(caster))
        call SetUnitFlyHeight(u,-50,1000.0)
        call SaveUnitHandle(udg_sht,GetHandleId(caster),0,u)
        
        set u = CreateUnit(GetOwningPlayer(caster),'n032',ox,oy,GetUnitFacing(caster))
        call SetUnitFlyHeight(u,-50,1000.0)
        call SaveUnitHandle(udg_sht,GetHandleId(caster),1,u)
        
        set u = CreateUnit(GetOwningPlayer(caster),'n032',ox,oy,GetUnitFacing(caster))
        call SetUnitFlyHeight(u,-50,1000.0)
        call SaveUnitHandle(udg_sht,GetHandleId(caster),2,u)
        
        call AddSpecialEffectTarget("Light.mdl",u,"chest")
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ReviveHuman\\ReviveHuman.mdl",u,"origin"))
        
        set level = GetUnitAbilityLevel(caster,'A0F1')
        if level > 0 then
            call UnitAddAbility(caster,'A0FE')
            call SetUnitAbilityLevel(caster,'A0FE',level)
        endif
        
        set level = GetUnitAbilityLevel(caster,'A0F4')
        if level > 0 then
            call UnitAddAbility(caster,'A0F8')
            call SetUnitAbilityLevel(caster,'A0F8',level)
        endif
        
        set level = GetUnitAbilityLevel(caster,'A0F6')
        if level > 0 then
            call UnitAddAbility(caster,'A0FC')
            call SetUnitAbilityLevel(caster,'A0FC',level)
        endif
        
        call SetUnitAbilityLevel(caster,'A0FB',level)
        
    else
        
        call SaveBoolean(udg_sht,GetHandleId(caster),0,false)
        set u = LoadUnitHandle(udg_sht,GetHandleId(caster),0)
        if u != null then
            call RemoveUnit(u)
        endif
        set u = LoadUnitHandle(udg_sht,GetHandleId(caster),1)
        if u != null then
            call RemoveUnit(u)
        endif
        set u = LoadUnitHandle(udg_sht,GetHandleId(caster),2)
        if u != null then
            call RemoveUnit(u)
        endif
        
        call DebugMsg("MOF OFF")
        
    endif
    //========
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Kanako04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: KanakoEX01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_KanakoEX01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0FE'
endfunction

function Trig_KanakoEX01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u
    local location o
    local location p
    local real a = LoadReal(udg_ht,task,0)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i>0 and GetUnitCurrentOrder(caster)==OrderId("starfall") then
        set o = GetUnitLoc(caster)
        set p = GetRandomLocInRange(o,300.0)
        set u = CreateUnitAtLoc(GetOwningPlayer(caster),GPSU(),p,270.0)
        call UnitAddAbility(u,'A0F0')
        call SetUnitAbilityLevel(u,'A0F0',level)
        call IssuePointOrderLoc(u,"dreadlordinferno",p)
        call RemoveLocation(o)
        call RemoveLocation(p)
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set o = null
    set p = null
endfunction

function Trig_KanakoEX01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local integer n = level + 4
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,n)
    call TimerStart(t,3.50/n,true,function Trig_KanakoEX01_Main)
    //========
    set caster = null
    set target = null
    set t = null
endfunction

//===========================================================================
function InitTrig_KanakoEX01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: KanakoEX02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_KanakoEX02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0F8'
endfunction

function Trig_KanakoEX02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
        call UnitAddAbility(caster,'A0F9')
        call SetUnitAbilityLevel(caster,'A0F9',level)
    else
        call UnitRemoveAbility(caster,'A0F9')
    endif
    //========
    set caster = null
endfunction

//===========================================================================
function InitTrig_KanakoEX02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: KanakoEX03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_KanakoEX03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0FC'
endfunction

function GroupKill takes nothing returns nothing
    call KillUnit(GetEnumUnit())
endfunction

function Trig_Kanako03_Thunder takes unit caster,integer level,location p returns nothing
    local real px = GetLocationX(p)
    local real py = GetLocationY(p)
    local real h = GetLocationZ(p)
    local unit u
    local unit v
    local lightning e
    local group g = CreateGroup()
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    //========
    set e = AddLightningEx("FORK",false,px,py,h+800.0,px,py,h)
    call TSU_DestroyLightning(0.50,e)
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),px,py,270.0)
    call UnitAddAbility(u,'A0FF')
    call SetUnitAbilityLevel(u,'A0FF',4)
    call GroupEnumUnitsInRange(g,px,py,220.0,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitAlive(v) then
            call IssueTargetOrder(u,"thunderbolt",v)
        endif
    endloop
    call DestroyGroup(g)
    call DestroyEffect(AddSpecialEffectLoc("Abilities\\Weapons\\ChimaeraLightningMissile\\ChimaeraLightningMissile.mdl",p))
    //========
    set g = null
    set u = null
    set v = null
    set e = null
    set iff = null
endfunction

function Trig_KanakoEX03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local location target = GetSpellTargetLoc()
    local location p
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real px
    local real py
    local real s
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local integer i
    local integer n
    local group g = CreateGroup()
    //local timer t = CreateTimer()
    //local integer task = GetHandleId(t)
    //========
    set u = CreateUnit(GetOwningPlayer(caster),'n033',tx,ty,0.0)
    call GroupAddUnit(g,u)
    //========
    set n = level/2 + 2
    set s = 360.0/n
    set i = 0
    loop
        exitwhen i>=n
        set u = CreateUnit(GetOwningPlayer(caster),'n00R',tx,ty,i*s)
        call GroupAddUnit(g,u)
        call UnitApplyTimedLife(u,'BTLF',4.50)
        call UnitAddAbility(u,'A0FD')
        call SetUnitAbilityLevel(u,'A0FD',level)
        set px = tx + 100.0*CosBJ(i*s)
        set py = ty + 100.0*SinBJ(i*s)
        call IssuePointOrder(u,"tornado",px,py)
        set i = i + 1
    endloop
    //========
    set n = level*2
    set s = 2.0/level
    set i = 0
    loop
        exitwhen i>=n
        exitwhen GetUnitCurrentOrder(caster)!=OrderId("blizzard")
        set p = GetRandomLocInRange(target,250.0)
        call Trig_Kanako03_Thunder(caster,level,p)
        call RemoveLocation(p)
        set i = i + 1
        call TriggerSleepAction(s)
    endloop
    //========
    call ForGroup(g,function GroupKill)
    call RemoveLocation(target)
    call DestroyGroup(g)
    //========
    set caster = null
    set target = null
    set p = null
    set u = null
    set g = null
endfunction

//===========================================================================
function InitTrig_KanakoEX03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Init Kanako
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Kanako_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('U00L')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_Kanako01 = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_Kanako01, GetOwningPlayer(h), EVENT_PLAYER_UNIT_SPELL_EFFECT, null )
    call TriggerAddCondition( gg_trg_Kanako01, Condition( function Trig_Kanako01_Conditions ) )
    call TriggerAddAction( gg_trg_Kanako01, function Trig_Kanako01_Actions )
    
    set gg_trg_Kanako02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kanako02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Kanako02, Condition( function Trig_Kanako02_Conditions ) )
    call TriggerAddAction( gg_trg_Kanako02, function Trig_Kanako02_Actions )
    
    set gg_trg_Kanako03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kanako03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Kanako03, Condition( function Trig_Kanako03_Conditions ) )
    call TriggerAddAction( gg_trg_Kanako03, function Trig_Kanako03_Actions )
    
    set gg_trg_Kanako04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kanako04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerRegisterUnitEvent( gg_trg_Kanako04, h, EVENT_UNIT_SPELL_FINISH )
    call TriggerAddCondition( gg_trg_Kanako04, Condition( function Trig_Kanako04_Conditions ) )
    call TriggerAddAction( gg_trg_Kanako04, function Trig_Kanako04_Actions )
    
    set gg_trg_KanakoEX01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_KanakoEX01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_KanakoEX01, Condition( function Trig_KanakoEX01_Conditions ) )
    call TriggerAddAction( gg_trg_KanakoEX01, function Trig_KanakoEX01_Actions )
    
    set gg_trg_KanakoEX02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_KanakoEX02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerRegisterUnitEvent( gg_trg_KanakoEX02, h, EVENT_UNIT_SPELL_ENDCAST )
    call TriggerAddCondition( gg_trg_KanakoEX02, Condition( function Trig_KanakoEX02_Conditions ) )
    call TriggerAddAction( gg_trg_KanakoEX02, function Trig_KanakoEX02_Actions )
    
    set gg_trg_KanakoEX03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_KanakoEX03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_KanakoEX03, Condition( function Trig_KanakoEX03_Conditions ) )
    call TriggerAddAction( gg_trg_KanakoEX03, function Trig_KanakoEX03_Actions )
    
    call UnitMakeAbilityPermanent(h,true,'A0IM')
    call UnitMakeAbilityPermanent(h,true,'A0IO')
    
    call SetPlayerTechResearched(GetOwningPlayer(h),'R004',1)
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Kanako takes nothing returns nothing
    set gg_trg_Init_Kanako = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Kanako, function Trig_Init_Kanako_Actions )
endfunction

//===========================================================================
// Trigger: SuwakoEx
//===========================================================================
function Trig_SuwakoEx_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0TI'
endfunction

function Trig_SuwakoEx_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local group m = LoadGroupHandle(udg_ht,task,2)
    local group g
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local integer i = LoadInteger(udg_ht,task,3)
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local real px 
    local real py 
    local real a = LoadReal(udg_ht,task,4)
    local real d = LoadReal(udg_ht,task,5)
    //========
    if i>0 then
        set px = ox + d*Cos(a)
        set py = oy + d*Sin(a)
        if IsTerrainPathable(px,py,PATHING_TYPE_FLYABILITY)==false then
            call SetUnitXY(u,px,py)
            call SaveInteger(udg_ht,task,3,i - 1)
        else
            call SaveInteger(udg_ht,task,3,0)
        endif
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,px,py,60.0,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitAliveBJ(v) and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and IsUnitInGroup(v,m)==false then
                call GroupAddUnit(m,v) 
                call UnitDamageTarget(caster,v,30+GetHeroInt(caster,true)*1.20,true,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_METAL_HEAVY_SLICE)
                call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\HumanBlood\\BloodElfSpellThiefBlood.mdl",GetUnitX(v),GetUnitY(v)))
            endif
        endloop
        call DestroyGroup(g)
    else
        call RemoveUnit(u)
        call PauseTimer(t)
        call DestroyTimer(t)
        call DestroyGroup(m)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set m = null
    set g = null
    set iff = null
endfunction

function Trig_SuwakoEx_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real a = GetUnitFacing(caster)/bj_RADTODEG
    local group m = CreateGroup()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 4
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
    endif
    //========
    set u = CreateUnit(GetOwningPlayer(caster),'e01Y',ox,oy,GetUnitFacing(caster))
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveGroupHandle(udg_ht,task,2,m)
    call SaveInteger(udg_ht,task,3,35)
    call SaveReal(udg_ht,task,4,a)
    call SaveReal(udg_ht,task,5,20.0)
    call TimerStart(t,0.02,true,function Trig_SuwakoEx_Main)
    set caster = null
    set u = null
    set m = null 
    set t = null
endfunction

//===========================================================================
function InitTrig_SuwakoEx takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Suwako01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Suwako01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0FI'
endfunction

function Trig_Suwako01_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit e1 = LoadUnitHandle(udg_ht,task,0)
    local unit e2 = LoadUnitHandle(udg_ht,task,1)
    local unit e3 = LoadUnitHandle(udg_ht,task,2)
    local unit e4 = LoadUnitHandle(udg_ht,task,3)
    local unit e5 = LoadUnitHandle(udg_ht,task,4)
    local unit e6 = LoadUnitHandle(udg_ht,task,5)
    call KillUnit(e1)
    call KillUnit(e2)
    call KillUnit(e3)
    call KillUnit(e4)
    call KillUnit(e5)
    call KillUnit(e6)
    call RemoveUnit(e1)
    call RemoveUnit(e2)
    call RemoveUnit(e3)
    call RemoveUnit(e4)
    call RemoveUnit(e5)
    call RemoveUnit(e6)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set e1 = null
    set e2 = null
    set e3 = null
    set e4 = null
    set e5 = null
    set e6 = null
endfunction

function Trig_Suwako01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local real ox = LoadReal(udg_ht,task,1)
    local real oy = LoadReal(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,3)
    local group g
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local unit u
    local unit v
    local unit w
    if i > 0 then
        set i = i - 1 
        call SaveInteger(udg_ht,task,3,i)
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,ox,oy,300.0,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
                set w = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,0)
                call UnitAddAbility(w,'A0OP')
                call IssueTargetOrder(w,"thunderbolt",v)
            endif
        endloop
        call DestroyGroup(g)
    else
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set g = null
    set iff = null
    set u = null
    set v = null
    set w = null
endfunction

function Trig_Suwako01_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local timer t2 = CreateTimer()
    local integer task2 = GetHandleId(t2)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local unit e1 = CreateUnit(GetOwningPlayer(caster),'e01L',ox,oy,0)
    local unit e2 = CreateUnit(GetOwningPlayer(caster),'e01L',ox,oy,0)
    local unit e3 = CreateUnit(GetOwningPlayer(caster),'e01L',ox,oy,0)
    local unit e4 = CreateUnit(GetOwningPlayer(caster),'e01L',ox,oy,0)
    local unit e5 = CreateUnit(GetOwningPlayer(caster),'e01L',ox,oy,0)
    local unit e6 = CreateUnit(GetOwningPlayer(caster),'e01L',ox,oy,0)
    local unit w
    //========
    local real abilitycooldownlv01 = 16
    local real abilitycooldownlv02 = 16
    local real abilitycooldownlv03 = 16
    local real abilitycooldownlv04 = 16
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call SetUnitPathing(e1,false)
    call SetUnitPathing(e2,false)
    call SetUnitPathing(e3,false)
    call SetUnitPathing(e4,false)
    call SetUnitPathing(e5,false)
    call SetUnitPathing(e6,false)
    call SetUnitXY(e1,ox,oy)
    call SetUnitXY(e2,ox,oy)
    call SetUnitXY(e3,ox,oy)
    call SetUnitXY(e4,ox,oy)
    call SetUnitXY(e5,ox,oy)
    call SetUnitXY(e6,ox,oy)
    call SaveUnitHandle(udg_ht,task,0,e1)
    call SaveUnitHandle(udg_ht,task,1,e2)
    call SaveUnitHandle(udg_ht,task,2,e3)
    call SaveUnitHandle(udg_ht,task,3,e4)
    call SaveUnitHandle(udg_ht,task,4,e5)
    call SaveUnitHandle(udg_ht,task,5,e6)
    call TimerStart(t,1.20+0.20*level,false,function Trig_Suwako01_Clear)

    call SaveUnitHandle(udg_ht,task2,0,caster)
    call SaveReal(udg_ht,task2,1,ox)
    call SaveReal(udg_ht,task2,2,oy)
    call SaveInteger(udg_ht,task2,3,level+6)
    call TimerStart(t2,0.20,true,function Trig_Suwako01_Main)

    set t = null
    set t2 = null
    set caster = null
    set e1 = null
    set e2 = null
    set e3 = null
    set e4 = null
    set e5 = null
    set e6 = null
    set w = null
endfunction

//===========================================================================
function InitTrig_Suwako01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Suwako02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Suwako02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0FJ'
endfunction

function Trig_Suwako02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local integer i
    local integer n
    local integer level = GetUnitAbilityLevel(caster,'A0FJ')
    local unit u
    local unit v
    local group g = CreateGroup()
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    //========
    local real abilitycooldownlv01 = 14
    local real abilitycooldownlv02 = 14
    local real abilitycooldownlv03 = 14
    local real abilitycooldownlv04 = 14
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,0.0)
    call UnitAddAbility(u,'A0FH')
    call SetUnitAbilityLevel(u,'A0FH',level)
    call IssueTargetOrder(u,"chainlightning",target)
    call GroupEnumUnitsInRange(g,tx,ty,420.0,iff)
    call GroupRemoveUnit(g,target)
    if level<=2 then
        set n = 1
    else
        set n = 3
    endif
    set i = 0
    loop
        set v = GroupPickRandomUnit(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitAliveBJ(v) and not IsUnitType(v,UNIT_TYPE_MECHANICAL) then
            set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,0.0)
            call UnitAddAbility(u,'A0FH')
            call SetUnitAbilityLevel(u,'A0FH',level)
            call IssueTargetOrder(u,"chainlightning",v)
            set i = i + 1
        endif
        exitwhen i >= n
    endloop
    call DestroyGroup(g)
    //========
    set caster = null
    set target = null
    set u = null
    set v = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_Suwako02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Suwako03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Suwako03_Conditions takes nothing returns boolean
    return false
endfunction

function Trig_Suwako03_Actions takes nothing returns nothing
    
endfunction

//===========================================================================
function InitTrig_Suwako03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Suwako04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Suwako04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0FL'
endfunction

function Trig_Suwako04_Effect_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local integer level = LoadInteger(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,3)
    local real h = (i-20)*(i-20)
    local unit w 
    call SetUnitFlyHeight(target,450-h,0)
    call SaveInteger(udg_ht,task,3,i+1)
    if i > 40 then
        call SetUnitFlyHeight(target,GetUnitDefaultFlyHeight(target),0)
        call SetUnitPathing(target,true)
        call SetUnitFlag(target,CS_REPEL(),false)
        call SetUnitFlag(target,CS_DRAG(),false)
        set w = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0)
        call UnitAddAbility(w,'A0FM')
        call SetUnitAbilityLevel(w,'A0FM',level)
        call IssueTargetOrder(w,"thunderbolt",target)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set target = null
    set w = null
endfunction

function Trig_Suwako04_Effect_Start takes unit caster,unit target,integer level returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local real ox = GetUnitX(target)
    local real oy = GetUnitY(target)
    call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Naga\\NagaDeath\\NagaDeath.mdl",ox,oy))
    call SetUnitPathing(target,false)
    call EnableHeight(target)
    call SetUnitFlag(target,CS_REPEL(),true)
    call SetUnitFlag(target,CS_DRAG(),true)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveInteger(udg_ht,task,2,level)
    call SaveInteger(udg_ht,task,3,1)
    call TimerStart(t,0.02,true,function Trig_Suwako04_Effect_Main)
    set t = null
endfunction

function Trig_Suwako04_Effect takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i
    local unit h
    if IsUnitAliveBJ(caster) then
        set i = 0
        loop
            exitwhen i>=12
            set h = udg_PlayerHeroes[i]
            if h!= null and IsUnitAliveBJ(h) and IsUnitEnemy(h,GetOwningPlayer(caster)) and IsUnitVisible(h,GetOwningPlayer(caster)) then
                call Trig_Suwako04_Effect_Start(caster,h,level)
            endif
            set i = i + 1
        endloop
    endif
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set caster = null
    set h = null
endfunction

function Trig_Suwako04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer level = GetUnitAbilityLevel(caster,'A0FL')
    //========
    local real abilitycooldownlv01 = 100
    local real abilitycooldownlv02 = 80
    local real abilitycooldownlv03 = 60
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    call SaveInteger(udg_ht,task,0,level)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call TimerStart(t,1.00,false,function Trig_Suwako04_Effect)
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Suwako04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Init Suwako
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Suwako_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H012')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set gg_trg_SuwakoEx = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_SuwakoEx, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_SuwakoEx, Condition( function Trig_SuwakoEx_Conditions ) )
    call TriggerAddAction( gg_trg_SuwakoEx, function Trig_SuwakoEx_Actions )
    
    set gg_trg_Suwako01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Suwako01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Suwako01, Condition( function Trig_Suwako01_Conditions ) )
    call TriggerAddAction( gg_trg_Suwako01, function Trig_Suwako01_Actions )
    
    set gg_trg_Suwako02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Suwako02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Suwako02, Condition( function Trig_Suwako02_Conditions ) )
    call TriggerAddAction( gg_trg_Suwako02, function Trig_Suwako02_Actions )
    
    set gg_trg_Suwako03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Suwako03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Suwako03, Condition( function Trig_Suwako03_Conditions ) )
    call TriggerAddAction( gg_trg_Suwako03, function Trig_Suwako03_Actions )
    
    set gg_trg_Suwako04 = CreateTrigger()
    //call TriggerRegisterUnitEvent( gg_trg_Suwako04, h, EVENT_UNIT_HERO_SKILL )
    call TriggerRegisterUnitEvent( gg_trg_Suwako04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Suwako04, Condition( function Trig_Suwako04_Conditions ) )
    call TriggerAddAction( gg_trg_Suwako04, function Trig_Suwako04_Actions )
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Suwako takes nothing returns nothing
    set gg_trg_Init_Suwako = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Suwako, function Trig_Init_Suwako_Actions )
endfunction
//===========================================================================
// Trigger: Pachouli Attack
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Pachouli_Attack_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetAttacker()) == 'U00N'
endfunction

function Trig_Pachouli_Attack_Frame takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local unit u
    local real a
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local boolean k = udg_SK_Pachi04_Target==target
    //========
    call SaveInteger(udg_ht,task,1,i + 1)
    if k and i<=8 and IsUnitAliveBJ(caster) and IsUnitAliveBJ(target) then
        if i==0 then
            call SetUnitTimeScale(caster,1.0)
            call SetUnitAnimation(caster,"attack")
            call TimerStart(t,0.05,true,function Trig_Pachouli_Attack_Frame)
        elseif i==4 then
            //0.2s 初始火系魔法 正前方抬手 纯法术伤害
            set u = LoadUnitHandle(udg_ht,task,2)
            call SetUnitX(u,ox)
            call SetUnitY(u,oy)
            if IsUnitType(target,UNIT_TYPE_STRUCTURE) then
                call SetUnitAbilityLevel(u,'A0G0',level)
                call IssueTargetOrder(u,"thunderbolt",target)
            else
                call SetUnitAbilityLevel(u,'A0FS',level)
                call IssueTargetOrder(u,"deathcoil",target)
            endif
        elseif i==2 and level>=2 then
            //0.1s Lv1.金元素魔法 左手边上方 两下纯物理伤害
            set a = AngleBetweenUnits(caster,target)
            set u = CreateUnit(GetOwningPlayer(caster),'n038',ox,oy,a)
            call SetUnitX(u,ox)
            call SetUnitY(u,oy)
            call IssueTargetOrder(u,"attack",target)
            call UnitApplyTimedLife(u,'BTLF',1.5)
        elseif i==6 and level>=3 then
            //0.3s Lv2.地元素魔法 后脑勺上方 炮击型混合伤害
            set a = AngleBetweenUnits(caster,target)
            set u = CreateUnit(GetOwningPlayer(caster),'n039',ox,oy,a)
            call IssueTargetOrder(u,"attackground",target)
            call UnitApplyTimedLife(u,'BTLF',1.5)
        elseif i==8 and level>=4 then
            //0.4s Lv3.水系魔法 右手边上方 有AOE魔法攻击和冰霜减速效果
            set a = AngleBetweenUnits(caster,target)
            set u = CreateUnit(GetOwningPlayer(caster),'n03A',ox,oy,a)
            call SetUnitX(u,ox)
            call SetUnitY(u,oy)
            call IssueTargetOrder(u,"attack",target)
            call UnitApplyTimedLife(u,'BTLF',1.5)
        endif
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        call SetUnitPosition(u,ox,oy)
    endif
    //========
    set t = null
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_Pachouli_Attack_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local unit u = LoadUnitHandle(udg_sht,GetHandleId(caster),0)
    local real a = GetUnitFacing(caster)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    if u==null or IsUnitDeadBJ(u) then
        set u = CreateUnit(GetOwningPlayer(caster),'n037',ox,oy,a)
        call SaveUnitHandle(udg_sht,GetHandleId(caster),0,u)
    endif
    call SetUnitState(u,UNIT_STATE_LIFE,500.0)
    call SetUnitPosition(u,ox,oy)
    set level = 1
    if GetUnitAbilityLevel(caster,'B03W')>0 and not IsUnitIllusion(caster) then
        set level = GetUnitAbilityLevel(caster,'A0FV')
        set ox = GetUnitState(caster,UNIT_STATE_MANA)
        set oy = 25.0*level
        if ox>=oy then
            call SetUnitState(caster,UNIT_STATE_MANA,ox-oy)
            call SetUnitAbilityLevel(caster,'A0GI',level)
            set level = 1 + level
        else
            call UnitRemoveAbility(caster,'A0GI')
            set level = 1
        endif
    else
        call UnitRemoveAbility(caster,'A0GI')
    endif
    call SetUnitTimeScale(caster,1.0)
    call SetUnitAnimation(caster,"stand")
    //========
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,0)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveUnitHandle(udg_ht,task,2,u)
    set udg_SK_Pachi04_Target = target
    call TimerStart(t,0.01,false,function Trig_Pachouli_Attack_Frame)
    //========
    set caster = null
    set target = null
    set t = null
    set u = null
endfunction

function Trig_Pachouli_Attack_Cancel takes nothing returns boolean
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_ISSUED_TARGET_ORDER then
        set udg_SK_Pachi04_Target = GetOrderTargetUnit()
        return false
    endif
    set udg_SK_Pachi04_Target = null
    return false
endfunction

//===========================================================================
function InitTrig_Pachouli_Attack takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Pachouli01
//===========================================================================
function Trig_Pachouli01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0TF'
endfunction

function Trig_Pachouli01_Damage takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local integer level = LoadInteger(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,3)
    local integer j = LoadInteger(udg_ht,task,4)
    local real damage = ((50+level*50+(level+1)*GetHeroInt(caster,true))*i/250)/5.0
    local integer stunlevel = R2I(i/25*3)
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local unit u
    if j<5 then
        if j == 0 then
            if stunlevel == 10 and i != 250 then
                set stunlevel = 9
            endif
            set u = CreateUnit(GetOwningPlayer(caster),'n001',tx,ty,0.0)
            call UnitAddAbility(u,'A0TG')
            call SetUnitAbilityLevel(u,'A0TG',stunlevel)
            call IssueTargetOrder(u,"thunderbolt",target)
            if i == 250 then
                call CastSpell(caster,"日符「皇家圣焰」！！！")
            else
                call CastSpell(caster,"圣焰!!!")
            endif
        endif
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl",tx,ty))
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile.mdl",target,"chest"))
        if i != 300 then
            set damage = damage * 0.80
        endif
        call UnitDamageTarget(caster,target,damage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC, WEAPON_TYPE_WHOKNOWS)
        call SaveInteger(udg_ht,task,4,j + 1)
    else
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_Pachouli01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local integer level = LoadInteger(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,3)
    local effect e1 = LoadEffectHandle(udg_ht,task,4)
    local effect e2 = LoadEffectHandle(udg_ht,task,5)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local boolean k = false
    local boolean l = false
    local timer t2
    local integer task2
    //========
    if GetUnitCurrentOrder(caster)!=OrderId("channel") then
        set k = true
    elseif i < 250 then
        call SaveInteger(udg_ht,task,3,i + 1)
        if SquareRoot((ox-tx)*(ox-tx)+(oy-ty)*(oy-ty)) > 1000.0 then
            set l = true
        endif
    else
        set l = true
    endif
    if l then
        call DestroyEffect(e1)
        call DestroyEffect(e2)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        call SetUnitAnimation(caster,"spell")
        call SetUnitTimeScale(caster,1.0)
        set t2 = CreateTimer()
        set task2 = GetHandleId(t2)
        call SaveUnitHandle(udg_ht,task2,0,caster)
        call SaveUnitHandle(udg_ht,task2,1,target)
        call SaveInteger(udg_ht,task2,2,level)
        call SaveInteger(udg_ht,task2,3,i)
        call SaveInteger(udg_ht,task2,4,0)
        call TimerStart(t2,0.1,true,function Trig_Pachouli01_Damage)
    endif
    if k then
        call DestroyEffect(e1)
        call DestroyEffect(e2)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set target = null
    set e1 = null
    set e2 = null
    set t2 = null
endfunction

function Trig_Pachouli01_Actions takes nothing returns nothing
    local timer t
    local integer task
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0TF')
    local effect e1
    local effect e2
    //========
    local real abilitycooldownlv01 = 16
    local real abilitycooldownlv02 = 14
    local real abilitycooldownlv03 = 12
    local real abilitycooldownlv04 = 10
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set t = null
            set caster = null
            set target = null
            set e1 = null
            set e2 = null
            return
        endif
    endif
    //======== 
    call SetUnitAnimation(caster,"spell channel")
    call SetUnitTimeScale(caster,1.2)
    set t = CreateTimer()
    set task = GetHandleId(t)
    set e1 = AddSpecialEffectTarget("RoyalFlareLockOn.mdl",target,"origin")
    set e2 = AddSpecialEffectTarget("LightCircle45g.mdl",caster,"origin")
    call CastSpell(caster,"%$%￡*&@~#……")
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveInteger(udg_ht,task,2,level)
    call SaveInteger(udg_ht,task,3,0)
    call SaveEffectHandle(udg_ht,task,4,e1)
    call SaveEffectHandle(udg_ht,task,5,e2)
    call TimerStart(t,0.01,true,function Trig_Pachouli01_Main)
    //========
    set t = null
    set caster = null
    set target = null
    set e1 = null
    set e2 = null
endfunction

//===========================================================================
function InitTrig_Pachouli01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Pachouli02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Pachouli02_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0FY'
endfunction

function Trig_Fire_Wall_Target takes nothing returns boolean
    if GetUnitState(GetTriggerUnit(),UNIT_STATE_LIFE)<=0 then
        return false
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_FLYING) then
        return false
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if GetUnitAbilityLevel(GetTriggerUnit(),'Aloc')!=0 then
        return false
    endif
    if GetUnitFlag(GetTriggerUnit(),CS_LOST()) then
        return false
    endif
    //if IsUnitAntiDebuff(GetTriggerUnit()) then
    //    return false
    //endif
    return IsMobileUnit(GetTriggerUnit())
endfunction

function Trig_Fire_Wall_Repel takes nothing returns nothing
    local integer task = GetHandleId(GetTriggeringTrigger())
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = GetEnteringUnit()
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local location p1 = LoadLocationHandle(udg_ht,task,2)
    local location p2 = LoadLocationHandle(udg_ht,task,3)
    local real int = LoadReal(udg_ht,task,0)
    local real damage
    local real px = GetUnitX(GetTriggerUnit())
    local real py = GetUnitY(GetTriggerUnit())
    local real x1 = px - GetLocationX(p1)
    local real y1 = py - GetLocationY(p1)
    local real x2 = px - GetLocationX(p2)
    local real y2 = py - GetLocationY(p2)
    local real a
    set a = 1/SquareRoot(x1*x1+y1*y1)
    set x1 = x1*a
    set y1 = y1*a
    set a = 1/SquareRoot(x2*x2+y2*y2)
    set x2 = x2*a
    set y2 = y2*a
    set a = Atan2(y1+y2,x1+x2)
    set px = px + 100.0*Cos(a)
    set py = py + 100.0*Sin(a)
    set damage = 25.0 + 0.5*int
    if GetUnitFlag(target,CS_DASHING()) then
        //call DebugMsg("突破")
        set damage = damage*1.5
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Other\\Doom\\DoomDeath.mdl",target,"origin"))
    else
        if IsUnitFree(target) then
            call SetUnitX(target,px)
            call SetUnitY(target,py)
        endif
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIfb\\AIfbSpecialArt.mdl",target,"chest"))
    endif
    call UnitDamageTarget(caster,target,damage,false,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    call UnitDamageTarget(target,u,750.0/(10+int/10),false,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    set caster = null
    set target = null
    set u = null
    set p1 = null
    set p2 = null
endfunction

function Trig_Fire_Wall_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local trigger trg
    local boolexpr tgb
    local triggeraction tga
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local integer n = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer z = LoadInteger(udg_ht,task,2)
    local integer s = LoadInteger(udg_ht,task,3)
    //========
    if GetUnitState(u,UNIT_STATE_LIFE)>0 and z>0 then
        set u = LoadUnitHandle(udg_ht,task,7 + i)
        call SetUnitAnimation(u,"stand")
        if (i+s)>n or (i+s)<1 then
            set s = -1*s
        endif
        call SaveInteger(udg_ht,task,1,i+s)
        call SaveInteger(udg_ht,task,2,z-1)
        call SaveInteger(udg_ht,task,3,s)
    else
        call DestroyTimer(t)
        set trg = LoadTriggerHandle(udg_ht,task,4)
        set tgb = LoadBooleanExprHandle(udg_ht,task,5)
        set tga = LoadTriggerActionHandle(udg_ht,task,6)
        call TriggerRemoveAction(trg,tga)
        call DestroyBoolExpr(tgb)
        call DestroyTrigger(trg)
        set i = 1
        loop
            exitwhen i > n
            call KillUnit(LoadUnitHandle(udg_ht,task,7 + i))
            set i = i + 1
        endloop
        call RemoveLocation(LoadLocationHandle(udg_ht,task,2))
        call RemoveLocation(LoadLocationHandle(udg_ht,task,3))
        call FlushChildHashtable(udg_ht,task)
        call FlushChildHashtable(udg_ht,GetHandleId(trg))
    endif
    //========
    set t = null
    set caster = null
    set trg = null
    set tga = null
    set tgb = null
    set u = null
endfunction

function Trig_Fire_Wall_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local trigger trg = CreateTrigger()
    local boolexpr tgb
    local triggeraction tga
    local integer stask = GetHandleId(trg)
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local unit u
    local real s
    local real a
    local real d
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px = GetSpellTargetX()
    local real py = GetSpellTargetY()
    local real dx
    local real dy
    local real ux
    local real uy
    local location p1
    local location p2
    local integer z
    local integer n
    local integer i
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    local real abilitycooldownlv01 = 3.5
    local real abilitycooldownlv02 = 4.0
    local real abilitycooldownlv03 = 4.5
    local real abilitycooldownlv04 = 5.0
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set a = Atan2(py-oy,px-ox)*bj_RADTODEG
    set d = 32.0*(2 + level)
    set p1 = Location(px+d*CosBJ(a+90),py+d*SinBJ(a+90))
    set p2 = Location(px+d*CosBJ(a-90),py+d*SinBJ(a-90))
    set n = 5 + level*2
    set dx = (GetLocationX(p2) - GetLocationX(p1))/I2R(n)
    set dy = (GetLocationY(p2) - GetLocationY(p1))/I2R(n)
    //--------
    set i = 1
    loop
        exitwhen i > n
        //--------
        set a = Pow(-1,I2R(i-1))*I2R(i/2)*5.0
        set ux = GetLocationX(p1) + (I2R(i)-0.5)*dx
        set uy = GetLocationY(p1) + (I2R(i)-0.5)*dy
        set u = CreateUnit(GetOwningPlayer(caster),'n03B',ux,uy,0)
        call TriggerRegisterUnitInRange(trg,u,40.0,iff)
        call SaveUnitHandle(udg_ht,task,7 + i,u)
        call SetUnitX(u,ux)
        call SetUnitY(u,uy)
        //--------
        set i = i + 1
    endloop
    //--------
    set tgb = Condition(function Trig_Fire_Wall_Target)
    call TriggerAddCondition(trg,tgb)
    set tga = TriggerAddAction(trg,function Trig_Fire_Wall_Repel)
    //--------
    set u = LoadUnitHandle(udg_ht,task,8)
    set s = 0.3/I2R(n)
    set z = R2I((5.0+1.0*level)/s)
    call SaveInteger(udg_ht,task,0,n)
    call SaveInteger(udg_ht,task,1,1)
    call SaveInteger(udg_ht,task,2,z)
    call SaveInteger(udg_ht,task,3,1)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveLocationHandle(udg_ht,task,2,p1)
    call SaveLocationHandle(udg_ht,task,3,p2)
    call SaveTriggerHandle(udg_ht,task,4,trg)
    call SaveBooleanExprHandle(udg_ht,task,5,tgb)
    call SaveTriggerActionHandle(udg_ht,task,6,tga)
    //--------
    call TimerStart(t,s,true,function Trig_Fire_Wall_Main)
    call SaveReal(udg_ht,stask,0,GetHeroInt(caster,true))
    call SaveUnitHandle(udg_ht,stask,0,caster)
    call SaveUnitHandle(udg_ht,stask,1,u)
    call SaveLocationHandle(udg_ht,stask,2,p1)
    call SaveLocationHandle(udg_ht,stask,3,p2)
    call SaveTriggerActionHandle(udg_ht,stask,4,tga)
    call SaveBooleanExprHandle(udg_ht,stask,5,tgb)
    //========
    set t = null
    set caster = null
    set trg = null
    set tgb = null
    set tga = null
    set iff = null
    set u = null
    set p1 = null
    set p2 = null
endfunction

//===========================================================================
function InitTrig_Pachouli02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Pachouli03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Pachouli03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0FX'
endfunction

function Trig_Pachouli03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real a = GetUnitFacing(caster)
    local real s
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local effect e
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    local real abilitycooldownlv01 = 21
    local real abilitycooldownlv02 = 21
    local real abilitycooldownlv03 = 21
    local real abilitycooldownlv04 = 21
    //========
    if GetTriggerEventId()==EVENT_UNIT_SPELL_EFFECT then
        if UnitHasItemOfTypeBJ(caster, 'I00B') then
            if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
            elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
                call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
            endif
        endif
        set px = ox + 200.0*CosBJ(a)
        set py = oy + 200.0*SinBJ(a)
        set s = 1.5 + 0.25*level
        set u = CreateUnit(GetOwningPlayer(caster),'e012',px,py,a)
        call SetUnitScale(u,s,s,s)
        call UnitApplyTimedLife(u,'B03O',11.0)
        call SetUnitAbilityLevel(u,'A0FW',level)
        call IssueImmediateOrder(u,"manaflareon")
        //call SaveUnitHandle(udg_sht,GetHandleId(caster),1,u)
        set e = AddSpecialEffect("HumanSpellRune.mdl",px,py)
        call TSU_DestroyEffect(12.0,e)
    else
        //set u = LoadUnitHandle(udg_sht,GetHandleId(caster),1)
        //call RemoveUnit(u)
        //set e = LoadEffectHandle(udg_sht,GetHandleId(caster),2)
        //call DestroyEffect(e)
        //call SaveUnitHandle(udg_sht,GetHandleId(caster),1,null)
    endif
    //========
    set caster = null
    set u = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Pachouli03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Pachouli04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Pachouli04_Switch takes nothing returns boolean
    if GetIssuedOrderId()==OrderId("immolation") then
        call UnitAddAbility(GetTriggerUnit(),'A0GI')
        call SetUnitAbilityLevel(GetTriggerUnit(),'A0GI',GetUnitAbilityLevel(GetTriggerUnit(),'A0FV'))
        call DebugMsg("ON")
        //return true
    endif
    if GetIssuedOrderId()==OrderId("unimmolation") then
        call UnitRemoveAbility(GetTriggerUnit(),'A0GI')
        call DebugMsg("OFF")
    endif
    return false
endfunction

function Trig_Pachouli04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real a = AngleBetweenUnits(u,caster)
    local real d = DistanceBetweenUnits(u,caster)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if GetUnitAbilityLevel(caster,'B03X')>0 then
        call SetUnitX(u,ox)
        call SetUnitY(u,oy)
        call SetUnitFacingTimed(u,GetUnitFacing(caster),0.1)
        if i/128*128==i then
            call SetUnitFlyHeight(u,160.0+GetRandomReal(-15.0,15.0),5.0)
        endif
        call SaveInteger(udg_ht,task,1,i + 1)
    else
        call KillUnit(u)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Pachouli04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local unit u
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    set u = CreateUnit(GetOwningPlayer(caster),'n03G',ox,oy,GetUnitFacing(caster))
    call SetUnitX(u,ox)
    call SetUnitY(u,oy)
    call SetUnitAnimation(u,"birth")
    call EnableHeight(u)
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,1,0)
    call TimerStart(t,0.02,true,function Trig_Pachouli04_Main)
    //========
    set caster = null
    set u = null
    set t = null
endfunction

function InitTrig_Pachouli04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Init Pachouli
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Pachouli_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('U00N')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_Pachouli_Attack = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Pachouli_Attack, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Pachouli_Attack, Condition( function Trig_Pachouli_Attack_Conditions ) )
    call TriggerAddAction( gg_trg_Pachouli_Attack, function Trig_Pachouli_Attack_Actions )
    
    set gg_trg_Pachouli_Attack = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Pachouli_Attack, h, EVENT_UNIT_ISSUED_ORDER )
    call TriggerRegisterUnitEvent( gg_trg_Pachouli_Attack, h, EVENT_UNIT_ISSUED_POINT_ORDER )
    call TriggerRegisterUnitEvent( gg_trg_Pachouli_Attack, h, EVENT_UNIT_ISSUED_TARGET_ORDER )
    call TriggerAddCondition( gg_trg_Pachouli_Attack, Condition( function Trig_Pachouli_Attack_Cancel ) )
    
    set gg_trg_Pachouli01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Pachouli01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Pachouli01, Condition( function Trig_Pachouli01_Conditions ) )
    call TriggerAddAction( gg_trg_Pachouli01, function Trig_Pachouli01_Actions )
    
    set gg_trg_Pachouli02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Pachouli02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Pachouli02, Condition( function Trig_Pachouli02_Conditions ) )
    call TriggerAddAction( gg_trg_Pachouli02, function Trig_Fire_Wall_Actions )
    
    set gg_trg_Pachouli03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Pachouli03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerRegisterUnitEvent( gg_trg_Pachouli03, h, EVENT_UNIT_SPELL_ENDCAST )
    call TriggerAddCondition( gg_trg_Pachouli03, Condition( function Trig_Pachouli03_Conditions ) )
    call TriggerAddAction( gg_trg_Pachouli03, function Trig_Pachouli03_Actions )
    
    set gg_trg_Pachouli04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Pachouli04, h, EVENT_UNIT_ISSUED_ORDER )
    call TriggerAddCondition( gg_trg_Pachouli04, Condition( function Trig_Pachouli04_Switch ) )
    call TriggerAddAction( gg_trg_Pachouli04, function Trig_Pachouli04_Actions )
    set udg_SK_Pachi04_Attacking = false

    call UnitAddAbility(h,'A0TG')
    call UnitRemoveAbility(h,'A0TG')
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Pachouli takes nothing returns nothing
    set gg_trg_Init_Pachouli = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Pachouli, function Trig_Init_Pachouli_Actions )
endfunction
//===========================================================================
// Trigger: MeirinStar
//===========================================================================
function Trig_MeirinStar_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    set udg_SK_MeirinStar = udg_SK_MeirinStar - 1
    set t = null
endfunction

function Trig_MeirinStar_Cast takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    set udg_SK_MeirinStar = udg_SK_MeirinStar + 1
    call TimerStart(t,4.00,false,function Trig_MeirinStar_Clear)
    set t = null
endfunction

function Trig_MeirinStar_Actions takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_LIFE) + 3.00 * (1 + udg_SK_MeirinStar * 1.50))
    call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA) + 0.20 * (1 + udg_SK_MeirinStar * 1.50))
    call DebugMsg(R2S(1 + udg_SK_MeirinStar * 1.50))
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_MeirinStar takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Meirin
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function MeilingPushUnitMain takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer tid = GetHandleId(t)
    local unit u =LoadUnitHandle(udg_Hashtable, tid, 1)
    local integer count = LoadInteger(udg_Hashtable, tid, 2)
    local integer countmax = LoadInteger(udg_Hashtable, tid, 3)
    local real distance = LoadReal(udg_Hashtable, tid, 4)
    local real acc = distance*2/0.5/0.5*0.03*0.03
    local real startspeed = distance*2/0.5*0.03
    local real angle = LoadReal(udg_Hashtable, tid, 5)
    local real movedistance = startspeed-acc*count
    local real originx = GetUnitX(u)
    local real originy = GetUnitY(u)
    local real ux = originx+movedistance*Cos(angle)
    local real uy = originy+movedistance*Sin(angle)
    local boolean flag
    
    if count>countmax then
        call SetUnitFlag(u,CS_REPEL(),false)
        call SetUnitFlag(u,CS_DRAG(),false)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable, tid)
        set u = null
        set t = null
        return
    endif
    call SetUnitXYRepel(u,ux,uy)
//推人效果
    call SaveInteger(udg_Hashtable, tid, 2, count+1)
    set u = null
    set t = null
endfunction

function MeilingPushUnit takes unit u, real distance, real angle returns nothing
    local timer t
    local integer tid
    local real lasttime = 0.5
    
    if GetUnitFlag(u,CS_LOST()) then
        return
    endif
    if GetUnitFlag(u,CS_DASHING()) then
        return
    endif
    if GetUnitFlag(u,CS_FROZEN()) then
        return
    endif
    
    set t = CreateTimer()
    set tid = GetHandleId(t)
    call SetUnitFlag(u,CS_DRAG(),true)
    call TimerStart(t, 0.03, true, function MeilingPushUnitMain)
    call SaveUnitHandle(udg_Hashtable, tid, 1, u)
    call SaveInteger(udg_Hashtable, tid, 2, 0)
    call SaveInteger(udg_Hashtable, tid, 3, R2I(lasttime/0.03))
    call SaveReal(udg_Hashtable, tid, 4, distance)
    call SaveReal(udg_Hashtable, tid, 5, angle)
    call SetUnitFlag(u,CS_REPEL(),true)
    set t = null
endfunction

function MeilingSkillsAnimeEnd takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer tid = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_Hashtable, tid, 1)

    call SetUnitAnimation(u, "stand")
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_Hashtable, tid)
    set t = null
    set u = null
endfunction

function MeilingSkillsAnimeStart takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer tid = GetHandleId(t)
    local timer t2 = CreateTimer()
    local integer t2id = GetHandleId(t2)
    local unit u = LoadUnitHandle(udg_Hashtable, tid, 1)
    local string animename = LoadStr(udg_Hashtable, tid, 2)
    local real lasttime = LoadReal(udg_Hashtable, tid, 3)

    call SetUnitAnimation(u, animename)
    call TimerStart(t2, lasttime, false, function MeilingSkillsAnimeEnd)
    call SaveUnitHandle(udg_Hashtable, t2id, 1, u)
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_Hashtable, tid)
    set t = null
    set t2 = null
    set u = null
endfunction

function MeilingSkillsAnime takes unit u, string animename, real lasttime returns nothing
    local timer t = CreateTimer()
    call TimerStart(t, 0.01, false, function MeilingSkillsAnimeStart)
    call SaveUnitHandle(udg_Hashtable, GetHandleId(t), 1, u)
    call SaveStr(udg_Hashtable, GetHandleId(t), 2, animename)
    call SaveReal(udg_Hashtable, GetHandleId(t), 3, lasttime)
    set t = null
endfunction

function MeilingSkill4PanCameraRandom takes player whichplayer, real originx, real originy, real range returns nothing
    local real a = GetRandomReal(-1*range, range)
    local real b = GetRandomReal(-1*range, range)
    if GetLocalPlayer() == whichplayer then
        call PanCameraToTimed(originx+a, originy+b, 0.2)
    endif
endfunction

function MeilingSkill4ShakeCameraMain takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer tid = GetHandleId(t)
    local player whichplayer = LoadPlayerHandle(udg_Hashtable, tid, 1)
    local integer count = LoadInteger(udg_Hashtable, tid, 2)
    local integer countmax = LoadInteger(udg_Hashtable, tid, 3)
    local real shakepower = LoadReal(udg_Hashtable, tid, 4)

    if count > countmax then
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable, tid)
        if GetLocalPlayer() == whichplayer then
            call SetCameraField(CAMERA_FIELD_ROTATION, 90.00, 0.0 )
        endif
        set t = null
        set whichplayer = null
        return
    endif
    if GetLocalPlayer() == whichplayer then
        if count/2*2 == count then
            call SetCameraField( CAMERA_FIELD_ROTATION, 90+(shakepower-shakepower/countmax*count), 0.0 )
        else
            call SetCameraField( CAMERA_FIELD_ROTATION, 90-(shakepower-shakepower/countmax*count), 0.0 )
        endif
    endif
    call SaveInteger(udg_Hashtable, tid, 2, count+1)
    set t = null
    set whichplayer = null    
endfunction

function MeilingSkill4ShakeCamera takes player whichplayer, real shakepower, real shaketime returns nothing
    local timer t
    local integer tid

    set t = CreateTimer()
    set tid = GetHandleId(t)
    call TimerStart(t, 0.03, true, function MeilingSkill4ShakeCameraMain)
    call SavePlayerHandle(udg_Hashtable, tid, 1, whichplayer)
    call SaveInteger(udg_Hashtable, tid, 2, 0)
    call SaveInteger(udg_Hashtable, tid, 3, R2I(shaketime/0.03))
    call SaveReal(udg_Hashtable, tid, 4, shakepower)
    set t = null
endfunction

function MeilingSkill4Shake takes unit caster,real ox,real oy,integer k returns nothing
    local unit h
    local real dx
    local real dy
    local integer i
    set i = 0
    loop
        exitwhen i>=12
        set h = udg_PlayerHeroes[i]
        if h!= null and IsUnitAliveBJ(h) and IsUnitEnemy(h,GetOwningPlayer(caster)) then
            set dx = GetUnitX(h) - ox
            set dy = GetUnitX(h) - oy
            if SquareRoot(dx*dx + dy*dy)<=500 then
                if k==1 then
                    call MeilingSkill4ShakeCamera( GetOwningPlayer(h), 15, 0.7 )
                endif
                if k==2 then
                    call MeilingSkill4ShakeCamera( GetOwningPlayer(h), 30, 0.7 )
                    call MeilingSkill4PanCameraRandom( GetOwningPlayer(h), GetUnitX(h), GetUnitY(h), 1000 )
                endif
                if k==3 then
                    call MeilingSkill4ShakeCamera( GetOwningPlayer(h), 90, 1.5 )
                endif
            endif
        endif
        set i = i + 1
    endloop
    set h = null
endfunction

function Trig_Meirin_Actions takes nothing returns nothing
endfunction

//===========================================================================
function InitTrig_Meirin takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Meirin01
//
// 这个其实是技能03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Meirin01_Conditions takes nothing returns boolean
    if GetRandomInt(0,100)>10 + 2.5 * GetUnitAbilityLevel(GetTriggerUnit(),'A0GA') then
        return false
    endif
    if GetEventDamage()>=300.0 or GetEventDamage()<=10.0 then
        return false
    endif
    if GetUnitCurrentOrder(GetTriggerUnit())>0x0D0040 then
        return false //使用其它技能时，不会触发
    endif
    call Trig_MeirinStar_Cast()
    return true
endfunction

function Trig_Meirin01_Frame takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    if i==0 then
        //call UnitRemoveAbility(caster,'A0I2')
        //call UnitRemoveAbility(caster,'A0IR')
        call SaveInteger(udg_ht,task,1,i + 1)
        call TimerStart(t,0.7,false,function Trig_Meirin01_Frame)
    elseif i==1 then
        call AddUnitAnimationProperties(caster,"spin",false)
        call SaveInteger(udg_ht,task,1,i + 1)
        call TimerStart(t,0.8,false,function Trig_Meirin01_Frame)
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        call EnableTrigger(gg_trg_Meirin01)
    endif
    //========
    set t = null
    set caster = null
endfunction

function Trig_Meirin01_Actions takes nothing returns nothing
    //local trigger trg = GetTriggeringTrigger()
    local unit caster = GetTriggerUnit()
    local real damage = GetEventDamage()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = GetUnitAbilityLevel(caster,'A0GA')
    local unit u
    local timer t
    //========
    if LoadBoolean(udg_sht,GetHandleId(caster),0) then
        call DisableTrigger(gg_trg_Meirin01)
        //call SetUnitAnimation(caster,"attack walk stand spin")
        call SetUnitState(caster,UNIT_STATE_LIFE,damage + GetUnitState(caster,UNIT_STATE_LIFE))
        //call TSU_SetUnitInvulnerable(caster,0.001)
        //call UnitAddAbility(caster,'A0I2')
        //call UnitAddAbility(caster,'A0IR')
        call AddUnitAnimationProperties(caster,"spin",true)
        set t = CreateTimer()
        call SaveUnitHandle(udg_ht,GetHandleId(t),0,caster)
        call SaveInteger(udg_ht,GetHandleId(t),1,0)
        call TimerStart(t,0.1,false,function Trig_Meirin01_Frame)
        set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,0)
        call UnitAddAbility(u,'A0G5')
        call SetUnitAbilityLevel(u,'A0G5',level)
        call UnitApplyTimedLife(u,'BTLF',1.0)
        call IssueImmediateOrder(u,"fanofknives")
    endif
    //========
    set caster = null
    set u = null
    set t = null
endfunction

function Trig_Meirin01_Trace takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local real px = GetUnitX(caster)
    local real py = GetUnitY(caster)
    local real dx = px - LoadReal(udg_ht,task,0)
    local real dy = py - LoadReal(udg_ht,task,1)
    local real d = SquareRoot(dx*dx + dy*dy)
    if d>200.0 then
        call SaveBoolean(udg_sht,GetHandleId(caster),0,false)
    else
        call SaveBoolean(udg_sht,GetHandleId(caster),0,true)
    endif
    call SaveReal(udg_ht,task,0,px)
    call SaveReal(udg_ht,task,1,py)
    set caster = null
    set t = null
endfunction

function Trig_Meirin01_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A0GA'
endfunction

function Trig_Meirin01_Learn_Actions takes nothing returns nothing
    local timer t
    call DestroyTrigger(gg_trg_Meirin01)
    set gg_trg_Meirin01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Meirin01, GetTriggerUnit(), EVENT_UNIT_DAMAGED )
    call TriggerAddCondition( gg_trg_Meirin01, Condition( function Trig_Meirin01_Conditions ) )
    call TriggerAddAction( gg_trg_Meirin01, function Trig_Meirin01_Actions )
    call SaveBoolean(udg_sht,GetHandleId(GetTriggerUnit()),0,true)
    set t = CreateTimer()
    call SaveUnitHandle(udg_ht,GetHandleId(t),0,GetTriggerUnit())
    call SaveReal(udg_ht,GetHandleId(t),0,GetUnitX(GetTriggerUnit()))
    call SaveReal(udg_ht,GetHandleId(t),1,GetUnitY(GetTriggerUnit()))
    call TimerStart(t,0.7,true,function Trig_Meirin01_Trace)
    set t = null
endfunction

//===========================================================================
function InitTrig_Meirin01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Meirin02
//
// 这个其实是技能01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Meirin02_Conditions takes nothing returns boolean
    if GetSpellAbilityId() != 'A0GB' then
        return false
    endif
    call Trig_MeirinStar_Cast()
    return true
endfunction

function Trig_Meirin02_Target takes nothing returns boolean
    if IsUnitDeadBJ(GetFilterUnit()) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')>0 then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_ETHEREAL) then
        return false
    endif
    if GetUnitFlag(GetFilterUnit(),CS_DASHING()) then
        return false
    endif
    if GetUnitFlag(GetFilterUnit(),CS_LOST()) then
        return false
    endif
    if IsUnitGiant(GetFilterUnit()) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'BOvc') >= 1 then
        return false
    endif
    return IsUnitType(GetFilterUnit(),UNIT_TYPE_GROUND)
endfunction

function MeilingSkill2ActMain takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer tid = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_Hashtable, tid, 1)
    local real casterx = GetUnitX(u)
    local real castery = GetUnitY(u)
    local real ux
    local real uy
    local integer level = LoadInteger(udg_Hashtable, tid, 0)
    local integer count = LoadInteger(udg_Hashtable, tid, 2)
    local integer countmax = LoadInteger(udg_Hashtable, tid, 3)
    local real movedistance = LoadReal(udg_Hashtable, tid, 4)
    local real angle = LoadReal(udg_Hashtable, tid, 5)
    local real angle2
    local group g = LoadGroupHandle(udg_Hashtable, tid, 6)
    local group effg
    local boolexpr f
    local unit tempu
    local real tempux
    local real tempuy
    local unit target = LoadUnitHandle(udg_Hashtable, tid, 7)
    local real targetx = GetUnitX(target)
    local real targety = GetUnitY(target)
    local boolean flag
    //local trigger tr = LoadTriggerHandle(udg_Hashtable, tid, 8)
    local real originx = LoadReal(udg_Hashtable, tid, 9)
    local real originy = LoadReal(udg_Hashtable, tid, 10)
    
    if count > countmax or GetUnitState(u,UNIT_STATE_LIFE)<=0 then
        call PauseTimer(t)
        call DestroyTimer(t)
        call DestroyGroup(g)
        //call FlushChildHashtable(udg_Hashtable, GetHandleId(tr))
        //call TriggerClearActions(tr)
        //call DestroyTrigger(tr)
        call DestroyEffect(LoadEffectHandle(udg_Hashtable, tid, 6))
        call FlushChildHashtable(udg_Hashtable, tid)
        call SetUnitFlag(u,CS_DASHING(),false)
        if target!=null then
            call SetUnitFlag(target,CS_DASHING(),false)
            call SetUnitFlag(target,CS_DRAG(),false)
        endif
        set t = null
        set u = null
        set g = null
        set f = null
        //set tr = null
        set effg = null
        set tempu = null
        set target = null
        return
    endif
    set ux = casterx+movedistance*Cos(angle)
    set uy = castery+movedistance*Sin(angle)
    set flag = SetUnitXYGround(u, ux, uy)
    if flag == false then
        call SetUnitX(u, casterx)
        call SetUnitY(u, castery)        
    endif
    if target != null and IsMobileUnit(target) then
        set targetx = GetUnitX(target)
        set targety = GetUnitY(target)
        if (targetx-casterx)*(targetx-casterx)+(targety-castery)*(targety-castery)<=100*100 then
            if IsUnitInGroup(target, g) == false then
                call UnitDamageTarget(u, target, 40+30*level, true, false, ATTACK_TYPE_HERO, DAMAGE_TYPE_NORMAL, WEAPON_TYPE_WHOKNOWS)
                call GroupAddUnit(g, target)
                call SetUnitFlag(target,CS_DASHING(),true)
                call SetUnitFlag(target,CS_DRAG(),true)
            endif
            set targetx = ux+100*Cos(angle)
            set targety = uy+100*Sin(angle)
            set flag = SetUnitXYGround(target, targetx, targety)
            if flag == false then
                call SetUnitX(target, ux)
                call SetUnitY(target, uy)
            endif
        endif
    endif
    set f = Filter(function Trig_Meirin02_Target)
    set effg = CreateGroup()
    call GroupEnumUnitsInRange(effg, casterx, castery, 100, f)
    call GroupRemoveUnit(effg, u)
    loop
        set tempu = FirstOfGroup(effg)
        exitwhen(tempu == null)
        call GroupRemoveUnit(effg, tempu)
        if IsUnitInGroup(tempu, g)==false and IsUnitEnemy(tempu,GetOwningPlayer(u)) and IsMobileUnit(tempu) then
            call GroupAddUnit(g, tempu)
            call UnitDamageTarget(u, tempu, 40+30*level, true, false, ATTACK_TYPE_HERO, DAMAGE_TYPE_NORMAL, WEAPON_TYPE_WHOKNOWS)
            set tempux = GetUnitX(tempu)
            set tempuy = GetUnitY(tempu)
            set angle2 = Atan2(tempuy-originy, tempux-originx)
            if angle2 >= angle then
                call MeilingPushUnit(tempu, 100, angle+3.1415926/2)
            endif
            if angle2 < angle then
                call MeilingPushUnit(tempu, 100, angle-3.1415926/2)
            endif
        endif
    endloop
    call SaveInteger(udg_Hashtable, tid, 2, count+1)
    call DestroyGroup(effg)
    call DestroyBoolExpr(f)
    set t = null
    set u = null
    set g = null
    set f = null
    set effg = null
    set tempu = null
    set target = null
    //set tr = null
endfunction

function Trig_Meirin02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real casterx = GetUnitX(caster)
    local real castery = GetUnitY(caster)
    local unit target = GetSpellTargetUnit()
    local real locx
    local real locy
    local timer t = CreateTimer()
    local integer tid = GetHandleId(t)
    local real angle
    local integer level = GetUnitAbilityLevel(caster,'A0GB')
    local real distance = 450.0 + 50.0*level
    local group g = CreateGroup()
    //local trigger tr = CreateTrigger()
    local location targetloc = GetSpellTargetLoc()
    //========
    local real abilitycooldownlv01 = 18
    local real abilitycooldownlv02 = 15
    local real abilitycooldownlv03 = 12
    local real abilitycooldownlv04 = 9
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========

    if IsUnitEnemy(target, GetOwningPlayer(caster)) == false then
        set target = null
    endif
    if target == null then
        set locx = GetLocationX(targetloc)
        set locy = GetLocationY(targetloc)
    endif
    if target != null then
        set locx = GetUnitX(target)
        set locy = GetUnitY(target)
    endif
    set angle = Atan2(locy-castery, locx-casterx)
    call MeilingSkillsAnime(caster, "spell channel", 0.6)
    call SetUnitFlag(caster,CS_DASHING(),true)
    call TimerStart(t, 0.03, true, function MeilingSkill2ActMain)
    call SaveUnitHandle(udg_Hashtable, tid, 1, caster)
    call SaveInteger(udg_Hashtable, tid, 0, level)
    call SaveInteger(udg_Hashtable, tid, 2, 0)
    call SaveInteger(udg_Hashtable, tid, 3, R2I(0.6/0.03))
    call SaveReal(udg_Hashtable, tid, 4, distance/(0.6/0.03))
    call SaveReal(udg_Hashtable, tid, 5, angle)
    call SaveGroupHandle(udg_Hashtable, tid, 6, g)
    call SaveUnitHandle(udg_Hashtable, tid, 7, target)
    call SaveReal(udg_Hashtable, tid, 9, casterx)
    call SaveReal(udg_Hashtable, tid, 10, castery)
    //call TriggerRegisterUnitEvent(tr, caster, EVENT_UNIT_ISSUED_TARGET_ORDER)
    //call TriggerRegisterUnitEvent(tr, caster, EVENT_UNIT_DEATH)
    //call TriggerAddAction(tr, function MeilingSkill2Break)
    //call SaveTriggerHandle(udg_Hashtable, tid, 8, tr)
    //call SaveTimerHandle(udg_Hashtable, GetHandleId(tr), 1, t)
    //call SaveGroupHandle(udg_Hashtable, GetHandleId(tr), 2, g)
    call RemoveLocation(targetloc)
    set caster = null
    set t = null
    set g = null
    //set tr = null
    set target = null
    set targetloc = null
endfunction

//===========================================================================
function InitTrig_Meirin02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Meirin03
//
// 这个其实是技能02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Meirin03_Damage_Conditions takes nothing returns boolean
    if GetUnitTypeId(GetEventDamageSource())!='E013' then
        return false
    endif
    //使用其它技能时，不会触发
    return GetUnitCurrentOrder(GetEventDamageSource())<0x0D0040
endfunction

function Trig_Meirin03_Damage takes nothing returns nothing
    local unit caster = GetEventDamageSource()
    local unit target = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = GetUnitAbilityLevel(caster,'A0GC')
    local integer x = LoadInteger(udg_sht,GetHandleId(caster),0)
    local unit u
    //========
    if x>0 then
        if GetUnitAbilityLevel(target, 'B062') > 0 then
            set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,0.0)
            call UnitAddAbility(u,'A0G6')
            call SetUnitAbilityLevel(u,'A0G6',level)
            call IssueTargetOrder(u,"thunderbolt",target)
        endif
        if x==1 then
            call AddUnitAnimationProperties(caster,"alternate",false)
            call UnitRemoveAbility(caster,'A0SK')
            call SaveInteger(udg_sht,GetHandleId(caster),0,0)
        else
            call SaveInteger(udg_sht,GetHandleId(caster),0,x-1)
        endif
    endif
    //========
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_Meirin03_Conditions takes nothing returns boolean
    if GetSpellAbilityId() != 'A0GC' then
        return false
    endif
    call Trig_MeirinStar_Cast()
    return true
endfunction

function MeilingSkill3ActTimeOut takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    call UnitRemoveAbility(caster,'A0SK')
    
    call AddUnitAnimationProperties( caster, "alternate", false )
    call SaveInteger(udg_sht,GetHandleId(caster),0,0)
    
    call FlushChildHashtable(udg_ht,task)
    
    call PauseTimer(t)
    call DestroyTimer(t) 
    set t = null
    set caster = null
endfunction

function Trig_Meirin03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t
    //========
    local real abilitycooldownlv01 = 14
    local real abilitycooldownlv02 = 13
    local real abilitycooldownlv03 = 12
    local real abilitycooldownlv04 = 11
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call UnitAddAbility(caster,'A0SK')
    
    call AddUnitAnimationProperties(caster,"alternate",true)
    call SaveInteger(udg_sht,GetHandleId(caster),0,level+2)
    
    set t = LoadTimerHandle(udg_sht,GetHandleId(caster),0)
    call PauseTimer(t)
    call DestroyTimer(t)
    set t = CreateTimer()
    call SaveTimerHandle(udg_sht,GetHandleId(caster),0,t)
    
    call SaveUnitHandle(udg_ht,GetHandleId(t),0,caster)
    call TimerStart(t,9.0,false,function MeilingSkill3ActTimeOut)
    
    if gg_trg_Meirin==null then
        set gg_trg_Meirin = CreateTrigger()
        call RegisterAnyUnitDamage( gg_trg_Meirin )
        call TriggerAddCondition( gg_trg_Meirin, Condition( function Trig_Meirin03_Damage_Conditions ) )
        call TriggerAddAction(gg_trg_Meirin,function Trig_Meirin03_Damage)
        call DebugMsg("Meirin02 Init")
    endif
    
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Meirin03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Meirin04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Meirin04_Conditions takes nothing returns boolean
    if GetSpellAbilityId() != 'A0GD' then
        return false
    endif
    call Trig_MeirinStar_Cast()
    return true
endfunction

function Trig_Meirin04_Effect_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px 
    local real py 
    local real a = LoadReal(udg_ht,task,0)
    local integer k = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer r
    local integer g
    local integer b
    //========
    if i<12 then
        if k==1 then
            set ox = ox + 200.0*CosBJ(a)
            set oy = oy + 200.0*SinBJ(a)
            set px = ox + 150.0*CosBJ(a + 180.0 + 30.0*i)
            set py = oy + 150.0*SinBJ(a + 180.0 + 30.0*i)
            set u = CreateUnit(GetOwningPlayer(caster),'n03E',px,py,a)
            call SetUnitAnimation(u,"birth")
            call UnitApplyTimedLife(u,'BTLF',0.7)
            set r = udg_SK_Meirin_RGB[i*3]
            set g = udg_SK_Meirin_RGB[i*3 + 1]
            set b = udg_SK_Meirin_RGB[i*3 + 2]
            call SetUnitVertexColor(u,r,g,b,255)
        elseif k==2 then
            set px = ox + 250.0*CosBJ(a + 5.0 + 10.0*(i-6))
            set py = oy + 250.0*SinBJ(a + 5.0 + 10.0*(i-6))
            set u = CreateUnit(GetOwningPlayer(caster),'n03E',px,py,a)
            call UnitApplyTimedLife(u,'BTLF',0.7)
            set r = udg_SK_Meirin_RGB[i*3]
            set g = udg_SK_Meirin_RGB[i*3 + 1]
            set b = udg_SK_Meirin_RGB[i*3 + 2]
            call SetUnitVertexColor(u,r,g,b,255)
            call SetUnitAnimation(u,"birth")
        elseif k==3 then
            set px = ox + i*40.0*CosBJ(a)
            set py = oy + i*40.0*SinBJ(a)
            set u = CreateUnit(GetOwningPlayer(caster),'n03E',px,py,a)
            call SetUnitAnimation(u,"birth")
            call UnitApplyTimedLife(u,'BTLF',0.7)
            set r = udg_SK_Meirin_RGB[i*3]
            set g = udg_SK_Meirin_RGB[i*3 + 1]
            set b = udg_SK_Meirin_RGB[i*3 + 2]
            call SetUnitVertexColor(u,r,g,b,255)
        endif
        call SaveInteger(udg_ht,task,1,i + 1)
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Meirin04_Effect takes unit caster,integer k,real a returns nothing
    local unit u
    local real px 
    local real py
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,0,k)
    call SaveInteger(udg_ht,task,1,0)
    call SaveReal(udg_ht,task,0,a*bj_RADTODEG)
    call TimerStart(t,0.03,true,function Trig_Meirin04_Effect_Main)
    //========
    set u = null
    set t = null
endfunction

function MeilingSkill4ActMain takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer tid = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable, tid, 0)
    local integer level = LoadInteger(udg_Hashtable, tid, 0)
    local integer count = LoadInteger(udg_Hashtable, tid, 1) 
    local unit helper
    local real angle = LoadReal(udg_Hashtable, tid, 0)
    local real castx = GetUnitX(caster)+200*Cos(angle)
    local real casty = GetUnitY(caster)+200*Sin(angle)
    local boolean k = not( IsUnitMorphed(caster) or GetUnitFlag(caster,CS_LOST()) or GetUnitFlag(caster,CS_FROZEN()) )
    local trigger tr = LoadTriggerHandle(udg_Hashtable, tid, 4)
    set k = k and GetUnitCurrentOrder(caster)==OrderId("clusterrockets")
    call SetUnitFacing(caster,angle*bj_RADTODEG)
    if count == 1 and IsUnitAliveBJ(caster) and k then
        call MeilingSkillsAnime(caster, "spell first", 1.0)
        call MeilingPushUnit(caster, 50, GetUnitFacing(caster)/180*3.1415926)
    endif
    if count == 4 and IsUnitAliveBJ(caster) and k then
        call MeilingSkillsAnime(caster, "spell second", 1.0)
        call MeilingPushUnit(caster, 50, GetUnitFacing(caster)/180*3.1415926)
    endif
    if count == 7 and IsUnitAliveBJ(caster) and k then
        call MeilingSkillsAnime(caster, "spell third", 1.0)
        call MeilingPushUnit(caster, 50, GetUnitFacing(caster)/180*3.1415926)
    endif
    if count == 2 and IsUnitAliveBJ(caster) and k then
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl", castx, casty))
        set helper = CreateUnit(GetOwningPlayer(caster),GPSU(), castx, casty, 0)
        call UnitAddAbility(helper, 'A0G7')
        call SetUnitAbilityLevel(helper,'A0G7',level)
        call UnitApplyTimedLife(helper,'BTLF',2)
        call IssueImmediateOrder(helper, "thunderclap")
        //call MeilingSkill4Shake(caster,castx,casty,1)
        call Trig_Meirin04_Effect(caster,1,angle)
    endif
    if count == 5 and IsUnitAliveBJ(caster) and k then
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl", castx, casty))
        set helper = CreateUnit(GetOwningPlayer(caster),GPSU(), castx, casty, 0)
        call UnitAddAbility(helper, 'A0G8')
        call SetUnitAbilityLevel(helper, 'A0G8',level)
        call UnitApplyTimedLife(helper,'BTLF',2)
        call IssueImmediateOrder(helper, "stomp")
        //call MeilingSkill4Shake(caster,castx,casty,2)
        call Trig_Meirin04_Effect(caster,2,angle)
    endif
    if count == 8 and IsUnitAliveBJ(caster) and k then
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\WarStomp\\WarStompCaster.mdl", castx, casty))
        set helper = CreateUnit(GetOwningPlayer(caster),GPSU(), castx, casty, 0)
        call UnitAddAbility(helper, 'A0G9')
        call SetUnitAbilityLevel(helper, 'A0G9',level)
        call UnitApplyTimedLife(helper, 'BTLF', 2 )
        call IssueImmediateOrder(helper, "stomp")
        //call MeilingSkill4Shake(caster,castx,casty,3)
        call Trig_Meirin04_Effect(caster,3,angle)
    endif
    if count == 8 or IsUnitDeadBJ(caster) or (not k) then
        call UnitRemoveAbility(caster,'A0AN')
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,tid)
        //call FlushChildHashtable(udg_Hashtable, GetHandleId(tr))
        //call TriggerClearActions(tr)
        //call DestroyTrigger(tr)
    endif
    if count != 8 then
        call SaveInteger(udg_Hashtable, tid, 1, count+1)
    endif
    set helper = null
    set caster = null
    set t = null
    //set tr = null
endfunction                            

function MeilingSkill4PushUnit takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer tid = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable, tid, 0)
    local integer count = LoadInteger(udg_Hashtable, tid, 1)
    local boolexpr f
    local group effg
    local unit u
    local real ux
    local real uy
    local real casterx
    local real castery

    if count > 8 then
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable, tid)
        set t = null
        set caster = null
        set effg = null
        set u = null
    endif
    set casterx = GetUnitX(caster)
    set castery = GetUnitY(caster)
    set effg = CreateGroup()
    set f = Filter(function Trig_Meirin02_Target)
    call GroupEnumUnitsInRange(effg, GetUnitX(caster), GetUnitY(caster), 100, f)
    call DestroyBoolExpr(f)
    call GroupRemoveUnit(effg, caster)
    loop
        set u = FirstOfGroup(effg)
        exitwhen(u == null)
        if IsMobileUnit(u) then
            set ux = GetUnitX(u)
            set uy = GetUnitY(u)
            call MeilingPushUnit(u, 50, Atan2(uy-castery, ux-casterx))
        endif
        call GroupRemoveUnit(effg, u)
    endloop
    call SaveInteger(udg_Hashtable, tid, 1, count+1)
    call DestroyGroup(effg)
    set t = null
    set caster = null
    set effg = null
    set f = null
    set u = null
endfunction

function Trig_Meirin04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t = CreateTimer()
    local integer tid = GetHandleId(t)
    //local trigger tr = CreateTrigger()
    local timer t2 = CreateTimer()
    local integer t2id = GetHandleId(t2)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = Atan2(ty-oy,tx-ox)
    //========
    local real abilitycooldownlv01 = 120
    local real abilitycooldownlv02 = 105
    local real abilitycooldownlv03 = 90
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    
    call SaveReal(udg_Hashtable,tid,0,a)
    call SaveUnitHandle(udg_Hashtable, tid, 0, caster)
    call SaveInteger(udg_Hashtable, tid, 0, level)
    call SaveInteger(udg_Hashtable, tid, 1, 1)
    call TimerStart(t, 0.5, true, function MeilingSkill4ActMain)
    
    call SaveUnitHandle(udg_Hashtable, t2id, 0,caster)
    call SaveInteger(udg_Hashtable,t2id, 1, 1)
    call TimerStart(t2, 0.33, true, function MeilingSkill4PushUnit)
    call UnitAddAbility(caster,'A0AN')
    //call TriggerRegisterUnitEvent(tr, caster, EVENT_UNIT_DEATH)
    //call TriggerAddAction(tr, function MeilingSkill4Break)
    //call SaveTimerHandle(udg_Hashtable, GetHandleId(tr), 1, t)
    //call SaveTimerHandle(udg_Hashtable, GetHandleId(tr), 2, t2)
    //call SaveTriggerHandle(udg_Hashtable, tid, 4, tr)
    
    //set tr = null
    set caster = null
    set t = null
    set t2 = null
endfunction

//===========================================================================
function InitTrig_Meirin04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Init Meirin
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Meirin_Actions takes nothing returns nothing
    local integer i
    local unit h = GetCharacterHandle('E013')
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)

    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    //gg_trg_MeirinStar
    call SaveUnitHandle(udg_ht,task,0,h)
    call TimerStart(t,1.00,true,function Trig_MeirinStar_Actions)

    set gg_trg_Meirin = null
    
    set gg_trg_Meirin01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Meirin01, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Meirin01, Condition( function Trig_Meirin01_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Meirin01, function Trig_Meirin01_Learn_Actions )
    
    set gg_trg_Meirin02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Meirin02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Meirin02, Condition( function Trig_Meirin02_Conditions ) )
    call TriggerAddAction( gg_trg_Meirin02, function Trig_Meirin02_Actions )
    
    set gg_trg_Meirin03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Meirin03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Meirin03, Condition( function Trig_Meirin03_Conditions ) )
    call TriggerAddAction( gg_trg_Meirin03, function Trig_Meirin03_Actions )
    
    set gg_trg_Meirin04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Meirin04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Meirin04, Condition( function Trig_Meirin04_Conditions ) )
    call TriggerAddAction( gg_trg_Meirin04, function Trig_Meirin04_Actions )
    
    set i = 0
    set udg_SK_Meirin_RGB[i+0] = 255
    set udg_SK_Meirin_RGB[i+1] = 0
    set udg_SK_Meirin_RGB[i+2] = 0
    set i = i + 3
    set udg_SK_Meirin_RGB[i+0] = 255
    set udg_SK_Meirin_RGB[i+1] = 127
    set udg_SK_Meirin_RGB[i+2] = 0
    set i = i + 3
    set udg_SK_Meirin_RGB[i+0] = 255
    set udg_SK_Meirin_RGB[i+1] = 255
    set udg_SK_Meirin_RGB[i+2] = 0
    set i = i + 3
    set udg_SK_Meirin_RGB[i+0] = 127
    set udg_SK_Meirin_RGB[i+1] = 255
    set udg_SK_Meirin_RGB[i+2] = 0
    set i = i + 3
    set udg_SK_Meirin_RGB[i+0] = 0
    set udg_SK_Meirin_RGB[i+1] = 255
    set udg_SK_Meirin_RGB[i+2] = 0
    set i = i + 3
    set udg_SK_Meirin_RGB[i+0] = 0
    set udg_SK_Meirin_RGB[i+1] = 255
    set udg_SK_Meirin_RGB[i+2] = 127
    set i = i + 3
    set udg_SK_Meirin_RGB[i+0] = 0
    set udg_SK_Meirin_RGB[i+1] = 255
    set udg_SK_Meirin_RGB[i+2] = 255
    set i = i + 3
    set udg_SK_Meirin_RGB[i+0] = 0
    set udg_SK_Meirin_RGB[i+1] = 127
    set udg_SK_Meirin_RGB[i+2] = 255
    set i = i + 3
    set udg_SK_Meirin_RGB[i+0] = 0
    set udg_SK_Meirin_RGB[i+1] = 0
    set udg_SK_Meirin_RGB[i+2] = 255
    set i = i + 3
    set udg_SK_Meirin_RGB[i+0] = 127
    set udg_SK_Meirin_RGB[i+1] = 0
    set udg_SK_Meirin_RGB[i+2] = 255
    set i = i + 3
    set udg_SK_Meirin_RGB[i+0] = 255
    set udg_SK_Meirin_RGB[i+1] = 0
    set udg_SK_Meirin_RGB[i+2] = 255
    set i = i + 3
    set udg_SK_Meirin_RGB[i+0] = 255
    set udg_SK_Meirin_RGB[i+1] = 0
    set udg_SK_Meirin_RGB[i+2] = 127
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Meirin takes nothing returns nothing
    set gg_trg_Init_Meirin = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Meirin, function Trig_Init_Meirin_Actions )
endfunction
//===========================================================================
// Trigger: Alice Dolls
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function GetDollType takes unit u returns integer
    local integer d = GetUnitTypeId(u)
    if d=='h01C' then
        return 1
    endif
    if d=='h01B' or d=='h01E' then
        return 2
    endif
    if d=='h01D' or d=='h01F' then
        return 3
    endif
    return 0
endfunction

function ConvertDollType takes integer d returns integer
    if d==1 then
        return 'h01C'
    endif
    if d==2 then
        return 'h01B'
    endif
    if d==3 then
        return 'h01D'
    endif
    return 0
endfunction

function CountDollsInGroupEnum takes nothing returns nothing
    local unit u = GetEnumUnit()
    if IsUnitDead(u) then
        call GroupRemoveUnit(udg_SK_AliceDollsCountingGroup,u)
    else
        set udg_SK_AliceDollsCounting = udg_SK_AliceDollsCounting + 1
    endif
    set u = null
endfunction

function CountDollsInGroup takes group g returns integer
    set udg_SK_AliceDollsCounting = 0
    set udg_SK_AliceDollsCountingGroup = g
    call ForGroup(g,function CountDollsInGroupEnum)
    set udg_SK_AliceDollsCountingGroup = null
    return udg_SK_AliceDollsCounting
endfunction

function ChangeDollLifeAndAttack takes unit doll,integer atk,integer life returns nothing
    
    //附加生命
    call UnitAddAbility(doll, 'A0H5')
    call SetUnitAbilityLevel(doll, 'A0H5', R2I(life/1000)+1)
    call UnitRemoveAbility(doll,'A0H5')
    set life = life - R2I(life/1000)*1000
    
    call UnitAddAbility(doll, 'A0H4')
    call SetUnitAbilityLevel(doll, 'A0H4', R2I(life/100)+1)
    call UnitRemoveAbility(doll,'A0H4')
    set life = life - R2I(life/100)*100
    
    call UnitAddAbility(doll,'A0H3')
    call SetUnitAbilityLevel(doll, 'A0H3', R2I(life/10)+1)
    call UnitRemoveAbility(doll,'A0H3')
    set life = life - R2I(life/10)*10
    
    call UnitAddAbility(doll, 'A0H2')
    call SetUnitAbilityLevel(doll, 'A0H2',life+1)
    call UnitRemoveAbility(doll, 'A0H2')
    
    //附加攻击
    call UnitAddAttackDamage(doll,atk)
    
endfunction

function SetDollProperty takes unit caster,unit u returns nothing
    local integer AGI = GetHeroAgi(caster,true)
    local integer INT = GetHeroInt(caster,true)
    local integer ATK = AGI/2
    local integer HP = INT*4
    if GetDollType(u)==1 then
        set HP = HP + INT
    endif
    call ChangeDollLifeAndAttack(u,ATK,HP)
endfunction

function RemoveDoll takes unit caster,unit u,boolean remove returns nothing
    local integer task = GetHandleId(caster)
    local integer d = GetDollType(u)
    local real px = GetUnitX(u)
    local real py = GetUnitY(u)
    local real mana = 0.0
    local group g
    if d>0 then
        set mana = 50.0
        set g = LoadGroupHandle(udg_sht,GetHandleId(caster),d)
        call GroupRemoveUnit(g,u)
        call FlushChildHashtable(udg_sht,GetHandleId(u))
    endif
    if remove then
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DarkRitual\\DarkRitualTarget.mdl",px,py))
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Undead\\DarkRitual\\DarkRitualCaster.mdl",caster,"origin"))
        call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA)+mana)
        call RemoveUnit(u)
    endif
    set g = null
endfunction

function CreateDoll takes unit caster, integer d, real x, real y, real a,code f returns unit
    local unit u
    local lightning e
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real oz = GetPositionZ(ox,oy)
    local real z = GetPositionZ(x,y)
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    set u = CreateUnit(GetOwningPlayer(caster),d,x,y,a)
    call EnableHeight(u)
    set z = z + GetUnitFlyHeight(u)
    set e = AddLightningEx("DSTR",false,ox,oy,oz+80.0,x,y,z+40.0)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveLightningHandle(udg_ht,task,2,e)
    call TimerStart(t,0.03,true,f)
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\TomeOfRetraining\\TomeOfRetrainingCaster.mdl",x,y))
    call UnitAddAbility(u,'A0H6')
    call UnitMakeAbilityPermanent(u,true,'A0H6')
    call UnitAddAbility(u,'A0H7')
    call UnitMakeAbilityPermanent(u,true,'A0H7')
    call UnitAddAbility(u,'A0H8')
    call UnitMakeAbilityPermanent(u,true,'A0H8')
    call UnitAddAbility(u,'A0H9')
    call UnitMakeAbilityPermanent(u,true,'A0H9')
    call SaveUnitHandle(udg_sht,GetHandleId(u),0,caster)
    //========
    set bj_lastCreatedUnit = u
    set u = null
    set e = null
    set t = null
    return bj_lastCreatedUnit
endfunction

//===========================================================================
function InitTrig_Alice_Dolls takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Alice Dolls KIA
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Alice_Dolls_KIA_Conditions takes nothing returns boolean
    local integer d = GetUnitTypeId(GetTriggerUnit())
    return ('h01B'<=d) and (d<='h01F') and IsUnitIllusion(GetTriggerUnit())==false
endfunction

function Trig_Alice_Dolls_KIA_Actions takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local unit h = LoadUnitHandle(udg_sht,GetHandleId(u),0)
    local real x = GetUnitX(u)
    local real y = GetUnitY(u)
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\FeralSpirit\\feralspirittarget.mdl",x,y))
    call RemoveDoll(h,u,false)
    set h = null
    set u = null
endfunction

function InitTrig_Alice_Dolls_KIA takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Alice Dolls Back
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Alice_Dolls_Back_Conditions takes nothing returns boolean
    if GetSpellAbilityId()!='A0GZ' then
        return false
    endif
    return IsUnitIllusion(GetSpellTargetUnit())==false
endfunction

function Trig_Alice_Dolls_Back_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    if GetDollType(target)>0 and GetUnitAbilityLevel(target,'A0HR')==0 then
        call RemoveDoll(caster,target,true)
    endif
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Alice_Dolls_Back takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Shanghai01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Shanghai01_Conditions takes nothing returns boolean
    local unit caster = null
    if GetIssuedOrderId()==OrderId("defend") then
        set caster = GetTriggerUnit()
        call UnitAddAbility(caster,'AIsr')
        call UnitAddAbility(caster,'A0HH')
        call SetUnitAbilityLevel(caster,'A0HG',GetUnitAbilityLevel(caster,'A0HF'))
        if GetUnitAbilityLevel(caster,'B044')>0 then
            call UnitRemoveAbility(caster,'B044')
        endif
        if GetUnitAbilityLevel(caster,'A0HW')>0 then
            call UnitRemoveAbility(caster,'A0HW')
        endif
        set caster = null
        return false
    endif
    if GetIssuedOrderId()==OrderId("undefend") then
        set caster = GetTriggerUnit()
        call UnitRemoveAbility(caster,'AIsr')
        call UnitRemoveAbility(caster,'A0HH')
        set caster = null
        return false
    endif
    set caster = null
    return false
endfunction

function Trig_Shanghai01_Actions takes nothing returns nothing
endfunction

//===========================================================================
function InitTrig_Shanghai01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Shanghai02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Shanghai02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0HI'
endfunction

function Trig_Shanghai02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local boolean o = GetUnitAbilityLevel(caster,'A0HW')>=1
    local boolean k = GetUnitAbilityLevel(caster,'A0HR')==0 and o
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i>0 and IsUnitAlive(caster) and k then
        call SetUnitLifePercentBJ(u,100.0)
        call SetUnitX(u,ox)
        call SetUnitY(u,oy)
        call IssueImmediateOrder(u,"fanofknives")
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call UnitRemoveAbility(caster,'A0HW')
        call AddUnitAnimationProperties(caster,"spin",false)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Shanghai02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    if GetUnitAbilityLevel(caster,'A0HH')>0 then
        call IssueImmediateOrder(caster,"undefend")
    endif
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),GetUnitX(caster),GetUnitY(caster),270.0)
    call UnitAddAbility(u,'A0HJ')
    call SetUnitAbilityLevel(u,'A0HJ',level)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,10)
    call TimerStart(t,0.5,true,function Trig_Shanghai02_Main)
    call UnitRemoveAbility(caster,'BOww')
    call UnitAddAbility(caster,'A0HW')
    call AddUnitAnimationProperties(caster,"spin",true)
    //========
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Shanghai02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Shanghai03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Shanghai03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0HN'
endfunction

function Trig_Shanghai03_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local unit caster = LoadUnitHandle(udg_ht,GetHandleId(t),0)
    if IsUnitDeadBJ(caster) or GetUnitAbilityLevel(caster,'B044')==0 then
        call UnitRemoveAbility(caster,'Aeth')
        call SetUnitFlyHeight(caster,45.0,50.0)
        call FlushChildHashtable(udg_ht,GetHandleId(t))
        call DestroyTimer(t)
    endif
    set t = null
    set caster = null
endfunction

function Trig_Shanghai03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t
    if GetUnitAbilityLevel(caster,'A0HG')>0 then
        call DisableTrigger(gg_trg_Shanghai01)
        call IssueImmediateOrder(caster,"undefend")
        call UnitRemoveAbility(caster,'A0HH')
        call EnableTrigger(gg_trg_Shanghai01)
    endif
    call UnitAddAbility(caster,'Aeth')
    call SetUnitFlyHeight(caster,GetRandomReal(0,130.0),50.0)
    set t = CreateTimer()
    call SaveUnitHandle(udg_ht,GetHandleId(t),0,caster)
    call TimerStart(t,0.2,true,function Trig_Shanghai03_Main)
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Shanghai03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Shanghai04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Shanghai04_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0HO'
endfunction

function Trig_Shanghai04_Hit takes nothing returns nothing
    local location target
    local integer task
    local unit v = GetEnteringUnit()
    local unit u
    //========
    if GetTriggerEventId()==EVENT_UNIT_ISSUED_POINT_ORDER then
        set task = GetHandleId(GetTriggerUnit())
        set u = LoadUnitHandle(udg_sht,task,0)
        set target = LoadLocationHandle(udg_sht,task,1)
        if IsUnitInRange(u,GetTriggerUnit(),1200.0) then
            call MoveLocation(target,GetOrderPointX(),GetOrderPointY())
        endif
        call IssueImmediateOrder(GetTriggerUnit(),"stop")
    elseif GetTriggerEventId()==EVENT_UNIT_ISSUED_TARGET_ORDER then
        set task = GetHandleId(GetTriggerUnit())
        set u = LoadUnitHandle(udg_sht,task,0)
        set target = LoadLocationHandle(udg_sht,task,1)
        if IsUnitInRange(u,GetTriggerUnit(),1200.0) then
            set v = GetOrderTargetUnit()
            call MoveLocation(target,GetUnitX(v),GetUnitY(v))
        endif
        call IssueImmediateOrder(GetTriggerUnit(),"stop")
    elseif IsUnitAlive(v) then
        set task = GetHandleId(GetTriggeringTrigger())
        set u = LoadUnitHandle(udg_ht,task,1)
        call SetUnitX(u,GetUnitX(v)-5.0)
        call SetUnitY(u,GetUnitY(v))
        call IssueTargetOrder(u,"thunderbolt",v)
    endif
    //========
    set target = null
    set u = null
    set v = null
endfunction

function Trig_Shanghai04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit h = LoadUnitHandle(udg_sht,GetHandleId(caster),0)
    local location target = LoadLocationHandle(udg_sht,GetHandleId(caster),1)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetLocationX(target)
    local real ty = GetLocationY(target)
    local real dx = tx - ox
    local real dy = ty - oy
    local real px
    local real py
    local real a = LoadReal(udg_ht,task,0)
    local real e
    local real s = 3.0
    //local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer n = LoadInteger(udg_ht,task,2)
    local boolean k = (i/5*5==i)
    local trigger trg
    local triggeraction tga
    //========
    if i>0 and IsUnitAlive(caster) then
        call SetUnitLifePercentBJ(u,100.0)
        call SaveInteger(udg_ht,task,1,i - 1)
        if SquareRoot(dy*dy+dx*dx)<=150.0 then
            set tx = ox + 3000.0*CosBJ(a)
            set ty = oy + 3000.0*SinBJ(a)
            call MoveLocation(target,tx,ty)
        endif
        if not IsUnitInRange(h,caster,1100.0) then
            set tx = GetUnitX(h)
            set ty = GetUnitY(h)
            set e = bj_RADTODEG*Atan2(oy-ty,ox-tx)
            if YawError(a,e)<=0.0 then
                set e = e + 144.0
            else
                set e = e - 144.0
            endif
            set tx = tx + 1200.0*CosBJ(e)
            set ty = ty + 1200.0*SinBJ(e)
            call MoveLocation(target,tx,ty)
            set s = 4.0
            if not IsUnitInRange(h,caster,2400.0) then
                call SaveInteger(udg_ht,task,1,0)
            endif
        else
            set s = 3.0
        endif
        set e = YawError(a,bj_RADTODEG*Atan2(ty-oy,tx-ox))
        if e>=0.0 then
            set e = RMinBJ(e,s)
        else
            set e = RMaxBJ(e,-s)
        endif
        set a = a + e
        if a<0.0 then
            set a = a + 360.0
        elseif a>=360.0 then
            set a = a - 360.0
        endif
        call SaveReal(udg_ht,task,0,a)
        call IssueImmediateOrder(caster,"stop")
        call SetUnitAnimation(caster,"spell channel")
        call SetUnitFacing(caster,a)
        set px = ox + 16.0*CosBJ(a)
        set py = oy + 16.0*SinBJ(a)
        if IsTerrainPathable(px,py,PATHING_TYPE_FLYABILITY)==false then
            call SetUnitX(caster,px)
            call SetUnitY(caster,py)
            call SetUnitX(u,px)
            call SetUnitY(u,py)
        endif
        //if k then
        //    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\FreezingBreath\\FreezingBreathMissile.mdl",ox,oy))
        //endif
        set i = 2
        loop
            exitwhen i>n
            set h = udg_SK_ShanghaiJSA[13 - i]
            set u = udg_SK_ShanghaiJSA[12 - i]
            set tx = GetUnitX(h)
            set ty = GetUnitY(h)
            set ox = GetUnitX(u)
            set oy = GetUnitY(u)
            set dx = tx - ox
            set dy = ty - oy
            set a = Atan2(dy,dx)
            set e = RMinBJ(30.0,SquareRoot(dy*dy+dx*dx)/5.0)
            set px = ox + e*Cos(a)
            set py = oy + e*Sin(a)
            call SetUnitFacing(u,bj_RADTODEG*a)
            call SetUnitX(u,px)
            call SetUnitY(u,py)
            set i = i + 1
        endloop
    else
        call RemoveUnit(u)
        call DestroyEffect(LoadEffectHandle(udg_ht,task,2))
        set trg = LoadTriggerHandle(udg_ht,task,3)
        set tga = LoadTriggerActionHandle(udg_ht,task,4)
        call FlushChildHashtable(udg_ht,GetHandleId(trg))
        call TriggerRemoveAction(trg,tga)
        call DestroyTrigger(trg)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        call RemoveLocation(target)
        set i = 1
        loop
            exitwhen i>n
            set u = udg_SK_ShanghaiJSA[12 - i]
            set udg_SK_ShanghaiJSA[12 - i] = null
            if u!=caster then
                call PauseUnit(u,false)
                call DestroyEffect(LoadEffectHandle(udg_sht,GetHandleId(u),1))
                //if i==2 then
                //    call DestroyEffect(LoadEffectHandle(udg_sht,GetHandleId(u),2))
                //endif
            endif
            call UnitRemoveAbility(u,'A0HR')
            call SetUnitAnimation(u,"stand")
            call IssueImmediateOrder(u,"stop")
            call SetUnitPathing(u,true)
            call SetUnitInvulnerable(u,false)
            call SetUnitFlag(u,CS_DASHING(),false)
            set i = i + 1
        endloop
        call EnableTrigger(gg_trg_Shanghai04)
    endif
    //========
    set t = null
    set caster = null
    set target = null
    set u = null
    set h = null
    set trg = null
    set tga = null
endfunction

function Trig_Shanghai04_Shanghai takes nothing returns boolean
    if GetUnitTypeId(GetFilterUnit())!='h01C' then
        return false
    endif
    if IsUnitIllusion(GetFilterUnit()) then
        return false
    endif
    return not IsUnitDead(GetFilterUnit())
endfunction

function Trig_Shanghai04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit h = LoadUnitHandle(udg_sht,GetHandleId(caster),0)
    local real mana = GetUnitState(h,UNIT_STATE_MANA)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local location target = GetSpellTargetLoc()
    local integer level = GetUnitAbilityLevel(caster,'A0HQ')
    local timer t = CreateTimer()
    local integer task
    local unit u
    local effect e
    local group g = CreateGroup()
    local boolexpr f = Filter(function Trig_Shanghai04_Shanghai)
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local trigger trg = CreateTrigger()
    local triggeraction tga
    local integer n
    local integer i
    //========
    call DisableTrigger(gg_trg_Shanghai04)
    set n = 1
    set udg_SK_ShanghaiJSA[12 - n] = caster
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    call GroupEnumUnitsInRange(g,GetUnitX(h),GetUnitY(h),1200.0,f)
    call GroupRemoveUnit(g,caster)
    loop
        set u = FirstOfGroup(g)
        exitwhen u==null
        call GroupRemoveUnit(g,u)
        if GetUnitAbilityLevel(u,'A0HW')==0 then
            set n = n + 1
            set udg_SK_ShanghaiJSA[12 - n] = u
        endif
        exitwhen n>=12
    endloop
    call DestroyBoolExpr(f)
    call DestroyGroup(g)
    //========
    if n>=6 then//and mana>=600.0 then
        if GetUnitAbilityLevel(h,'A0HU')==0 then
            call UnitAddAbility(h,'A0HU')
        endif
        call IssueImmediateOrder(h,"starfall")
        //call SetUnitState(h,UNIT_STATE_MANA,mana-600.0)
        set tga = TriggerAddAction(trg,function Trig_Shanghai04_Hit)
        //========
        set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,0.0)
        call UnitAddAbility(u,'A0HP')
        call SetUnitAbilityLevel(u,'A0HP',level)
        call DebugMsg("level:"+I2S(level))
        //========
        set task = GetHandleId(trg)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveUnitHandle(udg_ht,task,1,u)
        //========
        set task = GetHandleId(t)
        set e = AddSpecialEffectTarget("Abilities\\Spells\\Orc\\Shockwave\\ShockwaveMissile.mdl",caster,"origin")
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveUnitHandle(udg_ht,task,1,u)
        call SaveEffectHandle(udg_ht,task,2,e)
        call SaveTriggerHandle(udg_ht,task,3,trg)
        call SaveTriggerActionHandle(udg_ht,task,4,tga)
        call SaveInteger(udg_ht,task,0,level)
        call SaveInteger(udg_ht,task,1,600)
        call SaveInteger(udg_ht,task,2,n)
        call SaveReal(udg_ht,task,0,a)
        call TimerStart(t,0.02,true,function Trig_Shanghai04_Main)
        //========
        call SaveLocationHandle(udg_sht,GetHandleId(caster),1,target)
        call SetUnitFacing(caster,a)
        call UnitAddAbility(caster,'A0HR')
        call UnitMakeAbilityPermanent(caster,true,'A0HR')
        call SetUnitPathing(caster,false)
        call SetUnitFlag(caster,CS_DASHING(),true)
        call SetUnitInvulnerable(caster,true)
        call TriggerRegisterUnitInRange(trg,caster,90.0,iff)
        set i = 2
        loop
            exitwhen i>n
            set u = udg_SK_ShanghaiJSA[12 - i]
            call UnitAddAbility(u,'A0HR')
            call UnitMakeAbilityPermanent(u,true,'A0HR')
            call SetUnitPathing(u,false)
            call SetUnitFlag(u,CS_DASHING(),true)
            call SetUnitInvulnerable(u,true)
            call TriggerRegisterUnitInRange(trg,u,90.0,iff)
            call PauseUnit(u,true)
            set e = AddSpecialEffectTarget("Abilities\\Spells\\Orc\\Shockwave\\ShockwaveMissile.mdl",u,"origin")
            call SaveEffectHandle(udg_sht,GetHandleId(u),1,e)
            //if i==2 then
            //    set e = AddSpecialEffectTarget("Doodads\\LordaeronSummer\\Props\\BannerHuman\\BannerHuman1.mdl",u,"overhead")
            //    call SaveEffectHandle(udg_sht,GetHandleId(u),2,e)
            //endif
            call SetUnitAnimation(u,"spell channel")
            set i = i + 1
        endloop
    else
        //if mana<600.0 then
        //    call DisplayTextToPlayer(GetOwningPlayer(caster),0.0,0.0,"|cffff1100当前爱丽丝的魔法不足以发动音速强袭！|r")
        //else
        //    call SetUnitState(h,UNIT_STATE_MANA,mana+600.0)
        //endif
        call DisplayTextToPlayer(GetOwningPlayer(caster),0.0,0.0,"|cffff1100当前上海人偶的数量不足以发动音速强袭！|r")
        call DestroyTimer(t)
        call DestroyTrigger(trg)
        call RemoveLocation(target)
        call EnableTrigger(gg_trg_Shanghai04)
    endif
    //========
    set caster = null
    set target = null
    set h = null
    set t = null
    set u = null
    set e = null
    set f = null
    set g = null
    set iff = null
    set trg = null
    set tga = null
endfunction

//===========================================================================
function InitTrig_Shanghai04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Shanghai04 Issue
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Shanghai04_Issue_Conditions takes nothing returns boolean
    return GetIssuedOrderId()==OrderId("impale")
endfunction

function Trig_Shanghai04_Issue_Actions takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local unit h = LoadUnitHandle(udg_sht,GetHandleId(u),0)
    local real tx = GetOrderPointX()
    local real ty = GetOrderPointY()
    call IssuePointOrder(h,"impale",tx,ty)
    set u = null
    set h = null
endfunction

//===========================================================================
function InitTrig_Shanghai04_Issue takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Shanghai04 Alice
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Shanghai04_Alice_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0HU'
endfunction

function Trig_Shanghai04_Alice_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local unit v
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real dx
    local real dy
    local real d
    local real s = 999999.9
    local group g = CreateGroup()
    local boolexpr f = Filter(function Trig_Shanghai04_Shanghai)
    local integer n
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    //排序，找最近的上海来放
    set n = 0
    set u = null
    set v = null
    call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),1200.0,f)
    loop
        set u = FirstOfGroup(g)
        exitwhen u==null
        call GroupRemoveUnit(g,u)
        set n = n + 1
        set dx = GetUnitX(u) - tx
        set dy = GetUnitY(u) - ty
        set d = SquareRoot(dx*dx + dy*dy)
        if d<s then
            set v = u
            set s = d
        endif
        exitwhen n>=12
    endloop
    call DestroyBoolExpr(f)
    call DestroyGroup(g)
    //========
    if n<6 then
        call DisplayTextToPlayer(GetOwningPlayer(caster),0.0,0.0,"|cffff1100当前上海人偶的数量不足以发动音速强袭！|r")
        call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA)+300.0)
        call UnitRemoveAbility(caster,'A0HU')
        call UnitAddAbility(caster,'A0HU')
        call SetUnitAbilityLevel(caster,'A0HU',level)
    else
        call IssuePointOrder(v,"shockwave",tx,ty)
    endif
    //========
    set caster = null
    set f = null
    set g = null
    set u = null
    set v = null
endfunction

//===========================================================================
function InitTrig_Shanghai04_Alice takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Hourai01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Hourai01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0HA'
endfunction

function Trig_Hourai01_Actions takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local unit h = LoadUnitHandle(udg_sht,GetHandleId(u),0)
    local group g = LoadGroupHandle(udg_sht,GetHandleId(h),3)
    local real HP = GetUnitLifePercent(u)
    local real MP = GetUnitManaPercent(u)
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local real a = GetUnitFacing(u)
    
    call FlushChildHashtable(udg_sht,GetHandleId(u))
    call GroupRemoveUnit(g,u)
    call RemoveUnit(u)
    set u = CreateUnit(GetOwningPlayer(h),'h01F',ox,oy,a)
    call GroupAddUnit(g,u)
    call SetDollProperty(h,u)
    call SetUnitLifePercentBJ(u,HP)
    call SetUnitManaPercentBJ(u,MP)
    call UnitApplyTimedLife(u,'B02I',180.0)
    call SaveUnitHandle(udg_sht,GetHandleId(u),0,h)
    call SetUnitColor(u,PLAYER_COLOR_PURPLE)
    
    set u = null
    set h = null
    set g = null
endfunction

//===========================================================================
function InitTrig_Hourai01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Hourai02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Hourai02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0HC'
endfunction

function Trig_Hourai02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_SPELL_EFFECT then
        call UnitAddAbility(caster,'A0HB')
        if GetUnitTypeId(caster)=='h01F' then
            call UnitRemoveAbility(caster,'Agho')
            call UnitAddAbility(caster,'Aeth')
        endif
    else
        call UnitRemoveAbility(caster,'A0HB')
        if GetUnitTypeId(caster)=='h01F' then
            call UnitRemoveAbility(caster,'Aeth')
            call UnitAddAbility(caster,'Agho')
        endif
    endif
    set caster = null
endfunction

//===========================================================================
function InitTrig_Hourai02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Hourai04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Hourai04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0H0'
endfunction

function Trig_Hourai04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    
    call SetUnitFacing(caster,a)
    
    set tx = ox + 30.0*CosBJ(a)
    set ty = oy + 30.0*SinBJ(a)
    
    set u = CreateUnit(GetOwningPlayer(caster),'n03I',tx,ty,a)
    call SetUnitTimeScale(u,1.5)
    call UnitApplyTimedLife(u,'BTLF',0.1)
    
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,a)
    call UnitAddAbility(u,'A0H1')
    call SetUnitAbilityLevel(u,'A0H1',level)
    call IssuePointOrder(u,"breathoffrost",tx,ty)
    
    //========
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Hourai04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: NewEngland01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_NewEngland01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0HD'
endfunction

function Trig_NewEngland01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),ox,oy,0.0)
    call UnitAddAbility(u,'A0HK')
    call SetUnitAbilityLevel(u,'A0HK',level)
    call IssueImmediateOrder(u,"fanofknives")
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\Mortar\\MortarMissile.mdl",ox,oy))
    call KillUnit(caster)
    //========
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_NewEngland01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: NewEngland03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_NewEngland03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == '0000'
endfunction

function Trig_NewEngland03_Actions takes nothing returns nothing
endfunction

//===========================================================================
function InitTrig_NewEngland03 takes nothing returns nothing
    //set gg_trg_NewEngland03 = CreateTrigger()
    //call TriggerRegisterPlayerUnitEvent( gg_trg_NewEngland03, w, EVENT_PLAYER_UNIT_SPELL_EFFECT, null )
    //call TriggerAddCondition( gg_trg_NewEngland03, Condition( function Trig_NewEngland03_Conditions ) )
    //call TriggerAddAction( gg_trg_NewEngland03, function Trig_NewEngland03_Actions )
endfunction

//===========================================================================
// Trigger: NewEngland04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_NewEngland04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0HL'
endfunction

function Trig_NewEngland04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real dx
    local real dy
    local real tx
    local real ty
    local real v = LoadReal(udg_ht,task,2)
    local real s = LoadReal(udg_ht,task,3)
    local real a = LoadReal(udg_ht,task,4)
    local real e
    local real damage
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local boolean k = true
    //========
    if i>0 and IsUnitAlive(caster) then
        if IsUnitVisible(target,GetOwningPlayer(caster)) then
            if IsUnitAlive(target) then
                set tx = GetUnitX(target)
                set ty = GetUnitY(target)
                call SaveReal(udg_ht,task,0,tx)
                call SaveReal(udg_ht,task,1,ty)
            else
                set tx = LoadReal(udg_ht,task,0)
                set ty = LoadReal(udg_ht,task,1)
            endif
            set k = true
        else
            set k = false
        endif
        if k then
            set dy = ty - oy
            set dx = tx - ox
        endif
        if k and SquareRoot(dy*dy+dx*dx)<=40.0 then
            set damage = 45.0 + level*15.0
            call UnitDamageTarget(caster,target,damage,true,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_DEMOLITION,WEAPON_TYPE_WHOKNOWS)
            call SaveInteger(udg_ht,task,1,0)
            call DebugMsg("击中目标")
        else
            if k then
                //飞行方向修正
                set e = YawError(a,bj_RADTODEG*Atan2(dy,dx))
                if RAbsBJ(e)<=30.0 then
                    if e>=0.0 then
                        set e = RMinBJ(e,2.0)
                    else
                        set e = RMaxBJ(e,-2.0)
                    endif
                    set a = a + e
                    if a<0.0 then
                        set a = a + 360.0
                    elseif a>=360.0 then
                        set a = a - 360.0
                    endif
                endif
            endif
            set v = v + 0.025*(s-v)
            call SaveReal(udg_ht,task,2,v)
            call SaveReal(udg_ht,task,4,a)
            call SetUnitFacing(caster,a)
            set v = v/50.0
            set dx = ox + v*CosBJ(a)
            set dy = oy + v*SinBJ(a)
            if IsTerrainPathable(dx,dy,PATHING_TYPE_FLYABILITY)==false then
                call SetUnitX(caster,dx)
                call SetUnitY(caster,dy)
                call SaveInteger(udg_ht,task,1,i - 1)
            else
                call SaveInteger(udg_ht,task,1,0)
            endif
        endif
    else
        if IsUnitAliveBJ(caster) then
            call SetUnitFlag(caster,CS_DASHING(),true)
            call PauseUnit(caster,false)
        endif
        call DestroyEffect(LoadEffectHandle(udg_ht,task,2))
        set u = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,0.0)
        call SetUnitFlyHeight(u,100.0,200000.0)
        call UnitAddAbility(u,'A0HT')
        call SetUnitAbilityLevel(u,'A0HT',level)
        call IssueImmediateOrder(u,"fanofknives")
        call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\DemolisherFireMissile\\DemolisherFireMissile.mdl",ox,oy))
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        call KillUnit(caster)
    endif
    //========
    set t = null
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_NewEngland04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local effect e
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    call SetUnitState(caster,UNIT_STATE_LIFE,0.3*GetUnitState(caster,UNIT_STATE_LIFE))
    call SelectUnitRemoveForPlayer(caster,GetOwningPlayer(caster))
    call SetUnitFlag(caster,CS_DASHING(),true)
    call PauseUnit(caster,true)
    call UnitAddAbility(caster,'A0HR')
    set e = AddSpecialEffectTarget("Abilities\\Weapons\\PhoenixMissile\\Phoenix_Missile.mdl",caster,"chest")
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveEffectHandle(udg_ht,task,2,e)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,150)
    call SaveReal(udg_ht,task,0,GetUnitX(target))
    call SaveReal(udg_ht,task,1,GetUnitY(target))
    call SaveReal(udg_ht,task,2,300.0)
    call SaveReal(udg_ht,task,3,900.0)
    call SaveReal(udg_ht,task,4,a)
    call TimerStart(t,0.02,true,function Trig_NewEngland04_Main)
    //========
    set caster = null
    set target = null
    set t = null
    set e = null
endfunction

//===========================================================================
function InitTrig_NewEngland04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Alice
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Alice_Conditions takes nothing returns boolean
    return true
endfunction

function Trig_Alice_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer task = GetHandleId(caster)
    local integer d = GetLearnedSkill()
    local integer level = GetUnitAbilityLevel(caster,d)
    
    if d=='A0GV' then
        set d = LoadInteger(udg_sht,task,1)
        call SaveInteger(udg_sht,task,1,d + 1)
        call SetPlayerTechResearched(GetOwningPlayer(caster),'R007',level)
        
        if level>=4 then
            if GetUnitAbilityLevel(caster,'A0HU')==0 then
                call UnitAddAbility(caster,'A0HU')
                call UnitMakeAbilityPermanent(caster,true,'A0HU')
            endif
            set level = GetUnitAbilityLevel(caster,'A0GY')
            if level>0 then
                call SetUnitAbilityLevel(caster,'A0HU',level+1)
            endif
        endif
        
    endif
    
    if d=='A0GW' then
        set d = LoadInteger(udg_sht,task,2)
        call SaveInteger(udg_sht,task,2,d + 1)
        call SetPlayerTechResearched(GetOwningPlayer(caster),'R008',level)
    endif
    
    if d=='A0GX' then
        set d = LoadInteger(udg_sht,task,3)
        call SaveInteger(udg_sht,task,3,d + 1)
        call SetPlayerTechResearched(GetOwningPlayer(caster),'R009',level)
    endif
    
    if d=='A0GY' then
        set d = LoadInteger(udg_sht,task,1)
        call SaveInteger(udg_sht,task,1,d + 2)
        set d = LoadInteger(udg_sht,task,2)
        call SaveInteger(udg_sht,task,2,d + 2)
        set d = LoadInteger(udg_sht,task,3)
        call SaveInteger(udg_sht,task,3,d + 2)
        call SetPlayerTechResearched(GetOwningPlayer(caster),'R006',level)
        call SetPlayerTechResearched(GetOwningPlayer(caster),'R00A',level)
        
        if GetUnitAbilityLevel(caster,'A0HU')>0 then
            call SetUnitAbilityLevel(caster,'A0HU',level+1)
        endif
        
    endif
    
    if GetUnitAbilityLevel(caster,'A0GZ')==0 then
        call UnitAddAbility(caster,'A0GZ')
        call UnitMakeAbilityPermanent(caster,true,'A0GZ')
    endif
    
    set caster = null
endfunction

//===========================================================================
function InitTrig_Alice takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Alice01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Alice01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0GV'
endfunction

function Trig_Alice01_Control takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local lightning e = LoadLightningHandle(udg_ht,task,2)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real oz
    local real px 
    local real py 
    local real pz
    local real a
    local real d
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if IsUnitAlive(caster) and IsUnitAlive(u) then
        if i>=0 then
            if i<=12 then
                call SaveInteger(udg_ht,task,1,i + 1)
            else
                call SaveInteger(udg_ht,task,1,0)
            endif
        endif
        if not IsUnitInRange(caster,u,1000.0) then
            set px = GetUnitX(u)
            set py = GetUnitY(u)
            set a = Atan2(py-oy,px-ox)
            set d = GetRandomReal(600.0,800.0)
            set px = ox + d*Cos(a)
            set py = oy + d*Sin(a)
            if i==0 then
                call IssuePointOrder(u,"move",px,py)
                call SaveInteger(udg_ht,task,1,1)
            endif
        endif
        if not IsUnitInRange(caster,u,1200.0) and GetUnitAbilityLevel(u,'A0HR')==0 then
            call RemoveDoll(caster,u,true)
        else
            set a = GetUnitFacing(caster) - 15.0
            set ox = ox + 30.0*CosBJ(a)
            set oy = oy + 30.0*SinBJ(a)
            set oz = GetPositionZ(ox,oy) + 80.0
            set px = GetUnitX(u)
            set py = GetUnitY(u)
            set pz = GetPositionZ(px,py) + GetUnitFlyHeight(u) + 20.0
            call MoveLightningEx(e,false,ox,oy,oz,px,py,pz)
            if IsUnitVisible(caster,GetLocalPlayer()) and IsUnitVisible(u,GetLocalPlayer()) then
                call SetLightningColor(e,1.0,1.0,1.0,0.5)
            else
                call SetLightningColor(e,0.0,0.0,0.0,0.0)
            endif
        endif
    else
        if IsUnitAlive(u) then
            call KillUnit(u)
        endif
        call DestroyLightning(e)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set e = null
endfunction

function Trig_Alice01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer task = GetHandleId(caster)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local unit u
    local group g = LoadGroupHandle(udg_sht,task,1)
    local integer max = LoadInteger(udg_sht,task,1)
    local integer n
    
    set n = CountDollsInGroup(g)
    if n>=max then
        loop
            set u = FirstOfGroup(g)
            call GroupRemoveUnit(g,u)
            if IsUnitAlive(u) then
                call RemoveDoll(caster,u,true)
                set n = n - 1
                exitwhen true
            endif
        endloop
    endif
    
    set u = CreateDoll(caster,ConvertDollType(1),tx,ty,a,function Trig_Alice01_Control)
    call SetDollProperty(caster,u)
    call EnableHeight(u)
    call GroupAddUnit(g,u)
    set n = n + 1
    
    if GetRandomReal(0,100)<=61.8 then
        call SetUnitColor(u,PLAYER_COLOR_BLUE)
    else
        call SetUnitColor(u,ConvertPlayerColor(12))
    endif
    
    call DisplayTextToPlayer(GetOwningPlayer(caster),0.0,0.0,"上海："+I2S(n)+"/"+I2S(max))
    
    set caster = null
    set u = null
    set g = null
endfunction

//==================================================================
function InitTrig_Alice01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Alice02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Alice02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0GW'
endfunction

function Trig_Alice02_Control takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local lightning e = LoadLightningHandle(udg_ht,task,2)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real oz
    local real px 
    local real py 
    local real pz
    local real a
    local real d
    local integer i = LoadInteger(udg_ht,task,1)
    local boolean k = GetUnitAbilityLevel(u,'A0HR')==0
    //========
    if IsUnitAlive(caster) and IsUnitAlive(u) and k then
        if i>=0 then
            if i<=12 then
                call SaveInteger(udg_ht,task,1,i + 1)
            else
                call SaveInteger(udg_ht,task,1,0)
            endif
        endif
        if not IsUnitInRange(caster,u,1000.0) then
            set px = GetUnitX(u)
            set py = GetUnitY(u)
            set a = Atan2(py-oy,px-ox)
            set d = GetRandomReal(600.0,800.0)
            set px = ox + d*Cos(a)
            set py = oy + d*Sin(a)
            if i==0 then
                call IssuePointOrder(u,"move",px,py)
                call SaveInteger(udg_ht,task,1,1)
            endif
        endif
        if not IsUnitInRange(caster,u,1200.0) then
            call RemoveDoll(caster,u,true)
        else
            set a = GetUnitFacing(caster) - 15.0
            set ox = ox + 30.0*CosBJ(a)
            set oy = oy + 30.0*SinBJ(a)
            set oz = GetPositionZ(ox,oy) + 80.0
            set px = GetUnitX(u)
            set py = GetUnitY(u)
            set pz = GetPositionZ(px,py) + GetUnitFlyHeight(u)
            if GetUnitTypeId(u)=='h01B' then
                set pz = pz + 60.0
            else
                set pz = pz + 20.0
            endif
            call MoveLightningEx(e,false,ox,oy,oz,px,py,pz)
            if IsUnitVisible(caster,GetLocalPlayer()) and IsUnitVisible(u,GetLocalPlayer()) then
                call SetLightningColor(e,1.0,1.0,1.0,0.5)
            else
                call SetLightningColor(e,0.0,0.0,0.0,0.0)
            endif
        endif
    else
        if IsUnitAlive(u) and k then
            call KillUnit(u)
        endif
        call DestroyLightning(e)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set e = null
endfunction

function Trig_Alice02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer task = GetHandleId(caster)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local unit u
    local group g = LoadGroupHandle(udg_sht,task,2)
    local integer max = LoadInteger(udg_sht,task,2)
    local integer n
    
    set n = CountDollsInGroup(g)
    if n>=max then
        loop
            set u = FirstOfGroup(g)
            call GroupRemoveUnit(g,u)
            if IsUnitAlive(u) then
                call RemoveDoll(caster,u,true)
                set n = n - 1
                exitwhen true
            endif
        endloop
    endif
    
    set u = CreateDoll(caster,ConvertDollType(2),tx,ty,a,function Trig_Alice02_Control)
    call SetDollProperty(caster,u)
    call GroupAddUnit(g,u)
    set n = n + 1
    
    if GetRandomReal(0,100)<=61.8 then
        call SetUnitColor(u,PLAYER_COLOR_ORANGE)
    else
        call SetUnitColor(u,PLAYER_COLOR_GREEN)
    endif
    
    call DisplayTextToPlayer(GetOwningPlayer(caster),0.0,0.0,"新英格兰："+I2S(n)+"/"+I2S(max))
    
    set caster = null
    set u = null
    set g = null
endfunction

//===========================================================================
function InitTrig_Alice02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Alice03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Alice03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0GX'
endfunction

function Trig_Alice03_Control takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local lightning e = LoadLightningHandle(udg_ht,task,2)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real oz
    local real px 
    local real py 
    local real pz
    local real a
    //========
    if IsUnitAlive(caster) and IsUnitAlive(u) then
        if not IsUnitInRange(caster,u,1200.0) then
            call RemoveDoll(caster,u,true)
        else
            set a = GetUnitFacing(caster) + 75.0
            set ox = ox + 20.0*CosBJ(a)
            set oy = oy + 20.0*SinBJ(a)
            set oz = GetPositionZ(ox,oy) + 50.0
            set px = GetUnitX(u)
            set py = GetUnitY(u)
            set pz = GetPositionZ(px,py) + GetUnitFlyHeight(u) + 20.0
            call MoveLightningEx(e,false,ox,oy,oz,px,py,pz)
            if IsUnitVisible(caster,GetLocalPlayer()) and IsUnitVisible(u,GetLocalPlayer()) then
                call SetLightningColor(e,1.0,1.0,1.0,0.5)
            else
                call SetLightningColor(e,0.0,0.0,0.0,0.0)
            endif
        endif
    else
        if IsUnitAlive(u) then
            call KillUnit(u)
        endif
        call DestroyLightning(e)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set e = null
endfunction

function Trig_Alice03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer task = GetHandleId(caster)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = bj_RADTODEG*Atan2(ty-oy,tx-ox)
    local unit u
    local group g = LoadGroupHandle(udg_sht,task,3)
    local integer max = LoadInteger(udg_sht,task,3)
    local integer n
    
    set n = CountDollsInGroup(g)
    if n>=max then
        loop
            set u = FirstOfGroup(g)
            call GroupRemoveUnit(g,u)
            if IsUnitAlive(u) then
                call RemoveDoll(caster,u,true)
                set n = n - 1
                exitwhen true
            endif
        endloop
    endif
    
    set tx = R2I(tx/64.0+0.5)*64.0
    set ty = R2I(ty/64.0+0.5)*64.0
    set a = R2I((a+22.5)/45.0)*45.0
    set u = CreateDoll(caster,ConvertDollType(3),tx,ty,a,function Trig_Alice03_Control)
    call UnitRemoveAbility(u,'Amov')
    call SetDollProperty(caster,u)
    call GroupAddUnit(g,u)
    set n = n + 1
    
    if GetRandomReal(0,100)<=61.8 then
        call SetUnitColor(u,PLAYER_COLOR_PINK)
    else
        call SetUnitColor(u,PLAYER_COLOR_RED)
    endif
    
    call DisplayTextToPlayer(GetOwningPlayer(caster),0.0,0.0,"蓬莱："+I2S(n)+"/"+I2S(max))
    
    set caster = null
    set u = null
    set g = null
endfunction

//===========================================================================
function InitTrig_Alice03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Alice Onboard
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Alice_Onboard_Conditions takes nothing returns boolean
    return IsUnitLoaded(GetTriggerUnit())
endfunction

function Trig_Alice_Onboard_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    //========
    if IsUnitInTransport(caster,target) then
        call SetUnitX(caster,GetUnitX(target))
        call SetUnitY(caster,GetUnitY(target))
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set target = null
endfunction

function Trig_Alice_Onboard_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetTransportUnit()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call TimerStart(t,0.03,true,function Trig_Alice_Onboard_Main)
    //========
    set caster = null
    set target = null
    set t = null
endfunction

function InitTrig_Alice_Onboard takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Init Alice
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Alice_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H01A')
    local player w = GetOwningPlayer(h)
    local integer task = GetHandleId(h)
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + "技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_Alice_Dolls = CreateTrigger()
    
    set gg_trg_Alice_Dolls_KIA = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_Alice_Dolls_KIA, w, EVENT_PLAYER_UNIT_DEATH, null )
    call TriggerAddCondition( gg_trg_Alice_Dolls_KIA, Condition( function Trig_Alice_Dolls_KIA_Conditions ) )
    call TriggerAddAction( gg_trg_Alice_Dolls_KIA, function Trig_Alice_Dolls_KIA_Actions )
    
    set gg_trg_Alice_Dolls_Back = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Alice_Dolls_Back, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Alice_Dolls_Back, Condition( function Trig_Alice_Dolls_Back_Conditions ) )
    call TriggerAddAction( gg_trg_Alice_Dolls_Back, function Trig_Alice_Dolls_Back_Actions )
    
    call SaveInteger(udg_sht,task,1,2)
    call SaveInteger(udg_sht,task,2,2)
    call SaveInteger(udg_sht,task,3,2)
    call SaveGroupHandle(udg_sht,task,1,CreateGroup())
    call SaveGroupHandle(udg_sht,task,2,CreateGroup())
    call SaveGroupHandle(udg_sht,task,3,CreateGroup())
    
    set gg_trg_Alice = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Alice, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Alice, Condition( function Trig_Alice_Conditions ) )
    call TriggerAddAction( gg_trg_Alice, function Trig_Alice_Actions )
    
    set gg_trg_Alice01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Alice01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Alice01, Condition( function Trig_Alice01_Conditions ) )
    call TriggerAddAction( gg_trg_Alice01, function Trig_Alice01_Actions )
    
    set gg_trg_Alice02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Alice02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Alice02, Condition( function Trig_Alice02_Conditions ) )
    call TriggerAddAction( gg_trg_Alice02, function Trig_Alice02_Actions )
    
    set gg_trg_Alice03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Alice03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Alice03, Condition( function Trig_Alice03_Conditions ) )
    call TriggerAddAction( gg_trg_Alice03, function Trig_Alice03_Actions )
    
    set gg_trg_Alice_Onboard = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Alice_Onboard, h, EVENT_UNIT_LOADED )
    call TriggerAddCondition( gg_trg_Alice_Onboard, Condition( function Trig_Alice_Onboard_Conditions ) )
    call TriggerAddAction( gg_trg_Alice_Onboard, function Trig_Alice_Onboard_Actions )
    
    set gg_trg_Shanghai01 = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_Shanghai01, w, EVENT_PLAYER_UNIT_ISSUED_ORDER, null )
    call TriggerAddCondition( gg_trg_Shanghai01, Condition( function Trig_Shanghai01_Conditions ) )
    
    set gg_trg_Shanghai02 = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_Shanghai02, w, EVENT_PLAYER_UNIT_SPELL_EFFECT, null )
    call TriggerAddCondition( gg_trg_Shanghai02, Condition( function Trig_Shanghai02_Conditions ) )
    call TriggerAddAction( gg_trg_Shanghai02, function Trig_Shanghai02_Actions )
    
    set gg_trg_Shanghai03 = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_Shanghai03, w, EVENT_PLAYER_UNIT_SPELL_EFFECT, null )
    call TriggerAddCondition( gg_trg_Shanghai03, Condition( function Trig_Shanghai03_Conditions ) )
    call TriggerAddAction( gg_trg_Shanghai03, function Trig_Shanghai03_Actions )
    
    set gg_trg_Shanghai04 = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_Shanghai04, w, EVENT_PLAYER_UNIT_SPELL_EFFECT, null )
    call TriggerAddCondition( gg_trg_Shanghai04, Condition( function Trig_Shanghai04_Conditions ) )
    call TriggerAddAction( gg_trg_Shanghai04, function Trig_Shanghai04_Actions )
    
    set gg_trg_Shanghai04_Issue = CreateTrigger()
    //call TriggerRegisterPlayerUnitEvent( gg_trg_Shanghai04_Issue, w, EVENT_PLAYER_UNIT_SPELL_CAST, null )
    call TriggerRegisterPlayerUnitEvent( gg_trg_Shanghai04_Issue, w, EVENT_PLAYER_UNIT_ISSUED_POINT_ORDER, null )
    call TriggerAddCondition( gg_trg_Shanghai04_Issue, Condition( function Trig_Shanghai04_Issue_Conditions ) )
    call TriggerAddAction( gg_trg_Shanghai04_Issue, function Trig_Shanghai04_Issue_Actions )
    
    set gg_trg_Shanghai04_Alice = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Shanghai04_Alice, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Shanghai04_Alice, Condition( function Trig_Shanghai04_Alice_Conditions ) )
    call TriggerAddAction( gg_trg_Shanghai04_Alice, function Trig_Shanghai04_Alice_Actions )
    
    set gg_trg_Hourai01 = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_Hourai01, w, EVENT_PLAYER_UNIT_SPELL_EFFECT, null )
    call TriggerAddCondition( gg_trg_Hourai01, Condition( function Trig_Hourai01_Conditions ) )
    call TriggerAddAction( gg_trg_Hourai01, function Trig_Hourai01_Actions )
    
    set gg_trg_Hourai02 = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_Hourai02, w, EVENT_PLAYER_UNIT_SPELL_EFFECT, null )
    call TriggerRegisterPlayerUnitEvent( gg_trg_Hourai02, w, EVENT_PLAYER_UNIT_SPELL_ENDCAST, null )
    call TriggerAddCondition( gg_trg_Hourai02, Condition( function Trig_Hourai02_Conditions ) )
    call TriggerAddAction( gg_trg_Hourai02, function Trig_Hourai02_Actions )
    
    set gg_trg_Hourai04 = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_Hourai04, w, EVENT_PLAYER_UNIT_SPELL_EFFECT, null )
    call TriggerAddCondition( gg_trg_Hourai04, Condition( function Trig_Hourai04_Conditions ) )
    call TriggerAddAction( gg_trg_Hourai04, function Trig_Hourai04_Actions )
    
    set gg_trg_NewEngland01 = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_NewEngland01, w, EVENT_PLAYER_UNIT_SPELL_EFFECT, null )
    call TriggerAddCondition( gg_trg_NewEngland01, Condition( function Trig_NewEngland01_Conditions ) )
    call TriggerAddAction( gg_trg_NewEngland01, function Trig_NewEngland01_Actions )
    
    set gg_trg_NewEngland04 = CreateTrigger()
    call TriggerRegisterPlayerUnitEvent( gg_trg_NewEngland04, w, EVENT_PLAYER_UNIT_SPELL_EFFECT, null )
    call TriggerAddCondition( gg_trg_NewEngland04, Condition( function Trig_NewEngland04_Conditions ) )
    call TriggerAddAction( gg_trg_NewEngland04, function Trig_NewEngland04_Actions )
    
    set h = CreateUnitAtLoc(Player(15),GPSU(),udg_BackStage,0.0)
    call UnitAddAbility(h,'A0GV')
    call UnitAddAbility(h,'A0GW')
    call UnitAddAbility(h,'A0GX')
    call UnitAddAbility(h,'A0GY')
    call UnitAddAbility(h,'A0GZ')
    call UnitAddAbility(h,'A0H0')
    call UnitAddAbility(h,'A0H1')
    call UnitAddAbility(h,'A0H2')
    call UnitAddAbility(h,'A0H3')
    call UnitAddAbility(h,'A0H4')
    call UnitAddAbility(h,'A0H5')
    call UnitAddAbility(h,'A0H6')
    call UnitAddAbility(h,'A0H7')
    call UnitAddAbility(h,'A0H8')
    call UnitAddAbility(h,'A0H9')
    call UnitAddAbility(h,'A0HA')
    call UnitAddAbility(h,'A0HB')
    call UnitAddAbility(h,'A0HC')
    call UnitAddAbility(h,'A0HD')
    call UnitAddAbility(h,'A0HE')
    call UnitAddAbility(h,'A0HF')
    call UnitAddAbility(h,'A0HG')
    call UnitAddAbility(h,'A0HH')
    call UnitAddAbility(h,'A0HI')
    call UnitAddAbility(h,'A0HJ')
    call UnitAddAbility(h,'A0HK')
    call UnitAddAbility(h,'A0HL')
    call UnitAddAbility(h,'A0HM')
    call UnitAddAbility(h,'A0HN')
    call UnitAddAbility(h,'A0HO')
    call UnitAddAbility(h,'A0HP')
    call UnitAddAbility(h,'A0HQ')
    call UnitAddAbility(h,'A0HR')
    call UnitAddAbility(h,'A0HS')
    call UnitAddAbility(h,'A0HT')
    call UnitAddAbility(h,'A0HU')
    call UnitAddAbility(h,'A0HW')
    call UnitAddAbility(h,'A0HX')
    
    set w = null
    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Alice takes nothing returns nothing
    set gg_trg_Init_Alice = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Alice, function Trig_Init_Alice_Actions )
endfunction
//===========================================================================
// Trigger: Satori01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Satori01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0IW'
endfunction

function Trig_Satori01_Max takes unit caster returns integer
    return 6
endfunction

function Trig_Satori01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetUnitX(u)
    local real ty = GetUnitY(u)
    local real px
    local real py
    local real dx
    local real dy
    local real r
    local real a
    local real d
    local real e
    local integer level
    local integer n = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if IsUnitAliveBJ(u) then
        set target = LoadUnitHandle(udg_ht,GetHandleId(u),0)
        set level = LoadInteger(udg_ht,GetHandleId(u),0)
        if target!=null then
            call SaveUnitHandle(udg_ht,task,2,target)
            call SaveInteger(udg_ht,task,2,level)
            call FlushChildHashtable(udg_ht,GetHandleId(u))
            call SetUnitAbilityLevel(u,'A0JL',level)
            call SetUnitScale(u,1.5,1.5,1.5)
            call SaveInteger(udg_ht,task,1,2)
        elseif i==0 then
            set dx = ox - tx
            set dy = oy - ty
            set r = 120.0
            set d = SquareRoot(dx*dx+dy*dy)
            if d>(r + 5.0) then
                set a = Atan2(dy,dx) + (bj_DEGTORAD*90.0 - Acos(r/d))
                set px = tx + 20.0*Cos(a)
                set py = ty + 20.0*Sin(a)
                call SetUnitFacing(u,bj_RADTODEG*a)
                if IsTerrainPathable(px,py,PATHING_TYPE_FLYABILITY)==false then
                    call SetUnitX(u,px)
                    call SetUnitY(u,py)
                endif
            else
                call SaveInteger(udg_ht,task,1,1)
            endif
        elseif i==1 then
            set dx = tx - ox
            set dy = ty - oy
            set r = 120.0
            set a = bj_RADTODEG*Atan2(dy,dx) - 5.0
            set px = ox + r*CosBJ(a)
            set py = oy + r*SinBJ(a)
            if IsTerrainPathable(px,py,PATHING_TYPE_FLYABILITY)==false then
                call SetUnitX(u,px)
                call SetUnitY(u,py)
            endif
        elseif i==2 then
            set target = LoadUnitHandle(udg_ht,task,2)
            set level = LoadInteger(udg_ht,task,2)
            if IsUnitAlive(target) then
                set ox = GetUnitX(u)
                set oy = GetUnitY(u)
                set tx = GetUnitX(target)
                set ty = GetUnitY(target)
                set dx = tx - ox
                set dy = ty - oy
                set a = GetUnitFacing(u)
                set e = YawError(a,bj_RADTODEG*Atan2(dy,dx))
                if RAbsBJ(e)>15.0 then
                    call IssueTargetOrder(u,"move",target)
                else
                    call SetUnitAbilityLevel(u,'A0JL',level)
                    call IssueTargetOrder(u,"thunderbolt",target)
                    call SaveInteger(udg_ht,task,1,3)
                    call TimerStart(t,0.1,true,function Trig_Satori01_Main)
                endif
            else
                call SaveInteger(udg_ht,task,1,3)
            endif
        elseif i==3 then
            call ShowUnit(u,false)
            call UnitApplyTimedLife(u,'BTLF',6.0)
            call DestroyTimer(t)
            call FlushChildHashtable(udg_ht,task)
        endif
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_Satori01_Check takes unit caster,unit target,integer skill returns boolean
    local integer task = GetHandleId(caster)
    local integer index
    local integer i
    
    if skill==0 then
        return false
    endif
    
    set i = 1
    loop
        if skill==LoadInteger(udg_sht,task,i) then
            return false
        endif
        set i = i + 1
        exitwhen i>6
    endloop
    
    set index = GetHeroIndex(GetUnitTypeId(target))
    set i = 1
    loop
        if skill==AI_DataBaseRead(index,i) then
            return true
        endif
        set i = i + 1
        exitwhen i>5
    endloop
    
    return false
endfunction

function Trig_Satori01_Add takes unit caster,unit target,integer skill returns boolean
    local integer task = GetHandleId(caster)
    local integer n = LoadInteger(udg_sht,task,0)
    local real px = GetUnitX(target)
    local real py = GetUnitY(target)
    local unit u
    local timer t
    if n>=Trig_Satori01_Max(caster) then
        return false
    endif
    set t = CreateTimer()
    set u = CreateUnit(GetOwningPlayer(caster),'n03R',px,py,GetUnitFacing(target))
    set n = n + 1
    call SaveUnitHandle(udg_sht,task,n,u)
    call SaveInteger(udg_sht,task,n,skill)
    call SaveInteger(udg_sht,task,0,n)
    call DisplayTextToPlayer(GetOwningPlayer(caster),0,0,"符灵数量：" + I2S(n))
    set task = GetHandleId(t)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,0,n)
    call SaveInteger(udg_ht,task,1,0)
    call TimerStart(t,0.02,true,function Trig_Satori01_Main)
    set t = null
    set u = null
    return true
endfunction

function Trig_Satori01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit u
    local integer task = GetHandleId(caster)
    local integer level
    local integer i
    local integer n
    //========
    if GetTriggerEventId()==EVENT_UNIT_SPELL_CAST then
        if LoadInteger(udg_sht,task,0)==0 then
            call IssueImmediateOrder(caster,"stop")
            call DisplayTextToPlayer(GetOwningPlayer(caster),0,0,"目前没有可用的符灵")
        endif
    else
        set level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
        set n = Trig_Satori01_Max(caster)
        set i = 1
        loop
            exitwhen i>n
            set u = LoadUnitHandle(udg_sht,task,i)
            if u!=caster then
                call SaveUnitHandle(udg_sht,task,i,caster)
                call SaveInteger(udg_sht,task,i,0)
                call SaveUnitHandle(udg_ht,GetHandleId(u),0,target)
                call SaveInteger(udg_ht,GetHandleId(u),0,level)
            endif
            set i = i + 1
        endloop
        call SaveInteger(udg_sht,task,0,0)
        call UnitShareVision(target,GetOwningPlayer(caster),true)
        call TriggerSleepAction(3.0)
        call UnitShareVision(target,GetOwningPlayer(caster),false)
    endif
    //========
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Satori01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Satori01 Collect
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Satori01_Collect_Conditions takes nothing returns boolean
    return IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)
endfunction

function Trig_Satori01_Collect_Actions takes nothing returns nothing
    local integer task = GetHandleId(GetTriggeringTrigger())
    local integer skill = GetSpellAbilityId()
    local unit caster = LoadUnitHandle(udg_sht,task,0)
    local unit target = GetTriggerUnit()
    if target!=caster and IsUnitInRange(caster,target,1200.0) and Trig_Satori01_Check(caster,target,skill) then
        if GetUnitAbilityLevel(caster,'A0IW')>0 then
            call Trig_Satori01_Add(caster,target,skill)
        endif
    endif
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Satori01_Collect takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Satori02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Satori02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0IX'
endfunction

function Trig_Satori02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real x = GetSpellTargetX()
    local real y = GetSpellTargetY()
    local real mana
    local real rate
    local real c
    local real d = 0.0
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local unit v
    local group g = CreateGroup()
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local texttag e
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 12
    local real abilitycooldownlv03 = 9
    local real abilitycooldownlv04 = 6
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set v = CreateUnit(GetOwningPlayer(caster),'n03P',x,y,0.0)
    call SetUnitTimeScale(v,1.5)
    call KillUnit(v)
    set v = CreateUnit(GetOwningPlayer(caster),'n03P',x,y,120.0)
    call SetUnitTimeScale(v,1.5)
    call KillUnit(v)
    set v = CreateUnit(GetOwningPlayer(caster),'n03P',x,y,240.0)
    call SetUnitTimeScale(v,1.5)
    call KillUnit(v)
    //========
    call GroupEnumUnitsInRange(g,x,y,160.0,iff)
    loop
    set c = 0.0
    set d = 0.0
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitType(v,UNIT_TYPE_DEAD)==false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and IsUnitWard(v)==false and GetUnitAbilityLevel(v,'B04B') == 0 and GetUnitAbilityLevel(v,'BOvc') == 0 then
            if GetUnitState(v,UNIT_STATE_MAX_MANA)>0.0 then//有魔法单位
                set mana = GetUnitState(v,UNIT_STATE_MANA)//当前魔法值
                set rate = mana/GetUnitState(v,UNIT_STATE_MAX_MANA)//当前比最大魔法值
                if rate>=0.2 then//最大20%
                    set rate = 0.2
                else
                    set d = (0.2 - rate)*GetUnitState(v,UNIT_STATE_LIFE)
                endif
                set c = rate*GetUnitState(v,UNIT_STATE_MAX_MANA)
                set d = rate*GetUnitState(v,UNIT_STATE_MAX_LIFE) + d
                call SetUnitState(v,UNIT_STATE_MANA,mana - c)
            else
                set c = 0.0
                set d = 50.0 + 0.4*GetUnitState(v,UNIT_STATE_LIFE)
            endif
            if IsUnitType(v,UNIT_TYPE_HERO) then
                set x = GetUnitX(v)
                set y = GetUnitY(v)
                //魔法值
                set e = CreateTextTag()
                call SetTextTagTextBJ(e,"－" + R2SW(c,3,0),14.0)
                call SetTextTagPos(e,x,y,50.0)
                call SetTextTagColor(e,0,0,255,240)
                call SetTextTagVelocityBJ(e,150,90)
                call SetTextTagPermanent(e,false)
                call SetTextTagLifespan(e,1.67)
                //生命值
                set e = CreateTextTag()
                call SetTextTagTextBJ(e,"－" + R2SW(d,3,0),14.0)
                call SetTextTagPos(e,x,y,100.0)
                call SetTextTagColor(e,220,0,0,240)
                call SetTextTagVelocityBJ(e,150,90)
                call SetTextTagPermanent(e,false)
                call SetTextTagLifespan(e,1.67)
            endif
            call UnitDamageTarget(caster,v,d,false,false,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,null)
            call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Demon\\DemonBoltImpact\\DemonBoltImpact.mdl",v,"head"))
        endif
    endloop
    call DestroyGroup(g)
    //========
    set caster = null
    set e = null
    set v = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_Satori02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Satori03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Satori03_Conditions takes nothing returns boolean
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_SUMMON then
        return GetUnitAbilityLevel(GetSummonedUnit(),'B04N')>0
    endif
    if IsUnitType(GetAttacker(),UNIT_TYPE_HERO)==false then
        return false
    endif
    if GetUnitAbilityLevel(GetAttacker(),'Aloc')!=0 then
        return false
    endif
    return GetRandomInt(0,100)<35
endfunction

function Trig_Satori03_Actions takes nothing returns nothing
    local unit caster
    local unit target
    local unit u
    local real ox
    local real oy
    local real dx
    local real dy
    local real a
    local real d
    local integer task
    local integer level
    //========
    if GetTriggerEventId()==EVENT_UNIT_ATTACKED then
        set caster = GetTriggerUnit()
        set target = GetAttacker()
        set level = GetUnitAbilityLevel(caster,'A0IY')
        set u = CreateUnit(GetOwningPlayer(caster),GPSU(),GetUnitX(caster),GetUnitY(caster),0.0)
        call UnitAddAbility(u,'A0J0')
        call SetUnitAbilityLevel(u,'A0J0',level)
        set task = GetHandleId(u)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveUnitHandle(udg_ht,task,1,target)
        call IssueTargetOrderById(u,0x0D0132,target)
        call DebugMsg("Satori03")
    else
        set task = GetHandleId(GetSummoningUnit())
        set caster = LoadUnitHandle(udg_ht,task,0)
        set target = LoadUnitHandle(udg_ht,task,1)
        call FlushChildHashtable(udg_ht,task)
        set u = GetSummonedUnit()
        set ox = GetUnitX(caster)
        set oy = GetUnitY(caster)
        set dx = GetUnitX(target) - ox
        set dy = GetUnitY(target) - oy
        set a = Atan2(dy,dx)
        set d = 0.2*SquareRoot(dx*dx+dy*dy)
        call SetUnitFacingTimed(u,bj_RADTODEG*a,0.05)
        call UnitAddAbility(u,'Aloc')
        call SetUnitX(u,ox + d*Cos(a))
        call SetUnitY(u,oy + d*Sin(a))
        call IssueTargetOrderById(u,0x0D0011,target)
    endif
    //========
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_Satori03_Learn takes nothing returns nothing
    if GetLearnedSkill()=='A0IY' then
        call DestroyTrigger(gg_trg_Satori03)
        set gg_trg_Satori03 = CreateTrigger()
        call TriggerRegisterUnitEvent( gg_trg_Satori03, GetTriggerUnit(), EVENT_UNIT_ATTACKED )
        call TriggerRegisterPlayerUnitEvent( gg_trg_Satori03, GetOwningPlayer(GetTriggerUnit()), EVENT_PLAYER_UNIT_SUMMON, null )
        call TriggerAddCondition( gg_trg_Satori03, Condition( function Trig_Satori03_Conditions ) )
        call TriggerAddAction( gg_trg_Satori03, function Trig_Satori03_Actions )
    endif
endfunction

//===========================================================================
function InitTrig_Satori03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Satori04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Satori04_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0IZ'
endfunction

function Trig_Satori04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local unit u = LoadUnitHandle(udg_ht,task,2)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer c = LoadInteger(udg_ht,task,2)
    //========
    if i<7 and IsUnitAlive(target) then
        call SetUnitLifePercentBJ(u,100.0)
        call SetUnitX(u,GetUnitX(target))
        call SetUnitY(u,GetUnitY(target))
        if GetUnitAbilityLevel(target,'B04P')==0 then
            call UnitRemoveAbility(target,'B04O')
            call SetUnitAbilityLevel(u,c,7 - i)
            call IssueTargetOrder(u,"shadowstrike",target)
            call SaveInteger(udg_ht,task,1,i + 1)
            call TimerStart(t,0.25 + 0.25*level,false,function Trig_Satori04_Main)
        endif
    else
        call UnitRemoveAbility(target,'B04O')
        call RemoveUnit(u)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set target = null
    set u = null
endfunction

function Trig_Satori04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit u
    local real x = GetUnitX(target)
    local real y = GetUnitY(target)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local integer c = 'A0J0' + level
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 75
    local real abilitycooldownlv02 = 75
    local real abilitycooldownlv03 = 75
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),x,y,270.0)
    call UnitAddAbility(u,c)
    call UnitAddAbility(u,'A0J5')
    call SetUnitAbilityLevel(u,'A0J5',level)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveUnitHandle(udg_ht,task,2,u)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,0)
    call SaveInteger(udg_ht,task,2,c)
    call TimerStart(t,0.03,true,function Trig_Satori04_Main)
    call DebugMsg("Satori04")
    //========
    set caster = null
    set target = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Satori04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Init Satori
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Satori_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E015')
    local player w = GetOwningPlayer(h)
    local integer task = GetHandleId(h)
    local integer i
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + "技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    call SaveInteger(udg_sht,task,0,0)
    set i = 1
    loop
        call SaveUnitHandle(udg_sht,task,i,h)
        call SaveInteger(udg_sht,task,i,0)
        set i = i + 1
        exitwhen i>9
    endloop
    
    set gg_trg_Satori01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Satori01, h, EVENT_UNIT_SPELL_CAST )
    call TriggerRegisterUnitEvent( gg_trg_Satori01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Satori01, Condition( function Trig_Satori01_Conditions ) )
    call TriggerAddAction( gg_trg_Satori01, function Trig_Satori01_Actions )
    
    set gg_trg_Satori01_Collect = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Satori01_Collect, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Satori01_Collect, Condition( function Trig_Satori01_Collect_Conditions ) )
    call TriggerAddAction( gg_trg_Satori01_Collect, function Trig_Satori01_Collect_Actions )
    
    call SaveUnitHandle(udg_sht,GetHandleId(gg_trg_Satori01_Collect),0,h)
    
    set gg_trg_Satori02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Satori02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Satori02, Condition( function Trig_Satori02_Conditions ) )
    call TriggerAddAction( gg_trg_Satori02, function Trig_Satori02_Actions )
    
    set gg_trg_Satori03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Satori03, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Satori03, Condition( function Trig_Satori03_Learn ) )
    
    set gg_trg_Satori04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Satori04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Satori04, Condition( function Trig_Satori04_Conditions ) )
    call TriggerAddAction( gg_trg_Satori04, function Trig_Satori04_Actions )
    
    set h = null
    set w = null
endfunction

//===========================================================================
function InitTrig_Init_Satori takes nothing returns nothing
    set gg_trg_Init_Satori = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Satori, function Trig_Init_Satori_Actions )
endfunction

//===========================================================================
// Trigger: shizuha01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_shizuha01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0J8'
endfunction

function Trig_shizuha01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local unit v
    local real x = GetSpellTargetX()
    local real y = GetSpellTargetY()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local real Range = 158.00 + 25.00*level
    local group g = CreateGroup()
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    //========
    local real abilitycooldownlv01 = 14
    local real abilitycooldownlv02 = 14
    local real abilitycooldownlv03 = 14
    local real abilitycooldownlv04 = 14
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========   

    call TriggerSleepAction(0.4)

    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),x,y,0)
    call UnitAddAbility(u,'A0JD')
    call SetUnitAbilityLevel(u,'A0JD',level)
    call GroupEnumUnitsInRange(g,x,y,Range+10.0,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if GetUnitCurrentOrder(v)!=OrderId("metamorphosis") then
            call IssueTargetOrder(u,"entanglingroots",v)
            call UnitDamageTarget(caster,v,20+40*level,false,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
        endif
    endloop
    //========
    call DestroyGroup(g)
    call RemoveUnit(u)
    set caster = null
    set v = null
    set u = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_shizuha01 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Shizuha02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Shizuha02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0JC'
endfunction

function Trig_Shizuha02_End takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    if i>0 and IsUnitAlive(caster) then
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call UnitRemoveAbility(caster,'A0JM')
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set caster = null
    set t = null
endfunction

function Trig_Shizuha02_Trace takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer c = LoadInteger(udg_ht,task,2)
    local boolean o = GetUnitCurrentOrder(caster)==OrderId("tranquility")
    local boolean b = GetUnitAbilityLevel(caster,'B04R')>0
    //========
    if i>0 then
        if o and b then
            call SaveInteger(udg_ht,task,1,i - 1)
        else
            call SetUnitTimeScale(caster,1.0)
            call SetUnitAnimation(caster,"stand")
            if o then
                call IssueImmediateOrder(caster,"stop")
            endif
            if b then
                call UnitRemoveAbility(caster,'B04R')
            endif
            call DestroyTimer(t)
            call FlushChildHashtable(udg_ht,task)
        endif
    else
        call SetUnitTimeScale(caster,1.0)
        call SetUnitAnimation(caster,"stand")
        call IssueImmediateOrder(caster,"stop")
        call UnitAddAbility(caster,'A0JM')
        call SetUnitAbilityLevel(caster,'A0JM',level)
        call SaveInteger(udg_ht,task,1,50 + 10*level)
        call TimerStart(t,0.1,true,function Trig_Shizuha02_End)
    endif
    //========
    set t = null
    set caster = null
endfunction

function Trig_Shizuha02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local real s = 6.9/(10.0 - 1.0*level)
    //========
    local real abilitycooldownlv01 = 60
    local real abilitycooldownlv02 = 60
    local real abilitycooldownlv03 = 60
    local real abilitycooldownlv04 = 60
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call SetUnitTimeScale(caster,s)
    call IssueImmediateOrder(caster,"tranquility")
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,100 - 10*level)
    call SaveBoolean(udg_ht,task,0,false)
    call TimerStart(t,0.1,true,function Trig_Shizuha02_Trace)
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Shizuha02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: shizuha03
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_shizuha03_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A0J7'
endfunction

function Trig_shizuha03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0J7')
    //========
    if GetUnitAbilityLevel(caster,'A0JA')==0 then
        call UnitAddAbility(caster,'A0JA')
        call UnitMakeAbilityPermanent(caster,true,'A0JA')
    else
        call SetUnitAbilityLevel(caster,'A0JA',level)
    endif
    //========
    set caster = null
endfunction

//===========================================================================
function InitTrig_shizuha03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Shizuha04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Shizuha04_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0J6'
endfunction

function Trig_Shizuha04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real dx = tx - ox
    local real dy = ty - oy
    local real a = Atan2(dy,dx)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    local real abilitycooldownlv01 = 60
    local real abilitycooldownlv02 = 60
    local real abilitycooldownlv03 = 60
    local real abilitycooldownlv04 = 60
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    set u = CreateUnit(GetOwningPlayer(caster),'n00X',tx,ty,bj_RADTODEG*a)
    call UnitAddAbility(u,'A0JE')
    call SetUnitAbilityLevel(u,'A0JE',level)
    set tx = tx + 100.0*Cos(a)
    set ty = ty + 100.0*Sin(a)
    call IssuePointOrder(u,"stampede",tx,ty)
    call UnitApplyTimedLife(u,'BTLF',10.0)
    //========
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Shizuha04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Init Shizuha
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Shizuha_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H01H')
    local player w = GetOwningPlayer(h)
    local integer task = GetHandleId(h)
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + "技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
    
    set gg_trg_shizuha01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_shizuha01, h,EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_shizuha01, Condition( function Trig_shizuha01_Conditions ) )
    call TriggerAddAction( gg_trg_shizuha01, function Trig_shizuha01_Actions )
    
    set gg_trg_Shizuha02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Shizuha02, h,EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Shizuha02, Condition( function Trig_Shizuha02_Conditions ) )
    call TriggerAddAction( gg_trg_Shizuha02, function Trig_Shizuha02_Actions )
    
    set gg_trg_shizuha03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_shizuha03, h,EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_shizuha03, Condition( function Trig_shizuha03_Conditions ) )
    call TriggerAddAction( gg_trg_shizuha03, function Trig_shizuha03_Actions )
    
    set gg_trg_Shizuha04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Shizuha04, h,EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Shizuha04, Condition( function Trig_Shizuha04_Conditions ) )
    call TriggerAddAction( gg_trg_Shizuha04, function Trig_Shizuha04_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Shizuha takes nothing returns nothing
    set gg_trg_Init_Shizuha = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Shizuha, function Trig_Init_Shizuha_Actions )
endfunction

//===========================================================================
// Trigger: Minoriko Harvest
//===========================================================================
function Trig_Minoriko_Harvest_Target takes nothing returns boolean
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_DEAD) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO) == false then
        return false
    endif
    return IsUnitAlly(GetFilterUnit(),GetOwningPlayer(udg_SK_Minoriko))
endfunction

function Trig_Minoriko_Harvest_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit v
    local group g = CreateGroup()
    local boolexpr iff = Filter(function Trig_Minoriko_Harvest_Target)
    call DisplayTimedTextToForce(GetPlayersAll(), 10.00,"|c00ffff00穰子分享收获的成果了哟～～～|r")
    call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),99999.0,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        call SetUnitState(v,UNIT_STATE_LIFE,GetUnitState(v,UNIT_STATE_LIFE) + 100 + 12 * GetHeroLevel(caster))
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIhe\\AIheTarget.mdl",v,"origin"))
    endloop
    call DestroyGroup(g)
    set caster = null
    set v = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_Minoriko_Harvest takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Minoriko01
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Minoriko01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0JF'
endfunction

function Trig_Minoriko01_Heal takes unit caster,unit target,integer level returns nothing
    local real a = 50.0 + 50.0*level + (0.02*level)*GetUnitState(target,UNIT_STATE_MAX_LIFE)
    local real ox = GetUnitX(target)
    local real oy = GetUnitY(target)
    local texttag e
    call SetUnitState(target,UNIT_STATE_LIFE,GetUnitState(target,UNIT_STATE_LIFE) + a)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIhe\\AIheTarget.mdl",target,"origin"))
    set e = CreateTextTag()
    call SetTextTagTextBJ(e,"＋" + I2S(R2I(a)),14.0)
    call SetTextTagPos(e,ox,oy,100.0)
    call SetTextTagColor(e,0,255,96,240)
    call SetTextTagVelocityBJ(e,150,90)
    call SetTextTagPermanent(e,false)
    call SetTextTagLifespan(e,1.67)
    set e = null
endfunction

function Trig_Minoriko01_Damage takes unit caster,unit target,integer level returns nothing
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local real damage = 25.0 + level*25.0
    local unit v
    local group g = CreateGroup()
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    call GroupEnumUnitsInRange(g,tx,ty,230.0,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitAliveBJ(v) and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and IsUnitWard(v)==false then
            call UnitDamageTarget(caster,v,damage,false,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,null)
        endif
    endloop
    call DestroyGroup(g)
    set v = null
    set g = null
    set iff = null
endfunction

function Trig_Minoriko01_Hit takes nothing returns nothing
    local unit caster
    local unit target
    local real tx
    local real ty
    local trigger trg
    local triggeraction tga
    local integer task
    local integer level
    local integer c
    //========
    if GetTriggerEventId()==EVENT_UNIT_DEATH then
        set trg = GetTriggeringTrigger()
        set task = GetHandleId(trg)
        set tga = LoadTriggerActionHandle(udg_ht,task,1)
        call TriggerRemoveAction(trg,tga)
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set caster = null
        set target = null
        set trg = null
        set tga = null
        return
    endif
    if GetUnitTypeId(GetEventDamageSource())!='o00R' then
        set caster = null
        set target = null
        set trg = null
        set tga = null
        return
    endif
    //========
    call RemoveUnit(GetEventDamageSource())
    set trg = GetTriggeringTrigger()
    set task = GetHandleId(trg)
    set caster = LoadUnitHandle(udg_ht,task,0)
    set target = GetTriggerUnit()
    set tx = GetUnitX(target)
    set ty = GetUnitY(target)
    set tga = LoadTriggerActionHandle(udg_ht,task,1)
    set level = LoadInteger(udg_ht,task,0)
    set c = LoadInteger(udg_ht,task,1)
    call TriggerRemoveAction(trg,tga)
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    if c==0 then
        call Trig_Minoriko01_Heal(caster,target,level)
    else
        call Trig_Minoriko01_Damage(caster,target,level)
        call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl",tx,ty))
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Weapons\\SteamTank\\SteamTankImpact.mdl",target,"chest"))
    endif
    //========
    set caster = null
    set target = null
    set trg = null
    set tga = null
endfunction

function Trig_Minoriko01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit u
    local real s
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local trigger trg
    local triggeraction tga
    local integer task
    local integer level
    //========
    local real abilitycooldownlv01 = 11
    local real abilitycooldownlv02 = 11
    local real abilitycooldownlv03 = 11
    local real abilitycooldownlv04 = 11
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set trg = null
            set tga = null
            set u = null
            return
        endif
    endif
    //======== 
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_Minoriko01_Hit)
    set task = GetHandleId(trg)
    set level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveTriggerActionHandle(udg_ht,task,1,tga)
    call SaveInteger(udg_ht,task,0,level)
    set u = CreateUnit(GetOwningPlayer(caster),'o00R',ox,oy,270.0)
    call UnitApplyTimedLife(u,'BTLF',7.0)
    call TriggerRegisterUnitEvent( trg, u, EVENT_UNIT_DEATH )
    call TriggerRegisterUnitEvent( trg, target, EVENT_UNIT_DAMAGED )
    set s = 1.6 + 0.1*level
    call SetUnitScale(u,s,s,s)
    if IsUnitAlly(target,GetOwningPlayer(caster)) then
        call SaveInteger(udg_ht,task,1,0)
        call IssueTargetOrder(u,"shadowstrike",target)
    else
        call SaveInteger(udg_ht,task,1,1)
        call SetUnitAbilityLevel(u,'A0JH',level)
        call IssueTargetOrder(u,"thunderbolt",target)
    endif
    //========
    set caster = null
    set target = null
    set trg = null
    set tga = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Minoriko01 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Minoriko02
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Minoriko02_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetSummonedUnit())=='o00S'
endfunction

function Trig_Minoriko02_Target takes nothing returns boolean
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitDeadBJ(GetFilterUnit()) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_MECHANICAL) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_MAGIC_IMMUNE) == true then
        return false
    endif
    if IsUnitGiant(GetFilterUnit()) then
        return false
    endif
    return true
endfunction

function Trig_Minoriko02_Heal takes unit h,integer level,real rate returns boolean
    local real HP = GetUnitState(h,UNIT_STATE_LIFE)
    local real MP = GetUnitState(h,UNIT_STATE_MANA)
    local real a = rate*(50.0 + level*50.0)/5.0
    local real b = rate*(90.0 + level*20.0)/5.0
    local real c = GetUnitState(h,UNIT_STATE_MAX_LIFE) - HP
    local real d = GetUnitState(h,UNIT_STATE_MAX_MANA) - MP
    local real ox = GetUnitX(h) - 40.0
    local real oy = GetUnitY(h)
    local texttag e
    if c<50.0 and d<50.0 then
        return false
    endif
    call SetUnitState(h,UNIT_STATE_LIFE,HP + a)
    call SetUnitState(h,UNIT_STATE_MANA,MP + b)
    if false then
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIma\\AImaTarget.mdl",h,"chest"))
        set e = CreateTextTag()
        call SetTextTagTextBJ(e,"＋" + R2SW(a,3,0),12.0)
        call SetTextTagPos(e,ox,oy,100.0)
        call SetTextTagColor(e,0,255,96,240)
        call SetTextTagVelocityBJ(e,150,90)
        call SetTextTagPermanent(e,false)
        call SetTextTagLifespan(e,1.67)
        set e = CreateTextTag()
        call SetTextTagTextBJ(e,"＋" + R2SW(b,3,0),12.0)
        call SetTextTagPos(e,ox,oy,50.0)
        call SetTextTagColor(e,0,30,255,240)
        call SetTextTagVelocityBJ(e,150,90)
        call SetTextTagPermanent(e,false)
        call SetTextTagLifespan(e,1.67)
    endif
    set e = null
    return true
endfunction

function Trig_Minoriko02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local player w = GetOwningPlayer(u)
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local group g
    local boolexpr f
    local integer level = LoadInteger(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    local integer j
    local integer k
    //========
    if i<40 and IsUnitAlive(u) then
        call SaveInteger(udg_ht,task,1,i + 1)
        set g = CreateGroup()
        set f = Filter(function Trig_Minoriko02_Target)
        call GroupEnumUnitsInRange(g,ox,oy,500.0,f)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitAlly(v,w) then
                set k = GetHandleId(v)
                if HaveSavedInteger(udg_ht,task,k) then
                    set j = LoadInteger(udg_ht,task,k)
                else
                    set j = 0
                endif
                if j<5 then
                    if Trig_Minoriko02_Heal(v,level,1.0) then
                        set j = j + 1
                    endif
                    call SaveInteger(udg_ht,task,k,j)
                endif
            endif
        endloop
        call DestroyBoolExpr(f)
        call DestroyGroup(g)
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set g = null
    set f = null
endfunction

function Trig_Minoriko02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u = GetSummonedUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0JI')
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 36
    local real abilitycooldownlv02 = 36
    local real abilitycooldownlv03 = 36
    local real abilitycooldownlv04 = 36
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,'A0JI') == 1 then
            call Item_HeroAbilityCoolDownReset(caster,'A0JI',abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,'A0JI') == 2 then
            call Item_HeroAbilityCoolDownReset(caster,'A0JI',abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,'A0JI') == 3 then
            call Item_HeroAbilityCoolDownReset(caster,'A0JI',abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,'A0JI',abilitycooldownlv04)
        endif
    endif
    //========
    call SetUnitAbilityLevel(u,'A0L6',level)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,0,level)
    call SaveInteger(udg_ht,task,1,0)
    call TimerStart(t,0.5,true,function Trig_Minoriko02_Main)
    //========
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Minoriko02 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Minoriko03
//===========================================================================
function Trig_Minoriko03_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0JK'
endfunction

function Trig_Minoriko03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    //========
    local real abilitycooldownlv01 = 20
    local real abilitycooldownlv02 = 20
    local real abilitycooldownlv03 = 20
    local real abilitycooldownlv04 = 20
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set caster = null
endfunction

//===========================================================================
function InitTrig_Minoriko03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Minoriko04
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Minoriko04_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A0JJ'
endfunction

function Trig_Minoriko04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local player w = GetOwningPlayer(caster)
    local integer level = GetUnitAbilityLevel(caster,'A0JJ')
    local group g
    local unit v
    //========
    set g = CreateGroupOfAllHeroes()
    if IsUnitAlive(caster) then
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitAlly(v,w) and IsUnitInRange(caster,v,900.0) and IsUnitAlive(v) then
                if GetUnitAbilityLevel(v,'A0JN')==0 then
                    call UnitAddAbility(v,'A0JN')
                    call UnitMakeAbilityPermanent(v,true,'A0JN')
                endif
                call SetUnitAbilityLevel(v,'A0JN',level)
            elseif GetUnitAbilityLevel(v,'A0JN')>0 then
                call UnitRemoveAbility(v,'A0JN')
            endif
        endloop
    else
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if GetUnitAbilityLevel(v,'A0JN')>0 then
                call UnitRemoveAbility(v,'A0JN')
            endif
        endloop
    endif
    call DestroyGroup(g)
    //========
    set t = null
    set caster = null
    set w = null
    set g = null
    set v = null
endfunction

function Trig_Minoriko04_Actions takes nothing returns nothing
    local unit h = GetTriggerUnit()
    local timer t
    local integer task
    local integer level = GetUnitAbilityLevel(h,'A0JJ')
    if level==1 then
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,h)
        call TimerStart(t,0.5,true,function Trig_Minoriko04_Main)
    endif
    set h = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Minoriko04 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Init Minoriko
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Init_Minoriko_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H01I')
    local player w = GetOwningPlayer(h)
    local integer task = GetHandleId(h)
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + "技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set udg_SK_Minoriko = h
    
    set gg_trg_Minoriko_Harvest = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Minoriko_Harvest, h, EVENT_UNIT_HERO_LEVEL )
    call TriggerAddAction( gg_trg_Minoriko_Harvest, function Trig_Minoriko_Harvest_Actions )

    set gg_trg_Minoriko01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Minoriko01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Minoriko01, Condition( function Trig_Minoriko01_Conditions ) )
    call TriggerAddAction( gg_trg_Minoriko01, function Trig_Minoriko01_Actions )
    
    set gg_trg_Minoriko02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Minoriko02, h, EVENT_UNIT_SUMMON )
    call TriggerAddCondition( gg_trg_Minoriko02, Condition( function Trig_Minoriko02_Conditions ) )
    call TriggerAddAction( gg_trg_Minoriko02, function Trig_Minoriko02_Actions )

    set gg_trg_Minoriko03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Minoriko03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Minoriko03, Condition( function Trig_Minoriko03_Conditions ) )
    call TriggerAddAction( gg_trg_Minoriko03, function Trig_Minoriko03_Actions )
    
    set gg_trg_Minoriko04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Minoriko04, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Minoriko04, Condition( function Trig_Minoriko04_Conditions ) )
    call TriggerAddAction( gg_trg_Minoriko04, function Trig_Minoriko04_Actions )
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Minoriko takes nothing returns nothing
    set gg_trg_Init_Minoriko = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Minoriko, function Trig_Init_Minoriko_Actions )
endfunction

//===========================================================================
// Trigger: Momizi01
//===========================================================================
function Trig_Momizi01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A09U'
endfunction

function Trig_Momizi01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    //========
    local real abilitycooldownlv01 = 39
    local real abilitycooldownlv02 = 39
    local real abilitycooldownlv03 = 39
    local real abilitycooldownlv04 = 39
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set caster = null
endfunction

//===========================================================================
function InitTrig_Momizi01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Momizi02
//===========================================================================
function Trig_Momizi02_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A09V'
endfunction

function Trig_Momizi02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 15
    local real abilitycooldownlv03 = 15
    local real abilitycooldownlv04 = 15
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set caster = null
endfunction

//===========================================================================
function InitTrig_Momizi02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Momizi03
//===========================================================================
function Trig_Momizi03_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0QO'
endfunction

function Trig_Momizi03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit w
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    local real abilitycooldownlv01 = 17
    local real abilitycooldownlv02 = 17
    local real abilitycooldownlv03 = 17
    local real abilitycooldownlv04 = 17
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set w = null
            return
        endif
    endif
    //========
    set w = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0)
    call UnitAddAbility(w,'A09T')
    call SetUnitAbilityLevel(w,'A09T',level)
    call IssueTargetOrder(w,"thunderbolt",target)
    set caster = null
    set target = null
    set w = null
endfunction

//===========================================================================
function InitTrig_Momizi03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Init Momizi
//
// > w < !!
//===========================================================================
function Trig_Init_Momizi_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('O00A')
    local integer task = GetHandleId(h)
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + "技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    call SetPlayerAbilityAvailableBJ( false, 'A0PH', GetOwningPlayer(h))

    set gg_trg_Momizi01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Momizi01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Momizi01, Condition( function Trig_Momizi01_Conditions ) )
    call TriggerAddAction( gg_trg_Momizi01, function Trig_Momizi01_Actions )
 
    set gg_trg_Momizi02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Momizi02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Momizi02, Condition( function Trig_Momizi02_Conditions ) )
    call TriggerAddAction( gg_trg_Momizi02, function Trig_Momizi02_Actions )

    set gg_trg_Momizi03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Momizi03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Momizi03, Condition( function Trig_Momizi03_Conditions ) )
    call TriggerAddAction( gg_trg_Momizi03, function Trig_Momizi03_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Momizi takes nothing returns nothing
    set gg_trg_Init_Momizi = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Momizi, function Trig_Init_Momizi_Actions )
endfunction

//===========================================================================
// Trigger: NueAttack
//===========================================================================
function Trig_NueAttack_Conditions takes nothing returns boolean
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    return GetUnitTypeId(GetAttacker()) == 'H01J'
endfunction

function Trig_NueAttack_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local effect e
    local real nmdamage
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        set e = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        set trg = null
        set caster = null
        set target = null
        set e = null
        return
    endif
    set target = GetTriggerUnit()
    //========
    call DisableTrigger(trg)
    //========
    set nmdamage = NueDamageCounting(caster) * 1.00
    call UnitDamageTargetHJ(caster,target,nmdamage,0)
    set e = AddSpecialEffect("Abilities\\Spells\\Undead\\OrbOfDeath\\OrbOfDeathMissile.mdl",GetUnitX(target),GetUnitY(target))
    call DestroyEffect(e)
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
    set e = null
endfunction

function Trig_NueAttack_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_NueAttack_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_NueAttack takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: NueIllusionKill
//===========================================================================
function Trig_NueIllusionKill_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0LZ'
endfunction

function Trig_NueIllusionKill_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local effect e
    local real nmdamage = NueDamageCounting(caster) * 2.00
    //========
    local real abilitycooldownlv01 = 8
    local real abilitycooldownlv02 = 8
    local real abilitycooldownlv03 = 8
    local real abilitycooldownlv04 = 8
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set e = null
            return
        endif
    endif
    //======== 
    set e = AddSpecialEffectTarget("Abilities\\Spells\\Human\\ControlMagic\\ControlMagicTarget.mdl",target,"overhead")
    call DestroyEffect(e)
    if IsUnitIllusionBJ(target) then
        call KillUnit(target)
    else
        call UnitDamageTarget(caster,target,nmdamage,false,false,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    endif
    set caster = null
    set target = null
    set e = null
endfunction

//===========================================================================
function InitTrig_NueIllusionKill takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Nue01
//===========================================================================
function Trig_Nue01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0M1'
endfunction

function Trig_Nue01_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local real nmdamage 
    set udg_SK_nue_nightmare_insc = udg_SK_nue_nightmare_insc - 1 
    if udg_SK_nue_nightmare_insc == 0 then
        set udg_SK_nue_nightmare_buff = 0
        set nmdamage = NueDamageCounting(caster) * 1.00
        call DisplayTimedTextToForce(GetForceOfPlayer(GetOwningPlayer(caster)),12.00,"|cffffcc00「平安京之恶梦」伤害数值|r：|cffffccff"+R2S(nmdamage)+"|r")
    endif
    set t = null
    set caster = null
endfunction

function Trig_Nue01_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit() 
    local real nmdamage 
    set udg_SK_nue_nightmare_buff = udg_SK_nue_nightmare_buff + 1
    set udg_SK_nue_nightmare_insc = udg_SK_nue_nightmare_insc + 1
    set nmdamage = NueDamageCounting(caster) * 1.00
    call DisplayTimedTextToForce(GetForceOfPlayer(GetOwningPlayer(caster)),12.00,"|cffffcc00「平安京之恶梦」伤害数值|r：|cffffccff"+R2S(nmdamage)+"|r")
    call SaveUnitHandle(udg_ht,task,0,caster) 
    call TimerStart(t,12.0,false,function Trig_Nue01_Clear) 
    set t = null     
    set caster = null
endfunction

//===========================================================================
function InitTrig_Nue01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Nue02
//===========================================================================
function Trig_Nue02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0M2'
endfunction

function Trig_Nue02_Fly takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,1)
    local real facing = LoadReal(udg_ht,task,2)
    local unit u = LoadUnitHandle(udg_ht,task,3)
    local integer i = LoadInteger(udg_ht,task,4)
    local group grp2 = LoadGroupHandle(udg_ht,task,5)
    local integer level = LoadInteger(udg_ht,task,6)
    local effect e
    local group grp1 = CreateGroup()
    local unit target
    local real nmdamage = NueDamageCounting(caster) * 3.00
    call GroupEnumUnitsInRange(grp1,GetUnitX(u),GetUnitY(u),140,null)
    loop
        set target = FirstOfGroup(grp1)
        exitwhen target == null
        call GroupRemoveUnit(grp1,target)
        if IsUnitEnemy(target,GetOwningPlayer(u)) and IsUnitInGroup(target,grp2)==false and IsUnitType(target,UNIT_TYPE_STRUCTURE) == false then
            call UnitDamageTarget(caster,target,80.00+level*40.00+nmdamage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
            set e = AddSpecialEffect("Abilities\\Spells\\Undead\\OrbOfDeath\\OrbOfDeathMissile.mdl",GetUnitX(target),GetUnitY(target))
            call DestroyEffect(e)
            call GroupAddUnit(grp2,target)
        endif
    endloop
    call GroupClear(grp1)
    call DestroyGroup(grp1)
    
    if i > 0 then
        call SaveInteger(udg_ht,task,4,i-1)          
        call SetUnitXY(u,GetUnitX(u)+40*Cos(facing*bj_DEGTORAD),GetUnitY(u)+40*Sin(facing*bj_DEGTORAD))
        set e = AddSpecialEffect("Abilities\\Spells\\Undead\\OrbOfDeath\\OrbOfDeathMissile.mdl",GetUnitX(u),GetUnitY(u))
        call DestroyEffect(e)
    else
        call GroupClear(grp2)
        call DestroyGroup(grp2)
        call KillUnit(u)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        set e = AddSpecialEffect("Abilities\\Spells\\Undead\\OrbOfDeath\\OrbOfDeathMissile.mdl",GetUnitX(u),GetUnitY(u))
        call DestroyEffect(e)
    endif
    set t = null
    set u = null
    set e = null
    set grp1 = null
    set grp2 = null
    set caster = null
    set target = null
endfunction

function Trig_Nue02_Fire takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,1)
    local real facing = LoadReal(udg_ht,task,2)
    local integer level = LoadInteger(udg_ht,task,6)
    local integer range
    local unit u = CreateUnit(GetOwningPlayer(caster),'e018',GetUnitX(caster)+10*Cos(facing*bj_DEGTORAD),GetUnitY(caster)+10*Sin(facing*bj_DEGTORAD),facing)
    local group grp2 = CreateGroup()
    call PauseUnit(caster,false)
    call SetUnitTimeScale(caster,1)
    call PauseTimer(t)
    call SaveUnitHandle(udg_ht,task,3,u)
    if level == 1 then
        set range = 17 //680
    endif
    if level == 2 then
        set range = 24 //960
    endif
    if level == 3 then
        set range = 31 //1240
    endif
    if level == 4 then
        set range = 38 //1520
    endif
    call SaveInteger(udg_ht,task,4,range)
    call SaveGroupHandle(udg_ht,task,5,grp2)
    call TimerStart(t,0.02,true,function Trig_Nue02_Fly)
    set t = null
    set caster = null
    set u = null
    set grp2 = null
endfunction

function Trig_Nue02_Go takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,1)
    call SetUnitTimeScale(caster,2)
    call SetUnitAnimationByIndex( caster, 5 )
    call PauseTimer(t)
    call TimerStart(t,0.5,false,function Trig_Nue02_Fire)
    set t = null
    set caster = null
endfunction
    
function Trig_Nue02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local real facing = bj_RADTODEG * Atan2(GetSpellTargetY() - GetUnitY(caster), GetSpellTargetX() - GetUnitX(caster))
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    call PauseUnit(caster,true)
    call SaveTimerHandle(udg_ht,task,0,t)
    call SaveUnitHandle(udg_ht,task,1,caster)
    call SaveReal(udg_ht,task,2,facing)
    call SaveInteger(udg_ht,task,6,level)
    call TimerStart(t,0.01,false,function Trig_Nue02_Go)
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Nue02 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Nue03
//===========================================================================
function Trig_Nue03_Conditions takes nothing returns boolean
    if GetUnitAbilityLevel(GetTriggerUnit(),'A0MM')!=0 then
        return false
    endif
    return GetOwningPlayer(GetKillingUnit()) == udg_SK_nue_rscd_player
endfunction

function Trig_Nue03_Actions takes nothing returns nothing
    local unit killer = GetKillingUnit()
    local unit dyer = GetTriggerUnit()
    local unit killerhero = GetPlayerCharacter(GetOwningPlayer(killer))
    call NueResetCD(killerhero,dyer) //In Misc
    set killer = null
    set dyer = null
    set killerhero = null
endfunction

//===========================================================================
function InitTrig_Nue03 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Nue04
//===========================================================================
function Trig_Nue04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0M4'
endfunction

function Trig_Nue04_Ufo takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level =  LoadInteger(udg_ht,task,1)
    local unit u = LoadUnitHandle(udg_ht,task,2)
    local real a = LoadReal(udg_ht,task,3)
    local integer i = LoadInteger(udg_ht,task,4)
    local unit k = LoadUnitHandle(udg_ht,task,5)
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local real oz
    local real px 
    local real py 
    local group g
    local unit v
    local unit w
    local real nmdamage 
    if i>0 then
        call SaveInteger(udg_ht,task,4,i - 1)
        set px = ox + 5*Cos(a)
        set py = oy + 5*Sin(a)
        call SetUnitXY(u,px,py)
        call SetUnitXY(k,px,py)
        call SetUnitFlyHeight(u,GetUnitFlyHeight(u)-40,0)
        call SetUnitFlyHeight(k,GetUnitFlyHeight(u)-40,0)
    else 
        set nmdamage = NueDamageCounting(caster) * 4.00
        call SetUnitXY(caster,ox,oy)
        call ShowUnitShow(caster)
        call SelectUnitForPlayerSingle(caster,GetOwningPlayer(caster))
        set g = CreateGroup()
        set w = CreateUnit(GetOwningPlayer(caster),'n01A',ox,oy,0)
        call UnitAddAbility(w,'A0M0')
        call SetUnitAbilityLevel(w,'A0M0',level)
        call IssueImmediateOrderById(w,852127)

        call GroupEnumUnitsInRange(g,ox,oy,250+level*50,null)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitEnemy(v,GetOwningPlayer(u)) and IsUnitAliveBJ(v) and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
                call UnitDamageTarget(caster,v,level*100 + nmdamage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
            endif
        endloop

        call KillUnit(u)
        call KillUnit(k)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set u = null
    set g = null
    set v = null
    set w = null
    set k = null
endfunction

function Trig_Nue04_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local unit u
    local unit k
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = Atan2(ty-oy,tx-ox)

    call ShowUnitHide(caster)
    set u = CreateUnit(GetOwningPlayer(caster),'e017',tx - 375*Cos(a),ty - 375*Sin(a),bj_RADTODEG*a)
    set k = CreateUnit(GetOwningPlayer(caster),'e019',tx - 375*Cos(a),ty - 375*Sin(a),bj_RADTODEG*a)
    call SetUnitPathing(u,false)
    call SetUnitPathing(k,false)

    call SetUnitVertexColor(u,GetRandomInt(1,255),GetRandomInt(1,255),GetRandomInt(1,255),255)

    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,1,level)
    call SaveUnitHandle(udg_ht,task,2,u)
    call SaveReal(udg_ht,task,3,a)
    call SaveInteger(udg_ht,task,4,75)
    call SaveUnitHandle(udg_ht,task,5,k)
    call TimerStart(t,0.02,true,function Trig_Nue04_Ufo)
    set caster = null
    set t = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Nue04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initial Nue
//===========================================================================
function Trig_Initial_Nue_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H01J')
    local player w = GetOwningPlayer(h)
    local integer task = GetHandleId(h)
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + "技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    //Nightmare Damage System In Misc
    //Reset Cooldown System In Misc

    //Nightmare Damage Increasing Buff
    set udg_SK_nue_nightmare_insc = 0
    set udg_SK_nue_nightmare_buff = 0
    //Reset Cooldown's Player Confirm
    set udg_SK_nue_rscd_player = GetOwningPlayer(h)

    set gg_trg_NueAttack = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_NueAttack, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_NueAttack, Condition( function Trig_NueAttack_Conditions ) )
    call TriggerAddAction( gg_trg_NueAttack, function Trig_NueAttack_Actions )

    set gg_trg_NueIllusionKill = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_NueIllusionKill, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_NueIllusionKill, Condition( function Trig_NueIllusionKill_Conditions ) )
    call TriggerAddAction( gg_trg_NueIllusionKill, function Trig_NueIllusionKill_Actions )

    set gg_trg_Nue01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Nue01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Nue01, Condition( function Trig_Nue01_Conditions ) )
    call TriggerAddAction( gg_trg_Nue01, function Trig_Nue01_Actions )

    set gg_trg_Nue02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Nue02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Nue02, Condition( function Trig_Nue02_Conditions ) )
    call TriggerAddAction( gg_trg_Nue02, function Trig_Nue02_Actions )

    set gg_trg_Nue03 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Nue03, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_Nue03, Condition( function Trig_Nue03_Conditions ) )
    call TriggerAddAction( gg_trg_Nue03, function Trig_Nue03_Actions )

    set gg_trg_Nue04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Nue04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Nue04, Condition( function Trig_Nue04_Conditions ) )
    call TriggerAddAction( gg_trg_Nue04, function Trig_Nue04_Actions )
 
    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Nue takes nothing returns nothing
    set gg_trg_Initial_Nue = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Nue, function Trig_Initial_Nue_Actions )
endfunction

//===========================================================================
// Trigger: Keine Ability Change
//===========================================================================
function Trig_Keine_Ability_Change_Actions takes nothing returns nothing
    local unit u = udg_SK_Keine
    if GetUnitAbilityLevel(u,'A0M5') == 0 and GetUnitAbilityLevel(u,'A0M8') > 0 then
        call UnitAddAbility(u,'A0M5')
    endif
    if GetUnitAbilityLevel(u,'A0M8')!=0 then
        call SetUnitAbilityLevel(u,'A0M5',(GetUnitAbilityLevel(u,'A0M8') + udg_SK_Keine_Wolf))
    endif
    if GetUnitAbilityLevel(u,'A0M6') == 0 and GetUnitAbilityLevel(u,'A0M9') > 0 then
        call UnitAddAbility(u,'A0M6')               
    endif
    if GetUnitAbilityLevel(u,'A0M9')!=0 then
        call SetUnitAbilityLevel(u,'A0M6',(GetUnitAbilityLevel(u,'A0M9') + udg_SK_Keine_Wolf))
    endif
    if GetUnitAbilityLevel(u,'A0M7') == 0 and GetUnitAbilityLevel(u,'A0MA') > 0 then
        call UnitAddAbility(u,'A0M7')
        call UnitAddAbility(u,'A0ML')
    endif
    if GetUnitAbilityLevel(u,'A0MA')!=0 then
        call SetUnitAbilityLevel(u,'A0M7',(GetUnitAbilityLevel(u,'A0MA') + udg_SK_Keine_Wolf))
        call SetUnitAbilityLevel(u,'A0ME',(GetUnitAbilityLevel(u,'A0MA') + udg_SK_Keine_Wolf))
    endif
    set u = null  
endfunction

//===========================================================================
function InitTrig_Keine_Ability_Change takes nothing returns nothing   
endfunction//===========================================================================
// Trigger: Keine01
//===========================================================================
//TESH.scrollpos=21
//TESH.alwaysfold=0
function Trig_Keine_01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0M5'
endfunction

function Trig_Keine_01_Kill takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local effect e = LoadEffectHandle(udg_ht,task,2)
    if GetUnitState(target,UNIT_STATE_LIFE) > 0.00 then
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",target,"chest"))
        call UnitDamageTarget(caster,target,60,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    else
        call DestroyEffect(e)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set target = null
    set e = null
endfunction

function Trig_Keine_01_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local effect e = LoadEffectHandle(udg_ht,task,2)
    local real hp = LoadReal(udg_ht,task,3)
    local integer style = LoadInteger(udg_ht,task,4)
    call DestroyEffect(e)
    if style == 0 then
        call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",target,"chest"))
        call SetUnitState(target,UNIT_STATE_LIFE,hp)
    else
        if GetUnitState(target,UNIT_STATE_LIFE)-hp >= 0.00 then
            call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",target,"chest"))
            call SetUnitState(target,UNIT_STATE_LIFE,(GetUnitState(target,UNIT_STATE_LIFE)+(GetUnitState(target,UNIT_STATE_LIFE)-hp)*0.50))
        else
            call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\ManaFlare\\ManaFlareBoltImpact.mdl",target,"chest"))
            call UnitDamageTarget(caster,target,(hp-GetUnitState(target,UNIT_STATE_LIFE))*0.50,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS )
        endif
    endif
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set caster = null
    set target = null
    set e = null
endfunction

function Trig_Keine_01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local effect e
    local timer t
    local integer task
    local real hp
    local integer style
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set e = null
            set t = null
            return
        endif
    endif
    //======== 
    if IsUnitType(target,UNIT_TYPE_HERO) then
        if udg_SK_Keine_Wolf == 0 then
            set style = 0
        else
            set style = 1
        endif
        set e = AddSpecialEffectTarget("Abilities\\Spells\\Orc\\Voodoo\\VoodooAuraTarget.mdl",target,"chest")
        set t = CreateTimer()
        set task = GetHandleId(t)
        set hp = GetUnitState(target,UNIT_STATE_LIFE)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveUnitHandle(udg_ht,task,1,target)
        call SaveEffectHandle(udg_ht,task,2,e)
        call SaveReal(udg_ht,task,3,hp)
        call SaveInteger(udg_ht,task,4,style)
        call TimerStart(t,5.0,false,function Trig_Keine_01_Clear)
    else
        set e = AddSpecialEffectTarget("Abilities\\Spells\\Orc\\Voodoo\\VoodooAuraTarget.mdl",target,"chest")
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveUnitHandle(udg_ht,task,1,target)
        call SaveEffectHandle(udg_ht,task,2,e)
        call TimerStart(t,0.10,true,function Trig_Keine_01_Kill)
    endif
    set caster = null
    set target = null
    set e = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Keine01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Keine02
//===========================================================================
//TESH.scrollpos=20
//TESH.alwaysfold=0
function Trig_Keine_02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0M6'
endfunction

function Trig_Keine_02_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_ht,task,0)
    local unit v = LoadUnitHandle(udg_ht,task,1)
    local effect e = LoadEffectHandle(udg_ht,task,2)
    local effect f = LoadEffectHandle(udg_ht,task,3)
    call SetUnitInvulnerable(u,false)
    call DestroyEffect(e)
    if v != null then
        call SetUnitInvulnerable(v,false)
        call DestroyEffect(f)
    endif
    call PauseTimer(t)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set u = null
    set v = null
    set e = null
    set f = null
endfunction

function Trig_Keine_02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit u
    local effect e
    local effect f
    local timer t
    local integer task
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set u = null
            set e = null
            set f = null
            set t = null
            return
        endif
    endif
    //======== 
    call UnitDamageTarget(caster,caster,GetUnitState(caster,UNIT_STATE_LIFE)*0.30,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    if IsUnitAlly(target,GetOwningPlayer(caster)) then
        call SetUnitInvulnerable(caster, true)
        call SetUnitInvulnerable(target, true)
        set e = AddSpecialEffectTarget("Abilities\\Spells\\Human\\DivineShield\\DivineShieldTarget.mdl",caster,"origin")
        set f = AddSpecialEffectTarget("Abilities\\Spells\\Human\\DivineShield\\DivineShieldTarget.mdl",target,"origin")
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveUnitHandle(udg_ht,task,1,target)
        call SaveEffectHandle(udg_ht,task,2,e)
        call SaveEffectHandle(udg_ht,task,3,f)
        call TimerStart(t,2.0,false,function Trig_Keine_02_Clear)
    else
        call SetUnitInvulnerable(caster, true)     
        set e = AddSpecialEffectTarget("Abilities\\Spells\\Human\\DivineShield\\DivineShieldTarget.mdl",caster,"origin")   
        set u = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(caster),GetUnitY(caster),GetUnitFacing(caster))
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveUnitHandle(udg_ht,task,1,null)
        call SaveEffectHandle(udg_ht,task,2,e)
        call SaveEffectHandle(udg_ht,task,3,null)
        call TimerStart(t,2.0,false,function Trig_Keine_02_Clear)
        if GetUnitCurrentOrder(target)!=OrderId("metamorphosis") then
            call UnitAddAbility(u,'A0MC')
            call IssueTargetOrder(u,"drunkenhaze",target)
        endif
    endif
    set caster = null
    set target = null
    set u = null
    set e = null
    set f = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Keine02 takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Keine03
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Keine_03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0M7'
endfunction

function Trig_Keine_03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target) 
    local real a = Atan2(ty-oy,tx-ox)
    local real px = tx - 90*Cos(a)
    local real py = ty - 90*Sin(a)
    local integer level = GetUnitAbilityLevel(caster,'A0M7')
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set u = null
            return
        endif
    endif
    //======== 
    call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\NightElf\\Blink\\BlinkTarget.mdl", ox, oy) )
    call IssueTargetOrderById( caster, 851983, target )
    call SetUnitAnimation(caster, "attack slam" )    
    call SetUnitXY(caster,px,py)
    set u = CreateUnit(GetOwningPlayer(caster), 'n001', tx, ty, 0.00)
    call UnitAddAbility( u, 'A0MD' )
    call SetUnitAbilityLevel( u,'A0MD',level)
    call IssueTargetOrderById( u, 852095, target )
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Keine03 takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: Keine04
//===========================================================================
function Trig_Keine_04_Conditions takes nothing returns boolean
    if ( not ( GetUnitTypeId(GetTriggerUnit()) == 'E01A' ) ) then
        return false
    endif
    return GetSpellAbilityId() == 'A0MB'
endfunction

function Trig_Keine_04_Clear takes nothing returns nothing
    local timer p = GetExpiredTimer()
    local integer pask = GetHandleId(p)
    local unit caster = LoadUnitHandle(udg_ht,pask,0)
    local integer level = LoadInteger(udg_ht,pask,1)
    local real k0
    local real k1
    set udg_SK_Keine = caster
    set udg_SK_Keine_Wolf = 0
    set k0 = GetUnitState(caster,UNIT_STATE_MAX_LIFE)
    set k1 = GetUnitState(caster,UNIT_STATE_LIFE)
    if udg_SK_Keine04_count == 0 then
        set udg_SK_Keine04_count = 1
        call SetHeroStr(caster,(GetHeroStr(caster,false)-udg_SK_Keine_Str),true)
    endif
    if GetUnitState(caster,UNIT_STATE_LIFE) > 0 then
        call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_MAX_LIFE)*(k1/k0))
    endif
    call TriggerExecute(gg_trg_Keine_Ability_Change)
    call PauseTimer(p)
    call DestroyTimer(p)
    call FlushChildHashtable(udg_ht,pask)
    set caster = null
    set p = null
endfunction

function Trig_Keine_04_AtkStr_Actions takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = LoadInteger(udg_ht,task,1)
    local real m = LoadReal(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,3)
    local timer p 
    local integer pask
    local unit keine = caster
    local integer atk = GetHeroStr(caster,true) - GetHeroInt(caster,true) + 1
    set i = i + 1
    if i == 1 then
        call TriggerExecute(gg_trg_Keine_Ability_Change)
        call SetUnitAnimation(caster,"Morph")
    endif

    if GetUnitTypeId(keine) == 'E01B' and IsUnitType(caster,UNIT_TYPE_DEAD) == false then
        if GetUnitAbilityLevel(caster,'A0MH') == 0 then
            call UnitAddAbility(caster, 'A0MH')
        endif
        if GetUnitAbilityLevel(caster,'A0MG') == 0 then
            call UnitAddAbility(caster, 'A0MG')
        endif
        if GetUnitAbilityLevel(caster,'A0MF') == 0 then
            call UnitAddAbility(caster, 'A0MF')
        endif
        call SetUnitAbilityLevel(keine, 'A0MH', R2I(atk/100)+1)
        set atk = atk - R2I(atk/100)*100    
        call SetUnitAbilityLevel(keine, 'A0MG', R2I(atk/10)+1)
        set atk = atk - R2I(atk/10)*10    
        call SetUnitAbilityLevel(keine, 'A0MF',atk+1)
        call SaveInteger(udg_ht,task,3,i)
    else    
        call UnitRemoveAbility(keine,'A0MH')
        call UnitRemoveAbility(keine,'A0MG')
        call UnitRemoveAbility(keine,'A0MF')
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        set p = CreateTimer()
        set pask = GetHandleId(p)
        call SaveUnitHandle(udg_ht,pask,0,caster)
        call SaveInteger(udg_ht,pask,1,level)        
        call TimerStart(p,0.01,false,function Trig_Keine_04_Clear)        
    endif
    set p = null
    set t = null
    set caster = null
    set keine = null
endfunction

function Trig_Keine_04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local integer level = GetUnitAbilityLevel(caster, 'A0MB')
    local real m = GetUnitState(caster,UNIT_STATE_MANA)
    local real k0
    local real k1
    set udg_SK_Keine = caster
    set udg_SK_Keine_Wolf = level
    set udg_SK_Keine04_count = 0
    set udg_SK_Keine_Str = 15 + level * 15
    set k0 = GetUnitState(caster,UNIT_STATE_MAX_LIFE)
    set k1 = GetUnitState(caster,UNIT_STATE_LIFE)
    call SetHeroStr(caster,(GetHeroStr(caster,false)+udg_SK_Keine_Str),true)
    call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_MAX_LIFE)*(k1/k0))
    call TriggerExecute(gg_trg_Keine_Ability_Change)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,1,level)
    call SaveReal(udg_ht,task,2,m)
    call SaveInteger(udg_ht,task,3,0)
    call TimerStart(t,0.02,true,function Trig_Keine_04_AtkStr_Actions)
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Keine04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initial Keine
//===========================================================================
function Trig_Initial_Keine_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E01A')
    local player w = GetOwningPlayer(h)
    local integer task = GetHandleId(h)
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + "技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())
 
    set udg_SK_Keine = h
    set udg_SK_Keine_Str = 0
    set udg_SK_Keine_Wolf = 0

    set gg_trg_Keine_Ability_Change = CreateTrigger()
    call TriggerRegisterUnitEvent(gg_trg_Keine_Ability_Change,h,EVENT_UNIT_HERO_SKILL )
    call TriggerRegisterTimerEventPeriodic(gg_trg_Keine_Ability_Change,5.00)
    call TriggerAddAction( gg_trg_Keine_Ability_Change, function Trig_Keine_Ability_Change_Actions )

    set gg_trg_Keine01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Keine01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Keine01, Condition( function Trig_Keine_01_Conditions ) )
    call TriggerAddAction( gg_trg_Keine01, function Trig_Keine_01_Actions )

    set gg_trg_Keine02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Keine02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Keine02, Condition( function Trig_Keine_02_Conditions ) )
    call TriggerAddAction( gg_trg_Keine02, function Trig_Keine_02_Actions )

    set gg_trg_Keine03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Keine03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Keine03, Condition( function Trig_Keine_03_Conditions ) )
    call TriggerAddAction( gg_trg_Keine03, function Trig_Keine_03_Actions )

    set gg_trg_Keine04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Keine04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Keine04, Condition( function Trig_Keine_04_Conditions ) )
    call TriggerAddAction( gg_trg_Keine04, function Trig_Keine_04_Actions )


    call UnitAddAbility(h, 'A0MH')
    call UnitAddAbility(h, 'A0MG')
    call UnitAddAbility(h, 'A0MF')
    call UnitRemoveAbility(h,'A0MH')
    call UnitRemoveAbility(h,'A0MG')
    call UnitRemoveAbility(h,'A0MF')

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Keine takes nothing returns nothing
    set gg_trg_Initial_Keine = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Keine, function Trig_Initial_Keine_Actions )
endfunction

//===========================================================================
// Trigger: Byakuren01
//===========================================================================
function Trig_Byakuren01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0NZ'
endfunction

function Trig_Byakuren01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local unit e1
    local unit e2
    local unit v
    local unit w
    local group g
    local boolexpr iff
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 12.5
    local real abilitycooldownlv03 = 10
    local real abilitycooldownlv04 = 7.5
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set e1 = null
            set e2 = null
            set v = null
            set w = null
            set g = null
            set iff = null
            return
        endif
    endif
    //======== 
    set e1 = CreateUnit(GetOwningPlayer(caster),'e01J',tx,ty,0)
    set e2 = CreateUnit(GetOwningPlayer(caster),'e01J',tx,ty,180)
    set g = CreateGroup()
    set iff = GetPlayerFilter(GetOwningPlayer(caster))
    call SetUnitPathing(e1,false)
    call SetUnitPathing(e2,false)
    call SetUnitXY(e1,tx,ty)
    call SetUnitXY(e2,tx,ty)
    call UnitDamageTarget(caster,target,50+75*level-5,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    set w = CreateUnit(GetOwningPlayer(caster),'n001',tx,ty,0)
    call UnitAddAbility(w,'A0O4')
    call SetUnitAbilityLevel(w,'A0O4',level)
    call IssueTargetOrder(w,"thunderbolt",target)
    call GroupEnumUnitsInRange(g,tx,ty,350,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and target != v then
            call UnitDamageTarget(caster,v,40+40*level-5,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
            set w = CreateUnit(GetOwningPlayer(caster),'n001',tx,ty,0)
            call UnitAddAbility(w,'A0O4')
            call SetUnitAbilityLevel(w,'A0O4',level)
            call IssueTargetOrder(w,"thunderbolt",v)
        endif
    endloop
    set caster = null
    set target = null
    set e1 = null
    set e2 = null
    set v = null
    set w = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_Byakuren01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Byakuren02
//===========================================================================
function Trig_Byakuren02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0O2'
endfunction

function Trig_Byakuren02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local unit e
    local real damage = RMinBJ(GetUnitState(caster,UNIT_STATE_MANA),GetUnitState(caster,UNIT_STATE_MAX_MANA)*0.20)
    //========
    local real abilitycooldownlv01 = 8
    local real abilitycooldownlv02 = 7
    local real abilitycooldownlv03 = 6
    local real abilitycooldownlv04 = 5
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set e = null
            return
        endif
    endif
    //======== 
    set e = CreateUnit(GetOwningPlayer(caster),'e01M',tx,ty,0)
    call SetUnitPathing(e,false)
    call SetUnitXY(e,tx,ty)
    call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA)-damage)
    call UnitDamageTarget(caster,target,damage*(0.20+level*0.30),false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
    set caster = null
    set target = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Byakuren02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Byakuren03
//===========================================================================
//TESH.scrollpos=10
//TESH.alwaysfold=0
function Trig_Byakuren03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0O0'
endfunction

function Trig_Byakuren03_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit target = LoadUnitHandle(udg_ht,task,0)
    local real tx = LoadReal(udg_ht,task,1)
    local real ty = LoadReal(udg_ht,task,2)
    if IsUnitType(target,UNIT_TYPE_DEAD) == false then
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Charm\\CharmTarget.mdl",GetUnitX(target),GetUnitY(target)))
        call SetUnitXY(target,tx,ty)
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Charm\\CharmTarget.mdl",tx,ty))
    endif
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set target = null
endfunction

function Trig_Byakuren03_Actions takes nothing returns nothing
    local timer t
    local integer task
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local unit e1
    local unit e2
    local unit e3
    //========
    local real abilitycooldownlv01 = 17
    local real abilitycooldownlv02 = 16
    local real abilitycooldownlv03 = 15
    local real abilitycooldownlv04 = 14
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set e1 = null
            set e2 = null
            set e3 = null
            set t = null
            return
        endif
    endif
    //======== 
    set e1 = CreateUnit(GetOwningPlayer(caster),'e01K',tx,ty,GetRandomInt(0,360))
    set e2 = CreateUnit(GetOwningPlayer(caster),'e01K',tx,ty,GetRandomInt(0,360))
    set e3 = CreateUnit(GetOwningPlayer(caster),'e01K',tx,ty,GetRandomInt(0,360))
    call SetUnitPathing(e1,false)
    call SetUnitPathing(e2,false)
    call SetUnitPathing(e3,false)
    call SetUnitXY(e1,tx,ty)
    call SetUnitXY(e2,tx,ty)
    call SetUnitXY(e3,tx,ty)
    call SetUnitFlyHeight(e1,0,0)
    call SetUnitFlyHeight(e2,100,0)
    call SetUnitFlyHeight(e3,200,0)
    call AttachSoundToUnit(gg_snd_PaladinDivineShieldDeath1, caster)
    call SetSoundVolume(gg_snd_PaladinDivineShieldDeath1, 127)
    call StartSound(gg_snd_PaladinDivineShieldDeath1)
    if IsUnitAlly(target,GetOwningPlayer(caster)) then
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Charm\\CharmTarget.mdl",GetUnitX(target),GetUnitY(target)))
        call SetUnitXY(target,ox,oy)
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Other\\Charm\\CharmTarget.mdl",tx,ty))
    else
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,target)
        call SaveReal(udg_ht,task,1,tx)
        call SaveReal(udg_ht,task,2,ty)
        call TimerStart(t,3.0,false,function Trig_Byakuren03_Clear)        
    endif
    set caster = null
    set target = null
    set e1 = null
    set e2 = null
    set e3 = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Byakuren03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Byakuren04
//===========================================================================
//TESH.scrollpos=31
//TESH.alwaysfold=0
function Trig_Byakuren04_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A0O1'
endfunction

function Trig_Byakuren04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = GetUnitAbilityLevel(caster,'A0O1')
    local integer life
    local integer extrlife = R2I(GetUnitState(caster,UNIT_STATE_MAX_MANA) * (0.15+0.15 * level))
    local integer origlife = LoadInteger(udg_ht,task,1)

    if IsUnitType(caster,UNIT_TYPE_DEAD) == false and extrlife != origlife then
        set life = origlife

        call UnitAddAbility(caster,'A0OD')
        call SetUnitAbilityLevel(caster,'A0OD',R2I(life/1000)+1)
        call UnitRemoveAbility(caster,'A0OD')
        set life = life - R2I(life/1000)*1000
    
        call UnitAddAbility(caster,'A0OC')
        call SetUnitAbilityLevel(caster,'A0OC',R2I(life/100)+1)
        call UnitRemoveAbility(caster,'A0OC')
        set life = life - R2I(life/100)*100
    
        call UnitAddAbility(caster,'A0OB')
        call SetUnitAbilityLevel(caster,'A0OB',R2I(life/10)+1)
        call UnitRemoveAbility(caster,'A0OB')
        set life = life - R2I(life/10)*10
    
        call UnitAddAbility(caster, 'A0OA')
        call SetUnitAbilityLevel(caster,'A0OA',life+1)
        call UnitRemoveAbility(caster,'A0OA')

        set life = extrlife

        call UnitAddAbility(caster,'A0O9')
        call SetUnitAbilityLevel(caster,'A0O9',R2I(life/1000)+1)
        call UnitRemoveAbility(caster,'A0O9')
        set life = life - R2I(life/1000)*1000
    
        call UnitAddAbility(caster,'A0O8')
        call SetUnitAbilityLevel(caster,'A0O8',R2I(life/100)+1)
        call UnitRemoveAbility(caster,'A0O8')
        set life = life - R2I(life/100)*100
    
        call UnitAddAbility(caster,'A0O7')
        call SetUnitAbilityLevel(caster,'A0O7',R2I(life/10)+1)
        call UnitRemoveAbility(caster,'A0O7')
        set life = life - R2I(life/10)*10
    
        call UnitAddAbility(caster, 'A0O6')
        call SetUnitAbilityLevel(caster,'A0O6',life+1)
        call UnitRemoveAbility(caster,'A0O6')

        call SaveInteger(udg_ht,task,1,extrlife)
    endif

    set t = null
    set caster = null
endfunction

function Trig_Byakuren04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t
    local integer task
    local integer level = GetUnitAbilityLevel(caster,'A0O1')
    if level==1 then
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call SaveInteger(udg_ht,task,1,0)
        call TimerStart(t,0.10,true,function Trig_Byakuren04_Main)
    endif
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Byakuren04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Byakuren04Attack
//===========================================================================
//TESH.scrollpos=36
//TESH.alwaysfold=0
function Trig_Byakuren04Attack_Conditions takes nothing returns boolean
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    return GetUnitTypeId(GetAttacker()) == 'H01K'
endfunction

function Trig_Byakuren04Attack_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local real damage
    local integer level
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        set trg = null
        set caster = null
        set target = null
        return
    endif
    set target = GetTriggerUnit()
    set level = GetUnitAbilityLevel(caster,'A0O1')
    //========
    call DisableTrigger(trg)
    //========
    if GetUnitAbilityLevel(caster,'A0O1') != 0 then
        set damage = level*15 + (GetUnitState(caster,UNIT_STATE_MAX_LIFE)-GetUnitState(caster,UNIT_STATE_LIFE)) * (level*0.01)
        call UnitDamageTargetHJ(caster,target,damage,0)
        call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_LIFE)+damage)
    endif
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\GreenDragonMissile\\GreenDragonMissile.mdl",GetUnitX(target),GetUnitY(target)))
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
endfunction

function Trig_Byakuren04Attack_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_Byakuren04Attack_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Byakuren04Attack takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initial Byakuren
//===========================================================================
//TESH.scrollpos=14
//TESH.alwaysfold=0
function Trig_Initial_Byakuren_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H01K')
    local player w = GetOwningPlayer(h)
    local integer task = GetHandleId(h)
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + "技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set gg_trg_Byakuren01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Byakuren01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Byakuren01, Condition( function Trig_Byakuren01_Conditions))
    call TriggerAddAction( gg_trg_Byakuren01, function Trig_Byakuren01_Actions )

    set gg_trg_Byakuren02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Byakuren02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Byakuren02, Condition( function Trig_Byakuren02_Conditions))
    call TriggerAddAction( gg_trg_Byakuren02, function Trig_Byakuren02_Actions )

    set gg_trg_Byakuren03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Byakuren03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Byakuren03, Condition( function Trig_Byakuren03_Conditions))
    call TriggerAddAction( gg_trg_Byakuren03, function Trig_Byakuren03_Actions )

    set gg_trg_Byakuren04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Byakuren04, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Byakuren04, Condition( function Trig_Byakuren04_Conditions ) )
    call TriggerAddAction( gg_trg_Byakuren04, function Trig_Byakuren04_Actions )

    set gg_trg_Byakuren04Attack = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Byakuren04Attack, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Byakuren04Attack, Condition( function Trig_Byakuren04Attack_Conditions ) )
    call TriggerAddAction( gg_trg_Byakuren04Attack, function Trig_Byakuren04Attack_Actions )

    call UnitAddAbility(h,'A0OD')
    call UnitRemoveAbility(h,'A0OD')
    call UnitAddAbility(h,'A0OC')
    call UnitRemoveAbility(h,'A0OC')
    call UnitAddAbility(h,'A0OB')
    call UnitRemoveAbility(h,'A0OB')
    call UnitAddAbility(h, 'A0OA')
    call UnitRemoveAbility(h,'A0OA')
    call UnitAddAbility(h,'A0O9')
    call UnitRemoveAbility(h,'A0O9')
    call UnitAddAbility(h,'A0O8')
    call UnitRemoveAbility(h,'A0O8')
    call UnitAddAbility(h,'A0O7')
    call UnitRemoveAbility(h,'A0O7')
    call UnitAddAbility(h, 'A0O6')
    call UnitRemoveAbility(h,'A0O6')    
    
    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Byakuren takes nothing returns nothing
    set gg_trg_Initial_Byakuren = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Byakuren, function Trig_Initial_Byakuren_Actions )
endfunction

//===========================================================================
// Trigger: Twei01
//===========================================================================
function Trig_Twei01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0N2'
endfunction

function Trig_Twei01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local item fakeitem = LoadItemHandle(udg_ht,task,1)
    local integer i = LoadInteger(udg_ht,task,2)
    local integer l = LoadInteger(udg_ht,task,3)
    local lightning e = LoadLightningHandle(udg_ht,task,4)
    local real itemx = GetItemX(fakeitem)
    local real itemy = GetItemY(fakeitem)
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local group g
    local unit v
    local unit u

    call SaveInteger(udg_ht,task,2,i - 1)
    if l > 0 then
       call SaveInteger(udg_ht,task,3,l - 1)
    endif

    set g = CreateGroup()
    call GroupEnumUnitsInRange(g,itemx,itemy,125.0,iff)
    if i > 0 then
        if l <= 0 then
            loop
                set v = FirstOfGroup(g)
                exitwhen v == null
                call GroupRemoveUnit(g,v)
                if IsUnitAliveBJ(v) and IsUnitType(v,UNIT_TYPE_HERO) and IsUnitAlly(v,GetOwningPlayer(caster))==false then
                    set i = 0
                endif
            endloop
        endif
        if GetItemLifeBJ(fakeitem) == 0.00 then
            set i = 0
        endif
    endif

    if i <= 0 and l <= 0 then
        call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl",itemx,itemy))

        call GroupEnumUnitsInRange(g,itemx,itemy,260.0,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitAliveBJ(v) and IsUnitAlly(v,GetOwningPlayer(caster))==false then
                set u = CreateUnit(GetOwningPlayer(caster),'n02O',itemx,itemy,0)
                call UnitAddAbility(u,'A0N8')
                call SetUnitAbilityLevel(u,'A0N8',GetUnitAbilityLevel(caster,'A0N2'))
                call IssueTargetOrder(u,"thunderbolt",v)
            endif
        endloop

        call RemoveItem(fakeitem)
        call DestroyLightning(e)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    elseif i <= 0 and l > 0 then
        call RemoveItem(fakeitem)
        call DestroyLightning(e)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task) 
    endif

    set t = null
    set caster = null
    set fakeitem = null
    set e = null
    set iff = null
    set g = null
    set v = null
    set u = null
endfunction

function Trig_Twei01_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local item fakeitem
    local integer fakeitemtype
    local real itemx
    local real itemy
    local real itemz1
    local real itemz2
    local lightning e
    local integer a
    local real k
    //========
    local real abilitycooldownlv01 = 10
    local real abilitycooldownlv02 = 10
    local real abilitycooldownlv03 = 10
    local real abilitycooldownlv04 = 10
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========

    set a = GetRandomInt(1,100)
    if a <= 45 then
        set fakeitemtype = 'I054'
    elseif a <= 90 then
        set fakeitemtype = 'I055'
    elseif a <= 99 then
        set fakeitemtype = 'I059'
    elseif a <= 100 then
        set a = GetRandomInt(1,22)
        if a <= 1 then
            set fakeitemtype = 'I05N'
        elseif a <= 2 then
            set fakeitemtype = 'I05M'
        elseif a <= 3 then
            set fakeitemtype = 'I05L'
        elseif a <= 4 then
            set fakeitemtype = 'I05K'
        elseif a <= 5 then
            set fakeitemtype = 'I05J'
        elseif a <= 6 then
            set fakeitemtype = 'I05I'
        elseif a <= 7 then
            set fakeitemtype = 'I05H'
        elseif a <= 8 then
            set fakeitemtype = 'I05G'
        elseif a <= 9 then
            set fakeitemtype = 'I05F'
        elseif a <= 10 then
            set fakeitemtype = 'I05E'
        elseif a <= 11 then
            set fakeitemtype = 'I05D'
        elseif a <= 12 then
            set fakeitemtype = 'I05C'
        elseif a <= 13 then
            set fakeitemtype = 'I056'
        elseif a <= 14 then
            set fakeitemtype = 'I058'
        elseif a <= 15 then
            set fakeitemtype = 'I057'
        elseif a <= 16 then
            set fakeitemtype = 'I05A'
        elseif a <= 17 then
            set fakeitemtype = 'I05O'
        elseif a <= 18 then
            set fakeitemtype = 'I05P'
        elseif a <= 19 then
            set fakeitemtype = 'I05Q'
        elseif a <= 20 then
            set fakeitemtype = 'I053'
        elseif a <= 21 then
            set fakeitemtype = 'I05R'
        elseif a <= 22 then
            set fakeitemtype = 'I05S'
        endif
    endif


    set k = GetRandomInt(0,360)
    set itemx = GetUnitX(caster)+50*CosBJ(k)
    set itemy = GetUnitY(caster)+50*SinBJ(k)
    set fakeitem = CreateItem(fakeitemtype,itemx,itemy)

    set itemz1 = GetPositionZ(itemx,itemy) + 0.0
    set itemz2 = GetPositionZ(itemx,itemy) + 200.0
    set e = AddLightningEx("TCLE",false,itemx,itemy,itemz1,itemx,itemy,itemz2)
    if IsUnitAlly(caster,GetLocalPlayer()) then                        
        call SetLightningColor(e,1.0,0.0,0.0,1.0)
    else
        call SetLightningColor(e,0.0,0.0,0.0,0.0)
    endif
    
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveItemHandle(udg_ht,task,1,fakeitem)
    call SaveInteger(udg_ht,task,2,900)
    call SaveInteger(udg_ht,task,3,10)
    call SaveLightningHandle(udg_ht,task,4,e)
    call TimerStart(t,0.20,true,function Trig_Twei01_Main)

    set t = null
    set caster = null
    set fakeitem = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Twei01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Twei01 Death
//===========================================================================
function Trig_Twei01_Death_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real x = GetUnitX(caster)
    local real y = GetUnitY(caster)
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local group g = CreateGroup()
    local unit v
    local unit u
    if GetUnitAbilityLevel(caster,'A0N2') != 0 then
        call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Other\\NeutralBuildingExplosion\\NeutralBuildingExplosion.mdl",x,y))
        call GroupEnumUnitsInRange(g,x,y,260.0,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitAliveBJ(v) and IsUnitAlly(v,GetOwningPlayer(caster))==false then
                set u = CreateUnit(GetOwningPlayer(caster),'n02O',x,y,0)
                call UnitAddAbility(u,'A0N8')
                call SetUnitAbilityLevel(u,'A0N8',GetUnitAbilityLevel(caster,'A0N2'))
                call IssueTargetOrder(u,"thunderbolt",v)
            endif
        endloop        
    endif
    set caster = null
    set iff = null
    set g = null
    set v = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Twei01_Death takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Twei02
//===========================================================================
function Trig_Twei02_Conditions takes nothing returns boolean
    if GetUnitTypeId(GetEventDamageSource()) != 'O00N' then
        return false
    endif
    if GetEventDamage() != 0.00 then
        return false
    endif
    if GetUnitAbilityLevel(GetTriggerUnit(),'B05C')==0 then
        return false
    endif
    call UnitRemoveAbility(GetTriggerUnit(),'B05C')
    return true
endfunction

function Trig_Twei02_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit target = LoadUnitHandle(udg_ht,task,0)
    call UnitRemoveAbility(target,'A08E')
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set target = null
endfunction

function Trig_Twei02_Actions takes nothing returns nothing
    local timer t 
    local integer task
    local unit caster = GetEventDamageSource()
    local unit target = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster, 'A0N3')
    local real a = AngleBetweenUnits(caster,target)
    local real b = GetUnitFacing(target)
    local real x1 = GetUnitX(caster)
    local real x2 = GetUnitX(target)
    local real y1 = GetUnitY(caster)
    local real y2 = GetUnitY(target)
    local real dis = SquareRoot((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))
    local real damage = GetUnitState(target,UNIT_STATE_MAX_LIFE) * RMinBJ(dis,680)/600 * (level * 0.015)
    local integer r
    local unit u = CreateUnit(GetOwningPlayer(caster),'n001',x2,y2,0)
    if GetUnitAbilityLevel(caster,'A08E') == 0 and GetUnitAbilityLevel(caster,'A0N4') != 0 then
        call UnitAddAbility(target,'A08E')
        call SetUnitAbilityLevel(target,'A08E',GetUnitAbilityLevel(caster,'A0N4'))
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,target)
        call TimerStart(t,1,false,function Trig_Twei02_Clear)      
    endif
    call DebugMsg(R2S(damage))
    set a = RAbsBJ(YawError(a,b))
    set r = GetRandomInt(0,100)
    if a <= 45.00 then
        set r = r - 10
    endif
    if r <= 10 then
        call UnitAddAbility(u,'A0NA')
        call IssueTargetOrder(u,"thunderbolt",target)
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Demon\\DemonBoltImpact\\DemonBoltImpact.mdl",GetUnitX(target),GetUnitY(target)))
        set damage = damage * 2.0
        call DebugMsg(R2S(damage))
    endif
    call UnitDamageTarget(caster,target,0.01,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
    call UnitDamageTargetHJ(u,target,damage,1)
    set caster = null
    set target = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Twei02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Twei03
//===========================================================================
function Trig_Twei03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0N4'
endfunction

function Trig_Twei03_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    call AddUnitAnimationProperties(caster,"alternate",false)
    set udg_SK_Twei03_Iff = udg_SK_Twei03_Iff - 1
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set caster = null
endfunction

function Trig_Twei03_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0N4')
    //========
    local real abilitycooldownlv01 = 15
    local real abilitycooldownlv02 = 15
    local real abilitycooldownlv03 = 15
    local real abilitycooldownlv04 = 15
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call AddUnitAnimationProperties(caster,"alternate",true)
    set udg_SK_Twei03_Iff = udg_SK_Twei03_Iff + 1
    call SaveUnitHandle(udg_ht,task,0,caster)
    call TimerStart(t,level*1.5,false,function Trig_Twei03_Clear)
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Twei03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Twei03 Damage
//===========================================================================
function Trig_Twei03_Damage_Conditions takes nothing returns boolean
    if GetUnitTypeId(GetEventDamageSource()) != 'O00N' then
        return false
    endif
    if udg_SK_Twei03_Iff == 0 then
        return false
    endif
    if udg_SK_Twei03_Moving == true then
        return false
    endif
    return GetEventDamage()>0.00
endfunction

function Trig_Twei03_Damage_Move takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local real a = LoadReal(udg_ht,task,1)
    local real d = LoadReal(udg_ht,task,2)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real rx = ox + 13 * CosBJ(a)
    local real ry = oy + 13 * SinBJ(a)
    if d > 0 and IsTerrainPathable(rx,ry,PATHING_TYPE_WALKABILITY) == false then
        call SetUnitXYGround(caster,rx,ry)
        call SaveReal(udg_ht,task,2,d - 13)
    else
        set udg_SK_Twei03_Moving = false
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
endfunction

function Trig_Twei03_Damage_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetEventDamageSource()
    local unit target = GetTriggerUnit()
    local real a
    local real d
    local real x1 = GetUnitX(caster)
    local real x2 = GetUnitX(target)
    local real y1 = GetUnitY(caster)
    local real y2 = GetUnitY(target)
    local real dis = SquareRoot((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))
    set d = (630 - dis)*0.50
    set a = AngleBetween(caster,target) + 180.00
    if a > 360.0 then
        set a = a - 360.00
    endif
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\AncientProtectorMissile\\AncientProtectorMissile.mdl",x1,y1))
    set udg_SK_Twei03_Moving = true
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveReal(udg_ht,task,1,a)
    call SaveReal(udg_ht,task,2,d)
    call TimerStart(t,0.02,true,function Trig_Twei03_Damage_Move)
    set t = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Twei03_Damage takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Twei04
//===========================================================================
function Trig_Twei04_Conditions takes nothing returns boolean
    if GetUnitAbilityLevel(udg_SK_Twei04_Twei,'A0N5') == 0 then
        return false
    endif
    if GetEventDamage()<=10.00 then
        return false
    endif
    return GetRandomInt(0,100) <= 40
endfunction

function Trig_Twei04_Actions takes nothing returns nothing
    local unit caster = GetEventDamageSource()
    local unit target = GetTriggerUnit()
    local unit casterhero = GetPlayerCharacter(GetOwningPlayer(caster))
    local integer level = GetUnitAbilityLevel(udg_SK_Twei04_Twei,'A0N5')
    local real damage = GetEventDamage() * 0.133 * level
    local unit u 
    if GetUnitAbilityLevel(casterhero,'B058') >= 1 then
        set u = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0)
        call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Orc\\Disenchant\\DisenchantSpecialArt.mdl",GetUnitX(target),GetUnitY(target)))
        call UnitDamageTargetHJ(u,target,damage,2)
        call DebugMsg("ExtraDamage:" + R2S(damage))
    endif
    if GetUnitAbilityLevel(target,'B058') >= 1 then
        if GetEventDamage() < GetUnitState(target,UNIT_STATE_LIFE) then
            call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\VampiricAura\\VampiricAuraTarget.mdl",GetUnitX(target),GetUnitY(target)))
            call SetUnitState(target,UNIT_STATE_LIFE,GetUnitState(target,UNIT_STATE_LIFE)+damage)
            call DebugMsg("Healing:" + R2S(damage))
        else
            call DebugMsg("Healing:DeathFail")
        endif
    endif
    set caster = null
    set target = null
    set casterhero = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Twei04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Init Twei
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Init_Twei_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('O00N')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set udg_SK_Twei03_Iff = 0
    set udg_SK_Twei03_Moving = false
    set udg_SK_Twei04_Twei = h
    
    set gg_trg_Twei01_Death = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Twei01_Death, h, EVENT_UNIT_DEATH )
    call TriggerAddAction( gg_trg_Twei01_Death, function Trig_Twei01_Death_Actions )

    set gg_trg_Twei01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Twei01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Twei01, Condition( function Trig_Twei01_Conditions))
    call TriggerAddAction( gg_trg_Twei01, function Trig_Twei01_Actions )

    set gg_trg_Twei02 = CreateTrigger()
    call RegisterAnyUnitDamage(gg_trg_Twei02)
    call TriggerAddCondition( gg_trg_Twei02, Condition( function Trig_Twei02_Conditions ) )
    call TriggerAddAction( gg_trg_Twei02, function Trig_Twei02_Actions )

    set gg_trg_Twei03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Twei03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Twei03, Condition( function Trig_Twei03_Conditions ) )
    call TriggerAddAction( gg_trg_Twei03, function Trig_Twei03_Actions )

    set gg_trg_Twei03_Damage = CreateTrigger()
    call RegisterAnyUnitDamage(gg_trg_Twei03_Damage)
    call TriggerAddCondition( gg_trg_Twei03_Damage, Condition( function Trig_Twei03_Damage_Conditions ) )
    call TriggerAddAction( gg_trg_Twei03_Damage, function Trig_Twei03_Damage_Actions )

    set gg_trg_Twei04 = CreateTrigger()
    call RegisterAnyUnitDamage(gg_trg_Twei04)
    call TriggerAddCondition( gg_trg_Twei04, Condition( function Trig_Twei04_Conditions ) )
    call TriggerAddAction( gg_trg_Twei04, function Trig_Twei04_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Twei takes nothing returns nothing
    set gg_trg_Init_Twei = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Twei, function Trig_Init_Twei_Actions )
endfunction

//===========================================================================
// Trigger: KoakumaLibrary
//===========================================================================
function Trig_KoakumaLibrary_Actions takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA) + (1 - GetUnitState(caster,UNIT_STATE_MANA)/GetUnitState(caster,UNIT_STATE_MAX_MANA))*5.00)
    call DebugMsg(R2S((1 - GetUnitState(caster,UNIT_STATE_MANA)/GetUnitState(caster,UNIT_STATE_MAX_MANA))*4.00))
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_KoakumaLibrary takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Koakuma
//
// Koakuma01
// Koakuma02
// Koakuma03
// Koakuma04
//===========================================================================
function Trig_Koakuma_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0MT' or GetSpellAbilityId() == 'A0NH'
endfunction

function Trig_Koakuma_Target takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(LoadUnitHandle(udg_ht,GetHandleId(GetExpiredTimer()),0))) then
        return false
    endif
    if LoadUnitHandle(udg_ht,GetHandleId(GetExpiredTimer()),1) == GetFilterUnit() then
        return false
    endif
    if IsUnitAliveBJ(GetFilterUnit()) != true then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_MECHANICAL) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function Trig_Koakuma_Target2 takes nothing returns boolean
    if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(LoadUnitHandle(udg_ht,GetHandleId(GetExpiredTimer()),0))) then
        return false
    endif
    if LoadUnitHandle(udg_ht,GetHandleId(GetExpiredTimer()),1) == GetFilterUnit() then
        return false
    endif
    if IsUnitAliveBJ(GetFilterUnit()) != true then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return IsUnitType(GetFilterUnit(),UNIT_TYPE_HERO)
endfunction

function Trig_Koakuma_Target3 takes nothing returns boolean
    if LoadUnitHandle(udg_ht,GetHandleId(GetExpiredTimer()),1) == GetFilterUnit() then
        return false
    endif
    return GetUnitTypeId(GetFilterUnit()) == 'E01E'
endfunction

function Trig_Koakuma02_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit target = LoadUnitHandle(udg_ht,task,0)
    if GetUnitAbilityLevel(target,'A0NO') > 0 then
        call UnitRemoveAbility(target,'A0NO')
    endif
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set target = null
endfunction

function Trig_Koakuma02_StartTimer takes unit target returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    call SaveUnitHandle(udg_ht,task,0,target)
    call TimerStart(t,4.00,false,function Trig_Koakuma02_Clear)
    set t = null
    set target = null
endfunction

function Trig_Koakuma_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local unit u = LoadUnitHandle(udg_ht,task,2)
    local unit v
    local unit w
    local integer sktype = LoadInteger(udg_ht,task,3)
    local integer sklevel = LoadInteger(udg_ht,task,4)
    local integer jumpi = LoadInteger(udg_ht,task,5)
    local integer kmlevel = LoadInteger(udg_ht,task,6)
    local boolean kmswitch = LoadBoolean(udg_ht,task,7)
    local integer jumptimes = LoadInteger(udg_ht,task,8)
    local real jumpdeplz
    local real kmswitchincre
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local real px 
    local real py 
    local real a = Atan2(ty-oy,tx-ox)
    local group g
    local boolexpr iff
    local boolexpr iff2
    local boolexpr iff3
    local boolean k = false
    if target == null then
        call KillUnit(u)
        call RemoveUnit(u)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
        set t = null
        set caster = null
        set target = null
        set u = null
        set v = null
        set w = null
        set g = null
        set iff = null
        set iff2 = null
        set iff3 = null
        return
    endif
    set px = ox + 16.0*Cos(a)
    set py = oy + 16.0*Sin(a)
    call SetUnitXY(u,px,py)
    call SetUnitFacing(u,bj_RADTODEG*a)
    if SquareRoot((ox-tx)*(ox-tx)+(oy-ty)*(oy-ty)) < 20.00 then
        if jumptimes == 0 then
            set jumpdeplz = 1.00
        elseif jumptimes == 1 then
            set jumpdeplz = 0.95
        elseif jumptimes == 2 then
            set jumpdeplz = 0.90
        elseif jumptimes == 3 then
            set jumpdeplz = 0.86
        elseif jumptimes == 4 then
            set jumpdeplz = 0.81
        elseif jumptimes == 5 then
            set jumpdeplz = 0.77
        elseif jumptimes == 6 then
            set jumpdeplz = 0.74
        endif
        if kmswitch == true then
            set kmswitchincre = 1.00 + 0.10 * kmlevel
        else
            set kmswitchincre = 1.00
        endif
        if sktype == 'A0MT' and IsUnitAlly(caster,GetOwningPlayer(target)) == false then
            call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\FragmentationShards\\FragBoomSpawn.mdl",GetUnitX(target),GetUnitY(target)))
            call UnitDamageTarget(caster,target,(60+35*sklevel)*jumpdeplz*kmswitchincre,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
            if kmswitch == true then
                set iff = Filter(function Trig_Koakuma_Target)
                set g = CreateGroup()
                call GroupEnumUnitsInRange(g,tx,ty,225.0+25*kmlevel,iff)
                loop
                    set v = FirstOfGroup(g)
                    exitwhen v == null
                    call GroupRemoveUnit(g,v)
                    call DestroyEffect(AddSpecialEffect("Objects\\Spawnmodels\\Human\\FragmentationShards\\FragBoomSpawn.mdl",GetUnitX(v),GetUnitY(v)))
                    call UnitDamageTarget(caster,v,((75+35*sklevel)*(0.25*(1+kmlevel)))*jumpdeplz*kmswitchincre,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
                endloop
                call DestroyGroup(g)
            endif
        endif
        if sktype == 'A0NH' and IsUnitAlly(caster,GetOwningPlayer(target)) == false then
            call UnitDamageTarget(caster,target,(25+15*sklevel)*jumpdeplz*kmswitchincre,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
            if GetUnitAbilityLevel(target,'A0NO') == 0 then
                call UnitAddAbility(target,'A0NO')
                call SetUnitAbilityLevel(target,'A0NO',sklevel)
            else
                call SetUnitAbilityLevel(target,'A0NO',GetUnitAbilityLevel(target,'A0NO') + sklevel)
            endif
            set w = CreateUnit(GetOwningPlayer(caster),'n001',tx,ty,0)
            call UnitAddAbility(w,'A0NK')
            call SetUnitAbilityLevel(w,'A0NK',GetUnitAbilityLevel(target,'A0NO'))
            call IssueTargetOrder(w,"slow",target)
            call Trig_Koakuma02_StartTimer(target)
            if kmswitch == true then
                set iff = Filter(function Trig_Koakuma_Target)
                set g = CreateGroup()
                call GroupEnumUnitsInRange(g,tx,ty,225.0+25*kmlevel,iff)
                loop
                    set v = FirstOfGroup(g)
                    exitwhen v == null
                    call GroupRemoveUnit(g,v)
                    call UnitDamageTarget(caster,v,((25+15*sklevel)*(0.25*(1+kmlevel)))*jumpdeplz*kmswitchincre,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
                    if GetUnitAbilityLevel(v,'A0NO') == 0 then
                        call UnitAddAbility(v,'A0NO')
                        call SetUnitAbilityLevel(v,'A0NO',R2I(sklevel*(0.25*(1+kmlevel))*jumpdeplz))
                    else
                        call SetUnitAbilityLevel(v,'A0NO',GetUnitAbilityLevel(v,'A0NO') + R2I(sklevel*(0.25*(1+kmlevel))*jumpdeplz))
                    endif
                    set w = CreateUnit(GetOwningPlayer(caster),'n001',tx,ty,0)
                    call UnitAddAbility(w,'A0NO')
                    call SetUnitAbilityLevel(w,'A0NO',GetUnitAbilityLevel(v,'A0NO'))
                    call IssueTargetOrder(w,"slow",target)
                    call Trig_Koakuma02_StartTimer(v)
                endloop
                call DestroyGroup(g)
            endif
        endif
        if jumpi > 0 then
            set g = CreateGroup()
            set iff2 = Filter(function Trig_Koakuma_Target2)
            call GroupEnumUnitsInRange(g,tx,ty,500.0,iff2)
            set v = FirstOfGroup(g)
            if v != null then
                set k = true
                set target = GroupPickRandomUnit(g)
            else
                call DestroyGroup(g)
                set g = CreateGroup()
                set iff = Filter(function Trig_Koakuma_Target)
                call GroupEnumUnitsInRange(g,tx,ty,500.0,iff)
                set v = FirstOfGroup(g)
                if v != null then
                    set target = GroupPickRandomUnit(g)
                    call DestroyGroup(g)
                    set k = true
                else
                    call DestroyGroup(g)
                    set g = CreateGroup()
                    set iff3 = Filter(function Trig_Koakuma_Target3)
                    call GroupEnumUnitsInRange(g,tx,ty,500.0,iff3)
                    set v = FirstOfGroup(g)
                    if v != null then
                        set target = GroupPickRandomUnit(g)
                        call DestroyGroup(g)
                        set k = true
                    else
                        call DestroyGroup(g)
                        set k = false
                    endif
                endif
            endif
            if k == true then
                set jumpi = jumpi - 1
            else 
                set jumpi = 0
            endif
            call SaveUnitHandle(udg_ht,task,1,target)
            call SaveInteger(udg_ht,task,5,jumpi)
            call SaveInteger(udg_ht,task,8,jumptimes + 1)
        endif
        if k == false then
            call KillUnit(u)
            call RemoveUnit(u)
            call PauseTimer(t)
            call DestroyTimer(t)
            call FlushChildHashtable(udg_ht,task)
        endif
    endif
    set t = null
    set caster = null
    set target = null
    set u = null
    set v = null
    set w = null
    set g = null
    set iff = null
    set iff2 = null
    set iff3 = null
endfunction

function Trig_Koakuma_Actions takes nothing returns nothing
    local timer t
    local integer task
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit u
    local integer sktype = GetSpellAbilityId()
    local integer uttype
    local integer sklevel = GetUnitAbilityLevel(caster,sktype)
    local integer lslevel = GetUnitAbilityLevel(caster,'A0NJ')
    local integer kmlevel = GetUnitAbilityLevel(caster,'A0NI')
    local integer jumpi
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local real a = Atan2(ty-oy,tx-ox)
    local boolean kmswitch = GetUnitAbilityLevel(caster,'B05B') > 0
    //========
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetSpellAbilityId() == 'A0MT' then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),8)
        elseif GetSpellAbilityId() == 'A0NH' then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),10)
        endif
    endif
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set t = null
            set caster = null
            set target = null
            set u = null
            return
        endif
    endif
    //======== 
    set t = CreateTimer()
    set task = GetHandleId(t)
    if sktype == 'A0MT' then
        set uttype = 'e01F'
    else
        set uttype = 'e01G'
    endif
    set jumpi = 2 + lslevel
    set u = CreateUnit(GetOwningPlayer(caster),uttype,ox,oy,bj_RADTODEG*a)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveUnitHandle(udg_ht,task,2,u)
    call SaveInteger(udg_ht,task,3,sktype)
    call SaveInteger(udg_ht,task,4,sklevel)
    call SaveInteger(udg_ht,task,5,jumpi)
    call SaveInteger(udg_ht,task,6,kmlevel)
    call SaveBoolean(udg_ht,task,7,kmswitch)
    call SaveInteger(udg_ht,task,8,0)
    call TimerStart(t,0.02,true,function Trig_Koakuma_Main)
    set t = null
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Koakuma takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Koakuma04 Effect
//===========================================================================
function Trig_Koakuma04_Effect_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0NI'
endfunction

function Trig_Koakuma04_Effect_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    if GetUnitAbilityLevel(caster,'B05B') > 0 then
        call SetUnitXY(u,GetUnitX(caster),GetUnitY(caster))
    else
        call KillUnit(u)
        call RemoveUnit(u)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set u = null
endfunction

function Trig_Koakuma04_Effect_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local unit u
    local integer level = GetUnitAbilityLevel(caster,'A0NI')
    //========
    local real abilitycooldownlv01 = 85
    local real abilitycooldownlv02 = 85
    local real abilitycooldownlv03 = 85
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    set u = CreateUnit(GetOwningPlayer(caster),'e01H',GetUnitX(caster),GetUnitY(caster),0)
    call SetUnitPathing(u,false)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call TimerStart(t,0.02,true,function Trig_Koakuma04_Effect_Main)
    set t = null
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Koakuma04_Effect takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Init Koakuma
//===========================================================================
function Trig_Init_Koakuma_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E01E')

    local timer t = CreateTimer()
    local integer task = GetHandleId(t)

    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    //gg_trg_KoakumaLibrary
    call SaveUnitHandle(udg_ht,task,0,h)
    call TimerStart(t,1.00,true,function Trig_KoakumaLibrary_Actions)

    set gg_trg_Koakuma = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Koakuma, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Koakuma, Condition( function Trig_Koakuma_Conditions ) )
    call TriggerAddAction( gg_trg_Koakuma, function Trig_Koakuma_Actions )

    set gg_trg_Koakuma04_Effect = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Koakuma04_Effect, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Koakuma04_Effect, Condition( function Trig_Koakuma04_Effect_Conditions ) )
    call TriggerAddAction( gg_trg_Koakuma04_Effect, function Trig_Koakuma04_Effect_Actions )

    //Debug - Delay
    call UnitAddAbility(h,'A0NO')
    call UnitRemoveAbility(h,'A0NO')

    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Koakuma takes nothing returns nothing
    set gg_trg_Init_Koakuma = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Koakuma, function Trig_Init_Koakuma_Actions )
endfunction

//===========================================================================
// Trigger: Sunny03
//===========================================================================
function Trig_Sunny03_Conditions takes nothing returns boolean
    return GetLearnedSkill()=='A0ND'
endfunction

function Trig_Sunny03_Target takes nothing returns boolean
    if GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)<=0 then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    if IsUnitAlly(GetFilterUnit(),GetOwningPlayer(LoadUnitHandle(udg_ht,GetHandleId(GetExpiredTimer()),0))) == false then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) == true then
        return false
    endif
    return true
endfunction

function Trig_Sunny03_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local real damage
    local boolexpr f
    local group g
    local unit v
    if IsUnitAlive(caster) then
        set g = CreateGroup()
        set f = Filter(function Trig_Sunny03_Target)
        call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),500,f)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            set damage = GetUnitState(v, UNIT_STATE_MAX_LIFE) * 0.0025 * (3+GetUnitAbilityLevel(caster,'A0ND'))
            set damage = damage * 0.25
            call SetUnitState(v,UNIT_STATE_LIFE,GetUnitState(v,UNIT_STATE_LIFE)+damage)
        endloop
        call DestroyGroup(g) 
    endif
    set t = null
    set caster = null
    set f = null
    set g = null
    set v = null
endfunction

function Trig_Sunny03_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0ND') 
    if level == 1 then
        call SaveUnitHandle(udg_ht,task,0,caster)
        call TimerStart(t,0.25,true,function Trig_Sunny03_Main)
    endif
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Sunny03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Sunny04
//===========================================================================
function Trig_Sunny04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0NE'
endfunction

function Trig_Sunny04_Go takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local group m = LoadGroupHandle(udg_ht,task,2)
    local group g
    local real a = LoadReal(udg_ht,task,3)
    local integer i = LoadInteger(udg_ht,task,4)
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local real px 
    local real py 
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))

    if i>0 then
        set px = ox + 18.75*Cos(a)
        set py = oy + 18.75*Sin(a)
        if IsTerrainPathable(px,py,PATHING_TYPE_FLYABILITY)==false then
            call SetUnitXY(u,px,py)
            call SaveInteger(udg_ht,task,4,i - 1)
        else
            call SaveInteger(udg_ht,task,4,0)
        endif
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,px,py,100.0,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitAliveBJ(v) and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and IsUnitInGroup(v,m)==false then
                call GroupAddUnit(m,v)
                call UnitDamageTarget(caster,v,60.0,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
            endif
        endloop
        call DestroyGroup(g)
    else
        if IsUnitAliveBJ(u) then
            call RemoveUnit(u)
        endif
        call PauseTimer(t)
        call DestroyTimer(t)
        call DestroyGroup(m)
        call FlushChildHashtable(udg_ht,task)
    endif

    set t = null
    set caster = null
    set u = null
    set v = null
    set m = null
    set g = null
    set iff = null
endfunction

function Trig_Sunny04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)

    local timer t2
    local integer task2
    local unit u
    local real a = GetUnitFacing(caster)/bj_RADTODEG
    local group m 
    local real ox = GetUnitX(caster) + 18.75*Cos(a)
    local real oy = GetUnitY(caster) + 18.75*Sin(a)

    if i > 0 then
        set m = CreateGroup()
        set u = CreateUnit(GetOwningPlayer(caster),'e01C',ox,oy,bj_RADTODEG*a)

        set t2 = CreateTimer()
        set task2 = GetHandleId(t2)
        call SaveUnitHandle(udg_ht,task2,0,caster)
        call SaveUnitHandle(udg_ht,task2,1,u)
        call SaveGroupHandle(udg_ht,task2,2,m)
        call SaveReal(udg_ht,task2,3,a)
        call SaveInteger(udg_ht,task2,4,80)
        call TimerStart(t2,0.02,true,function Trig_Sunny04_Go)

        call SaveInteger(udg_ht,task,1,i - 1)        
    else
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set t2 = null 
    set u = null
    set m = null
endfunction

function Trig_Sunny04_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0NE')
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveInteger(udg_ht,task,1,R2I(GetHeroStr(caster,true)/8)+2+level*2)
    call TimerStart(t,0.20,true,function Trig_Sunny04_Main)
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Sunny04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Init Sunny
//===========================================================================
function Trig_Init_Sunny_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E01D')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set gg_trg_Sunny03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Sunny03, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Sunny03, Condition( function Trig_Sunny03_Conditions ) )
    call TriggerAddAction( gg_trg_Sunny03, function Trig_Sunny03_Actions )

    set gg_trg_Sunny04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Sunny04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Sunny04, Condition( function Trig_Sunny04_Conditions ) )
    call TriggerAddAction( gg_trg_Sunny04, function Trig_Sunny04_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Sunny takes nothing returns nothing
    set gg_trg_Init_Sunny = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Sunny, function Trig_Init_Sunny_Actions )
endfunction

//===========================================================================
// Trigger: Orange01
//===========================================================================
function Trig_Orange01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0NQ'
endfunction

function Trig_Orange01_Actions takes nothing returns nothing
endfunction

//===========================================================================
function InitTrig_Orange01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Init Orange
//===========================================================================
function Trig_Init_Orange_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E01I')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set gg_trg_Orange01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Orange01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Orange01, Condition( function Trig_Orange01_Conditions ) )
    call TriggerAddAction( gg_trg_Orange01, function Trig_Orange01_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Orange takes nothing returns nothing
    set gg_trg_Init_Orange = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Orange, function Trig_Init_Orange_Actions )
endfunction

//===========================================================================
// Trigger: Lunasa01
//===========================================================================
function Trig_Lunasa01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0LM'
endfunction

function Trig_Lunasa01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local unit e1 = CreateUnit(GetOwningPlayer(caster),'e01O',tx,ty,0)
    local unit w
    call SetUnitPathing(e1,false)
    call SetUnitXY(e1,tx,ty)
    if IsUnitType(target,UNIT_TYPE_HERO) == true then
        call UnitDamageTargetHJ(caster,target,50+50*level,0)
        set w = CreateUnit(GetOwningPlayer(caster),'n001',tx,ty,0)
        call UnitAddAbility(w,'A0OK')
        call SetUnitAbilityLevel(w,'A0OK',level)
        call IssueTargetOrder(w,"drunkenhaze",target)
    else
        call UnitDamageTargetHJ(caster,target,(50+50*level)*2.75,0)
    endif
    set caster = null
    set target = null
    set e1 = null
    set w = null
endfunction

//===========================================================================
function InitTrig_Lunasa01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Lunasa02
//===========================================================================
function Trig_Lunasa02_Conditions takes nothing returns boolean
    if GetUnitTypeId(GetEventDamageSource()) != 'E01N' then
        return false
    endif
    return GetEventDamage()==0.00
endfunction

function Trig_Lunasa02_Actions takes nothing returns nothing
    local unit caster = GetEventDamageSource()
    local unit target = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster, 'A0OI')
    local real damage = udg_SK_Lunasa02_Buff * 0.10
    if damage != 0 then
        call UnitDamageTargetHJ(caster,target,damage,0)
    endif
    call DebugMsg(R2S(damage))
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Lunasa02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Lunasa03
//===========================================================================
function Trig_Lunasa03_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A0OG'
endfunction

function Trig_Lunasa03_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = GetUnitAbilityLevel(caster,'A0OG')
    local real h0 = GetUnitState(caster,UNIT_STATE_LIFE)
    local real h1 = GetUnitState(caster,UNIT_STATE_MAX_LIFE)
    local real c = 26 - level * 4
    local real incres = (h0/h1)*(100/c)+1
    if R2I(incres) != GetUnitAbilityLevel(caster,'A0OL') then
        call SetUnitAbilityLevel(caster,'A0OL',R2I(incres))
        call DisplayTextToPlayer(GetOwningPlayer(caster),0,0,"|cffffcc00幻想乐章：|r" + R2S(incres*0.08) + "%")
    endif
    set t = null
    set caster = null
endfunction

function Trig_Lunasa03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t
    local integer task
    local integer level = GetUnitAbilityLevel(caster,'A0OG')
    if level==1 then
        call UnitAddAbility(caster,'A0OM')
        call SetPlayerAbilityAvailableBJ(false,'A0OM',GetOwningPlayer(caster))
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call TimerStart(t,0.1,true,function Trig_Lunasa03_Main)
    endif
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Lunasa03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Lunasa04
//
// Lunasa02 Included
//===========================================================================
function Trig_Lunasa04_Conditions takes nothing returns boolean
    if GetUnitState(GetTriggerUnit(), UNIT_STATE_MAX_LIFE) <= 200.00 then
        return false
    endif
    return GetUnitTypeId(GetPlayerCharacter(GetOwningPlayer(GetKillingUnit()))) == 'E01N'
endfunction

function Trig_Lunasa04_Actions takes nothing returns nothing
    local unit caster = GetPlayerCharacter(GetOwningPlayer(GetKillingUnit()))
    local unit target = GetTriggerUnit()
    local integer sk02level = GetUnitAbilityLevel(caster,'A0OI')
    local integer sk04level = GetUnitAbilityLevel(caster,'A0OH')
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local unit e1
    local real damage 
    local unit v
    local group g
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    if sk02level != 0 then
        set udg_SK_Lunasa02_Buff = udg_SK_Lunasa02_Buff + sk02level
        call DisplayTextToPlayer(GetOwningPlayer(caster),0,0,"|cffffccff忧郁伤害：|r" + R2S(udg_SK_Lunasa02_Buff*0.10))
    endif
    if sk04level != 0 then
        set damage = 100 + 50*sk04level
        set e1 = CreateUnit(GetOwningPlayer(caster),'e01Q',tx,ty,GetRandomInt(0,360))
        call SetUnitPathing(e1,false)
        call SetUnitXY(e1,tx,ty)
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,tx,ty,250,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
                call UnitDamageTargetHJ(caster,v,damage,0)
            endif
        endloop
    endif
    set caster = null
    set target = null
    set e1 = null
    set v = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_Lunasa04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Init Lunasa
//===========================================================================
function Trig_Init_Lunasa_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E01N')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set udg_SK_Lunasa02_Buff = 0

    set gg_trg_Lunasa01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Lunasa01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Lunasa01, Condition( function Trig_Lunasa01_Conditions))
    call TriggerAddAction( gg_trg_Lunasa01, function Trig_Lunasa01_Actions )

    set gg_trg_Lunasa02 = CreateTrigger()
    call RegisterAnyUnitDamage(gg_trg_Lunasa02)
    call TriggerAddCondition( gg_trg_Lunasa02, Condition( function Trig_Lunasa02_Conditions ) )
    call TriggerAddAction( gg_trg_Lunasa02, function Trig_Lunasa02_Actions )

    set gg_trg_Lunasa03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Lunasa03, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Lunasa03, Condition( function Trig_Lunasa03_Conditions ) )
    call TriggerAddAction( gg_trg_Lunasa03, function Trig_Lunasa03_Actions )

    set gg_trg_Lunasa04 = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Lunasa04, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_Lunasa04, Condition( function Trig_Lunasa04_Conditions ) )
    call TriggerAddAction( gg_trg_Lunasa04, function Trig_Lunasa04_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Lunasa takes nothing returns nothing
    set gg_trg_Init_Lunasa = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Lunasa, function Trig_Init_Lunasa_Actions )
endfunction

//===========================================================================
// Trigger: MerlinAttack
//===========================================================================
//TESH.scrollpos=24
//TESH.alwaysfold=0
function Trig_MerlinAttack_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetAttacker()) == 'E01W'
endfunction

function Trig_MerlinAttack_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        //call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        //call DestroyTrigger(trg)
        //call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        return
    endif
    set target = GetTriggerUnit()
    //========
    call DisableTrigger(trg)
    //========
    if udg_SK_MerlinEx_Count < 4 then
        set udg_SK_MerlinEx_Count = udg_SK_MerlinEx_Count + 1
        call PlaySoundOnUnitBJ(gg_snd_TrumpetChorusA_u,100,caster)
    else
        set udg_SK_MerlinEx_Count = 1
        call PlaySoundOnUnitBJ(gg_snd_TrumpetChorusD,100,caster)
        call UnitDamageTargetHJ(caster,target,GetUnitState(caster,UNIT_STATE_MAX_LIFE)*0.04,0)
    endif
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
endfunction

function Trig_MerlinAttack_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_MerlinAttack_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_MerlinAttack takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: MerlinEx
//
// Lunasa02 Included
//===========================================================================
function Trig_MerlinEx_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetPlayerCharacter(GetOwningPlayer(GetKillingUnit()))) == 'E01W'
endfunction

function Trig_MerlinEx_Actions takes nothing returns nothing
    local unit caster = GetPlayerCharacter(GetOwningPlayer(GetKillingUnit()))
    local unit target = GetTriggerUnit()
    call UnitAddAbility(caster,'A0S0')
    call SetUnitAbilityLevel(caster,'A0S0',2)
    call UnitRemoveAbility(caster,'A0S0')
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_MerlinEx takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Merlin01
//===========================================================================
//TESH.scrollpos=58
//TESH.alwaysfold=0
function Trig_Merlin01_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0O3'
endfunction

function Trig_Merlin01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local integer i = LoadInteger(udg_ht,task,2)
    local effect e2 = LoadEffectHandle(udg_ht,task,3)
    if i > 0 and IsUnitType(caster,UNIT_TYPE_DEAD) == false and IsUnitType(target,UNIT_TYPE_DEAD) == false then
        call IssueTargetOrderById(target,851983,caster)
        set i = i - 1
        call SaveInteger(udg_ht,task,2,i)
    else
        call DestroyEffect(e2)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set target = null
    set e2 = null
endfunction

function Trig_Merlin01_Actions takes nothing returns nothing
    local timer t
    local integer task
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local unit e1
    local effect e2
    //========
    local real abilitycooldownlv01 = 10.0
    local real abilitycooldownlv02 = 10.0
    local real abilitycooldownlv03 = 10.0
    local real abilitycooldownlv04 = 10.0
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set t = null
            set caster = null
            set target = null
            set e1 = null 
            set e2 = null
            return
        endif
    endif
    //========
    call PlaySoundOnUnitBJ(gg_snd_TrumpetChorus_01,100,caster)
    set e1 = CreateUnit(GetOwningPlayer(caster),'e01O',tx,ty,0)
    call SetUnitPathing(e1,false)
    call SetUnitXY(e1,tx,ty)
    call SetUnitVertexColor(e1,255,155,255,255)
    set e2 = AddSpecialEffectTarget("Abilities\\Spells\\Undead\\Cripple\\CrippleTarget.mdl",target,"head")
    if IsUnitType(target,UNIT_TYPE_HERO) == true then
        call UnitDamageTargetHJ(caster,target,50+50*level,0)
    else
        call UnitDamageTargetHJ(caster,target,(50+50*level)*3.00,0)
    endif
    set t = CreateTimer()
    set task = GetHandleId(t)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveInteger(udg_ht,task,2,6+level*4)
    call SaveEffectHandle(udg_ht,task,3,e2)
    call TimerStart(t,0.10,true,function Trig_Merlin01_Main)
    set t = null
    set e1 = null
    set e2 = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Merlin01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Merlin02
//===========================================================================
//TESH.scrollpos=48
//TESH.alwaysfold=0
function Trig_Merlin02_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0RS'
endfunction

function Trig_Merlin02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit target = LoadUnitHandle(udg_ht,task,0)
    call SetUnitVertexColor(target,255,255,255,255)
    call UnitRemoveAbility(target,'A0S1')
    if GetUnitAbilityLevel(target,'A0S7') >= 1 then
        call UnitRemoveAbility(target,'A0S7')
    elseif GetUnitAbilityLevel(target,'A0SB') >= 1 then
        call UnitRemoveAbility(target,'A0SB')
    elseif GetUnitAbilityLevel(target,'A0SC') >= 1 then
        call UnitRemoveAbility(target,'A0SC')
    elseif GetUnitAbilityLevel(target,'A0SD') >= 1 then
        call UnitRemoveAbility(target,'A0SD')
    endif
    call UnitRemoveAbility(target,'B060')
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set target = null
endfunction

function Trig_Merlin02_Actions takes nothing returns nothing
    local timer t
    local integer task
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    local real abilitycooldownlv01 = 9.0
    local real abilitycooldownlv02 = 9.0
    local real abilitycooldownlv03 = 9.0
    local real abilitycooldownlv04 = 9.0
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set t = null
            set caster = null
            set target = null
            return
        endif
    endif
    //========
    call PlaySoundOnUnitBJ(gg_snd_TrumpetChorus_02,100,caster)
    call SetUnitVertexColor(target,255,255,155,255)
    call UnitAddAbility(target,'A0S1')
    call SetUnitAbilityLevel(target,'A0S2',level)
    call SetUnitAbilityLevel(target,'A0S4',level)
    call SetUnitAbilityLevel(target,'A0SE',level)
    if level == 1 then
        call UnitAddAbility(target,'A0S7')
    elseif level == 2 then
        call UnitAddAbility(target,'A0SB')
    elseif level == 3 then
        call UnitAddAbility(target,'A0SC')
    elseif level == 4 then
        call UnitAddAbility(target,'A0SD')
    endif
    set t = CreateTimer()
    set task = GetHandleId(t)
    call SaveUnitHandle(udg_ht,task,0,target)
    call TimerStart(t,8.00,false,function Trig_Merlin02_Main)
    set t = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Merlin02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Merlin03
//===========================================================================
//TESH.scrollpos=35
//TESH.alwaysfold=0
function Trig_Merlin03_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A0RX'
endfunction

function Trig_Merlin03_Target takes nothing returns boolean
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_DEAD) then
        return false
    endif
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    return IsUnitAlly(GetFilterUnit(),GetOwningPlayer(LoadUnitHandle(udg_ht,GetHandleId(GetExpiredTimer()),0)))
endfunction

function Trig_Merlin03_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local integer level = GetUnitAbilityLevel(caster,'A0RX')
    local real h0 = GetUnitState(caster,UNIT_STATE_LIFE)
    local real h1 = GetUnitState(caster,UNIT_STATE_MAX_LIFE)
    local real c = 26 - level * 4
    local real incres = (1-(h0/h1))*(100/c)*2
    local group g
    local boolexpr iff
    local unit v
    set g = CreateGroup()
    set iff = Filter(function Trig_Merlin03_Target)
    call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),600,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        call SetUnitState(v,UNIT_STATE_LIFE,GetUnitState(v,UNIT_STATE_LIFE)+incres)
    endloop
    set t = null
    set caster = null
    set g = null
    set iff = null
    set v = null
endfunction

function Trig_Merlin03_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t
    local integer task
    local integer level = GetUnitAbilityLevel(caster,'A0RX')
    if level==1 then
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_ht,task,0,caster)
        call TimerStart(t,1.0,true,function Trig_Merlin03_Main)
    endif
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Merlin03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Merlin04
//===========================================================================
function Trig_Merlin04_Conditions takes nothing returns boolean
    return GetSpellAbilityId()=='A0RY'
endfunction

function Trig_Merlin04_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local effect e1 = LoadEffectHandle(udg_ht,task,0)
    local effect e2 = LoadEffectHandle(udg_ht,task,1)
    set udg_SK_Merlin04_Target = null
    call DestroyEffect(e1)
    call DestroyEffect(e2)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set e1 = null
    set e2 = null
endfunction

function Trig_Merlin04_Actions takes nothing returns nothing
    local timer t
    local integer task
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    local effect e1
    local effect e2
    //========
    local real abilitycooldownlv01 = 100.0
    local real abilitycooldownlv02 = 90.0
    local real abilitycooldownlv03 = 80.0
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    call PlaySoundOnUnitBJ(gg_snd_TrumpetChorus_03,100,caster)
    set udg_SK_Merlin04_Target = target
    set e1 = AddSpecialEffectTarget("musicnote_merlin02.mdX",caster,"chest")
    set e2 = AddSpecialEffectTarget("musicnote_merlin02.mdX",target,"chest")
    set t = CreateTimer()
    set task = GetHandleId(t)
    call SaveEffectHandle(udg_ht,task,0,e1)
    call SaveEffectHandle(udg_ht,task,1,e2)
    call TimerStart(t,5+level,false,function Trig_Merlin04_Clear)
    set t = null
    set caster = null
    set target = null
    set e1 = null
    set e2 = null
endfunction

//===========================================================================
function InitTrig_Merlin04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Merlin04 Damage
//===========================================================================
//TESH.scrollpos=1
//TESH.alwaysfold=0
function Trig_Merlin04_Damage_Conditions takes nothing returns boolean
    if udg_SK_Merlin04_Target == null then
        return false
    endif
    if IsUnitType(udg_SK_Merlin04_Target,UNIT_TYPE_DEAD) then
        return false
    endif
    if IsUnitType(GetPlayerCharacter(GetOwningPlayer(GetEventDamageSource())),UNIT_TYPE_HERO) == false then
        return false
    endif
    return true
endfunction

function Trig_Merlin04_Damage_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = udg_SK_Merlin04_Target
    local integer level = GetUnitAbilityLevel(caster,'A0RS')
    local real damage = GetEventDamage() * (0.60 + 0.20 * level)
    call UnitDamageTarget(caster,target,damage,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS) 
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Merlin04_Damage takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Init Merlin
//===========================================================================
//TESH.scrollpos=41
//TESH.alwaysfold=0
function Trig_Init_Merlin_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E01W')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + " 技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set udg_SK_MerlinEx_Count = 1

    set gg_trg_MerlinAttack = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_MerlinAttack, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_MerlinAttack, Condition( function Trig_MerlinAttack_Conditions ) )
    call TriggerAddAction( gg_trg_MerlinAttack, function Trig_MerlinAttack_Actions )

    set gg_trg_MerlinEx = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_MerlinEx, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_MerlinEx, Condition( function Trig_MerlinEx_Conditions ) )
    call TriggerAddAction( gg_trg_MerlinEx, function Trig_MerlinEx_Actions )

    set gg_trg_Merlin01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Merlin01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Merlin01, Condition( function Trig_Merlin01_Conditions))
    call TriggerAddAction( gg_trg_Merlin01, function Trig_Merlin01_Actions )

    set gg_trg_Merlin02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Merlin02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Merlin02, Condition( function Trig_Merlin02_Conditions))
    call TriggerAddAction( gg_trg_Merlin02, function Trig_Merlin02_Actions )

    set gg_trg_Merlin03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Merlin03, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Merlin03, Condition( function Trig_Merlin03_Conditions ) )
    call TriggerAddAction( gg_trg_Merlin03, function Trig_Merlin03_Actions )

    set gg_trg_Merlin04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Merlin04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Merlin04, Condition( function Trig_Merlin04_Conditions))
    call TriggerAddAction( gg_trg_Merlin04, function Trig_Merlin04_Actions )

    set gg_trg_Merlin04_Damage = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Merlin04_Damage, h, EVENT_UNIT_DAMAGED )
    call TriggerAddCondition( gg_trg_Merlin04_Damage, Condition( function Trig_Merlin04_Damage_Conditions))
    call TriggerAddAction( gg_trg_Merlin04_Damage, function Trig_Merlin04_Damage_Actions )

    call UnitAddAbility(h,'A0S0')
    call UnitRemoveAbility(h,'A0S0')
    call UnitAddAbility(h,'A0S1')
    call UnitRemoveAbility(h,'A0S1')
    call UnitAddAbility(h,'A0S7')
    call UnitRemoveAbility(h,'A0S7')
    call UnitAddAbility(h,'A0SB')
    call UnitRemoveAbility(h,'A0SB')
    call UnitAddAbility(h,'A0SC')
    call UnitRemoveAbility(h,'A0SC')
    call UnitAddAbility(h,'A0SD')
    call UnitRemoveAbility(h,'A0SD')

    set h = null
endfunction

//===========================================================================
function InitTrig_Init_Merlin takes nothing returns nothing
    set gg_trg_Init_Merlin = CreateTrigger()
    call TriggerAddAction( gg_trg_Init_Merlin, function Trig_Init_Merlin_Actions )
endfunction

//===========================================================================
// Trigger: ToramaruDB
//===========================================================================
function Trig_ToramaruDB_Change takes nothing returns nothing
    local unit caster = udg_SK_Toramaru
    if GetUnitAbilityLevel(caster,'A0P4') == 1 then
        call UnitRemoveAbility(caster,'A0P4')
    elseif GetUnitAbilityLevel(caster,'A0QX') == 1 then
        call UnitRemoveAbility(caster,'A0QX')
    elseif GetUnitAbilityLevel(caster,'A0QY') == 1 then
        call UnitRemoveAbility(caster,'A0QY')
    elseif GetUnitAbilityLevel(caster,'A0QZ') == 1 then
        call UnitRemoveAbility(caster,'A0QZ')
    elseif GetUnitAbilityLevel(caster,'A0R0') == 1 then
        call UnitRemoveAbility(caster,'A0R0')
    elseif GetUnitAbilityLevel(caster,'A0R1') == 1 then
        call UnitRemoveAbility(caster,'A0R1')
    elseif GetUnitAbilityLevel(caster,'A0R2') == 1 then
        call UnitRemoveAbility(caster,'A0R2')
    endif
    if udg_SK_ToramaruDB_Count == 0 then
        call UnitAddAbility(caster,'A0P4')
    elseif udg_SK_ToramaruDB_Count == 1 then
        call UnitAddAbility(caster,'A0QX')
    elseif udg_SK_ToramaruDB_Count == 2 then
        call UnitAddAbility(caster,'A0QY')
    elseif udg_SK_ToramaruDB_Count == 3 then
        call UnitAddAbility(caster,'A0QZ')
    elseif udg_SK_ToramaruDB_Count == 4 then
        call UnitAddAbility(caster,'A0R0')
    elseif udg_SK_ToramaruDB_Count == 5 then
        call UnitAddAbility(caster,'A0R1')
    elseif udg_SK_ToramaruDB_Count == 6 then
        call UnitAddAbility(caster,'A0R2')
    endif
    set caster = null
endfunction

function Trig_ToramaruDB_Actions takes nothing returns nothing
    if udg_SK_ToramaruDB_Count < 6 then
        set udg_SK_ToramaruDB_Count = udg_SK_ToramaruDB_Count + 1
        call Trig_ToramaruDB_Change()
    endif
endfunction

//===========================================================================
function InitTrig_ToramaruDB takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Toramaru01
//===========================================================================
function Trig_Toramaru01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0P2'
endfunction

function Trig_Toramaru01_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    if GetUnitAbilityLevel(caster,'A0PB') == 1 then
        call DestroyEffect(udg_SK_Toramaru01_Effect)
        set udg_SK_Toramaru01_Effect = null
        call UnitRemoveAbility(caster,'A0PB')
        call UnitRemoveAbility(caster,'B05P')
    endif
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set caster = null
endfunction

function Trig_Toramaru01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0P2')
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 14
    local real abilitycooldownlv02 = 12
    local real abilitycooldownlv03 = 10
    local real abilitycooldownlv04 = 8
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if udg_SK_ToramaruDB_Count > 0 then
        set udg_SK_ToramaruDB_Count = udg_SK_ToramaruDB_Count - 1
        call Trig_ToramaruDB_Change()
        call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_LIFE)+GetUnitState(caster,UNIT_STATE_MAX_LIFE)*0.025)
        call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA)+GetUnitState(caster,UNIT_STATE_MAX_MANA)*0.025)
    endif
    set udg_SK_Toramaru01_Effect = AddSpecialEffectTarget("toramaru_0.mdx",caster,"hand left")
    call UnitAddAbility(caster,'A0PB')
    call SetPlayerAbilityAvailableBJ( false, 'A0PB', GetOwningPlayer(caster))
    call SetUnitAbilityLevel(caster,'A0SS',level)
    call SetUnitAbilityLevel(caster,'A0ST',level)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveTimerHandle(udg_ht,task,99,t)
    call TimerStart(t,5.0,false,function Trig_Toramaru01_Clear) 
    set caster = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Toramaru01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Toramaru01 Attack
//===========================================================================
function Trig_Toramaru01_Attack_Conditions takes nothing returns boolean
    local unit attacked = GetTriggerUnit()
    local unit attacker = GetAttacker()
    if GetUnitAbilityLevel(attacker,'A0PB')<=0 then
        set attacked = null
        set attacker = null
        return false
    endif
    set attacked = null
    set attacker = null
    return true
endfunction

function Trig_Toramaru01_Attack_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local integer level
    local real damage = 0
    local effect e
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        set e = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        //call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        //call DestroyTrigger(trg)
        //call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        set e = null
        return
    endif
    set target = GetTriggerUnit()
    set level = GetUnitAbilityLevel(caster,'A0P2')
    //========
    call DisableTrigger(trg)
    //========
    call DestroyEffect(udg_SK_Toramaru01_Effect)
    set udg_SK_Toramaru01_Effect = null
    call UnitRemoveAbility(caster,'A0PB')
    call UnitRemoveAbility(caster,'B05P')
    call UnitDamageTargetHJ(caster,target,60+level*60,0)
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Human\\HolyBolt\\HolyBoltSpecialArt.mdl",GetUnitX(target),GetUnitY(target)))
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
    set e = null
endfunction

function Trig_Toramaru01_Attack_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_Toramaru01_Attack_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Toramaru01_Attack takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Toramaru02
//===========================================================================
function Trig_Toramaru02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0R3' or GetSpellAbilityId() == 'A0SU'
endfunction

function Trig_Toramaru02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local integer level = LoadInteger(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,3)
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local boolean k = false
    local group g
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    //========
    if i>0 then
        call SaveInteger(udg_ht,task,3,i-1)
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,ox,oy,120.0,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
                call UnitDamageTarget(u,v,25+level*55,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
                set k = true
            endif
        endloop
        call DestroyGroup(g)
        if k then
            call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FarseerMissile\\FarseerMissile.mdl",GetUnitX(u),GetUnitY(u)))
            call KillUnit(u)
            call PauseTimer(t)
            call DestroyTimer(t)
            call FlushChildHashtable(udg_ht,task)
        endif
    else
        call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FarseerMissile\\FarseerMissile.mdl",GetUnitX(u),GetUnitY(u)))
        call KillUnit(u)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set g = null
    set iff = null
endfunction

function Trig_Toramaru02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local integer level = GetUnitAbilityLevel(caster,'A0R3')
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 6
    local real abilitycooldownlv02 = 5
    local real abilitycooldownlv03 = 4
    local real abilitycooldownlv04 = 3
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if udg_SK_ToramaruDB_Count > 0 then
        set udg_SK_ToramaruDB_Count = udg_SK_ToramaruDB_Count - 1
        call Trig_ToramaruDB_Change()
        call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_LIFE)+GetUnitState(caster,UNIT_STATE_MAX_LIFE)*0.025)
        call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA)+GetUnitState(caster,UNIT_STATE_MAX_MANA)*0.025)
    endif
    if GetSpellAbilityId() == 'A0R3' then
        set u = CreateUnit(GetOwningPlayer(caster),'e01X',tx,ty,0)
    else
        set u = CreateUnit(GetOwningPlayer(caster),'e01P',tx,ty,0)
    endif
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,2,level)
    call SaveInteger(udg_ht,task,3,250)
    call TimerStart(t,0.04,true,function Trig_Toramaru02_Main)
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Toramaru02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Toramaru02 Learn
//===========================================================================
function Trig_Toramaru02_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A0R3'
endfunction

function Trig_Toramaru02_Learn_Actions takes nothing returns nothing
    if GetUnitAbilityLevel(GetTriggerUnit(),'A0R3') == 1 then
        call UnitAddAbility(GetTriggerUnit(),'A0SU')
        call UnitMakeAbilityPermanent(GetTriggerUnit(),true,'A0SU')
    else
        call SetUnitAbilityLevel(GetTriggerUnit(),'A0SU',GetUnitAbilityLevel(GetTriggerUnit(),'A0R3'))
    endif
endfunction

//===========================================================================
function InitTrig_Toramaru02_Learn takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Toramaru03
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Toramaru03_Conditions takes nothing returns boolean
    if IsUnitAlly(GetEventDamageSource(),GetOwningPlayer(GetTriggerUnit())) then
        return false
    endif
    if GetEventDamage() <= 0.00 then
        return false
    endif
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_DEAD) == true then
        return false
    endif
    return true
endfunction

function Trig_Toramaru03_Actions takes nothing returns nothing
    local unit caster = GetPlayerCharacter(GetOwningPlayer(GetEventDamageSource()))
    local unit target = GetTriggerUnit()
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\FaerieDragonMissile\\FaerieDragonMissile.mdl",GetUnitX(target),GetUnitY(target)))
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Toramaru03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Toramaru03 Kill
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Toramaru03_Kill_Conditions takes nothing returns boolean
    if IsUnitAlly(GetTriggerUnit(),GetOwningPlayer(GetKillingUnit())) then
        return false
    endif
    return GetUnitAbilityLevel(GetPlayerCharacter(GetOwningPlayer(GetKillingUnit())),'A0P3') != 0
endfunction

function Trig_Toramaru03_Kill_Actions takes nothing returns nothing
    local unit caster = GetPlayerCharacter(GetOwningPlayer(GetKillingUnit()))
    local unit target = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0P3')
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local unit e1 = CreateUnit(GetOwningPlayer(caster),'e01R',tx,ty,0)
    local unit v
    local unit w
    local group g = CreateGroup()
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    if udg_SK_ToramaruDB_Count < 6 then
        set udg_SK_ToramaruDB_Count = udg_SK_ToramaruDB_Count + 1
        call Trig_ToramaruDB_Change()
    endif
    call SetUnitPathing(e1,false)
    call SetUnitXY(e1,tx,ty)
    call GroupEnumUnitsInRange(g,tx,ty,250,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and target != v then
            set w = CreateUnit(GetOwningPlayer(caster),'n001',tx,ty,0)
            call UnitAddAbility(w,'A0PE')
            call SetUnitAbilityLevel(w,'A0PE',level)
            call IssueTargetOrder(w,"thunderbolt",v)
        endif
    endloop
    call SetPlayerStateBJ(GetOwningPlayer(caster),PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(GetOwningPlayer(caster),PLAYER_STATE_RESOURCE_GOLD)+(1+level)) 
    set caster = null
    set target = null
    set e1 = null
    set v = null
    set w = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_Toramaru03_Kill takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Toramaru04
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Toramaru04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0SR'
endfunction

function Trig_Toramaru04_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local group m = LoadGroupHandle(udg_ht,task,1)
    local group g
    local integer level = LoadInteger(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,3)
    local integer j
    local integer k = LoadInteger(udg_ht,task,9)
    local real a = LoadReal(udg_ht,task,4)
    local real ox = LoadReal(udg_ht,task,5)
    local real oy = LoadReal(udg_ht,task,6)
    local real tx = LoadReal(udg_ht,task,7)
    local real ty = LoadReal(udg_ht,task,8)
    local real px = 0
    local real py = 0
    local unit array u
    local unit w
    local unit v
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    if i != 100 then
        if k == 0 then
            set k = -90
        else
            set k = 90
        endif
        call SetUnitVertexColor(caster,255,255,255,255-R2I(i*2.55))
        call SetUnitXY(caster,ox + i*3*Cos(a-k/bj_RADTODEG),oy + i*3*Sin(a-k/bj_RADTODEG))
        call SaveInteger(udg_ht,task,3,i+1)
    elseif IsUnitType(caster,UNIT_TYPE_DEAD)==false and i == 100 then
        call PauseUnit(caster,false)
        call SetUnitVertexColor(caster,255,255,255,255)
        call SetUnitXY(caster,tx,ty)
        set u[0] = CreateUnit(GetOwningPlayer(caster),'e01S',tx,ty,90)
        set u[1] = CreateUnit(GetOwningPlayer(caster),'e01S',tx,ty,162)
        set u[2] = CreateUnit(GetOwningPlayer(caster),'e01S',tx,ty,234)
        set u[3] = CreateUnit(GetOwningPlayer(caster),'e01S',tx,ty,306)
        set u[4] = CreateUnit(GetOwningPlayer(caster),'e01S',tx,ty,18)
        set i = 0
        loop
            exitwhen i == 5
            set j = 2
            loop
                exitwhen j == 20
                set px = tx + j*50*Cos((i*72+90)/bj_RADTODEG)
                set py = ty + j*50*Sin((i*72+90)/bj_RADTODEG)
                set g = CreateGroup()
                call GroupEnumUnitsInRange(g,px,py,175.0,iff)
                loop
                    set v = FirstOfGroup(g)
                    exitwhen v == null
                    call GroupRemoveUnit(g,v)
                    if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false and IsUnitInGroup(v,m)==false then
                        call GroupAddUnit(m,v)
                        set w = CreateUnit(GetOwningPlayer(caster),'n001',px,py,0)
                        call UnitAddAbility(w,'A0SV')
                        call SetUnitAbilityLevel(w,'A0SV',level)
                        call IssueTargetOrder(w,"thunderbolt",v)
                    endif
                endloop
                call DestroyGroup(g)
                set j = j + 1
            endloop
            set i = i + 1
        endloop
        call PauseTimer(t)
        call DestroyTimer(t)
        call DestroyGroup(m)
        call FlushChildHashtable(udg_ht,task)
    elseif IsUnitType(caster,UNIT_TYPE_DEAD) then
        call PauseUnit(caster,false)
        call SetUnitVertexColor(caster,255,255,255,255)
        call PauseTimer(t)
        call DestroyTimer(t)
        call DestroyGroup(m)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set m = null
    set g = null
    set u[0] = null
    set u[1] = null
    set u[2] = null
    set u[3] = null
    set u[4] = null
    set w = null
    set iff = null
endfunction

function Trig_Toramaru04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = Atan2(ty-oy,tx-ox)
    local integer level = GetUnitAbilityLevel(caster,'A0SR')
    local group m = CreateGroup()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    //========
    local real abilitycooldownlv01 = 120
    local real abilitycooldownlv02 = 120
    local real abilitycooldownlv03 = 120
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    if udg_SK_ToramaruDB_Count > 0 then
        set udg_SK_ToramaruDB_Count = udg_SK_ToramaruDB_Count - 1
        call Trig_ToramaruDB_Change()
        call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_LIFE)+GetUnitState(caster,UNIT_STATE_MAX_LIFE)*0.025)
        call SetUnitState(caster,UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA)+GetUnitState(caster,UNIT_STATE_MAX_MANA)*0.025)
    endif
    call PauseUnit(caster,true)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveGroupHandle(udg_ht,task,1,m)
    call SaveInteger(udg_ht,task,2,level)
    call SaveInteger(udg_ht,task,3,0)
    call SaveReal(udg_ht,task,4,a)
    call SaveReal(udg_ht,task,5,ox)
    call SaveReal(udg_ht,task,6,oy)
    call SaveReal(udg_ht,task,7,tx)
    call SaveReal(udg_ht,task,8,ty)
    call SaveInteger(udg_ht,task,9,GetRandomInt(0,1))
    call TimerStart(t,0.01,true,function Trig_Toramaru04_Main)
    set caster = null
    set m = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Toramaru04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initial Toramaru
//===========================================================================
//TESH.scrollpos=14
//TESH.alwaysfold=0
function Trig_Initial_Toramaru_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('H01N')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + "技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set udg_SK_Toramaru = h

    call UnitAddAbility(h,'A0P4')

    set gg_trg_ToramaruDB = CreateTrigger()
    call TriggerRegisterTimerEventPeriodic( gg_trg_ToramaruDB, 12.00 )
    call TriggerAddAction( gg_trg_ToramaruDB, function Trig_ToramaruDB_Actions )

    set gg_trg_Toramaru01_Attack = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Toramaru01_Attack, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Toramaru01_Attack, Condition( function Trig_Toramaru01_Attack_Conditions ) )
    call TriggerAddAction( gg_trg_Toramaru01_Attack, function Trig_Toramaru01_Attack_Actions )

    set gg_trg_Toramaru01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Toramaru01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Toramaru01, Condition( function Trig_Toramaru01_Conditions ) )
    call TriggerAddAction( gg_trg_Toramaru01, function Trig_Toramaru01_Actions )

    set gg_trg_Toramaru02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Toramaru02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Toramaru02, Condition( function Trig_Toramaru02_Conditions ) )
    call TriggerAddAction( gg_trg_Toramaru02, function Trig_Toramaru02_Actions )

    set gg_trg_Toramaru02_Learn = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Toramaru02_Learn, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Toramaru02_Learn, Condition( function Trig_Toramaru02_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Toramaru02_Learn, function Trig_Toramaru02_Learn_Actions )

    set gg_trg_Toramaru03 = CreateTrigger()
    call RegisterAnyUnitDamage(gg_trg_Toramaru03)
    call TriggerAddCondition( gg_trg_Toramaru03, Condition( function Trig_Toramaru03_Conditions ) )
    call TriggerAddAction( gg_trg_Toramaru03, function Trig_Toramaru03_Actions )

    set gg_trg_Toramaru03_Kill = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Toramaru03_Kill, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_Toramaru03_Kill, Condition( function Trig_Toramaru03_Kill_Conditions ) )
    call TriggerAddAction( gg_trg_Toramaru03_Kill, function Trig_Toramaru03_Kill_Actions )

    set gg_trg_Toramaru04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Toramaru04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Toramaru04, Condition( function Trig_Toramaru04_Conditions ) )
    call TriggerAddAction( gg_trg_Toramaru04, function Trig_Toramaru04_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Toramaru takes nothing returns nothing
    set gg_trg_Initial_Toramaru = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Toramaru, function Trig_Initial_Toramaru_Actions )
endfunction

//===========================================================================
// Trigger: Initial Parsee
//===========================================================================
//TESH.scrollpos=14
//TESH.alwaysfold=0
function Trig_Initial_Parsee_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E01U')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + "技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set h = null
endfunction

//===========================================================================
function InitTrig_Initial_Parsee takes nothing returns nothing
    set gg_trg_Initial_Parsee = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initial_Parsee, function Trig_Initial_Parsee_Actions )
endfunction

//===========================================================================
// Trigger: KisumeDS
//===========================================================================
function Trig_KisumeDS_Conditions takes nothing returns boolean
    return IsUnitAlive(GetPlayerCharacter(GetTriggerPlayer()))
endfunction

function Trig_KisumeDS_Actions takes nothing returns nothing
    local player who = GetTriggerPlayer()
    local unit caster = GetPlayerCharacter(who)
    local integer level01 = GetUnitAbilityLevel(caster,'A0R9')
    local integer level02 = GetUnitAbilityLevel(caster,'A0RA')
    local real damage01 = 60 + 60*level01 + GetHeroAgi(caster,true) * (0.6+0.6*level01)
    local real damage02 = 50 + 50*level02 + GetHeroAgi(caster,true) * (0.5+0.5*level02)
    if level01 != 0 then
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00吊瓶「飞入井中」伤害：|r" + R2S(damage01))
    endif
    if level02 != 0 then
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00桶符「强力防护之桶」抵档：|r" + R2S(damage02))
    endif
    set who = null
    set caster = null
endfunction


//===========================================================================
function InitTrig_KisumeDS takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Kisume01
//===========================================================================
function Trig_Kisume01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0R8'
endfunction

function Trig_Kisume01_Burning takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit w = LoadUnitHandle(udg_ht,task,0)
    local unit v
    local integer i = LoadInteger(udg_ht,task,1)
    local integer level = LoadInteger(udg_ht,task,2)
    local real tx = GetUnitX(w)
    local real ty = GetUnitY(w)
    local group g
    local boolexpr iff
    if i > 0 then
        set i = i - 1
        set g = CreateGroup()
        set iff = GetPlayerFilter(GetOwningPlayer(w))
        call GroupEnumUnitsInRange(g,tx,ty,200,iff)
        loop
            set v = FirstOfGroup(g)
            exitwhen v == null
            call GroupRemoveUnit(g,v)
            if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
                call UnitDamageTarget(w,v,2+2*level,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
            endif
        endloop
        call SaveInteger(udg_ht,task,1,i)
        call DestroyGroup(g)
    else
        call KillUnit(w)
        call RemoveUnit(w)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set w = null
    set v = null
    set g = null
    set iff = null    
endfunction

function Trig_Kisume01_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    local unit v
    local unit w
    local integer level = LoadInteger(udg_ht,task,2)
    local integer i = LoadInteger(udg_ht,task,3)
    local real ox = GetUnitX(u)
    local real oy = GetUnitY(u)
    local real px 
    local real py 
    local real a = LoadReal(udg_ht,task,4)
    local real d = LoadReal(udg_ht,task,5)
    local boolean instun = LoadBoolean(udg_ht,task,6)
    local boolean k = false
    local group g
    local boolexpr iff = GetPlayerFilter(GetOwningPlayer(caster))
    local timer t2
    local integer task2
    //========
    if i>0 then
        set px = ox + d*Cos(a)
        set py = oy + d*Sin(a)
        if IsTerrainPathable(px,py,PATHING_TYPE_FLYABILITY)==false then
            call SetUnitX(u,px)
            call SetUnitY(u,py)
            call SaveInteger(udg_ht,task,3,i - 1)
        else
            call SaveInteger(udg_ht,task,3,0)
        endif
        set g = CreateGroup()
        call GroupEnumUnitsInRange(g,px,py,120.0,iff)
        set v = FirstOfGroup(g)
        if v != null then
            if IsUnitAliveBJ(v) and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
                set w = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,0)
                call UnitAddAbility(w,'A0RC')
                if instun == true then
                    call SetUnitAbilityLevel(w,'A0RC',level + 4)
                else
                    call SetUnitAbilityLevel(w,'A0RC',level)
                endif
                call IssueTargetOrder(w,"thunderbolt",v)
                set k = true
            endif
        endif
        call DestroyGroup(g)
        if k then
            set t2 = CreateTimer()
            set task2 = GetHandleId(t2)
            set w = CreateUnit(GetOwningPlayer(caster),'n03F',ox,oy,0)
            call SaveUnitHandle(udg_ht,task2,0,w)
            call SaveInteger(udg_ht,task2,1,16)
            call SaveInteger(udg_ht,task2,2,level)
            call TimerStart(t2,0.50,true,function Trig_Kisume01_Burning)
            call KillUnit(u)
            call RemoveUnit(u)
            call PauseTimer(t)
            call DestroyTimer(t)
            call FlushChildHashtable(udg_ht,task)
        endif
    else
        set t2 = CreateTimer()
        set task2 = GetHandleId(t2)
        set w = CreateUnit(GetOwningPlayer(caster),'n03F',ox,oy,0)
        call SaveUnitHandle(udg_ht,task2,0,w)
        call SaveInteger(udg_ht,task2,1,16)
        call SaveInteger(udg_ht,task2,2,level)
        call TimerStart(t2,0.50,true,function Trig_Kisume01_Burning)
        call KillUnit(u)
        call RemoveUnit(u)
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set caster = null
    set u = null
    set v = null
    set w = null
    set g = null
    set iff = null
    set t2 = null
endfunction

function Trig_Kisume01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local real a = Atan2(ty-oy,tx-ox)
    local integer level = GetUnitAbilityLevel(caster,'A0R8')
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local boolean instun = false
    //========
    local real abilitycooldownlv01 = 6
    local real abilitycooldownlv02 = 6
    local real abilitycooldownlv03 = 6
    local real abilitycooldownlv04 = 6
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if udg_SK_KisumeEX_Count >= 4 then
        set udg_SK_KisumeEX_Count = 0
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00吊瓶「Well Destructor」积累|r" + I2S(udg_SK_KisumeEX_Count) + "|c00ffff00次。|r")
        set instun = true
    else
        set udg_SK_KisumeEX_Count = udg_SK_KisumeEX_Count + 1
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00吊瓶「Well Destructor」积累|r" + I2S(udg_SK_KisumeEX_Count) + "|c00ffff00次。|r")
        set instun = false
    endif
    set u = CreateUnit(GetOwningPlayer(caster),'n03D',ox,oy,bj_RADTODEG*a)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,u)
    call SaveInteger(udg_ht,task,2,level)
    call SaveInteger(udg_ht,task,3,50)
    call SaveReal(udg_ht,task,4,a)
    call SaveReal(udg_ht,task,5,20.0)
    call SaveBoolean(udg_ht,task,6,instun)
    call TimerStart(t,0.02,true,function Trig_Kisume01_Main)
    set caster = null
    set u = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Kisume01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Kisume02
//===========================================================================
function Trig_Kisume02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0R9'
endfunction

function Trig_Kisume02_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local real tx = LoadReal(udg_ht,task,1)
    local real ty = LoadReal(udg_ht,task,2)
    local integer level = LoadInteger(udg_ht,task,3)
    local boolean instun = LoadBoolean(udg_ht,task,4)
    local integer i = LoadInteger(udg_ht,task,5)
    local integer j
    local real ox = LoadReal(udg_ht,task,6)
    local real oy = LoadReal(udg_ht,task,7)
    local unit v
    local unit w
    local group g
    local boolexpr iff
    if i > 0 then
        set i = i - 1
        if i > 25 then
            call SetUnitXYGround(caster,ox,oy)
            call SetUnitFlyHeight(caster,(50-i)*80,0)
        endif
        if i == 25 then
            call SetUnitXYGround(caster,tx,ty)
        endif
        if i != 0 and i < 25 then
            call SetUnitXYGround(caster,tx,ty)
            call SetUnitFlyHeight(caster,i*80,0)
        endif
        if i == 0 then
            call PauseUnit(caster,false)
            call SetUnitInvulnerable(caster,false)
            set tx = GetUnitX(caster)
            set ty = GetUnitY(caster)
            call DestroyEffect(AddSpecialEffect("abilities\\weapons\\DemolisherMissile\\DemolisherMissile.mdl",tx,ty))
            set i = 0
            loop
                set i = i + 1
                call DestroyEffect(AddSpecialEffect("abilities\\weapons\\DemolisherMissile\\DemolisherMissile.mdl",tx+270*CosBJ(i*15),ty+270*SinBJ(i*15)))
                exitwhen i == 24
            endloop
            set i = 0
            loop
                set i = i + 1
                set j = 0
                loop
                    set j = j + 1
                    call DestroyEffect(AddSpecialEffect("abilities\\weapons\\DemolisherMissile\\DemolisherMissile.mdl",tx+j*45*CosBJ(i*120),ty+j*45*SinBJ(i*120)))
                    exitwhen j == 5
                endloop
                exitwhen i == 3
            endloop
            set i = 0
            call SetUnitFlyHeight(caster,GetUnitDefaultFlyHeight(caster),0)
            call SetUnitPathing(caster,true)
            set g = CreateGroup()
            set iff = GetPlayerFilter(GetOwningPlayer(caster))
            call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),300,iff)
            loop
                set v = FirstOfGroup(g)
                exitwhen v == null
                call GroupRemoveUnit(g,v)
                if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
                    call UnitDamageTarget(caster,v,(60+60*level+GetHeroAgi(caster,true)*(0.6+0.6*level))*(400-SquareRoot((GetUnitX(caster)-GetUnitX(v))*(GetUnitX(caster)-GetUnitX(v))+(GetUnitY(caster)-GetUnitY(v))*(GetUnitY(caster)-GetUnitY(v))))/400,false,true,ATTACK_TYPE_HERO,DAMAGE_TYPE_NORMAL,WEAPON_TYPE_WHOKNOWS)
                    if instun == true then
                        set w = CreateUnit(GetOwningPlayer(caster),'n001',tx,ty,0)
                        call UnitAddAbility(w,'A0RC')
                        call SetUnitAbilityLevel(w,'A0RC',9)
                        call IssueTargetOrder(w,"thunderbolt",v)
                    endif
                endif
            endloop
            call DestroyGroup(g)
        endif
        call SaveInteger(udg_ht,task,5,i)
    else
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set caster = null
    set v = null
    set w = null
    set g = null
    set iff = null
endfunction

function Trig_Kisume02_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local integer level = GetUnitAbilityLevel(caster,'A0R9')
    local boolean instun = false
    //========
    local real abilitycooldownlv01 = 22
    local real abilitycooldownlv02 = 20
    local real abilitycooldownlv03 = 18
    local real abilitycooldownlv04 = 16
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call PauseUnit(caster,true)
    call SetUnitPathing(caster,false)
    call EnableHeight(caster)
    call SetUnitInvulnerable(caster, true)
    if udg_SK_KisumeEX_Count >= 4 then
        set udg_SK_KisumeEX_Count = 0
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00吊瓶「Well Destructor」积累|r" + I2S(udg_SK_KisumeEX_Count) + "|c00ffff00次。|r")
        set instun = true
    else
        set udg_SK_KisumeEX_Count = udg_SK_KisumeEX_Count + 1
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00吊瓶「Well Destructor」积累|r" + I2S(udg_SK_KisumeEX_Count) + "|c00ffff00次。|r")
        set instun = false
    endif
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveReal(udg_ht,task,1,tx)
    call SaveReal(udg_ht,task,2,ty)
    call SaveInteger(udg_ht,task,3,level)
    call SaveBoolean(udg_ht,task,4,instun)
    call SaveInteger(udg_ht,task,5,50)
    call SaveReal(udg_ht,task,6,ox)
    call SaveReal(udg_ht,task,7,oy)
    call TimerStart(t,0.02,true,function Trig_Kisume02_Main)
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Kisume02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Kisume03
//===========================================================================
function Trig_Kisume03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0RA'
endfunction

function Trig_Kisume03_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    if udg_SK_Kisume03_Effect != null then
        call DestroyEffect(udg_SK_Kisume03_Effect)
        set udg_SK_Kisume03_Effect = null
    endif
    set udg_SK_Kisume03_Count = 0
    call DestroyTimer(t)
    set t = null
endfunction

function Trig_Kisume03_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local unit caster = GetTriggerUnit()
    local unit u
    local unit w
    local unit v
    local integer level = GetUnitAbilityLevel(caster,'A0RA')
    local integer i
    local group g
    local boolexpr iff
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local boolean instun = false
    //========
    local real abilitycooldownlv01 = 14
    local real abilitycooldownlv02 = 14
    local real abilitycooldownlv03 = 14
    local real abilitycooldownlv04 = 14
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    if udg_SK_Kisume03_Effect != null then
        call DestroyEffect(udg_SK_Kisume03_Effect)
        set udg_SK_Kisume03_Effect = null
    endif
    set udg_SK_Kisume03_Effect = AddSpecialEffectTarget("Abilities\\Spells\\Other\\ImmolationRed\\ImmolationRedTarget.mdl",caster,"chest")
    set udg_SK_Kisume03_Count = 50 + 50 * level + GetHeroAgi(caster,true) * (0.5 + 0.5 * level)
    call TimerStart(t,7.00,false,function Trig_Kisume03_Main)
    set i = 0
    loop
        set i = i + 1
        set u = CreateUnit(GetOwningPlayer(caster),'n03S',ox + 180 * CosBJ(i*40),oy + 180 * SinBJ(i*40),0)
        exitwhen i == 9
    endloop
    if udg_SK_KisumeEX_Count >= 4 then
        set udg_SK_KisumeEX_Count = 0
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00吊瓶「Well Destructor」积累|r" + I2S(udg_SK_KisumeEX_Count) + "|c00ffff00次。|r")
        set instun = true
    else
        set udg_SK_KisumeEX_Count = udg_SK_KisumeEX_Count + 1
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00吊瓶「Well Destructor」积累|r" + I2S(udg_SK_KisumeEX_Count) + "|c00ffff00次。|r")
        set instun = false
    endif
    set g = CreateGroup()
    set iff = GetPlayerFilter(GetOwningPlayer(caster))
    call GroupEnumUnitsInRange(g,ox,oy,200,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
            call UnitDamageTarget(caster,v,25+25*level,false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
            if instun == true then
                set w = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,0)
                call UnitAddAbility(w,'A0RC')
                call SetUnitAbilityLevel(w,'A0RC',9)
                call IssueTargetOrder(w,"thunderbolt",v)
            endif
        endif
    endloop
    call DestroyGroup(g)
    set t = null
    set caster = null
    set u = null
    set w = null
    set v = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_Kisume03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Kisume03 Damage
//===========================================================================
function Trig_Kisume03_Damage_Conditions takes nothing returns boolean
    return GetUnitAbilityLevel(GetTriggerUnit(),'A0RA') > 0
endfunction

function Trig_Kisume03_Damage_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0RA')
    local real damage = GetEventDamage()
    local real healing
    if udg_SK_Kisume03_Count > 0 then
        set healing = RMinBJ(udg_SK_Kisume03_Count,damage)
        set udg_SK_Kisume03_Count = udg_SK_Kisume03_Count - healing*(1-(0.035+level*0.035))
        if GetUnitState(caster,UNIT_STATE_LIFE) - GetEventDamage() + healing > 0 then
            call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_LIFE)+healing)
        endif
        if udg_SK_Kisume03_Count <= 0 then
            if udg_SK_Kisume03_Effect != null then
                call DestroyEffect(udg_SK_Kisume03_Effect)
                set udg_SK_Kisume03_Effect = null
            endif
            set udg_SK_Kisume03_Count = 0
        endif
    else
        set healing = GetEventDamage() * (0.035 + level * 0.035)
        if GetUnitState(caster,UNIT_STATE_LIFE) - GetEventDamage() + healing > 0 then
            call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_LIFE)+healing)
        endif
    endif
    set caster = null
endfunction

//===========================================================================
function InitTrig_Kisume03_Damage takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Kisume04
//===========================================================================
function Trig_Kisume04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0RB'
endfunction

function Trig_Kisume04_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit u
    local unit w
    local unit v
    local integer level = GetUnitAbilityLevel(caster,'A0RB')
    local integer i
    local group g
    local boolexpr iff
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local boolean instun = false
    //========
    local real abilitycooldownlv01 = 135
    local real abilitycooldownlv02 = 135
    local real abilitycooldownlv03 = 135
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    set i = 0
    loop
        set i = i + 1
        call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\RedDragonBreath\\RedDragonMissile.mdl",ox + 135 * CosBJ(i*60),oy + 135 * SinBJ(i*60)))
        exitwhen i == 6
    endloop
    set i = 0
    loop
        set i = i + 1
        call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\RedDragonBreath\\RedDragonMissile.mdl",ox + 270 * CosBJ(i*30),oy + 270 * SinBJ(i*30)))
        exitwhen i == 12
    endloop
    set i = 0
    loop
        set i = i + 1
        call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\RedDragonBreath\\RedDragonMissile.mdl",ox + 540 * CosBJ(i*15),oy + 540 * SinBJ(i*15)))
        exitwhen i == 24
    endloop

    if udg_SK_KisumeEX_Count >= 4 then
        set udg_SK_KisumeEX_Count = 0
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00吊瓶「Well Destructor」积累|r" + I2S(udg_SK_KisumeEX_Count) + "|c00ffff00次。|r")
        set instun = true
    else
        set udg_SK_KisumeEX_Count = udg_SK_KisumeEX_Count + 1
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|c00ffff00吊瓶「Well Destructor」积累|r" + I2S(udg_SK_KisumeEX_Count) + "|c00ffff00次。|r")
        set instun = false
    endif
    call SetUnitState(caster,UNIT_STATE_LIFE,1.00)
    set g = CreateGroup()
    set iff = GetPlayerFilter(GetOwningPlayer(caster))
    call GroupEnumUnitsInRange(g,ox,oy,600,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
            call UnitDamageTarget(caster,v,150 + level*150 + GetUnitState(v,UNIT_STATE_LIFE) * (0.09 + level * 0.09),false,true,ATTACK_TYPE_NORMAL,DAMAGE_TYPE_MAGIC,WEAPON_TYPE_WHOKNOWS)
            if instun == true then
                set w = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,0)
                call UnitAddAbility(w,'A0RC')
                call SetUnitAbilityLevel(w,'A0RC',9)
                call IssueTargetOrder(w,"thunderbolt",v)
            endif
        endif
    endloop
    call DestroyGroup(g)
    set caster = null
    set u = null
    set v = null
    set w = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_Kisume04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initialing Kisume
//===========================================================================
//TESH.scrollpos=14
//TESH.alwaysfold=0
function Trig_Initialing_Kisume_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('E01V')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + "技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set gg_trg_KisumeDS = CreateTrigger()
    call TriggerRegisterPlayerEvent( gg_trg_KisumeDS, GetOwningPlayer(h), EVENT_PLAYER_END_CINEMATIC)
    call TriggerAddCondition( gg_trg_KisumeDS, Condition( function Trig_KisumeDS_Conditions ) )
    call TriggerAddAction( gg_trg_KisumeDS, function Trig_KisumeDS_Actions )

    set gg_trg_Kisume01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kisume01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Kisume01, Condition( function Trig_Kisume01_Conditions ) )
    call TriggerAddAction( gg_trg_Kisume01, function Trig_Kisume01_Actions )

    set gg_trg_Kisume02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kisume02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Kisume02, Condition( function Trig_Kisume02_Conditions ) )
    call TriggerAddAction( gg_trg_Kisume02, function Trig_Kisume02_Actions )

    set gg_trg_Kisume03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kisume03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Kisume03, Condition( function Trig_Kisume03_Conditions ) )
    call TriggerAddAction( gg_trg_Kisume03, function Trig_Kisume03_Actions )

    set gg_trg_Kisume03_Damage = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kisume03_Damage, h, EVENT_UNIT_DAMAGED )
    call TriggerAddCondition( gg_trg_Kisume03_Damage, Condition( function Trig_Kisume03_Damage_Conditions ) )
    call TriggerAddAction( gg_trg_Kisume03_Damage, function Trig_Kisume03_Damage_Actions )

    set gg_trg_Kisume04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Kisume04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Kisume04, Condition( function Trig_Kisume04_Conditions ) )
    call TriggerAddAction( gg_trg_Kisume04, function Trig_Kisume04_Actions )

    set h = null
endfunction

//===========================================================================
function InitTrig_Initialing_Kisume takes nothing returns nothing
    set gg_trg_Initialing_Kisume = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initialing_Kisume, function Trig_Initialing_Kisume_Actions )
endfunction

//===========================================================================
// Trigger: Hatate01
//===========================================================================
function Trig_Hatate01_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A08N'
endfunction

function Trig_Hatate01_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real dx = GetSpellTargetX() - ox
    local real dy = GetSpellTargetY() - oy
    local real px
    local real py
    local real a = Atan2(dy,dx)
    local real d = SquareRoot(dx*dx+dy*dy)
    local integer level = GetUnitAbilityLevel(caster,GetSpellAbilityId())
    //========
    local real abilitycooldownlv01 = 11
    local real abilitycooldownlv02 = 11
    local real abilitycooldownlv03 = 11
    local real abilitycooldownlv04 = 11
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set d = RMinBJ(300.0 + level*200.0,d)
    set px = ox + d*Cos(a)
    set py = oy + d*Sin(a)
    call DestroyEffect(AddSpecialEffect("Shot_02.mdx",ox,oy))
    call SetUnitXY(caster,px,py)
    call DestroyEffect(AddSpecialEffect("Shot_02.mdx",GetUnitX(caster),GetUnitY(caster)))
    set caster = null
endfunction

//===========================================================================
function InitTrig_Hatate01 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Hatate01 Learn
//===========================================================================
function Trig_Hatate01_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A08N'
endfunction

function Trig_Hatate01_Learn_Actions takes nothing returns nothing
    if GetUnitAbilityLevel(GetTriggerUnit(),'A08N') == 1 then
        call UnitAddAbility(GetTriggerUnit(),'A08O')
    else
        call SetUnitAbilityLevel(GetTriggerUnit(),'A08O',GetUnitAbilityLevel(GetTriggerUnit(),'A08N'))
    endif
endfunction

//===========================================================================
function InitTrig_Hatate01_Learn takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Hatate02
//===========================================================================
function Trig_Hatate02_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A09B'
endfunction

function Trig_Hatate02_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real tx = GetSpellTargetX()
    local real ty = GetSpellTargetY()
    local integer level = GetUnitAbilityLevel(caster,'A09B')
    local real damage
    local unit v
    local unit w
    local group g
    local boolexpr iff
    //========
    local real abilitycooldownlv01 = 5
    local real abilitycooldownlv02 = 5
    local real abilitycooldownlv03 = 5
    local real abilitycooldownlv04 = 5
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    set g = CreateGroup()
    set iff = GetPlayerFilter(GetOwningPlayer(caster))
    call GroupEnumUnitsInRange(g,tx,ty,250,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
            set w = CreateUnit(GetOwningPlayer(caster),'n001',tx,ty,0)
            call UnitAddAbility(w,'A0D4')
            call IssueTargetOrder(w,"faeriefire",v)
            if level==1 then
                set damage = 7
            elseif level==2 then
                set damage = 13
            elseif level==3 then
                set damage = 23
            elseif level==4 then
                set damage = 38
            endif
            call UnitDamageTargetHJ(caster,v,damage,2)
        endif
    endloop
    call DestroyGroup(g)
    set caster = null
    set v = null
    set w = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_Hatate02 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Hatate02 Attack
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Hatate02_Attack_Conditions takes nothing returns boolean
    local unit attacked = GetTriggerUnit()
    local unit attacker = GetAttacker()
    if GetUnitAbilityLevel(attacker,'A09B')<=0 then
        set attacked = null
        set attacker = null
        return false
    endif
    if GetUnitAbilityLevel(attacked,'B05Z')==0 then
        set attacked = null
        set attacker = null
        return false
    endif
    set attacked = null
    set attacker = null
    return true
endfunction

function Trig_Hatate02_Attack_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local integer level
    local real damage = 0
    local effect e
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        set e = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        //call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        //call DestroyTrigger(trg)
        //call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        set e = null
        return
    endif
    set target = GetTriggerUnit()
    set level = GetUnitAbilityLevel(caster,'A09B')
    //========
    call DisableTrigger(trg)
    //========
    if level==1 then
        set damage = 7
    elseif level==2 then
        set damage = 13
    elseif level==3 then
        set damage = 23
    elseif level==4 then
        set damage = 38
    endif
    call UnitDamageTargetHJ(caster,target,damage,2)
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
    set e = null
endfunction

function Trig_Hatate02_Attack_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_Hatate02_Attack_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Hatate02_Attack takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Hatate03
//===========================================================================
function Trig_Hatate03_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0D9'
endfunction

function Trig_Hatate03_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    if GetUnitAbilityLevel(caster,'A0E5') == 1 or GetUnitAbilityLevel(caster,'A0E5') == 5 or GetUnitAbilityLevel(caster,'A0E5') == 9 or GetUnitAbilityLevel(caster,'A0E5') == 13 then
        call UnitRemoveAbility(caster,'A0E5')
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    else
        call SetUnitAbilityLevel(caster,'A0E5',GetUnitAbilityLevel(caster,'A0E5')-1)
    endif
    set t = null
    set caster = null
endfunction

function Trig_Hatate03_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0D9')
    //========
    local real abilitycooldownlv01 = 11
    local real abilitycooldownlv02 = 11
    local real abilitycooldownlv03 = 11
    local real abilitycooldownlv04 = 11
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 4 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv04)
        endif
    endif
    //========
    call UnitAddAbility(caster,'A0E5')
    call SetUnitAbilityLevel(caster,'A0E5',level*4)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call TimerStart(t,1.25,true,function Trig_Hatate03_Clear)
    set t = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Hatate03 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Hatate04
//===========================================================================
function Trig_Hatate04_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0E6'
endfunction

function Trig_Hatate04_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit v = LoadUnitHandle(udg_ht,task,0)
    local unit u = LoadUnitHandle(udg_ht,task,1)
    if IsUnitType(u,UNIT_TYPE_DEAD)==false then
        call SetUnitXY(u,GetUnitX(v),GetUnitY(v))
    else
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    set t = null
    set v = null
    set u = null
endfunction

function Trig_Hatate04_Main takes unit caster, unit v, integer level returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit u
    if level == 1 then
        set u = CreateUnit(GetOwningPlayer(caster),'n03Y',GetUnitX(v),GetUnitY(v),0)
    elseif level == 2 then
        set u = CreateUnit(GetOwningPlayer(caster),'n03Z',GetUnitX(v),GetUnitY(v),0)
    else
        set u = CreateUnit(GetOwningPlayer(caster),'n040',GetUnitX(v),GetUnitY(v),0)
    endif
    call SaveUnitHandle(udg_ht,task,0,v)
    call SaveUnitHandle(udg_ht,task,1,u)
    call TimerStart(t,0.10,true,function Trig_Hatate04_Clear)
    set t = null
    set u = null
endfunction

function Trig_Hatate04_EffectClear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local effect e = LoadEffectHandle(udg_ht,task,0)
    call DestroyEffect(e)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set e = null
endfunction

function Trig_Hatate04_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local integer level = GetUnitAbilityLevel(caster,'A0E6')
    local integer i
    local unit v
    local effect e = AddSpecialEffectTarget("Abilities\\Spells\\Items\\PotionOfOmniscience\\CrystalBallCaster.mdl",caster,"head")
    //========
    local real abilitycooldownlv01 = 180
    local real abilitycooldownlv02 = 150
    local real abilitycooldownlv03 = 120
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    set i = 0
    loop
        exitwhen i>=12
        set v = udg_PlayerHeroes[i]
        if v!= null and IsUnitEnemy(v,GetOwningPlayer(caster)) then
            call Trig_Hatate04_Main(caster,v,level)
        endif
        set i = i + 1
    endloop
    call SaveEffectHandle(udg_ht,task,0,e)
    call TimerStart(t,4+level,false,function Trig_Hatate04_EffectClear)
    set caster = null
    set v = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Hatate04 takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Hatate04 Learn
//===========================================================================
function Trig_Hatate04_Learn_Conditions takes nothing returns boolean
    return GetLearnedSkill() == 'A0E6'
endfunction

function Trig_Hatate04_Learn_Actions takes nothing returns nothing
    if GetUnitAbilityLevel(GetTriggerUnit(),'A0E6') == 1 then
        call UnitAddAbility(GetTriggerUnit(),'A0I2')
    else
        call SetUnitAbilityLevel(GetTriggerUnit(),'A0I2',GetUnitAbilityLevel(GetTriggerUnit(),'A0E6'))
    endif
endfunction

//===========================================================================
function InitTrig_Hatate04_Learn takes nothing returns nothing
endfunction//===========================================================================
// Trigger: Hatate04 Ex
//===========================================================================
function Trig_Hatate04_Ex_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0I2'
endfunction

function Trig_Hatate04_Ex_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local effect e = LoadEffectHandle(udg_ht,task,1)
    call DestroyEffect(e)
    if IsUnitAlly(gg_unit_n023_0006,GetOwningPlayer(caster)) then
        call SetUnitXYGround(caster,GetUnitX(gg_unit_n023_0006)-125,GetUnitY(gg_unit_n023_0006)-125)
    elseif IsUnitAlly(gg_unit_n03O_0079,GetOwningPlayer(caster)) then 
        call SetUnitXYGround(caster,GetUnitX(gg_unit_n03O_0079)-125,GetUnitY(gg_unit_n03O_0079)-125)
    endif
    call PauseUnit(caster,false)
    call SetUnitInvulnerable(caster, false)
    call IssueImmediateOrder(caster, "stop" )
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
    set caster = null
    set e = null
endfunction

function Trig_Hatate04_Ex_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local effect e = AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Starfall\\StarfallCaster.mdl",caster,"origin")
    //========
    local real abilitycooldownlv01 = 240
    local real abilitycooldownlv02 = 210
    local real abilitycooldownlv03 = 180
    if UnitHasItemOfTypeBJ(caster, 'I00B') then
        if GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 1 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv01)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 2 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv02)
        elseif GetUnitAbilityLevel(caster,GetSpellAbilityId()) == 3 then
            call Item_HeroAbilityCoolDownReset(caster,GetSpellAbilityId(),abilitycooldownlv03)
        endif
    endif
    //========
    call PauseUnit(caster,true)
    call SetUnitInvulnerable(caster, true)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveEffectHandle(udg_ht,task,1,e)
    call TimerStart(t,3.00,false,function Trig_Hatate04_Ex_Clear)
    set caster = null
    set t = null
    set e = null
endfunction

//===========================================================================
function InitTrig_Hatate04_Ex takes nothing returns nothing
endfunction

//===========================================================================
// Trigger: Initialing Hatate
//===========================================================================
//TESH.scrollpos=14
//TESH.alwaysfold=0
function Trig_Initialing_Hatate_Actions takes nothing returns nothing
    local unit h = GetCharacterHandle('O00V')
    if h==null then
        return
    endif
    call DebugMsg(GetHeroProperName(h) + "技能初始化完成")
    call DestroyTrigger(GetTriggeringTrigger())

    set gg_trg_Hatate01 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Hatate01, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Hatate01, Condition( function Trig_Hatate01_Conditions ) )
    call TriggerAddAction( gg_trg_Hatate01, function Trig_Hatate01_Actions )

    set gg_trg_Hatate01_Learn = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Hatate01_Learn, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Hatate01_Learn, Condition( function Trig_Hatate01_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Hatate01_Learn, function Trig_Hatate01_Learn_Actions )

    set gg_trg_Hatate02 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Hatate02, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Hatate02, Condition( function Trig_Hatate02_Conditions ) )
    call TriggerAddAction( gg_trg_Hatate02, function Trig_Hatate02_Actions )

    set gg_trg_Hatate02_Attack = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Hatate02_Attack, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Hatate02_Attack, Condition( function Trig_Hatate02_Attack_Conditions ) )
    call TriggerAddAction( gg_trg_Hatate02_Attack, function Trig_Hatate02_Attack_Actions )

    set gg_trg_Hatate03 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Hatate03, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Hatate03, Condition( function Trig_Hatate03_Conditions ) )
    call TriggerAddAction( gg_trg_Hatate03, function Trig_Hatate03_Actions )

    set gg_trg_Hatate04 = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Hatate04, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Hatate04, Condition( function Trig_Hatate04_Conditions ) )
    call TriggerAddAction( gg_trg_Hatate04, function Trig_Hatate04_Actions )

    set gg_trg_Hatate04_Learn = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Hatate04_Learn, h, EVENT_UNIT_HERO_SKILL )
    call TriggerAddCondition( gg_trg_Hatate04_Learn, Condition( function Trig_Hatate04_Learn_Conditions ) )
    call TriggerAddAction( gg_trg_Hatate04_Learn, function Trig_Hatate04_Learn_Actions )

    set gg_trg_Hatate04_Ex = CreateTrigger()
    call TriggerRegisterUnitEvent( gg_trg_Hatate04_Ex, h, EVENT_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Hatate04_Ex, Condition( function Trig_Hatate04_Ex_Conditions ) )
    call TriggerAddAction( gg_trg_Hatate04_Ex, function Trig_Hatate04_Ex_Actions )

    call UnitAddAbility(h,'A0E5')
    call UnitRemoveAbility(h,'A0E5')

    set h = null
endfunction

//===========================================================================
function InitTrig_Initialing_Hatate takes nothing returns nothing
    set gg_trg_Initialing_Hatate = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initialing_Hatate, function Trig_Initialing_Hatate_Actions )
endfunction

//===========================================================================
// Trigger: Initialization ItemAbilities
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Initialization_ItemAbilities_Func002A takes nothing returns nothing
    local player w = GetEnumPlayer()
    call SetPlayerAbilityAvailable(w,'A03Q',false)
    call SetPlayerAbilityAvailable(w,'A0GM',false)
    call SetPlayerAbilityAvailable(w,'A0GU',false)
    call SetPlayerAbilityAvailable(w,'A0R4',false)
    set w = null
endfunction

function Trig_Initialization_ItemAbilities_Func002B takes nothing returns nothing
    local player w = GetEnumPlayer()
    local integer i
    local integer c
    set i = 0
    loop
        set c = udg_HeroType[i]
        if c!=0 then
            call SetPlayerAbilityAvailable(w,DB_GetHeroTypeData(c,DB_HERO_MULTIPLE_ATTACK()),false)
        endif
        set i = i + 1
        exitwhen i>=200
    endloop
    set w = null
endfunction

function Trig_Initialization_ItemAbilities_Actions takes nothing returns nothing
    call ForForce( GetPlayersAll(), function Trig_Initialization_ItemAbilities_Func002A )
    call TriggerSleepAction( 2.0 )
    call ForForce( GetPlayersAll(), function Trig_Initialization_ItemAbilities_Func002B )
endfunction

//===========================================================================
function InitTrig_Initialization_ItemAbilities takes nothing returns nothing
    set gg_trg_Initialization_ItemAbilities = CreateTrigger()
    call TriggerAddAction( gg_trg_Initialization_ItemAbilities, function Trig_Initialization_ItemAbilities_Actions )
endfunction
//===========================================================================
// Trigger: Mashroom
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Mashroom_Conditions takes nothing returns boolean
    local item mashroom = GetManipulatedItem()
    local integer ItemType = GetItemTypeId(mashroom)
    if ItemType == 'I00R' or ItemType == 'I00T' or ItemType == 'I00S' then
    set mashroom = null
    return true
    endif
    set mashroom = null
    return false
endfunction

function Trig_Mashroom_Actions takes nothing returns nothing
    local item mashroom = GetManipulatedItem()
    local integer ItemType = GetItemTypeId(mashroom)
    local unit caster = GetManipulatingUnit()
    local effect e
    if IsUnitType(caster,UNIT_TYPE_HERO) then
        if ItemType == 'I00R' then
        call SetHeroStr(caster,GetHeroStr(caster,false)+3,true)
        elseif ItemType == 'I00T' then
        call SetHeroAgi(caster,GetHeroAgi(caster,false)+3,true)
        elseif ItemType == 'I00S' then
        call SetHeroInt(caster,GetHeroInt(caster,false)+3,true)
        endif
        set e = AddSpecialEffectTarget("Abilities\\Spells\\Items\\AIlm\\AIlmTarget.mdl",caster,"origin")
        call DestroyEffect(e)
    endif
    set e = null
    set mashroom = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_Mashroom takes nothing returns nothing
    set gg_trg_Mashroom = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Mashroom, EVENT_PLAYER_UNIT_USE_ITEM )
    call TriggerAddCondition( gg_trg_Mashroom, Condition( function Trig_Mashroom_Conditions ) )
    call TriggerAddAction( gg_trg_Mashroom, function Trig_Mashroom_Actions )
endfunction

//===========================================================================
// Trigger: TreeEyes
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_TreeEyes_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A02C'
endfunction

function Trig_TreeEyes_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local destructable target = GetSpellTargetDestructable()
    local real tx = GetDestructableX(target) - 64.0
    local real ty = GetDestructableY(target) - 64.0
    local unit u
    //========
    set u = CreateUnit(GetOwningPlayer(caster),'n002',tx,ty,225.0)
    call UnitApplyTimedLife(u,'BTLF',120.00)
    //========
    call TriggerSleepAction(1.0)
    set u = CreateUnit(Player(PLAYER_NEUTRAL_AGGRESSIVE),GPSU(),tx,ty,270.0)
    call UnitAddAbility(u,'Adis')
    call IssuePointOrder(u,"dispel",tx,ty)
    //========
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_TreeEyes takes nothing returns nothing
    set gg_trg_TreeEyes = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_TreeEyes, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_TreeEyes, Condition( function Trig_TreeEyes_Conditions ) )
    call TriggerAddAction( gg_trg_TreeEyes, function Trig_TreeEyes_Actions )
endfunction
//===========================================================================
// Trigger: Doll Cast
//===========================================================================
function Trig_Doll_Cast_Conditions takes nothing returns boolean
    if ( not ( GetSpellAbilityId() == 'A019' ) ) then
        return false
    endif
    return true
endfunction

function Trig_Doll_Cast_Actions takes nothing returns nothing
    call TriggerSleepAction( 0.00 )
    call UnitAddAbilityBJ( 'A03J', GetTriggerUnit() )
    call IssueImmediateOrder( GetTriggerUnit(), "windwalk" )
    call UnitRemoveAbilityBJ( 'A03J', GetTriggerUnit() )
endfunction

//===========================================================================
function InitTrig_Doll_Cast takes nothing returns nothing
    set gg_trg_Doll_Cast = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Doll_Cast, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Doll_Cast, Condition( function Trig_Doll_Cast_Conditions ) )
    call TriggerAddAction( gg_trg_Doll_Cast, function Trig_Doll_Cast_Actions )
endfunction

//===========================================================================
// Trigger: Doll Issue
//===========================================================================
function Trig_Doll_Issue_Conditions takes nothing returns boolean
    if ( not ( GetSpellAbilityId() == 'A03J' ) ) then
        return false
    endif
    return true
endfunction

function Trig_Doll_Issue_Actions takes nothing returns nothing
    set udg_ObjectsDoll = GetSpellAbilityUnit()
    set udg_SK_TempLocation = GetUnitLoc(GetSpellAbilityUnit())
    call CreateNUnitsAtLocFacingLocBJ( 1, 'n00G', GetOwningPlayer(GetSpellAbilityUnit()), udg_SK_TempLocation, udg_SK_TempLocation )
    call RemoveLocation( udg_SK_TempLocation )
    call UnitAddAbilityBJ( 'A03K', GetLastCreatedUnit() )
    call IssueTargetOrderById( GetLastCreatedUnit(), 852274, GetSpellAbilityUnit() )
endfunction

//===========================================================================
function InitTrig_Doll_Issue takes nothing returns nothing
    set gg_trg_Doll_Issue = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Doll_Issue, EVENT_PLAYER_UNIT_SPELL_FINISH )
    call TriggerAddCondition( gg_trg_Doll_Issue, Condition( function Trig_Doll_Issue_Conditions ) )
    call TriggerAddAction( gg_trg_Doll_Issue, function Trig_Doll_Issue_Actions )
endfunction

//===========================================================================
// Trigger: Doll Move
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_Doll_Move_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetSummoningUnit()) == 'n00G'
endfunction

function Trig_Doll_Move_Actions takes nothing returns nothing
    local real x = GetUnitX(udg_ObjectsDoll)
    local real y = GetUnitY(udg_ObjectsDoll)
    local real facing = GetUnitFacing(udg_ObjectsDoll)
    local unit u = GetSummonedUnit()
    call SetUnitPosition(u,x,y)
    call SetUnitFacing(u,facing)
    set udg_ObjectsDoll = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Doll_Move takes nothing returns nothing
    set gg_trg_Doll_Move = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Doll_Move, EVENT_PLAYER_UNIT_SUMMON )
    call TriggerAddCondition( gg_trg_Doll_Move, Condition( function Trig_Doll_Move_Conditions ) )
    call TriggerAddAction( gg_trg_Doll_Move, function Trig_Doll_Move_Actions )
endfunction

//===========================================================================
// Trigger: Lunchbox
//===========================================================================
function Trig_Lunchbox_Func001C takes nothing returns boolean
    if ( ( GetSpellAbilityId() == 'A02K' ) ) then
        return true
    endif
    if ( ( GetSpellAbilityId() == 'A02L' ) ) then
        return true
    endif
    if ( ( GetSpellAbilityId() == 'A02M' ) ) then
        return true
    endif
    if ( ( GetSpellAbilityId() == 'A0LC' ) ) then
        return true
    endif
    return false
endfunction

function Trig_Lunchbox_Conditions takes nothing returns boolean
    if ( not Trig_Lunchbox_Func001C() ) then
        return false
    endif
    return true
endfunction

function Trig_Lunchbox_Func002C takes nothing returns boolean
    if ( not ( GetSpellAbilityId() == 'A02K' ) ) then
        return false
    endif
    return true
endfunction

function Trig_Lunchbox_Func003C takes nothing returns boolean
    if ( not ( GetSpellAbilityId() == 'A02L' ) ) then
        return false
    endif
    return true
endfunction

function Trig_Lunchbox_Func004C takes nothing returns boolean
    if ( not ( GetSpellAbilityId() == 'A02M' ) ) then
        return false
    endif
    return true
endfunction

function Trig_Lunchbox_Func005Func001C takes nothing returns boolean
    if ( not ( GetItemCharges(GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I05W')) >= 7 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Lunchbox_Func005C takes nothing returns boolean
    if ( not ( GetSpellAbilityId() == 'A0LC' ) ) then
        return false
    endif
    return true
endfunction

function Trig_Lunchbox_Actions takes nothing returns nothing
    if ( Trig_Lunchbox_Func002C() ) then
        call SetUnitLifeBJ( GetTriggerUnit(), ( GetUnitStateSwap(UNIT_STATE_LIFE, GetTriggerUnit()) + ( 12.00 * I2R(GetItemCharges(GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I02Z'))) ) ) )
        call SetUnitManaBJ( GetTriggerUnit(), ( GetUnitStateSwap(UNIT_STATE_MANA, GetTriggerUnit()) + ( 12.00 * I2R(GetItemCharges(GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I02Z'))) ) ) )
        call SetItemCharges( GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I02Z'), 0 )
    else
        call DoNothing(  )
    endif
    if ( Trig_Lunchbox_Func003C() ) then
        call SetUnitLifeBJ( GetTriggerUnit(), ( GetUnitStateSwap(UNIT_STATE_LIFE, GetTriggerUnit()) + ( 18.00 * I2R(GetItemCharges(GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I033'))) ) ) )
        call SetUnitManaBJ( GetTriggerUnit(), ( GetUnitStateSwap(UNIT_STATE_MANA, GetTriggerUnit()) + ( 18.00 * I2R(GetItemCharges(GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I033'))) ) ) )
        call SetItemCharges( GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I033'), 0 )
    else
        call DoNothing(  )
    endif
    if ( Trig_Lunchbox_Func004C() ) then
        call SetUnitLifeBJ( GetTriggerUnit(), ( GetUnitStateSwap(UNIT_STATE_LIFE, GetTriggerUnit()) + ( 24.00 * I2R(GetItemCharges(GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I03G'))) ) ) )
        call SetUnitManaBJ( GetTriggerUnit(), ( GetUnitStateSwap(UNIT_STATE_MANA, GetTriggerUnit()) + ( 24.00 * I2R(GetItemCharges(GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I03G'))) ) ) )
        call SetItemCharges( GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I03G'), 0 )
    else
        call DoNothing(  )
    endif
    if ( Trig_Lunchbox_Func005C() ) then
        if ( Trig_Lunchbox_Func005Func001C() ) then
            call UnitRemoveBuffsEx( GetTriggerUnit(), false, true, false, false, true, true, false )
            call DestroyEffect( AddSpecialEffect("Abilities\\Spells\\Human\\Resurrect\\ResurrectCaster.mdl", GetUnitX(GetTriggerUnit()), GetUnitY(GetTriggerUnit())) )
        else
        endif
        call SetUnitLifeBJ( GetTriggerUnit(), ( GetUnitStateSwap(UNIT_STATE_LIFE, GetTriggerUnit()) + ( 40.00 * I2R(GetItemCharges(GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I05W'))) ) ) )
        call SetUnitManaBJ( GetTriggerUnit(), ( GetUnitStateSwap(UNIT_STATE_MANA, GetTriggerUnit()) + ( 40.00 * I2R(GetItemCharges(GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I05W'))) ) ) )
        call SetItemCharges( GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I05W'), 0 )
    else
        call DoNothing(  )
    endif
endfunction

//===========================================================================
function InitTrig_Lunchbox takes nothing returns nothing
    set gg_trg_Lunchbox = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Lunchbox, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Lunchbox, Condition( function Trig_Lunchbox_Conditions ) )
    call TriggerAddAction( gg_trg_Lunchbox, function Trig_Lunchbox_Actions )
endfunction

//===========================================================================
// Trigger: Lunchbox Collecting
//===========================================================================
function Trig_Lunchbox_Collecting_Conditions takes nothing returns boolean
    if ( not ( IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO) == true ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0OQ' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0QP' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0OS' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0OR' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A029' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A02A' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A02B' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A035' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A02C' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A02K' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A02L' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A02M' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0LC' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0GZ' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0I1' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A04O' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A07V' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0FK' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A03T' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0CI' ) ) then
        return false
    endif
    if ( not ( GetSpellAbilityId() != 'A0N3' ) ) then
        return false
    endif
    return true
endfunction

function Trig_Lunchbox_Collecting_Func025001003 takes nothing returns boolean
    return ( IsUnitEnemy(GetFilterUnit(), GetTriggerPlayer()) == true )
endfunction

function Trig_Lunchbox_Collecting_Func025Func001Func001Func002Func002C takes nothing returns boolean
    if ( not ( UnitHasItemOfTypeBJ(GetEnumUnit(), 'I02Z') == true ) ) then
        return false
    endif
    if ( not ( GetItemCharges(GetItemOfTypeFromUnitBJ(GetEnumUnit(), 'I02Z')) < 7 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Lunchbox_Collecting_Func025Func001Func001Func002C takes nothing returns boolean
    if ( not ( UnitHasItemOfTypeBJ(GetEnumUnit(), 'I033') == true ) ) then
        return false
    endif
    if ( not ( GetItemCharges(GetItemOfTypeFromUnitBJ(GetEnumUnit(), 'I033')) < 7 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Lunchbox_Collecting_Func025Func001Func001C takes nothing returns boolean
    if ( not ( UnitHasItemOfTypeBJ(GetEnumUnit(), 'I03G') == true ) ) then
        return false
    endif
    if ( not ( GetItemCharges(GetItemOfTypeFromUnitBJ(GetEnumUnit(), 'I03G')) < 7 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Lunchbox_Collecting_Func025Func001C takes nothing returns boolean
    if ( not ( UnitHasItemOfTypeBJ(GetEnumUnit(), 'I05W') == true ) ) then
        return false
    endif
    if ( not ( GetItemCharges(GetItemOfTypeFromUnitBJ(GetEnumUnit(), 'I05W')) < 7 ) ) then
        return false
    endif
    return true
endfunction

function Trig_Lunchbox_Collecting_Func025A takes nothing returns nothing
    if ( Trig_Lunchbox_Collecting_Func025Func001C() ) then
        call SetItemCharges( GetItemOfTypeFromUnitBJ(GetEnumUnit(), 'I05W'), ( GetItemCharges(GetItemOfTypeFromUnitBJ(GetEnumUnit(), 'I05W')) + 1 ) )
    else
        if ( Trig_Lunchbox_Collecting_Func025Func001Func001C() ) then
            call SetItemCharges( GetItemOfTypeFromUnitBJ(GetEnumUnit(), 'I03G'), ( GetItemCharges(GetItemOfTypeFromUnitBJ(GetEnumUnit(), 'I03G')) + 1 ) )
        else
            if ( Trig_Lunchbox_Collecting_Func025Func001Func001Func002C() ) then
                call SetItemCharges( GetItemOfTypeFromUnitBJ(GetEnumUnit(), 'I033'), ( GetItemCharges(GetItemOfTypeFromUnitBJ(GetEnumUnit(), 'I033')) + 1 ) )
            else
                if ( Trig_Lunchbox_Collecting_Func025Func001Func001Func002Func002C() ) then
                    call SetItemCharges( GetItemOfTypeFromUnitBJ(GetEnumUnit(), 'I02Z'), ( GetItemCharges(GetItemOfTypeFromUnitBJ(GetEnumUnit(), 'I02Z')) + 1 ) )
                else
                    call DoNothing(  )
                endif
            endif
        endif
    endif
endfunction

function Trig_Lunchbox_Collecting_Actions takes nothing returns nothing
    set udg_SK_TempLocation = GetUnitLoc(GetTriggerUnit())
    set bj_wantDestroyGroup = true
    call ForGroupBJ( GetUnitsInRangeOfLocMatching(1500.00, udg_SK_TempLocation, Condition(function Trig_Lunchbox_Collecting_Func025001003)), function Trig_Lunchbox_Collecting_Func025A )
    call RemoveLocation(udg_SK_TempLocation)
endfunction

//===========================================================================
function InitTrig_Lunchbox_Collecting takes nothing returns nothing
    set gg_trg_Lunchbox_Collecting = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Lunchbox_Collecting, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Lunchbox_Collecting, Condition( function Trig_Lunchbox_Collecting_Conditions ) )
    call TriggerAddAction( gg_trg_Lunchbox_Collecting, function Trig_Lunchbox_Collecting_Actions )
endfunction

//===========================================================================
// Trigger: ChuShou
//
// A01S 制造触手围殴目标的技能ID
// n00H 触须
// n00I 缠绕效果
// I00W 物品5数据ID
// n001 无形施法单位 2秒
//===========================================================================
//TESH.scrollpos=21
//TESH.alwaysfold=0
function ChuShou takes nothing returns boolean
    local integer i = 1
    local location p1
    local location p2
    local unit u
    if GetSpellAbilityId() == 'A01S' then//制造触手围殴目标的技能ID
        set p1 = GetUnitLoc(GetTriggerUnit())
        loop
            exitwhen i > 9
            set p2 = PolarProjectionBJ(p1,170,(40 * I2R(i)))
            set u = CreateUnitAtLoc(GetOwningPlayer(GetTriggerUnit()),'n00H',p2,40*i+180)
            call SetUnitAnimation(u,"birth")
            call UnitApplyTimedLife(u,'BTLF',9)
            call RemoveLocation(p2)
            set i = i + 1
        endloop
        call RemoveLocation(p1)
        set p1 = null
        set p2 = null
        set u = null
    endif
    return false
endfunction

function ChuShouTuoLi takes nothing returns nothing
    local real x
    local real y
    local unit u
    if IsUnitIllusion(GetAttacker()) then
        return
    endif
    if GetInventoryIndexOfItemType(GetAttacker(),'I00W')>0 then//物品5数据ID
        if GetRandomReal(0,100)<5.0 then
            set x = GetUnitX(GetTriggerUnit())
            set y = GetUnitY(GetTriggerUnit())
            set u = CreateUnit(GetOwningPlayer(GetAttacker()),'n00I',x,y,0)
            call UnitApplyTimedLife(u,'BTLF',2.0)
            set u = CreateUnit(GetOwningPlayer(GetAttacker()),'n001',x,y,0)
            call UnitAddAbility(u,'A03L')
            call IssueTargetOrder(u,"entanglingroots",GetTriggerUnit())
            set u = null
        endif
    endif
endfunction

function InitTrig_ChuShou takes nothing returns nothing
    set gg_trg_ChuShou = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(gg_trg_ChuShou,EVENT_PLAYER_UNIT_SPELL_EFFECT)
    call TriggerAddCondition(gg_trg_ChuShou,Condition(function ChuShou))
    set gg_trg_ChuShou = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(gg_trg_ChuShou,EVENT_PLAYER_UNIT_ATTACKED)
    call TriggerAddCondition(gg_trg_ChuShou,Condition(function ChuShouTuoLi))
endfunction

//===========================================================================
// Trigger: QiQiu
//
// I00I 气球
// A03M 冰霜护甲技能ID
// n001 无形施法单位
//===========================================================================
function QiQiu takes nothing returns nothing
    local real x
    local real y
    local unit u
    if GetItemTypeId(GetManipulatedItem()) == 'I00I' then//物品7
        set x = GetUnitX(GetTriggerUnit())
        set y = GetUnitY(GetTriggerUnit())
        set u = CreateUnit(GetOwningPlayer(GetTriggerUnit()),'n001',x,y,0)//一个不可见的辅助施法单位ID即可（非隐藏）
        call UnitAddAbility(u,'A03M')//冰霜护甲技能ID
        call IssueTargetOrder(u,"frostarmor",GetTriggerUnit())
        set u = null
    endif
endfunction

//===========================================================================
function InitTrig_QiQiu takes nothing returns nothing
    set gg_trg_QiQiu = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(gg_trg_QiQiu,EVENT_PLAYER_UNIT_USE_ITEM)
    call TriggerAddCondition(gg_trg_QiQiu, Condition(function QiQiu))
endfunction//===========================================================================
// Trigger: Peach
//===========================================================================
//TESH.scrollpos=92
//TESH.alwaysfold=0
//使一切数据重置，用于防止物品升级后可能发生的一些恶心事件
function RemoveSkill takes unit u returns nothing
    call UnitRemoveAbility(u,'A09S')//攻击速度每级15%的物品ID
    call UnitRemoveAbility(u,'A0R4')//攻击速度每级20%的物品ID
    call SaveInteger(udg_Hashtable,StringHash("Dam"+I2S(GetHandleId(u))),StringHash("SkillLevel"),0)
    call SaveReal(udg_Hashtable,StringHash("Dam"+I2S(GetHandleId(u))),StringHash("DamAll"),0)
    
    call DisplayTextToPlayer( GetOwningPlayer(u), 0, 0, "Cancel" )
    
    return
endfunction
//计时器到期后调用函数使一切重置,包括积累的伤害。
function TimerOut takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local unit u = LoadUnitHandle(udg_Hashtable,StringHash("Unit"+I2S(GetHandleId(t))),StringHash("u"))
    call PauseTimer(t)
    call DestroyTimer(t)
    call RemoveSkill(u)
    
    call DisplayTextToPlayer( GetOwningPlayer(u), 0, 0, "Finish" )
    
    set t = null
    set u = null
endfunction
//捕捉伤害并判断，然后增加攻击速度
function GetDamFunc takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local real damnow = GetEventDamage()
    local real damall = LoadReal(udg_Hashtable,StringHash("Dam"+I2S(GetHandleId(u))),StringHash("DamAll"))
    local integer lv = LoadInteger(udg_Hashtable,StringHash("Dam"+I2S(GetHandleId(u))),StringHash("SkillLevel"))
    local timer t = LoadTimerHandle(udg_Hashtable,StringHash("Timer"+I2S(GetHandleId(u))),StringHash("t"))
    if GetInventoryIndexOfItemType(u,'I04Q')>0 then//馆里猿数据ID
        if damnow > 0.00 then
            set damall = damall + damnow

            if damall > 200 then
                set damall = damall - 200
                set lv = lv + 1
                
                call DisplayTextToPlayer( GetOwningPlayer(u), 0, 0, "船勾暴击机率等级："+I2S(IMinBJ(8,lv)) )
                
                if lv == 1 then
                    call UnitAddAbility(u,'A0R4')
                else
                    call SetUnitAbilityLevel(u,'A0QB',IMinBJ(8,lv))
                endif
                call PauseTimer(t)
                call DestroyTimer(t)
                call FlushChildHashtable(udg_Hashtable,StringHash("Timer"+I2S(GetHandleId(u))))
                call FlushChildHashtable(udg_Hashtable,StringHash("Unit"+I2S(GetHandleId(t))))
                set t = CreateTimer()
                call TimerStart(t,12,false,function TimerOut)
                call SaveTimerHandle(udg_Hashtable,StringHash("Timer"+I2S(GetHandleId(u))),StringHash("t"),t)
                call SaveUnitHandle(udg_Hashtable,StringHash("Unit"+I2S(GetHandleId(t))),StringHash("u"),u)
            endif
            call SaveInteger(udg_Hashtable,StringHash("Dam"+I2S(GetHandleId(u))),StringHash("SkillLevel"),lv)
            call SaveReal(udg_Hashtable,StringHash("Dam"+I2S(GetHandleId(u))),StringHash("DamAll"),damall)
        endif
        
    elseif GetInventoryIndexOfItemType(u,'I00G')>0 then//桃子数据ID
        if damnow > 0.00 then
            set damall = damall + damnow
            if damall >= 200 then
                set damall = damall - 200
                set lv = lv + 1
                
                call DisplayTextToPlayer( GetOwningPlayer(u), 0, 0, "桃子加速等级："+I2S(IMinBJ(8,lv)) )
                
                if lv > 1 then
                    call SetUnitAbilityLevel(u,'A09S',IMinBJ(8,lv))
                else
                    call UnitAddAbility(u,'A09S')//攻击速度每级15%的物品ID
                endif
                call PauseTimer(t)
                call DestroyTimer(t)
                call FlushChildHashtable(udg_Hashtable,StringHash("Timer"+I2S(GetHandleId(u))))
                call FlushChildHashtable(udg_Hashtable,StringHash("Unit"+I2S(GetHandleId(t))))
                set t = CreateTimer()
                call TimerStart(t,12,false,function TimerOut)
                call SaveTimerHandle(udg_Hashtable,StringHash("Timer"+I2S(GetHandleId(u))),StringHash("t"),t)
                call SaveUnitHandle(udg_Hashtable,StringHash("Unit"+I2S(GetHandleId(t))),StringHash("u"),u)
            endif
            call SaveInteger(udg_Hashtable,StringHash("Dam"+I2S(GetHandleId(u))),StringHash("SkillLevel"),lv)
            call SaveReal(udg_Hashtable,StringHash("Dam"+I2S(GetHandleId(u))),StringHash("DamAll"),damall)
        endif
    endif
    set u = null
    set t = null
endfunction
//单位得到或者丢弃（包括卖商店里）物品1或者物品2都会使得所增加的攻击速度和所积累的伤害失效
function Unit_PickOrDropItem takes nothing returns nothing
    if GetItemTypeId(GetManipulatedItem()) == 'I00G' or GetItemTypeId(GetManipulatedItem()) == 'I04Q' then//'I00G'物品2数据ID，'I04Q'物品3数据ID
        call RemoveSkill(GetManipulatingUnit())
    endif
endfunction

function Trig_Peach_Register_Conditions takes nothing returns boolean
    if GetItemTypeId(GetManipulatedItem())!='I00G' and GetItemTypeId(GetManipulatedItem())!='I04Q' then
        return false
    endif
    return not LoadBoolean(udg_Hashtable,StringHash(I2S(GetHandleId(GetTriggerUnit()))+"Peach"),StringHash("R"))
endfunction

function Trig_Peach_Register takes nothing returns nothing
    local unit u = GetTriggerUnit()
    local trigger trg = CreateTrigger()
    local timer t = CreateTimer()

call DisplayTextToPlayer( GetOwningPlayer(u), 0, 0, "Register" )

    call TriggerRegisterUnitEvent(trg,u,EVENT_UNIT_DAMAGED)
    call TriggerAddCondition(trg,Condition( function GetDamFunc ))
    call SaveInteger(udg_Hashtable,StringHash("Dam"+I2S(GetHandleId(u))),StringHash("SkillLevel"),0)
    call SaveTimerHandle(udg_Hashtable,StringHash("Timer"+I2S(GetHandleId(u))),StringHash("t"),t)
    call SaveUnitHandle(udg_Hashtable,StringHash("Unit"+I2S(GetHandleId(t))),StringHash("u"),u)
    call SaveReal(udg_Hashtable,StringHash("Dam"+I2S(GetHandleId(u))),StringHash("DamAll"),0)
    call SaveBoolean(udg_Hashtable,StringHash(I2S(GetHandleId(u))+"Peach"),StringHash("R"),true)
    set trg = CreateTrigger()
    call TriggerRegisterUnitEvent(trg,u,EVENT_UNIT_PICKUP_ITEM)
    call TriggerRegisterUnitEvent(trg,u,EVENT_UNIT_DROP_ITEM)
    call TriggerAddCondition(trg,Condition( function Unit_PickOrDropItem ))
    set u = null
    set t = null
    set trg = null
endfunction

//===========================================================================
function InitTrig_Peach takes nothing returns nothing
    set gg_trg_Peach = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ(gg_trg_Peach,EVENT_PLAYER_UNIT_PICKUP_ITEM)
    call TriggerAddCondition(gg_trg_Peach,Condition( function Trig_Peach_Register_Conditions ))
    call TriggerAddAction( gg_trg_Peach, function Trig_Peach_Register )
endfunction//===========================================================================
// Trigger: Magic String
//
// A01J 绳子技能
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Magic_String_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A01J'
endfunction

function Trig_Magic_String_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht,task,0)
    local unit target = LoadUnitHandle(udg_ht,task,1)
    local lightning l = LoadLightningHandle(udg_ht,task,2)
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real oz
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local real tz
    local real d = SquareRoot(Pow(tx-ox,2)+Pow(ty-oy,2))
    local real a = Atan2(ty-oy,tx-ox)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    set oz = GetPositionZ(ox,oy) + GetUnitFlyHeight(caster) + 60
    set tz = GetPositionZ(tx,ty) + GetUnitFlyHeight(target) + 60
    if i>0 then
        call MoveLightningEx(l,false,ox,oy,oz,tx,ty,tz)
        if d>600 then
            set i = 1
        else
            if d>400 and IsMobileUnit(caster) then
                set ox = tx - 400.0*Cos(a)
                set oy = ty - 400.0*Sin(a)
                call SetUnitXYFly(caster,ox,oy)
            endif
        endif
        if IsUnitDeadBJ(caster) or IsUnitDeadBJ(caster) then
            set i = 1
        endif
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call SetUnitFlag(caster,CS_DRAG(),false)
        call DestroyLightning(l)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set l = null
    set caster = null
    set target = null
endfunction

function Trig_Magic_String_Actions takes nothing returns nothing
    local timer t
    local integer task
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local lightning l
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real oz
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    local real tz
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set t = null
            set l = null
            set caster = null
            set target = null
            return
        endif
    endif
    //======== 
    set t = CreateTimer()
    set task = GetHandleId(t)
    set oz = GetPositionZ(ox,oy) + GetUnitFlyHeight(caster) + 60
    set tz = GetPositionZ(tx,ty) + GetUnitFlyHeight(target) + 60
    set l = AddLightningEx("LEAS",false,ox,oy,oz,tx,ty,tz)
    call SaveUnitHandle(udg_ht,task,0,caster)
    call SaveUnitHandle(udg_ht,task,1,target)
    call SaveLightningHandle(udg_ht,task,2,l)
    call SaveInteger(udg_ht,task,1,350)
    call SetUnitFlag(caster,CS_DRAG(),true)
    call TimerStart(t,0.02,true,function Trig_Magic_String_Main)
    //========
    set t = null
    set l = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Magic_String takes nothing returns nothing
    set gg_trg_Magic_String = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Magic_String, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Magic_String, Condition( function Trig_Magic_String_Conditions ) )
    call TriggerAddAction( gg_trg_Magic_String, function Trig_Magic_String_Actions )
endfunction

//===========================================================================
// Trigger: Cirno Ball
//
// I00N 琪露诺完美间隙发生器
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Cirno_Ball_Conditions takes nothing returns boolean
    return GetItemTypeId(GetManipulatedItem()) == 'I00N'
endfunction

function Trig_Cirno_Ball_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local real px
    local real py
    local real d = GetRandomReal(300,700)
    local real a = GetRandomReal(0,360)
    set px = ox + d*CosBJ(a)
    set py = oy + d*SinBJ(a)
    call SetUnitPosition(caster,px,py)
    call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\NightElf\\Blink\\BlinkCaster.mdl",caster,"chest"))
    set caster = null
endfunction

//===========================================================================
function InitTrig_Cirno_Ball takes nothing returns nothing
    set gg_trg_Cirno_Ball = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Cirno_Ball, EVENT_PLAYER_UNIT_USE_ITEM )
    call TriggerAddCondition( gg_trg_Cirno_Ball, Condition( function Trig_Cirno_Ball_Conditions ) )
    call TriggerAddAction( gg_trg_Cirno_Ball, function Trig_Cirno_Ball_Actions )
endfunction

//===========================================================================
// Trigger: XinHua
//
// A02Y 新华增援
// h00J 业务员
// n001 无形施法单位1秒
//===========================================================================
//TESH.scrollpos=21
//TESH.alwaysfold=0
function Trig_XinHua_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A02Y'
endfunction

function Trig_XinHua_UnitID takes nothing returns boolean
    if GetUnitTypeId(GetFilterUnit())!='h00J' then
        return false
    endif
    return GetUnitState(GetFilterUnit(),UNIT_STATE_LIFE)>0
endfunction

function Trig_XinHua_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,StringHash("caster"))
    local group g = CreateGroup()
    local boolexpr f = Filter(function Trig_XinHua_UnitID)
    local unit u
    local unit v
    //========
    call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(caster),f)
    set u = FirstOfGroup(g)
    if u!=null then
        loop
            set u = FirstOfGroup(g)
            exitwhen u==null
            call GroupRemoveUnit(g,u)
            if GetRandomReal(0,90)<=1.0 then
                set v = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(u),GetUnitY(u),0)
                //call UnitAddAbility(v,'A03O')
                //call IssueImmediateOrder(v,"stomp")
                call UnitAddAbility(v,'A0HY')
                call IssuePointOrder(v,"clusterrockets",GetUnitX(u),GetUnitY(u))
            endif
        endloop
    else
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,task)
    endif
    //========
    call DestroyGroup(g)
    call DestroyBoolExpr(f)
    set t = null
    set caster = null
    set g = null
    set f = null
    set u = null
    set v = null
endfunction

function Trig_XinHua_Actions takes nothing returns nothing
    local timer t
    local integer task
    local unit caster = GetTriggerUnit()
    local group g = CreateGroup()
    local boolexpr f = Filter(function Trig_XinHua_UnitID)
    //========
    call GroupEnumUnitsOfPlayer(g,GetOwningPlayer(caster),f)
    if FirstOfGroup(g)==null then
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveUnitHandle(udg_Hashtable,task,StringHash("caster"),caster)
        call TimerStart(t,0.1,true,function Trig_XinHua_Main)
    endif
    call DestroyGroup(g)
    call DestroyBoolExpr(f)
    //========
    set t = null
    set g = null
    set f = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_XinHua takes nothing returns nothing
    set gg_trg_XinHua = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_XinHua, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_XinHua, Condition( function Trig_XinHua_Conditions ) )
    call TriggerAddAction( gg_trg_XinHua, function Trig_XinHua_Actions )
endfunction//===========================================================================
// Trigger: BaGuaLu
//===========================================================================
//TESH.scrollpos=21
//TESH.alwaysfold=0
function Trig_BaGuaLu_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A00N'
endfunction

function Trig_BaGuaLu_Remove takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_Hashtable,task,StringHash("caster"))
    local effect e = LoadEffectHandle(udg_Hashtable,task,StringHash("e"))
    call SetUnitState(caster,UNIT_STATE_MANA,0.0)
    call UnitRemoveAbility(caster,'A03Q')
    call UnitRemoveAbility(caster,'A03P')
    call DestroyEffect(e)
    call DestroyTimer(t)
    call FlushChildHashtable(udg_Hashtable,task)
    //========
    set t = null
    set caster = null
    set e = null
endfunction

function Trig_BaGuaLu_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit caster = GetTriggerUnit()
    local effect e
    //========
    set e = AddSpecialEffectTarget("Abilities\\Spells\\Other\\ImmolationRed\\ImmolationRedTarget.mdl",caster,"chest")
    call UnitAddAbility(caster,'A03Q')
    call UnitAddAbility(caster,'A03P')
    call UnitMakeAbilityPermanent(caster,true,'A03Q')
    call UnitMakeAbilityPermanent(caster,true,'A03P')
    //--------
    call SaveUnitHandle(udg_Hashtable,task,StringHash("caster"),caster)
    call SaveEffectHandle(udg_Hashtable,task,StringHash("e"),e)
    call TimerStart(t,12,false,function Trig_BaGuaLu_Remove)
    //========
    set t = null
    set e = null
    set caster = null
endfunction

//===========================================================================
function InitTrig_BaGuaLu takes nothing returns nothing
    set gg_trg_BaGuaLu = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_BaGuaLu, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_BaGuaLu, Condition( function Trig_BaGuaLu_Conditions ) )
    call TriggerAddAction( gg_trg_BaGuaLu, function Trig_BaGuaLu_Actions )
endfunction//===========================================================================
// Trigger: YukkuriUpgrade
//
// A03G馒头升级
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_YukkuriUpgrade_Conditions takes nothing returns boolean
    if GetSpellAbilityId() != 'A03G' then
        return false
    endif
    if GetPlayerState(GetTriggerPlayer(),PLAYER_STATE_RESOURCE_GOLD) < 175 then
        call DisplayTextToPlayer(GetTriggerPlayer(),0,0,"|cffff0000金币不足！|r")
        return false
    endif
    return true
endfunction

function Trig_YukkuriUpgrade_Actions takes nothing returns nothing
    local unit u = GetSpellAbilityUnit()
    local unit new = null
    local player p = GetOwningPlayer(u)
    local integer i
    local item it = null
    local real x = GetUnitX(u)
    local real y = GetUnitY(u)
    call ShowUnit(u, false)
    set new = CreateUnit(p, 'h00I', x, y, GetUnitFacing(u))
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Items\\AIem\\AIemTarget.mdl", x, y))
    set i = 0
    loop
        set it = UnitItemInSlot(u,i)
        if it != null then
            call UnitRemoveItem(u,it)
            call UnitAddItem(new,it)
        endif
        set i = i + 1
        exitwhen i >= bj_MAX_INVENTORY
    endloop
    call SetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD,GetPlayerState(p,PLAYER_STATE_RESOURCE_GOLD) - 175)
    call RemoveUnit(u)
    set u = null
    set new = null
    set p = null
    set it = null
endfunction

//===========================================================================
function InitTrig_YukkuriUpgrade takes nothing returns nothing
    set gg_trg_YukkuriUpgrade = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_YukkuriUpgrade, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_YukkuriUpgrade, Condition( function Trig_YukkuriUpgrade_Conditions ) )
    call TriggerAddAction( gg_trg_YukkuriUpgrade,function Trig_YukkuriUpgrade_Actions )
endfunction

//===========================================================================
// Trigger: HuDieMengWan
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_HuDieMengWan_Conditions takes nothing returns boolean
    local integer d = GetItemTypeId(GetManipulatedItem())
    return ('I04E'<=d) and (d<='I04H')
endfunction

function Trig_HuDieMengWan_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local real ox = GetUnitX(caster)
    local real oy = GetUnitY(caster)
    local integer level = GetItemTypeId(GetManipulatedItem()) - 'I04E' + 1
    local unit u = CreateUnit(GetOwningPlayer(caster),'n001',ox,oy,0)
    //净化效果
    call UnitRemoveBuffs(caster,false,true)
    call UnitRemoveAbility(caster,'B009')
    //衣玖加速取消
    if GetUnitAbilityLevel(caster,'B00S')>0 then
        call UnitRemoveAbility(caster,'B00S')
        call UnitRemoveAbility(caster,'B01T')
    endif
    //加速效果
    call UnitAddAbility(u,'A03S')
    call SetUnitAbilityLevel(u,'A03S',level)
    call IssueTargetOrder(u,"bloodlust",caster)
    set caster = null
    set u = null
endfunction

//===========================================================================
function InitTrig_HuDieMengWan takes nothing returns nothing
    set gg_trg_HuDieMengWan = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_HuDieMengWan, EVENT_PLAYER_UNIT_USE_ITEM )
    call TriggerAddCondition( gg_trg_HuDieMengWan, Condition( function Trig_HuDieMengWan_Conditions ) )
    call TriggerAddAction( gg_trg_HuDieMengWan, function Trig_HuDieMengWan_Actions )
endfunction

//===========================================================================
// Trigger: Hourai Elixir
//
// I048 蓬莱之药 1级
// B00B 蓬莱制药Buff
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_Hourai_Elixir_Conditions takes nothing returns boolean
    local integer d = GetItemTypeId(GetManipulatedItem())
    return ('I03C'<=d)and(d<='I03E')
endfunction

function Trig_Hourai_Elixir_Active takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local timer t
    local trigger trg
    if GetTriggerEventId()==EVENT_UNIT_DAMAGED then
        if GetUnitAbilityLevel(caster,'B00B')>0 and GetUnitAbilityLevel(caster,'A0MM')==0 then
            if GetEventDamage()<(GetUnitState(caster,UNIT_STATE_LIFE) - 50.0) then
                set caster = null
                set t = null
                set trg = null
                return
            endif
            //call TSU_SetUnitInvulnerable(caster,0.0)
            call SetUnitState(caster,UNIT_STATE_LIFE,GetUnitState(caster,UNIT_STATE_MAX_LIFE))
            call DestroyEffect(AddSpecialEffectTarget("Abilities\\Spells\\Human\\Resurrect\\ResurrectTarget.mdl",caster,"origin"))
        endif
        set trg = GetTriggeringTrigger()
        set t = LoadTimerHandle(udg_ht,GetHandleId(trg),0)
    else
        set trg = GetTriggeringTrigger()
        set t = GetExpiredTimer()
    endif
    call DebugMsg("蓬莱之药效果结束")
    call UnitRemoveAbility(caster,'B00B')
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,GetHandleId(trg),1))
    call DestroyTrigger(trg)
    call DestroyTimer(t)
    //========
    set caster = null
    set trg = null
    set t = null
endfunction

function Trig_Hourai_Elixir_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level
    local integer d
    local timer t = CreateTimer()
    local trigger trg
    local triggeraction tga
    //========
    set level = GetItemTypeId(GetManipulatedItem()) - 'I03C' + 1
    if level == 1 then
        set d = 270
    elseif level == 2 then
        set d = 380
    else
        set d = 530
    endif
    call DebugMsg("蓬莱之药等级 "+I2S(level))
    call SetUnitState(caster,UNIT_STATE_LIFE,d + GetUnitState(caster,UNIT_STATE_LIFE))
    call TimerStart(t,3.0+2.0*level,false,null)
    set trg = CreateTrigger()
    call TriggerRegisterTimerExpireEvent(trg,t)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_DAMAGED)
    set tga = TriggerAddAction(trg,function Trig_Hourai_Elixir_Active)
    call SaveTimerHandle(udg_ht,GetHandleId(trg),0,t)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    //========
    set caster = null
    set trg = null
    set tga = null
    set t = null
endfunction

//===========================================================================
function InitTrig_Hourai_Elixir takes nothing returns nothing
    set gg_trg_Hourai_Elixir = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Hourai_Elixir, EVENT_PLAYER_UNIT_USE_ITEM )
    call TriggerAddCondition( gg_trg_Hourai_Elixir, Condition( function Trig_Hourai_Elixir_Conditions ) )
    call TriggerAddAction( gg_trg_Hourai_Elixir, function Trig_Hourai_Elixir_Actions )
endfunction//===========================================================================
// Trigger: Hourai Elixir Drop
//===========================================================================
function Trig_Hourai_Elixir_Drop_Func007C takes nothing returns boolean
    if ( ( UnitHasItemOfTypeBJ(GetTriggerUnit(), 'I03C') == true ) ) then
        return true
    endif
    if ( ( UnitHasItemOfTypeBJ(GetTriggerUnit(), 'I03D') == true ) ) then
        return true
    endif
    if ( ( UnitHasItemOfTypeBJ(GetTriggerUnit(), 'I03E') == true ) ) then
        return true
    endif
    return false
endfunction

function Trig_Hourai_Elixir_Drop_Conditions takes nothing returns boolean
    if ( not Trig_Hourai_Elixir_Drop_Func007C() ) then
        return false
    endif
    return true
endfunction

function Trig_Hourai_Elixir_Drop_Actions takes nothing returns nothing
    call SetItemCharges( GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I03C'), 0 )
    call RemoveItem( GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I03C') )
    call SetItemCharges( GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I03D'), 0 )
    call RemoveItem( GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I03D') )
    call SetItemCharges( GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I03E'), 0 )
    call RemoveItem( GetItemOfTypeFromUnitBJ(GetTriggerUnit(), 'I03E') )
endfunction

//===========================================================================
function InitTrig_Hourai_Elixir_Drop takes nothing returns nothing
    set gg_trg_Hourai_Elixir_Drop = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Hourai_Elixir_Drop, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_Hourai_Elixir_Drop, Condition( function Trig_Hourai_Elixir_Drop_Conditions ) )
    call TriggerAddAction( gg_trg_Hourai_Elixir_Drop, function Trig_Hourai_Elixir_Drop_Actions )
endfunction

//===========================================================================
// Trigger: WoCao2KuangCao
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_WoCao2KuangCao_Conditions takes nothing returns boolean
    return GetItemTypeId(GetManipulatedItem()) == 'I031'
endfunction

function Trig_WoCao2KuangCao_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local item km = CreateItem('I038', GetUnitX(caster), GetUnitY(caster))

    call THD_SetItemOwner(km,GetOwningPlayer(caster))
    call ChangeUnitItem(caster, 6, GetManipulatedItem(), km)
    set caster = null
    set km = null
endfunction

//===========================================================================
function InitTrig_WoCao2KuangCao takes nothing returns nothing
    set gg_trg_WoCao2KuangCao = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_WoCao2KuangCao, EVENT_PLAYER_UNIT_USE_ITEM )
    call TriggerAddCondition( gg_trg_WoCao2KuangCao, Condition( function Trig_WoCao2KuangCao_Conditions ) )
    call TriggerAddAction( gg_trg_WoCao2KuangCao, function Trig_WoCao2KuangCao_Actions )
endfunction//===========================================================================
// Trigger: KuangCao2WoCao
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function Trig_KuangCao2WoCao_Conditions takes nothing returns boolean
    return GetItemTypeId(GetManipulatedItem()) == 'I038' 
endfunction

function Trig_KuangCao2WoCao_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local item wm = CreateItem('I031', GetUnitX(caster), GetUnitY(caster))

    call THD_SetItemOwner(wm,GetOwningPlayer(caster))
    call ChangeUnitItem(caster, 6, GetManipulatedItem(), wm)
    set caster = null
    set wm = null
endfunction

//===========================================================================
function InitTrig_KuangCao2WoCao takes nothing returns nothing
    set gg_trg_KuangCao2WoCao = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_KuangCao2WoCao, EVENT_PLAYER_UNIT_USE_ITEM )
    call TriggerAddCondition( gg_trg_KuangCao2WoCao, Condition( function Trig_KuangCao2WoCao_Conditions ) )
    call TriggerAddAction( gg_trg_KuangCao2WoCao, function Trig_KuangCao2WoCao_Actions )
endfunction

//===========================================================================
// Trigger: KuangCaoManaCost
//===========================================================================
//TESH.scrollpos=0
//TESH.alwaysfold=0
function KuangCaoManaCost takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit caster = LoadUnitHandle(udg_ht, task, 1)
    local item km = LoadItemHandle(udg_ht, task, 2)
    local real mana
    local boolean flag = IsUnitOwnedItem(caster, km)
    local item wm

    set mana = 0.03*GetUnitState(caster,UNIT_STATE_MAX_MANA)
    set mana = GetUnitState(caster,UNIT_STATE_MANA) - 0.1*mana
if IsUnitType(caster,UNIT_TYPE_DEAD) == false then
    if mana<=0 or flag == false then
        if flag then
            set wm = CreateItem('I031', GetUnitX(caster), GetUnitY(caster))
            call THD_SetItemOwner(wm,GetOwningPlayer(caster))
            call ChangeUnitItem(caster, 6, km, wm)
        endif
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht, task)
    else
        call SetUnitState(caster,UNIT_STATE_MANA,RMaxBJ(0.0,mana))
    endif
endif
    set t = null
    set caster = null
    set km = null
    set wm = null
endfunction

function Trig_KuangCaoManaCost_Conditions takes nothing returns boolean
    return GetItemTypeId(GetManipulatedItem()) == 'I038'
endfunction

function Trig_KuangCaoManaCost_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)

    call SaveUnitHandle(udg_ht, task, 1, GetTriggerUnit())
    call SaveItemHandle(udg_ht, task, 2, GetManipulatedItem())
    call SaveTimerHandle(udg_ht, task, 0, t)
    call TimerStart(t, 0.1, true, function KuangCaoManaCost)
    set t = null
endfunction

//===========================================================================
function InitTrig_KuangCaoManaCost takes nothing returns nothing
    set gg_trg_KuangCaoManaCost = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_KuangCaoManaCost, EVENT_PLAYER_UNIT_PICKUP_ITEM )
    call TriggerAddCondition( gg_trg_KuangCaoManaCost, Condition( function Trig_KuangCaoManaCost_Conditions ) )
    call TriggerAddAction( gg_trg_KuangCaoManaCost, function Trig_KuangCaoManaCost_Actions )
endfunction

//===========================================================================
// Trigger: LvBaHuaJiHuHang
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_LvBaHuaJiHuHang_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0AP'
endfunction

function Trig_LvBaHuaJiHuHang_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local location loc = GetUnitLoc(caster)
    local unit u
    set u = CreateUnitAtLoc( GetOwningPlayer(caster), 'n001', loc, 0 )
    call UnitAddAbility( u ,'A0AO')
    call IssueTargetOrder( u , "antimagicshell", caster )
    call RemoveLocation( loc )
    set caster = null
    set loc = null
    set u = null
endfunction

//===========================================================================
function InitTrig_LvBaHuaJiHuHang takes nothing returns nothing
    set gg_trg_LvBaHuaJiHuHang = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_LvBaHuaJiHuHang, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_LvBaHuaJiHuHang, Condition( function Trig_LvBaHuaJiHuHang_Conditions ) )
    call TriggerAddAction( gg_trg_LvBaHuaJiHuHang, function Trig_LvBaHuaJiHuHang_Actions )
endfunction

//===========================================================================
// Trigger: Mr Yang
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 删除减少的智力在HeroEvent触发的Hero Recovery函数里
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
//原来的电疗 放自己人也会减智力 现在的不会
//原来的电疗 对方出了bl 无净化效果 有减少智力效果 现在减少智力效果也会抵抗
//貌似净化的buff是有延迟 直接触效果后直接检测buff判断不行。。。所以做了个0.01秒的延时。。。

function Trig_Mr_Yang_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A062'
endfunction

function IQ takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit target = LoadUnitHandle( udg_Hashtable,task,1 )
    call UnitRemoveAbility(target,'A0A1')
    call FlushChildHashtable( udg_Hashtable,task )
    call PauseTimer(t)
    call DestroyTimer(t)
    set t = null
    set target = null
endfunction

function Trig_Mr_Yang_Actions takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit target = LoadUnitHandle(udg_Hashtable,task,1)
    if IsUnitType(target,UNIT_TYPE_DEAD)==false and GetUnitTypeId(target) != 'E009' then
        call UnitAddAbility(target,'A0A1')
        call TimerStart(t,6.00,false,function IQ)
    else
        call FlushChildHashtable( udg_Hashtable,task )
        call PauseTimer(t)
        call DestroyTimer(t)
    endif
    set t = null
    set target = null
endfunction

function Trig_Mr_Yang_Start takes nothing returns nothing
    local timer t
    local integer task
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit w
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set t = null
            set caster = null
            set target = null
            set w = null
            return
        endif
    endif
    //========
    set w = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0.0)
    call UnitAddAbility(w,'A0AZ')
    call IssueTargetOrder(w,"purge",target)
    set t = CreateTimer()
    set task = GetHandleId(t)
    call SaveTimerHandle( udg_Hashtable,task,0,t )
    call SaveUnitHandle( udg_Hashtable,task,1,target )
    call TimerStart(t,0.01,false,function Trig_Mr_Yang_Actions)
    set t = null
    set caster = null
    set target = null
    set w = null
endfunction

//===========================================================================
function InitTrig_Mr_Yang takes nothing returns nothing
    set gg_trg_Mr_Yang = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Mr_Yang, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Mr_Yang, Condition( function Trig_Mr_Yang_Conditions ) )
    call TriggerAddAction( gg_trg_Mr_Yang, function Trig_Mr_Yang_Start )
endfunction//===========================================================================
// Trigger: Jinkela
//===========================================================================
function Trig_Jinkela_Conditions takes nothing returns boolean
    if ( not ( GetSpellAbilityId() == 'A0B1' ) ) then
        return false
    endif
    return true
endfunction

function Trig_Jinkela_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local location loc = GetUnitLoc(caster)
    local unit u = CreateUnitAtLoc(GetOwningPlayer(caster),'n001',loc,0)
    call UnitAddAbility(u,'A0B2')
    call IssueImmediateOrder( u , "roar" )
    call RemoveLocation(loc)
    set caster = null
    set loc = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Jinkela takes nothing returns nothing
    set gg_trg_Jinkela = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Jinkela, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Jinkela, Condition( function Trig_Jinkela_Conditions ) )
    call TriggerAddAction( gg_trg_Jinkela, function Trig_Jinkela_Actions )
endfunction//===========================================================================
// Trigger: XiongGui
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_XiongGui_Conditions takes nothing returns boolean
    return GetUnitTypeId(GetSummonedUnit())=='n01X'
endfunction

function Trig_XiongGui_loli_Conditions takes nothing returns boolean
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_Hashtable,task,1)
    local boolean b = (IsUnitAlly(GetFilterUnit(),GetOwningPlayer(u)) == false)
    if GetUnitAbilityLevel(GetFilterUnit(),'B04B') >= 1 then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'BOvc') >= 1 then
        return false
    endif
    set t = null
    set u = null
    return b
endfunction

function Trig_XiongGui_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local unit u = LoadUnitHandle(udg_Hashtable,task,1)
    local integer i = LoadInteger(udg_Hashtable,task,2)
    local location loc = GetUnitLoc(u)
    local group loli = GetUnitsInRangeOfLocMatching(350,loc,Condition(function Trig_XiongGui_loli_Conditions))
    call RemoveLocation(loc)
    if IsUnitAliveBJ(u) then
        call GroupTargetOrder(loli,"attack",u)
    else
        set i = 0
    endif
    call DestroyGroup(loli)
    //if ModuloInteger(i,10)==0 then
    //    call IssueImmediateOrder(u,"thunderclap")
    //endif
    set i = i - 1
    if i <= 0 then
        call PauseTimer(t)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_Hashtable,task)
    else
        call SaveInteger(udg_Hashtable,task,2,i)
    endif
    set t = null
    set u = null
    set loli = null
    set loc = null
endfunction

function Trig_XiongGui_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    local unit u = GetSummonedUnit()
    call SaveUnitHandle(udg_Hashtable,task,1,u)
    call SaveInteger(udg_Hashtable,task,2,20)
    call TimerStart(t,0.2,true,function Trig_XiongGui_Main)
    set t = null
    set u = null
endfunction

//===========================================================================
function InitTrig_XiongGui takes nothing returns nothing
    set gg_trg_XiongGui = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_XiongGui, EVENT_PLAYER_UNIT_SUMMON )
    call TriggerAddCondition( gg_trg_XiongGui, Condition( function Trig_XiongGui_Conditions ) )
    call TriggerAddAction( gg_trg_XiongGui, function Trig_XiongGui_Actions )
endfunction
//===========================================================================
// Trigger: Yukkuri Morph
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_Yukkuri_Morph_Conditions takes nothing returns boolean
    if GetSpellAbilityId() != 'A0G4' then
        return false
    endif
    if GetUnitFlag(GetSpellTargetUnit(),CS_FROZEN()) then
        return false
    endif
    if IsUnitAntiDebuff(GetSpellTargetUnit()) then
        return false
    endif
    return true
endfunction

function Trig_Yukkuri_Morph_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit u
    local real tx = GetUnitX(target)
    local real ty = GetUnitY(target)
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set u = null
            return
        endif
    endif
    //======== 
    set u = CreateUnit(GetOwningPlayer(caster),GPSU(),tx,ty,0.0)
    call UnitAddAbility(u,'A01K')
    call PreMorphReset(target)
    call IssueTargetOrder(u,"polymorph",target)
    //========
    set caster = null
    set target = null
    set u = null
endfunction

//===========================================================================
function InitTrig_Yukkuri_Morph takes nothing returns nothing
    set gg_trg_Yukkuri_Morph = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Yukkuri_Morph, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Yukkuri_Morph, Condition( function Trig_Yukkuri_Morph_Conditions ) )
    call TriggerAddAction( gg_trg_Yukkuri_Morph, function Trig_Yukkuri_Morph_Actions )
endfunction

//===========================================================================
// Trigger: DaoYao
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_DaoYao_Conditions takes nothing returns boolean
    local unit caster = GetAttacker()
    if GetUnitAbilityLevel(caster,'A0GQ')>0 and IsUnitIllusion(caster)==false then
        if GetUnitAbilityLevel(caster,'A0GM')==0 then
            call UnitAddAbility(caster,'A0GM')
        endif
    else
        if GetUnitAbilityLevel(caster,'A0GM')>=0 then
            call UnitRemoveAbility(caster,'A0GM')
        endif
    endif
    set caster = null
    return false
endfunction

function Trig_DaoYao_Actions takes nothing returns nothing
endfunction

//===========================================================================
function InitTrig_DaoYao takes nothing returns nothing
    set gg_trg_DaoYao = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_DaoYao, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_DaoYao, Condition( function Trig_DaoYao_Conditions ) )
    //call TriggerAddAction( gg_trg_DaoYao, function Trig_DaoYao_Actions )
endfunction
//===========================================================================
// Trigger: DaJiangYou
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_DaJiangYou_Conditions takes nothing returns boolean
    local integer d = GetItemTypeId(GetManipulatedItem())
    return ('I04U'<=d) and (d<='I04Z')
endfunction

function Trig_DaJiangYou_Speed takes nothing returns nothing
    local integer task = GetHandleId(GetExpiredTimer())
    local integer level = LoadInteger(udg_ht,task,0)
    local unit u = GetEnumUnit()
    local real a = GetUnitDefaultMoveSpeed(u)
    local real s = GetUnitMoveSpeed(u)
    local real d = LoadReal(udg_ht,task,GetHandleId(u))
    if GetUnitAbilityLevel(u,'B049')>0 and not IsUnitMorphed(u) then
        set d = (330.0 + 30.0*level) - s + d
        call SetUnitMoveSpeed(u,a + d)
        call SaveReal(udg_ht,task,GetHandleId(u),d)
    else
        call SetUnitMoveSpeed(u,a)
    endif
    set u = null
endfunction

function Trig_DaJiangYou_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local group g = LoadGroupHandle(udg_ht,task,0)
    local integer i = LoadInteger(udg_ht,task,1)
    //========
    if i>=0 then
        call ForGroup(g,function Trig_DaJiangYou_Speed)
        call SaveInteger(udg_ht,task,1,i - 1)
    else
        call DestroyGroup(g)
        call DestroyTimer(t)
        call FlushChildHashtable(udg_ht,task)
    endif
    //========
    set t = null
    set g = null
endfunction

function Trig_DaJiangYou_Target takes nothing returns boolean
    return IsUnitAlive(GetFilterUnit()) and IsUnitAlly(GetFilterUnit(),GetOwningPlayer(GetTriggerUnit()))
endfunction

function Trig_DaJiangYou_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer level = GetItemTypeId(GetManipulatedItem()) - 'I04U' + 1
    local timer t
    local group g
    local boolexpr f
    //========
    call SetUnitAbilityLevel(caster,'A0I0',level)
    call SetUnitAbilityLevel(caster,'A0I3',level)//智力
    if GetTriggerEventId()==EVENT_PLAYER_UNIT_USE_ITEM then
        set t = CreateTimer()
        set g = CreateGroup()
        set f = Filter(function Trig_DaJiangYou_Target)
        call GroupEnumUnitsInRange(g,GetUnitX(caster),GetUnitY(caster),600.0,f)
        call DestroyBoolExpr(f)
        call SaveGroupHandle(udg_ht,GetHandleId(t),0,g)
        call SaveInteger(udg_ht,GetHandleId(t),0,level)
        call SaveInteger(udg_ht,GetHandleId(t),1,(level + 3)*50 + 10)
        call TimerStart(t,0.02,true,function Trig_DaJiangYou_Main)
        call DebugMsg("路过打酱油 等级 "+I2S(level))
    endif
    //========
    set caster = null
    set t = null
    set g = null
    set f = null
endfunction

//===========================================================================
function InitTrig_DaJiangYou takes nothing returns nothing
    set gg_trg_DaJiangYou = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_DaJiangYou, EVENT_PLAYER_UNIT_PICKUP_ITEM )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_DaJiangYou, EVENT_PLAYER_UNIT_USE_ITEM )
    call TriggerAddCondition( gg_trg_DaJiangYou, Condition( function Trig_DaJiangYou_Conditions ) )
    call TriggerAddAction( gg_trg_DaJiangYou, function Trig_DaJiangYou_Actions )
endfunction
//===========================================================================
// Trigger: TuPao
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_TuPao_Conditions takes nothing returns boolean
    if GetItemTypeId(GetManipulatedItem())!='I00L' then
        return false
    endif
    return IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO)
endfunction

function Trig_TuPao_Actions takes nothing returns nothing
    local unit h = GetTriggerUnit()
    local integer a
    local integer b = DB_GetHeroTypeData(GetUnitTypeId(h),DB_HERO_MULTIPLE_ATTACK())
    if b==0 or b == 'A0K1' then
        //近战分裂攻击直接添加在物品内 远程无效(避免恋等变身英雄错误)
        //set a = 'A0K0'
        //set b = 'A0K1'
    else
        //远程弹幕攻击
        set a = b - 1
        if GetTriggerEventId()==EVENT_PLAYER_UNIT_PICKUP_ITEM then
        call UnitAddAbility(h,b)
        call UnitMakeAbilityPermanent(h,true,b)
        call UnitMakeAbilityPermanent(h,true,a)
        else
        call UnitRemoveAbility(h,b)
        endif
    endif
    set h = null
endfunction

//===========================================================================
function InitTrig_TuPao takes nothing returns nothing
    set gg_trg_TuPao = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_TuPao, EVENT_PLAYER_UNIT_PICKUP_ITEM )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_TuPao, EVENT_PLAYER_UNIT_DROP_ITEM )
    call TriggerAddCondition( gg_trg_TuPao, Condition( function Trig_TuPao_Conditions ) )
    call TriggerAddAction( gg_trg_TuPao, function Trig_TuPao_Actions )
endfunction
//===========================================================================
// Trigger: Kafziel
//===========================================================================
//TESH.scrollpos=60
//TESH.alwaysfold=0
function Trig_Kafziel_Conditions takes nothing returns boolean
    local real k
    if UnitHasItemOfTypeBJ(GetAttacker(),'I04D') != true then
        return false
    endif
    if IsUnitAlly(GetAttackedUnitBJ(),GetOwningPlayer(GetAttacker())) then
        return false
    endif
    if IsUnitType(GetAttackedUnitBJ(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if IsUnitIllusionBJ(GetAttacker()) then
        return false
    endif
    if IsUnitType(GetAttacker(),UNIT_TYPE_RANGED_ATTACKER) == true then
        set k = 10.0
    else
        set k = 0
    endif
    return GetRandomReal(0,100.0) < 25 - k
endfunction

function Trig_Kafziel_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local real k1
    local real r1
    local real damage
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        //call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        //call DestroyTrigger(trg)
        //call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        return
    endif
    set target = GetTriggerUnit()
    //========
    call DisableTrigger(trg)
    //========
    set k1 = GetUnitState(caster,UNIT_STATE_LIFE)
    set r1 = GetUnitState(target,UNIT_STATE_LIFE)
    if k1 > r1 then
        set damage = (k1 - r1) * 0.13 + 20
    else
        set damage = 20
    endif
    call UnitDamageTargetHJ(caster,target,damage,0)
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\DeathCoil\\DeathCoilSpecialArt.mdl",GetUnitX(target),GetUnitY(target)))
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
endfunction

function Trig_Kafziel_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_Kafziel_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Kafziel takes nothing returns nothing
    set gg_trg_Kafziel = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Kafziel, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Kafziel, Condition( function Trig_Kafziel_Conditions ) )
    call TriggerAddAction( gg_trg_Kafziel, function Trig_Kafziel_Actions )
endfunction

//===========================================================================
// Trigger: Verity
//===========================================================================
//TESH.scrollpos=51
//TESH.alwaysfold=0
function Trig_Verity_Conditions takes nothing returns boolean
    if UnitHasItemOfTypeBJ(GetAttacker(),'I05T') != true then
        return false
    endif
    if IsUnitAlly(GetAttackedUnitBJ(),GetOwningPlayer(GetAttacker())) then
        return false
    endif
    if IsUnitType(GetAttackedUnitBJ(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if IsUnitIllusionBJ(GetAttacker()) then
        return false
    endif
    return true
endfunction

function Trig_Verity_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local effect e
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        set e = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        //call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        //call DestroyTrigger(trg)
        //call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        set e = null
        return
    endif
    set target = GetTriggerUnit()
    //========
    call DisableTrigger(trg)
    //========
    call SetUnitState(target,UNIT_STATE_MANA,GetUnitState(target,UNIT_STATE_MANA)-GetUnitState(target,UNIT_STATE_MAX_MANA)*0.04)
    set e = AddSpecialEffect("Abilities\\Spells\\Human\\Feedback\\SpellBreakerAttack.mdl",GetUnitX(target),GetUnitY(target))
    if IsUnitType(caster,UNIT_TYPE_RANGED_ATTACKER) == true then
    else
        call UnitDamageTargetHJ(caster,target,(GetUnitState(target,UNIT_STATE_MAX_MANA)*0.04)*0.70,1)
        call DestroyEffect(e)
    endif
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
    set e = null
endfunction

function Trig_Verity_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_Verity_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Verity takes nothing returns nothing
    set gg_trg_Verity = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Verity, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Verity, Condition( function Trig_Verity_Conditions ) )
    call TriggerAddAction( gg_trg_Verity, function Trig_Verity_Actions )
endfunction

//===========================================================================
// Trigger: YYY
//===========================================================================
//TESH.scrollpos=16
//TESH.alwaysfold=0
function Trig_YYY_Conditions takes nothing returns boolean
    if UnitHasItemOfTypeBJ(GetKillingUnit(), 'I04T') != true then
        return false
    endif
    if IsUnitAlly(GetKillingUnit(),GetOwningPlayer(GetTriggerUnit())) then
        return false
    endif
    if GetUnitTypeId(GetTriggerUnit()) == 'n01Y' then
        return false
    endif
    return GetRandomReal(0,100.0) < 20.0
endfunction

function Trig_YYY_Clear takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local integer k = LoadInteger(udg_ht,task,0)
    set udg_SK_YYY[k] = 0
    call DestroyTimer(t)
    call FlushChildHashtable(udg_ht,task)
    set t = null
endfunction

function Trig_YYY_Actions takes nothing returns nothing
    local timer t
    local integer task
    local unit killer = GetKillingUnit()
    local unit dyer = GetTriggerUnit()
    local unit u1
    local unit u2
    local integer k = GetConvertedPlayerId(GetOwningPlayer(GetKillingUnit()))
    if udg_SK_YYY[k] == 0 then
        set u1 = CreateUnit(GetOwningPlayer(killer),'n001',GetUnitX(killer),GetUnitY(killer),0)
        set u2 = CreateUnit(GetOwningPlayer(dyer),'n01Y',GetUnitX(dyer),GetUnitY(dyer),0)
        call InstantKill(u1,u2)
        set udg_SK_YYY[k] = 1
        set t = CreateTimer()
        set task = GetHandleId(t)
        call SaveInteger(udg_ht,task,0,k)
        call TimerStart(t,1.00,false,function Trig_YYY_Clear)
    endif
    set t = null
    set killer = null
    set dyer = null
    set u1 = null
    set u2 = null
endfunction

//===========================================================================
function InitTrig_YYY takes nothing returns nothing
    set gg_trg_YYY = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_YYY, EVENT_PLAYER_UNIT_DEATH )
    call TriggerAddCondition( gg_trg_YYY, Condition( function Trig_YYY_Conditions ) )
    call TriggerAddAction( gg_trg_YYY, function Trig_YYY_Actions )
endfunction

//===========================================================================
// Trigger: CardWorseMan
//===========================================================================
function Trig_CardWorseMan_Conditions takes nothing returns boolean
    if ( not ( GetSpellAbilityId() == 'A0OR' ) ) then
        return false
    endif
    return true
endfunction

function Trig_CardWorseMan_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    call DestroyEffect(AddSpecialEffect("Abilities\\Spells\\Undead\\AnimateDead\\AnimateDeadTarget.mdl",GetUnitX(target),GetUnitY(target)))
    call UnitDamageTargetHJ(caster,target,100.00,0)
    call SetUnitState(target, UNIT_STATE_MANA,GetUnitState(target,UNIT_STATE_MANA)-100.00)
    call SetUnitState(caster, UNIT_STATE_MANA,GetUnitState(caster,UNIT_STATE_MANA)+100.00)
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_CardWorseMan takes nothing returns nothing
    set gg_trg_CardWorseMan = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_CardWorseMan, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_CardWorseMan, Condition( function Trig_CardWorseMan_Conditions ) )
    call TriggerAddAction( gg_trg_CardWorseMan, function Trig_CardWorseMan_Actions )
endfunction

//===========================================================================
// Trigger: BLTalismanic
//===========================================================================
function Trig_BLTalismanic_Conditions takes nothing returns boolean
    if IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO) != true then
        return false
    endif
    return GetItemTypeId(GetManipulatedItem()) == 'I00E'
endfunction

function Trig_BLTalismanic_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer k = GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))
    if udg_SK_BLTalismanicCoolDown[k] == false then
        set udg_SK_BLTalismanicAvaliable[k] = true
        call UnitAddAbility(caster,'A0QL')
        call SetPlayerAbilityAvailableBJ(false,'A0QL',GetOwningPlayer(caster))
    endif
    set caster = null
endfunction

//===========================================================================
function InitTrig_BLTalismanic takes nothing returns nothing
    set gg_trg_BLTalismanic = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_BLTalismanic, EVENT_PLAYER_UNIT_PICKUP_ITEM )
    call TriggerAddCondition( gg_trg_BLTalismanic, Condition( function Trig_BLTalismanic_Conditions ) )
    call TriggerAddAction( gg_trg_BLTalismanic, function Trig_BLTalismanic_Actions )
endfunction

//===========================================================================
// Trigger: BLTalismanicDrop
//===========================================================================
function Trig_BLTalismanicDrop_Conditions takes nothing returns boolean
    if IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO) != true then
        return false
    endif
    return GetItemTypeId(GetManipulatedItem()) == 'I00E'
endfunction

function Trig_BLTalismanicDrop_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local integer k = GetConvertedPlayerId(GetOwningPlayer(GetTriggerUnit()))
    if udg_SK_BLTalismanicCoolDown[k] == false then
        set udg_SK_BLTalismanicAvaliable[k] = false
        call UnitRemoveAbility(caster,'A0QL')
    endif
    set caster = null
endfunction

//===========================================================================
function InitTrig_BLTalismanicDrop takes nothing returns nothing
    set gg_trg_BLTalismanicDrop = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_BLTalismanicDrop, EVENT_PLAYER_UNIT_DROP_ITEM )
    call TriggerAddCondition( gg_trg_BLTalismanicDrop, Condition( function Trig_BLTalismanicDrop_Conditions ) )
    call TriggerAddAction( gg_trg_BLTalismanicDrop, function Trig_BLTalismanicDrop_Actions )
endfunction

//===========================================================================
// Trigger: CardGoodMan
//===========================================================================
function Trig_CardGoodMan_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0QP'
endfunction

function Trig_CardGoodMan_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit w
    set w = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0.0)
    call UnitAddAbility(w,'A026')
    call IssueTargetOrder(w,"cripple",target)
    set caster = null
    set target = null
    set w = null
endfunction

//===========================================================================
function InitTrig_CardGoodMan takes nothing returns nothing
    set gg_trg_CardGoodMan = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_CardGoodMan, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_CardGoodMan, Condition( function Trig_CardGoodMan_Conditions ) )
    call TriggerAddAction( gg_trg_CardGoodMan, function Trig_CardGoodMan_Actions )
endfunction

//===========================================================================
// Trigger: PadsClockThunderBolt
//===========================================================================
function Trig_PadsClockThunderBolt_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0QQ'
endfunction

function Trig_PadsClockThunderBolt_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit w
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set w = null
            return
        endif
    endif
    //======== 
    set w = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0.0)
    call UnitAddAbility(w,'A0MU')
    call IssueTargetOrder(w,"thunderbolt",target)
    set caster = null
    set target = null
    set w = null
endfunction

//===========================================================================
function InitTrig_PadsClockThunderBolt takes nothing returns nothing
    set gg_trg_PadsClockThunderBolt = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_PadsClockThunderBolt, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_PadsClockThunderBolt, Condition( function Trig_PadsClockThunderBolt_Conditions ) )
    call TriggerAddAction( gg_trg_PadsClockThunderBolt, function Trig_PadsClockThunderBolt_Actions )
endfunction

//===========================================================================
// Trigger: MagicHat
//===========================================================================
function Trig_MagicHat_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0QR'
endfunction

function Trig_MagicHat_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit target = GetSpellTargetUnit()
    local unit w
    //======== 
    if IsUnitAlly(GetSpellTargetUnit(),GetTriggerPlayer()) == false then
        if IsUnitType(GetSpellTargetUnit(),UNIT_TYPE_HERO) and udg_SK_BLTalismanicAvaliable[GetConvertedPlayerId(GetOwningPlayer(GetSpellTargetUnit()))] == true and IsUnitIllusionBJ(GetSpellTargetUnit()) == false then
            call Item_BLTalismanicRunningCD(GetSpellTargetUnit())
            set caster = null
            set target = null
            set w = null
            return
        endif
    endif
    //======== 
    set w = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(target),GetUnitY(target),0.0)
    call UnitAddAbility(w,'A01V')
    call IssueTargetOrder(w,"cyclone",target)
    set caster = null
    set target = null
    set w = null
endfunction

//===========================================================================
function InitTrig_MagicHat takes nothing returns nothing
    set gg_trg_MagicHat = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_MagicHat, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_MagicHat, Condition( function Trig_MagicHat_Conditions ) )
    call TriggerAddAction( gg_trg_MagicHat, function Trig_MagicHat_Actions )
endfunction

//===========================================================================
// Trigger: WindGun
//===========================================================================
//TESH.scrollpos=53
//TESH.alwaysfold=0
function Trig_WindGun_Conditions takes nothing returns boolean
    local real k
    if UnitHasItemOfTypeBJ(GetAttacker(),'I04F') != true then
        return false
    endif
    if IsUnitAlly(GetAttackedUnitBJ(),GetOwningPlayer(GetAttacker())) then
        return false
    endif
    if IsUnitType(GetAttackedUnitBJ(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if IsUnitType(GetAttackedUnitBJ(),UNIT_TYPE_HERO) then
        return false
    endif
    if IsUnitIllusionBJ(GetAttacker()) then
        return false
    endif
    set k = 100.00
    return GetRandomReal(0,100.0) < k
endfunction

function Trig_WindGun_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local real damage
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        //call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        //call DestroyTrigger(trg)
        //call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        return
    endif
    set target = GetTriggerUnit()
    //========
    call DisableTrigger(trg)
    //========
    set damage = 45.00
    call UnitDamageTargetHJ(caster,target,damage,1)
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
endfunction

function Trig_WindGun_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_WindGun_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_WindGun takes nothing returns nothing
    set gg_trg_WindGun = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_WindGun, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_WindGun, Condition( function Trig_WindGun_Conditions ) )
    call TriggerAddAction( gg_trg_WindGun, function Trig_WindGun_Actions )
endfunction

//===========================================================================
// Trigger: Profess
//===========================================================================
function Trig_Profess_Conditions takes nothing returns boolean
    return GetSpellAbilityId() == 'A0C1'
endfunction

function Trig_Profess_Actions takes nothing returns nothing
    local unit caster = GetTriggerUnit()
    local unit v
    local unit w
    local group g
    local boolexpr iff
    local real tx
    local real ty
    set g = CreateGroup()
    set iff = GetPlayerFilter(GetOwningPlayer(caster))
    set tx = GetUnitX(caster)
    set ty = GetUnitY(caster)
    call GroupEnumUnitsInRange(g,tx,ty,300,iff)
    loop
        set v = FirstOfGroup(g)
        exitwhen v == null
        call GroupRemoveUnit(g,v)
        if IsUnitType(v,UNIT_TYPE_DEAD) == false and IsUnitType(v,UNIT_TYPE_STRUCTURE)==false then
            set w = CreateUnit(GetOwningPlayer(caster),'n001',GetUnitX(caster),GetUnitY(caster),0.0)
            call UnitAddAbility(w,'A0T0')
            call IssueTargetOrder(w,"slow",v)
        endif
    endloop
    set caster = null
    set v = null
    set w = null
    set g = null
    set iff = null
endfunction

//===========================================================================
function InitTrig_Profess takes nothing returns nothing
    set gg_trg_Profess = CreateTrigger(  )
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Profess, EVENT_PLAYER_UNIT_SPELL_EFFECT )
    call TriggerAddCondition( gg_trg_Profess, Condition( function Trig_Profess_Conditions ) )
    call TriggerAddAction( gg_trg_Profess, function Trig_Profess_Actions )
endfunction

//===========================================================================
// Trigger: Camara
//===========================================================================
//TESH.scrollpos=60
//TESH.alwaysfold=0
function Trig_Camara_Conditions takes nothing returns boolean
    if UnitHasItemOfTypeBJ(GetAttacker(),'I060') != true then
        return false
    endif
    if IsUnitAlly(GetAttackedUnitBJ(),GetOwningPlayer(GetAttacker())) then
        return false
    endif
    if IsUnitType(GetAttackedUnitBJ(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if IsUnitIllusionBJ(GetAttacker()) then
        return false
    endif
    return GetRandomReal(0,100.0) < 63
endfunction

function Trig_Camara_Damaged takes nothing returns nothing
    local trigger trg = GetTriggeringTrigger()
    local integer task = GetHandleId(trg)
    local unit caster
    local unit target
    local real damage
    //========
    if GetTriggerEventId()!=EVENT_UNIT_DAMAGED then
        call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        call DestroyTrigger(trg)
        call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        return
    endif
    //========
    set caster = LoadUnitHandle(udg_ht,task,0)
    if GetEventDamageSource()!=caster then
        //call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
        //call DestroyTrigger(trg)
        //call FlushChildHashtable(udg_ht,task)
        set trg = null
        set caster = null
        set target = null
        return
    endif
    set target = GetTriggerUnit()
    //========
    call DisableTrigger(trg)
    //========
    set damage = GetUnitState(target,UNIT_STATE_MAX_LIFE)*0.063
    call UnitDamageTargetHJ(caster,target,damage,0)
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\PriestMissile\\PriestMissile.mdl",GetUnitX(target),GetUnitY(target)))
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\PriestMissile\\PriestMissile.mdl",GetUnitX(target)+50,GetUnitY(target)+50))
    call DestroyEffect(AddSpecialEffect("Abilities\\Weapons\\PriestMissile\\PriestMissile.mdl",GetUnitX(target)-50,GetUnitY(target)-50))
    //========
    call TriggerRemoveAction(trg,LoadTriggerActionHandle(udg_ht,task,1))
    call DestroyTrigger(trg)
    call FlushChildHashtable(udg_ht,task)
    //========
    set trg = null
    set caster = null
    set target = null
endfunction

function Trig_Camara_Actions takes nothing returns nothing
    local unit caster = GetAttacker()
    local unit target = GetTriggerUnit()
    local trigger trg
    local triggeraction tga
    set trg = CreateTrigger()
    set tga = TriggerAddAction(trg,function Trig_Camara_Damaged)
    call SaveUnitHandle(udg_ht,GetHandleId(trg),0,caster)
    call SaveTriggerActionHandle(udg_ht,GetHandleId(trg),1,tga)
    call TriggerRegisterUnitEvent(trg,target,EVENT_UNIT_DAMAGED)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_POINT_ORDER)
    call TriggerRegisterUnitEvent(trg,caster,EVENT_UNIT_ISSUED_TARGET_ORDER)
    //========
    set trg = null
    set tga = null
    set caster = null
    set target = null
endfunction

//===========================================================================
function InitTrig_Camara takes nothing returns nothing
    set gg_trg_Camara = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Camara, EVENT_PLAYER_UNIT_ATTACKED )
    call TriggerAddCondition( gg_trg_Camara, Condition( function Trig_Camara_Conditions ) )
    call TriggerAddAction( gg_trg_Camara, function Trig_Camara_Actions )
endfunction

//===========================================================================
// Trigger: Steam Bun And Frog
//===========================================================================
function Trig_Steam_Bun_Conditions takes nothing returns boolean
    if GetSpellAbilityId() == 'A01K' then
        return true
    endif
    if GetSpellAbilityId() == 'A0FG' then
        return true
    endif
    if GetSpellAbilityId() == 'A0FP' then
        return true
    endif
    return false
endfunction

function Trig_Steam_Bun_Actions takes nothing returns nothing
    local unit u = GetOrderTargetUnit()
    call UnitRemoveAbility(u,'B00N')
    call UnitRemoveAbility(u,'B03S')
    set u = null
endfunction

//===========================================================================
function InitTrig_Steam_Bun_And_Frog takes nothing returns nothing
    set gg_trg_Steam_Bun_And_Frog = CreateTrigger()
    call TriggerRegisterAnyUnitEventBJ( gg_trg_Steam_Bun_And_Frog, EVENT_PLAYER_UNIT_SPELL_CAST )
    call TriggerAddCondition( gg_trg_Steam_Bun_And_Frog, Condition( function Trig_Steam_Bun_Conditions ) )
    call TriggerAddAction( gg_trg_Steam_Bun_And_Frog, function Trig_Steam_Bun_Actions )
endfunction

//===========================================================================
// Trigger: AI
//===========================================================================
//TESH.scrollpos=60
//TESH.alwaysfold=0

function InitTrig_AI takes nothing returns nothing
endfunction

//page: 0~15
//field: 0~31
//index: 0~15
function AI_WriteState takes integer page,integer field,integer index,integer value returns nothing
    set udg_AI_States[page*512 + field*16 + index] = value
endfunction
function AI_ReadState takes integer page,integer field,integer index returns integer
    return udg_AI_States[page*512 + field*16 + index]
endfunction

function AI_STATE_PHASE takes nothing returns integer
    return 0
endfunction
function AI_STATE_WAYPOINT takes nothing returns integer
    return 1
endfunction
function AI_STATE_DECISION takes nothing returns integer
    return 2
endfunction

function AI_IsLowHP takes unit u returns boolean
    local real HP = GetUnitState(u,UNIT_STATE_LIFE)
    local real percent = 100.0*HP/GetUnitState(u,UNIT_STATE_MAX_LIFE)
    local real speed = GetUnitMoveSpeed(u)
    local real DC = RMinBJ(100.0,RMaxBJ(600.0 - GetUnitDefaultAcquireRange(u),0.0))
    if percent <= (25.0 + DC/20.0) then
        return true
    endif
    if HP <= ( 180.0 + 3.0*(320.0 - speed) + DC ) then
        return percent < 80.0
    endif
    return false
endfunction

function AI_IsLowMP takes unit u returns boolean
    local real MP = GetUnitState(u,UNIT_STATE_MANA)
    local real percent = 100.0*MP/GetUnitState(u,UNIT_STATE_MAX_MANA)
    local integer level = GetHeroLevel(u)
    if percent <= 15.0 then
        return true
    endif
    if MP <= ( 60.0 + level*3.0 ) then
        return true
    endif
    return false
endfunction

function Trig_AI_Action_All_Tactical_Units takes nothing returns boolean
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return GetUnitDefaultMoveSpeed(GetFilterUnit()) >= 80.00
endfunction

function AI_IssueAttackOrder takes unit h returns boolean
    local player w = GetOwningPlayer(h)
    local group g = GetUnitsOfPlayerMatching(w,Filter(function Trig_AI_Action_All_Tactical_Units))
    local location target
    local integer phase = AI_ReadState(GetPlayerId(w),AI_STATE_PHASE(),0)
    local integer waypoint = AI_ReadState(GetPlayerId(w),AI_STATE_WAYPOINT(),0)
    local integer offset
    set offset = 32*AI_GetPlayerForceId(w)
    set target = udg_AI_Waypoints[offset + waypoint + 1]
    if target==null then
        set target = udg_AI_Waypoints[offset + waypoint]
    endif
    call GroupPointOrderLoc(g,"attack",target)
    call AI_WriteState(GetPlayerId(w),AI_STATE_DECISION(),0,1)
    call DestroyGroup(g)
    set w = null
    set g = null
    set target = null
    return false
endfunction

function AI_IssueRetreatOrder takes unit h returns boolean
    local player w = GetOwningPlayer(h)
    local group g = GetUnitsOfPlayerMatching(w,Filter(function Trig_AI_Action_All_Tactical_Units))
    local location target
    local integer phase = AI_ReadState(GetPlayerId(w),AI_STATE_PHASE(),0)
    local integer waypoint = AI_ReadState(GetPlayerId(w),AI_STATE_WAYPOINT(),0)
    local integer offset
    set offset = 32*AI_GetPlayerForceId(w)
    if waypoint>0 then
        set target = udg_AI_Waypoints[offset + waypoint - 1]
    else
        set target = GetPlayerShelter(w)
    endif
    call GroupPointOrderLoc(g,"move",target)
    call AI_WriteState(GetPlayerId(w),AI_STATE_DECISION(),0,2)
    call DestroyGroup(g)
    set w = null
    set g = null
    set target = null
    return false
endfunction
//===========================================================================
// Trigger: Initialization AI
//===========================================================================
function Trig_Initialization_AI_Func018C takes nothing returns boolean
    if ( not ( udg_TestMode == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Initialization_AI_Actions takes nothing returns nothing
    local integer i
    local unit u
    // ========
    set i = 0
    loop
        exitwhen i>=8192
        set udg_AI_States[i] = 0
        set i = i + 1
    endloop
    call TriggerSleepAction( 0.30 )
    set i = 0
    loop
        exitwhen i>=64
        set udg_AI_Waypoints[i] = null
        set i = i + 1
    endloop
    // ========
    if ( Trig_Initialization_AI_Func018C() ) then
    else
        call DoNothing(  )
    endif
    // ========
    // 博丽英雄路线A
    set i = 0
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_BaseA)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_AI_Waypoint_00)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_AI_Waypoint_01)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_AI_Waypoint_02)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_AI_Waypoint_03)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_AI_Waypoint_04)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_AI_Waypoint_05)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_BaseB)
    // ========
    // 守矢英雄路线A
    set i = 32
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_BaseB)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_AI_Waypoint_05)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_AI_Waypoint_04)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_AI_Waypoint_03)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_AI_Waypoint_02)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_AI_Waypoint_01)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_AI_Waypoint_00)
    set i = i + 1
    set udg_AI_Waypoints[i] = GetRectCenter(gg_rct_BaseA)
    // ========
    set i = 0
    loop
        exitwhen i>=32
        if udg_AI_Waypoints[i]!=null then
            set u = CreateUnitAtLoc(Player(15),'n004',udg_AI_Waypoints[i],270.0)
            call TriggerRegisterUnitInRange(gg_trg_AI_Waypoints,u,600.0,null)
        endif
        set i = i + 1
    endloop
    set u = null
endfunction

//===========================================================================
function InitTrig_Initialization_AI takes nothing returns nothing
    set gg_trg_Initialization_AI = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initialization_AI, function Trig_Initialization_AI_Actions )
endfunction

//===========================================================================
// Trigger: AI Waypoints
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_AI_Waypoints_Conditions takes nothing returns boolean
    if IsUnitType(GetTriggerUnit(),UNIT_TYPE_HERO)==false then
        return false
    endif
    if IsUnitIllusion(GetTriggerUnit()) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return true
endfunction

function Trig_AI_Waypoints_Actions takes nothing returns nothing
    local unit h = GetEnteringUnit()
    local player w = GetOwningPlayer(h)
    local location p
    local real ox = GetUnitX(h)
    local real oy = GetUnitY(h)
    local real dx
    local real dy
    local integer i
    local integer offset
    
    if AI_GetPlayerForceId(GetOwningPlayer(h))==0 then
        set offset = 0
    else
        set offset = 32
    endif
    
    set i = 0
    loop
        set p = udg_AI_Waypoints[offset + i]
        exitwhen p==null
        set dx = GetLocationX(p) - ox
        set dy = GetLocationY(p) - oy
        exitwhen SquareRoot(dx*dx + dy*dy)<660.0
        set i = i + 1
    endloop
    
    call AI_WriteState(GetPlayerId(w),AI_STATE_WAYPOINT(),0,i)
    
    if IsPlayerInForce(w,udg_AI_Players) then
        if AI_ReadState(GetPlayerId(w),AI_STATE_DECISION(),0)==1 then
            call AI_IssueAttackOrder(h)
        else
            call AI_IssueRetreatOrder(h)
        endif
    endif
    
    set h = null
    set w = null
    set p = null
endfunction

//===========================================================================
function InitTrig_AI_Waypoints takes nothing returns nothing
    set gg_trg_AI_Waypoints = CreateTrigger()
    call TriggerAddCondition( gg_trg_AI_Waypoints, Condition( function Trig_AI_Waypoints_Conditions ) )
    call TriggerAddAction( gg_trg_AI_Waypoints, function Trig_AI_Waypoints_Actions )
endfunction
//===========================================================================
// Trigger: AI Learn
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_AI_Learn_Actions takes nothing returns nothing
    call AI_LearnSkill(GetTriggerUnit())
endfunction

//===========================================================================
function InitTrig_AI_Learn takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: AI Revive
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_AI_Revive_Conditions takes nothing returns boolean
    return GetPlayerController(GetOwningPlayer(GetTriggerUnit())) == MAP_CONTROL_COMPUTER
endfunction

function Trig_AI_Revive_Actions takes nothing returns nothing
    local integer level = GetHeroLevel(GetTriggerUnit())
    call TriggerSleepAction(0.0)
    call AddHeroXP(GetTriggerUnit(),40 + level*4,true)
endfunction

//===========================================================================
function InitTrig_AI_Revive takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: AI EXP Bonus
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0
function Trig_AI_EXP_Bonus_Conditions takes nothing returns boolean
    if not IsUnitType(GetTriggerUnit(), UNIT_TYPE_HERO) then
        return false
    endif
    if IsUnitIllusion(GetTriggerUnit()) then
        return false
    endif
    if GetUnitLifePercent(GetTriggerUnit()) > 30.00 then
        return false
    endif
    if IsUnitDead(GetTriggerUnit()) then
        return false
    endif
    return GetPlayerController(GetOwningPlayer(GetTriggerUnit())) == MAP_CONTROL_COMPUTER
endfunction

function Trig_AI_EXP_Bonus_Actions takes nothing returns nothing
    local integer level = GetHeroLevel(GetTriggerUnit())
    call TriggerSleepAction(0.0)
    call AddHeroXP(GetTriggerUnit(),40 + level*4,true)
endfunction

//===========================================================================
function InitTrig_AI_EXP_Bonus takes nothing returns nothing
endfunction
//===========================================================================
// Trigger: AI Ability
//===========================================================================
//TESH.scrollpos=264
//TESH.alwaysfold=0

function AI_Ability_Target_Enemy_Units takes nothing returns boolean
    if IsUnitType(GetFilterUnit(),UNIT_TYPE_STRUCTURE) then
        return false
    endif
    if GetUnitAbilityLevel(GetFilterUnit(),'Aloc')!=0 then
        return false
    endif
    return IsUnitEnemy(GetFilterUnit(),GetEnumPlayer())
endfunction

function AI_Ability_Nazrin takes unit h returns nothing
    local integer level = GetUnitAbilityLevel(h,'A0D8')
    local integer i
    local unit v
    local group g
    local real mp = GetUnitState(h,UNIT_STATE_MANA)
    //========
    if level==0 or mp<(60.0 + level*25.0) then
        return
    endif
    //========
    set g = AI_GetAllFoes(h,900.0)
    if AI_CountUnitsInGroup(g)>0 then
        set i = 0
        loop
            exitwhen i>=12
            set v = udg_PlayerHeroes[i]
            if v!= null and IsUnitAlive(v) then
                if IsUnitAlly(v,GetOwningPlayer(h)) and GetUnitLifePercent(v)<60.0 then
                    if DistanceBetweenUnits(h,v)<500.0 and GetRandomReal(0,100)>30.0 then
                        call IssueTargetOrder(h,"frostarmor",v)
                        exitwhen true
                    endif
                endif
            endif
            set i = i + 1
        endloop
    endif
    call DestroyGroup(g)
    set g = null
    set v = null
endfunction

function AI_Ability_Alice_Doll takes nothing returns nothing
    if GetRandomReal(0,100.0)<40.0 then
        call IssueImmediateOrder(GetEnumUnit(),"ravenform")
    endif
endfunction

function AI_Ability_Alice takes unit h returns nothing
    local integer level = GetUnitAbilityLevel(h,'A0GW')
    local unit v
    local integer n
    local group g
    //========
    if AI_IsLowHP(h) then
        return
    endif
    //========
    if level>=2 then
        if GetRandomReal(0,100.0)<50.0 then
            set g = LoadGroupHandle(udg_sht,GetHandleId(h),2)
            call ForGroup(g,function AI_Ability_Alice_Doll)
        endif
    endif
    //========
    set g = null
    set v = null
endfunction

function AI_Ability_Iku takes unit h returns nothing
    local integer level = GetUnitAbilityLevel(h,'A04S')
    local unit v
    local integer i
    //========
    if level>=1 and GetUnitState(h,UNIT_STATE_MANA)>=155.0 then
        set i = 0
        loop
            exitwhen i>=12
            set v = udg_PlayerHeroes[i]
            if v!= null and IsUnitAlive(v) then
                if IsUnitEnemy(v,GetOwningPlayer(h)) and IsUnitInRange(h,v,200.0) then
                    call IssueImmediateOrder(h,"metamorphosis")
                    exitwhen true
                endif
            endif
            set i = i + 1
        endloop
    endif
    //========
    set v = null
endfunction

function AI_Ability_Captain takes unit h returns nothing
    local integer level = GetUnitAbilityLevel(h,'A0A6')
    local unit v
    local integer i
    //========
    if level>=1 and GetUnitState(h,UNIT_STATE_MANA)>=50.0 then
        set i = 0
        loop
            exitwhen i>=12
            set v = udg_PlayerHeroes[i]
            if v!= null and IsUnitAlive(v) then
                if IsUnitEnemy(v,GetOwningPlayer(h)) and IsUnitInRange(h,v,300.0) then
                    call IssueImmediateOrder(h,"battleroar")
                    exitwhen true
                endif
            endif
            set i = i + 1
        endloop
    endif
    //========
    set v = null
endfunction

function AI_Ability_Marisa takes unit h returns nothing
    local integer level = GetUnitAbilityLevel(h,'A042')
    local integer i
    local unit v
    //========
    if GetUnitLifePercent(h)<30.0 then
        return
    endif
    //========
    if level>=0 and GetUnitState(h,UNIT_STATE_MANA) > (125.0 + level*125.0) then
        set i = 0
        loop
            exitwhen i>=12
            set v = udg_PlayerHeroes[i]
            if v!= null and IsUnitAlive(v) then
                if IsUnitEnemy(v,GetOwningPlayer(h)) and DistanceBetweenUnits(h,v)<=700.0 then
                    if GetUnitState(v,UNIT_STATE_LIFE)<(150.0 + level*180.0) and GetUnitLifePercent(v)>=10.0 then
                        call IssuePointOrder(h,"carrionswarm",GetUnitX(v),GetUnitY(v))
                        exitwhen true
                    elseif GetRandomReal(0.0,100.0)<30.0 then
                        if GetUnitLifePercent(v)<70.0 then
                            call IssuePointOrder(h,"carrionswarm",GetUnitX(v),GetUnitY(v))
                            exitwhen true
                        endif
                    endif
                endif
            endif
            set i = i + 1
        endloop
    endif
    //========
    set level = GetUnitAbilityLevel(h,'A041')
    if level==0 then
        return
    endif
    if GetUnitState(h,UNIT_STATE_MANA) < (65 + 25.0*level) then
        return
    endif
    if GetUnitCurrentOrder(h)!=OrderId("carrionswarm") then
        set i = 0
        loop
            exitwhen i>=12
            set v = udg_PlayerHeroes[i]
            if v!= null and IsUnitAliveBJ(v) then
                if IsUnitEnemy(v,GetOwningPlayer(h)) and DistanceBetweenUnits(h,v)<=200.0 then
                    call IssuePointOrder(h,"breathoffire",GetUnitX(v),GetUnitY(v))
                    set v = null
                    return
                endif
            endif
            set i = i + 1
        endloop
    endif
    //========
    set v = null
endfunction

function AI_Ability_Shikieiki takes unit h returns nothing
    local integer level = GetUnitAbilityLevel(h,'A0B9')
    local integer i
    local unit v
    local real mp = GetUnitState(h,UNIT_STATE_MANA)
    //========
    if GetUnitLifePercent(h)<20.0 then
        set v = null
        return
    endif
    //========
    if level>=4 then
        set i = 0
        loop
            exitwhen i>=12
            set v = udg_PlayerHeroes[i]
            if v!= null and IsUnitAlive(v) and IsUnitEnemy(v,GetOwningPlayer(h)) then
                if IsUnitInRange(h,v,800.0) then
                    if Trig_Shikieiki01_Debuff_Degree(v)>=10 then
                        call IssueTargetOrder(h,"cripple",v)
                    elseif GetRandomReal(0,100)<=2.0*Trig_Shikieiki01_Debuff_Degree(v) then
                        call IssueTargetOrder(h,"cripple",v)
                    endif
                endif
            endif
            set i = i + 1
        endloop
    endif
    //========
    set i = 0
    loop
        exitwhen i>=12
        set v = udg_PlayerHeroes[i]
        if v!= null and IsUnitAlive(v) and IsUnitEnemy(v,GetOwningPlayer(h)) then
            if IsUnitInRange(h,v,800.0) then
                call IssueTargetOrder(h,"faeriefire",v)
            endif
        endif
        set i = i + 1
    endloop
    //========
    set v = null
endfunction

function AI_Ability_Yukari takes unit h returns nothing
    local integer level = GetUnitAbilityLevel(h,'A04J')
    local integer i
    local unit v
    local real mp = GetUnitState(h,UNIT_STATE_MANA)
    local location shelter
    //========
    if level==0 then
        return
    endif
    //========
    if GetUnitLifePercent(h)<20.0 then
        if mp > (110.0 + level*10.0) then
            call IssueTargetOrder(h,"drunkenhaze",h)
        elseif GetUnitCurrentOrder(h)<=0xD0040 then
            set level = GetUnitAbilityLevel(h,'A04N')
            if level>=0 and mp >= (60.0 - 10.0*level) then
                if IsPlayerInForce(GetOwningPlayer(h),udg_TeamA) then
                    set shelter = udg_RevivePoint[0]
                else
                    set shelter = udg_RevivePoint[1]
                endif
                call IssuePointOrderLoc(h,"blink",shelter)
                set shelter = null
            endif
        endif
        return
    endif
    //========
    set i = 0
    loop
        exitwhen i>=12
        set v = udg_PlayerHeroes[i]
        if v!= null and IsUnitAlive(v) then
            if IsUnitAlly(v,GetOwningPlayer(h)) and GetUnitLifePercent(v)<20.0 then
                if DistanceBetweenUnits(h,v)<750.0 then
                    call IssueTargetOrder(h,"drunkenhaze",v)
                    exitwhen true
                endif
            endif
            if IsUnitEnemy(v,GetOwningPlayer(h)) and DistanceBetweenUnits(h,v)<=700.0 then
                if GetUnitCurrentOrder(v)>=0xD0040 then
                    call IssueTargetOrder(h,"drunkenhaze",v)
                    exitwhen true
                endif
                if GetUnitLifePercent(v)>=80.0 and GetUnitManaPercent(v)>=25.0 then
                    call IssueTargetOrder(h,"banish",v)
                    exitwhen true
                endif
                if GetUnitLifePercent(v)>=20.0 and GetRandomReal(0,100)<=66.6 then
                    call IssueTargetOrder(h,"drunkenhaze",v)
                    exitwhen true
                endif
            endif
        endif
        set i = i + 1
    endloop
    set v = null
endfunction

function AI_Ability_Ran takes unit h returns nothing
    local integer level = GetUnitAbilityLevel(h,'A0EG')
    local integer i
    local unit v
    local unit target
    local integer n
    local integer m
    //========
    if level==0 or GetUnitLifePercent(h)<20.0 then
        return
    endif
    if GetUnitState(h,UNIT_STATE_MANA) < (80.0 + level*20.0) then
        return
    endif
    //========
    set target = null
    set m = 0
    set n = 0
    set i = 0
    loop
        exitwhen i>=12
        set v = udg_PlayerHeroes[i]
        if v!= null and IsUnitAliveBJ(v) and DistanceBetweenUnits(h,v)<=550.0 then
            if IsUnitAlly(v,GetOwningPlayer(h)) then
                set m = m + 1
            else
                if target == null then
                    set target = v
                endif
                set n = n + 1
            endif
        endif
        set i = i + 1
    endloop
    if m>=3 and n>=2 then
        set level = GetUnitAbilityLevel(h,'A0EH')
        if level>0 then
            if GetUnitState(h,UNIT_STATE_MANA) > (90 + level*70.0) then
                call IssueImmediateOrder(h,"tranquility")
                set v = null
                set target = null
                return
            endif
        endif
    endif
    if n>=2 then
        call IssueTargetOrder(h,"chainlightning",target)
    endif
    set v = null
    set target = null
endfunction

function AI_Ability_Eirin takes unit h returns nothing
    local integer level = GetUnitAbilityLevel(h,'A083')
    local integer i
    local real px
    local real py
    local real a
    local real d
    local unit v
    //========
    if level==0 or GetUnitLifePercent(h)<15.0 then
        return
    endif
    if GetUnitState(h,UNIT_STATE_MANA) < 75.0 then
        return
    endif
    //========
    set i = 0
    loop
        exitwhen i>=12
        set v = udg_PlayerHeroes[i]
        if v!=null and v!=h and IsUnitAliveBJ(v) then
            if IsUnitAlly(v,GetOwningPlayer(h)) and GetUnitLifePercent(v)<60.0 then
                set d = DistanceBetweenUnits(h,v)
                if d<=1200.0 then
                    set px = GetUnitX(v)
                    set py = GetUnitY(v)
                    if GetUnitCurrentOrder(v)==OrderId("move") then
                        set a = GetUnitFacing(v)
                        set px = px + 300.0*(d/900.0)*CosBJ(a)
                        set py = py + 300.0*(d/900.0)*SinBJ(a)
                    endif
                    call IssuePointOrder(h,"healingspray",px,py)
                    exitwhen true
                endif
            endif
            if IsUnitEnemy(v,GetOwningPlayer(h)) and GetUnitState(h,UNIT_STATE_LIFE)<60.0*level then
                set d = DistanceBetweenUnits(h,v)
                if d<=1500.0 then
                    set px = GetUnitX(v)
                    set py = GetUnitY(v)
                    if GetUnitCurrentOrder(v)==OrderId("move") then
                        set a = GetUnitFacing(v)
                        set px = px + 300.0*(d/900.0)*CosBJ(a)
                        set py = py + 300.0*(d/900.0)*SinBJ(a)
                    endif
                    call IssuePointOrder(h,"healingspray",px,py)
                    exitwhen true
                endif
            endif
        endif
        set i = i + 1
    endloop
    set v = null
endfunction

function AI_Ability_Tensi takes unit h returns nothing
    local integer level = GetUnitAbilityLevel(h,'A0AJ')
    local integer i
    local integer n
    local unit v
    //========
    if level==0 or GetUnitLifePercent(h)<40.0 then
        return
    endif
    if GetUnitState(h,UNIT_STATE_MANA) < (level*280.0) then
        return
    endif
    //========
    set n = 0
    set i = 0
    loop
        exitwhen i>=12
        set v = udg_PlayerHeroes[i]
        if v!= null and IsUnitAliveBJ(v) then
            if IsUnitEnemy(v,GetOwningPlayer(h)) and GetUnitState(v,UNIT_STATE_LIFE)<(100.0 + level*150.0) then
                set n = n + 1
            endif
        endif
        set i = i + 1
    endloop
    if n>=2 then
        call IssueImmediateOrder(h,"starfall")
    endif
    set v = null
endfunction

function AI_Ability_Mokou takes unit h returns nothing
    local unit v
    local integer n
    local boolexpr iff
    local group enemy
    //========
    if GetUnitAbilityLevel(h,'A052')==0 then
        return
    endif
    if GetUnitState(h,UNIT_STATE_MANA) < 150.0 then
        return
    endif
    //========
    if GetUnitLifePercent(h)<50.0 then
        set enemy = CreateGroup()
        set iff = GetPlayerFilter(GetOwningPlayer(h))
        call GroupEnumUnitsInRange(enemy,GetUnitX(h),GetUnitY(h),1000.0,iff)
        set n = 0
        loop
            set v = FirstOfGroup(enemy)
            exitwhen v == null
            call GroupRemoveUnit(enemy,v)
            if IsUnitType(v,UNIT_TYPE_HERO) then
                set n = n + 2
            else
                set n = n + 1
            endif
        endloop
        call DestroyGroup(enemy)
        if n<=1 then
            call IssueImmediateOrder(h,"burrow")
        endif
    endif
    //========
    set enemy = null
    set iff = null
    set v = null
endfunction

function AI_Ability_Kaguya takes unit h returns nothing
    local unit v
    local integer n
    local boolexpr f
    local group enemy
    //========
    if AI_IsLowHP(h) then
        return
    endif
    if GetUnitAbilityLevel(h,'A0D0')==0 then
        return
    endif
    //========
    if GetUnitManaPercent(h)>30.0 then
        set enemy = CreateGroup()
        set f = Filter(function AI_Ability_Target_Enemy_Units)
        call GroupEnumUnitsInRange(enemy,GetUnitX(h),GetUnitY(h),500.0,f)
        set n = 0
        loop
            set v = FirstOfGroup(enemy)
            exitwhen v == null
            call GroupRemoveUnit(enemy,v)
            if IsUnitType(v,UNIT_TYPE_HERO) then
                set n = n + 3
            else
                set n = n + 1
            endif
        endloop
        call DestroyGroup(enemy)
        call DestroyBoolExpr(f)
        if n>=3 then
            call IssueImmediateOrder(h,"fanofknives")
        endif
    endif
    //========
    set enemy = null
    set f = null
    set v = null
endfunction

function AI_Ability_Mystia takes unit h returns nothing
    local integer level = GetUnitAbilityLevel(h,'A0DI')
    local integer i
    local unit v
    local unit target
    local integer n
    local integer m
    //========
    if level==0 then
        return
    endif
    if GetUnitState(h,UNIT_STATE_MANA) < 40 then
        return
    endif
    //========
    set target = null
    set m = 0
    set n = 0
    set i = 0
    loop
        exitwhen i>=12
        set v = udg_PlayerHeroes[i]
        if v!= null and IsUnitAliveBJ(v) and DistanceBetweenUnits(h,v)<=550.0 then
            if IsUnitAlly(v,GetOwningPlayer(h)) then
                if GetUnitLifePercent(h)<20.0 then
                    set n = n + 1
                endif
                set m = m + 1
            endif
        endif
        set i = i + 1
    endloop
    if n>=1 then
        call IssueImmediateOrder(h,"roar")
    elseif m>=3 and GetRandomReal(0,100.0)>50.0 then
        call IssueImmediateOrder(h,"roar")
    endif
    //========
    set v = null
    set target = null
endfunction

function InitTrig_AI_Ability takes nothing returns nothing
    set gg_trg_AI_Ability = null
endfunction
//===========================================================================
// Trigger: AI Action
//===========================================================================
//TESH.scrollpos=247
//TESH.alwaysfold=0

function Trig_AI_Action_Custom_Ability takes player who,unit h returns nothing
    local integer ID = GetUnitTypeId(h)
    if ID == 'H00W' then
        call AI_Ability_Kaguya(h)
    elseif ID == 'O006' then
        call AI_Ability_Eirin(h)
    elseif ID == 'H002' then
        call AI_Ability_Tensi(h)
    elseif ID == 'N00J' then
        call AI_Ability_Mokou(h)
    elseif ID == 'H000' then
        call AI_Ability_Marisa(h)
    elseif ID == 'E00F' then
        call AI_Ability_Yukari(h)
    elseif ID == 'E00G' then
        call AI_Ability_Ran(h)
    elseif ID == 'E00Z' then
        call AI_Ability_Mystia(h)
    elseif ID == 'E00V' then
        call AI_Ability_Shikieiki(h)
    elseif ID == 'H01A' then
        call AI_Ability_Alice(h)
    elseif ID == 'E00Q' then
        call AI_Ability_Captain(h)
    elseif ID == 'U003' then
        call AI_Ability_Iku(h)
    elseif ID == 'U00K' then
        call AI_Ability_Nazrin(h)
    endif
endfunction

function AI_GetPowerUp_Take takes nothing returns nothing
    local item w = GetEnumItem()
    if bj_lastRemovedItem == null then
        call IssueTargetOrder(bj_lastLoadedUnit,"smart",w)
        set bj_lastRemovedItem = w
    endif
    set w = null
endfunction

function AI_GetPowerUp_Type takes nothing returns boolean
    local integer d = GetItemTypeId(GetFilterItem())
    if d=='I03H' then
        return true
    endif
    if d=='I03F' then
        return GetRandomReal(0,100.0)<50.0
    endif
    if ('I04E'<=d) and (d<='I04H') then
        return true
    endif//加速药 
    if ('I03C'<=d) and (d<='I03E') then
        return true
    endif//蓬莱药 
    return false
endfunction

function AI_GetPowerUp takes unit h returns nothing
    local real ox = GetUnitX(h)
    local real oy = GetUnitY(h)
    local rect r = Rect(ox-200.0,oy-200.0,ox+200.0,oy+200.0)
    local boolexpr f = Filter(function AI_GetPowerUp_Type)
    set bj_lastRemovedItem = null
    set bj_lastLoadedUnit = h
    call EnumItemsInRect(r,f,function AI_GetPowerUp_Take)
    set bj_lastRemovedItem = null
    set bj_lastLoadedUnit = null
    call RemoveRect(r)
    call DestroyBoolExpr(f)
    set r = null
    set f = null
endfunction

function Trig_AI_Action_Maintain takes unit h returns boolean
    local integer ID = GetUnitCurrentOrder(h)
    if ID == OrderId("voodoo") then
        return true
    endif
    if ID == OrderId("blink") then
        return true
    endif
    if ID == OrderId("massteleport") then
        return true
    endif
    return false
endfunction

function Trig_AI_Action_Offensive takes player who,unit h returns nothing
    local group g
    local unit v
    local integer i
    local location target
    local rect base
    local group enemy
    local location shelter
    local boolean LowHP = AI_IsLowHP(h)
    local boolean LowMP = AI_IsLowMP(h)
    local boolean HighHP = GetUnitLifePercent(h) >= 90.00
    local boolean HighMP = GetUnitManaPercent(h) >= 90.00
    //========
    if IsPlayerInForce(who,udg_TeamA) then
        set base = gg_rct_BaseA
        set enemy = udg_AI_Groups[3]
        set shelter = udg_RecoverPoint[0]
        set target = GetRectCenter(gg_rct_SpawnB0)
    else
        set base = gg_rct_BaseB
        set enemy = udg_AI_Groups[2]
        set shelter = udg_RecoverPoint[1]
        set target = GetRectCenter(gg_rct_SpawnA2)
    endif
    //========
    if RectContainsUnit(base,h) then
        if HighHP and HighMP then
            set i = 0
            loop
                set v = GroupPickRandomUnit(enemy)
                if IsUnitEnemy(v,who) and IsUnitAliveBJ(v) then
                    call RemoveLocation(target)
                    set target = GetUnitLoc(v)
                    exitwhen true
                endif
                set i = i + 1
                exitwhen i>=8
            endloop
            call AI_IssueAttackOrder(h)
        endif
    else
        if LowHP then
            if not Trig_AI_Action_Maintain(h) then
                call AI_IssueRetreatOrder(h)
            endif
        else
            set i = 0
            loop
                set v = GroupPickRandomUnit(enemy)
                if IsUnitEnemy(v,who) and IsUnitAliveBJ(v) then
                    call RemoveLocation(target)
                    set target = GetUnitLoc(v)
                    exitwhen true
                endif
                set i = i + 1
                exitwhen i>=8
            endloop
            set g = GetUnitsOfPlayerMatching(who,Filter(function Trig_AI_Action_All_Tactical_Units))
            call AI_IssueAttackOrder(h)
        endif
    endif
    //========
    call RemoveLocation(target)
    call DestroyGroup(g)
    set who = null
    set h = null
    set v = null
    set g = null
    set target = null
    set base = null
    set enemy = null
    set shelter = null
endfunction

function Trig_AI_Action_Defensive takes player who,unit h returns nothing
    local location target
    local rect base
    local group enemy
    local location shelter
    local boolean LowHP = AI_IsLowHP(h)
    local boolean LowMP = AI_IsLowMP(h)
    local boolean HighHP = GetUnitLifePercent(h) >= 50.00
    local boolean HighMP = GetUnitManaPercent(h) >= 50.00
    //========
    if IsPlayerInForce(who,udg_TeamA) then
        set base = gg_rct_BaseA
        set enemy = udg_AI_Groups[3]
        set shelter = udg_RecoverPoint[0]
    else
        set base = gg_rct_BaseB
        set enemy = udg_AI_Groups[2]
        set shelter = udg_RecoverPoint[1]
    endif
    //========
    set target = GetUnitLoc(h)
    if LowHP then
        call AI_IssueRetreatOrder(h)
    elseif ( DistanceBetweenPoints(shelter,target) < 4800.0 ) and ( not (HighHP and HighMP) ) then
        call AI_IssueRetreatOrder(h)
    elseif GetUnitCurrentOrder(h)<=0xD0040 then
        call AI_GetPowerUp(h)
    endif
    call RemoveLocation(target)
    //========
    set who = null
    set h = null
    set target = null
    set base = null
    set enemy = null
    set shelter = null
endfunction

function Trig_AI_AddItems takes player who,unit h,integer T returns nothing
    local integer d
    local real ox = GetUnitX(h)
    local real oy = GetUnitY(h)
    local item w
    
    if T==30 then
        
        set d = GetHeroMainProperty(h)
        
        if d==1 then
            set w = CreateItem('I039',ox,oy)
        elseif d==2 then
            set w = CreateItem('I03A',ox,oy)
        elseif d==3 then
            set w = CreateItem('I03B',ox,oy)
        endif
        call UnitAddItem(h,w)
        
        set w = CreateItem('I007',ox,oy)
        call UnitAddItem(h,w)
        
        set w = CreateItem('I00I',ox,oy)
        call UnitAddItem(h,w)
        
    endif
    
    if T==900 then
        set w = CreateItem('I008',ox,oy)
        call AI_UnitAddItem(h,w,true)
    endif
    
    set w = null
endfunction

function Trig_AI_Action_Router takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local player who = GetEnumPlayer()
    local integer i = GetPlayerId(who)
    local integer T = LoadInteger(udg_ht,task,0) + i//Phase Shift
    local unit h = udg_PlayerHeroes[i]
    //========
    if h==null then
        return
    endif
    if IsUnitAlive(h) then
        if T/5*5==T then
            call Trig_AI_Action_Offensive(who,h)
        else
            if not Trig_AI_Action_Maintain(h) then
                call Trig_AI_Action_Defensive(who,h)
            endif
        endif
        if T/3*3==T then
            call Trig_AI_Action_Custom_Ability(who,h)
        endif
    endif
    call Trig_AI_AddItems(who,h,T)
    //========
    set t = null
    set who = null
    set h = null
endfunction

function Trig_AI_Action_Main takes nothing returns nothing
    local timer t = GetExpiredTimer()
    local integer task = GetHandleId(t)
    local integer T = LoadInteger(udg_ht,task,0)
    call ForForce(udg_AI_Players,function Trig_AI_Action_Router)
    call SaveInteger(udg_ht,task,0,T + 1)
    set t = null
endfunction

function Trig_AI_Action_Actions takes nothing returns nothing
    local timer t = CreateTimer()
    local integer task = GetHandleId(t)
    call SaveInteger(udg_ht,task,0,0)
    call TimerStart(t,1.0,true,function Trig_AI_Action_Main)
    set t = null
endfunction

//===========================================================================
function InitTrig_AI_Action takes nothing returns nothing
    set gg_trg_AI_Action = CreateTrigger()
    call TriggerAddAction( gg_trg_AI_Action, function Trig_AI_Action_Actions )
endfunction
//===========================================================================
// Trigger: AI Init
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function Trig_AI_Team_Players takes nothing returns nothing
    local integer i = GetPlayerId(GetEnumPlayer())
    if IsPlayerInForce(GetEnumPlayer(),udg_TeamA) then
        call GroupAddUnit( udg_AI_Groups[2], udg_PlayerHeroes[i] )
    elseif IsPlayerInForce(GetEnumPlayer(),udg_TeamB) then
        call GroupAddUnit( udg_AI_Groups[3], udg_PlayerHeroes[i] )
    endif
endfunction

function Trig_AI_PickHero takes nothing returns nothing
local player PLY = GetEnumPlayer()
local integer i = GetPlayerId(PLY)
local unit caster = udg_PlayerHeroesBan[i]
if udg_PlayerHeroes[i]==null then
    call RescueUnitBJ( caster, PLY, true )
    set udg_PlayerHeroes[i]=caster
    call SetUnitUserData(caster,0)
    set udg_PlayerName[i] = udg_PlayerColors[i] + GetPlayerName(Player(i)) + "|r"
    call SetPlayerName( PLY , GetPlayerName(PLY) + "（" + GetHeroProperName(udg_PlayerHeroes[i]) + "）" )
    set udg_PN[i] = udg_PlayerColors[i] + GetPlayerName(Player(i)) + "|r"
    call TriggerRegisterUnitEvent( gg_trg_CE_Input, udg_PlayerHeroes[ (i)], EVENT_UNIT_DAMAGED )
    call UnitRemoveAbility( udg_PlayerHeroes[i], 'Asud' )
    call UnitRemoveAbility( udg_PlayerHeroes[i], 'Aall' )
    call ModifyHeroSkillPoints( udg_PlayerHeroes[i], bj_MODIFYMETHOD_SET, 1 )
    //call SetUnitPropWindow(udg_PlayerHeroes[i],GetUnitDefaultPropWindow(udg_PlayerHeroes[i]))
    call TriggerExecute( gg_trg_Setup_Game_Info_Board )
endif
set PLY = null
set caster = null
endfunction

function Trig_AI_Register_Learning_Skill takes nothing returns nothing
    local integer i = GetPlayerId(GetEnumPlayer())
    call AI_LearnSkill(udg_PlayerHeroes[i])
    call TriggerRegisterUnitEvent( gg_trg_AI_Learn, udg_PlayerHeroes[i], EVENT_UNIT_HERO_LEVEL )
endfunction

function Trig_AI_Register_Revive_Events takes nothing returns nothing
    local integer i = GetPlayerId(GetEnumPlayer())
    call TriggerRegisterUnitEvent( gg_trg_AI_Revive, udg_PlayerHeroes[i], EVENT_UNIT_HERO_REVIVE_FINISH )
endfunction

//===========================================================================

function Trig_AI_Init_Conditions takes nothing returns boolean
    call CountAIPlayerSum()
    return udg_AI_DataBase[0]>0
endfunction

function Trig_AI_Init_Actions takes nothing returns nothing
    
    call DestroyTrigger(gg_trg_AI_Init)
    if IsBanMode() then
    call ForForce( udg_AI_Players, function Trig_AI_PickHero )
    endif
    
    call ForForce( udg_OnlinePlayers, function Trig_AI_Team_Players )
    
    set gg_trg_AI_Learn = CreateTrigger()
    call ForForce( udg_AI_Players, function Trig_AI_Register_Learning_Skill )
    call TriggerAddAction( gg_trg_AI_Learn, function Trig_AI_Learn_Actions )
    
    set gg_trg_AI_Revive = CreateTrigger()
    call ForForce( udg_AI_Players, function Trig_AI_Register_Revive_Events )
    call TriggerAddCondition( gg_trg_AI_Revive, Condition( function Trig_AI_Revive_Conditions ) )
    call TriggerAddAction( gg_trg_AI_Revive, function Trig_AI_Revive_Actions )
    
    set gg_trg_AI_EXP_Bonus = CreateTrigger()
    call TriggerRegisterEnterRectSimple( gg_trg_AI_EXP_Bonus, gg_rct_BaseA )
    call TriggerRegisterEnterRectSimple( gg_trg_AI_EXP_Bonus, gg_rct_BaseB )
    call TriggerAddCondition( gg_trg_AI_EXP_Bonus, Condition( function Trig_AI_EXP_Bonus_Conditions ) )
    call TriggerAddAction( gg_trg_AI_EXP_Bonus, function Trig_AI_EXP_Bonus_Actions )
    
    call TriggerExecute( gg_trg_AI_Action )
    
endfunction

//===========================================================================
function InitTrig_AI_Init takes nothing returns nothing
    set gg_trg_AI_Init = CreateTrigger()
    call TriggerAddCondition( gg_trg_AI_Init, Condition( function Trig_AI_Init_Conditions ) )
    call TriggerAddAction( gg_trg_AI_Init, function Trig_AI_Init_Actions )
endfunction
//===========================================================================
// Trigger: Initialization CMD
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--设置游戏命令代码
//===========================================================================
function Trig_Initialization_CMD_Func001A takes nothing returns nothing
    call TriggerRegisterPlayerChatEvent( gg_trg_TEST_MODE_OPEN, GetEnumPlayer(), "/*#thd#*/", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_TEST_MODE_OFF, GetEnumPlayer(), "/*#dht#*/", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_TEST_MODE_OPEN, GetEnumPlayer(), "/*#test#*/", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_TEST_MODE_OFF, GetEnumPlayer(), "/*#endtest#*/", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_Debug_Fog, GetEnumPlayer(), "/fog", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_Command_PS, GetEnumPlayer(), "/ps", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_PowerOpen, GetEnumPlayer(), "/PowerOpen", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_PointOpen, GetEnumPlayer(), "/PointOpen", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_PowerOff, GetEnumPlayer(), "/PowerOff", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_PointOff, GetEnumPlayer(), "/PointOff", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_Debug_TOD, GetEnumPlayer(), "/tod", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_Debug_TODMORE, GetEnumPlayer(), "/tod+", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_Debug_Spirit, GetEnumPlayer(), "/spirit", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_Debug_Level_Up_All, GetEnumPlayer(), "/up", false )
endfunction

function Trig_Initialization_CMD_Func002A takes nothing returns nothing
    call TriggerRegisterPlayerChatEvent( gg_trg_Command_Move_Speed, GetEnumPlayer(), "-ms", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_Command_Kill, GetEnumPlayer(), "-df", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_Debug_Kill, GetEnumPlayer(), "/kill", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_Debug_CD, GetEnumPlayer(), "/cd", true )
    call TriggerRegisterPlayerChatEvent( gg_trg_Debug_Level, GetEnumPlayer(), "/lvlup", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_Debug_Gold, GetEnumPlayer(), "/gold", false )
    call TriggerRegisterPlayerChatEvent( gg_trg_Debug_Death, GetEnumPlayer(), "/death?", true )
endfunction

function Trig_Initialization_CMD_Actions takes nothing returns nothing
    call ForForce( bj_FORCE_ALL_PLAYERS, function Trig_Initialization_CMD_Func001A )
    call ForForce( udg_OnlinePlayers, function Trig_Initialization_CMD_Func002A )
endfunction

//===========================================================================
function InitTrig_Initialization_CMD takes nothing returns nothing
    set gg_trg_Initialization_CMD = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Initialization_CMD, function Trig_Initialization_CMD_Actions )
endfunction

//===========================================================================
// Trigger: Close TEST MODE
//===========================================================================
function Trig_Close_TEST_MODE_Actions takes nothing returns nothing
    set udg_TestMode_Close = true
endfunction

//===========================================================================
function InitTrig_Close_TEST_MODE takes nothing returns nothing
    set gg_trg_Close_TEST_MODE = CreateTrigger(  )
    call TriggerRegisterTimerEventSingle( gg_trg_Close_TEST_MODE, 180.00 )
    call TriggerAddAction( gg_trg_Close_TEST_MODE, function Trig_Close_TEST_MODE_Actions )
endfunction

//===========================================================================
// Trigger: Command Move Speed
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--显示英雄移动速度
//===========================================================================
function Trig_Command_Move_Speed_Actions takes nothing returns nothing
    local integer i = GetPlayerId(GetTriggerPlayer())
    call DisplayTextToPlayer( GetTriggerPlayer(), 0, 0, ( "英雄移动速度：" + R2SW(GetUnitMoveSpeed(udg_PlayerHeroes[ (i)]), 4, 2) ) )
endfunction

//===========================================================================
function InitTrig_Command_Move_Speed takes nothing returns nothing
    set gg_trg_Command_Move_Speed = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Command_Move_Speed, function Trig_Command_Move_Speed_Actions )
endfunction

//===========================================================================
// Trigger: Command Kill
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--杀死英雄
//===========================================================================
function Trig_Command_Kill_Actions takes nothing returns nothing
    local unit h = GetPlayerCharacter(GetTriggerPlayer())
    call PauseUnit(h,true)
    call TriggerSleepAction( 20.00 )
    call PauseUnit(h,false)
    call KillUnit(       (h) )
    set h = null
endfunction

//===========================================================================
function InitTrig_Command_Kill takes nothing returns nothing
    set gg_trg_Command_Kill = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Command_Kill, function Trig_Command_Kill_Actions )
endfunction

//===========================================================================
// Trigger: Command PS
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--显示实际玩家数目
//===========================================================================
function Trig_Command_PS_Actions takes nothing returns nothing
    call DisplayTextToPlayer( GetTriggerPlayer(), 0, 0, I2S(CountPlayersInForceBJ(udg_OnlinePlayers)) )
endfunction

//===========================================================================
function InitTrig_Command_PS takes nothing returns nothing
    set gg_trg_Command_PS = CreateTrigger(  )
    call TriggerAddAction( gg_trg_Command_PS, function Trig_Command_PS_Actions )
endfunction

//===========================================================================
// Trigger: PointOpen
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--显示英雄移动速度
//===========================================================================
function Trig_PointOpen_Actions takes nothing returns nothing
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_6395" )
    call EnableTrigger( gg_trg_Point_Creat )
    call EnableTrigger( gg_trg_Point_Delete )
endfunction

//===========================================================================
function InitTrig_PointOpen takes nothing returns nothing
    set gg_trg_PointOpen = CreateTrigger(  )
    call TriggerAddAction( gg_trg_PointOpen, function Trig_PointOpen_Actions )
endfunction

//===========================================================================
// Trigger: PowerOpen
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--显示英雄移动速度
//===========================================================================
function Trig_PowerOpen_Actions takes nothing returns nothing
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_6396" )
    call EnableTrigger( gg_trg_Power_Create )
    call EnableTrigger( gg_trg_Power_Get )
    call EnableTrigger( gg_trg_Power_Lost )
endfunction

//===========================================================================
function InitTrig_PowerOpen takes nothing returns nothing
    set gg_trg_PowerOpen = CreateTrigger(  )
    call TriggerAddAction( gg_trg_PowerOpen, function Trig_PowerOpen_Actions )
endfunction

//===========================================================================
// Trigger: PointOff
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--显示英雄移动速度
//===========================================================================
function Trig_PointOff_Actions takes nothing returns nothing
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_6397" )
    call DisableTrigger( gg_trg_Point_Creat )
    call DisableTrigger( gg_trg_Point_Delete )
endfunction

//===========================================================================
function InitTrig_PointOff takes nothing returns nothing
    set gg_trg_PointOff = CreateTrigger(  )
    call TriggerAddAction( gg_trg_PointOff, function Trig_PointOff_Actions )
endfunction

//===========================================================================
// Trigger: PowerOff
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--显示英雄移动速度
//===========================================================================
function Trig_PowerOff_Actions takes nothing returns nothing
    call DisplayTextToForce( GetPlayersAll(), "TRIGSTR_6398" )
    call DisableTrigger( gg_trg_Power_Create )
    call DisableTrigger( gg_trg_Power_Get )
    call DisableTrigger( gg_trg_Power_Lost )
endfunction

//===========================================================================
function InitTrig_PowerOff takes nothing returns nothing
    set gg_trg_PowerOff = CreateTrigger(  )
    call TriggerAddAction( gg_trg_PowerOff, function Trig_PowerOff_Actions )
endfunction

//===========================================================================
// Trigger: TEST MODE OPEN
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--显示实际玩家数目
//===========================================================================
function Trig_TEST_MODE_OPEN_Func001Func004A takes nothing returns nothing
    call DisplayTimedTextToPlayer( GetEnumPlayer(), 0, 0, 15.00, "TRIGSTR_593" )
endfunction

function Trig_TEST_MODE_OPEN_Func001C takes nothing returns boolean
    if ( not ( udg_TestMode_Close == false ) ) then
        return false
    endif
    return true
endfunction

function Trig_TEST_MODE_OPEN_Actions takes nothing returns nothing
    if ( Trig_TEST_MODE_OPEN_Func001C() ) then
        set udg_TestMode = true
        set udg_DebugMode = true
        call ForForce( bj_FORCE_ALL_PLAYERS, function Trig_TEST_MODE_OPEN_Func001Func004A )
        call DisableTrigger( GetTriggeringTrigger() )
    else
    endif
endfunction

//===========================================================================
function InitTrig_TEST_MODE_OPEN takes nothing returns nothing
    set gg_trg_TEST_MODE_OPEN = CreateTrigger(  )
    call TriggerAddAction( gg_trg_TEST_MODE_OPEN, function Trig_TEST_MODE_OPEN_Actions )
endfunction

//===========================================================================
// Trigger: TEST MODE OFF
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--显示实际玩家数目
//===========================================================================
function Trig_TEST_MODE_OFF_Func003A takes nothing returns nothing
    call DisplayTextToPlayer( GetEnumPlayer(), 0, 0, "TRIGSTR_6400" )
endfunction

function Trig_TEST_MODE_OFF_Actions takes nothing returns nothing
    set udg_TestMode = false
    set udg_DebugMode = false
    call ForForce( bj_FORCE_ALL_PLAYERS, function Trig_TEST_MODE_OFF_Func003A )
    call DisableTrigger( GetTriggeringTrigger() )
endfunction

//===========================================================================
function InitTrig_TEST_MODE_OFF takes nothing returns nothing
    set gg_trg_TEST_MODE_OFF = CreateTrigger(  )
    call TriggerAddAction( gg_trg_TEST_MODE_OFF, function Trig_TEST_MODE_OFF_Actions )
endfunction

//===========================================================================
// Trigger: Debug Fog
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--显示全图
//===========================================================================
function Trig_Debug_Fog_Conditions takes nothing returns boolean
    if ( not ( udg_TestMode == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Debug_Fog_Func002C takes nothing returns boolean
    if ( not ( IsFogEnabled() == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Debug_Fog_Actions takes nothing returns nothing
    if ( Trig_Debug_Fog_Func002C() ) then
        call FogEnable( false )
        call FogMaskEnable( false )
    else
        call FogEnable( true )
        call FogMaskEnable( true )
    endif
endfunction

//===========================================================================
function InitTrig_Debug_Fog takes nothing returns nothing
    set gg_trg_Debug_Fog = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Debug_Fog, Condition( function Trig_Debug_Fog_Conditions ) )
    call TriggerAddAction( gg_trg_Debug_Fog, function Trig_Debug_Fog_Actions )
endfunction

//===========================================================================
// Trigger: Debug CD
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--刷新CD 血量和魔法值
//===========================================================================
function Trig_Debug_CD_Conditions takes nothing returns boolean
    if ( not ( udg_TestMode == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Debug_CD_Actions takes nothing returns nothing
    local integer i = GetPlayerId(GetTriggerPlayer())
    call SetUnitLifePercentBJ( udg_PlayerHeroes[ (i)], 100 )
    call SetUnitManaPercentBJ( udg_PlayerHeroes[ (i)], 100 )
    call UnitResetCooldown( udg_PlayerHeroes[ (i)] )
endfunction

//===========================================================================
function InitTrig_Debug_CD takes nothing returns nothing
    set gg_trg_Debug_CD = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Debug_CD, Condition( function Trig_Debug_CD_Conditions ) )
    call TriggerAddAction( gg_trg_Debug_CD, function Trig_Debug_CD_Actions )
endfunction

//===========================================================================
// Trigger: Debug Level
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--立即升级
//===========================================================================
function Trig_Debug_Level_Conditions takes nothing returns boolean
    if ( not ( udg_TestMode == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Debug_Level_Actions takes nothing returns nothing
    local integer i = GetPlayerId(GetTriggerPlayer())
    local integer j = GetHeroLevel(udg_PlayerHeroes[i]) + S2I(SubString(GetEventPlayerChatString(),7,9))
    call SetHeroLevel( udg_PlayerHeroes[ (i)],  (j), true )
endfunction

//===========================================================================
function InitTrig_Debug_Level takes nothing returns nothing
    set gg_trg_Debug_Level = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Debug_Level, Condition( function Trig_Debug_Level_Conditions ) )
    call TriggerAddAction( gg_trg_Debug_Level, function Trig_Debug_Level_Actions )
endfunction

//===========================================================================
// Trigger: Debug Gold
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--给与金钱
//===========================================================================
function Trig_Debug_Gold_Conditions takes nothing returns boolean
    if ( not ( udg_TestMode == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Debug_Gold_Actions takes nothing returns nothing
    local integer i = S2I(SubString(GetEventPlayerChatString(),6,11))
    call AdjustPlayerStateBJ(  (i), GetTriggerPlayer(), PLAYER_STATE_RESOURCE_GOLD )
endfunction

//===========================================================================
function InitTrig_Debug_Gold takes nothing returns nothing
    set gg_trg_Debug_Gold = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Debug_Gold, Condition( function Trig_Debug_Gold_Conditions ) )
    call TriggerAddAction( gg_trg_Debug_Gold, function Trig_Debug_Gold_Actions )
endfunction

//===========================================================================
// Trigger: Debug Spirit
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--给与信仰
//===========================================================================
function Trig_Debug_Spirit_Conditions takes nothing returns boolean
    if ( not ( udg_TestMode == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Debug_Spirit_Actions takes nothing returns nothing
    local integer i = S2I(SubString(GetEventPlayerChatString(),8,13))
    call THD_AddSpirit(GetTriggerPlayer(),i)
endfunction

//===========================================================================
function InitTrig_Debug_Spirit takes nothing returns nothing
    set gg_trg_Debug_Spirit = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Debug_Spirit, Condition( function Trig_Debug_Spirit_Conditions ) )
    call TriggerAddAction( gg_trg_Debug_Spirit, function Trig_Debug_Spirit_Actions )
endfunction

//===========================================================================
// Trigger: Debug Death
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--杀死英雄
//===========================================================================
function Trig_Debug_Death_Conditions takes nothing returns boolean
    if ( not ( udg_TestMode == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Debug_Death_Actions takes nothing returns nothing
    local integer i = GetPlayerId(GetTriggerPlayer())
    if IsUnitDeadBJ(udg_PlayerHeroes[i])==true then
    call BJDebugMsg("true")
    call BJDebugMsg(R2S(GetUnitState(udg_PlayerHeroes[i], UNIT_STATE_LIFE)))
    else
    call BJDebugMsg("false")
    call BJDebugMsg(R2S(GetUnitState(udg_PlayerHeroes[i], UNIT_STATE_LIFE)))
    endif
endfunction

//===========================================================================
function InitTrig_Debug_Death takes nothing returns nothing
    set gg_trg_Debug_Death = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Debug_Death, Condition( function Trig_Debug_Death_Conditions ) )
    call TriggerAddAction( gg_trg_Debug_Death, function Trig_Debug_Death_Actions )
endfunction

//===========================================================================
// Trigger: Debug Level Up All
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--全员升级
//===========================================================================
function Trig_Debug_Level_Up_All_Conditions takes nothing returns boolean
    if ( not ( udg_TestMode == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Debug_Level_Up_All_Func001Func001A takes nothing returns nothing
    local integer i = GetPlayerId(GetEnumPlayer())
    call SetHeroLevel( udg_PlayerHeroes[ (i)], ( GetHeroLevel(udg_PlayerHeroes[ (i)]) + 1 ), true )
endfunction

function Trig_Debug_Level_Up_All_Actions takes nothing returns nothing
    set bj_forLoopBIndex = 1
    set bj_forLoopBIndexEnd = S2I(SubString(GetEventPlayerChatString(), 4, 6))
    loop
        exitwhen bj_forLoopBIndex > bj_forLoopBIndexEnd
        call ForForce( udg_OnlinePlayers, function Trig_Debug_Level_Up_All_Func001Func001A )
        call TriggerSleepAction( 0.20 )
        set bj_forLoopBIndex = bj_forLoopBIndex + 1
    endloop
endfunction

//===========================================================================
function InitTrig_Debug_Level_Up_All takes nothing returns nothing
    set gg_trg_Debug_Level_Up_All = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Debug_Level_Up_All, Condition( function Trig_Debug_Level_Up_All_Conditions ) )
    call TriggerAddAction( gg_trg_Debug_Level_Up_All, function Trig_Debug_Level_Up_All_Actions )
endfunction

//===========================================================================
// Trigger: Debug TOD
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--设置游戏时间
//===========================================================================
function Trig_Debug_TOD_Conditions takes nothing returns boolean
    if ( not ( udg_TestMode == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Debug_TOD_Actions takes nothing returns nothing
    local integer i = GetPlayerId(GetTriggerPlayer())
    local real s = S2I(SubString(GetEventPlayerChatString(),5,9))
    call SetTimeOfDay(    (s) )
endfunction

//===========================================================================
function InitTrig_Debug_TOD takes nothing returns nothing
    set gg_trg_Debug_TOD = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Debug_TOD, Condition( function Trig_Debug_TOD_Conditions ) )
    call TriggerAddAction( gg_trg_Debug_TOD, function Trig_Debug_TOD_Actions )
endfunction

//===========================================================================
// Trigger: Debug TODMORE
//===========================================================================
function Trig_Debug_TODMORE_Conditions takes nothing returns boolean
    if ( not ( udg_TestMode == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Debug_TODMORE_Actions takes nothing returns nothing
    call SetTimeOfDayScale( 20.00 )
endfunction

//===========================================================================
function InitTrig_Debug_TODMORE takes nothing returns nothing
    set gg_trg_Debug_TODMORE = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Debug_TODMORE, Condition( function Trig_Debug_TODMORE_Conditions ) )
    call TriggerAddAction( gg_trg_Debug_TODMORE, function Trig_Debug_TODMORE_Actions )
endfunction

//===========================================================================
// Trigger: Debug Kill
//
// THDOTA-0.800 for Warcraft 1.24b Rewritten by HJISTC
// ---------------------------------------------------
// 游戏命令--杀死英雄
//===========================================================================
function Trig_Debug_Kill_Conditions takes nothing returns boolean
    if ( not ( udg_TestMode == true ) ) then
        return false
    endif
    return true
endfunction

function Trig_Debug_Kill_Actions takes nothing returns nothing
    local integer i = GetPlayerId(GetTriggerPlayer())
    call KillUnit( udg_PlayerHeroes[ (i)] )
endfunction

//===========================================================================
function InitTrig_Debug_Kill takes nothing returns nothing
    set gg_trg_Debug_Kill = CreateTrigger(  )
    call TriggerAddCondition( gg_trg_Debug_Kill, Condition( function Trig_Debug_Kill_Conditions ) )
    call TriggerAddAction( gg_trg_Debug_Kill, function Trig_Debug_Kill_Actions )
endfunction

//===========================================================================
// Trigger: MapMain
//===========================================================================
//TESH.scrollpos=-1
//TESH.alwaysfold=0

function InitTrig_MapMain takes nothing returns nothing
    call Trig_Initialization_UDG_Actions()
    call Trig_Master_Initialization_Actions()
endfunction
//===========================================================================
function InitCustomTriggers takes nothing returns nothing
    call InitTrig_OpenSmileys(  )
    call InitTrig_QuickSmileys(  )
    call InitTrig_Systems(  )
    call InitTrig_Override_Systems(  )
    call InitTrig_Misc(  )
    call InitTrig_Any_Unit_Damaged(  )
    call InitTrig_AI_System(  )
    call InitTrig_HC_System(  )
    call InitTrig_Setting_Balance(  )
    call InitTrig_Setting_Character_A(  )
    call InitTrig_Setting_Character_B(  )
    call InitTrig_Setting_Item_System_Table_1(  )
    call InitTrig_Setting_Item_System_Table_2(  )
    call InitTrig_Setting_Neutrals(  )
    call InitTrig_Setting_Spawn(  )
    call InitTrig_Setting_Item_System_Table_3(  )
    call InitTrig_About_Map(  )
    call InitTrig_Announce(  )
    call InitTrig_Master_Initialization(  )
    call InitTrig_Master_Trigger(  )
    call InitTrig_Initialization_Players(  )
    call InitTrig_Initialization_UDG(  )
    call InitTrig_Initialization_Locations(  )
    call InitTrig_Enter_Mode_Select(  )
    call InitTrig_Mode_Select_Step_1(  )
    call InitTrig_Mode_Select_Step_2(  )
    call InitTrig_Mode_Select_Time_Out(  )
    call InitTrig_Initialization_CSS(  )
    call InitTrig_Enter_Character_Select_Screen(  )
    call InitTrig_CSS(  )
    call InitTrig_CSS_GUI(  )
    call InitTrig_CSS_Event(  )
    call InitTrig_CSS_Main(  )
    call InitTrig_CSS_Ban_Mode(  )
    call InitTrig_CSS_Ban_Mode_Step2(  )
    call InitTrig_CSS_Ban_Pick(  )
    call InitTrig_CSS_Action(  )
    call InitTrig_CSS_Setup(  )
    call InitTrig_CSS_AI(  )
    call InitTrig_CSS_Finish(  )
    call InitTrig_GIB(  )
    call InitTrig_Setup_Game_Info_Board(  )
    call InitTrig_Set_GIB_Clock(  )
    call InitTrig_Resource_System(  )
    call InitTrig_Spirit(  )
    call InitTrig_Power_Create(  )
    call InitTrig_Power_Get(  )
    call InitTrig_Power_Lost(  )
    call InitTrig_Initialization_Spawn(  )
    call InitTrig_Route_A(  )
    call InitTrig_Route_B(  )
    call InitTrig_Route_Order(  )
    call InitTrig_Keep_Order_A(  )
    call InitTrig_Keep_Order_B(  )
    call InitTrig_Spawn_A(  )
    call InitTrig_Spawn_B(  )
    call InitTrig_Spawn_Levelup(  )
    call InitTrig_Spawn_Units_AI(  )
    call InitTrig_Refresh_Order(  )
    call InitTrig_Initialization_Base(  )
    call InitTrig_Tower_Break_A(  )
    call InitTrig_Tower_Break_A_Patch(  )
    call InitTrig_Tower_Break_B(  )
    call InitTrig_Tower_Break_B_Patch(  )
    call InitTrig_Initialization_Weather(  )
    call InitTrig_Weather_Change(  )
    call InitTrig_Weather_Fog_System(  )
    call InitTrig_Weather_Shrine_Reset(  )
    call InitTrig_Weather_Trigger(  )
    call InitTrig_Weather_Effect_Create(  )
    call InitTrig_Weather_Effect_Remove(  )
    call InitTrig_Weather_Effect_Spell(  )
    call InitTrig_Weather_Spell_02(  )
    call InitTrig_Weather_Spell_02_Off(  )
    call InitTrig_Initialization_Defence(  )
    call InitTrig_Defence_DefArea(  )
    call InitTrig_Defence_Eating(  )
    call InitTrig_Defence_BL(  )
    call InitTrig_Defence_Control_1(  )
    call InitTrig_Defence_SpdArea(  )
    call InitTrig_Defence_SCV(  )
    call InitTrig_Defence_God(  )
    call InitTrig_Defence_Control_2(  )
    call InitTrig_RuneBorn(  )
    call InitTrig_Rune(  )
    call InitTrig_Tree_Bridge(  )
    call InitTrig_Trees_Relife(  )
    call InitTrig_Bridge_Restore(  )
    call InitTrig_BoatRL(  )
    call InitTrig_BoatLR(  )
    call InitTrig_Jump1(  )
    call InitTrig_Jump2(  )
    call InitTrig_Jump3(  )
    call InitTrig_Jump4(  )
    call InitTrig_Jump5(  )
    call InitTrig_Jump6(  )
    call InitTrig_GoodMan(  )
    call InitTrig_Initialization_Market(  )
    call InitTrig_Item_System(  )
    call InitTrig_Item_Exchange(  )
    call InitTrig_Initialization_CE(  )
    call InitTrig_CE_Input(  )
    call InitTrig_CE_Bonus(  )
    call InitTrig_Announce_Bonus(  )
    call InitTrig_Game_Start(  )
    call InitTrig_Time_Event(  )
    call InitTrig_Money(  )
    call InitTrig_Share(  )
    call InitTrig_Point_Creat(  )
    call InitTrig_Point_Delete(  )
    call InitTrig_Attack(  )
    call InitTrig_Deny(  )
    call InitTrig_Hero_Event(  )
    call InitTrig_Victory(  )
    call InitTrig_Player_Left(  )
    call InitTrig_FeetManFix(  )
    call InitTrig_Neutral_System(  )
    call InitTrig_ItemClear(  )
    call InitTrig_Init_Abilities(  )
    call InitTrig_Marisa01(  )
    call InitTrig_Marisa02(  )
    call InitTrig_Marisa03(  )
    call InitTrig_Marisa04(  )
    call InitTrig_Initial_Marisa(  )
    call InitTrig_SakuyaDS(  )
    call InitTrig_SakuyaClock(  )
    call InitTrig_Sakuya01(  )
    call InitTrig_Sakuya02(  )
    call InitTrig_Sakuya03(  )
    call InitTrig_Sakuya04(  )
    call InitTrig_Sakuya04_Reset(  )
    call InitTrig_Sakuya04_Enter(  )
    call InitTrig_Initial_Sakuya(  )
    call InitTrig_ReimuEx(  )
    call InitTrig_Reimu01(  )
    call InitTrig_Reimu02(  )
    call InitTrig_Reimu03(  )
    call InitTrig_Reimu04(  )
    call InitTrig_Initial_Reimu(  )
    call InitTrig_YukariEyebug(  )
    call InitTrig_Yukari02(  )
    call InitTrig_Yukari02_Gap_Dump(  )
    call InitTrig_Yukari02_Mega_Dump(  )
    call InitTrig_Yukari03(  )
    call InitTrig_Yukari04_New(  )
    call InitTrig_Yukari04_New_Effect(  )
    call InitTrig_Yukari04_DS(  )
    call InitTrig_Initial_Yukari(  )
    call InitTrig_IkuTime(  )
    call InitTrig_Iku01(  )
    call InitTrig_Iku02(  )
    call InitTrig_Iku03_Active(  )
    call InitTrig_Iku03(  )
    call InitTrig_Iku04(  )
    call InitTrig_Initial_Iku(  )
    call InitTrig_Mokou01(  )
    call InitTrig_Mokou02(  )
    call InitTrig_Mokou03(  )
    call InitTrig_Mokou04(  )
    call InitTrig_Mokou04_End(  )
    call InitTrig_Mokou04_AOE(  )
    call InitTrig_Initial_Mokou(  )
    call InitTrig_Yuyuko_Rekill(  )
    call InitTrig_Yuyuko01(  )
    call InitTrig_Yuyuko02(  )
    call InitTrig_Yuyuko03(  )
    call InitTrig_Yuyuko03_Damage(  )
    call InitTrig_Yuyuko03_Switch(  )
    call InitTrig_Yuyuko04(  )
    call InitTrig_Yuyuko04_Learn(  )
    call InitTrig_Init_Yuyuko(  )
    call InitTrig_AyaDS(  )
    call InitTrig_Aya01(  )
    call InitTrig_Aya02(  )
    call InitTrig_Aya02_Use(  )
    call InitTrig_Aya03(  )
    call InitTrig_Aya04(  )
    call InitTrig_Initial_Aya(  )
    call InitTrig_Suika01(  )
    call InitTrig_Suika02(  )
    call InitTrig_Suika03(  )
    call InitTrig_Suika04(  )
    call InitTrig_Initial_Suika(  )
    call InitTrig_Youmu01(  )
    call InitTrig_Youmu02(  )
    call InitTrig_Youmu03(  )
    call InitTrig_Youmu04(  )
    call InitTrig_Initial_Youmu(  )
    call InitTrig_Reisen_Attack(  )
    call InitTrig_Reisen01(  )
    call InitTrig_Reisen01_Count(  )
    call InitTrig_Reisen02_New(  )
    call InitTrig_Reisen03(  )
    call InitTrig_Reisen04(  )
    call InitTrig_Init_Reisen(  )
    call InitTrig_CirnoBaga(  )
    call InitTrig_Cirno01(  )
    call InitTrig_Cirno02(  )
    call InitTrig_Cirno03(  )
    call InitTrig_Cirno04(  )
    call InitTrig_Initial_Cirno(  )
    call InitTrig_FlandreBroker(  )
    call InitTrig_Flandre01(  )
    call InitTrig_Flandre02(  )
    call InitTrig_Flandre02_Skill(  )
    call InitTrig_Flandre04(  )
    call InitTrig_Initial_Flandre(  )
    call InitTrig_SanaeEx(  )
    call InitTrig_Sanae01(  )
    call InitTrig_Sanae02(  )
    call InitTrig_Sanae03(  )
    call InitTrig_Sanae04(  )
    call InitTrig_Initial_Sanae(  )
    call InitTrig_TensiDS(  )
    call InitTrig_Tensi01(  )
    call InitTrig_Tensi02(  )
    call InitTrig_Tensi03(  )
    call InitTrig_Tensi04(  )
    call InitTrig_Init_Tensi(  )
    call InitTrig_UtsuhoEx(  )
    call InitTrig_Utsuho01(  )
    call InitTrig_Utsuho02(  )
    call InitTrig_Utsuho03(  )
    call InitTrig_Utsuho04(  )
    call InitTrig_Initial_Utsuho(  )
    call InitTrig_Rumia01(  )
    call InitTrig_Rumia02(  )
    call InitTrig_Rumia03(  )
    call InitTrig_Rumia04(  )
    call InitTrig_Rumia04_Lost(  )
    call InitTrig_Initial_Rumia(  )
    call InitTrig_YukaFlower(  )
    call InitTrig_YukaFlower_Levelup(  )
    call InitTrig_Yuka01(  )
    call InitTrig_Yuka02(  )
    call InitTrig_Yuka03(  )
    call InitTrig_Yuka04(  )
    call InitTrig_Initial_Yuka(  )
    call InitTrig_Medi02(  )
    call InitTrig_Medi03(  )
    call InitTrig_Medi04(  )
    call InitTrig_Initial_Medi(  )
    call InitTrig_EirinSage(  )
    call InitTrig_Eirin01(  )
    call InitTrig_Eirin02(  )
    call InitTrig_Eirin03(  )
    call InitTrig_Eirin04(  )
    call InitTrig_Initial_Eirin(  )
    call InitTrig_KaguyaEx(  )
    call InitTrig_Kaguya01(  )
    call InitTrig_Kaguya02(  )
    call InitTrig_Kaguya03(  )
    call InitTrig_Kaguya04(  )
    call InitTrig_Init_Kaguya(  )
    call InitTrig_Letty01(  )
    call InitTrig_Letty02New(  )
    call InitTrig_Letty02(  )
    call InitTrig_Letty02main(  )
    call InitTrig_Letty04(  )
    call InitTrig_Initial_Letty(  )
    call InitTrig_Nitori_Bag(  )
    call InitTrig_Nitori_Loaded(  )
    call InitTrig_Nitori01(  )
    call InitTrig_Nitori02(  )
    call InitTrig_Nitori03(  )
    call InitTrig_Nitori03_Active(  )
    call InitTrig_Nitori04(  )
    call InitTrig_Initial_Nitori(  )
    call InitTrig_YamameDS(  )
    call InitTrig_Yamame_Dis(  )
    call InitTrig_Yamame01(  )
    call InitTrig_Yamame02(  )
    call InitTrig_Yamame03(  )
    call InitTrig_Yamame04(  )
    call InitTrig_Initial_Spider(  )
    call InitTrig_Yuugi_Roar(  )
    call InitTrig_Yuugi01(  )
    call InitTrig_Yuugi02(  )
    call InitTrig_Yuugi03(  )
    call InitTrig_Yuugi04(  )
    call InitTrig_Initial_Yuugi(  )
    call InitTrig_Wriggle01(  )
    call InitTrig_Wriggle02(  )
    call InitTrig_Wriggle03(  )
    call InitTrig_Wriggle04(  )
    call InitTrig_Initial_Wriggle(  )
    call InitTrig_CaptainEyebug01(  )
    call InitTrig_CaptainEyebug02(  )
    call InitTrig_CaptainEyebug03(  )
    call InitTrig_CaptainEyebug04(  )
    call InitTrig_CaptainEyebug05(  )
    call InitTrig_CaptainEyebug06(  )
    call InitTrig_CaptainEyebug07(  )
    call InitTrig_CaptainEyebug08(  )
    call InitTrig_CaptainEyebug09(  )
    call InitTrig_CaptainEyebug10(  )
    call InitTrig_CaptainEyebug11(  )
    call InitTrig_CaptainEyebug12(  )
    call InitTrig_Captain01(  )
    call InitTrig_Captain02(  )
    call InitTrig_Captain03(  )
    call InitTrig_Captain04_Learn(  )
    call InitTrig_Captain04_Reg(  )
    call InitTrig_Captain04_LostShip(  )
    call InitTrig_Captain04_jiasu(  )
    call InitTrig_Captain04_jiansu(  )
    call InitTrig_Captain04_yongjiutingbo(  )
    call InitTrig_Captain04_nihility(  )
    call InitTrig_Captain04_CallBack(  )
    call InitTrig_Initial_Captain(  )
    call InitTrig_Shikieiki01(  )
    call InitTrig_Shikieiki01_Active(  )
    call InitTrig_Shikieiki01_Display(  )
    call InitTrig_Shikieiki01_Death(  )
    call InitTrig_Shikieiki02(  )
    call InitTrig_Shikieiki03(  )
    call InitTrig_Shikieiki04(  )
    call InitTrig_Initial_Shikieiki(  )
    call InitTrig_Cat01_Reg(  )
    call InitTrig_Cat01_BodyGet(  )
    call InitTrig_Cat01_BodyRemove(  )
    call InitTrig_Cat02(  )
    call InitTrig_Cat03(  )
    call InitTrig_Cat04(  )
    call InitTrig_Initial_Cat(  )
    call InitTrig_KogasaDS(  )
    call InitTrig_Kogasa01(  )
    call InitTrig_Kogasa02(  )
    call InitTrig_Kogasa03(  )
    call InitTrig_Kogasa03_Learn(  )
    call InitTrig_Kogasa04_Check(  )
    call InitTrig_Kogasa04(  )
    call InitTrig_Kogasa04_Cancel(  )
    call InitTrig_Initial_Umbrella(  )
    call InitTrig_Remilia01(  )
    call InitTrig_Remilia02(  )
    call InitTrig_Remilia03(  )
    call InitTrig_Remilia04(  )
    call InitTrig_Initial_Remilia(  )
    call InitTrig_Komachi01(  )
    call InitTrig_Komachi03(  )
    call InitTrig_Komachi04(  )
    call InitTrig_KomachiGhostExplosion(  )
    call InitTrig_KomachiALLExplosion(  )
    call InitTrig_Initial_Komachi(  )
    call InitTrig_Nazrin_Pet(  )
    call InitTrig_Nazrin01(  )
    call InitTrig_Nazrin02(  )
    call InitTrig_Nazrin03(  )
    call InitTrig_Nazrin04(  )
    call InitTrig_Nazrin04_Switch(  )
    call InitTrig_Init_Nazrin(  )
    call InitTrig_MystiaFly(  )
    call InitTrig_Mystia01(  )
    call InitTrig_Mystia02(  )
    call InitTrig_Mystia03(  )
    call InitTrig_Mystia04(  )
    call InitTrig_Init_Mystia(  )
    call InitTrig_Koishi01(  )
    call InitTrig_Koishi02(  )
    call InitTrig_Koishi04(  )
    call InitTrig_Koishi04_DS(  )
    call InitTrig_Init_Koishi(  )
    call InitTrig_Hina01(  )
    call InitTrig_Hina02(  )
    call InitTrig_Hina03(  )
    call InitTrig_Hina04(  )
    call InitTrig_Initial_Hina(  )
    call InitTrig_Ran01(  )
    call InitTrig_Ran01Up(  )
    call InitTrig_Ran02(  )
    call InitTrig_Ran03(  )
    call InitTrig_Ran04(  )
    call InitTrig_Chen(  )
    call InitTrig_Chen02(  )
    call InitTrig_Chen03(  )
    call InitTrig_Initial_Ran(  )
    call InitTrig_Kanako01(  )
    call InitTrig_Kanako02(  )
    call InitTrig_Kanako03(  )
    call InitTrig_Kanako04(  )
    call InitTrig_KanakoEX01(  )
    call InitTrig_KanakoEX02(  )
    call InitTrig_KanakoEX03(  )
    call InitTrig_Init_Kanako(  )
    call InitTrig_SuwakoEx(  )
    call InitTrig_Suwako01(  )
    call InitTrig_Suwako02(  )
    call InitTrig_Suwako03(  )
    call InitTrig_Suwako04(  )
    call InitTrig_Init_Suwako(  )
    call InitTrig_Pachouli_Attack(  )
    call InitTrig_Pachouli01(  )
    call InitTrig_Pachouli02(  )
    call InitTrig_Pachouli03(  )
    call InitTrig_Pachouli04(  )
    call InitTrig_Init_Pachouli(  )
    call InitTrig_MeirinStar(  )
    call InitTrig_Meirin(  )
    call InitTrig_Meirin01(  )
    call InitTrig_Meirin02(  )
    call InitTrig_Meirin03(  )
    call InitTrig_Meirin04(  )
    call InitTrig_Init_Meirin(  )
    call InitTrig_Alice_Dolls(  )
    call InitTrig_Alice_Dolls_KIA(  )
    call InitTrig_Alice_Dolls_Back(  )
    call InitTrig_Shanghai01(  )
    call InitTrig_Shanghai02(  )
    call InitTrig_Shanghai03(  )
    call InitTrig_Shanghai04(  )
    call InitTrig_Shanghai04_Issue(  )
    call InitTrig_Shanghai04_Alice(  )
    call InitTrig_Hourai01(  )
    call InitTrig_Hourai02(  )
    call InitTrig_Hourai04(  )
    call InitTrig_NewEngland01(  )
    call InitTrig_NewEngland03(  )
    call InitTrig_NewEngland04(  )
    call InitTrig_Alice(  )
    call InitTrig_Alice01(  )
    call InitTrig_Alice02(  )
    call InitTrig_Alice03(  )
    call InitTrig_Alice_Onboard(  )
    call InitTrig_Init_Alice(  )
    call InitTrig_Satori01(  )
    call InitTrig_Satori01_Collect(  )
    call InitTrig_Satori02(  )
    call InitTrig_Satori03(  )
    call InitTrig_Satori04(  )
    call InitTrig_Init_Satori(  )
    call InitTrig_shizuha01(  )
    call InitTrig_Shizuha02(  )
    call InitTrig_shizuha03(  )
    call InitTrig_Shizuha04(  )
    call InitTrig_Init_Shizuha(  )
    call InitTrig_Minoriko_Harvest(  )
    call InitTrig_Minoriko01(  )
    call InitTrig_Minoriko02(  )
    call InitTrig_Minoriko03(  )
    call InitTrig_Minoriko04(  )
    call InitTrig_Init_Minoriko(  )
    call InitTrig_Momizi01(  )
    call InitTrig_Momizi02(  )
    call InitTrig_Momizi03(  )
    call InitTrig_Init_Momizi(  )
    call InitTrig_NueAttack(  )
    call InitTrig_NueIllusionKill(  )
    call InitTrig_Nue01(  )
    call InitTrig_Nue02(  )
    call InitTrig_Nue03(  )
    call InitTrig_Nue04(  )
    call InitTrig_Initial_Nue(  )
    call InitTrig_Keine_Ability_Change(  )
    call InitTrig_Keine01(  )
    call InitTrig_Keine02(  )
    call InitTrig_Keine03(  )
    call InitTrig_Keine04(  )
    call InitTrig_Initial_Keine(  )
    call InitTrig_Byakuren01(  )
    call InitTrig_Byakuren02(  )
    call InitTrig_Byakuren03(  )
    call InitTrig_Byakuren04(  )
    call InitTrig_Byakuren04Attack(  )
    call InitTrig_Initial_Byakuren(  )
    call InitTrig_Twei01(  )
    call InitTrig_Twei01_Death(  )
    call InitTrig_Twei02(  )
    call InitTrig_Twei03(  )
    call InitTrig_Twei03_Damage(  )
    call InitTrig_Twei04(  )
    call InitTrig_Init_Twei(  )
    call InitTrig_KoakumaLibrary(  )
    call InitTrig_Koakuma(  )
    call InitTrig_Koakuma04_Effect(  )
    call InitTrig_Init_Koakuma(  )
    call InitTrig_Sunny03(  )
    call InitTrig_Sunny04(  )
    call InitTrig_Init_Sunny(  )
    call InitTrig_Orange01(  )
    call InitTrig_Init_Orange(  )
    call InitTrig_Lunasa01(  )
    call InitTrig_Lunasa02(  )
    call InitTrig_Lunasa03(  )
    call InitTrig_Lunasa04(  )
    call InitTrig_Init_Lunasa(  )
    call InitTrig_MerlinAttack(  )
    call InitTrig_MerlinEx(  )
    call InitTrig_Merlin01(  )
    call InitTrig_Merlin02(  )
    call InitTrig_Merlin03(  )
    call InitTrig_Merlin04(  )
    call InitTrig_Merlin04_Damage(  )
    call InitTrig_Init_Merlin(  )
    call InitTrig_ToramaruDB(  )
    call InitTrig_Toramaru01(  )
    call InitTrig_Toramaru01_Attack(  )
    call InitTrig_Toramaru02(  )
    call InitTrig_Toramaru02_Learn(  )
    call InitTrig_Toramaru03(  )
    call InitTrig_Toramaru03_Kill(  )
    call InitTrig_Toramaru04(  )
    call InitTrig_Initial_Toramaru(  )
    call InitTrig_Initial_Parsee(  )
    call InitTrig_KisumeDS(  )
    call InitTrig_Kisume01(  )
    call InitTrig_Kisume02(  )
    call InitTrig_Kisume03(  )
    call InitTrig_Kisume03_Damage(  )
    call InitTrig_Kisume04(  )
    call InitTrig_Initialing_Kisume(  )
    call InitTrig_Hatate01(  )
    call InitTrig_Hatate01_Learn(  )
    call InitTrig_Hatate02(  )
    call InitTrig_Hatate02_Attack(  )
    call InitTrig_Hatate03(  )
    call InitTrig_Hatate04(  )
    call InitTrig_Hatate04_Learn(  )
    call InitTrig_Hatate04_Ex(  )
    call InitTrig_Initialing_Hatate(  )
    call InitTrig_Initialization_ItemAbilities(  )
    call InitTrig_Mashroom(  )
    call InitTrig_TreeEyes(  )
    call InitTrig_Doll_Cast(  )
    call InitTrig_Doll_Issue(  )
    call InitTrig_Doll_Move(  )
    call InitTrig_Lunchbox(  )
    call InitTrig_Lunchbox_Collecting(  )
    call InitTrig_ChuShou(  )
    call InitTrig_QiQiu(  )
    call InitTrig_Peach(  )
    call InitTrig_Magic_String(  )
    call InitTrig_Cirno_Ball(  )
    call InitTrig_XinHua(  )
    call InitTrig_BaGuaLu(  )
    call InitTrig_YukkuriUpgrade(  )
    call InitTrig_HuDieMengWan(  )
    call InitTrig_Hourai_Elixir(  )
    call InitTrig_Hourai_Elixir_Drop(  )
    call InitTrig_WoCao2KuangCao(  )
    call InitTrig_KuangCao2WoCao(  )
    call InitTrig_KuangCaoManaCost(  )
    call InitTrig_LvBaHuaJiHuHang(  )
    call InitTrig_Mr_Yang(  )
    call InitTrig_Jinkela(  )
    call InitTrig_XiongGui(  )
    call InitTrig_Yukkuri_Morph(  )
    call InitTrig_DaoYao(  )
    call InitTrig_DaJiangYou(  )
    call InitTrig_TuPao(  )
    call InitTrig_Kafziel(  )
    call InitTrig_Verity(  )
    call InitTrig_YYY(  )
    call InitTrig_CardWorseMan(  )
    call InitTrig_BLTalismanic(  )
    call InitTrig_BLTalismanicDrop(  )
    call InitTrig_CardGoodMan(  )
    call InitTrig_PadsClockThunderBolt(  )
    call InitTrig_MagicHat(  )
    call InitTrig_WindGun(  )
    call InitTrig_Profess(  )
    call InitTrig_Camara(  )
    call InitTrig_Steam_Bun_And_Frog(  )
    call InitTrig_AI(  )
    call InitTrig_Initialization_AI(  )
    call InitTrig_AI_Waypoints(  )
    call InitTrig_AI_Learn(  )
    call InitTrig_AI_Revive(  )
    call InitTrig_AI_EXP_Bonus(  )
    call InitTrig_AI_Ability(  )
    call InitTrig_AI_Action(  )
    call InitTrig_AI_Init(  )
    call InitTrig_Initialization_CMD(  )
    call InitTrig_Close_TEST_MODE(  )
    call InitTrig_Command_Move_Speed(  )
    call InitTrig_Command_Kill(  )
    call InitTrig_Command_PS(  )
    call InitTrig_PointOpen(  )
    call InitTrig_PowerOpen(  )
    call InitTrig_PointOff(  )
    call InitTrig_PowerOff(  )
    call InitTrig_TEST_MODE_OPEN(  )
    call InitTrig_TEST_MODE_OFF(  )
    call InitTrig_Debug_Fog(  )
    call InitTrig_Debug_CD(  )
    call InitTrig_Debug_Level(  )
    call InitTrig_Debug_Gold(  )
    call InitTrig_Debug_Spirit(  )
    call InitTrig_Debug_Death(  )
    call InitTrig_Debug_Level_Up_All(  )
    call InitTrig_Debug_TOD(  )
    call InitTrig_Debug_TODMORE(  )
    call InitTrig_Debug_Kill(  )
    call InitTrig_MapMain(  )
endfunction

//===========================================================================
function RunInitializationTriggers takes nothing returns nothing
    call ConditionalTriggerExecute( gg_trg_Init_Abilities )
    call ConditionalTriggerExecute( gg_trg_Initialization_ItemAbilities )
endfunction

//***************************************************************************
//*
//*  Players
//*
//***************************************************************************

function InitCustomPlayerSlots takes nothing returns nothing

    // Player 0
    call SetPlayerStartLocation( Player(0), 0 )
    call ForcePlayerStartLocation( Player(0), 0 )
    call SetPlayerColor( Player(0), ConvertPlayerColor(0) )
    call SetPlayerRacePreference( Player(0), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(0), true )
    call SetPlayerController( Player(0), MAP_CONTROL_USER )

    // Player 1
    call SetPlayerStartLocation( Player(1), 1 )
    call ForcePlayerStartLocation( Player(1), 1 )
    call SetPlayerColor( Player(1), ConvertPlayerColor(1) )
    call SetPlayerRacePreference( Player(1), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(1), true )
    call SetPlayerController( Player(1), MAP_CONTROL_USER )

    // Player 2
    call SetPlayerStartLocation( Player(2), 2 )
    call ForcePlayerStartLocation( Player(2), 2 )
    call SetPlayerColor( Player(2), ConvertPlayerColor(2) )
    call SetPlayerRacePreference( Player(2), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(2), true )
    call SetPlayerController( Player(2), MAP_CONTROL_USER )

    // Player 3
    call SetPlayerStartLocation( Player(3), 3 )
    call ForcePlayerStartLocation( Player(3), 3 )
    call SetPlayerColor( Player(3), ConvertPlayerColor(3) )
    call SetPlayerRacePreference( Player(3), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(3), true )
    call SetPlayerController( Player(3), MAP_CONTROL_USER )

    // Player 4
    call SetPlayerStartLocation( Player(4), 4 )
    call ForcePlayerStartLocation( Player(4), 4 )
    call SetPlayerColor( Player(4), ConvertPlayerColor(4) )
    call SetPlayerRacePreference( Player(4), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(4), true )
    call SetPlayerController( Player(4), MAP_CONTROL_USER )

    // Player 6
    call SetPlayerStartLocation( Player(6), 5 )
    call ForcePlayerStartLocation( Player(6), 5 )
    call SetPlayerColor( Player(6), ConvertPlayerColor(6) )
    call SetPlayerRacePreference( Player(6), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(6), true )
    call SetPlayerController( Player(6), MAP_CONTROL_USER )

    // Player 7
    call SetPlayerStartLocation( Player(7), 6 )
    call ForcePlayerStartLocation( Player(7), 6 )
    call SetPlayerColor( Player(7), ConvertPlayerColor(7) )
    call SetPlayerRacePreference( Player(7), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(7), true )
    call SetPlayerController( Player(7), MAP_CONTROL_USER )

    // Player 8
    call SetPlayerStartLocation( Player(8), 7 )
    call ForcePlayerStartLocation( Player(8), 7 )
    call SetPlayerColor( Player(8), ConvertPlayerColor(8) )
    call SetPlayerRacePreference( Player(8), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(8), true )
    call SetPlayerController( Player(8), MAP_CONTROL_USER )

    // Player 9
    call SetPlayerStartLocation( Player(9), 8 )
    call ForcePlayerStartLocation( Player(9), 8 )
    call SetPlayerColor( Player(9), ConvertPlayerColor(9) )
    call SetPlayerRacePreference( Player(9), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(9), true )
    call SetPlayerController( Player(9), MAP_CONTROL_USER )

    // Player 10
    call SetPlayerStartLocation( Player(10), 9 )
    call ForcePlayerStartLocation( Player(10), 9 )
    call SetPlayerColor( Player(10), ConvertPlayerColor(10) )
    call SetPlayerRacePreference( Player(10), RACE_PREF_RANDOM )
    call SetPlayerRaceSelectable( Player(10), true )
    call SetPlayerController( Player(10), MAP_CONTROL_USER )

endfunction

function InitCustomTeams takes nothing returns nothing
    // Force: TRIGSTR_647
    call SetPlayerTeam( Player(0), 0 )
    call SetPlayerState( Player(0), PLAYER_STATE_ALLIED_VICTORY, 1 )
    call SetPlayerTeam( Player(1), 0 )
    call SetPlayerState( Player(1), PLAYER_STATE_ALLIED_VICTORY, 1 )
    call SetPlayerTeam( Player(2), 0 )
    call SetPlayerState( Player(2), PLAYER_STATE_ALLIED_VICTORY, 1 )
    call SetPlayerTeam( Player(3), 0 )
    call SetPlayerState( Player(3), PLAYER_STATE_ALLIED_VICTORY, 1 )

    //   Allied
    call SetPlayerAllianceStateAllyBJ( Player(0), Player(1), true )
    call SetPlayerAllianceStateAllyBJ( Player(0), Player(2), true )
    call SetPlayerAllianceStateAllyBJ( Player(0), Player(3), true )
    call SetPlayerAllianceStateAllyBJ( Player(1), Player(0), true )
    call SetPlayerAllianceStateAllyBJ( Player(1), Player(2), true )
    call SetPlayerAllianceStateAllyBJ( Player(1), Player(3), true )
    call SetPlayerAllianceStateAllyBJ( Player(2), Player(0), true )
    call SetPlayerAllianceStateAllyBJ( Player(2), Player(1), true )
    call SetPlayerAllianceStateAllyBJ( Player(2), Player(3), true )
    call SetPlayerAllianceStateAllyBJ( Player(3), Player(0), true )
    call SetPlayerAllianceStateAllyBJ( Player(3), Player(1), true )
    call SetPlayerAllianceStateAllyBJ( Player(3), Player(2), true )

    //   Shared Vision
    call SetPlayerAllianceStateVisionBJ( Player(0), Player(1), true )
    call SetPlayerAllianceStateVisionBJ( Player(0), Player(2), true )
    call SetPlayerAllianceStateVisionBJ( Player(0), Player(3), true )
    call SetPlayerAllianceStateVisionBJ( Player(1), Player(0), true )
    call SetPlayerAllianceStateVisionBJ( Player(1), Player(2), true )
    call SetPlayerAllianceStateVisionBJ( Player(1), Player(3), true )
    call SetPlayerAllianceStateVisionBJ( Player(2), Player(0), true )
    call SetPlayerAllianceStateVisionBJ( Player(2), Player(1), true )
    call SetPlayerAllianceStateVisionBJ( Player(2), Player(3), true )
    call SetPlayerAllianceStateVisionBJ( Player(3), Player(0), true )
    call SetPlayerAllianceStateVisionBJ( Player(3), Player(1), true )
    call SetPlayerAllianceStateVisionBJ( Player(3), Player(2), true )

    // Force: TRIGSTR_3805
    call SetPlayerTeam( Player(4), 1 )

    // Force: TRIGSTR_3804
    call SetPlayerTeam( Player(6), 2 )
    call SetPlayerState( Player(6), PLAYER_STATE_ALLIED_VICTORY, 1 )
    call SetPlayerTeam( Player(7), 2 )
    call SetPlayerState( Player(7), PLAYER_STATE_ALLIED_VICTORY, 1 )
    call SetPlayerTeam( Player(8), 2 )
    call SetPlayerState( Player(8), PLAYER_STATE_ALLIED_VICTORY, 1 )
    call SetPlayerTeam( Player(9), 2 )
    call SetPlayerState( Player(9), PLAYER_STATE_ALLIED_VICTORY, 1 )

    //   Allied
    call SetPlayerAllianceStateAllyBJ( Player(6), Player(7), true )
    call SetPlayerAllianceStateAllyBJ( Player(6), Player(8), true )
    call SetPlayerAllianceStateAllyBJ( Player(6), Player(9), true )
    call SetPlayerAllianceStateAllyBJ( Player(7), Player(6), true )
    call SetPlayerAllianceStateAllyBJ( Player(7), Player(8), true )
    call SetPlayerAllianceStateAllyBJ( Player(7), Player(9), true )
    call SetPlayerAllianceStateAllyBJ( Player(8), Player(6), true )
    call SetPlayerAllianceStateAllyBJ( Player(8), Player(7), true )
    call SetPlayerAllianceStateAllyBJ( Player(8), Player(9), true )
    call SetPlayerAllianceStateAllyBJ( Player(9), Player(6), true )
    call SetPlayerAllianceStateAllyBJ( Player(9), Player(7), true )
    call SetPlayerAllianceStateAllyBJ( Player(9), Player(8), true )

    //   Shared Vision
    call SetPlayerAllianceStateVisionBJ( Player(6), Player(7), true )
    call SetPlayerAllianceStateVisionBJ( Player(6), Player(8), true )
    call SetPlayerAllianceStateVisionBJ( Player(6), Player(9), true )
    call SetPlayerAllianceStateVisionBJ( Player(7), Player(6), true )
    call SetPlayerAllianceStateVisionBJ( Player(7), Player(8), true )
    call SetPlayerAllianceStateVisionBJ( Player(7), Player(9), true )
    call SetPlayerAllianceStateVisionBJ( Player(8), Player(6), true )
    call SetPlayerAllianceStateVisionBJ( Player(8), Player(7), true )
    call SetPlayerAllianceStateVisionBJ( Player(8), Player(9), true )
    call SetPlayerAllianceStateVisionBJ( Player(9), Player(6), true )
    call SetPlayerAllianceStateVisionBJ( Player(9), Player(7), true )
    call SetPlayerAllianceStateVisionBJ( Player(9), Player(8), true )

    // Force: TRIGSTR_4564
    call SetPlayerTeam( Player(10), 3 )

endfunction

function InitAllyPriorities takes nothing returns nothing

    call SetStartLocPrioCount( 0, 4 )
    call SetStartLocPrio( 0, 0, 1, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 0, 1, 2, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 0, 2, 3, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 0, 3, 4, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 1, 4 )
    call SetStartLocPrio( 1, 0, 0, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 1, 1, 2, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 1, 2, 3, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 1, 3, 4, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 2, 4 )
    call SetStartLocPrio( 2, 0, 0, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 2, 1, 1, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 2, 2, 3, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 2, 3, 4, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 3, 4 )
    call SetStartLocPrio( 3, 0, 0, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 3, 1, 1, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 3, 2, 2, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 3, 3, 4, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 4, 4 )
    call SetStartLocPrio( 4, 0, 0, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 4, 1, 1, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 4, 2, 2, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 4, 3, 3, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 5, 4 )
    call SetStartLocPrio( 5, 0, 6, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 5, 1, 7, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 5, 2, 8, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 5, 3, 9, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 6, 4 )
    call SetStartLocPrio( 6, 0, 5, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 6, 1, 7, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 6, 2, 8, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 6, 3, 9, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 7, 4 )
    call SetStartLocPrio( 7, 0, 5, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 7, 1, 6, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 7, 2, 8, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 7, 3, 9, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 8, 4 )
    call SetStartLocPrio( 8, 0, 5, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 8, 1, 6, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 8, 2, 7, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 8, 3, 9, MAP_LOC_PRIO_HIGH )

    call SetStartLocPrioCount( 9, 4 )
    call SetStartLocPrio( 9, 0, 5, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 9, 1, 6, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 9, 2, 7, MAP_LOC_PRIO_HIGH )
    call SetStartLocPrio( 9, 3, 8, MAP_LOC_PRIO_HIGH )
endfunction

//***************************************************************************
//*
//*  Main Initialization
//*
//***************************************************************************

//===========================================================================
function main takes nothing returns nothing
    call SetCameraBounds( -9216.0 + GetCameraMargin(CAMERA_MARGIN_LEFT), -18432.0 + GetCameraMargin(CAMERA_MARGIN_BOTTOM), 14848.0 - GetCameraMargin(CAMERA_MARGIN_RIGHT), -2048.0 - GetCameraMargin(CAMERA_MARGIN_TOP), -9216.0 + GetCameraMargin(CAMERA_MARGIN_LEFT), -2048.0 - GetCameraMargin(CAMERA_MARGIN_TOP), 14848.0 - GetCameraMargin(CAMERA_MARGIN_RIGHT), -18432.0 + GetCameraMargin(CAMERA_MARGIN_BOTTOM) )
    call SetDayNightModels( "Environment\\DNC\\DNCLordaeron\\DNCLordaeronTerrain\\DNCLordaeronTerrain.mdl", "Environment\\DNC\\DNCLordaeron\\DNCLordaeronUnit\\DNCLordaeronUnit.mdl" )
    call SetTerrainFogEx( 0, 1500.0, 3000.0, 0.500, 1.000, 1.000, 1.000 )
    call NewSoundEnvironment( "lake" )
    call SetAmbientDaySound( "AshenvaleDay" )
    call SetAmbientNightSound( "AshenvaleNight" )
    call SetMapMusic( "Music", true, 0 )
    call InitSounds(  )
    call CreateRegions(  )
    call CreateAllDestructables(  )
    call CreateAllItems(  )
    call CreateAllUnits(  )
    call InitBlizzard(  )
    call InitGlobals(  )
    call InitCustomTriggers(  )
    call RunInitializationTriggers(  )

endfunction

//***************************************************************************
//*
//*  Map Configuration
//*
//***************************************************************************

function config takes nothing returns nothing
    call SetMapName( "TRIGSTR_330" )
    call SetMapDescription( "TRIGSTR_611" )
    call SetPlayers( 10 )
    call SetTeams( 10 )
    call SetGamePlacement( MAP_PLACEMENT_TEAMS_TOGETHER )

    call DefineStartLocation( 0, 704.0, -16384.0 )
    call DefineStartLocation( 1, 704.0, -16384.0 )
    call DefineStartLocation( 2, 704.0, -16384.0 )
    call DefineStartLocation( 3, 704.0, -16384.0 )
    call DefineStartLocation( 4, 704.0, -16384.0 )
    call DefineStartLocation( 5, 12800.0, -4864.0 )
    call DefineStartLocation( 6, 12800.0, -4864.0 )
    call DefineStartLocation( 7, 12800.0, -4864.0 )
    call DefineStartLocation( 8, 12800.0, -4864.0 )
    call DefineStartLocation( 9, 12800.0, -4864.0 )

    // Player setup
    call InitCustomPlayerSlots(  )
    call InitCustomTeams(  )
    call InitAllyPriorities(  )
endfunction

